# Task for AGENT-2: WBS-003 — Search & Indexing Implementation

You are a Cursor CLI agent working under a central Orchestrator.

## WBS Task

- ID: WBS-003
- Title: Search & Indexing Implementation
- Phase: Backend
- Agent: AGENT-2
- Depends on: WBS-002
- Blueprint IDs: TD-0001, TD-0003, TD-0004, TD-0005, TD-0006, TD-0007, TD-0008, TD-0009, TD-0236, TD-0237, TD-0238, TD-0239, TD-0240, TD-0241, TD-0242, TD-0243, TD-0244, TD-0245, TD-0246, TD-0247, TD-0248, TD-0249

### Description

Implement search infrastructure using Typesense (default) with optional OpenSearch fallback. Define and build search indices for People and Studios with detailed schemas supporting facets, filters, sorting, safe-mode filtering, and promotions. Develop GraphQL search API with role-based filters, cursor pagination, and autocomplete with typo tolerance and synonyms. Implement ranking algorithms blending text match, geo proximity, reputation, verification, price fit, availability, and recency with fairness constraints. Build admin tools for synonym management, density caps, invalid-click dashboards, and index health monitoring. Integrate caching, rate limiting, telemetry, and cost controls.

### Acceptance Criteria

- Search indices for People and Studios built with full schema and safe-mode filtering
- GraphQL search API supports filters, cursor pagination, autocomplete, and role gating
- Ranking algorithm implemented with fairness and promotions blending
- Admin consoles for synonym editing, density caps, and invalid-click monitoring live
- Caching and rate limiting enforced with telemetry dashboards and cost alarms
- Search latency and availability meet SLOs
- Tests cover relevance, safety, performance, and resilience


## Relevant Blueprint Chunks

### TD-0001 (tech)

<!-- id: TD-0001 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 3600-7600 -->

omplete Zod schemas on request; they are
200+ lines and omitted here to keep this section readable.)*

**1.1.Q Availability model & conflict rules**

- *availability_json* is **advisory** for search hints; authoritative
  blocks come from accepted booking legs.
- When creating a draft or confirming a booking leg, we check **overlaps
  across all SPs** owned by the same account and across any **studio
  listing** the account owns if the owner will be present/required.
- Conflict outcomes: warn on soft conflicts (availability windows);
  hard-block on accepted overlaps unless the user explicitly opts for
  back-to-back with buffer (configurable minimum, e.g., 60 min).

**Overlap detection (UTC):**

- Normalize proposed *(start,end)* to UTC; query legs for the owner in
  *\[start-buffer, end+buffer\]*.
- If any accepted leg overlaps → reject; if pending holds overlap → show
  conflict UI with manage options.

**1.1.R Typesense/OpenSearch schemas & analyzers**

**People index (*****people_v1*****)**

- Fields: *id (string)*, *userId*, *role*, *city*, *geo* (lat,lon),
  *isPublished* (bool), *completenessScore (int)*, *instantBook (bool)*,
  *ratingAvg (float)*, *ratingCount (int)*, *priceFromCents (int)*,
  *verification.id (bool)*, *verification.bg (bool)*,
  *verification.social (bool)*, *availabilityBuckets (string\[\])*,
  *genres/specialties (string\[\])*, **selected role filters** (e.g.,
  *height_cm*, *studio_access*).
- Facets: *role*, *city*, *verification.id*, *instantBook*,
  *genres/specialties*, price buckets (derived).
- Sorting: *\_text_match* → *verification.id desc* → *ratingAvg desc* →
  *abs(priceFromCents - queryBudget) asc* → *created_at desc*.

**Studios index (*****studios_v1*****)**

- Fields: *id*, *city*, *geo*, *amenities (string\[\])*,
  *depositRequired (bool)*, *verifiedStudio (bool)*, *ratingAvg*,
  *ratingCount*.
- Facets: *city*, *amenities*, *verifiedStudio*.

**Analyzers & normalization**

- Lowercase/ASCII fold; synonyms for common tags (e.g., "glamour" \~
  "glam"); numeric filters for height/price.
- Safe-Mode filtering occurs in the query layer: if Safe-Mode=ON →
  exclude *nsfw_band=2* assets from cards; prefer blur on 1.

**Index refresh & backfill**

- Mutation outbox → indexer Lambda; nightly full backfill per city;
  integrity check (counts vs DB) with alert if \>1% deviation.

**1.1.S Content-safety thresholds & pipelines**

- **Upload path:** client → signed S3 upload (previews only) → SQS →
  Lambda scan.

- **Scanner result →** ***nsfw_band*****:**

  - 0 = Allow (public thumbnail fine)
  - 1 = Blur (mild adult; blur radius 8--16)
  - 2 = Block (explicit; no public display)

- **Appeals:** owner submits appeal; T&S reviews; on override, we store
  *override_reason*, *actor*, *timestamp*. All decisions audited.

**1.1.T Admin RBAC (for this section)**

  ------------------ ---------------------------------------------- -------------------------------------- -------------------------------
  **Admin role**     **Can view**                                   **Can edit**                           **Approvals required**
  Support            SP/studio status, completeness, basic fields   Unpublish SP/studio on policy breach   1 approver
  Trust & Safety     NSFW decisions, overrides, link removals       Override scan; set *nsfw_band*         2-person approval
  Promotions         N/A (1.1 only)                                 N/A                                    N/A
  City Ops           City allowlists for visibility                 Toggle city gate on SP exposure        2-person on city gate changes
  Finance            N/A                                            N/A                                    N/A
  Legal/Compliance   Audit log access                               Lock records (litigation hold)         2-person
  ------------------ ---------------------------------------------- -------------------------------------- -------------------------------

All admin actions write imm

### TD-0003 (tech)

<!-- id: TD-0003 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 10800-14800 -->

kout).
50. **Saved searches & alerts** (optional for MVP; schema below).
51. **Admin**: Reindex, synonyms, density caps, city gates,
    invalid‑click dashboard.

**Non‑negotiable behaviors**

- Clicking a search card **always** deep‑links to the **role canonical
  page** (*/u/{handle}/{role}*) or **studio page** (*/studio/{slug}*),
  never the account shell alone.
- Safe‑Mode ON by default for guests; public thumbnails follow NSFW
  rules.
- **Studios are listings (places)**; role results never mix studio
  ratings or badges.
- Social metrics appear *only when verified*; otherwise show
  "Unverified".

## **1.2.B Engine & collections**

We implement the Search Service to be **engine‑agnostic** with a default
**Typesense** deployment (low fixed cost), and an optional
**OpenSearch** backend behind the same adapter.

**Collections**

- *people_v1* --- one document per **Service Profile** (SP).
- *studios_v1* --- one document per **Studio**.

**Sharding/partitioning**

- Logical shards by *city* and *role* (we keep physical topology simple
  at MVP---one node w/ replica or small serverless OCU cap).
- Daily compaction to prune stale docs; reindex per city when
  policy/flags change.

## **1.2.C Index schema (canonical)**

***people_v1*** **(Service Profiles)**

*{ \"id\": \"srv_mdl_01h\...\", \"userId\": \"usr_01h\...\", \"role\":
\"model \| photographer \| videographer \| creator \| fansub\",
\"handle\": \"kevin\", \"slug\": \"model\", // for /u/{handle}/{role}
\"isPublished\": true, \"completenessScore\": 82, \"createdAt\":
\"2025-10-30T19:00:00Z\", \"updatedAt\": \"2025-11-05T14:12:00Z\",
\"city\": \"Houston\", \"region\": \"TX\", \"geo\": { \"lat\": 29.7604,
\"lon\": -95.3698 }, \"radiusKm\": 80, // willing-to-travel hint
\"safeModeBandMax\": 1, // 0 allow, 1 blur OK, 2 block on public
\"verification\": { \"id\": true, \"bg\": false, \"socialVerified\":
true }, \"instantBook\": true, \"ratingAvg\": 4.92, \"ratingCount\": 27,
\"priceFromCents\": 15000, // min package price \"priceMedianCents\":
25000, // optional \"currency\": \"USD\", \"availabilityBuckets\":
\[\"2025-11-10\",\"2025-11-11\",\"2025-11-14\"\], \"roleFields\": {
\"model\": { \"height_cm\": 175, \"genres\":
\[\"fashion\",\"editorial\"\] }, \"photographer\": { \"specialties\":
\[\"portrait\"\], \"studio_access\": false }, \"videographer\": {
\"specialties\": \[\"music\"\] }, \"creator\": { \"platforms\":
\[\"instagram\",\"tiktok\"\] } }, \"social\": { \"igFollowers\": 182000,
\"igEngagementRate\": 0.028, \"ttFollowers\": 530000, \"ttAvgViews\":
120000 }, \"policySignals\": { \"disputeRate30d\": 0.0,
\"cancelRate90d\": 0.02, \"lateDeliveryRate90d\": 0.01 }, \"boosts\": {
\"trustedPro\": 0, // +1 if BG passed \"newSellerFloor\": 1, // protect
cold start \"studioLinked\": 0 // +1 if linked studio (has chip) }}*

***studios_v1*** **(Studio Listings)**

*{ \"id\": \"std_01h\...\", \"ownerUserId\": \"usr_01h\...\", \"title\":
\"East End Loft\", \"slug\": \"east-end-loft\", \"city\": \"Houston\",
\"region\": \"TX\", \"geo\": {\"lat\": 29.75, \"lon\": -95.35},
\"isPublished\": true, \"verifiedStudio\": true, \"amenities\":
\[\"natural light\",\"backdrops\",\"makeup area\",\"parking\"\],
\"depositRequired\": true, \"ratingAvg\": 4.85, \"ratingCount\": 41,
\"priceFromCents\": 3500, // per-hour or base slot price (normalized)
\"availabilityBuckets\": \[\"2025-11-10\",\"2025-11-12\"\]}*

## **1.2.D Analyzers & normalization**

**Text fields**

- Lowercase, ASCII‑fold; stopwords minimal; synonyms (see Admin §1.2.N)
  for common fashion/creator terms: *\"glamour\" \~ \"glam\"*, *\"bnw\"
  \~ \"black and white\"*, *\"H‑Town\" \~ \"Houston\"*.

**Numeric**

- Height, price, rating stored as numerics for range queries.

**Geo**

- Store *geo* as lat/lon. We support **radius** queries at MVP (polygon
  later).

**Availability**

- Bucket by ISO calendar days; daily job populates buckets for the next
  N days (N configurable; default 30).

**NSFW/Safe‑Mode**

- For **public search**

### TD-0004 (tech)

<!-- id: TD-0004 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 14400-18400 -->

"
  \~ \"black and white\"*, *\"H‑Town\" \~ \"Houston\"*.

**Numeric**

- Height, price, rating stored as numerics for range queries.

**Geo**

- Store *geo* as lat/lon. We support **radius** queries at MVP (polygon
  later).

**Availability**

- Bucket by ISO calendar days; daily job populates buckets for the next
  N days (N configurable; default 30).

**NSFW/Safe‑Mode**

- For **public search**, apply a query‐time filter:

  - Safe‑Mode ON → *safeModeBandMax \<= 1* (block band 2 entirely).
  - Safe‑Mode OFF for verified adults → *safeModeBandMax \<= 2* (still
    no explicit thumbnails if the product policy forbids explicit public
    imagery).

## **1.2.E Filters & UI chips**

**Global filters (people)**

- Role (tab), Location (city/radius), Date (single or range), Budget
  (min/max), Verification (ID Verified badge), Instant Book toggle,
  Rating (≥ threshold), Safe‑Mode on/off (if signed‑in and
  age‑verified), Availability (specific day), Sort (Default, Top Rated,
  Price Low→High, New).

**Role‑specific filters**

- **Models**: Height (cm/in ranges), Genres (allowlist), Experience
  (years), Travel ready (bool).
- **Photographers**: Specialties, Studio Access (has studio link),
  Turnaround (days), Insurance (bool).
- **Videographers**: Specialties, Audio capability (bool), Deliverable
  format (enum).
- **Creators**: Platforms (IG/TT/YT/X), Category, Verified social
  (bool), Min followers (range).
- **Studios**: Amenities (multi‑select), Deposit required (bool),
  Size/Capacity buckets, Natural light (bool), Parking (bool).

**Promotion chips (when feature flag on)**

- "Featured" label (above the fold) or "Boosted" (below); both must be
  visually distinct and disclose paid placement.

## **1.2.F Query grammar & API contracts**

**GraphQL (AppSync)**

*input SearchInput { surface: SearchSurface! \# PEOPLE or STUDIOS role:
RoleType \# required when surface=PEOPLE city: String! lat: Float lon:
Float radiusKm: Int = 50 date: AWSDate \# single day dateRange:
DateRangeInput \# optional alternative budgetMinCents: Int
budgetMaxCents: Int ratingMin: Float verifiedOnly: Boolean
instantBookOnly: Boolean safeMode: Boolean = true \# Role-specific
filters: model: ModelFiltersInput photographer: PhotographerFiltersInput
videographer: VideographerFiltersInput creator: CreatorFiltersInput
studios: StudiosFiltersInput sort: SearchSort = DEFAULT page: String \#
opaque cursor pageSize: Int = 20} type SearchResult { items:
\[SearchCard!\]! facets: \[Facet!\]! page: String \# next cursor} type
Query { search(input: SearchInput!): SearchResult! searchSuggest(query:
String!, surface: SearchSurface!, role: RoleType, city: String!):
\[SuggestItem!\]! savedSearches: \[SavedSearch!\]!} type Mutation {
saveSearch(name: String!, input: SearchInput!): SavedSearch!
deleteSavedSearch(id: ID!): Boolean!}*

**Cursor‑based pagination**

- Results return opaque *page* tokens (do not leak engine details).
- We cache the last N cursors per user/session (server‑side) to enable
  back/forward replay.

**Query normalization**

- City is canonicalized to a region/city id; if *lat/lon* present, we
  compute city from reverse geocoding and warn on mismatches.
- Role‑specific filters are ignored unless *role* matches the relevant
  type.

## **1.2.G Ranking & fairness**

**Base score**\
*score = w_text\*textMatch + w_geo\*geoScore + w_rep\*repScore +
w_verify\*verifyBoost + w_price\*priceFit + w_avail\*availBoost +
w_recency\*recency*

- *textMatch*: keyword/synonym features (if query text present).
- *geoScore*: distance‑decay (radius Gaussian; 0 beyond radius).
- *repScore*: f(ratingAvg, ratingCount) with Laplace smoothing to avoid
  low‑sample overweighting.
- *verifyBoost*: +X if ID Verified, +Y if Trusted Pro (BG passed).
- *priceFit*: penalty for large deviation from user budget (if set).
- *availBoost*: +Z if the requested date is in *availabilityBuckets*.
- *recency*: mild boost for recently updated profiles (helps cold
  start).

**Fairness & divers

### TD-0005 (tech)

<!-- id: TD-0005 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 18000-22000 -->

*repScore*: f(ratingAvg, ratingCount) with Laplace smoothing to avoid
  low‑sample overweighting.
- *verifyBoost*: +X if ID Verified, +Y if Trusted Pro (BG passed).
- *priceFit*: penalty for large deviation from user budget (if set).
- *availBoost*: +Z if the requested date is in *availabilityBuckets*.
- *recency*: mild boost for recently updated profiles (helps cold
  start).

**Fairness & diversity constraints**

- **Provider diversity**: impose a max of K results per owner within the
  top N (avoid multi‑role flooding).
- **New‑seller floor**: ensure a minimum presence (M slots in top N
  reserved for low‑history but complete/verified profiles).
- **Studio diversity**: different studio owners in top M.
- **Policy penalties**: suppress results if *policySignals* exceed
  thresholds (dispute, late delivery). Thresholds configured via Admin.

**Promotions blending (when enabled)**

- **Featured**: eligible results can occupy fixed slots (e.g., 1--2
  positions in top 20) but **never break filters**.
- **Boost**: cost‑per‑click uplift---insert additional slots every X
  organic results after position P.
- Both obey density caps: e.g., ≤2 Featured in top 20; ≤1 above the
  fold.

## **1.2.H Promotions integrity (invalid‑click handling)**

- Real‑time click stream with fingerprinting (device, IP block, user id,
  session id).
- **Deduplicate** multiple clicks from same session/user within T
  seconds.
- **Invalid click rules**: excessive repeat clicks, out‑of‑geo
  anomalies, bot signals → flagged and **not billed**.
- **Make‑good credits** auto‑issued for flagged traffic (logged as
  ledger entries).
- Holdouts (A/B) maintain an organic control set for unbiased impact
  analysis.

## **1.2.I Caching, rate limits, and SLOs**

**Result caching**

- Key: hash of normalized *SearchInput* (without page) + city + role +
  safeMode + version.
- TTL 60--120s (config), **stale‑while‑revalidate** to keep p95 low.
- Pagination cursors cached separately for short time (120s).

**Rate limits**

- Per IP and per account; stricter for anonymous traffic; separate
  limits for suggest vs full search.

**SLOs (MVP)**

- p95 latency: **≤350ms** for cached hits, **≤600ms** for cold queries
  at launch city scale.
- Error rate (5xx) \< 0.5%; availability ≥99.9% monthly for the API.

## **1.2.J Ingestion & update pipeline**

**Write sources**

- SP publish/update, rating updates, verification/badge changes,
  availability updates, policy signals, studio verification toggles.

**Mechanics**

- **Outbox** on mutations → SQS → Indexer Lambda → engine upsert.
- **Nightly backfill** per city to guarantee convergence.
- **On booking accept**: emit event to add date to *availabilityBuckets*
  for the participant SP and studio (if applicable).
- **On cancellation**: remove bucket(s) if time still in future.
- **On policy change** (Safe‑Mode, city gate, eligibility): bulk partial
  update.

**Consistency**

- If index write fails, retry with exponential backoff; stale card
  renders are guarded by server query filters.

## **1.2.K Telemetry & analytics**

**Events**

- *search.open*, *search.filters.apply*, *search.query.execute*,
  *search.results.render*, *search.result.impression*,
  *search.result.click*, *search.result.save*, *search.error*,
  *search.latency*.
- Promotions: *promo.slot.impression*, *promo.slot.click*,
  *promo.invalid_click.flag*, *promo.credit.issued*.
- Integrity: *search.integrity.invalid_request*,
  *search.abuse.robot_detected*.

**Metrics**

- CTR by role/facet; budget fit distribution; verified share;
  availability hit rate; density cap compliance; diversity indices.

## **1.2.L Admin tools (console)**

**Search Admin**

- **Reindex** city/role; **dry‑run** to preview doc deltas.
- **Synonyms** & stopwords editor; import/export.
- **Density caps** (Featured/Boost) with city gates.
- **Eligibility rules** (e.g., verified‑only for certain placements).
- **Invalid click** dashboard with credit issuance.
- **Index health**: doc coun

### TD-0006 (tech)

<!-- id: TD-0006 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 21600-25600 -->

 compliance; diversity indices.

## **1.2.L Admin tools (console)**

**Search Admin**

- **Reindex** city/role; **dry‑run** to preview doc deltas.
- **Synonyms** & stopwords editor; import/export.
- **Density caps** (Featured/Boost) with city gates.
- **Eligibility rules** (e.g., verified‑only for certain placements).
- **Invalid click** dashboard with credit issuance.
- **Index health**: doc counts vs DB counts, last update lag, error
  logs.

**Config safety**

- All changes require reason, actor, and (for money/placement)
  **two‑person approval**.
- Rollback to previous config version.

## **1.2.M Error model (API)**

- *SEARCH_INVALID_LOCATION* --- unresolvable or mismatched city vs
  lat/lon.
- *SEARCH_UNDERAGE_SAFEMODE* --- attempted explicit toggle without age
  verification.
- *SEARCH_ROLE_FILTER_CONFLICT* --- role‑specific filter provided for
  wrong role.
- *SEARCH_CITY_GATED* --- surface disabled for this city.
- *SEARCH_TOO_MANY_PARAMS* --- exceeded allowed number of facets.
- *SEARCH_ENGINE_ERROR* --- upstream engine error (masked; logged with
  corrId).

All error payloads include *code*, *message*, *hint*, and a correlation
id.

## **1.2.N Synonyms & taxonomies (starter sets)**

**Genres (Models)**: fashion, editorial, commercial, runway, beauty,
swim, fitness.\
**Specialties (Photographers/Videographers)**: portrait, fashion,
editorial, wedding, music, commercial, product.\
**Amenities (Studios)**: natural light, cyc wall, blackout, backdrops,
makeup area, dressing room, parking, AC/heating.

**Synonyms example**

- "bnw" ↔ "black and white"; "glam" ↔ "glamour"; "studio access" ↔ "has
  studio".

## **1.2.O Security, privacy, safety controls**

- **Safe‑Mode** enforced at query and render time.
- **Age‑gate** required to see certain role tabs (Fan‑Sub); explicit
  public images still disallowed.
- **PII** never stored in index documents.
- **Abuse**: aggressive rate limiting and bot heuristics for suggest
  endpoints.

## **1.2.P Cost controls**

- **Typesense**: single small node (or managed starter), vertical scale
  when QPS rises; replica optional for HA.
- **OpenSearch Serverless** (if chosen): **OCU cap** per region; alarms
  on sustained OCU \> 80%.
- Cache TTLs keep engine calls low; nightly reindex batched to off‑peak
  hours.

## **1.2.Q Test plan (must‑pass)**

**Unit & contract**

- Filter parsing/normalization; role‑filter gating; city & safe‑mode
  checks; error codes.

**Search correctness**

- Role true: a multi‑role user queried in "Model" must link to
  */u/{handle}/model*; ratings don't leak across roles.
- Studios separated: amenities filters never affect people surface.

**Ranking & fairness**

- Diversity: same owner appears ≤K times in top N.
- New‑seller floor: at least M cold‑start profiles surface in top N
  given enough eligible docs.
- Verify boosts: ID Verified outranks equal unverified, all else equal.

**Promotions**

- Density caps obeyed; placements never bypass filters; invalid clicks
  removed from billable stream.

**Performance**

- p95 latency within SLO for cached and uncached queries under synthetic
  city load.

**Resilience**

- Indexer retry & DLQ; search fallback message (non‑blocking) if engine
  unreachable.

## **1.2.R Work packages (for your 4 Cursor agents)**

**Agent C --- Search/Index**

- WP‑SRCH‑01: Define Typesense collections; create indexer Lambda;
  implement upsert paths from outbox.
- WP‑SRCH‑02: Build query layer with normalization (city, radius) and
  safe‑mode enforcement; cursor pagination.
- WP‑SRCH‑03: Implement ranking features and fairness constraints; write
  unit tests.

**Agent A --- API/BFF**

- WP‑API‑SRCH‑01: Implement GraphQL *search*, *searchSuggest*,
  *saveSearch* with auth & rate limits; error model and correlation ids.
- WP‑API‑SRCH‑02: Result caching (SWR) + per‑user cursor cache.

**Agent B --- Web**

- WP‑WEB‑SRCH‑01: Search UI (role tabs, chips, facets, sort); result
  cards; disclosure for paid slots.
- WP‑WEB‑SRCH‑02: Saved se

### TD-0007 (tech)

<!-- id: TD-0007 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 25200-29200 -->

 write
  unit tests.

**Agent A --- API/BFF**

- WP‑API‑SRCH‑01: Implement GraphQL *search*, *searchSuggest*,
  *saveSearch* with auth & rate limits; error model and correlation ids.
- WP‑API‑SRCH‑02: Result caching (SWR) + per‑user cursor cache.

**Agent B --- Web**

- WP‑WEB‑SRCH‑01: Search UI (role tabs, chips, facets, sort); result
  cards; disclosure for paid slots.
- WP‑WEB‑SRCH‑02: Saved searches & alerts (optional flag).

**Agent D --- Admin & QA**

- WP‑ADM‑SRCH‑01: Console pages (reindex, synonyms, density caps,
  invalid‑clicks).
- WP‑QA‑SRCH‑01: E2E tests for correctness, fairness, promotions, and
  SLOs; synthetic dataset & golden files.

## **1.2.S Acceptance criteria (mark §1.2 FINAL only when ALL are true)**

152. **Correctness**: Role‑true discovery and studio separation
     verified; safe‑mode & age‑gate enforced; city gate honored.
153. **Filters**: All global and role‑specific filters work; social
     metrics shown only when verified.
154. **Ranking**: Diversity caps & new‑seller floor active; verify
     boosts and price fit working.
155. **Promotions** (if flag on): featured/boost slots respect density
     caps; no filter bypass; invalid clicks removed from billing.
156. **Performance**: p95 within SLO; cache hit rate ≥60% under
     synthetic load.
157. **Resilience**: Indexer DLQ empty after backfill; backfill parity
     within ±1% of DB records.
158. **Telemetry**: Events emitted; dashboards show CTR, filter usage,
     fairness metrics, index lag.
159. **Cost**: Engine within budget; cache prevents \>40% of engine
     calls; alarms quiet for 48h.

# 

# 

# **§1.3 --- Booking & Checkout (Linked Booking Group, Escrow, Deposits, Docs‑Before‑Pay, Tax, Refunds, Disputes)**

**Purpose.** Specify the end‑to‑end technical design and guarantees for
creating, validating, paying for, amending, and settling bookings---both
single‑leg and **Linked Booking Groups (LBG)** where a *Talent leg* and
a *Studio leg* are confirmed together but keep independent policies,
receipts, and payouts. This section includes domain models, state
machines, APIs, ledgers, taxes, deposits, refunds, disputes,
attach‑in‑flow studios, admin tools, telemetry, SLOs, and a full test
plan. We will stay in §1.3 until it is complete to your 99.9% bar.

## **1.3.A Canon & invariants**

- **Two distinct ledgers:** Talent leg and Studio leg are independent
  commercial contracts (prices, taxes, refunds, payouts, disputes).
  **LBG** is a *container* that synchronizes timing and UX but **never**
  merges their policies or reviews.
- **Docs‑before‑pay:** Required packs (SOW, Model Releases, Studio House
  Rules) must be assembled and signed **before** any charge is
  authorized or captured.
- **Escrow‑like handling:** Buyer is charged at confirmation; payouts
  are **withheld** until completion or acceptance window close (escrow
  mimic), with deposits handled separately for Studios.
- **Atomicity:** LBG confirmation succeeds **only if both legs validate
  and fund**; otherwise nothing commits.
- **Money correctness:** Sum of lines = totals; taxes computed per leg;
  cents (integer); idempotency on all external I/O.
- **Attach‑in‑flow Studio:** During Talent checkout, the buyer can add a
  Studio leg that matches time/location rules; both legs confirm
  together if valid.

## **1.3.B Domain model (Aurora PostgreSQL, source of record)**

Money in cents; timestamps UTC.

*\-- Linked Booking Group (container)create table lbg ( lbg_id text
primary key, \-- lbg\_\... buyer_user_id text not null, \-- usr\_\...
status text not null check (status in
(\'draft\',\'awaiting_docs\',\'awaiting_payment\',\'confirmed\',\'in_progress\',\'completed\',\'cancelled\',\'failed\')),
city text not null, start_at timestamptz not null, \-- group reference
window end_at timestamptz not null, acceptance_until timestamptz, \--
buyer acceptance window end currency text not null default \'USD\',
created_at timestamptz not null default now(), updated_at timestamptz
not null

### TD-0008 (tech)

<!-- id: TD-0008 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 28800-32800 -->

',\'awaiting_docs\',\'awaiting_payment\',\'confirmed\',\'in_progress\',\'completed\',\'cancelled\',\'failed\')),
city text not null, start_at timestamptz not null, \-- group reference
window end_at timestamptz not null, acceptance_until timestamptz, \--
buyer acceptance window end currency text not null default \'USD\',
created_at timestamptz not null default now(), updated_at timestamptz
not null default now(), version bigint not null default 0); \-- Booking
legs (one per seller/role or per studio)create type leg_type as enum
(\'talent\',\'studio\'); create table booking_leg ( leg_id text primary
key, \-- leg\_\... lbg_id text references lbg(lbg_id) on delete cascade,
type leg_type not null, seller_user_id text not null, \-- usr\_\... (for
studio, owner_user_id) service_profile_id text, \-- talent leg
(srv\_\*), null for studio leg studio_id text, \-- studio leg (std\_\*),
null for talent leg title text not null, \-- shown on receipt start_at
timestamptz not null, end_at timestamptz not null, \-- pricing snapshot
(immutable after confirm; use amendments for changes) subtotal_cents int
not null, tax_cents int not null default 0, fees_cents int not null
default 0, \-- platform/service fees for this leg total_cents int not
null, \-- subtotal + tax + fees currency text not null default \'USD\',
policy_json jsonb not null default \'{}\'::jsonb, \-- cancel windows,
change windows doc_pack_id text, \-- e-sign envelope id status text not
null check (status in
(\'draft\',\'awaiting_docs\',\'awaiting_payment\',\'confirmed\',\'in_progress\',\'completed\',\'cancelled\',\'failed\')),
created_at timestamptz not null default now(), updated_at timestamptz
not null default now(), version bigint not null default 0); \-- Charges
(one LBG-level charge holds buyer funds; legs reference splits)create
table charge ( charge_id text primary key, \-- chg\_\... lbg_id text not
null references lbg(lbg_id) on delete cascade, processor text not null,
\-- \'stripe\' processor_intent text not null, \-- pi\_\...
(PaymentIntent) status text not null check (status in
(\'requires_action\',\'authorized\',\'captured\',\'succeeded\',\'canceled\',\'failed\')),
amount_cents int not null, currency text not null default \'USD\',
payment_method text, \-- \'card\',\'ach_debit\' created_at timestamptz
not null default now(), updated_at timestamptz not null default now(),
unique (processor, processor_intent)); \-- Charge allocations per
legcreate table charge_split ( charge_id text references
charge(charge_id) on delete cascade, leg_id text references
booking_leg(leg_id) on delete cascade, amount_cents int not null,
primary key (charge_id, leg_id)); \-- Studio deposits (separate
auth/hold via SetupIntent)create table deposit_auth ( deposit_id text
primary key, \-- dep\_\... leg_id text not null references
booking_leg(leg_id) on delete cascade, \-- studio leg only processor
text not null, \-- \'stripe\' processor_setup text not null, \--
seti\_\... status text not null check (status in
(\'requires_action\',\'authorized\',\'captured\',\'voided\',\'expired\')),
authorized_cents int not null, captured_cents int not null default 0,
currency text not null default \'USD\', created_at timestamptz not null
default now(), updated_at timestamptz not null default now(), unique
(processor, processor_setup)); \-- Amendments (change orders,
extras/overtime); each produces delta lines and tax recalcscreate table
amendment ( amendment_id text primary key, \-- amd\_\... leg_id text not
null references booking_leg(leg_id) on delete cascade, kind text not
null check (kind in
(\'change_order\',\'overtime\',\'refund_line\',\'admin_adjustment\')),
delta_subtotal_cents int not null, delta_tax_cents int not null,
delta_fees_cents int not null, delta_total_cents int not null, note
text, created_by text not null, \-- usr\_\... (buyer, seller, admin)
created_at timestamptz not null default now()); \-- Payouts per leg
(Connect transfers)create table payout ( payout_id text primary key, \--
pay\_\... 

### TD-0009 (tech)

<!-- id: TD-0009 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 32400-36400 -->

time\',\'refund_line\',\'admin_adjustment\')),
delta_subtotal_cents int not null, delta_tax_cents int not null,
delta_fees_cents int not null, delta_total_cents int not null, note
text, created_by text not null, \-- usr\_\... (buyer, seller, admin)
created_at timestamptz not null default now()); \-- Payouts per leg
(Connect transfers)create table payout ( payout_id text primary key, \--
pay\_\... leg_id text not null references booking_leg(leg_id) on delete
cascade, processor text not null, \-- \'stripe\' processor_payout text,
\-- po\_\... status text not null check (status in
(\'queued\',\'in_transit\',\'paid\',\'failed\',\'canceled\',\'paused\')),
amount_cents int not null, currency text not null default \'USD\',
scheduled_for timestamptz, created_at timestamptz not null default
now(), updated_at timestamptz not null default now()); \-- Tax
transactions (per leg)create table tax_txn ( tax_txn_id text primary
key, \-- tax\_\... leg_id text not null references booking_leg(leg_id)
on delete cascade, provider text not null, \-- \'taxjar\' or \'avalara\'
or \'stripe_tax\' provider_id text not null, jurisdiction_json jsonb not
null, \-- state/city, rates quote_cents int not null, committed boolean
not null default false, created_at timestamptz not null default now());
\-- Refunds & disputescreate table refund ( refund_id text primary key,
\-- rfd\_\... lbg_id text not null references lbg(lbg_id) on delete
cascade, leg_id text not null references booking_leg(leg_id) on delete
cascade, processor text not null, processor_refund text, \-- re\_\...
amount_cents int not null, reason text not null, status text not null
check (status in (\'pending\',\'succeeded\',\'failed\')), created_at
timestamptz not null default now()); create table dispute ( dispute_id
text primary key, \-- dsp\_\... leg_id text not null references
booking_leg(leg_id) on delete cascade, processor text not null, \--
\'stripe\' processor_dispute text, \-- dp\_\... reason text not null,
status text not null check (status in
(\'needs_response\',\'under_review\',\'won\',\'lost\',\'warning_closed\')),
evidence_due_at timestamptz, created_at timestamptz not null default
now());*

**Indices**

- *booking_leg (seller_user_id, start_at)* for seller calendars.
- *booking_leg (service_profile_id)* and *booking_leg (studio_id)* for
  lookups.
- *charge_split (leg_id)* for rollups.
- Partial indexes on *booking_leg(status in
  (\'confirmed\',\'in_progress\'))* for ops scans.

## **1.3.C State machines (per leg and for LBG)**

**Leg state:**\
*draft → awaiting_docs → awaiting_payment → confirmed → in_progress →
completed*\
Failures: *cancelled*, *failed*

**LBG state:**

- Derived from legs: *draft* if any leg *draft/awaiting\_\**;
  *confirmed* if **both** legs *confirmed*; *in_progress* if any leg
  *in_progress*; *completed* if **both** *completed*; *cancelled* if
  both cancelled (or group cancelled prior to start); *failed* on
  atomicity failure pre‑confirm.

**Transitions (high‑level)**

171. **startCheckout** → create LBG + one leg (Talent) in
     *awaiting_docs*.
172. **attachStudioInFlow** (optional) → add Studio leg; both legs now
     *awaiting_docs*.
173. **createDocPack & sign** → both legs *awaiting_payment*.
174. **authorize & capture LBG charge** (PaymentIntent) → *confirmed* if
     both legs funded; else rollback.
175. **before start_at**: allow **amendments** (extras), re‑quote tax,
     adjust charge (incremental capture or second charge).
176. **at start_at**: move legs to *in_progress*.
177. **completion**: buyer acceptance or window expiry → queue
     **payouts**; auto‑void unused deposit holds.
178. **dispute/refund**: flows do not alter leg status but affect
     payout/finance ledgers; receipts amended.

**Studio deposit** lives outside the main charge and is captured only on
approved claim within a policy window.

We implement these as an **AWS Step Functions** saga for LBG with
per‑leg substates, plus outbox events to keep UI in sync.

## **1.3.D Che

### TD-0236 (tech)

<!-- id: TD-0236 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 849600-853600 -->

:true},*\
*{\"name\":\"verified\",\"type\":\"bool\",\"facet\":true},*\
*{\"name\":\"price_min\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"price_max\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"rating\",\"type\":\"float\",\"facet\":true},*\
*{\"name\":\"review_count\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"availability_score\",\"type\":\"float\"},*\
*{\"name\":\"lat\",\"type\":\"float\"},
{\"name\":\"lng\",\"type\":\"float\"},*\
*{\"name\":\"nsfw_band\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"tags\",\"type\":\"string\[\]\",\"facet\":true},*\
*{\"name\":\"published_at\",\"type\":\"int64\"}, // epoch seconds*\
*{\"name\":\"updated_at\",\"type\":\"int64\"},*\
*{\"name\":\"bio\",\"type\":\"string\"},*\
*{\"name\":\"headline\",\"type\":\"string\"},*\
*{\"name\":\"sfw_image_urls\",\"type\":\"string\[\]\"}*\
*\],*\
*\"default_sorting_field\":\"updated_at\",*\
*\"token_separators\":\[\"-\",\"\_\",\"/\",\".\"\],*\
*\"enable_nested_fields\":false*\
*},*\
*\"studios\": {*\
*\"fields\": \[*\
*{\"name\":\"id\",\"type\":\"string\"},*\
*{\"name\":\"handle\",\"type\":\"string\"},*\
*{\"name\":\"name\",\"type\":\"string\"},*\
*{\"name\":\"city\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"country\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"amenities\",\"type\":\"string\[\]\",\"facet\":true},*\
*{\"name\":\"verified\",\"type\":\"bool\",\"facet\":true},*\
*{\"name\":\"hourly_min\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"rating\",\"type\":\"float\",\"facet\":true},*\
*{\"name\":\"review_count\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"lat\",\"type\":\"float\"},
{\"name\":\"lng\",\"type\":\"float\"},*\
*{\"name\":\"availability_score\",\"type\":\"float\"},*\
*{\"name\":\"nsfw_band\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"published_at\",\"type\":\"int64\"},*\
*{\"name\":\"updated_at\",\"type\":\"int64\"},*\
*{\"name\":\"sfw_image_urls\",\"type\":\"string\[\]\"}*\
*\],*\
*\"default_sorting_field\":\"updated_at\"*\
*},*\
*\"work\": {*\
*\"fields\": \[*\
*{\"name\":\"id\",\"type\":\"string\"},*\
*{\"name\":\"author_id\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"title\",\"type\":\"string\"},*\
*{\"name\":\"roles\",\"type\":\"string\[\]\",\"facet\":true},*\
*{\"name\":\"city\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"nsfw_band\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"published_at\",\"type\":\"int64\"},*\
*{\"name\":\"sfw_image_urls\",\"type\":\"string\[\]\"},*\
*{\"name\":\"body\",\"type\":\"string\"}*\
*\],*\
*\"default_sorting_field\":\"published_at\"*\
*},*\
*\"help\": {*\
*\"fields\": \[*\
*{\"name\":\"id\",\"type\":\"string\"},*\
*{\"name\":\"slug\",\"type\":\"string\"},*\
*{\"name\":\"title\",\"type\":\"string\"},*\
*{\"name\":\"category\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"body\",\"type\":\"string\"},*\
*{\"name\":\"updated_at\",\"type\":\"int64\"}*\
*\],*\
*\"default_sorting_field\":\"updated_at\"*\
*}*\
*}*\

**Safe‑Mode invariant:** All three public collections carry *nsfw_band*.
Public queries always enforce *nsfw_band \<= 1*. Email/OG previews never
fetch non‑SFW fields.

## **1.18.4 Indexer pipeline**

**Outbox table** (*db/migrations/025_search_outbox.sql*):

*begin;*\
*create schema if not exists search;*\
\
*create table search.outbox (*\
*event_id bigserial primary key,*\
*entity text not null check (entity in
(\'person\',\'studio\',\'work\',\'help\')),*\
*entity_id text not null,*\
*op text not null check (op in (\'upsert\',\'delete\')),*\
*payload jsonb not null,*\
*created_at timestamptz default now(),*\
*processed boolean not null default false*\
*);*\
*create index on search.outbox (processed, created_at);*\
*commit;*\

**Flow**

3882. Application services write normalized docs into *payload* (already
      SFW‑filtered if public).
3883. **Indexer Lambda** (every 1--2 minutes, or triggered by DB notify)
      upserts/deletes in Typesense.
3884. On success, mark *processed=true*. Failures retry 

### TD-0237 (tech)

<!-- id: TD-0237 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 853200-857200 -->


*processed boolean not null default false*\
*);*\
*create index on search.outbox (processed, created_at);*\
*commit;*\

**Flow**

3882. Application services write normalized docs into *payload* (already
      SFW‑filtered if public).
3883. **Indexer Lambda** (every 1--2 minutes, or triggered by DB notify)
      upserts/deletes in Typesense.
3884. On success, mark *processed=true*. Failures retry with back‑off;
      poison records alert.

**Normalization rules**

- People/studios include **availability_score** computed from §1.12
  feasible slots next 14 days (0--1).
- Ratings only included when *review_count ≥ 5* to avoid cold‑start
  bias.
- City + geo lat/lng always present for geosearch queries.

## **1.18.5 Query model & GraphQL**

**GraphQL (*****api/schema/search.graphql*****)**

*type SearchHit {*\
*id: ID!, kind: String!, score: Float!,*\
*title: String!, subtitle: String, city: String,*\
*image: AWSURL, verified: Boolean, rating: Float, reviewCount: Int,*\
*priceMin: Int, priceMax: Int, badges: \[String!\]*\
*}*\
*type SearchResults { hits: \[SearchHit!\]!, nextCursor: String }*\
\
*input PeopleFilter {*\
*city: String, roles: \[String!\], priceMin: Int, priceMax: Int,*\
*verified: Boolean, any: AWSJSON, all: AWSJSON*\
*}*\
*input StudiosFilter {*\
*city: String, amenities: \[String!\], hourlyMax: Int, verified:
Boolean*\
*}*\
*input WorkFilter { city: String, roles: \[String!\] }*\
\
*type Query {*\
*searchPeople(q: String, filter: PeopleFilter, sort: String, cursor:
String, limit: Int = 24): SearchResults!*\
*searchStudios(q: String, filter: StudiosFilter, sort: String, cursor:
String, limit: Int = 24): SearchResults!*\
*searchWork(q: String, filter: WorkFilter, sort: String, cursor: String,
limit: Int = 24): SearchResults!*\
*suggest(q: String!, scope: String!): \[String!\]! \# scope:
people\|studios\|work*\
*}*\

**Sorting options**

- *best* (default blended rank), *new*, *distance*, *price_low*,
  *price_high*, *rating*.
- Distance sorting requires an origin; otherwise fallback to *best*.

## **1.18.6 Ranking formula (blended relevance)**

**People/Studios rank score** (computed in search Lambda; weights
tunable via config):

*score = 0.45 \* text_match*\
* + 0.20 \* proximity_score \# inverse distance; city exact match gets
1.0*\
* + 0.12 \* verified_boost \# 1 if verified, else 0*\
* + 0.10 \* availability_score \# 0..1 next-14-days slots*\
* + 0.08 \* quality_score \# normalized rating \* log(review_count+1)*\
* + 0.05 \* freshness_score \# recency of update/publish*\

**Personalization boosts** (applied multiplicatively, capped):

- **Followed** author/studio: ×1.10
- **Recent engagement** (viewed profile or messaged in last 30 days):
  ×1.05
- **Blocked** author/studio: hard exclude
- **Same user**: hard exclude

**Anti‑gaming**:

- Clamp rating influence when *review_count \< 5*.
- Diminish freshness boost if an account edits too frequently
  (change‑rate limiter).

## **1.18.7 Facets & filters**

- **People**: *roles*, *city*, *price bands* (derived), *verified*,
  *tags*.
- **Studios**: *city*, *amenities*, *verified*, *hourly_max* band.
- **Work**: *roles*, *city*.
- **Safe‑Mode**: all public queries append filter *nsfw_band \<= 1*.
  Logged‑in 18+ areas use protected routes; never leak to public.

**ANY/ALL**: identical to the §1.16 contract; we normalize the filter
JSON and memoize a hash key for caching.

## **1.18.8 Spelling, synonyms & suggestions**

- **Synonyms**: role map ("photographer" ↔ "photo", "modeling" ↔
  "model").
- **Typos**: Typesense typo tolerance up to **2**; distance reduces
  *text_match*.
- **Suggestions**: prefix search over *handle*, *display_name*, *city*,
  and frequent tags with Safe‑Mode gate.

## **1.18.9 Availability & pricing integration**

- **availability_score** = sigmoid of available slot count in next 14
  days for the role; updated hourly during active hours.
- **price bands**: server computes band field (*\$*, *\$\$*, *\$\$\$*)
  from price_min/max; used for fa

### TD-0238 (tech)

<!-- id: TD-0238 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 856800-860800 -->

ch*.
- **Suggestions**: prefix search over *handle*, *display_name*, *city*,
  and frequent tags with Safe‑Mode gate.

## **1.18.9 Availability & pricing integration**

- **availability_score** = sigmoid of available slot count in next 14
  days for the role; updated hourly during active hours.
- **price bands**: server computes band field (*\$*, *\$\$*, *\$\$\$*)
  from price_min/max; used for faceting and sort.

## **1.18.10 Caching, pagination & rate limits**

- **Caching**: Dynamo (2--10 min TTL) for hot queries (top city×role
  combos). Cache keys include normalized filters and **user
  personalization hash** (follow list digest) so boosts don't leak.
- **Pagination**: Typesense *page* mapped to **cursor** tokens (opaque).
- **Rate limits**: per‑IP and per‑user QPS with soft CAPTCHA on abuse;
  suggestion endpoint stricter.

## **1.18.11 Security, safety & privacy**

- **Safe‑Mode** always appended on public; staff/admin override via
  signed header only on internal consoles.
- **PII** never indexed (emails, phones); we index only public‑consent
  fields.
- **Takedowns** (DMCA/policy from §1.15) result in outbox *delete*
  events; purge within **≤ 5 minutes**.

## **1.18.12 Observability & KPIs**

- **Events**: *search.query*, *search.suggest*, *search.result_click*,
  *search.zero_results*, *index.upsert\|delete\|error*.
- **KPIs**: query→profile‑view CTR, profile‑view→checkout start rate,
  zero‑result rate, cache hit rate, p95 search latency, index staleness
  (time since last upsert for hot docs).
- **Alerts**: zero‑results spike, index backlog \> N, search latency p95
  \> target, outbox error rate.

## **1.18.13 Work packages (Cursor --- 4 agents)**

- **Agent A --- Indexer**: outbox DDL, indexer Lambda (upsert/delete),
  normalization, retries/back‑off, poison‑queue alarms.
- **Agent B --- Search API**: GraphQL schema & resolver, query builder,
  ranking, Safe‑Mode enforcement, caching & cursoring.
- **Agent C --- Frontend UX**: search box + suggestions, filters/facets,
  result cards, sort modes, skeletons, empty‑state flows.
- **Agent D --- Ops & Quality**: synonyms/typos config,
  dashboards/alerts, AB test hooks for ranking weights.

## **1.18.14 Tests (representative)**

3918. **Relevance**: exact match outranks partial; verified/available
      boosts apply; proximity sorting stable.
3919. **Safety**: NSFW assets never appear in public results; staff
      override works only with signed header.
3920. **Index freshness**: profile update triggers outbox → upsert →
      visible within SLA (\<5 min).
3921. **Spelling**: 1--2 typos produce correct top‑k; synonyms map
      correctly.
3922. **Personalization**: followed creators boosted; blocked excluded;
      cache separation by personalization digest.
3923. **Performance**: p95 search API latency \< 200 ms for cached; \<
      450 ms for cache misses at steady load.
3924. **Abuse**: rapid query spam triggers rate limit; suggestions
      endpoint throttles earlier.
3925. **Zero results**: "did‑you‑mean" suggestions shown; log for
      analysis.

## **1.18.15 Artifacts (paste‑ready)**

- *ops/typesense/collections.json* --- schema above.
- *db/migrations/025_search_outbox.sql* --- outbox table.
- *api/schema/search.graphql* --- GraphQL API.
- *services/search/indexer.ts* --- upsert/delete pipeline.
- *services/search/query.ts* --- query builder & ranker.
- *web/components/Search/\** --- UX components (search box, results,
  facets).
- *observability/dashboards/search.md* --- KPIs & alert specs.
- *ops/runbooks/search-index.md* --- reindex, synonyms, and rollback
  procedures.

## **1.18.16 Acceptance criteria --- mark §1.18 FINAL only when ALL true**

3934. People/Studios/Work are indexed with Safe‑Mode fields and upsert
      within **≤ 5 minutes** of changes.
3935. Search supports **text + facets + geo + sort**, with **ANY/ALL**
      filters, cursor pagination, and suggestions; public queries never
      leak NSFW.
3936. Ranking blends relevance, proximity,

### TD-0239 (tech)

<!-- id: TD-0239 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 860400-864400 -->

cedures.

## **1.18.16 Acceptance criteria --- mark §1.18 FINAL only when ALL true**

3934. People/Studios/Work are indexed with Safe‑Mode fields and upsert
      within **≤ 5 minutes** of changes.
3935. Search supports **text + facets + geo + sort**, with **ANY/ALL**
      filters, cursor pagination, and suggestions; public queries never
      leak NSFW.
3936. Ranking blends relevance, proximity, verified, availability,
      quality, and freshness; personalization boosts and blocks work.
3937. Caching yields high hit rate on hot city×role queries; p95 latency
      meets targets.
3938. Synonyms/typos configured; "did‑you‑mean" operates; zero‑result
      rate tracked.
3939. Dashboards live; alarms for index backlog, zero‑results spikes,
      and latency.
3940. Cost profile within budget (single Typesense node for MVP, scale
      plan documented).

# **§1.19 --- Studios & Spaces (Listings, Availability, Booking Rules & Verification)**

**Full Technical Development Plan (copy‑paste block for your project
doc)**

**Purpose.** Model, publish, and book **places** (studios/spaces)
distinctly from **people** (service profiles), with their own fields,
pricing, buffers, rules, deposits, verification (**Studio Lite →
Verified Studio**), and policies. Integrates tightly with **Calendar
(§1.12)**, **Payments (§1.13)**, **Orders (§1.14)**, **Support
(§1.15)**, **Growth & SEO (§1.16--§1.17)**, and **Search (§1.18)**.
Cost‑conscious, Safe‑Mode compliant (SFW previews only on public), and
auditable.

## **1.19.1 Objectives & invariants**

3941. **People ≠ Places.** Studios are separate first‑class entities; no
      confusion in reviews, pricing, or policies.
3942. **Commercially complete.** Support hourly & day pricing, minimums,
      **buffers**, **overtime**, **cleaning**, **add‑ons**,
      **deposits**, and **insurance/permits** flags.
3943. **Verification first.** **Studio Lite** (documented address &
      control) → **Verified Studio** badge; gate **Instant Book** & city
      spotlight.
3944. **Safe & SFW.** Public pages render SFW images; PII & exact
      addresses gated until booking/approval when required.
3945. **Availability is truthful.** Templates & per‑date overrides; IB
      may require verification or host confirmation.
3946. **Atomic booking.** No partial double‑books; group holds convert
      or expire together.
3947. **Refund rules differ from people.** Studios follow their own
      **time‑band kernel** (see §1.15 & below).
3948. **Elastic cost.** Use serverless + Aurora + S3 + AppSync;
      geocoding via AWS Location; search via Typesense (§1.18).

## **1.19.2 Data model (Aurora, schema** ***studio*****) --- paste‑ready DDL**

Create *db/migrations/026_studios.sql*:

*begin;*\
\
*create schema if not exists studio;*\
\
*create type studio.verification_status as enum
(\'unverified\',\'lite_verified\',\'verified\');*\
*create type studio.publish_status as enum
(\'draft\',\'review\',\'published\',\'suspended\');*\
*create type studio.price_unit as enum (\'hour\',\'day\');*\
*create type studio.rule_kind as enum
(\'noise\',\'footwear\',\'food_drink\',\'smoking\',\'animals\',\'capacity\',\'other\');*\
*create type studio.addon_charge_kind as enum
(\'flat\',\'per_hour\',\'per_person\');*\
*create type studio.deposit_kind as enum
(\'authorization_hold\',\'charge_refundable\',\'nonrefundable_fee\');*\
\
*\-- Core studio listing (place)*\
*create table studio.listing (*\
*studio_id text primary key, \-- std\_\...*\
*owner_user_id text not null, \-- usr\_\...*\
*handle text not null unique, \-- public slug*\
*name text not null,*\
*headline text,*\
*description_md text not null,*\
*publish_status studio.publish_status not null default \'draft\',*\
*verification studio.verification_status not null default
\'unverified\',*\
*instant_book boolean not null default false,*\
*city text not null,*\
*country text not null,*\
*neighborhood text,*\
*address_hash text, \-- hashed; full address stored in secure table*\
*lat double 

### TD-0240 (tech)

<!-- id: TD-0240 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 864000-868000 -->

,*\
*headline text,*\
*description_md text not null,*\
*publish_status studio.publish_status not null default \'draft\',*\
*verification studio.verification_status not null default
\'unverified\',*\
*instant_book boolean not null default false,*\
*city text not null,*\
*country text not null,*\
*neighborhood text,*\
*address_hash text, \-- hashed; full address stored in secure table*\
*lat double precision not null,*\
*lng double precision not null,*\
*h3_7 text, \-- coarse geo cell (search buckets)*\
*sqft int,*\
*capacity int,*\
*base_unit studio.price_unit not null default \'hour\',*\
*hourly_min int not null, \-- cents*\
*day_rate_cents int, \-- optional*\
*min_hours numeric(4,2) not null default 2.0,*\
*cleaning_fee_cents int not null default 0,*\
*overtime_rate_pct int not null default 150, \-- % of hourly_min per
overtime unit*\
*buffer_before_min int not null default 30,*\
*buffer_after_min int not null default 30,*\
*deposit_kind studio.deposit_kind,*\
*deposit_cents int,*\
*insurance_required boolean not null default false,*\
*nsfw_band int not null default 0, \-- 0=SFW*\
*verified_chip boolean not null default false,*\
*ratings_avg numeric(3,2) default 0.0,*\
*ratings_count int not null default 0,*\
*created_at timestamptz default now(),*\
*updated_at timestamptz default now()*\
*);*\
\
*\-- Secure address table (PII / precise location)*\
*create table studio.address_secret (*\
*studio_id text primary key references studio.listing(studio_id) on
delete cascade,*\
*address_line1 text not null,*\
*address_line2 text,*\
*postal_code text,*\
*state_region text,*\
*country text not null,*\
*access_notes text, \-- gate code, freight elevator details; shown after
booking*\
*created_at timestamptz default now(),*\
*updated_at timestamptz default now()*\
*);*\
\
*\-- Amenities (facet)*\
*create table studio.amenity (*\
*amenity_id text primary key, \-- sam\_\...*\
*name text not null unique,*\
*group_name text not null \--
lighting\|backdrops\|props\|parking\|power\|sound\|other*\
*);*\
\
*create table studio.listing_amenity (*\
*studio_id text not null references studio.listing(studio_id) on delete
cascade,*\
*amenity_id text not null references studio.amenity(amenity_id) on
delete restrict,*\
*primary key (studio_id, amenity_id)*\
*);*\
\
*\-- House rules*\
*create table studio.rule (*\
*rule_id text primary key, \-- srl\_\...*\
*studio_id text not null references studio.listing(studio_id) on delete
cascade,*\
*kind studio.rule_kind not null,*\
*text_md text not null*\
*);*\
\
*\-- Add-ons*\
*create table studio.addon (*\
*addon_id text primary key, \-- sad\_\...*\
*studio_id text not null references studio.listing(studio_id) on delete
cascade,*\
*name text not null,*\
*description_md text,*\
*charge_kind studio.addon_charge_kind not null,*\
*amount_cents int not null,*\
*taxable boolean not null default true*\
*);*\
\
*\-- Availability templates & overrides*\
*create table studio.availability_template (*\
*template_id text primary key, \-- sat\_\...*\
*studio_id text not null references studio.listing(studio_id) on delete
cascade,*\
*dow int not null check (dow between 0 and 6), \-- 0=Sun*\
*start_min int not null, \-- minutes from midnight*\
*end_min int not null*\
*);*\
\
*create table studio.blackout (*\
*blackout_id text primary key, \-- sbo\_\...*\
*studio_id text not null references studio.listing(studio_id) on delete
cascade,*\
*starts_at timestamptz not null,*\
*ends_at timestamptz not null,*\
*reason text*\
*);*\
\
*\-- Verification documents (Studio Lite)*\
*create table studio.verification_doc (*\
*doc_id text primary key, \-- svd\_\...*\
*studio_id text not null references studio.listing(studio_id) on delete
cascade,*\
*kind text not null, \--
utility_bill\|lease\|business_license\|tax\|photo_outside*\
*s3_key text not null,*\
*status text not null default \'submitted\', \--
submitted\|approved\|rejected*\
*reviewer_id text, \-- admin*\
*reviewed_at timestamptz,*\
*note text,*\
*created_at timestamptz default n

### TD-0241 (tech)

<!-- id: TD-0241 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 867600-871600 -->

ey, \-- svd\_\...*\
*studio_id text not null references studio.listing(studio_id) on delete
cascade,*\
*kind text not null, \--
utility_bill\|lease\|business_license\|tax\|photo_outside*\
*s3_key text not null,*\
*status text not null default \'submitted\', \--
submitted\|approved\|rejected*\
*reviewer_id text, \-- admin*\
*reviewed_at timestamptz,*\
*note text,*\
*created_at timestamptz default now()*\
*);*\
\
*commit;*\

**Notes**

- We keep **address_secret** separate to gate exact location until
  needed.
- **h3_7** pre‑computed for geo bucketing; search still uses lat/lng
  (§1.18).
- **deposit_kind** allows holds vs actual charges; aligns with Stripe
  Connect flows (§1.13).
- **availability_template/blackout** integrate with §1.12; studios obey
  buffers & open hours.

## **1.19.3 GraphQL (AppSync) --- paste‑ready schema**

Create *api/schema/studio.graphql*:

*enum StudioPublish { DRAFT REVIEW PUBLISHED SUSPENDED }*\
*enum StudioVerify { UNVERIFIED LITE_VERIFIED VERIFIED }*\
*enum DepositKind { AUTHORIZATION_HOLD CHARGE_REFUNDABLE
NONREFUNDABLE_FEE }*\
*enum PriceUnit { HOUR DAY }*\
\
*type Amenity { id: ID!, name: String!, group: String! }*\
*type Addon { id: ID!, name: String!, descriptionMd: String, chargeKind:
String!, amountCents: Int!, taxable: Boolean! }*\
*type Rule { id: ID!, kind: String!, textMd: String! }*\
*type AvailabilityTemplate { id: ID!, dow: Int!, startMin: Int!, endMin:
Int! }*\
*type Blackout { id: ID!, startsAt: AWSDateTime!, endsAt: AWSDateTime!,
reason: String }*\
\
*type Studio {*\
*id: ID!, handle: String!, name: String!, headline: String,
descriptionMd: String!,*\
*publish: StudioPublish!, verify: StudioVerify!, instantBook:
Boolean!,*\
*city: String!, country: String!, neighborhood: String, lat: Float!,
lng: Float!,*\
*sqft: Int, capacity: Int, baseUnit: PriceUnit!, hourlyMin: Int!,
dayRateCents: Int,*\
*minHours: Float!, cleaningFeeCents: Int!, overtimeRatePct: Int!,*\
*bufferBeforeMin: Int!, bufferAfterMin: Int!, depositKind: DepositKind,
depositCents: Int,*\
*insuranceRequired: Boolean!, nsfwBand: Int!, verifiedChip: Boolean!,*\
*ratingsAvg: Float, ratingsCount: Int!,*\
*amenities: \[Amenity!\]!, rules: \[Rule!\]!, addons: \[Addon!\]!,*\
*availability: \[AvailabilityTemplate!\]!, blackouts: \[Blackout!\]!*\
*}*\
\
*input StudioInput {*\
*handle: String!, name: String!, headline: String, descriptionMd:
String!,*\
*city: String!, country: String!, neighborhood: String,*\
*lat: Float!, lng: Float!, sqft: Int, capacity: Int,*\
*baseUnit: PriceUnit = HOUR, hourlyMin: Int!, dayRateCents: Int,*\
*minHours: Float = 2.0, cleaningFeeCents: Int = 0, overtimeRatePct: Int
= 150,*\
*bufferBeforeMin: Int = 30, bufferAfterMin: Int = 30,*\
*depositKind: DepositKind, depositCents: Int, insuranceRequired: Boolean
= false*\
*}*\
\
*type Query {*\
*studioByHandle(handle: String!): Studio*\
*myStudios: \[Studio!\]! \@auth(role: \"owner\")*\
*}*\
\
*type Mutation {*\
*createStudio(input: StudioInput!): ID! \@auth(role: \"owner\")*\
*updateStudio(studioId: ID!, input: StudioInput!): Boolean! \@auth(role:
\"owner\")*\
*setStudioPublish(studioId: ID!, state: StudioPublish!): Boolean!
\@auth(role: \"owner\")*\
*setStudioInstantBook(studioId: ID!, enabled: Boolean!): Boolean!
\@auth(role: \"owner\")*\
\
*addAmenity(name: String!, group: String!): ID! \@auth(role:
\"admin\")*\
*addStudioAmenity(studioId: ID!, amenityId: ID!): Boolean! \@auth(role:
\"owner\")*\
\
*addRule(studioId: ID!, kind: String!, textMd: String!): ID!
\@auth(role: \"owner\")*\
*addAddon(studioId: ID!, name: String!, descriptionMd: String,
chargeKind: String!, amountCents: Int!, taxable: Boolean = true): ID!
\@auth(role: \"owner\")*\
\
*addAvailability(studioId: ID!, dow: Int!, startMin: Int!, endMin:
Int!): ID! \@auth(role: \"owner\")*\
*addBlackout(studioId: ID!, startsAt: AWSDateTime!, endsAt:
AWSDateTime!, reason: String): ID! \@auth(role: \"owner\")*\
\
*submitStudioDoc(studioId: ID!, kind: String!, s3Key: String!): ID!
\@auth(role: \"owner\

### TD-0242 (tech)

<!-- id: TD-0242 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 871200-875200 -->

ring!, amountCents: Int!, taxable: Boolean = true): ID!
\@auth(role: \"owner\")*\
\
*addAvailability(studioId: ID!, dow: Int!, startMin: Int!, endMin:
Int!): ID! \@auth(role: \"owner\")*\
*addBlackout(studioId: ID!, startsAt: AWSDateTime!, endsAt:
AWSDateTime!, reason: String): ID! \@auth(role: \"owner\")*\
\
*submitStudioDoc(studioId: ID!, kind: String!, s3Key: String!): ID!
\@auth(role: \"owner\")*\
*reviewStudioDoc(docId: ID!, approve: Boolean!, note: String): Boolean!
\@auth(role: \"trust_safety\")*\
*}*\

**Auth & privacy**

- Owner‑only mutations for their own studios; **Trust & Safety** reviews
  documents.
- Precise address only visible to confirmed bookings, support, or admins
  via case scope.

## **1.19.4 Studio pricing & booking kernel (integration with §1.12 & §1.14)**

**Pricing calculator** (server function):

*base = hours \* hourly_min OR day_rate (if selected)*\
*apply min_hours (ceil to nearest 0.5h)*\
*addons = sum(addon.amount × (per_hour? hours : per_person? party_size :
1))*\
*cleaning_fee = flat*\
*subtotal = base + addons + cleaning_fee*\
*overtime = actual_time \> booked? (delta_hours \* hourly_min \*
overtime_rate_pct/100) else 0*\
*deposit = deposit_cents (hold or charge based on deposit_kind)*\
*platform_fee = % × subtotal (see §1.13)*\
*taxes = jurisdictional rules (see §1.13)*\
*total_due_at_booking = subtotal + platform_fee + taxes (excl. deposit
if hold)*\

**Time‑band refund kernel (studios)** *(aligned with §1.15)*:

- ≥72h → full refund of subtotal + platform fee refundable
- 24--72h → 50% of subtotal
- \<24h → 0%; deposit forfeiture if **nonrefundable_fee**
- Provider cancel → full refund + auto‑apology credit (configurable) +
  IB pause macro

**Atomic holds & conversion**:

- When buyer initiates studio checkout, create **calendar hold** (see
  §1.12) that includes **buffers**.
- On payment success, convert hold to booking; on failure/abandon,
  **release** holds automatically.

## **1.19.5 Calendar & availability details (studios)**

- **Templates** per DOW + **blackouts** compute open intervals.
- **Buffers** applied before/after the booking; enforces cleaning/setup
  time.
- **Overnight/multi‑day**: if *base_unit=day*, spans entire open hours;
  optional after‑hours surcharge.
- **Conflict resolution**: Studio holds/bookings live in
  *calendar.event* with *resource_id=std\_\**; conflict check is
  **resource‑scoped** (separate from people).
- **ICS**: read‑only import allowed (Phase‑2), outbound ICS file for
  confirmed bookings to host & buyer.

## **1.19.6 Media & SFW policy**

- Public studio pages only render **SFW** images; private albums may
  include sensitive behind‑the‑scenes content, accessible to buyer
  post‑booking.
- OG/sharecards use **SFW** variant (see §1.16).
- DMCA takedown (Support §1.15) hides assets and revalidates ISR within
  ≤ 10 minutes.

## **1.19.7 Verification --- Studio Lite → Verified Studio**

**Inputs** (any two required for Lite):

- Utility bill or lease showing address & name;
- Business license or tax document;
- Geo‑verified exterior photo (time‑stamped);
- Optional insurance certificate upload.

**Flow**

- Owner uploads docs (to S3 private); **Trust & Safety** reviews in
  console → approve/reject with note.
- On **approved**, set *verification=\'lite_verified\'* and
  *verified_chip=true*; **Instant Book** can be enabled
  (policy‑controlled).
- Flags: *insurance_required* toggles buyer disclosure and "Recommended
  permits/COI" notice.

## **1.19.8 Checkout specifics for studios**

- **Address disclosure.** Full address unlocks **after** booking
  confirmation; before that, show **neighborhood** and generic map pin.
- **IDV/phone** gate (optional): for high‑risk studios, require buyer
  IDV before confirming.
- **Deposit capture.** If *authorization_hold*, create Stripe auth (void
  on clean checkout); if *charge_refundable*, refund on no‑damage
  (support case closes); if *nonrefundable_fee*, non‑reversible.
- **Add‑ons** selectable at checko

### TD-0243 (tech)

<!-- id: TD-0243 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 874800-878800 -->

firmation; before that, show **neighborhood** and generic map pin.
- **IDV/phone** gate (optional): for high‑risk studios, require buyer
  IDV before confirming.
- **Deposit capture.** If *authorization_hold*, create Stripe auth (void
  on clean checkout); if *charge_refundable*, refund on no‑damage
  (support case closes); if *nonrefundable_fee*, non‑reversible.
- **Add‑ons** selectable at checkout; additional add‑ons can be added
  **post‑booking** via an amendment order (Action Card §1.14).

## **1.19.9 Search, SEO & growth integration**

- **Search facets**: *city*, *amenities\[\]*, *verified*, *hourly_min*,
  *nsfw_band* (always ≤1 for public). (§1.18)
- **Programmatic pages**: city×"studios" landing in SEO (§1.17) with
  unique copy & SFW hero.
- **Feed**: "Studio slot open next weekend" post type (growth §1.16).
- **Referrals**: provider‑invites‑provider awards once a studio
  publishes and completes first booking (§1.16).

## **1.19.10 Notifications (§1.10)**

- **Buyer**: booking request received/approved/declined; deposit status;
  overtime/cleaning fee adjustments.
- **Host**: new request; IB confirmation; calendar conflicts; deposit
  released; dispute opened.
- **Admin**: P0 failures (double‑book), high‑value charge fail,
  suspicious doc patterns.

## **1.19.11 Observability, KPIs & SLOs**

**Events**:\
*studio.create\|publish\|suspend*,
*studio.doc.submit\|approve\|reject*,\
*studio.booking.request\|confirm\|cancel\|no_show*,\
*studio.deposit.hold\|capture\|void\|refund*,\
*calendar.hold.apply\|convert\|release* (resource=studio),\
*checkout.overtime\|cleaning.adjust*.

**KPIs**:

- Publish→first booking time; IB share; cancellation rate by time band;
  deposit usage rate; overtime incidence; SFW compliance errors; dispute
  rate.

**SLOs**:

- Hold apply/convert/release actions **\< 500 ms** p95; verification
  review p95 **≤ 24h**; double‑booking incidents **= 0**.

## **1.19.12 Cost posture & dependencies**

- **Amplify Hosting (Gen‑2)** + **AppSync** + **Lambda** + **Aurora
  Serverless v2** + **S3 + CloudFront** + **AWS Location** (geocoding &
  maps) + **Typesense** (already deployed in §1.18).
- All compute paths are **serverless** except Typesense (ECS Fargate
  single‑node MVP).
- Image transforms at edge (Lambda@Edge/CloudFront functions) to keep
  CWV budgets (§1.17) while minimizing egress.

## **1.19.13 Work packages (Cursor --- 4 agents)**

- **Agent A --- Data & API Core**: DDL, GraphQL, secure address split,
  amenity/rule/add‑on subresources, verification docs.
- **Agent B --- Availability & Kernel**: availability template +
  blackouts; pricing kernel; buffers; overtime; deposit flows; Action
  Card hooks (§1.14).
- **Agent C --- UI/Front‑of‑house**: create/edit studio flow, media
  uploader (SFW default), public studio page, checkout widgets (add‑ons,
  deposits), post‑booking address reveal.
- **Agent D --- Admin & Ops**: verification console, moderation,
  suspension, ISR revalidation hooks, dashboards & alerts.

## **1.19.14 Tests (representative)**

3996. **Publish gating**: unverified studios cannot enable IB; Verified
      Studio badge renders post‑approval.
3997. **Pricing calculator**: min hours honored; overtime computed
      correctly; deposit applied per kind; add‑ons taxable flags
      respected.
3998. **Availability**: buffers enforce no overlaps; blackouts
      respected; overnight/day bookings supported.
3999. **Atomic holds**: holds apply and convert; failure releases;
      double‑book impossible.
4000. **Address privacy**: only visible to confirmed bookings & admins;
      neighborhood/pin shows to others.
4001. **Search/SEO**: facets present; public pages SFW; city×studios
      pages pass thin content gates (§1.17).
4002. **Verification**: document upload/review; rejection reasons
      stored; badge toggles.
4003. **Deposits**: auth hold → void on clean checkout; refundable
      charge → refund on resolution; nonrefundable fee → nonreversible.
4004. **Support**: dispu

### TD-0244 (tech)

<!-- id: TD-0244 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 878400-882400 -->

orhood/pin shows to others.
4001. **Search/SEO**: facets present; public pages SFW; city×studios
      pages pass thin content gates (§1.17).
4002. **Verification**: document upload/review; rejection reasons
      stored; badge toggles.
4003. **Deposits**: auth hold → void on clean checkout; refundable
      charge → refund on resolution; nonrefundable fee → nonreversible.
4004. **Support**: dispute attaches evidence (before/after photos,
      check‑in/out times), kernel applied for refunds, admin audit logs
      emitted.

## **1.19.15 Artifacts checklist (paste‑ready)**

- *db/migrations/026_studios.sql* --- schema above.
- *api/schema/studio.graphql* --- API above.
- *services/studio/pricing.ts* --- calculator & overtime/deposit logic.
- *services/studio/availability.ts* --- open intervals + buffer logic;
  ICS export.
- *services/studio/verification.ts* --- doc submission & review.
- *web/studio/\** --- create/edit, public page, checkout components.
- *observability/dashboards/studios.md* --- KPIs, SLOs, and alerts.
- *ops/runbooks/studio-verification.md*,
  *ops/runbooks/studio-outage.md*.

## **1.19.16 Acceptance criteria --- mark §1.19 FINAL only when ALL true**

4013. Owners can create/publish studios with **amenities, rules,
      add‑ons**, and SFW media; **Verified Studio** badge appears after
      doc approval.
4014. **Availability templates + blackouts + buffers** enforce truthful
      slots; holds/booking conversion are atomic; no double‑books.
4015. **Pricing** (min hours, day rate, add‑ons, cleaning, **overtime**)
      and **deposits** (hold/charge/nonrefundable) compute and settle
      correctly.
4016. **Address privacy**: exact location gated post‑confirmation;
      pre‑booking shows neighborhood + generic pin.
4017. **Search & SEO**: studios appear with proper facets; city×studio
      landings render unique content and pass SFW rules.
4018. **Support & disputes**: evidence pack includes check‑in/out and
      photos; time‑band refund kernel applies; admin audit logs are
      complete.
4019. **Costs** stay within serverless plan; no unbounded compute.
      Dashboards & alerts live for verification backlogs and double‑book
      incidents.

# **§1.20 --- Help Center & Knowledge Base (Self‑Serve Support & Guided Flows)**

**Full Technical Development Plan (single, copy‑paste block for your
master doc)**

**Purpose.** Deflect common questions with a **public Help Center** and
**in‑product guided flows**, reduce ticket volume, and improve
first‑contact resolution while staying Safe‑Mode compliant and
SEO‑friendly. Integrates tightly with **Support/Disputes (§1.15)**,
**Notifications (§1.10)**, **SEO (§1.17)**, **Search (§1.18)**, and
**Studios/People bookings (§1.12--§1.14)**.

## **1.20.1 Objectives & invariants**

4020. **Deflection without dead‑ends.** Every path ends with either a
      solved step or a one‑click way to **open a typed Support Case**
      pre‑filled with evidence (§1.15).
4021. **Safety & privacy.** Public content is **SFW**; no PII, no
      internal links; DMCA/policy takedowns propagate within **≤10
      minutes**.
4022. **Searchable & indexable.** SEO‑ready JSON‑LD (*FAQPage*,
      *BreadcrumbList*) and sitemaps; **noindex** for internal‑only
      articles.
4023. **Continuous review.** Every article has an **owner**, **review
      interval**, and **last‑reviewed** timestamp; stale content is
      auto‑flagged.
4024. **Low cost.** Static generation (ISR) + CDN; serverless authoring
      & ingestion; Typesense index shared with §1.18 (*help*
      collection).
4025. **Localization‑ready.** Content stored with *locale*, falls back
      to English when missing; *hreflang* in SEO pages.

## **1.20.2 Information architecture**

- **Top categories** (examples): Account, Messaging, Bookings, Payments
  & Payouts, Studios & Spaces, Disputes & Refunds, Safety & Policy,
  Technical Issues.

- **Article types**:

  - How‑to (step‑by‑step)
  - Policy (rules, penalties, allowed/prohibit

### TD-0245 (tech)

<!-- id: TD-0245 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 882000-886000 -->

ady.** Content stored with *locale*, falls back
      to English when missing; *hreflang* in SEO pages.

## **1.20.2 Information architecture**

- **Top categories** (examples): Account, Messaging, Bookings, Payments
  & Payouts, Studios & Spaces, Disputes & Refunds, Safety & Policy,
  Technical Issues.

- **Article types**:

  - How‑to (step‑by‑step)
  - Policy (rules, penalties, allowed/prohibited)
  - Troubleshooter (guided flow)
  - FAQ (Q/A)
  - Release note (changelogs; optional public)

- **Visibility**: *public* vs *internal* (internal for agents only;
  never indexed).

## **1.20.3 Data model (Aurora, schema** ***kb*****) --- paste‑ready DDL**

Create *db/migrations/027_helpcenter.sql*:

*begin;*\
\
*create schema if not exists kb;*\
\
*create type kb.article_kind as enum
(\'howto\',\'policy\',\'troubleshooter\',\'faq\',\'release\');*\
*create type kb.visibility as enum (\'public\',\'internal\');*\
*create type kb.review_status as enum (\'fresh\',\'due\',\'overdue\');*\
*create type kb.locale_code as enum (\'en\',\'es\'); \-- extend as
needed*\
\
*create table kb.article (*\
*article_id text primary key, \-- kba\_\...*\
*slug text not null unique, \-- canonical, kebab-case*\
*kind kb.article_kind not null,*\
*visibility kb.visibility not null default \'public\',*\
*locale kb.locale_code not null default \'en\',*\
*title text not null,*\
*summary text not null,*\
*body_md text not null, \-- markdown/MDX*\
*faq_json jsonb not null default \'\[\]\', \-- \[{q,a}\] when
kind=\'faq\' or embedded FAQ*\
*owner_user_id text not null, \-- accountable editor*\
*review_interval_days int not null default 90,*\
*last_reviewed_at timestamptz,*\
*review_status kb.review_status not null default \'fresh\',*\
*related_slugs text\[\] not null default \'{}\',*\
*category text not null,*\
*tags text\[\] not null default \'{}\',*\
*seo_noindex boolean not null default false, \-- derived from visibility
unless overridden*\
*published_at timestamptz,*\
*updated_at timestamptz default now()*\
*);*\
\
*\-- Article versions (immutable history)*\
*create table kb.article_version (*\
*version_id text primary key, \-- kbv\_\...*\
*article_id text not null references kb.article(article_id) on delete
cascade,*\
*version_num int not null,*\
*diff_summary text,*\
*body_md text not null,*\
*faq_json jsonb not null,*\
*updated_by text not null,*\
*created_at timestamptz default now(),*\
*unique (article_id, version_num)*\
*);*\
\
*\-- Troubleshooter graph (decision tree) for kind=\'troubleshooter\'*\
*create table kb.troubleshooter (*\
*article_id text primary key references kb.article(article_id) on delete
cascade,*\
*graph_json jsonb not null \--
{nodes:\[{id,type,text,choices:\[\...\],action:{open_case_type:\'payment\'}}\]}*\
*);*\
\
*\-- Feedback & signals*\
*create table kb.article_feedback (*\
*fb_id bigserial primary key,*\
*article_id text not null references kb.article(article_id) on delete
cascade,*\
*user_id text, \-- nullable for anonymous*\
*helpful boolean not null,*\
*comment_text text,*\
*created_at timestamptz default now(),*\
*ip_hash text*\
*);*\
\
*\-- Redirects (301) for slug changes*\
*create table kb.redirect (*\
*from_slug text primary key,*\
*to_slug text not null references kb.article(slug)*\
*);*\
\
*commit;*\

## **1.20.4 GraphQL API (AppSync) --- paste‑ready schema**

Create *api/schema/helpcenter.graphql*:

*scalar AWSJSON*\
*scalar AWSDateTime*\
*scalar AWSURL*\
\
*enum KBKind { HOWTO POLICY TROUBLESHOOTER FAQ RELEASE }*\
\
*type KBArticle {*\
*id: ID!, slug: String!, kind: KBKind!, locale: String!, title: String!,
summary: String!,*\
*bodyMd: String!, faqJson: AWSJSON!, category: String!, tags:
\[String!\]!,*\
*visibility: String!, publishedAt: AWSDateTime, lastReviewedAt:
AWSDateTime, reviewStatus: String!,*\
*relatedSlugs: \[String!\]!*\
*}*\
*type KBList { items: \[KBArticle!\]!, nextCursor: String }*\
\
*type Query {*\
*kbArticle(slug: String!, locale: String = \"en\"): KBArticle*\
*kbList(category: String, q: String, 

### TD-0246 (tech)

<!-- id: TD-0246 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 885600-889600 -->

,*\
*bodyMd: String!, faqJson: AWSJSON!, category: String!, tags:
\[String!\]!,*\
*visibility: String!, publishedAt: AWSDateTime, lastReviewedAt:
AWSDateTime, reviewStatus: String!,*\
*relatedSlugs: \[String!\]!*\
*}*\
*type KBList { items: \[KBArticle!\]!, nextCursor: String }*\
\
*type Query {*\
*kbArticle(slug: String!, locale: String = \"en\"): KBArticle*\
*kbList(category: String, q: String, cursor: String, limit: Int = 24,
locale: String = \"en\"): KBList!*\
*}*\
\
*input KBArticleInput {*\
*slug: String!, kind: KBKind!, locale: String = \"en\", title: String!,
summary: String!,*\
*bodyMd: String!, faqJson: AWSJSON, category: String!, tags:
\[String!\], visibility: String*\
*}*\
*type Mutation {*\
*kbCreate(input: KBArticleInput!): ID! \@auth(role: \"editor\")*\
*kbUpdate(id: ID!, input: KBArticleInput!): Boolean! \@auth(role:
\"editor\")*\
*kbPublish(id: ID!): Boolean! \@auth(role: \"editor\")*\
*kbFeedback(slug: String!, helpful: Boolean!, comment: String):
Boolean!*\
*}*\

**Auth:**

- *editor* role for authoring; public queries are read‑only.
- Internal articles require authenticated admin/agent and **never** set
  SEO JSON‑LD or sitemaps.

## **1.20.5 Rendering & delivery**

- **Next.js** pages at */help/{slug}*.
- **Static Generation + ISR**: rebuild on publish/update; CloudFront
  cache with *stale‑while‑revalidate*.
- **Markdown/MDX**: sanitized to safe HTML; code blocks highlighted;
  internal component shortcodes allowed (*\<Step\>*, *\<Callout\>*,
  *\<FormCTA\>*).
- **JSON‑LD** injection for *FAQPage* when *faq_json* present and
  visibility is *public*.
- **OG cards**: SFW preview image per §1.16 Sharecards.
- **Hreflang**: if translated versions exist, add *hreflang* links
  (Phase‑2 i18n).

## **1.20.6 Search & suggestions integration (with §1.18)**

- **Typesense** ***help*** **collection** already defined in §1.18 (*id,
  slug, title, category, body, updated_at*).
- Add fields: *tags\[\]*, *popularity_weight* (derived from views +
  helpful ratio), *seo_noindex* (to exclude internal).
- **Query routing**: in product search box → first tab returns help
  results (top 5) before marketplace entities.
- **Zero‑result rescue**: show top 3 help articles based on q‑grams and
  synonyms, gated by SFW.

## **1.20.7 Guided troubleshooters (decision trees)**

- **Graph model**: nodes (*step*, *choice*, *outcome*, *action*).

- **Runtime**: JSON graph rendered client‑side with analytics on each
  transition.

- **Actions**:

  - *open_case* → pre‑fills Support case type & fields (§1.15)
  - *open_form* → opens embedded form (e.g., "request payout review")
  - *link_article* → deep‑link to a detailed how‑to

- **Versioning**: any change creates a new *article_version* entry; last
  stable version used by default.

## **1.20.8 Authoring workflow & governance**

- Roles: **Contributor** (draft), **Editor** (edit/publish),
  **Legal/Policy Reviewer** (approve policy articles), **Localization**
  (translate, review).
- **Review cycle**: nightly job marks *review_status* to *due*/*overdue*
  based on *review_interval_days*; dashboard shows backlog.
- **Link checker**: CI job validates external links and internal
  anchors; broken links open a task.
- **Internal vs public**: only *public* articles enter sitemaps and
  JSON‑LD.

## **1.20.9 SEO specifics (ties to §1.17)**

- **Sitemaps**: */sitemap-help.xml* chunked by locale; include
  *lastmod*.
- **Canonical**: */help/{slug}* canonicalizes to itself; legacy slugs
  301 via *kb.redirect*.
- **FAQPage** schema only when *faq_json* present and visibility is
  public.
- **Noindex**: internal or very short (\<150 words) articles set
  *noindex,follow*.

## **1.20.10 Feedback, deflection & analytics**

- **Thumbs helpful/unhelpful** with optional comment (sanitized); store
  in *kb.article_feedback*.
- **Deflection metric**: if a user visits help within **15 minutes**
  *before* abandoning a support form **or** within **5 minutes** of a
  case *not being created*, count as def

### TD-0247 (tech)

<!-- id: TD-0247 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 889200-893200 -->

 internal or very short (\<150 words) articles set
  *noindex,follow*.

## **1.20.10 Feedback, deflection & analytics**

- **Thumbs helpful/unhelpful** with optional comment (sanitized); store
  in *kb.article_feedback*.
- **Deflection metric**: if a user visits help within **15 minutes**
  *before* abandoning a support form **or** within **5 minutes** of a
  case *not being created*, count as deflection; attribute to article
  slug.
- **KPIs**: deflection rate, helpful ratio, time to first view after
  problem trigger, stale content backlog, search→help CTR, help→case
  rate.
- **Dashboards**: aggregated by category and locale.

## **1.20.11 Notifications (§1.10) & in‑product surfacing**

- **Nudges**: on certain errors (payment fail, calendar sync issue),
  show contextual inline help with top 1--2 articles and a **"Contact
  Support"** CTA.
- **Digest**: weekly top new/updated help articles to admins/agents;
  optional public "What's new" for release notes (if enabled).
- **Quiet hours**: same rules as §1.10; only critical service failure
  nudges bypass.

## **1.20.12 Safety & compliance**

- **SFW guarantee**: public help images are SFW; private screenshots or
  sensitive guides flagged *internal*.
- **PII controls**: no user names, emails, phone numbers in content.
- **DMCA/policy**: a takedown event revalidates affected pages within
  **≤10 min**.
- **Accessibility**: headings (H1→H3), alt text on images, focus order,
  44px tap targets.

## **1.20.13 Cost posture**

- Static pages (ISR + CDN) → negligible runtime cost.
- Authoring & feedback are small Lambda/API calls; Typesense reuses the
  existing cluster (§1.18).
- Image assets optimized (AVIF/WebP) and cached at edge; no 3rd‑party
  heavy scripts.

## **1.20.14 Work packages (Cursor --- 4 agents)**

- **Agent A --- Data & API**: DDL, GraphQL, feedback endpoints, review
  status job, redirects.
- **Agent B --- Authoring & Rendering**: MDX pipeline, sanitizer,
  Next.js pages, JSON‑LD injection, ISR hooks.
- **Agent C --- Troubleshooters**: graph editor (MVP as JSON editor),
  runtime renderer, action handlers to Support (§1.15).
- **Agent D --- Ops & SEO**: sitemaps, link checker CI, Search Console
  integration, dashboards, stale‑content alerts.

## **1.20.15 Tests (representative)**

4071. **Rendering**: public article renders with canonical, JSON‑LD
      (when FAQ), and SFW assets.
4072. **Internal**: internal article returns 200 for authorized agents;
      no JSON‑LD/sitemaps; *noindex*.
4073. **Troubleshooter**: decision paths trigger correct actions;
      open_case payload pre‑fills Support.
4074. **Review cycle**: due/overdue statuses flip; dashboard shows
      backlog; notifications sent.
4075. **Search**: help suggestions appear for common queries; internal
      content never leaks.
4076. **Redirects**: old slug 301 to new; Analytics aggregates to new
      slug.
4077. **Deflection**: visits within window reduce case creation rate;
      attribution recorded to article.

## **1.20.16 Artifacts (paste‑ready)**

- *db/migrations/027_helpcenter.sql* --- DDL above.
- *api/schema/helpcenter.graphql* --- API above.
- *services/help/mdx.ts* --- markdown→safe HTML renderer.
- *services/help/troubleshooter.ts* --- decision graph runtime.
- *web/help/\[slug\].tsx* --- Next.js page with ISR & JSON‑LD.
- *observability/dashboards/help.md* --- KPIs & alerts.
- *ops/runbooks/help-center.md* --- authoring, publish, and rollback
  steps.

## **1.20.17 Acceptance criteria --- mark §1.20 FINAL only when ALL true**

4085. Public Help Center pages render with canonical + JSON‑LD (when
      applicable), SFW images, and are included in */sitemap-help.xml*.
4086. Internal articles are **not indexable**, never appear in public
      search or sitemaps.
4087. Troubleshooter flows work end‑to‑end and can open typed Support
      cases with pre‑filled payloads.
4088. Review cycle + stale content alerts function; editors can
      publish/redirect safely.
4089. Search integrati

### TD-0248 (tech)

<!-- id: TD-0248 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 892800-896800 -->

 (when
      applicable), SFW images, and are included in */sitemap-help.xml*.
4086. Internal articles are **not indexable**, never appear in public
      search or sitemaps.
4087. Troubleshooter flows work end‑to‑end and can open typed Support
      cases with pre‑filled payloads.
4088. Review cycle + stale content alerts function; editors can
      publish/redirect safely.
4089. Search integration live; suggestions show top help results;
      internal never leaks.
4090. Deflection, helpful ratio, and stale backlog dashboards live;
      **deflection rate** target configurable.
4091. Costs remain within serverless budget; ISR revalidation on updates
      ≤ 10 minutes.

# **§1.20 --- Hardening Addendum (paste directly after §1.20.15)**

### **1.20.16 Promotions Quality Score (QS) --- ordering within paid caps**

**Goal.** Use a **Quality Score** to order paid candidates **inside**
the capped sponsored positions (never outside filter match), as
described in your plan.

- Definition (per city×role):

*QS = 0.45 \* PredictedCTR*\
* + 0.35 \* PredictedBookingLift \# incremental vs. organic baseline*\
* + 0.10 \* ProfileHealth \# rating \* log(reviews+1), cancel-rate
inverse, verified_chip*\
* + 0.10 \* CreativeQualityProxy \# image sharpness/coverage, SFW
compliance, recency*\

Bounded to \[0.3, 1.3\] to avoid runaway weights; cold‑start defaults to
0.7.

- **Serving order for each sponsored slot:**\
  *order_score = min(max_cpc, cap) / cap × QS* (ties broken by
  time‑since‑last‑exposed to ensure fairness).\
  This **replaces** the simple "bid × quality" heuristic in §1.20.5 for
  Boost.

- Offline training (Phase‑1):

  - Labels: clicks and booking initiations attributed to **paid
    impressions**; use **holdout** cells (from
    *city_config.holdout_pct*) to compute **incremental** lift.
  - Features: prior CTR, prior booking rate, rating/reviews,
    verified_chip, availability score, price competitiveness band, image
    coverage metrics, city/role, device, time of day.
  - Models: logistic (CTR) and uplift/2‑model for booking lift;
    recalibrate weekly.

- **Online update:** refresh QS nightly; warm candidates when profiles
  change.

- **Abuse guardrails:** cap QS when review_count \< 5; down‑weight rapid
  "cosmetic" edits (change‑rate limiter).

**Artifacts:**

- *services/promotions/quality_score.py* (batch trainer),
- *jobs/promotions_qs_refresh.yml* (nightly schedule),
- *observability/dashboards/promotions_qs.md* (drift/precision).

### **1.20.17 Auto‑coaching & nudges (provider UX)**

**Triggers (weekly):**

- 7‑day **ROAS \< 1.5×** → inline coach: "Improve images or adjust bid;
  see checklist."
- 14‑day **ROAS \< 1.0×** → recommend **Pause**; link to help article
  and QS drivers.
- **Invalid‑click refunds \> 8%** → info banner explaining filters and
  best practices.

**UI hooks:** surfaced in *web/promotions/Manager.tsx*, with links to
Help Center (§1.20) and media tips (§1.11).

**Events:** *promo.autocoach.shown\|clicked\|dismissed*.

### **1.20.18 RFP/Brief credits --- clarify buyer‑side ownership**

Your non‑technical Appendix defines **RFP** as a **buyer/brand**
broadcasting a brief to vetted providers. Accordingly:

- **Semantics:** *promo.brief_wallet.user_id* refers to the
  **buyer/brand account** (not the provider).
- **Consumption rule:** 1 credit **per new recipient** in a broadcast
  brief; if an open thread exists with that provider in the last 30
  days, **no** credit is consumed.
- **Renewals (optional):** verified brands receive **N** free credits
  per week (configurable per city).
- **Admin visibility:** city‑level usage and abuse signals (e.g.,
  mass‑spam attempts) in the console.

*(No schema change needed---the existing tables already key by user_id;
we're specifying the **account role** is "buyer/brand" for this
wallet.)*

### **1.20.19 Compliance, labels & fairness**

- **Labeling:** "Sponsored"/"Featured" chip on all paid units; tooltip
  explains matching rules.
- **Organic share g

### TD-0249 (tech)

<!-- id: TD-0249 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 896400-900400 -->

lity:** city‑level usage and abuse signals (e.g.,
  mass‑spam attempts) in the console.

*(No schema change needed---the existing tables already key by user_id;
we're specifying the **account role** is "buyer/brand" for this
wallet.)*

### **1.20.19 Compliance, labels & fairness**

- **Labeling:** "Sponsored"/"Featured" chip on all paid units; tooltip
  explains matching rules.
- **Organic share guardrail:** maintain **≥ X%** organic exposure per
  page (configurable, default 80%).
- **Daily exposure caps:** per account, per city×role, to avoid
  starvation of others.
- **Protected classes:** no targeting or optimization on protected
  attributes; QS features exclude proxies.
- **Auditability:** all eligibility changes and city config edits are
  included in the **immutable admin audit log** (mirrored to S3 WORM).

### **1.20.20 Additional tests & acceptance extensions**

- **QS ordering test:** higher *order_score* wins within sponsored
  slots; verify no leakage beyond slots.
- **Auto‑coaching:** ROAS thresholds trigger messages; actions logged;
  dismissal persists.
- **Buyer RFP credits:** broadcast to 5 new recipients consumes 5
  credits; re‑inviting a recipient with an active thread consumes 0.
- **Organic share protection:** simulated heavy paid demand still leaves
  ≥ configured organic exposure on each page.

**Acceptance additions (append to §1.20.15):**

- QS pipeline runs nightly; online serving uses *order_score*;
  monitoring dashboards show CTR/AUC and uplift sanity.
- Auto‑coaching thresholds and copy are configurable; events flow to
  analytics.
- RFP credits enforced on **buyer** accounts; consumption, refunds, and
  renewals visible in ledger.

# **§1.21 --- Analytics, Attribution & Experimentation Platform**

**Full Technical Development Plan (single copy‑paste block for your
master doc)**

**Purpose.** Provide a privacy‑safe, cost‑efficient, and auditable
analytics stack that measures **end‑to‑end behavior** (search → view →
message → checkout → payout), powers **growth attribution** (UTM/click
tokens, referral/paid), and runs **experiments** with guardrails.
Integrates with **Amplify (web/app)**, **AppSync**, **Stripe**,
**Typesense**, **Calendar/Orders/Support** (Sections §1.12--§1.15),
**Growth/SEO/Search** (§1.16--§1.18), and **Studios** (§1.19).

## **1.21.1 Objectives & invariants**

4119. **Trust first**: event contracts are versioned, PII‑safe by
      default, and deletions propagate within SLA.
4120. **One identity graph**: stitch **anon_id ↔ user_id** across
      sessions, devices, and channels.
4121. **Attribution that's honest**: last non‑direct + configurable
      lookback, with **click‑token proof** for growth surfaces (§1.16).
4122. **Experiments with guardrails**: sticky assignment, SRM checks,
      CUPED/Bayesian estimators, and **no cloaking**.
4123. **Cost‑conscious**: serverless ingest → S3 data lake
      (Iceberg/Parquet) → Athena/dbt transforms → Redshift Serverless
      *only* for heavy interactive BI.
4124. **Observability**: schema drift, event loss, and lag alarms;
      reproducible **metric definitions**.

## **1.21.2 High‑level architecture**

- **Ingest**: Web/App send to */e* (API Gateway → Lambda). Back‑office
  services send via Kinesis SDK.
- **Landing (Bronze)**: raw NDJSON files in
  *s3://analytics/raw/{event_dt}/* with object lock (WORM) + partition
  pruning.
- **Refine (Silver)**: Glue job or Athena CTAS converts to
  **Iceberg/Parquet** partitioned tables in *s3://analytics/silver/*.
- **Model (Gold)**: *dbt* builds **semantic models** (sessions, funnels,
  attributions, experiment exposures) stored as Iceberg tables.
- **Serve**: Athena for ad‑hoc and scheduled reports; Redshift
  Serverless for dashboards with concurrency; QuickSight or Superset for
  BI.
- **Privacy**: Lake Formation governs access; DSAR delete jobs redact
  across all layers.

## **1.21.3 Event envelope v1 (contract)**

**Event key fields (always present):**

*{*\
*\"event_id\": \"evt_01H

## Pre-Run Ritual (HARD)

- [ ] Read your last run report.
- [ ] Read any related run reports for the same WBS or feature.
- [ ] Summarise Plan vs Done vs Pending before writing new code.

## Locking & Access (HARD)

- Acquire your lock file at `ops/locks/AGENT-2.lock` before modifying files.
- Declare your scope_paths[] in your run report.
- If you detect overlapping scopes or foreign changes, STOP and hand back to the Orchestrator.

## Required Run Report Content (HARD)

- Context Snapshot (WBS IDs, blueprint IDs, assumptions).
- What Was Done vs Planned.
- How It Was Done (architecture/implementation narrative).
- Testing (commands, results, coverage, security scans) + 'Testing Proof' paragraph.
- Issues & Problems (with root causes where possible).
- Locations / Touch Map (files created/modified/removed, migrations, databases touched).
- Suggestions for Next Agents.
- Progress & Checklist.

## Orchestrator Attach Pack (HARD)

- Place under `docs/orchestrator/from-agents/AGENT-2/run-<timestamp>-attach.zip`.
- Include: run report, diff summary, CI/test artifacts, performance/security results,
  and a manifest.json (agent, run_id, wbs_ids, blueprint_ids, status).

## Testing (HARD)

- Define a test plan before coding.
- Implement unit/integration/E2E tests where appropriate.
- Record all test commands and results in the run report.
- If you cannot implement or run tests, mark the task partial and propose follow-up WBS items.

## Implementation Notes

(Use this space during your run.)

## Issues & Risks

(Document any issues, risks, or TODOs you discover.)

## Suggestions for Next Agents

(Document any guidance for follow-up work.)
