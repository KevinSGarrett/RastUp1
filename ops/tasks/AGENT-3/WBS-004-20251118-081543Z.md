# Task for AGENT-3: WBS-004 — User Authentication and Onboarding

You are a Cursor CLI agent working under a central Orchestrator.

## WBS Task

- ID: WBS-004
- Title: User Authentication and Onboarding
- Phase: Frontend
- Agent: AGENT-3
- Depends on: WBS-001, WBS-002
- Blueprint IDs: TD-0302, TD-0303, TD-0311, TD-0312, TD-0313, TD-0314, TD-0315, TD-0316, TD-0317, TD-0318, TD-0319

### Description

Implement user authentication supporting email, Apple, Google, and optional SMS with password strength and breach checks. Enforce account lockout and CAPTCHA on risk. Provide password reset flows with token expiration. Implement optional MFA with step-up for sensitive actions. Develop onboarding wizards for multi-role providers and hosts, including profile creation, portfolio uploads with SFW enforcement, package/pricing setup, availability, and verification nudges. Enforce profile completeness scoring gating publishing and Instant Book eligibility. Integrate onboarding progress nudges and weekly digests. Provide public profile pages with SEO and Safe-Mode enforcement.

### Acceptance Criteria

- Authentication supports email, Apple, Google, optional SMS, and MFA with security controls
- Onboarding wizards for providers and hosts with step gating, autosave, and completeness scoring
- Portfolio uploads enforce SFW media with moderation and cropping
- Profile publishing gated by completeness and verification status
- Public profiles show verified badges, SEO JSON-LD, and Safe-Mode filtering
- Onboarding nudges and weekly digests implemented
- Tests cover auth flows, onboarding steps, media upload, and SEO integration


## Relevant Blueprint Chunks

### TD-0302 (tech)

<!-- id: TD-0302 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1087200-1091200 -->

nt (consolidated) --- mapped by domain   Appendix H --- UI: H.3 Auth & Account                                  auth_login.spec.ts                       Met          
  NTB-AUTH-003       Support social login with Google and Apple.                                                          NonTechBlueprint (consolidated) --- mapped by domain   Appendix H --- UI: H.3 Auth & Account                                  auth_sso_google_apple.spec.ts            Met          
  NTB-AUTH-004       Enforce password strength and breach‑check during signup and reset.                                  NonTechBlueprint (consolidated) --- mapped by domain   §1.24 Security & Privacy                                               auth_password_rules.spec.ts              Met          
  NTB-AUTH-005       Account lockout after 5 failed login attempts; CAPTCHA on risk score.                                NonTechBlueprint (consolidated) --- mapped by domain   §1.24 Security & Privacy; Appendix R --- Rate Limits & Quotas          auth_lockout_captcha.spec.ts             Met          
  NTB-AUTH-006       Support password reset via emailed one‑time code and token expiration.                               NonTechBlueprint (consolidated) --- mapped by domain   Appendix H --- UI: H.3 Auth & Account                                  auth_reset_password.spec.ts              Met          
  NTB-AUTH-007       MFA optional for all; required for payout changes and other sensitive actions (step‑up).             NonTechBlueprint (consolidated) --- mapped by domain   §1.24 Security & Privacy; §1.13 Payments & Payouts                     auth_mfa_stepup.spec.ts                  Met          
  NTB-AUTH-008       Sessions use httpOnly cookies; SameSite=Lax; device recognition events are logged.                   NonTechBlueprint (consolidated) --- mapped by domain   §1.24 Security & Privacy; Appendix L --- Logging & Redaction           auth_session_security.spec.ts            Met          
  NTB-AUTH-009       Provide account deletion with DSAR export link surfaced before final delete.                         NonTechBlueprint (consolidated) --- mapped by domain   §1.24 Security & Privacy; §1.28 Exports & Portability                  privacy_delete_export.spec.ts            Met          
  NTB-AUTH-010       Rate‑limit signup, login, reset flows per IP and per identity.                                       NonTechBlueprint (consolidated) --- mapped by domain   Appendix R --- Rate Limits & Quotas                                    rate_limits_auth.spec.ts                 Met          
  NTB-PROF-001       Public profile page displays avatar, verified chip, headline, city, roles, price band, CTA.          NonTechBlueprint (consolidated) --- mapped by domain   §1.7 Profiles; Appendix H --- UI: H.4 Profiles                         profile_public_view.spec.ts              Met          
  NTB-PROF-002       Owners can edit headline, bio, roles, tags, city, price min/max, languages, links.                   NonTechBlueprint (consolidated) --- mapped by domain   §1.7 Profiles; Appendix H --- UI: H.4 Profiles                         profile_edit_fields.spec.ts              Met          
  NTB-PROF-003       Upload/crop/reorder portfolio images; set cover image.                                               NonTechBlueprint (consolidated) --- mapped by domain   §1.11 Media Service; Appendix H --- UI: H.4 Profiles                   profile_media_upload_crop.spec.ts        Met          
  NTB-PROF-004       All public media pass SFW moderation; originals stored private; SFW variants only on public.         NonTechBlueprint (consolidated) --- mapped by domain   §1.11 Media Service; §1.7 Profiles                                     profile_media_sfw.spec.ts                Met          
  NTB-PROF-005       Profile completeness meter enforces thresholds for Instant Book eligibility.                         NonTechBlueprint (consolidated) --- mapped by domain   §1.7 Profiles; §1.3 

### TD-0303 (tech)

<!-- id: TD-0303 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1090800-1094800 -->

ly on public.         NonTechBlueprint (consolidated) --- mapped by domain   §1.11 Media Service; §1.7 Profiles                                     profile_media_sfw.spec.ts                Met          
  NTB-PROF-005       Profile completeness meter enforces thresholds for Instant Book eligibility.                         NonTechBlueprint (consolidated) --- mapped by domain   §1.7 Profiles; §1.3 Booking Flow & State                               profile_completeness.spec.ts             Met          
  NTB-PROF-006       Reviews summary and distribution displayed; count gating when reviews \< 5.                          NonTechBlueprint (consolidated) --- mapped by domain   §1.9 Reviews; Appendix H --- UI                                        profile_reviews_display.spec.ts          Met          
  NTB-PROF-007       Availability preview shows next‑14‑day feasible slots computed by calendar engine.                   NonTechBlueprint (consolidated) --- mapped by domain   §1.12 Calendar & Availability                                          profile_availability_preview.spec.ts     Met          
  NTB-PROF-008       Policies (cancellation/reschedule) surface on the profile and checkout.                              NonTechBlueprint (consolidated) --- mapped by domain   §1.14 Orders & Timeline; Appendix H --- UI                             profile_policies_display.spec.ts         Met          
  NTB-STUDIO-001     Public studio page shows hero carousel (SFW), amenities, hourly price, city map pin, verification.   NonTechBlueprint (consolidated) --- mapped by domain   §1.19 Studios/Spaces; Appendix H --- UI: H.5 Studios                   studio_public_view.spec.ts               Met          
  NTB-STUDIO-002     Studio editor allows name, slug, contact, address privacy, amenities, hourly min/max, deposits.      NonTechBlueprint (consolidated) --- mapped by domain   §1.19 Studios/Spaces                                                   studio_editor_fields.spec.ts             Met          
  NTB-STUDIO-003     Buffers/blackouts configured at studio propagate to feasibility and booking.                         NonTechBlueprint (consolidated) --- mapped by domain   §1.19 Studios/Spaces; §1.12 Calendar                                   studio_buffers_blackouts.spec.ts         Met          
  NTB-STUDIO-004     Studio verification workflow with document upload and status banners.                                NonTechBlueprint (consolidated) --- mapped by domain   §1.19 Studios/Spaces                                                   studio_verification_flow.spec.ts         Met          
  NTB-CAL-001        Weekly rules + exceptions define base schedule per role/service.                                     NonTechBlueprint (consolidated) --- mapped by domain   §1.12 Calendar & Availability                                          calendar_rules.spec.ts                   Met          
  NTB-CAL-002        Feasibility engine applies min duration, buffers, and blackouts.                                     NonTechBlueprint (consolidated) --- mapped by domain   §1.12 Calendar & Availability                                          calendar_feasibility_engine.spec.ts      Met          
  NTB-CAL-003        ICS import is read‑only; outbound ICS feeds for confirmed events.                                    NonTechBlueprint (consolidated) --- mapped by domain   §1.12 Calendar & Availability                                          calendar_ics_io.spec.ts                  Met          
  NTB-CAL-004        DST transitions handled correctly for start/end times.                                               NonTechBlueprint (consolidated) --- mapped by domain   §1.12 Calendar & Availability                                          calendar_dst.spec.ts                     Met          
  NTB-BOOK-001       Request → Hold → Confirmed state machine with idempotent transitions.                                NonTechBlueprint (consolidated) --- map

### TD-0311 (tech)

<!-- id: TD-0311 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1119600-1123600 -->

s,Met, NTB-AUTH-007,\"MFA
optional for all; required for payout changes and other sensitive
actions (step‑up).\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"Appendix H --- UI: H.3 Auth & Account;
§1.24 Security & Privacy\",auth_mfa_stepup.spec.ts,Met,
NTB-AUTH-008,\"Sessions use httpOnly cookies; SameSite=Lax; device
recognition events are logged.\",\"NonTechBlueprint (consolidated) ---
mapped by domain; see attached DOCX set\",\"Appendix H --- UI: H.3 Auth
& Account; §1.24 Security & Privacy\",auth_session_security.spec.ts,Met,
NTB-AUTH-009,\"Provide account deletion with DSAR export link surfaced
before final delete.\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.24 Security & Privacy; §1.28
Exports & Portability\",privacy_delete_export.spec.ts,Met,
NTB-AUTH-010,\"Rate‑limit signup, login, reset flows per IP and per
identity.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix R --- Rate Limits &
Quotas\",rate_limits_auth.spec.ts,Met, NTB-PROF-001,\"Public profile
page displays avatar, verified chip, headline, city, roles, price band,
CTA.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.7 Profiles; §1.11 Media Service; Appendix H ---
UI: H.4 Profiles\",profile_public_view.spec.ts,Met,
NTB-PROF-002,\"Owners can edit headline, bio, roles, tags, city, price
min/max, languages, links.\",\"NonTechBlueprint (consolidated) ---
mapped by domain; see attached DOCX set\",\"§1.7 Profiles; §1.11 Media
Service; Appendix H --- UI: H.4
Profiles\",profile_edit_fields.spec.ts,Met,
NTB-PROF-003,\"Upload/crop/reorder portfolio images; set cover
image.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.7 Profiles; §1.11 Media Service; Appendix H ---
UI: H.4 Profiles\",profile_media_upload_crop.spec.ts,Met,
NTB-PROF-004,\"All public media pass SFW moderation; originals stored
private; SFW variants only on public.\",\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.7
Profiles; §1.11 Media Service; Appendix H --- UI: H.4
Profiles\",profile_media_sfw.spec.ts,Met, NTB-PROF-005,Profile
completeness meter enforces thresholds for Instant Book
eligibility.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.7 Profiles; §1.11 Media Service; Appendix H ---
UI: H.4 Profiles\",profile_completeness.spec.ts,Met,
NTB-PROF-006,\"Reviews summary and distribution displayed; count gating
when reviews \< 5.\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.9 Reviews; Appendix H --- UI:
H.4\",profile_reviews_display.spec.ts,Met, NTB-PROF-007,\"Availability
preview shows next‑14‑day feasible slots computed by calendar
engine.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.12 Calendar & Availability; Appendix H ---
UI\",profile_availability_preview.spec.ts,Met, NTB-PROF-008,\"Policies
(cancellation/reschedule) surface on the profile and
checkout.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.14 Orders & Timeline; Appendix H ---
UI\",profile_policies_display.spec.ts,Met, NTB-STUDIO-001,\"Public
studio page shows hero carousel (SFW), amenities, hourly price, city map
pin, verification.\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.19 Studios/Spaces; Appendix H ---
UI: H.5 Studios\",studio_public_view.spec.ts,Met,
NTB-STUDIO-002,\"Studio editor allows name, slug, contact, address
privacy, amenities, hourly min/max, deposits.\",\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.19
Studios/Spaces; Appendix H --- UI: H.5
Studios\",studio_editor_fields.spec.ts,Met,
NTB-STUDIO-003,\"Buffers/blackouts configured at studio propagate to
feasibility and booking.\",\"NonTechBlueprint (consolidated) --- mapped
by domain; see attached D

### TD-0312 (tech)

<!-- id: TD-0312 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1123200-1127200 -->

ntact, address
privacy, amenities, hourly min/max, deposits.\",\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.19
Studios/Spaces; Appendix H --- UI: H.5
Studios\",studio_editor_fields.spec.ts,Met,
NTB-STUDIO-003,\"Buffers/blackouts configured at studio propagate to
feasibility and booking.\",\"NonTechBlueprint (consolidated) --- mapped
by domain; see attached DOCX set\",\"§1.19;
§1.12\",studio_buffers_blackouts.spec.ts,Met, NTB-STUDIO-004,Studio
verification workflow with document upload and status
banners.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.19\",studio_verification_flow.spec.ts,Met,
NTB-CAL-001,Weekly rules + exceptions define base schedule per
role/service.,\"NonTechBlueprint (consolidated) --- mapped by domain;
see attached DOCX set\",\"§1.12 Calendar &
Availability\",calendar_rules.spec.ts,Met, NTB-CAL-002,Feasibility
engine applies min duration, buffers, and blackouts.,\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.12
Calendar & Availability\",calendar_feasibility_engine.spec.ts,Met,
NTB-CAL-003,\"ICS import is read‑only; outbound ICS feeds for confirmed
events.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.12 Calendar &
Availability\",calendar_ics_io.spec.ts,Met, NTB-CAL-004,DST transitions
handled correctly for start/end times.,\"NonTechBlueprint (consolidated)
--- mapped by domain; see attached DOCX set\",\"§1.12 Calendar &
Availability\",calendar_dst.spec.ts,Met, NTB-BOOK-001,\"Request → Hold →
Confirmed state machine with idempotent
transitions.\",\"NonTechBlueprint (consolidated) --- mapped by domain;
see attached DOCX set\",\"§1.3 Booking Flow & State; §1.14 Orders &
Timeline\",booking_state_machine.spec.ts,Met,
NTB-BOOK-002,\"Cancellation/refund kernel applies time‑band rules
(full/partial/none).\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.3 Booking Flow & State; §1.14
Orders & Timeline\",refund_kernel.spec.ts,Met, NTB-BOOK-003,Order
timeline emits Action Cards for each transition and
task.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.14 Orders &
Timeline\",order_timeline_cards.spec.ts,Met, NTB-BOOK-004,\"Checkout
shows line items, fees, taxes, deposit, and policy
summaries.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.3 Booking Flow & State; §1.14 Orders &
Timeline\",checkout_ui.spec.ts,Met, NTB-PAY-001,\"Stripe PaymentIntents
with SCA/3DS2; Apple/Google Pay wallets.\",\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.13
Payments & Payouts\",payments_3ds_wallets.spec.ts,Met,
NTB-PAY-002,Payout destination change requires MFA; velocity limits for
new accounts.,\"NonTechBlueprint (consolidated) --- mapped by domain;
see attached DOCX set\",\"§1.13 Payments &
Payouts\",payout_mfa_velocity.spec.ts,Met, NTB-PAY-003,Chargeback
evidence packs assembled from order timeline and
messages.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.13 Payments &
Payouts\",chargeback_evidence.spec.ts,Met, NTB-PAY-004,Partial and full
refunds issued through refund kernel and reconciled by
webhooks.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.13 Payments &
Payouts\",refunds_reconciliation.spec.ts,Met, NTB-MSG-001,Inbox lists
threads with unread counts; search/sort provided.,\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.4
Messaging & Requests\",messages_inbox.spec.ts,Met, NTB-MSG-002,\"Thread
view supports text and attachment uploads (SFW) with
thumbnails.\",\"NonTechBlueprint (consolidated) --- mapped by domain;
see attached DOCX set\",\"§1.4 Messaging & Requests; §1.11
Media\",messages_thread_attachments.spec.ts,Met,
NTB-MSG-003,\"Block/report functions; rate limits per dyad;
anti‑circumvention copy.\",

### TD-0313 (tech)

<!-- id: TD-0313 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1126800-1130800 -->

\",\"§1.4
Messaging & Requests\",messages_inbox.spec.ts,Met, NTB-MSG-002,\"Thread
view supports text and attachment uploads (SFW) with
thumbnails.\",\"NonTechBlueprint (consolidated) --- mapped by domain;
see attached DOCX set\",\"§1.4 Messaging & Requests; §1.11
Media\",messages_thread_attachments.spec.ts,Met,
NTB-MSG-003,\"Block/report functions; rate limits per dyad;
anti‑circumvention copy.\",\"NonTechBlueprint (consolidated) --- mapped
by domain; see attached DOCX set\",\"§1.4 Messaging & Requests; Appendix
R --- Rate Limits\",messages_block_rate.spec.ts,Met,
NTB-NOTIF-001,\"Email templates (MJML) for key events: signup verify,
booking confirm, refund, payout.\",\"NonTechBlueprint (consolidated) ---
mapped by domain; see attached DOCX set\",\"§1.10 Notifications &
Templates\",notifications_templates_render.spec.ts,Met,
NTB-NOTIF-002,Quiet hours and consent/suppression honored for each
channel.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.10 Notifications & Templates; §1.24 Security &
Privacy\",notifications_quiet_hours.spec.ts,Met,
NTB-NOTIF-003,SPF/DKIM/DMARC configured; bounce/complaint
suppression.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.10 Notifications &
Templates\",deliverability_dns.spec.ts,Met, NTB-SEO-001,Sitemaps (main,
city, role, help) generated and kept fresh.,\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.17 SEO
& On‑Site; Appendix K --- Cache Matrix\",seo_sitemaps.spec.ts,Met,
NTB-SEO-002,Canonical/hreflang tags for city×role pages and
localizations.,\"NonTechBlueprint (consolidated) --- mapped by domain;
see attached DOCX set\",\"§1.17 SEO & On‑Site; Appendix K --- Cache
Matrix\",seo_canonical_hreflang.spec.ts,Met, NTB-SEO-003,\"Structured
data (Person, LocalBusiness, CreativeWork, FAQ) on applicable
pages.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.17 SEO & On‑Site; Appendix K --- Cache
Matrix\",seo_structured_data.spec.ts,Met, NTB-SEO-004,CWV budgets
enforced on top landings (mobile p75).,\"NonTechBlueprint (consolidated)
--- mapped by domain; see attached DOCX set\",\"§1.17 SEO & On‑Site;
Appendix K --- Cache Matrix\",lighthouse_ci.spec.ts,Met,
NTB-SEARCH-001,Typesense indexes for people, studios, work, and
help.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.18 Search &
Discovery\",search_index_schemas.spec.ts,Met,
NTB-SEARCH-002,Outbox→Indexer pipeline upserts within 5 minutes for hot
docs.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.18 Search &
Discovery\",search_indexer_sla.spec.ts,Met, NTB-SEARCH-003,\"Ranking
blends text, proximity, verified, availability, quality,
freshness.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.18 Search &
Discovery\",search_ranking_blend.spec.ts,Met, NTB-SEARCH-004,\"Safe‑Mode
enforced for all public queries; NSFW assets never
returned.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.18 Search &
Discovery\",search_safe_mode.spec.ts,Met,
NTB-SEARCH-005,\"Synonyms/typos/suggestions configured; cursor
pagination; caching for hot queries.\",\"NonTechBlueprint (consolidated)
--- mapped by domain; see attached DOCX set\",\"§1.18 Search &
Discovery; Appendix K --- Cache
Matrix\",search_suggest_cache.spec.ts,Met, NTB-GROWTH-001,Saved search
alerts and city digests with frequency caps.,\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.16
Growth; §1.30 Post‑Launch\",growth_digests.spec.ts,Met,
NTB-GROWTH-002,Referral program with clawback on
chargebacks/fraud.,\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.16
Growth\",growth_referrals_clawback.spec.ts,Met,
NTB-GROWTH-003,Experiment framework with CUPED/SRM
guardrails.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DO

### TD-0314 (tech)

<!-- id: TD-0314 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1130400-1134400 -->

§1.16
Growth; §1.30 Post‑Launch\",growth_digests.spec.ts,Met,
NTB-GROWTH-002,Referral program with clawback on
chargebacks/fraud.,\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.16
Growth\",growth_referrals_clawback.spec.ts,Met,
NTB-GROWTH-003,Experiment framework with CUPED/SRM
guardrails.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.21 Analytics &
Experiments\",experiments_framework.spec.ts,Met, NTB-HELP-001,Help
Center with categories, article template, and feedback
widget.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.20 Help
Center\",help_center_article.spec.ts,Met, NTB-HELP-002,DMCA takedown and
restore workflow with SLA timers.,\"NonTechBlueprint (consolidated) ---
mapped by domain; see attached DOCX set\",\"§1.15 Support &
Takedown\",dmca_flow.spec.ts,Met, NTB-ANALYT-001,Event taxonomy with
schema validation in CI.,\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.21 Analytics & Experiments;
Appendix L --- Logging & Event
Schema\",event_contract_validator.spec.ts,Met,
NTB-ANALYT-002,Attribution with click‑token proof and channel
grouping.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.21 Analytics &
Experiments\",attribution_clicktoken.spec.ts,Met, NTB-ADMIN-001,RBAC for
staff; dual‑control on sensitive operations; WORM
audit.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.22 Admin &
Back‑Office\",admin_rbac_audit.spec.ts,Met, NTB-SEC-001,WAF, BotControl,
and rate limiting tuned for abuse patterns.,\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.24
Security & Privacy; Appendix R --- Rate Limits &
Quotas\",waf_rules.spec.ts,Met, NTB-SEC-002,Consent logging for terms,
privacy, and marketing.,\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.24 Security &
Privacy\",consent_logging.spec.ts,Met, NTB-SEC-003,DSAR delete/export
propagates to search and analytics.,\"NonTechBlueprint (consolidated)
--- mapped by domain; see attached DOCX set\",\"§1.24;
§1.28\",dsar_propagation.spec.ts,Met, NTB-PLAT-001,Amplify Hosting Gen‑2
canary deploys with rollback SOP.,\"NonTechBlueprint (consolidated) ---
mapped by domain; see attached DOCX set\",\"§1.23 Platform, CI/CD &
Environments\",deploy_canary_rollback.spec.ts,Met, NTB-PLAT-002,\"Infra
as code (CDK) for edge, API, DB, caches.\",\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.23
Platform, CI/CD & Environments\",cdk_stacks.spec.ts,Met,
NTB-LAUNCH-001,\"Cutover plan (DNS/certs), content freeze, feature‑flag
ramps, rollback rehearsal.\",\"NonTechBlueprint (consolidated) ---
mapped by domain; see attached DOCX set\",\"§1.29
Launch/Go‑Live\",launch_cutover_rollback.spec.ts,Met,
NTB-POST-001,\"On‑call rotation, SLOs/error budgets, game days, DR
drills, FinOps cadence.\",\"NonTechBlueprint (consolidated) --- mapped
by domain; see attached DOCX set\",\"§1.30 Post‑Launch &
SRE\",slo_budget_gameday.spec.ts,Met, NTB-EXPORT-001,\"User exports and
portability bundle with receipts and redaction.\",\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.28
Exports & Portability\",export_bundle_redaction.spec.ts,Met,
NTB-API-001,\"Partner REST + Webhooks with OAuth scopes, HMAC,
idempotency, and retries.\",\"NonTechBlueprint (consolidated) --- mapped
by domain; see attached DOCX set\",\"§1.27 Partner API & Webhooks;
Appendix J --- API Errors &
Semantics\",webhook_signature_retry.spec.ts,Met, NTB-CACHE-001,\"Cache
key matrix (TTL, Vary) for public pages; ISR revalidation
rules.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix K --- Cache
Matrix\",cache_keys_matrix.spec.ts,Met, NTB-LOG-001,\"JSON log schema
with correlation IDs and PII redaction policy.\",\"NonTechBlueprint
(consolidated) --- mapped

### TD-0315 (tech)

<!-- id: TD-0315 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1134000-1138000 -->

ntics\",webhook_signature_retry.spec.ts,Met, NTB-CACHE-001,\"Cache
key matrix (TTL, Vary) for public pages; ISR revalidation
rules.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix K --- Cache
Matrix\",cache_keys_matrix.spec.ts,Met, NTB-LOG-001,\"JSON log schema
with correlation IDs and PII redaction policy.\",\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"Appendix
L --- Logging & Redaction\",log_schema_redaction.spec.ts,Met,
NTB-SBOM-001,\"SBOM per build, SCA/SAST/container scans, license policy,
SLAs for remediation.\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"Appendix M --- SBOM & Dependency
Policy\",sbom_policy_enforcement.spec.ts,Met, NTB-DR-001,\"RTO/RPO
targets and runbooks for Aurora, Typesense, and S3; quarterly
drills.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix N --- DR Matrix &
Runbooks\",dr_restore_drill.spec.ts,Met, NTB-GOV-001,\"Data
retention/classification/masking/lineage with automated
jobs.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix O --- Data
Governance\",retention_lineage_jobs.spec.ts,Met,
NTB-RATE-001,\"Rate‑limits/quotas for auth, search, messages, checkout,
and suggestions.\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"Appendix R --- Rate Limits &
Quotas\",rate_limit_matrix.spec.ts,Met, NTB-TESTDATA-001,\"Synthetic
seed dataset for Stage/Dev; no live PII in
non‑prod.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix S --- Test Data
Management\",seed_masking_policy.spec.ts,Met,

# **Appendix U --- Threat Modeling & Abuse Cases (STRIDE + Abuse/Anti‑Circumvention)**

**Purpose.** Identify and mitigate security threats and growth‑abuse
vectors early; prove mitigations by test.

**U.1 Scope**\
Surfaces: Auth, Profiles/Studios, Media, Messaging, Search,
Checkout/Payments, Partner API/Webhooks, Admin.

**U.2 Data‑Flow (text DFD)**

- *Edge (CloudFront/WAF)* → *Web (Next.js)* → *AppSync/GraphQL* →
  *Lambdas* → *Aurora*
- *Upload client* → *S3 pre‑signed PUT* → *Media processor Lambda* → *S3
  (variants)* → *CloudFront*
- *Event outbox (Aurora)* → *Indexer Lambda* → *Typesense*
- *Stripe/Webhooks* → *Webhook handler* → *Orders/Timeline*
- *Admin console* → *Admin APIs* → *WORM audit store*

**U.3 STRIDE risks & mitigations (representative)**

- **S**poofing: credential stuffing → *CAPTCHA after risk, lockout,
  breach‑check, MFA step‑up for payouts.*
- **T**ampering: IDOR on profile/media IDs → *row‑level auth checks,
  signed URLs, never expose S3 keys.*
- **R**epudiation: admin actions → *WORM audit, dual control for
  sensitive ops.*
- **I**nfo disclosure: NSFW leaks → *Safe‑Mode invariant in search & OG;
  originals never public.*
- **D**oS: search spam → *per‑IP/user QPS + leaky bucket; hard limits on
  suggestions.*
- **E**levation: partner API token misuse → *scoped OAuth, HMAC
  webhooks, rotate secrets.*

**U.4 Abuse cases & countermeasures**

- **Message solicitation bypass** (sharing emails) → *keyword
  redaction + strike system; rate‑limit per dyad.*
- **Spam profile creation** → *email verification, risk scoring, manual
  review on velocity spikes.*
- **Search gaming** (keyword stuffing) → *rank clamp on over‑edited
  accounts; quality signals (rating, reviews).*
- **Chargeback farming** → *refund kernel transparency, evidence packs,
  referral clawbacks.*
- **Storage abuse** → *upload caps, virus scan (if enabled), image type
  allow‑list.*

**U.5 Artifacts**

- *security/threat_model.md* (this content)
- *security/abuse_playbook.md* (signals, thresholds, actions)
- *security/controls_matrix.csv* (Threat→Control→Owner→Test)

**U.6 Acceptance**

- Each STRIDE item maps to at least one **control** and **test**.
- Red‑team checklist executed pre‑launch; critical findings remediated.

# **Appendix V --- Per

### TD-0316 (tech)

<!-- id: TD-0316 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1137600-1141600 -->

ed), image type
  allow‑list.*

**U.5 Artifacts**

- *security/threat_model.md* (this content)
- *security/abuse_playbook.md* (signals, thresholds, actions)
- *security/controls_matrix.csv* (Threat→Control→Owner→Test)

**U.6 Acceptance**

- Each STRIDE item maps to at least one **control** and **test**.
- Red‑team checklist executed pre‑launch; critical findings remediated.

# **Appendix V --- Performance, Load & Capacity Plan**

**Purpose.** Set budgets, prove them under load, and define
scale‑up/scale‑down rules.

**V.1 Budgets (targets at p95 unless noted)**

- **Web**: TTFB ≤ **400 ms**, LCP ≤ **2.5 s** (mobile p75), CLS ≤
  **0.1**, INP ≤ **200 ms**.
- **GraphQL**: cached ≤ **200 ms**, miss ≤ **450 ms**; steady **RPS
  150**, burst **500**.
- **Typesense**: median **\< 50 ms**, p95 **\< 150 ms** at **QPS 200**.
- **Uploads**: 50 MB per file, 10 concurrent per user.
- **Aurora**: CPU \< **60%**, connections \< **70%** of soft cap at
  steady state.

**V.2 Tests**

- **Load** (k6/gatling) for search, profile view, checkout; 30‑min
  steady + 5‑min burst.
- **Soak** 8‑hour run to catch leaks; **Chaos** single‑AZ failover
  rehearsal.
- **CWV** Lighthouse CI on top landings.

**V.3 Scale rules**

- Lambda provisioned concurrency ramps when p95 \> 450 ms for 5 min.
- Aurora ACU step‑up when CPU \>60% for 10 min.
- Typesense: move to 3‑node HA when index \> 20M docs or p95 \> 150 ms.

**V.4 Artifacts**

- *perf/k6/\*.js* (scenarios)
- *.github/workflows/perf.yml* (CI perf gates)
- *observability/dashboards/perf.json* (SLIs)

**V.5 Acceptance**

- All budgets green in CI; soak test passes; chaos drill documented.

# **Appendix W --- Internationalization (i18n), Localization (L10n) & Currency**

**Purpose.** Make locale, copy, and currency deterministic and SEO‑safe.

**W.1 Locales & routing**

- Locales: *en-US* (MVP), plan for *en-GB*, *fr-FR*, *de-DE*.
- Route pattern */\[locale\]/...* with default redirects; **hreflang** +
  canonical per §1.17.

**W.2 Catalog & formatting**

- ICU messages in *web/i18n/\*.json*; number/date/currency via Intl API.
- **Currency**: display user currency; charge in provider's settlement
  currency (Stripe).

**W.3 Translations**

- Keys freeze weekly; export → vendor → import; fallback to *en-US*.

**W.4 Acceptance**

- No hard‑coded strings; hreflang & canonical present; currency & dates
  respect locale.

# **Appendix X --- Accessibility (WCAG 2.2 AA) Plan**

**Purpose.** Guarantee accessibility across critical flows.

**X.1 Standards**

- WCAG 2.2 AA; ARIA 1.2; keyboard navigable; focus visible; color
  contrast ≥ 4.5:1.

**X.2 Flows covered**

- Auth, profile edit, search+filters, messaging, checkout, help
  articles.

**X.3 Tests**

- Axe CI on PRs; manual screen‑reader passes (NVDA/JAWS/VoiceOver);
  keyboard‑only E2Es.

**X.4 Artifacts**

- *a11y/checklist.md*, *a11y/violations_baseline.json*,
  *a11y/aria_map.md*

**X.5 Acceptance**

- Zero **serious/critical** Axe violations on top pages; manual passes
  recorded.

# **Appendix Y --- Legal Pack, Subprocessors & Consent (non‑legal template)**

**Purpose.** Document compliance surfaces (not legal advice).

**Y.1 Deliverables**

- Terms of Service, Privacy Policy, Cookie Policy.
- **Subprocessor inventory** (AWS, Stripe, email provider, error
  tracking).
- **CMP** (consent management) behavior for tracking cookies.

**Y.2 Records**

- *legal/subprocessors.md*, *privacy/data_lifecycle.md*,
  *privacy/dpia_summary.md*.

**Y.3 Acceptance**

- CMP banner in EU/UK; logs consent events; policies linked in footer.

# **Appendix Z --- Incident Management (SEV Ladder & Comms Templates)**

**Purpose.** Standardize response and communication.

**Z.1 Severity ladder**

- **SEV1**: outage/payments broken; **SEV2**: major impact; **SEV3**:
  partial; **SEV4**: minor.

**Z.2 Roles**

- Incident Commander, Ops, Comms, Scribe; 30‑min updates for SEV1/2.

**Z.3 Templates**

- Slack/Status page/email comms; postmortem template with action items &
  owners.


### TD-0317 (tech)

<!-- id: TD-0317 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1141200-1145200 -->

 (SEV Ladder & Comms Templates)**

**Purpose.** Standardize response and communication.

**Z.1 Severity ladder**

- **SEV1**: outage/payments broken; **SEV2**: major impact; **SEV3**:
  partial; **SEV4**: minor.

**Z.2 Roles**

- Incident Commander, Ops, Comms, Scribe; 30‑min updates for SEV1/2.

**Z.3 Templates**

- Slack/Status page/email comms; postmortem template with action items &
  owners.

**Z.4 Acceptance**

- Last drill completed within targets; templates in repo; paging routes
  tested.

# **Appendix AA --- Schema Migration & Data Backfill Playbook**

**Purpose.** Zero‑downtime migrations and safe rollbacks.

**AA.1 Expand/contract**

- Add nullable columns → dual‑write/read → backfill → cutover → drop
  old.

**AA.2 Tools**

- *db/migrations/\*.sql*, *ops/backfill/\*.ts* (idempotent).

**AA.3 Acceptance**

- Migration rehearsed in Stage with prod‑sized data; rollback tested.

# **Appendix AB --- QA Strategy & Test Matrix**

**Purpose.** Ensure coverage of critical business flows.

**AB.1 Test types**

- Unit, contract (GraphQL), E2E (Playwright), performance, security,
  accessibility, smoke.

**AB.2 Critical paths**

- Signup→verify, Profile edit, Search→view→checkout, Messaging with
  attachments, Refund, DSAR.

**AB.3 Gates**

- Coverage thresholds: **80% lines**, **95% functions on core
  services**; smoke must pass before deploy.

**AB.4 Artifacts**

- *qa/test_matrix.xlsx*, *.github/workflows/ci.yml* (gates),
  *qa/release_checklist.md*.

**AB.5 Acceptance**

- All gates green in Stage; release checklist signed.

# **Appendix AC --- FinOps & Cost Guardrails**

**Purpose.** Keep MVP costs low with elastic scaling.

**AC.1 Budgets & alerts**

- AWS Budgets: monthly targets for S3, Lambda, Aurora, CloudFront,
  Typesense.
- Alert at **70/90/100%** spend; anomaly detection on \> 2× daily
  baseline.

**AC.2 Unit economics**

- Track **\$/successful booking** and **\$/MAU**; dashboard derived from
  costs + analytics.

**AC.3 Rightsizing**

- TTLs and storage classes for S3; Dynamo TTLs; Aurora v2 autoscaling
  min/max set.

**AC.4 Acceptance**

- Budgets configured; alerts firing to on‑call; dashboard visible.

# **Appendix AD --- Cursor Agent Orchestration (4 Agents, Autopilot Build)**

**Purpose.** Make multi‑agent development deterministic, safe, and
efficient.

**AD.1 Roles**

- **Agent A (Backend/API):** GraphQL schema, Lambdas, migrations, tests.
- **Agent B (Frontend/UX):** Next.js pages/components, a11y, SEO.
- **Agent C (Infra/Ops):** CDK stacks, CI/CD, observability.
- **Agent D (Quality/SRE):** tests, dashboards, perf/chaos, RTM updates.

**AD.2 Guardrails**

- PR size caps; one agent per directory; CODEOWNERS; contract tests
  auto‑run on schema change.
- "Design‑first" protocol: edit schema/contract → generate stubs →
  implement.

**AD.3 Prompts & checklists**

- Each agent runs with a pinned prompt that references: RTM, appendices,
  acceptance criteria, and repository paths.

**AD.4 Acceptance**

- No cross‑agent drift; all PRs reference a **ReqID** from RTM; CI
  contract tests green.

# **Appendix V --- Performance, Load & Capacity (deep version)**

## **V.1 Budgets (exact numbers)**

**Web (mobile focus, p75 unless noted)**

- LCP ≤ **2500 ms**, INP ≤ **200 ms**, CLS ≤ **0.10**
- TTFB ≤ **400 ms** (edge cache hit ≤ **120 ms**, miss ≤ **400 ms**)
- JS initial ≤ **150 KB** gzip; CSS ≤ **70 KB**; images above-the-fold ≤
  **250 KB**

**GraphQL/API (p95)**

- Cached ≤ **200 ms**, Miss ≤ **450 ms**, Error rate ≤ **0.5%**

**Search (Typesense)**

- Median **\< 50 ms**, p95 **\< 150 ms**, Index freshness **≤ 5 min**

**Checkout**

- Server processing (excl. 3DS challenge) ≤ **600 ms** p95

## **V.2 k6 Scenarios (copy to** ***perf/k6/*****)**

***perf/k6/search.js***

*import http from \'k6/http\';*\
*import { check, sleep } from \'k6\';*\
*import { Trend, Rate } from \'k6/metrics\';*\
\
*export let SearchLat = new Trend(\'search_latency_ms\');*\
*export let SearchOK = new Rate(\'search_ok\');*\
\
*exp

### TD-0318 (tech)

<!-- id: TD-0318 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1144800-1148800 -->

5 min**

**Checkout**

- Server processing (excl. 3DS challenge) ≤ **600 ms** p95

## **V.2 k6 Scenarios (copy to** ***perf/k6/*****)**

***perf/k6/search.js***

*import http from \'k6/http\';*\
*import { check, sleep } from \'k6\';*\
*import { Trend, Rate } from \'k6/metrics\';*\
\
*export let SearchLat = new Trend(\'search_latency_ms\');*\
*export let SearchOK = new Rate(\'search_ok\');*\
\
*export const options = {*\
*stages: \[*\
*{ duration: \'2m\', target: 50 }, // ramp*\
*{ duration: \'5m\', target: 200 }, // steady*\
*{ duration: \'2m\', target: 0 }, // ramp down*\
*\],*\
*thresholds: {*\
*\'search_latency_ms\': \[\'p(95)\<150\'\],*\
*\'search_ok\': \[\'rate\>0.995\'\],*\
*},*\
*};*\
\
*const BASE = \_\_ENV.BASE_URL \|\|
\'*[*https://rastup.com*](https://rastup.com)*\';*\
*const Q = encodeURIComponent(\'photographer\');*\
*const CITY = encodeURIComponent(\'los-angeles\');*\
\
*export default function () {*\
*const url =
\`\${BASE}/api/search/people?q=\${Q}&city=\${CITY}&limit=24\`;*\
*const res = http.get(url, { headers: { \'Accept\': \'application/json\'
}});*\
*SearchLat.add(res.timings.duration);*\
*const ok = check(res, {*\
*\'status 200\': r =\> r.status === 200,*\
*\'json present\': r =\> r.headers\[\'Content-Type\'\] &&
r.headers\[\'Content-Type\'\].includes(\'application/json\'),*\
*});*\
*SearchOK.add(ok);*\
*sleep(0.3);*\
*}*\

***perf/k6/checkout.js***

*import http from \'k6/http\';*\
*import { check, sleep } from \'k6\';*\
*import { Trend, Rate } from \'k6/metrics\';*\
\
*export let PayLat = new Trend(\'checkout_latency_ms\');*\
*export let PayOK = new Rate(\'checkout_ok\');*\
\
*export const options = {*\
*stages: \[*\
*{ duration: \'1m\', target: 20 },*\
*{ duration: \'4m\', target: 60 },*\
*{ duration: \'1m\', target: 0 },*\
*\],*\
*thresholds: {*\
*\'checkout_latency_ms\': \[\'p(95)\<600\'\],*\
*\'checkout_ok\': \[\'rate\>0.995\'\],*\
*},*\
*};*\
\
*const BASE = \_\_ENV.BASE_URL \|\|
\'*[*https://rastup.com*](https://rastup.com)*\';*\
\
*export default function () {*\
*// 1) Start a "quote" (fake user flow; replace with Stage endpoint)*\
*let res = http.post(\`\${BASE}/api/checkout/start\`, JSON.stringify({*\
*serviceProfileId: \'spf_demo\',*\
*startTs: new Date(Date.now()+86400000).toISOString(),*\
*endTs: new Date(Date.now()+90000000).toISOString(),*\
*extras: \[\]*\
*}), { headers: { \'Content-Type\': \'application/json\' }});*\
*check(res, { \'start 200\': r =\> r.status === 200 });*\
*PayLat.add(res.timings.duration);*\
\
*// 2) Confirm payment (mocked in Stage or test-mode)*\
*const body = { txnId: res.json(\'txnId\'), method: \'card:test\' };*\
*res = http.post(\`\${BASE}/api/checkout/confirm\`,
JSON.stringify(body), { headers: { \'Content-Type\':
\'application/json\' }});*\
*const ok = check(res, { \'confirm 200\': r =\> r.status === 200 });*\
*PayOK.add(ok);*\
*sleep(1);*\
*}*\

***perf/k6/messages.js***

*import http from \'k6/http\';*\
*import { sleep, check } from \'k6\';*\
*import { Trend, Rate } from \'k6/metrics\';*\
\
*export let MsgLat = new Trend(\'messages_latency_ms\');*\
*export let MsgOK = new Rate(\'messages_ok\');*\
\
*export const options = {*\
*vus: 50, duration: \'5m\',*\
*thresholds: { \'messages_latency_ms\': \[\'p(95)\<250\'\],
\'messages_ok\': \[\'rate\>0.995\'\] },*\
*};*\
\
*const BASE = \_\_ENV.BASE_URL \|\|
\'*[*https://rastup.com*](https://rastup.com)*\';*\
\
*export default function () {*\
*// get inbox*\
*let res = http.get(\`\${BASE}/api/messages/inbox\`, { headers: {
\'Accept\': \'application/json\' }});*\
*check(res, { \'inbox 200\': r =\> r.status === 200 });*\
*MsgLat.add(res.timings.duration);*\
*// open thread*\
*if (res.status === 200 && res.json(\'threads\')?.length) {*\
*const id = res.json(\'threads\')\[0\].id;*\
*res = http.get(\`\${BASE}/api/messages/thread/\${id}\`);*\
*const ok = check(res, { \'thread 200\': r =\> r.status === 200 });*\
*MsgOK.add(ok);*\
*}*\
*sleep(0.5);*\
*}*\

**CI workflow (*****.github/workflows/perf.yml*****)**

*name: perf*\
*

### TD-0319 (tech)

<!-- id: TD-0319 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1148400-1152400 -->

.add(res.timings.duration);*\
*// open thread*\
*if (res.status === 200 && res.json(\'threads\')?.length) {*\
*const id = res.json(\'threads\')\[0\].id;*\
*res = http.get(\`\${BASE}/api/messages/thread/\${id}\`);*\
*const ok = check(res, { \'thread 200\': r =\> r.status === 200 });*\
*MsgOK.add(ok);*\
*}*\
*sleep(0.5);*\
*}*\

**CI workflow (*****.github/workflows/perf.yml*****)**

*name: perf*\
*on:*\
*workflow_dispatch:*\
*schedule:*\
* - cron: \"0 6 \* \* \*\" \# daily 06:00 UTC*\
*jobs:*\
*k6:*\
*runs-on: ubuntu-latest*\
*strategy:*\
*matrix:*\
*script: \[search.js, checkout.js, messages.js\]*\
*steps:*\
* - uses: actions/checkout@v4*\
* - name: Install k6*\
*run: \|*\
*sudo gpg -k \|\| true*\
*curl -s*
[*https://packagecloud.io/install/repositories/loadimpact/k6/script.deb.sh*](https://packagecloud.io/install/repositories/loadimpact/k6/script.deb.sh)
*\| sudo bash*\
*sudo apt-get install -y k6*\
* - name: Run k6*\
*env: { BASE_URL: \${{ secrets.PERF_BASE_URL }} }*\
*run: k6 run perf/k6/\${{ matrix.script }}*\

# **Appendix Z --- Incident Management (deep version)**

## **Z.1 Severity levels & examples**

- **SEV-1** (Critical): payments down, major PII exposure, widespread
  outage.
- **SEV-2** (High): checkout degradation, search results invalid, DMCA
  flood.
- **SEV-3** (Medium): minor feature outage, partial region issue.
- **SEV-4** (Low): cosmetic bugs, minor latency.

## **Z.2 Roles**

- **Incident Commander (IC)**, **Ops**, **Comms**, **Scribe**,
  **Resolver(s)**.

## **Z.3 Paging rules**

- Alerts that page must be **actionable**; no pages for known noisy
  metrics.
- SEV-1: page **primary & secondary** simultaneously; IC within 5
  minutes.

## **Z.4 Comms templates (copy into** ***ops/templates/*****)**

**Slack (war-room channel)**

*\[SEV-\<n\>\] \<short title\>*\
*Start: \<UTC time\>*\
*IC: \<name\>, Scribe: \<name\>*\
*Impact: \<who/what/where\>*\
*Hypotheses:*\
*Mitigations tried:*\
*Next update at: \<time\>*\

**Status page --- initial**

*Title: Degraded performance in \<component\>*\
*Body: We are investigating elevated errors/latency in \<component\>.
Bookings and messaging may be impacted for some users.*\
*Start: \<time UTC\>*\
*Next update: \<+30 minutes\>*\

**Customer email --- resolved**

*Subject: Incident on \<date\> has been resolved*\
*Body: Between \<time range UTC\>, some users experienced \<impact\>.
The issue has been resolved. Root cause: \<high-level\>. We are taking
the following steps to prevent recurrence: \<bullets\>. We apologize for
the disruption.*\

## **Z.5 Timeline of a typical SEV-1**

5540. IC declared, roles assigned, status page updated.
5541. Mitigate (flip feature flags, rollback, scale).
5542. Diagnose with logs/traces; fix; monitor.
5543. Resolve & close; postmortem within **5 business days**.

## **Z.6 Postmortem template**

*Summary:*\
*Timeline:*\
*Customer impact:*\
*Root cause:*\
*Fix:*\
*Action items (owner, due):*\
*Lessons:*\

## **Z.7 Acceptance**

- Last drill met paging and comms SLAs; postmortems exist for SEV-1/2;
  action items tracked.

# **Appendix AC --- FinOps & Cost Guardrails (deep version)**

## **AC.1 AWS Budgets YAML (*****ops/finops/budgets.yml*****)**

*budgets:*\
* - name: s3-monthly*\
*amount_usd: 250*\
*tag: service:s3*\
*alerts:*\
* - threshold: 70*\
* - threshold: 90*\
* - threshold: 100*\
* - name: lambda-monthly*\
*amount_usd: 400*\
*tag: service:lambda*\
*alerts: \[70, 90, 100\]*\
* - name: aurora-monthly*\
*amount_usd: 1200*\
*tag: service:aurora*\
*alerts: \[70, 90, 100\]*\
* - name: cloudfront-monthly*\
*amount_usd: 600*\
*tag: service:cloudfront*\
*alerts: \[70, 90, 100\]*\
* - name: typesense-monthly*\
*amount_usd: 300*\
*tag: service:typesense*\
*alerts: \[70, 90, 100\]*\

## **AC.2 Unit-economics SQL (Athena) ---** ***analytics/sql/unit_economics.sql***

*WITH cost AS (*\
*SELECT service, SUM(cost_usd) AS usd*\
*FROM finops.daily_service_cost*\
*WHERE dt BETWEEN date_trunc(\'month\', current_date) AND current_date*\
*GROUP BY 1*

## Pre-Run Ritual (HARD)

- [ ] Read your last run report.
- [ ] Read any related run reports for the same WBS or feature.
- [ ] Summarise Plan vs Done vs Pending before writing new code.

## Locking & Access (HARD)

- Acquire your lock file at `ops/locks/AGENT-3.lock` before modifying files.
- Declare your scope_paths[] in your run report.
- If you detect overlapping scopes or foreign changes, STOP and hand back to the Orchestrator.

## Required Run Report Content (HARD)

- Context Snapshot (WBS IDs, blueprint IDs, assumptions).
- What Was Done vs Planned.
- How It Was Done (architecture/implementation narrative).
- Testing (commands, results, coverage, security scans) + 'Testing Proof' paragraph.
- Issues & Problems (with root causes where possible).
- Locations / Touch Map (files created/modified/removed, migrations, databases touched).
- Suggestions for Next Agents.
- Progress & Checklist.

## Orchestrator Attach Pack (HARD)

- Place under `docs/orchestrator/from-agents/AGENT-3/run-<timestamp>-attach.zip`.
- Include: run report, diff summary, CI/test artifacts, performance/security results,
  and a manifest.json (agent, run_id, wbs_ids, blueprint_ids, status).

## Testing (HARD)

- Define a test plan before coding.
- Implement unit/integration/E2E tests where appropriate.
- Record all test commands and results in the run report.
- If you cannot implement or run tests, mark the task partial and propose follow-up WBS items.

## Implementation Notes

(Use this space during your run.)

## Issues & Risks

(Document any issues, risks, or TODOs you discover.)

## Suggestions for Next Agents

(Document any guidance for follow-up work.)
