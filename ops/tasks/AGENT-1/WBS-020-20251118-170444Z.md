# Task for AGENT-1: WBS-020 — Analytics, Experimentation, and Data Quality

You are a Cursor CLI agent working under a central Orchestrator.

## WBS Task

- ID: WBS-020
- Title: Analytics, Experimentation, and Data Quality
- Phase: Ops
- Agent: AGENT-1
- Depends on: WBS-002
- Blueprint IDs: TD-0066, TD-0067, TD-0068, TD-0069, TD-0070, TD-0071, TD-0072, TD-0073, TD-0074, TD-0075, TD-0076, TD-0077, TD-0078, TD-0079, TD-0080, TD-0081, TD-0082, TD-0083, TD-0084, TD-0085, TD-0086, TD-0087, TD-0088, TD-0089, TD-0090, TD-0091, TD-0092, TD-0093, TD-0094, TD-0095, TD-0096, TD-0097, TD-0098, TD-0099, TD-0100, TD-0101, TD-0102, TD-0103, TD-0104, TD-0105, TD-0106, TD-0107, TD-0108, TD-0109, TD-0110, TD-0111, TD-0112, TD-0113, TD-0114, TD-0115, TD-0116, TD-0117, TD-0118, TD-0119, TD-0120, TD-0121, TD-0122, TD-0123, TD-0124, TD-0125

### Description

Build analytics pipelines with event ingestion, schema validation, identity stitching, and attribution using click-token proof. Implement experimentation framework with CUPED, SRM guardrails, preregistration, and power analysis. Develop data quality rules, lineage tracking, and DSAR compliance with automated retention and deletion. Provide BI dashboards for marketplace health, growth, trust & safety, finance, and support. Enforce cost controls with budgets, query limits, and rightsizing. Implement security and privacy controls including PII masking, audit logs, and incident response. Provide runbooks for data governance, incident management, and compliance.

### Acceptance Criteria

- Event ingestion pipeline with schema validation and identity stitching
- Attribution using click-token proof and channel grouping
- Experimentation framework with CUPED, SRM guardrails, and preregistration
- Data quality rules, lineage tracking, and DSAR compliance automated
- BI dashboards for marketplace health, growth, trust, finance, and support
- Cost controls with budgets, query limits, and rightsizing implemented
- Security and privacy controls including PII masking and audit logs
- Runbooks for data governance, incident management, and compliance
- Tests cover data pipeline, experiments, quality, and privacy


## Relevant Blueprint Chunks

### TD-0066 (tech)

<!-- id: TD-0066 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 237600-241600 -->

UPED‑ready metrics.

## **1.13.B High‑level architecture**

- Ingestion (near real‑time):

  - App & web clients send event envelopes to an authenticated
    **/collect** endpoint (AppSync → Lambda).
  - Backend services publish **domain events** (the ones we enumerated
    across §§1.3--1.12) to **EventBridge**.
  - External providers (Stripe, e‑sign, SES) → webhook ingesters →
    normalized events → EventBridge.

- Transport & storage:

  - **EventBridge → Kinesis Firehose → S3** (partitioned
    *dt=YYYY‑MM‑DD/hour=HH*).
  - Bronze stored as **newline‑delimited JSON**; compaction jobs produce
    **Parquet** for Athena.
  - **Glue Catalog** defines tables for Bronze and Silver; partitions
    registered automatically.

- Transformations:

  - **AWS Glue** (PySpark) or **Athena CTAS** jobs to build Silver/Gold
    on schedules (NRT 5--15 min for ops, hourly/daily for heavy facts).
  - **dbt‑core on Athena** for modeling, tests, and lineage (optional
    but recommended).

- Serving & BI:

  - **Athena** for ad‑hoc; **QuickSight** (SPICE) for dashboards;
    optional **Metabase** (open‑source) on top of Athena/Redshift.
  - **Ops pages** in Admin use **materialized views** (Athena CTAS to
    Parquet) for low‑latency.

## **1.13.C Event envelope & contracts**

**Envelope (all events)**

*{*\
*\"event\": \"string\", // e.g., \"checkout.start\", \"payout.paid\"*\
*\"v\": 1, // schema version*\
*\"occurred_at\": \"2025-11-06T15:24:18Z\",*\
*\"received_at\": \"2025-11-06T15:24:19Z\",*\
*\"user_id\": \"usr\_\...\", // optional for anon*\
*\"anon_id\": \"an\_\...\", // sticky browser/device id when user not
logged in*\
*\"session_id\": \"ses\_\...\", // client session*\
*\"city\": \"houston\", // normalized city code when relevant*\
*\"device\": { \"ua\": \"hash\", \"os\": \"iOS\", \"app_ver\": \"1.0.3\"
},*\
*\"context\": { \"role\": \"buyer\|seller\|studio_owner\|admin\" },*\
*\"ids\": { \"lbg_id\": \"lbg\_\...\", \"leg_id\": \"leg\_\...\",
\"doc_id\": \"doc\_\...\" },*\
*\"money\": { \"amount_cents\": 12345, \"currency\": \"USD\" }, //
present when applicable*\
*\"payload\": { /\* event-specific fields, see below \*/ }*\
*}*\

**Conventions**

- **Amounts** always in integer cents.
- **Durations** in seconds.
- **Booleans** plain; **enums** strict strings.
- **PII** (names, emails, phones, addresses) **never** included---join
  on ids in Silver when necessary.

**Example families (non‑exhaustive; aligned to earlier sections)**

- **Search (§1.2):** *search.query*, *search.results_view*,
  *search.card_impression*, *search.card_click*, *search.save*,
  *search.alert.create\|triggered*.
- **Checkout/Booking (§1.3):** *checkout.start*,
  *docs.pack.create\|signed*,
  *payment.intent.created\|succeeded\|failed*, *lbg.confirmed*,
  *leg.in_progress\|completed*, *amendment.added*,
  *refund.created\|succeeded*, *payout.queued\|paid\|failed*.
- **Messaging (§1.4):** *thread.create*, *message.send*,
  *action.create\|state_change*, *deliverable.proof\|final\|approved*.
- **Docs (§1.5):** *doc.pack.issued\|signed*, *doc.pdf.hash_verified*.
- **Trust (§1.6):** *idv.started\|passed\|failed*,
  *bg.invited\|clear\|consider*, *risk.score.updated*.
- **Promotions (§1.7):** *promo.impression\|click\|invalid_click*,
  *promo.spend.debit\|credit*, *promo.topup.charge.succeeded*.
- **Reviews (§1.8):** *review.create\|hide\|remove\|restore*,
  *reputation.recompute*.
- **Comms (§1.10):** *notification.sent*,
  *email.bounce\|complaint\|unsubscribe*.
- **Studios (§1.11):** *studio.quote.request\|response*,
  *studio.verification.approved\|revoked*.
- **Infra (§1.12):** *waf.block*, *alarm.triggered*,
  *deploy.succeeded\|failed* (for internal SRE metrics).

We will ship **JSON Schemas** per event type with unit tests to
guarantee backward‑compatible evolution (*v* increments only on breaking
changes).

## **1.13.D Bronze → Silver → Gold modeling**

**Bronze (raw):**\
*s3://data/bronze/events/dt=YYYY‑MM‑DD/hour=HH/\*.json*

- Append‑only; immutable

### TD-0067 (tech)

<!-- id: TD-0067 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 241200-245200 -->

fra (§1.12):** *waf.block*, *alarm.triggered*,
  *deploy.succeeded\|failed* (for internal SRE metrics).

We will ship **JSON Schemas** per event type with unit tests to
guarantee backward‑compatible evolution (*v* increments only on breaking
changes).

## **1.13.D Bronze → Silver → Gold modeling**

**Bronze (raw):**\
*s3://data/bronze/events/dt=YYYY‑MM‑DD/hour=HH/\*.json*

- Append‑only; immutable.
- Glue Catalog table *bronze_events* with partitions (*dt*, *hour*).

**Silver (typed/curated):** primary tables

- *fact_search_impressions*, *fact_search_clicks* (joinable via
  *impression_id*).
- *fact_booking_legs* (one row per leg status change with snapshots).
- *fact_payments*, *fact_refunds*, *fact_payouts*, *fact_disputes*.
- *fact_promotions_events* (impressions/clicks/invalids),
  *fact_promotions_spend*.
- *fact_messages*, *fact_action_cards*, *fact_notifications*.
- *fact_docs*, *fact_idv_bg*, *fact_reviews*.
- **Dimensions**: *dim_user_public* (no PII), *dim_service_profile*,
  *dim_studio*, *dim_city*, *dim_device*, *dim_campaign*.

**Gold (marts/KPIs):**

- **Marketplace**: *kpi_gmv_daily*, *kpi_take_rate*,
  *kpi_conversion_funnel* (search→profile→checkout→confirm),
  *kpi_cancellations*, *kpi_refunds*, *kpi_disputes*.
- **Supply**: *kpi_seller_activation*, *kpi_studio_verification_rate*,
  *kpi_acceptance_window_hist*.
- **Trust**: *kpi_idv_pass_rate*, *kpi_bg_clear_rate*,
  *kpi_risk_buckets*.
- **Promotions**: *kpi_promo_ctr*, *kpi_invalid_rate*,
  *kpi_spend_vs_budget*.
- **Comms**: *kpi_delivery*, *kpi_bounce*, *kpi_complaint*,
  *kpi_open_click* (non‑sensitive).
- **SRE**: *kpi_api_latency_p95*, *kpi_error_rates*, *kpi_waf_blocks*.

**Build strategy**

- Glue/CTAS jobs materialize Silver to Parquet partitioned by *dt* (and
  sometimes *city*).
- Gold uses **dbt models** (on Athena) with tests (unique keys, not
  null, referential integrity), incremental by *dt*.

## **1.13.E Near‑real‑time ops views**

Some ops metrics (recon gates, payout backlogs, dispute queues) require
freshness **\<15 min**.

- Create **NRT materialized views** in S3 via Athena CTAS running every
  **5--10 min**, small partitions only for today's hours.
- Admin consoles read from these materialized Parquet tables for stable,
  fast loads.

## **1.13.F Experimentation framework**

**Assignment**

- Sticky bucket per *user_id* (or *anon_id* pre‑login) via salted hash
  (e.g., *hash(user_id + exp_key) % 100*).
- Variants defined in AppConfig (feature flags). Exposure logged as
  *exp.exposed* at first checkpoint.

**Metrics & guardrails**

- Primary metrics per experiment pre‑declared; guardrails include:
  refund rate, complaint rate, SLO latency, bounce for comms.
- **CUPED** or stratified analyses supported by exporting **per‑user
  aggregates** (pre‑period covariates).
- **Sequential** or fixed horizon; maintain cookbook for analysts.

**Data**

- *dim_exposure* table links *user_id*/*anon_id* to *exp_key*,
  *variant*, *exposed_at*.
- Gold layer produces per‑variant metric tables with p‑values/CI
  (analyst notebooks).

## **1.13.G Data quality, validation & lineage**

- **Contract tests**: every event schema tested in CI; unknown event
  fields flagged but preserved in Bronze.
- **Great Expectations** (or **Deequ**) on Silver/Gold: uniqueness of
  ids, non‑nulls, ranges (e.g., *rating between 1..5*), monotonicity
  (e.g., payout queue should drain).
- **Lineage**: dbt docs + event schema registry show upstream/downstream
  for each mart.
- **Alerts**: failed expectations page Ops; large deltas in GMV/CTR vs
  7‑day average trigger review.

## **1.13.H Privacy, governance & retention**

- **Lake Formation** for table/column permissions; analysts get
  **row‑level filtering** by environment and city if required.

- **Hashing**: *email_sha256*, *phone_sha256* kept only in **Silver
  private** area (not in Gold); never in events.

- **DSAR/Deletion**: user deletion writes a **tombstone event**; nightly
  job purges Silver/Gold joins that 

### TD-0068 (tech)

<!-- id: TD-0068 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 244800-248800 -->

 **1.13.H Privacy, governance & retention**

- **Lake Formation** for table/column permissions; analysts get
  **row‑level filtering** by environment and city if required.

- **Hashing**: *email_sha256*, *phone_sha256* kept only in **Silver
  private** area (not in Gold); never in events.

- **DSAR/Deletion**: user deletion writes a **tombstone event**; nightly
  job purges Silver/Gold joins that carry the user's PII hash; Bronze
  (raw, immutable) is handled by maintaining a mapping table of
  redactions and excluding on read.

- **Retention**:

  - Bronze events: 18 months (partition delete after).
  - Silver facts: 24--36 months depending on table.
  - Gold marts: rolling 24 months.

- **Legal holds**: tag partitions; purge blocked until hold cleared.

## **1.13.I BI & dashboards**

- **QuickSight** workspaces per function: **Executive**, **City Ops**,
  **Trust**, **Finance**, **Support**, **Growth**.
- Use **SPICE** extracts for fast loads; refresh cadences (NRT where
  appropriate, otherwise daily).
- **Metabase** (optional) for self‑serve exploration; connects to
  Athena; row‑level guards via Lake Formation.

**Core dashboards** (initial)

- **Executive**: GMV, take rate, bookings, CAC/LTV (when available),
  city trends, SLO tiles.
- **Operations**: payout backlog, recon variance, cancellation/refund
  bands, dispute queue.
- **Trust**: IDV/BG funnels, risk bucket movement, dispute outcomes.
- **Growth/Promotions**: impressions/clicks/invalid rate, CPA proxy,
  campaign pacing.
- **Comms**: delivery vs bounce/complaints, digest suppression, opt‑out
  flow.
- **Studios**: verification rate, amenity usage, quote success %.

## **1.13.J Cost posture & performance**

- **S3**: Parquet + Snappy compression; partition by date (and city when
  cardinality helps); lifecycle after 90--180 days to colder storage.
- **Athena**: avoid scanning whole buckets---push **partition filters**;
  ctables store sorted small files for today's partitions; limit CTAS
  output file sizes (256--512 MB).
- **Glue**: small DPU reservations; scale jobs by schedule; stop on
  idle; reuse code across models.
- **QuickSight**: prefer SPICE extracts (charged per user/capacity) with
  scheduled refresh; keep visuals focused.
- **Redshift Serverless**: disabled at launch; enable behind a flag if
  Athena latency becomes a blocker; start at smallest RPU with pause
  when idle.

## **1.13.K Admin tooling**

- **Schema registry** web UI (read‑only) listing events & versions with
  examples.
- **Backfill runner** for late events (replay a partition/day without
  clobbering existing Parquet).
- **Data dictionary** (Gold) with KPI definitions and SQL behind each
  card (single source of truth).
- **Access audit**: who queried which tables/partitions (CloudTrail/Lake
  Formation).

## **1.13.L Error taxonomy (data platform)**

- *EVENT_SCHEMA_INVALID* --- payload fails JSON Schema.
- *EVENT_REJECTED_RATE_LIMIT* --- client flooding; sample/delay.
- *PIPELINE_LAG_EXCEEDED* --- Bronze→Silver lag \> SLO.
- *QUALITY_CHECK_FAILED* --- Great Expectations failed (which check &
  partition).
- *DSAR_CONFLICT* --- deletion collides with legal hold.
- *BI_REFRESH_FAILED* --- SPICE refresh failed.

## **1.13.M SLOs & alerts**

- **Ingestion**: EventBridge→S3 (Bronze) **≤ 60 s p95**.
- **NRT views**: Bronze→Silver (ops views) **≤ 10 min p95**.
- **Daily marts**: complete by **T+6h** local.
- **BI**: Dashboards available by **08:00** local; SPICE refresh success
  **≥ 99%** rolling 7 days.

Alerts on: ingestion lag beyond SLO, quality failures, unusual GMV
deltas, ATHENA_SCANNED_BYTES anomalies (cost), QuickSight refresh
failures.

## **1.13.N Test plan (CI + stage)**

**Contracts & ingestion**

1347. Validate JSON Schemas for all events; generate fixtures; reject
      malformed example.
1348. Simulate Firehose → S3 path; partitions and Glue catalog creation
      verified.

**Transforms**\
3) Build Silver facts with sample events; ensure referential integrity;
Great Expe

### TD-0069 (tech)

<!-- id: TD-0069 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 248400-252400 -->

YTES anomalies (cost), QuickSight refresh
failures.

## **1.13.N Test plan (CI + stage)**

**Contracts & ingestion**

1347. Validate JSON Schemas for all events; generate fixtures; reject
      malformed example.
1348. Simulate Firehose → S3 path; partitions and Glue catalog creation
      verified.

**Transforms**\
3) Build Silver facts with sample events; ensure referential integrity;
Great Expectations pass.\
4) Build Gold marts; compare against golden KPIs.

**Ops freshness**\
5) NRT materialized views update within 10 min under synthetic load.

**Experimentation**\
6) Bucketing sticky across login; exposure logged once; per‑variant
metrics computed.

**Privacy & DSAR**\
7) DSAR tombstone leads to exclusion in Silver/Gold; Bronze read‑time
exclusion works; legal hold override blocks purge.

**BI**\
8) SPICE extracts refresh; dashboards render within targets.

**Cost**\
9) Athena queries using partition filters; scanned bytes within budget;
lifecycle transitions occur.

## **1.13.O Work packages (Cursor agents)**

- **Agent C --- Ingestion & Modeling**\
  WP‑DATA‑ING‑01: Event schemas & validation; EventBridge + Firehose S3
  pipeline.\
  WP‑DATA‑ING‑02: Bronze→Silver ETL (Glue/Athena CTAS) + dbt project
  skeleton.
- **Agent B --- Quality & Privacy**\
  WP‑DATA‑QTY‑01: Great Expectations suite; alerts; DSAR tombstone flow;
  Lake Formation grants.
- **Agent A --- BI & Experiments**\
  WP‑DATA‑BI‑01: QuickSight datasets & dashboards; SPICE schedules; data
  dictionary.\
  WP‑EXP‑01: Assignment & exposure logging; guardrail metric jobs;
  analysis notebooks.
- **Agent D --- Ops & Admin**\
  WP‑DATA‑OPS‑01: NRT materialized views (ops); backfill runner; schema
  registry UI.\
  WP‑COST‑01: Athena scanned‑bytes monitor; lifecycle & partition
  housekeeping jobs.

## **1.13.P Acceptance criteria (mark §1.13 FINAL only when ALL true)**

1353. Event pipeline ingests and lands Bronze with SLO **≤ 60 s p95**;
      schemas validated.
1354. Silver facts and dimensions materialize with tests passing; Gold
      marts compute KPIs correctly.
1355. NRT ops views feed Admin consoles within **≤ 10 min p95**.
1356. Experimentation framework logs exposures, runs metrics with
      guardrails, and supports CUPED/sequential analysis.
1357. Privacy: no PII in events; DSAR works; Lake Formation permissions
      enforced; legal holds respected.
1358. BI dashboards live for Executive/City
      Ops/Trust/Finance/Growth/Comms; SPICE refresh success ≥ 99%.
1359. Cost: Athena scanned bytes within target; lifecycle rules active;
      no unnecessary compute.
1360. Telemetry & alerts cover pipeline lag, data quality, cost
      anomalies, and BI refresh health.

# **§1.13 --- Data Platform, Analytics & Experimentation (Expanded)**

Below I expand each subsection with **executable‑grade detail**:
concrete event schemas, ingestion & storage configs, Athena/CTAS/dbt
models, data‑quality suites, DSAR/retention, Lake Formation permissions,
NRT ops views, experimentation machinery, BI datasets, and cost/alerting
runbooks. You can drop these artifacts into the repo (under */data/* and
*/amplify/backend/observability/*) and wire them with your Amplify Gen 2
stacks.

## **1.13.C (expanded) --- Event Envelope & Contracts**

### **C.1 Canonical envelope (JSON Schema v1)**

*{*\
*\"\$id\":
\"*[*https://rastup.com/schemas/event-envelope.v1.json*](https://rastup.com/schemas/event-envelope.v1.json)*\",*\
*\"\$schema\":
\"*[*https://json-schema.org/draft/2020-12/schema*](https://json-schema.org/draft/2020-12/schema)*\",*\
*\"type\": \"object\",*\
*\"required\": \[\"event\", \"v\", \"occurred_at\", \"received_at\",
\"context\", \"ids\", \"payload\"\],*\
*\"properties\": {*\
*\"event\": { \"type\": \"string\", \"pattern\": \"\^\[a-z0-9\_.\]+\$\"
},*\
*\"v\": { \"type\": \"integer\", \"enum\": \[1\] },*\
*\"occurred_at\": { \"type\": \"string\", \"format\": \"date-time\" },*\
*\"received_at\": { \"type\": \"string\", \"format\": \"date-time\" },*\
*\"user_id\": { \"ty

### TD-0070 (tech)

<!-- id: TD-0070 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 252000-256000 -->

, \"v\", \"occurred_at\", \"received_at\",
\"context\", \"ids\", \"payload\"\],*\
*\"properties\": {*\
*\"event\": { \"type\": \"string\", \"pattern\": \"\^\[a-z0-9\_.\]+\$\"
},*\
*\"v\": { \"type\": \"integer\", \"enum\": \[1\] },*\
*\"occurred_at\": { \"type\": \"string\", \"format\": \"date-time\" },*\
*\"received_at\": { \"type\": \"string\", \"format\": \"date-time\" },*\
*\"user_id\": { \"type\": \"string\", \"pattern\":
\"\^usr\_\[A-Za-z0-9\]+\$\" },*\
*\"anon_id\": { \"type\": \"string\", \"pattern\":
\"\^an\_\[A-Za-z0-9\]+\$\" },*\
*\"session_id\": { \"type\": \"string\", \"pattern\":
\"\^ses\_\[A-Za-z0-9\]+\$\" },*\
*\"city\": { \"type\": \"string\" },*\
*\"device\": {*\
*\"type\": \"object\",*\
*\"properties\": {*\
*\"ua_hash\": { \"type\": \"string\" },*\
*\"os\": { \"type\": \"string\" },*\
*\"app_ver\": { \"type\": \"string\" }*\
*},*\
*\"additionalProperties\": false*\
*},*\
*\"context\": {*\
*\"type\": \"object\",*\
*\"required\": \[\"role\", \"env\"\],*\
*\"properties\": {*\
*\"role\": { \"type\": \"string\", \"enum\":
\[\"buyer\",\"seller\",\"studio_owner\",\"admin\",\"guest\"\] },*\
*\"env\": { \"type\": \"string\", \"enum\":
\[\"dev\",\"stage\",\"prod\"\] }*\
*},*\
*\"additionalProperties\": true*\
*},*\
*\"ids\": {*\
*\"type\": \"object\",*\
*\"properties\": {*\
*\"lbg_id\": { \"type\": \"string\", \"pattern\": \"\^lbg\_\" },*\
*\"leg_id\": { \"type\": \"string\", \"pattern\": \"\^leg\_\" },*\
*\"doc_id\": { \"type\": \"string\", \"pattern\": \"\^doc\_\" },*\
*\"impression_id\": { \"type\": \"string\", \"pattern\": \"\^imp\_\"
},*\
*\"campaign_id\": { \"type\": \"string\", \"pattern\": \"\^pcmp\_\" }*\
*},*\
*\"additionalProperties\": true*\
*},*\
*\"money\": {*\
*\"type\": \"object\",*\
*\"properties\": {*\
*\"amount_cents\": { \"type\": \"integer\", \"minimum\": 0 },*\
*\"currency\": { \"type\": \"string\", \"minLength\": 3, \"maxLength\":
3 }*\
*},*\
*\"additionalProperties\": false*\
*},*\
*\"payload\": { \"type\": \"object\" }*\
*},*\
*\"additionalProperties\": false*\
*}*\

**PII‑free rule:** No names, emails, phones, exact addresses, or images
in events. Join to PII only inside **Silver private** models when
absolutely necessary.

### **C.2 Example event schemas (selected)**

- search.card_impression.v1

*{*\
*\"\$id\": \".../search.card_impression.v1.json\",*\
*\"type\": \"object\",*\
*\"required\":
\[\"query_hash\",\"result_pos\",\"target_type\",\"target_id\",\"filters\"\],*\
*\"properties\": {*\
*\"query_hash\": { \"type\":\"string\" },*\
*\"result_pos\": { \"type\":\"integer\", \"minimum\": 1 },*\
*\"target_type\": { \"type\":\"string\",
\"enum\":\[\"service_profile\",\"studio\"\] },*\
*\"target_id\": { \"type\":\"string\" },*\
*\"filters\": { \"type\":\"object\" }*\
*}*\
*}*\

- lbg.confirmed.v1

*{*\
*\"\$id\": \".../lbg.confirmed.v1.json\",*\
*\"type\": \"object\",*\
*\"required\": \[\"leg_count\",\"payment_method\",\"total_cents\"\],*\
*\"properties\": {*\
*\"leg_count\": { \"type\":\"integer\",\"minimum\":1 },*\
*\"payment_method\": { \"type\":\"string\",\"enum\":\[\"card\",\"ach\"\]
},*\
*\"total_cents\": { \"type\":\"integer\",\"minimum\":0 },*\
*\"has_deposit_auth\": { \"type\":\"boolean\" }*\
*}*\
*}*\

- promo.click.v1

*{*\
*\"\$id\": \".../promo.click.v1.json\",*\
*\"type\": \"object\",*\
*\"required\": \[\"impression_id\",\"campaign_id\",\"valid\"\],*\
*\"properties\": {*\
*\"impression_id\": { \"type\":\"string\" },*\
*\"campaign_id\": { \"type\":\"string\" },*\
*\"valid\": { \"type\":\"boolean\" },*\
*\"invalid_reason\": { \"type\":\"string\" }*\
*}*\
*}*\

- payout.paid.v1

*{*\
*\"\$id\":\".../payout.paid.v1.json\",*\
*\"type\":\"object\",*\
*\"required\":\[\"leg_id\",\"amount_cents\",\"provider_ref\"\],*\
*\"properties\":{*\
*\"leg_id\":{\"type\":\"string\"},*\
*\"amount_cents\":{\"type\":\"integer\",\"minimum\":0},*\
*\"provider_ref\":{\"type\":\"string\"}*\
*}*\
*}*\

**Versioning:** Backward‑compatible field additions do not bump *v*;
breaking changes → new schema id and *v+

### TD-0071 (tech)

<!-- id: TD-0071 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 255600-259600 -->

":\".../payout.paid.v1.json\",*\
*\"type\":\"object\",*\
*\"required\":\[\"leg_id\",\"amount_cents\",\"provider_ref\"\],*\
*\"properties\":{*\
*\"leg_id\":{\"type\":\"string\"},*\
*\"amount_cents\":{\"type\":\"integer\",\"minimum\":0},*\
*\"provider_ref\":{\"type\":\"string\"}*\
*}*\
*}*\

**Versioning:** Backward‑compatible field additions do not bump *v*;
breaking changes → new schema id and *v+1* in envelope.

## **1.13.B & 1.13.E (expanded) --- Ingestion, Bronze, and Near‑Real‑Time Views**

### **B.1 Event ingress path**

- **Client events**: App/Web → AppSync mutation *publishEvent* → Lambda
  *evt_ingest*:

  - Validate against **envelope schema** + **event‑specific schema**
    (ajv).
  - Add server fields (*received_at*, *context.env*, *ua_hash*).
  - Put onto **EventBridge Bus** (*rastup-events*).

- **Backend events**: services publish directly to EventBridge with the
  same envelope contract.

- **Provider webhooks** (Stripe, e‑sign, SES): normalized in dedicated
  Lambdas and published to EventBridge.

### **B.2 EventBridge → Firehose → S3 (Bronze)**

- Kinesis Firehose (Direct PUT from EventBridge)

  - **Buffer size**: 5 MB or **buffer interval** 60 s (whichever first).
  - **Compression**: GZIP.
  - **Dynamic partitioning** via record transformation Lambda to set S3
    prefix:

*s3://data/bronze/events/dt=YYYY-MM-DD/hour=HH/env=\${env}/event=\${event}/*\

- - **Backup**: All failures to *s3://data/bronze/\_bad/...*
    (quarantine) with original payload + error.
- **S3 object key** example:\
  *.../dt=2025-11-06/hour=15/env=prod/event=lbg.confirmed/part-00023-...json.gz*

### **B.3 Glue Catalog & Athena (Bronze table)**

*CREATE EXTERNAL TABLE IF NOT EXISTS bronze_events (*\
*event string,*\
*v int,*\
*occurred_at timestamp,*\
*received_at timestamp,*\
*user_id string,*\
*anon_id string,*\
*session_id string,*\
*city string,*\
*device struct\<ua_hash:string, os:string, app_ver:string\>,*\
*context struct\<role:string, env:string\>,*\
*ids map\<string,string\>,*\
*money struct\<amount_cents:int, currency:string\>,*\
*payload string \-- keep raw JSON; parse in Silver*\
*)*\
*PARTITIONED BY (dt string, hour string, env string, event_name
string)*\
*ROW FORMAT SERDE \'org.openx.data.jsonserde.JsonSerDe\'*\
*LOCATION \'s3://data/bronze/events/\'*\
*TBLPROPERTIES (\'projection.enabled\'=\'true\');*\

**Note:** Use **partition projection** to avoid expensive *MSCK REPAIR*.
For Firehose prefixes, set *event_name* from *event* value.

### **E.1 Near‑Real‑Time (NRT) Ops Views**

- Use **Athena CTAS** every 5--10 min to create small **Parquet**
  materializations for Admin dashboards.

**Example: payout backlog by city (last 24h)**

*CREATE TABLE IF NOT EXISTS ops_payout_backlog*\
*WITH (*\
*format=\'PARQUET\',*\
*parquet_compression=\'SNAPPY\',*\
*partitioned_by=array\[\'dt\'\]*\
*) AS*\
*SELECT*\
*date_format(received_at, \'%Y-%m-%d\') AS dt,*\
*coalesce(b.payload_json.city, \'unknown\') AS city,*\
*count_if(b.event=\'payout.queued\') AS queued,*\
*count_if(b.event=\'payout.paid\') AS paid,*\
*count_if(b.event=\'payout.failed\') AS failed,*\
*(count_if(b.event=\'payout.queued\') -
count_if(b.event=\'payout.paid\')) AS backlog*\
*FROM (*\
*SELECT*\
*event,*\
*received_at,*\
*json_parse(payload) AS payload_json*\
*FROM bronze_events*\
*WHERE dt \>= date_format(date_add(\'day\', -1, current_date),
\'%Y-%m-%d\')*\
*AND env=\'prod\'*\
*) b*\
*GROUP BY 1,2;*\

Schedule via **Athena Scheduler** or a small **Step Functions** state
machine.

## **1.13.D (expanded) --- Silver/Gold Modeling**

### **D.1 CTAS: Silver facts (examples)**

- Search impressions (Silver)

*CREATE TABLE IF NOT EXISTS silver.fact_search_impressions*\
*WITH (format=\'PARQUET\', parquet_compression=\'SNAPPY\',
partitioned_by=array\[\'dt\'\]) AS*\
*SELECT*\
*date_format(received_at, \'%Y-%m-%d\') AS dt,*\
*received_at,*\
*coalesce(user_id, anon_id) AS actor_key,*\
*(payload_json -\>\> \'query_hash\') AS query_hash,*\
*(payload_json -\>\> \'result_pos\')::int

### TD-0072 (tech)

<!-- id: TD-0072 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 259200-263200 -->

Search impressions (Silver)

*CREATE TABLE IF NOT EXISTS silver.fact_search_impressions*\
*WITH (format=\'PARQUET\', parquet_compression=\'SNAPPY\',
partitioned_by=array\[\'dt\'\]) AS*\
*SELECT*\
*date_format(received_at, \'%Y-%m-%d\') AS dt,*\
*received_at,*\
*coalesce(user_id, anon_id) AS actor_key,*\
*(payload_json -\>\> \'query_hash\') AS query_hash,*\
*(payload_json -\>\> \'result_pos\')::int AS result_pos,*\
*(payload_json -\>\> \'target_type\') AS target_type,*\
*(payload_json -\>\> \'target_id\') AS target_id,*\
*city,*\
*context.role AS role,*\
*ids\[\'impression_id\'\] AS impression_id*\
*FROM (*\
*SELECT event, received_at, user_id, anon_id, city, context, ids,*\
*json_parse(payload) AS payload_json*\
*FROM bronze_events*\
*WHERE event=\'search.card_impression\' AND env=\'prod\'*\
*) b;*\

- **Booking legs snapshot stream (Silver)**\
  (built from *leg.\** status events + finance webhooks)

*CREATE TABLE IF NOT EXISTS silver.fact_booking_legs*\
*WITH (format=\'PARQUET\', parquet_compression=\'SNAPPY\',
partitioned_by=array\[\'dt\'\]) AS*\
*SELECT*\
*date_format(received_at, \'%Y-%m-%d\') AS dt,*\
*ids\[\'leg_id\'\] AS leg_id,*\
*max_by(payload_json, received_at) AS latest_payload, \-- snapshot
reducer*\
*max(received_at) AS last_event_at*\
*FROM (*\
*SELECT event, received_at, ids, json_parse(payload) AS payload_json*\
*FROM bronze_events*\
*WHERE event LIKE \'leg.%\' AND env=\'prod\'*\
*) s*\
*GROUP BY 1, 2;*\

For full fidelity, prefer **dbt** incremental models on Athena to
express joins across *leg.\**, *refund.\**, *payout.\**.

### **D.2 dbt project skeleton (Athena adapter)**

*/data/dbt_project.yml*

*name: rastup_analytics*\
*version: 1.0.0*\
*profile: rastup_athena*\
*model-paths: \[\"models\"\]*\
*tests-paths: \[\"tests\"\]*\
*vars:*\
*env: prod*\

*/data/models/silver/fact_promotions_events.sql*

*{{ config(materialized=\'incremental\', unique_key=\'event_id\',
partition_by={\'field\': \'dt\'}) }}*\
\
*with base as (*\
*select*\
*md5(concat(event, cast(received_at as varchar),
coalesce(ids\[\'impression_id\'\], \'\'),
coalesce(ids\[\'campaign_id\'\], \'\'))) as event_id,*\
*date_format(received_at, \'%Y-%m-%d\') as dt,*\
*event,*\
*received_at,*\
*ids\[\'impression_id\'\] as impression_id,*\
*ids\[\'campaign_id\'\] as campaign_id,*\
*city,*\
*context.role as role,*\
*json_extract_scalar(payload, \'\$.invalid_reason\') as invalid_reason*\
*from {{ ref(\'bronze_events\') }}*\
*where env=\'{{ var(\"env\") }}\'*\
*and event in
(\'promo.impression\',\'promo.click\',\'promo.invalid_click\')*\
*{% if is_incremental() %}*\
*and received_at \> (select coalesce(max(received_at), timestamp
\'1970-01-01\') from {{ this }})*\
*{% endif %}*\
*)*\
*select \* from base;*\

*/data/models/gold/kpi_promo_ctr.sql*

*{{ config(materialized=\'table\', partition_by={\'field\':\'dt\'}) }}*\
*select*\
*dt,*\
*campaign_id,*\
*count_if(event=\'promo.impression\') as impressions,*\
*count_if(event=\'promo.click\') as clicks,*\
*(count_if(event=\'promo.click\') /
nullif(count_if(event=\'promo.impression\'),0)) as ctr*\
*from {{ ref(\'fact_promotions_events\') }}*\
*group by 1,2;*\

*/data/models/schema.yml* (tests)

*version: 2*\
*models:*\
* - name: fact_promotions_events*\
*columns:*\
* - name: event_id*\
*tests: \[not_null, unique\]*\
* - name: kpi_promo_ctr*\
*columns:*\
* - name: dt*\
*tests: \[not_null\]*\

## **1.13.G (expanded) --- Data Quality, Validation & Lineage**

### **G.1 Great Expectations suite (examples)**

*/data/quality/expectations/fact_booking_legs.yml*

*expectations:*\
* - expect_table_columns_to_match_ordered_list:*\
*column_list: \[dt, leg_id, latest_payload, last_event_at\]*\
* - expect_column_values_to_not_be_null:*\
*column: leg_id*\
* - expect_column_values_to_be_between:*\
*column: latest_payload.total_cents*\
*min_value: 0*\
* - expect_compound_columns_to_be_unique:*\
*column_list: \[dt, leg_id\]*\

*/data/quality/expectations/fact_promotions_events.yml*

*expectations:*\
* - expect_column_values_to_b

### TD-0073 (tech)

<!-- id: TD-0073 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 262800-266800 -->

\
*column_list: \[dt, leg_id, latest_payload, last_event_at\]*\
* - expect_column_values_to_not_be_null:*\
*column: leg_id*\
* - expect_column_values_to_be_between:*\
*column: latest_payload.total_cents*\
*min_value: 0*\
* - expect_compound_columns_to_be_unique:*\
*column_list: \[dt, leg_id\]*\

*/data/quality/expectations/fact_promotions_events.yml*

*expectations:*\
* - expect_column_values_to_be_in_set:*\
*column: event*\
*value_set:
\[\"promo.impression\",\"promo.click\",\"promo.invalid_click\"\]*\
* - expect_column_values_to_match_regex:*\
*column: campaign_id*\
*regex: \"\^pcmp\_.\*\"*\

Run suites as part of the CTAS/dbt job tail step; failures → SNS alert +
Slack (Ops).

### **G.2 Lineage**

- Maintain a lightweight **schema registry** (static site)
  auto‑generated from JSON Schemas + dbt docs.
- For every Gold mart, include *meta* fields citing upstream Silver
  models. dbt renders lineage graph---check into */docs/*.

## **1.13.H (expanded) --- Privacy, Governance & Retention**

### **H.1 Lake Formation & permissions**

- **Data lake locations**:

  - *s3://data/bronze* (read: data‑eng only; analysts excluded).
  - *s3://data/silver* (read: data‑eng + analysts; **private PII**
    columns masked via LF tags).
  - *s3://data/gold* (read: broad analyst/viewers).

- **LF tags**: *pii:yes/no*, *env:dev\|stage\|prod*. Attach to columns
  (e.g., *email_sha256* is *pii:yes*). Grant principals row‑level +
  column‑level access via tags.

### **H.2 DSAR (Right to Erasure) workflow**

1378. **User request** creates *dsar.requested* admin ticket and writes
      a **tombstone event**:\
      *{ event: \"dsar.tombstone\", v:1, user_id:\"usr\_\...\",
      occurred_at:... }*.

1379. **Operational stores** (Aurora/Dynamo/S3 app buckets) execute
      deletion/redaction per policy (already covered in §§1.4--1.12).

1380. Analytics purge:

      j.  **Silver/Gold**: nightly job reads tombstones and
          deletes/overwrites partitions where *user_id=usr\_...* or
          *actor_key* links; regenerate affected aggregates.
      k.  **Bronze**: keep immutable; **exclude on read** by maintaining
          *dsar_exclusions* table joined in views (regulatory‑approved
          strategy).

1381. **Verification**: generate a DSAR purge report with table counts
      before/after; store PDF in legal hold S3.

**Legal hold**: blocked DSARs write *dsar.hold* and the purge job skips
those users until hold clears.

### **H.3 Retention**

- **Bronze**: 18 months rolling delete by *dt* partition (S3 lifecycle).
- **Silver**: 24--36 months depending on table; keep finance facts 7
  years if required (PII masked).
- **Gold**: 24 months rolling.

## **1.13.F (expanded) --- Experimentation Framework**

### **F.1 Assignment & exposure**

- **Assignment function** (deterministic):

*bucket = (fnv1a(hash_key = user_id \|\| anon_id \|\| \"EXP_KEY\") %
100)*\

- Store assignment in **AppConfig** or a small Dynamo table
  *exp_assignment* (for overrides).
- Log *exp.exposed* **once** per experiment per user at first exposure
  checkpoint.

***exp.exposed.v1*** **schema**

*{*\
*\"required\": \[\"exp_key\",\"variant\",\"checkpoint\"\],*\
*\"properties\": {*\
*\"exp_key\": {\"type\":\"string\"},*\
*\"variant\": {\"type\":\"string\"},*\
*\"checkpoint\":
{\"type\":\"string\",\"enum\":\[\"search\",\"profile\",\"checkout\",\"postbook\"\]}*\
*}*\
*}*\

### **F.2 Guardrails & metrics**

- Guardrails computed **daily**:

  - Refund rate Δ vs control ≤ 0.2 pp
  - Complaint rate ≤ 0.1%
  - API p95 latency ≤ 2 s

- Metrics prepared in **Gold** as per‑variant aggregates with CUPED
  pre‑period covariates (e.g., prior 28‑day spend or visits).

**Example (Gold) CUPED prep**

*CREATE TABLE gold.exp_metric_checkout_cuped AS*\
*SELECT*\
*e.exp_key, e.variant, e.user_id,*\
*count_if(m.event=\'checkout.start\') AS y_observed,*\
*\-- theta estimate computed offline or via regression; simplified
here*\
*avg(pre.y_baseline) as theta,*\
*(count_if(m.event=\'checkout.start\')

### TD-0074 (tech)

<!-- id: TD-0074 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 266400-270400 -->

ith CUPED
  pre‑period covariates (e.g., prior 28‑day spend or visits).

**Example (Gold) CUPED prep**

*CREATE TABLE gold.exp_metric_checkout_cuped AS*\
*SELECT*\
*e.exp_key, e.variant, e.user_id,*\
*count_if(m.event=\'checkout.start\') AS y_observed,*\
*\-- theta estimate computed offline or via regression; simplified
here*\
*avg(pre.y_baseline) as theta,*\
*(count_if(m.event=\'checkout.start\') - avg(pre.y_baseline)) as
y_cuped*\
*FROM dim_exposure e*\
*LEFT JOIN fact_events m ON e.user_id = m.user_id*\
*LEFT JOIN preperiod_agg pre ON e.user_id = pre.user_id*\
*WHERE e.exp_key=\'EXP_SEARCH_UI_A\'*\
*GROUP BY 1,2,3;*\

## **1.13.I (expanded) --- BI Datasets & Dashboards**

### **I.1 Datasets (QuickSight SPICE)**

- ***ds_kpi_marketplace*** (from *gold.kpi\_\**): GMV, bookings, take
  rate, conversion funnel.
- ***ds_ops_health***: payout backlog, recon variance, dispute queue,
  acceptance windows.
- ***ds_trust***: IDV/BG funnels, risk buckets, dispute outcomes.
- ***ds_promotions***: impressions, clicks, CTR, invalid rate, spend vs
  budget.
- ***ds_comms***: delivery, bounces, complaints, opt‑outs, digest
  suppression.
- ***ds_studios***: verification rate, amenity usage, quote success.

**Row‑level security**: if city‑restricted analyst roles exist, attach a
mapping table *analyst_city_scope* and enforce RLS in QuickSight
datasets.

### **I.2 Dashboard tiles (definitions)**

- **Executive**:

  - *GMV & Bookings*: *sum(gold.kpi_gmv_daily.gmv_cents)/100* with 7‑day
    trend.
  - *Take Rate*: *sum(platform_fees)/sum(gmv)*.
  - *Conversion Funnel*: stages from impressions→clicks→profile
    views→checkout→confirm.

- **Operations**:

  - *Recon variance*: *abs(charges - (payouts + refunds + fees))* with
    gate alarms.
  - *Payout backlog*: from NRT view *ops_payout_backlog*.

- **Trust**:

  - *IDV pass rate*: *idv.passed / (idv.passed + idv.failed)*.
  - *Risk buckets*: distribution over Watch/Action/Critical.

...(the rest are similar; all pull from Gold/NRT views above)

## **1.13.J (expanded) --- Cost Posture & Performance**

- **Firehose**: small buffers to limit latency; GZIP + dynamic
  partitioning; DLQ for failed records.

- **Athena**:

  - Enforce **workgroup** with **encryption on**, **query bytes cap**,
    and **results location** per env.
  - Use **CTAS** with *bucketed_by* only if needed (careful with cost).
  - Partition filters **always applied** (*WHERE dt BETWEEN ...*); add
    **city partition** to high‑volume facts (search, promotions) when
    warranted.

- **Glue**: schedule transforms during off‑peak; use minimal DPUs (e.g.,
  2--3) and **Athena CTAS** for many transforms to avoid Glue cost.

- **QuickSight**: prefer SPICE; schedule no more than 4--6 daily
  refreshes; monitor SPICE capacity and prune unused visuals.

**Budget alarms (per env):** S3 storage, Athena scanned bytes, Glue
DPU‑hours, QuickSight capacity, Firehose PUTs.

## **1.13.K (expanded) --- Admin & Runbooks**

- **Schema registry site** generated from */schemas/\*\*.json* + dbt
  docs; published to internal Amplify Hosting.

- **Backfill runner**: Step Functions flow

  - pick date range
  - CTAS Bronze→Silver for those partitions
  - rebuild impacted Gold models
  - verify Great Expectations → if fail, auto‑rollback.

- **Incident runbooks**:

  - *Pipeline lag*: pause heavy CTAS, widen Firehose buffers, notify
    Ops, degrade BI refresh to daily only.
  - *High Athena spend*: identify runaway queries in workgroup metrics;
    kill/limit; pin dashboards to SPICE only.
  - *Schema break*: move invalid events to *\_bad* quarantine; hotfix
    schema or add adapter transform.

## **1.13.L/M/N/O (expanded) --- Error Taxonomy, SLOs, Tests, Work Packages**

### **L. Error codes (operational)**

- *EVENT_SCHEMA_INVALID*, *EVENT_ENVELOPE_INVALID*, *EVENT_PUT_FAILED*,
- *PIPELINE_LAG_EXCEEDED*, *CTAS_FAILURE*, *QUALITY_CHECK_FAILED*,
- *ATHENA_SCANNED_BYTES_BREACH*, *BI_REFRESH_FAILED*, *DSAR_CONFLICT*.

Each emits a **CloudWatch metr

### TD-0075 (tech)

<!-- id: TD-0075 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 270000-274000 -->

fix
    schema or add adapter transform.

## **1.13.L/M/N/O (expanded) --- Error Taxonomy, SLOs, Tests, Work Packages**

### **L. Error codes (operational)**

- *EVENT_SCHEMA_INVALID*, *EVENT_ENVELOPE_INVALID*, *EVENT_PUT_FAILED*,
- *PIPELINE_LAG_EXCEEDED*, *CTAS_FAILURE*, *QUALITY_CHECK_FAILED*,
- *ATHENA_SCANNED_BYTES_BREACH*, *BI_REFRESH_FAILED*, *DSAR_CONFLICT*.

Each emits a **CloudWatch metric** with labels (*env*, *component*,
*severity*) and raises an alarm with runbook link.

### **M. SLOs & Alerts (detail)**

- **Ingestion p95** ≤ 60 s; Alarm at 120 s for 10 min.
- **NRT views** ≤ 10 min; Alarm at 20 min.
- **Daily marts** done by 06:00 local; Alarm at 07:00.
- **Athena scanned bytes**: \< 500 GB/day (stage), \< 2 TB/day (prod) to
  start; alarms at 80%.
- **BI refresh** success ≥ 99%; alarm on 2 consecutive failures.

### **N. Test matrix (concrete add‑ons)**

- **Contract tests**: CI job enumerates all */schemas/\*.json* and
  validates synthetic fixtures; fails PR on mismatch.
- **Drill tests**: load a synthetic day, produce Silver/Gold, assert
  KPIs match golden JSON.
- **Lag tests**: inject 10k events/min for 15 min; verify NRT views
  within 10 min.
- **DSAR tests**: create user, produce events, issue tombstone, verify
  exclusion in Silver/Gold, verify Bronze exclusion view.
- **Cost tests**: run representative dashboard queries; ensure scanned
  bytes under thresholds.

### **O. Work packages (ready to assign to your 4 Cursor agents)**

- Agent C --- Ingestion & Schemas

  - WP‑DATA‑ING‑01: EventBridge bus + Firehose + transform Lambda
    (dynamic partitions).
  - WP‑DATA‑ING‑02: Envelope & event JSON Schemas + ajv validator
    Lambda.
  - WP‑DATA‑ING‑03: Provider webhook normalizers → EventBridge.

- Agent B --- Modeling & Quality

  - WP‑DATA‑MOD‑01: Bronze table, CTAS for *fact_search_impressions*,
    *fact_promotions_events*, *fact_booking_legs*.
  - WP‑DATA‑QTY‑01: Great Expectations suites + alerts; dbt tests.

- Agent A --- BI & Experiments

  - WP‑DATA‑BI‑01: QuickSight datasets & dashboards
    (Executive/Operations/Growth/Trust).
  - WP‑EXP‑01: Assignment function, *dim_exposure*, guardrails metrics,
    CUPED pipeline.

- Agent D --- Governance & Ops

  - WP‑DATA‑GOV‑01: Lake Formation permissions & LF tags; DSAR tombstone
    job.
  - WP‑DATA‑OPS‑01: NRT CTAS jobs + payout backlog view; backfill
    runner; cost monitors.

## **1.13.P (re‑stated) --- Final Acceptance Checklist for §1.13**

1423. **Ingestion** to Bronze S3 via EventBridge→Firehose with dynamic
      partitions; schema validation live; p95 lag ≤ 60 s.
1424. **Silver** facts and **Gold** marts materialize with dbt/CTAS;
      tests pass; NRT ops views update ≤ 10 min.
1425. **Experimentation** runs (assignment, exposure, metrics with
      guardrails and CUPED).
1426. **Privacy & governance**: no PII in events; LF column/row
      permissions; DSAR tombstone flow proven; legal holds respected.
1427. **BI**: QuickSight dashboards up, SPICE refreshed; RLS applied
      where required.
1428. **Cost & SLOs**: scanned bytes, DPU‑hours, SPICE capacity within
      budgets; alarms & runbooks configured.
1429. **Runbooks**: backfills, schema breaks, lag, high spend all
      documented and tested.

# **§1.14 --- Fan‑Sub (Paid Content, Requests, Tips & PPV)**

*(roles & gating · subscriptions · paid requests & deliverables · tips &
PPV · media pipeline (previews vs finals, watermarking) · safety &
age‑gates · payments, taxes & receipts · moderation & DMCA · dashboards
· admin · telemetry · tests · cost)*

**Purpose.** Implement a **Fan‑Sub** system that lets fans support
creators (talent) via **subscriptions**, **paid custom requests**,
**tips**, and **pay‑per‑view (PPV)** content---while enforcing **18+
verification**, safe‑mode rules, privacy, and cost efficiency. Fan‑Sub
integrates with messaging (§1.4), docs/e‑sign where required (§1.5),
trust gates (§1.6), payments & statements (§1.9), comms (§1.10), studios
(§1.11 when relevant), an

### TD-0076 (tech)

<!-- id: TD-0076 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 273600-277600 -->

em that lets fans support
creators (talent) via **subscriptions**, **paid custom requests**,
**tips**, and **pay‑per‑view (PPV)** content---while enforcing **18+
verification**, safe‑mode rules, privacy, and cost efficiency. Fan‑Sub
integrates with messaging (§1.4), docs/e‑sign where required (§1.5),
trust gates (§1.6), payments & statements (§1.9), comms (§1.10), studios
(§1.11 when relevant), and analytics (§1.13).

We won't advance until §1.14 meets your 99.9% bar.

## **1.14.A Canon & invariants**

1430. **Age gate & IDV required:** Creators **and** paying fans must be
      18+ (verified via §1.6). Creators need **ID Verified** to publish
      Fan‑Sub.
1431. **Safe‑Mode everywhere:** Public thumbnails are SFW; NSFW bands
      apply to previews and in‑thread uploads.
1432. **Previews vs finals:** Only **previews** (small images/clips) are
      stored in our S3. **Final media** is external (Drive/Dropbox/S3
      owner) and referenced via **immutable manifests** (checksums),
      like deliverables in §1.4/§1.3.
1433. **No filter bypass:** Fan‑Sub surfaces honor city gates, age
      gates, Safe‑Mode, and user preferences.
1434. **Money clarity:** Separate **Marketplace GMV** (requests/PPV) and
      **Subscription revenue** streams; platform fees & **taxes on
      fees** follow §1.9.
1435. **Privacy:** No PII in media watermarks; no emails/phones
      exchanged off‑platform (anticircumvention).
1436. **Auditability:** All paid actions produce immutable records
      (orders, receipts, approvals), with lineage to users and threads.

## **1.14.B Feature set (MVP + flags)**

- **Subscriptions** (monthly; optional annual flag later).
- **Paid custom requests** (one‑off commissions) with **action cards**
  in threads (quote → pay → deliverable → approve/revise).
- **Tips** (one‑click).
- **PPV posts** (locked content purchasable without subscribing).
- **Bundles/discounts** (flag‑gated for later).
- **Free trials** (flag‑gated; risk‑aware).
- **Geo/role gates**: creators may limit visibility by city/country if
  policy demands.

## **1.14.C Data model (Aurora + Dynamo + S3)**

### **C.1 Aurora (source of truth)**

*\-- Creator Fan-Sub profile*\
*create table fansub_creator (*\
*creator_id text primary key, \-- fsc\_\...*\
*user_id text not null unique, \-- usr\_\...*\
*handle text not null unique, \-- vanity*\
*display_name text not null,*\
*city_gate text\[\], \-- allowed cities (null = global)*\
*bio text,*\
*price_month_cents int not null, \-- subscription price*\
*currency text not null default \'USD\',*\
*is_published boolean not null default false,*\
*idv_required_ok boolean not null default false, \-- from §1.6*\
*nsfw_ok boolean not null default true, \-- creator allows NSFW (still
SFW preview rules)*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now()*\
*);*\
\
*\-- Subscription & entitlement*\
*create table fansub_subscription (*\
*sub_id text primary key, \-- fss\_\...*\
*creator_id text not null references fansub_creator(creator_id),*\
*fan_user_id text not null, \-- usr\_\...*\
*provider text not null, \-- \'stripe\'*\
*provider_ref text not null, \-- subscription id*\
*status text not null check (status in
(\'active\',\'past_due\',\'paused\',\'canceled\',\'trialing\')),*\
*current_period_end timestamptz not null,*\
*renews boolean not null default true,*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now(),*\
*unique (creator_id, fan_user_id)*\
*);*\
\
*\-- Tips & PPV & Requests share a common \"order\" header*\
*create table fansub_order (*\
*order_id text primary key, \-- fso\_\...*\
*kind text not null check (kind in (\'tip\',\'ppv\',\'request\')),*\
*creator_id text not null,*\
*buyer_user_id text not null,*\
*amount_cents int not null,*\
*fee_cents int not null default 0, \-- platform fee (see §1.9)*\
*fee_tax_cents int not null default 0,*\
*currency text not null default \'USD\',*\
*status text not null check (st

### TD-0077 (tech)

<!-- id: TD-0077 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 277200-281200 -->

ansub_order (*\
*order_id text primary key, \-- fso\_\...*\
*kind text not null check (kind in (\'tip\',\'ppv\',\'request\')),*\
*creator_id text not null,*\
*buyer_user_id text not null,*\
*amount_cents int not null,*\
*fee_cents int not null default 0, \-- platform fee (see §1.9)*\
*fee_tax_cents int not null default 0,*\
*currency text not null default \'USD\',*\
*status text not null check (status in
(\'pending\',\'succeeded\',\'refunded\',\'failed\',\'disputed\')),*\
*provider text not null, \-- \'stripe\'*\
*provider_charge text, \-- charge/payment intent id*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now()*\
*);*\
\
*\-- PPV posts (locked content)*\
*create table fansub_ppv_post (*\
*ppv_id text primary key, \-- fpp\_\...*\
*creator_id text not null references fansub_creator(creator_id),*\
*title text not null,*\
*caption text,*\
*price_cents int not null,*\
*preview_media jsonb not null default \'\[\]\'::jsonb, \-- S3 previews
(scanned)*\
*final_manifest_id text, \-- external manifest id (immutable)*\
*nsfw_band int not null default 0,*\
*is_published boolean not null default false,*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now()*\
*);*\
\
*\-- Entitlement when PPV is purchased*\
*create table fansub_ppv_access (*\
*access_id text primary key, \-- fpa\_\...*\
*ppv_id text not null references fansub_ppv_post(ppv_id),*\
*buyer_user_id text not null,*\
*order_id text not null references fansub_order(order_id),*\
*created_at timestamptz not null default now(),*\
*unique (ppv_id, buyer_user_id)*\
*);*\
\
*\-- Custom request lifecycle (threads carry action cards; this table is
the money/evidence)*\
*create table fansub_request (*\
*request_id text primary key, \-- fsr\_\...*\
*thread_id text not null, \-- link to §1.4 thread*\
*creator_id text not null,*\
*buyer_user_id text not null,*\
*title text not null,*\
*brief text not null,*\
*quoted_cents int not null,*\
*status text not null check (status in
(\'quoted\',\'accepted\',\'paid\',\'delivered\',\'approved\',\'revision_requested\',\'refunded\',\'disputed\',\'closed\')),*\
*order_id text, \-- fansub_order once paid*\
*proof_manifest_id text, \-- proofs (external)*\
*final_manifest_id text, \-- finals (external)*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now()*\
*);*\

### **C.2 DynamoDB (hot path caches)**

- *fansub_entitlement_cache*: *PK=USER#usr\_...*,
  *SK=CREATOR#fsc\_...\|PPV#fpp\_...* → boolean + expiry (for fast
  gating checks).
- *fansub_rate_limits*: tip/PPV write guardrails per IP/user (abuse
  mitigation).

### **C.3 S3 buckets (previews only)**

- *fansub-previews* (public via CF; all scanned; Safe‑Mode respected).
- *fansub-quarantine* (flagged previews awaiting T&S).
- Final media **not** stored internally---referenced via manifests, as
  in §1.4.

## **1.14.D Payment flows (Stripe) & taxes**

- **Subscriptions:** Stripe Billing **subscriptions** (monthly).

  - Create product per creator with *price_month_cents*; or use one
    product with **price per creator** (more scalable).
  - Webhooks: *invoice.payment_succeeded/failed*,
    *customer.subscription.updated\|deleted*.
  - We record *fansub_subscription* and entitlement (active period).

- **Tips:** one‑time **PaymentIntent** with **Connect destination** to
  the creator account (less platform float). Platform fee (if any)
  handled as application fee on Connect.

- **PPV:** one‑time **PaymentIntent**; after success, create
  *fansub_ppv_access* row to grant entitlement.

- Requests:

  - Creator issues **quote** (action card in thread).
  - Buyer pays **PaymentIntent**; on success, order → *succeeded*;
    request status *paid*.
  - Deliverable posted via action card; buyer **approves** or **requests
    revisions**.
  - Refunds follow §1.3 policy; disputes → §1.9 D.5.

- Taxes:

  - **Subscription/PPV/Requests** are **digital services**; compute
    *

### TD-0078 (tech)

<!-- id: TD-0078 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 280800-284800 -->

titlement.

- Requests:

  - Creator issues **quote** (action card in thread).
  - Buyer pays **PaymentIntent**; on success, order → *succeeded*;
    request status *paid*.
  - Deliverable posted via action card; buyer **approves** or **requests
    revisions**.
  - Refunds follow §1.3 policy; disputes → §1.9 D.5.

- Taxes:

  - **Subscription/PPV/Requests** are **digital services**; compute
    **buyer tax** via tax adapter (Stripe Tax/Avalara/TaxJar) using
    buyer location.
  - We separately compute **platform fee taxes** per §1.9 for any fee we
    charge.
  - Receipts show line items: content price, tax, platform fee (if
    present), platform fee tax.

- **Payouts:** per creator via Stripe Connect scheduled payouts; we
  record *payout.queued\|paid* events into analytics (see §1.13).

## **1.14.E Watermarking, access, and anti‑scrape**

- Previews:

  - Images: server watermark (creator handle + order id) diagonally; max
    1600 px; JPEG/WebP.
  - Video snippets: 10--20 s HLS preview; burned watermark.
  - NSFW banding: if *nsfw_band=1*, blur until hovered & age‑gate OK;
    *=2* blocked on public.

- Finals (external manifests):

  - Manifest includes per‑file SHA‑256, filename, size, URL, optional
    watermark seed.
  - If using cloud providers that support transforms (e.g., Cloudflare
    R2/Stream), creators can host DRM; we just store references and
    checksums.

- Access control:

  - Entitlement check before revealing **final manifest URLs** (fetched
    on demand and short‑lived).
  - Per‑request signed redirects; **tokenized** fragment in querystring
    that expires.

- Rate limits & anti‑abuse:

  - Per‑user/view throttles; hotlink protection via CF **signed
    cookies** if we proxy some assets.
  - Download logs linked to user id for evidence in disputes.

## **1.14.F Messaging integrations (action cards)**

- **Request Quote** → **Pay** → **Deliver** → **Approve/Revise** loops
  occur in the **thread** using **action cards** defined in §1.4.E
  (reused with *ACTION_TYPE = FS_REQUEST\_\**).
- **Tip receipt** and **PPV unlocked** post system messages into the
  thread (optional; user‑toggle).
- **Nudges** (comms §1.10) for unsigned docs if the creator uses any
  release forms (off by default for Fan‑Sub).

## **1.14.G Safety, policy, and moderation**

- **IDV**: creators and fans must be 18+ verified before accessing
  Fan‑Sub surfaces.

- **Content rules**:

  - Prohibit illegal content, doxxing, hate, non‑consensual content.
  - For public previews, **SFW only**; NSFW allowed in finals if
    compliant and user's Safe‑Mode is OFF.

- **Moderation pipeline**: previews are scanned (image/video); text
  captions pass toxicity/PII checks; repeat violations trigger T&S
  review and potential suspension.

- **Anticircumvention**: block emails/phones in captions and messages;
  nudges and soft blocks escalate on repeat.

- **Reporting**: fans can report content; T&S console handles takedowns
  and refunds.

- **DMCA**:

  - Inbound claims queue → temporarily hide content; notify creator;
    counter‑notice process handled via Admin console.
  - Evidence stored (timestamps, hashes from manifest).
  - We do not provide legal advice; the tooling facilitates compliance.

## **1.14.H UX surfaces**

- **Creator page**: hero, SFW gallery, subscription CTA, PPV catalog
  with locked overlays, request button.
- **Subscribed feed**: latest posts from creators a fan follows; PPV
  unlock badges.
- **Thread**: request flows, proofs/finals approval, receipts.
- **Wallet/Receipts**: Fan can view purchases, invoices, tax lines.
- **Creator dashboard**: earnings, subscriber counts/churn, top PPV,
  request backlog.

## **1.14.I GraphQL API (AppSync) --- selected**

*type FansubCreator {*\
*creatorId: ID!, handle: String!, displayName: String!,*\
*priceMonthCents: Int!, currency: String!, isPublished: Boolean!,*\
*nsfwOk: Boolean!, idvRequiredOk: Boolean!*\
*}*\
\
*type SubscriptionStatus { status: String!, currentPeriodEnd:


### TD-0079 (tech)

<!-- id: TD-0079 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 284400-288400 -->

*Creator dashboard**: earnings, subscriber counts/churn, top PPV,
  request backlog.

## **1.14.I GraphQL API (AppSync) --- selected**

*type FansubCreator {*\
*creatorId: ID!, handle: String!, displayName: String!,*\
*priceMonthCents: Int!, currency: String!, isPublished: Boolean!,*\
*nsfwOk: Boolean!, idvRequiredOk: Boolean!*\
*}*\
\
*type SubscriptionStatus { status: String!, currentPeriodEnd:
AWSDateTime!, renews: Boolean! }*\
\
*type PPVPost {*\
*ppvId: ID!, title: String!, caption: String, priceCents: Int!,*\
*previewMedia: \[Attachment!\]!, nsfwBand: Int!, isPublished: Boolean!*\
*}*\
\
*type Query {*\
*fansubCreator(handle: String!): FansubCreator!*\
*fansubPPV(creatorHandle: String!, cursor: String, limit: Int=12):
PPVPage!*\
*mySubscription(creatorId: ID!): SubscriptionStatus*\
*myPPVAccess(ppvId: ID!): Boolean!*\
*}*\
\
*type Mutation {*\
*publishFansubCreator(input: FansubCreatorInput!): FansubCreator!*\
*subscribe(creatorId: ID!): SubscriptionStatus! \# kicks off Stripe
flow*\
*cancelSubscription(subId: ID!): Boolean!*\
\
*tip(creatorId: ID!, amountCents: Int!): Boolean!*\
*buyPPV(ppvId: ID!): Boolean!*\
\
*requestQuote(creatorId: ID!, title: String!, brief: String!,
priceCents: Int!): ID!*\
*acceptQuote(requestId: ID!): Boolean!*\
*deliverRequest(requestId: ID!, manifestRef: ID!, note: String):
Boolean!*\
*approveRequest(requestId: ID!): Boolean!*\
*requestRevision(requestId: ID!, note: String!): Boolean!*\
*}*\

**Server guards**

- All mutations check **IDV age gate** from §1.6.
- Entitlement gating for PPV & subscriber‑only posts.
- Rate limits on tips/requests to prevent abuse.
- Pricing floors/ceilings from AppConfig to avoid outliers.

## **1.14.J Notifications & comms (from §1.10)**

- **Event triggers**: subscription start/renew/fail, PPV unlocked,
  request quote/paid/delivered, tip received.
- **Channels**: email/push/in‑app; SMS only for critical payment issues
  (opt‑in).
- **Quiet hours** respected for non‑critical; digest for batch updates.
- **Templates**: *fansub_sub_started*, *fansub_invoice_failed*,
  *fansub_ppv_unlocked*, *fansub_request_quote*,
  *fansub_request_delivered*.

## **1.14.K Analytics & experiments (from §1.13)**

- Events: *fansub.subscribe.start\|success\|fail*, *fansub.tip*,
  *fansub.ppv.buy*,
  *fansub.request.quote\|paid\|delivered\|approved\|revision*,
  *fansub.preview.view*, *fansub.final.view*.
- Funnels: profile → subscribe; preview → PPV buy; request quote → paid
  → approved.
- Guardrails: refund rate, complaint rate, moderation flags.
- Experiments: pricing A/B, preview length, watermark density, digest
  timing.
- NRT ops: creator earnings today, MTD, subscriber churn, request
  backlog, invoice failures.

## **1.14.L Admin consoles**

- **Creator eligibility** (IDV status, strikes) and publish toggle.
- **Refund & dispute desk** for tips/PPV/requests (policy simulator).
- **DMCA queue** with evidence viewer and timers.
- **Content moderation** (previews text/media); escalation & suspension
  controls.
- **Finance**: statements for creators, payout schedule, reserve flags.

All actions audited (actor, reason, before/after), some require dual
approval.

## **1.14.M Performance & cost**

- **Storage**: previews only; lifecycle to Intelligent‑Tiering after 30
  days.
- **Bandwidth**: HLS previews limited (10--20 s); CloudFront caching;
  signed cookies for private previews when needed.
- **Compute**: watermarking/transcode via Lambda on demand; no always‑on
  media servers.
- **Stripe**: use **billing thresholds** & retries for subs; dunning
  emails via Stripe to reduce send costs.
- **Search**: PPV/creator discovery in Typesense with lean fields (no
  captions in index).

## **1.14.N Error taxonomy (client‑safe)**

- *FANSUB_IDV_REQUIRED* --- user not age‑verified.
- *FANSUB_CREATOR_NOT_PUBLISHED* --- creator page not live.
- *FANSUB_PRICE_OUT_OF_RANGE* --- violates pricing policy.
- *FANSUB_ENTITLEMENT_REQUIRED* --- trying to access locked content.
- *FANSUB_REQUEST

### TD-0080 (tech)

<!-- id: TD-0080 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 288000-292000 -->

costs.
- **Search**: PPV/creator discovery in Typesense with lean fields (no
  captions in index).

## **1.14.N Error taxonomy (client‑safe)**

- *FANSUB_IDV_REQUIRED* --- user not age‑verified.
- *FANSUB_CREATOR_NOT_PUBLISHED* --- creator page not live.
- *FANSUB_PRICE_OUT_OF_RANGE* --- violates pricing policy.
- *FANSUB_ENTITLEMENT_REQUIRED* --- trying to access locked content.
- *FANSUB_REQUEST_STATE_INVALID* --- bad action order.
- *FANSUB_MEDIA_BLOCKED* --- preview failed safety checks.
- *PAYMENT_FAILED* --- Stripe failure; include retriable hints.

Each error includes *code*, *message*, *hint*, *corrId*.

## **1.14.O Test plan (CI + sandbox)**

**Eligibility & gating**

1503. Creator cannot publish until IDV passed; fan cannot subscribe/buy
      PPV until age‑verified.

**Subscriptions**\
2) Subscribe success → entitlement; invoice failure → status *past_due*;
dunning recovers; cancel resumes access until period end.

**Tips/PPV**\
3) Tip flow success; duplicate/double‑submit idempotent.\
4) PPV buy grants access; re‑buy blocked.

**Requests**\
5) Quote → pay → deliver → approve; revision loop; refund path via
policy.\
6) Action cards in thread reflect state; receipts correct.

**Media**\
7) Previews scanned & watermarked; finals referenced via manifest;
access tokens expire; rate limits enforced.

**Moderation/DMCA**\
8) Flagged preview hidden; DMCA takedown hides content; counter‑notice
restores.

**Analytics**\
9) Events land in Bronze; Silver facts & Gold KPIs update; NRT views
show earnings/backlog.

**Performance/cost**\
10) p95 entitlement check ≤ 60 ms (cached); preview loads ≤ 200 ms from
CF; Stripe webhooks idempotent; storage/egress within budget alarms.

## **1.14.P Work packages (Cursor 4‑agent lanes)**

- **Agent C --- Domain/API**\
  WP‑FS‑01: SQL for *fansub\_\** tables; GraphQL resolvers; entitlement
  cache.\
  WP‑FS‑02: Action cards for requests; tie‑ins to §1.4 flows; receipts &
  lineage.
- **Agent B --- Payments/Taxes**\
  WP‑FS‑PAY‑01: Stripe Billing subs; PPV/tips PaymentIntents; Connect
  payouts; tax adapter lines.\
  WP‑FS‑PAY‑02: Webhooks normalization (*invoice.\**,
  *payment_intent.\**, *charge.\**) + idempotency.
- **Agent A --- Web**\
  WP‑FS‑WEB‑01: Creator page, PPV catalog, subscribe/tip/buy flows;
  thread UI for requests.\
  WP‑FS‑WEB‑02: Watermarked preview renderer; entitlement‑aware media
  components.
- **Agent D --- Safety/Admin/QA**\
  WP‑FS‑SAFE‑01: NSFW scan + watermarking pipeline; anticircumvention in
  captions.\
  WP‑FS‑ADM‑01: DMCA/moderation/finance consoles; audits.\
  WP‑FS‑QA‑01: Full test matrix automation; synthetic earnings reports.

## **1.14.Q Acceptance criteria (mark §1.14 FINAL only when ALL true)**

1508. Age‑gated eligibility enforced; creators with IDV can publish;
      fans 18+ can pay.
1509. Subscriptions, tips, PPV, and requests work end‑to‑end with
      receipts, taxes, and payouts.
1510. Media pipeline (previews vs finals) functions with watermarking,
      safety scans, and access tokens; no finals stored internally.
1511. Messaging action cards cover the entire request lifecycle;
      approvals & revisions audited.
1512. Moderation & DMCA tooling live; anticircumvention active;
      violations audited.
1513. Dashboards & NRT views show earnings/churn/backlog; experiments
      and guardrails instrumented.
1514. Cost posture holds (previews only, limited HLS, caching); p95
      performance targets met.

# **§1.14 --- Fan‑Sub (Paid Content, Requests, Tips & PPV) --- Expanded Spec**

This augments the earlier §1.14 with **implementation‑grade detail**:
exact Stripe object mappings, state machines, watermarking/preview
specs, entitlement tokens, manifest contracts, moderation & DMCA flows,
tax/fee math, GL entries, comms templates, errors, and runbooks.

## **1.14.1 Roles, gates, and global invariants (recap + expansions)**

- **Eligibility gates** (server‑enforced before any Fan‑Sub surface or
  API):

  - **Age**: both creator and fan must have

### TD-0081 (tech)

<!-- id: TD-0081 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 291600-295600 -->

exact Stripe object mappings, state machines, watermarking/preview
specs, entitlement tokens, manifest contracts, moderation & DMCA flows,
tax/fee math, GL entries, comms templates, errors, and runbooks.

## **1.14.1 Roles, gates, and global invariants (recap + expansions)**

- **Eligibility gates** (server‑enforced before any Fan‑Sub surface or
  API):

  - **Age**: both creator and fan must have *idv_status=passed* and
    *age_verified=true* (§1.6).
  - **Trust**: creator must be *ID Verified*; **Trusted Pro** badge is
    **not** required for Fan‑Sub (optional boost).
  - **Policy clean**: creator not suspended; no unresolved DMCA strike
    blocking publish.

- Safe‑Mode & visibility:

  - Public pages show **SFW previews only**; finals require explicit
    entitlement + Safe‑Mode OFF (for adult categories).
  - City/region gates respected if configured by creator or policy.

- **Media storage stance**: we **store only previews**; **finals** live
  off‑platform (creator‑controlled) and are referenced via **immutable
  manifests** (with file checksums).

- **Money separation**: Marketplace GMV for Fan‑Sub (subs, PPV,
  requests, tips) is separate from booking GMV. Platform fees are
  separate revenue per §1.9.

## **1.14.2 Data contracts (DB, cache, storage)**

### **1.14.2.1 SQL (additions & refinements)**

*\-- Creator storefront settings & policy*\
*alter table fansub_creator*\
*add column preview_policy jsonb not null default jsonb_build_object(*\
*\'image_max_px\', 1600, \'video_preview_sec\', 15, \'watermark\', true,
\'nsfw_on_public\', false*\
*),*\
*add column payout_schedule text not null default \'standard\', \--
\'standard\' \| \'weekly\' (Stripe Connect)*\
*add column tos_accepted_at timestamptz,*\
*add column dmca_contact_email text;*\
\
*\-- Subscription invoice snapshots (for statements & taxes)*\
*create table fansub_subscription_invoice (*\
*inv_id text primary key, \-- fsi\_\...*\
*sub_id text not null references fansub_subscription(sub_id),*\
*provider_invoice text not null, \-- Stripe invoice id*\
*period_start timestamptz not null,*\
*period_end timestamptz not null,*\
*amount_cents int not null, \-- subtotal (creator portion)*\
*tax_cents int not null,*\
*fee_cents int not null, \-- platform fee taken (if any)*\
*fee_tax_cents int not null,*\
*currency text not null default \'USD\',*\
*status text not null check (status in
(\'paid\',\'void\',\'uncollectible\')),*\
*created_at timestamptz not null default now()*\
*);*\
\
*\-- Creator payout ledger (join to Stripe balance txns)*\
*create table fansub_payout (*\
*payout_id text primary key, \-- fpo\_\...*\
*creator_id text not null,*\
*provider_transfer text not null, \-- Stripe transfer/payout id*\
*amount_cents int not null,*\
*status text not null check (status in
(\'queued\',\'paid\',\'failed\')),*\
*scheduled_for timestamptz,*\
*created_at timestamptz not null default now()*\
*);*\

### **1.14.2.2 DynamoDB (hot‑path caches)**

- ***fansub_entitlement_cache*** item shape:

*{*\
*\"pk\": \"USER#usr_123\",*\
*\"sk\": \"CREATOR#fsc_789\", // or \"PPV#fpp_456\"*\
*\"entitled\": true,*\
*\"exp\": 1734567890 // TTL (epoch seconds)*\
*}*\

- ***fansub_rate_limits***: keys like *TIP#usr_123#2025-11-06* with
  counters.

### **1.14.2.3 S3 keys & CF**

- s3://fansub-previews/{creator_id}/ppv\_{ppv_id}/img\_{n}.webp
- s3://fansub-previews/{creator_id}/req\_{request_id}/proof\_{n}.webp
- All served via **CloudFront** with *Cache-Control: public,
  max-age=86400* and **WAF** throttles.

## **1.14.3 Manifests for final media (off‑platform)**

**Rationale:** Preserve creator control, reduce our media costs/risks,
keep **immutable evidence** via hashes.

### **1.14.3.1 Manifest JSON (v1)**

*{*\
*\"manifest_version\": 1,*\
*\"creator_id\": \"fsc_123\",*\
*\"kind\": \"ppv\" \| \"request\",*\
*\"entity_id\": \"fpp_456\" \| \"fsr_789\",*\
*\"created_at\": \"2025-11-06T15:22:10Z\",*\
*\"files\": \[*\
*{*\
*\"file_id\": \"F001\",*\
*\"name\": \"set1_001.jpg\",*\
*\"sha25

### TD-0082 (tech)

<!-- id: TD-0082 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 295200-299200 -->

or control, reduce our media costs/risks,
keep **immutable evidence** via hashes.

### **1.14.3.1 Manifest JSON (v1)**

*{*\
*\"manifest_version\": 1,*\
*\"creator_id\": \"fsc_123\",*\
*\"kind\": \"ppv\" \| \"request\",*\
*\"entity_id\": \"fpp_456\" \| \"fsr_789\",*\
*\"created_at\": \"2025-11-06T15:22:10Z\",*\
*\"files\": \[*\
*{*\
*\"file_id\": \"F001\",*\
*\"name\": \"set1_001.jpg\",*\
*\"sha256\": \"b8f9\...e1\",*\
*\"bytes\": 2435612,*\
*\"mime\": \"image/jpeg\",*\
*\"url\":
\"*[*https://creator-bucket.s3.amazonaws.com/\.../set1_001.jpg*](https://creator-bucket.s3.amazonaws.com/.../set1_001.jpg)*\"*\
*},*\
*{*\
*\"file_id\": \"V001\",*\
*\"name\": \"teaser.mp4\",*\
*\"sha256\": \"a3c1\...9f\",*\
*\"bytes\": 43293434,*\
*\"mime\": \"video/mp4\",*\
*\"url\":
\"*[*https://dropbox.com/s/...?dl=1*](https://dropbox.com/s/…?dl=1)*\"*\
*}*\
*\],*\
*\"signature\": {*\
*\"algo\": \"ed25519\",*\
*\"public_key\": \"pk\_\...\",*\
*\"sig\": \"MEYCIQ...\"*\
*}*\
*}*\

- **Validation**: we only cache the manifest (and not the files). On
  access, we **HEAD** each URL to verify availability; for
  disputes/DMCA, we may pull copies into **evidence vault** with a legal
  hold (separate S3 WORM bucket).

### **1.14.3.2 Tokenized access (short‑lived)**

- Generate an **entitlement token** per viewer:

*token = base64url(HMAC(k, user_id \| entity_id \| exp_ts \| nonce))*\

- Present token in redirect query: *?e={exp_ts}&t={token}*. Token TTL \~
  5 minutes.
- For creators using their own CDNs, document how to **validate** this
  token at their edge (optional).

## **1.14.4 Watermarking & previews**

### **1.14.4.1 Image previews**

- **Pipeline**: S3 upload → Lambda trigger:

  - Validate MIME/size → Rekognition NSFW → ClamAV → **Resize** max
    dimension = *preview_policy.image_max_px* → **Watermark**.

- **Watermark spec**:

  - Content: *\@{handle} · {order_or_ppv_id} · {date YYYY‑MM‑DD}*
  - Position: diagonal; **tile** every \~400--600px; 40--55% opacity;
    font *Inter*/fallback; 14--18px \@1x.
  - Color: auto black/white depending on local luminance.

### **1.14.4.2 Video previews**

- **Transcode** to **HLS** with 1 or 2 bitrates (e.g., 540p, 720p);
  preview length *preview_policy.video_preview_sec* (default 15s).
- **Burned watermark** (same content); or overlay at player with WebVTT
  if creator demands reversible watermarking (less secure).
- **Segment key rotation** not required for previews (public), but CF
  signed URLs prevent hotlinking.

## **1.14.5 Stripe object mappings & flows**

### **1.14.5.1 Subscriptions (Stripe Billing + Connect)**

- Create **one Product** "Fan‑Sub Subscription" with **one Price per
  creator** (*price\_{creator_id}* monthly).

- **Connect mode**:

  - Use **Application Fees** (*application_fee_amount*) to collect
    platform fees on each invoice (if we charge one), and route the
    **net** to the creator's **Connect account** via
    **transfer_data\[destination\]**.
  - Alternatively, use **Direct charges** on the creator's account if we
    want creator seen as MoR for subs. MVP: **Platform is MoR** to
    centralize tax handling (safer for compliance).

- **Key webhook events**:

  - *invoice.payment_succeeded* → create *fansub_subscription_invoice*
    row; (entitlement period) = *current_period_end*.
  - *invoice.payment_failed* / *customer.subscription.updated* (status
    *past_due*) → dunning schedule (below).
  - *customer.subscription.deleted* → mark *status=\'canceled\'* and
    entitlement ends at period end (no retro refunds unless policy
    configured).

**Dunning schedule (MVP)**

- Stripe handles retries at 3‑day cadence up to 4 retries; we mirror
  state changes; optional in‑product reminder at 24h before
  cancellation.

### **1.14.5.2 PPV, Tips, Requests (PaymentIntents)**

- Create **PaymentIntent** with:

  - *amount = price + tax + (optional platform fee tax) +
    application_fee_amount* (if platform collects fee).
  - *transfer_data\[destination\]=creator_connect_account

### TD-0083 (tech)

<!-- id: TD-0083 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 298800-302800 -->

pe handles retries at 3‑day cadence up to 4 retries; we mirror
  state changes; optional in‑product reminder at 24h before
  cancellation.

### **1.14.5.2 PPV, Tips, Requests (PaymentIntents)**

- Create **PaymentIntent** with:

  - *amount = price + tax + (optional platform fee tax) +
    application_fee_amount* (if platform collects fee).
  - *transfer_data\[destination\]=creator_connect_account* if routing
    funds immediately; otherwise capture centrally then **Transfer**.

- On *payment_intent.succeeded*:

  - **PPV** → insert *fansub_ppv_access*.
  - **Tip** → just record *fansub_order.status=\'succeeded\'*.
  - **Request** → set *fansub_request.status=\'paid\'*, link *order_id*.

### **1.14.5.3 Refunds & disputes**

- Refunds initiated by support or creator (subject to policy):
  *refund.created* & *refund.succeeded* webhooks → update
  *fansub_order.status=\'refunded\'* and revoke entitlements (PPV).

- Chargebacks (*charge.dispute.created*):

  - Set order *status=\'disputed\'*; hide finals; keep previews up;
    workflow in Admin console (evidence: manifest hashes, comms
    history).
  - GL expense entry per §1.9.D.5.

## **1.14.6 Tax & fee math (digital goods)**

- **Buyer line items** (per order/invoice):

*subtotal_cents (creator's content)*\

- content_tax_cents (digital services tax; adapter calculates)
- platform_fee_cents (0 at MVP unless policy says otherwise)
- platform_fee_tax_cents\
  = total_cents (charged)

<!-- -->

- **Platform revenue**: **only** the **platform_fee_cents** (and
  recognized when **collected**) per §1.9; we are not MoR for creator
  content unless explicitly configured (default: platform MoR for
  *platform fee*, not for content price; content is pass‑through).
- **Jurisdictions**: use adapter flags to treat content as **digital
  service**; store tax summary per invoice/order for audit.

## **1.14.7 Accounting & GL (platform side)**

- **At capture** (order or invoice paid):

*Dr Cash:Stripe total_cents*\
*Cr Liability:CreatorPayable subtotal_cents + content_tax_cents (if
pass-through)*\
*Cr Deferred:PlatformFees platform_fee_cents*\
*Cr Liability:TaxPayable:PlatformFeeTax platform_fee_tax_cents*\

- **At payout to creator**:

*Dr Liability:CreatorPayable transfer_amount_cents*\
*Cr Cash:Stripe transfer_amount_cents*\

- **When fee recognized** (immediate on invoice/order paid if we treat
  fee as earned at sale for Fan‑Sub):

*Dr Deferred:PlatformFees platform_fee_cents*\
*Cr Revenue:PlatformFees platform_fee_cents*\

- **Refunds/Chargebacks** mirror §1.9 logic (reverse earned if
  applicable).

If we configure **platform fee = 0** at MVP, platform revenue on Fan‑Sub
is **\$0** and accounting is simpler; we still incur Stripe fees as
expense.

## **1.14.8 State machines**

### **1.14.8.1 Custom Request flow (Step Functions)**

*States:*\
*QuoteIssued -\> (BuyerAccept?) -\> PaymentIntentCreated -\>
PaymentSucceeded*\
*-\> CreatorDelivers -\> (BuyerApproves? -\> Closed)*\
*-\> (BuyerRequestsRevision -\> CreatorDelivers) \[loop max N\]*\
*Cancelled/Refunded/Error (terminal)*\
*Guards:*\
* - IDV/age gates checked on every transition*\
* - Max revisions N configurable (default 2)*\
* - Auto-close after 7 days of inactivity post-delivery (no refund)*\

**Transitions (events & actions)**

- *BuyerAccept* → create PI; hold UI until Stripe returns *succeeded*.
- *PaymentSucceeded* → post system message, unlock **proofs**.
- *CreatorDelivers* → proofs posted; buyer can preview (watermarked).
- *BuyerApproves* → finals manifest recorded; receipt issued.
- *BuyerRequestsRevision* → loop with decrementing counter.
- *RefundIssued* → entitlements revoked; status *refunded*.

### **1.14.8.2 Subscription lifecycle**

- *trialing* (if enabled) → *active* on first invoice; *past_due* →
  *canceled* after dunning; *paused* (manual) halts entitlement updates;
  *canceled* allows access until *current_period_end*.

## **1.14.9 Moderation, DMCA & safety runbooks**

### **1.14.9.1 Moderation pipeline**



### TD-0084 (tech)

<!-- id: TD-0084 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 302400-306400 -->

ing counter.
- *RefundIssued* → entitlements revoked; status *refunded*.

### **1.14.8.2 Subscription lifecycle**

- *trialing* (if enabled) → *active* on first invoice; *past_due* →
  *canceled* after dunning; *paused* (manual) halts entitlement updates;
  *canceled* allows access until *current_period_end*.

## **1.14.9 Moderation, DMCA & safety runbooks**

### **1.14.9.1 Moderation pipeline**

- **Text**: profanity/toxicity + PII regex (emails, phones, socials).
  Confidence thresholds tuned; soft‑block with inline redaction + appeal
  path.
- **Media**: Rekognition (nudity/adult), custom NSFW model optional;
  **band 0/1/2** policy as earlier.
- **Escalation**: 3 strikes in 30 days → auto "under review" (publishing
  paused) pending T&S decision.

### **1.14.9.2 DMCA flow (Admin console)**

1561. Intake claim → **hide** content (previews & links), notify
      creator.
1562. Creator may **counter** within window; if no counter, content
      stays removed; if counter, re‑publish unless legal hold.
1563. Evidence pack: manifest JSON, file SHA‑256, timestamps, access
      logs; export PDF.

**Timers** and **email templates** pre‑authored (§1.10).

## **1.14.10 Pricing policy, limits & abuse protections**

- **Price ranges** (configurable):

  - Subscriptions: \$2--\$50/month
  - PPV: \$1--\$200
  - Requests: \$5--\$1,000
  - Tips: \$1--\$500 per click (daily cumulative cap per user)

- **Rate limits**:

  - Max 5 PPV purchases/min per user, 20/day; Tips ≤ 10/min; Requests ≤
    3 open per creator per fan.

- **Fraud**: velocity + device/IP risk signals (tie into §1.6 risk
  score); auto‑pause on thresholds.

## **1.14.11 Notifications & templates (MJML snippets)**

- ***fansub_sub_started***: subject "You're subscribed to {{creator}}";
  body includes period dates, manage link.
- ***fansub_invoice_failed***: "Payment issue for {{creator}}---update
  your card".
- ***fansub_ppv_unlocked***: "You unlocked {{title}} by {{creator}}".
- ***fansub_request_quote***: to buyer with pay CTA; to creator with
  accepted notice.
- ***fansub_request_delivered***: approve/revise buttons.
- ***fansub_tip_received***: to creator with amount.

All respect quiet hours; security/legal always deliver.

## **1.14.12 GraphQL SDL --- extended (selected)**

*enum FansubOrderKind { TIP PPV REQUEST }*\
*enum FansubRequestStatus { QUOTED ACCEPTED PAID DELIVERED APPROVED
REVISION_REQUESTED REFUNDED DISPUTED CLOSED }*\
*enum FansubNSFWBand { SAFE BLUR BLOCK }*\
\
*type FansubOrder {*\
*orderId: ID! kind: FansubOrderKind!*\
*amountCents: Int! feeCents: Int! taxCents: Int! currency: String!*\
*status: String! createdAt: AWSDateTime!*\
*}*\
\
*type PPVAccess { ppvId: ID!, purchasedAt: AWSDateTime! }*\
\
*type Mutation {*\
*\# Admin-ish helpers for creators:*\
*setFansubPrices(priceMonthCents: Int!): FansubCreator!*\
*publishPPV(input: PPVInput!): PPVPost!*\
*unpublishPPV(ppvId: ID!): Boolean!*\
\
*\# Purchases:*\
*buyPPV(ppvId: ID!): FansubOrder! \# returns order + client secret if
needed*\
*tip(creatorId: ID!, amountCents: Int!): FansubOrder!*\
*subscribe(creatorId: ID!): SubscriptionStatus!*\
\
*\# Requests flow:*\
*requestQuote(creatorId: ID!, title: String!, brief: String!,
priceCents: Int!): ID!*\
*acceptQuote(requestId: ID!): FansubOrder!*\
*deliverRequest(requestId: ID!, proofManifest: ManifestInput!):
Boolean!*\
*approveRequest(requestId: ID!, finalManifest: ManifestInput!):
Boolean!*\
*requestRevision(requestId: ID!, note: String!): Boolean!*\
*}*\

Server injects idempotency keys; returns PaymentIntent client secrets
where applicable.

## **1.14.13 Telemetry & ops dashboards (NRT)**

- **NRT views** (≤10 min): creator earnings today/MTD, failed invoices
  by creator, active subs, churn last 7 days, request backlog.
- **Gold KPIs**: conversion (profile→subscribe), PPV unlock CTR, request
  completion rate, refund/complaint rate, average tip, ARPU.
- **Alerts**: spike in invoice failures, refund bursts, DMCA volume,
  NSFW band‑2 misclassifications

### TD-0085 (tech)

<!-- id: TD-0085 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 306000-310000 -->

etry & ops dashboards (NRT)**

- **NRT views** (≤10 min): creator earnings today/MTD, failed invoices
  by creator, active subs, churn last 7 days, request backlog.
- **Gold KPIs**: conversion (profile→subscribe), PPV unlock CTR, request
  completion rate, refund/complaint rate, average tip, ARPU.
- **Alerts**: spike in invoice failures, refund bursts, DMCA volume,
  NSFW band‑2 misclassifications.

## **1.14.14 Errors & UX copy (client‑safe)**

- *FANSUB_IDV_REQUIRED*: "You must verify you're 18+ to access Fan‑Sub."
- *FANSUB_ENTITLEMENT_REQUIRED*: "Unlock this post to view the finals."
- *FANSUB_PRICE_OUT_OF_RANGE*: "That price is outside allowed limits."
- *PAYMENT_FAILED_RETRY*: "Payment failed---update your card to
  continue."
- *REQUEST_REVISION_LIMIT*: "You've reached the maximum revisions for
  this request."
- *CONTENT_UNAVAILABLE_DMCA*: "This content is temporarily unavailable."

All errors include *corrId* and map to telemetry.

## **1.14.15 Performance & cost budgets**

- **Previews only** ensures S3 ≪ cost of finals hosting. Target: ≤ 10
  TB/mo egress at launch (cached via CF).
- **Stripe fees** dominate; tune dunning to reduce involuntary churn.
- **Compute**: watermark/transcode Lambdas constrained by concurrency;
  queue spikes; no provisioned concurrency unless p95 exceeds SLA.

## **1.14.16 Test plan (expanded)**

- **Payments**: simulate happy path & failures (insufficient funds, 3DS
  challenge, dispute).
- **Entitlements**: PPV & subs access gates; cache TTL; token expiry.
- **Requests loop**: max revisions; inactivity auto‑close.
- **Moderation**: NSFW bands; PII detection; appeals; DMCA hide/restore.
- **Comms**: all templates send with quiet hours; unsubscribe works.
- **Analytics**: events arrive; NRT dashboards update; CUPED/guardrails
  compute.
- **Cost**: preview bandwidth under budget; Firehose/Athena within
  thresholds.

## **1.14.17 Work packages (ready to assign)**

- **Agent C --- Domain/API**: tables, resolvers, entitlement cache,
  state machines, receipts.
- **Agent B --- Payments/Taxes**: Stripe Billing + Connect flows, tax
  lines, webhooks, dunning.
- **Agent A --- Web**: creator storefront, PPV/subscribe/tip flows,
  request action cards, entitlement UI.
- **Agent D --- Safety/Admin/QA**: preview pipeline
  (scan/transcode/watermark), DMCA & moderation consoles, test
  automation + synthetic data.

## **1.14.18 Acceptance criteria --- FINAL gate for §1.14**

1596. Age/IDV gates and Safe‑Mode rules enforced across all Fan‑Sub
      surfaces.
1597. Subscriptions, PPV, tips, and request flows function end‑to‑end
      with correct receipts, taxes, and payouts.
1598. Previews are watermarked and scanned; finals are referenced via
      validated manifests; entitlement tokens work; access logs
      recorded.
1599. Stripe webhooks idempotent; dunning and refunds/chargebacks
      correctly update state, ledgers, and GL.
1600. Moderation/DMCA tooling in place with audits; anticircumvention
      enforced in captions/messages.
1601. NRT dashboards and Gold KPIs live; alerts configured for invoice
      failures, refunds, and DMCA spikes.
1602. Performance and cost within budgets under 48h synthetic load.

# **§1.15 --- Support, Disputes & Resolution Center**

*(case taxonomy · refund policies & flows · chargebacks & representment
· DMCA & policy violations · data model · evidence & timelines · API &
in‑app center · email bridge · automations & macros · payouts/holds ·
telemetry & SLOs · tests · cost)*

**Purpose.** Provide a unified, auditable system for **customer
support**, **refunds**, **booking disputes**, **payments issues**,
**chargebacks**, **DMCA**, and **policy‑violation reports**. It connects
to booking (§1.3), messaging (§1.4), docs (§1.5), trust (§1.6),
promotions (§1.7), reviews (§1.8), finance/GL (§1.9), comms (§1.10),
studios (§1.11), infra (§1.12), analytics (§1.13), and Fan‑Sub (§1.14).
We'll implement internal tooling, user‑facing "Support Center," and
operational automati

### TD-0086 (tech)

<!-- id: TD-0086 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 309600-313600 -->

 disputes**, **payments issues**,
**chargebacks**, **DMCA**, and **policy‑violation reports**. It connects
to booking (§1.3), messaging (§1.4), docs (§1.5), trust (§1.6),
promotions (§1.7), reviews (§1.8), finance/GL (§1.9), comms (§1.10),
studios (§1.11), infra (§1.12), analytics (§1.13), and Fan‑Sub (§1.14).
We'll implement internal tooling, user‑facing "Support Center," and
operational automations---cost‑consciously and compliant with
record‑keeping.

We will not move to §1.16 until §1.15 satisfies your 99.9% bar.

## **1.15.A Canon & invariants**

1603. **Single front door** for all issues ("Support Center"), but
      **typed cases** with tailored flows.
1604. **Evidence first**: timelines aggregate **messages, deliverables,
      docs, approvals, geotime metadata**, and **payment records**---no
      decisions without evidence.
1605. **Refund math is deterministic** (driven by cancellation bands,
      completion status, and doc acceptance); manual overrides require
      **reasons + dual approval**.
1606. **Chargebacks ≠ refunds**: separate workflows; chargebacks follow
      card‑network timelines with **representment** packages.
1607. **Payout safety**: severe open cases place **holds** on affected
      payouts until resolved.
1608. **DMCA & policy**: legal requirements honored; immutable audits;
      content can be hidden rapidly but restored with counter‑notice if
      eligible.
1609. **Cost‑conscious**: in‑house ticketing with SES email bridge;
      optional external helpdesk later via adapter; storage in S3 with
      lifecycle policies.
1610. **Privacy**: no raw PII in case summaries beyond what's necessary;
      redaction tools for doxxing.
1611. **SLAs by severity**: response and resolution targets with SLO
      monitoring; breached cases auto‑escalate.

## **1.15.B Case taxonomy (types & subtypes)**

- **Booking issue** (people/studios)

  - *Pre‑event*: reschedule request, venue conflict, wrong filters.
  - *During event*: no‑show, late, unsafe, rules violation.
  - *Post‑event*: quality dispute, late delivery, partial completion,
    damages (studio).

- Payment & payouts

  - Charge failure, duplicate charge, refund status, **instant payout**
    delay, verification hold.

- Product/Account

  - Access problems, comms/unsubscribe, trust badge concerns.

- DMCA/IP

  - Infringing media claims (Fan‑Sub or previews), counter‑notice
    tracking.

- Policy violation

  - Harassment, doxxing, off‑platform solicitation (anticircumvention),
    hate speech, illegal content.

- Chargeback (card network)

  - Inquiry/notification, evidence packaging, representment, result.

Each maps to a **case flow** with specific states, required fields, and
resolution outcomes.

## **1.15.C Refund & dispute policy (deterministic kernels)**

**Bookings (people/studios) --- base rules**

- If **buyer cancels** within policy bands (from §1.3 /
  *studio_policy*): refund = band % of subtotal + service tax; platform
  fees treated per §1.9 (usually refundable before completion,
  non‑refundable after; configurable).
- If **seller cancels/no‑show**: full refund; optional credit bonus.
- **Partial completion** (time & materials): proration by time delivered
  or milestone completion when docs reflect acceptance.
- **Damages (studio)**: deposit capture rules in §1.3.N; evidence
  required (photos, timestamps, invoices).

**Fan‑Sub (subscriptions, PPV, requests, tips)**

- **Subscriptions**: no retro refunds after period starts unless (a)
  *involuntary churn* reversal, or (b) service outage; dunning handled
  via Stripe.
- **PPV**: refundable if content not delivered/unavailable within X
  days; once **finals accessed**, refund eligibility drops unless
  quality dispute validated.
- **Requests**: if delivered and **buyer approved**, refund only via
  goodwill; if *revision loop* exhausted with unresolved defects,
  partial refund per tariff.
- **Tips**: non‑refundable except fraud.

**Escalation ladder**

1626. Auto‑decision (rule

### TD-0087 (tech)

<!-- id: TD-0087 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 313200-317200 -->

able if content not delivered/unavailable within X
  days; once **finals accessed**, refund eligibility drops unless
  quality dispute validated.
- **Requests**: if delivered and **buyer approved**, refund only via
  goodwill; if *revision loop* exhausted with unresolved defects,
  partial refund per tariff.
- **Tips**: non‑refundable except fraud.

**Escalation ladder**

1626. Auto‑decision (rules).
1627. Support agent decision with macros + reason codes.
1628. Supervisor dual‑approval when money impact \> threshold.
1629. Legal/T&S in DMCA or policy severe cases.

## **1.15.D State machines (high‑level)**

### **D.1 Generic Support Case**

*OPEN -\> (AwaitingCustomer \| AwaitingSeller \| Investigating)*\
*-\> DecisionPending -\> (Refunded \| Denied \| GoodwillCredit \|
Escalated)*\
*-\> Closed*\

- SLA timers on **first response** and **resolution**; pausing allowed
  when waiting on customer.

### **D.2 Booking dispute (people/studios)**

*Reported -\> EvidenceCollection (pull docs/messages/deliverables)*\
*-\> Adjudication (rules engine + agent)*\
*-\> Outcome: (FullRefund \| PartialRefund \| NoRefund \| DepositCapture
\[studio\])*\
*-\> Closed*\

### **D.3 Chargeback**

*Notified -\> EvidenceRequested (deadline T)*\
*-\> Represented (submitted) -\> (Won \| Lost)*\
*-\> (If Lost -\> GL expense; if Won -\> release hold)*\

### **D.4 DMCA**

*ClaimReceived -\> ContentHidden -\> NotifyCreator*\
*-\> (CounterNotice? -\> Review -\> RestoreOrKeepDown)*\
*-\> Closed*\

## **1.15.E Data model (Aurora + S3)**

*create table support_case (*\
*case_id text primary key, \-- sca\_\...*\
*type text not null check (type in
(\'booking\',\'payment\',\'product\',\'dmca\',\'policy\',\'chargeback\')),*\
*subtype text, \-- e.g., \'no_show\',\'quality\',\'duplicate_charge\'*\
*status text not null check (status in
(\'open\',\'awaiting_customer\',\'awaiting_seller\',\'investigating\',\'decision_pending\',\'refunded\',\'denied\',\'goodwill\',\'escalated\',\'closed\')),*\
*severity text not null check (severity in
(\'low\',\'normal\',\'high\',\'urgent\')),*\
*opened_by_user text not null, \-- usr\_\...*\
*owner_user_id text, \-- agent assigned*\
*watchers text\[\] not null default \'{}\',*\
*lbg_id text, \-- booking group*\
*leg_id text,*\
*order_id text, \-- fansub order (PPV/tip/request)*\
*studio_id text,*\
*creator_id text, \-- fansub_creator*\
*payout_id text, \-- if payout hold/release*\
*reason_code text, \-- normalized reason taxonomy*\
*sla_first_resp_at timestamptz,*\
*sla_due_at timestamptz,*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now()*\
*);*\
\
*create table support_message (*\
*msg_id text primary key, \-- smg\_\...*\
*case_id text not null references support_case(case_id) on delete
cascade,*\
*author_role text not null check (author_role in
(\'buyer\',\'seller\',\'studio_owner\',\'creator\',\'agent\',\'system\')),*\
*author_user_id text,*\
*body_md text not null, \-- markdown (sanitized)*\
*attachments_json jsonb not null default \'\[\]\'::jsonb, \-- \[{s3_key,
hash, bytes, mime}\]*\
*created_at timestamptz not null default now()*\
*);*\
\
*create table support_event (*\
*evt_id text primary key, \-- sev\_\...*\
*case_id text not null references support_case(case_id) on delete
cascade,*\
*action text not null, \--
\'status_change\',\'refund_issued\',\'deposit_captured\',\'evidence_attached\',\'hold_applied\',\'hold_released\',\'chargeback_represented\',\'dmca_hide\',\'dmca_restore\'*\
*actor_user_id text,*\
*details_json jsonb not null default \'{}\'::jsonb,*\
*created_at timestamptz not null default now()*\
*);*\
\
*\-- Calculated refund/goodwill outcomes (mirror §1.9 fee/tax logic)*\
*create table support_refund (*\
*refund_id text primary key, \-- srf\_\...*\
*case_id text not null references support_case(case_id) on delete
cascade,*\
*leg_id text,*\
*order_id text,*\
*amount_cents int not null,*\
*platform_fee_cents int not null,*\
*platform_fee_tax_cents int not null,*\
*reas

### TD-0088 (tech)

<!-- id: TD-0088 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 316800-320800 -->

null default now()*\
*);*\
\
*\-- Calculated refund/goodwill outcomes (mirror §1.9 fee/tax logic)*\
*create table support_refund (*\
*refund_id text primary key, \-- srf\_\...*\
*case_id text not null references support_case(case_id) on delete
cascade,*\
*leg_id text,*\
*order_id text,*\
*amount_cents int not null,*\
*platform_fee_cents int not null,*\
*platform_fee_tax_cents int not null,*\
*reason text not null,*\
*processor_ref text, \-- refund id on Stripe*\
*status text not null check (status in
(\'proposed\',\'processing\',\'succeeded\',\'failed\')),*\
*created_at timestamptz not null default now()*\
*);*\
\
*\-- Payout holds (linked to legs/orders)*\
*create table payout_hold (*\
*hold_id text primary key, \-- sph\_\...*\
*case_id text not null references support_case(case_id),*\
*leg_id text,*\
*order_id text,*\
*amount_cents int not null, \-- up to the payable amount*\
*status text not null check (status in
(\'applied\',\'released\',\'expired\')),*\
*created_at timestamptz not null default now()*\
*);*\

**S3**:

- *support-evidence/* (immutable, WORM‑like via object‑lock if enabled)
  stores attachments (photos, manifests, logs PDF). Lifecycle →
  Intelligent‑Tiering \@30d; Glacier \@180d.

## **1.15.F Evidence & timeline stitching**

When a case opens or moves to **Investigating**, the system
auto‑collects:

- **Messages & action cards** (from §1.4) for the thread(s) related to
  *leg_id* or *request_id*.
- **Docs & signatures** (from §1.5)---hashes and acceptance timestamps.
- **Deliverables & approvals** (proofs/finals manifests).
- **Geo/time** events (check‑ins, scheduled time windows, IP/device
  changes).
- **Finance**: charge, refund, payout records (§1.9).
- **Comms**: notification delivery (for "no response" claims).
- **Risk**: user risk scores (§1.6.G).

Evidence appears in a **chronological timeline** within the case.

## **1.15.G API (GraphQL) & Support Center (user‑facing)**

*type SupportCase {*\
*caseId: ID!, type: String!, subtype: String, status: String!, severity:
String!,*\
*createdAt: AWSDateTime!, updatedAt: AWSDateTime!,*\
*lbgId: ID, legId: ID, orderId: ID, studioId: ID, creatorId: ID,*\
*reasonCode: String, ownerUserId: ID, slaDueAt: AWSDateTime*\
*}*\
*type SupportMessage {*\
*msgId: ID!, authorRole: String!, bodyMd: String!, createdAt:
AWSDateTime!*\
*attachments: \[Attachment!\]!*\
*}*\
*type SupportRefund { refundId: ID!, amountCents: Int!, status: String!,
createdAt: AWSDateTime! }*\
\
*type Query {*\
*mySupportCases(cursor:String, limit:Int=20): \[SupportCase!\]!*\
*supportCase(caseId: ID!): SupportCase!*\
*supportMessages(caseId: ID!, cursor:String, limit:Int=50):
\[SupportMessage!\]!*\
*}*\
\
*input OpenCaseInput {*\
*type: String!, subtype: String, severity: String = \"normal\",*\
*lbgId: ID, legId: ID, orderId: ID, studioId: ID, creatorId: ID,*\
*reasonCode: String, bodyMd: String!, attachments:\[AttachmentInput!\]*\
*}*\
\
*type Mutation {*\
*openCase(input: OpenCaseInput!): SupportCase!*\
*postSupportMessage(caseId: ID!, bodyMd: String!,
attachments:\[AttachmentInput!\]): SupportMessage!*\
*closeCase(caseId: ID!): Boolean!*\
*}*\

**Guards**

- Role‑scoped visibility: buyer sees their cases; seller/creator sees
  cases naming them; agents see all.
- Attachments scanned (NSFW/AV) as in §1.14.4.
- Rate‑limits on open‑case attempts.

**Support Center UI**

- "Report a problem" flows pre‑filled from booking/order context.
- Case list, case detail with timeline, message composer, attachment
  upload, status chips.

## **1.15.H Email bridge (SES) & routing**

- **Inbound**:
  [*case+{case_id}@support.rastup.com*](mailto:case+%7bcase_id%7d@support.rastup.com)
  → SES inbound rule → Lambda → *support_message* append (author
  detection via DKIM/DMARC + token).
- **Outbound**: replies include *Message‑ID*/*In‑Reply‑To*;
  List‑Unsubscribe for marketing categories unaffected.
- **Auto‑ack**: immediate "we received your request" message with case
  id and SLA.

## **1.15.I Automations, macr

### TD-0089 (tech)

<!-- id: TD-0089 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 320400-324400 -->

support.rastup.com*](mailto:case+%7bcase_id%7d@support.rastup.com)
  → SES inbound rule → Lambda → *support_message* append (author
  detection via DKIM/DMARC + token).
- **Outbound**: replies include *Message‑ID*/*In‑Reply‑To*;
  List‑Unsubscribe for marketing categories unaffected.
- **Auto‑ack**: immediate "we received your request" message with case
  id and SLA.

## **1.15.I Automations, macros, and rules**

- **Macros** (agent shortcuts):

  - Booking no‑show (buyer): checklist + refund logic + canned message +
    case close.
  - Duplicate charge: verify Stripe balance txns → auto refund/dismiss.
  - Fan‑Sub PPV unavailable: verify manifest access logs → auto refund
    if within window.

- **Rules engine**:

  - SLA breaches → escalate severity + notify supervisor.
  - Too many simultaneous severe cases for a seller → **auto payout
    hold** to limit exposure.
  - Policy keywords/NSFW escalation → T&S queue.

## **1.15.J Payout holds & releases**

- **Apply hold** on leg/order payable when: severe open case, chargeback
  notice, or DMCA that may require refund.
- **Release** on case close or representment win; **expire** after max
  window (configurable).
- Visible to seller/creator in **Finance console** with reason and
  expected timeline.

## **1.15.K Chargebacks & representment**

- **Notifications**: case created of type *chargeback* with card‑network
  reason code and due date.

- **Evidence pack** includes:

  - Signed docs, delivery approvals, message history, IP/device matches,
    geotime, studio check‑in, manifest checksums, comms delivery.

- **Submission**: representment summary + attachments; track provider
  ref & due date.

- **Outcomes**:

  - **Won** → release holds; reverse expense.
  - **Lost** → GL *Expense:Chargebacks*, optional risk downgrade (§1.6),
    optional review of promotions eligibility (§1.7).

## **1.15.L DMCA & policy violations**

- **DMCA intake**: form collects claimant info, URLs, statements under
  penalty; content hidden immediately; case links to Fan‑Sub/studio
  media ids.
- **Counter notice**: creator submits; legal review; restore if valid;
  retain evidence.
- **Policy violations**: T&S adjudication; penalties ladder (warning →
  temp suspension → permanent removal).
- **Appeals**: one appeal per decision; immutable audit in
  *support_event*.

## **1.15.M Telemetry, dashboards & SLOs**

**SLOs**

- First response: **≤ 8h** (normal), **≤ 1h** (urgent).
- Resolution: **≤ 72h** average for non‑chargeback; **≤ network
  deadline** for chargebacks.
- SLA breach rate **\< 5%** rolling 30 days.

**Dashboards**

- Volume by type/subtype & city; backlog aging; SLA breach trend.
- Refund rate by reason; goodwill spend; chargeback **win rate**; DMCA
  volume/outcomes.
- Payout holds applied/released and exposure at risk.

**Events**

- *support.case.open\|assign\|status_change\|close*,
  *support.refund.proposed\|succeeded\|failed*,
- *support.hold.apply\|release*,
  *chargeback.notified\|represented\|won\|lost*,
- *dmca.received\|hidden\|restored*.

## **1.15.N Performance & cost posture**

- **Ticketing** in Aurora (no external SaaS at launch).
- **Email bridge** via SES (inbound + outbound) to avoid Twilio SendGrid
  costs.
- **Storage**: S3 evidence with lifecycle; avoid storing large
  videos---store **manifests** and small screenshots.
- **Compute**: Lambda for parsers and automations; Step Functions for
  chargeback deadlines; no provisioned concurrency unless needed.

## **1.15.O Error taxonomy (client‑safe)**

- *CASE_NOT_FOUND*, *CASE_ACCESS_DENIED*
- *ATTACHMENT_BLOCKED* (malware/NSFW)
- *REFUND_NOT_ELIGIBLE* (policy)
- *PAYOUT_HOLD_APPLY_FAILED* (admin‑only)
- *CHARGEBACK_DEADLINE_PASSED* (admin‑only)\
  Each with *code*, *message*, *hint*, *corrId*.

## **1.15.P Test plan (CI + sandbox)**

**Core flows**

1678. Open case from booking/order context; timeline auto‑stitches
      evidence.
1679. Deterministic refund outcomes by cancellation bands; manual
      override req

### TD-0090 (tech)

<!-- id: TD-0090 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 324000-328000 -->

/NSFW)
- *REFUND_NOT_ELIGIBLE* (policy)
- *PAYOUT_HOLD_APPLY_FAILED* (admin‑only)
- *CHARGEBACK_DEADLINE_PASSED* (admin‑only)\
  Each with *code*, *message*, *hint*, *corrId*.

## **1.15.P Test plan (CI + sandbox)**

**Core flows**

1678. Open case from booking/order context; timeline auto‑stitches
      evidence.
1679. Deterministic refund outcomes by cancellation bands; manual
      override requires dual approval.
1680. Payout hold applied & released; finance views update.

**Chargebacks**\
4) Chargeback intake; evidence pack creation; representment submitted;
outcome handling (GL + risk).

**DMCA & policy**\
5) DMCA hides content; counter‑notice restores; audits present.\
6) Policy violation escalations; appeals path.

**Email bridge**\
7) Inbound email creates/appends case; spoofing rejected; attachments
scanned.\
8) Outbound reply threading correct.

**SLA & automations**\
9) SLA timers escalate; macros apply consistent decisions; rules trigger
holds on thresholds.

**Analytics**\
10) Case events land in Bronze → Silver → Gold (§1.13); dashboards show
backlog and win rates.

**Performance & cost**\
11) p95 case list fetch ≤ 120 ms; evidence download streams; S3
lifecycle verified.

## **1.15.Q Work packages (Cursor 4‑agent lanes)**

- **Agent C --- Domain/API**\
  WP‑SUP‑01: SQL for *support\_\** tables; GraphQL queries/mutations;
  timeline stitching.\
  WP‑SUP‑02: Refund calculator (ties to §1.3/§1.9); payout hold service.
- **Agent B --- Payments/Chargebacks**\
  WP‑SUP‑CB‑01: Chargeback ingest + representment builder; GL
  side‑effects.\
  WP‑SUP‑DMCA‑01: DMCA intake + hide/restore endpoints; evidence vault.
- **Agent A --- Web (Support Center)**\
  WP‑SUP‑WEB‑01: Case list/detail UI, message composer, uploads;
  booking/order context launchers.\
  WP‑SUP‑WEB‑02: Admin consoles (queues, macros, SLA board, batch
  actions).
- **Agent D --- Comms/QA**\
  WP‑SUP‑COMMS‑01: SES inbound/outbound bridge; templates and quiet
  hours (hooks §1.10).\
  WP‑SUP‑QA‑01: Test automation for all flows; synthetic chargeback
  timelines.

## **1.15.R Acceptance criteria (mark §1.15 FINAL only when ALL true)**

1685. Users and agents can create, view, message, and close cases;
      evidence timelines auto‑assembled.
1686. Refund & goodwill flows compute correct amounts with proper GL
      entries; overrides require dual approval.
1687. Chargebacks handled end‑to‑end with evidence packs and outcomes;
      payout holds applied and released correctly.
1688. DMCA intake/hide/restore works with immutable audits; policy
      violations adjudicated with an appeal path.
1689. Email bridge functional and safe (spoofing resistance, scanning);
      Support Center UI meets accessibility basics.
1690. Telemetry dashboards live; SLA breach rate within targets for
      synthetic runs; costs within budget alarms.

# **§1.16 --- Growth, Retention & Referrals**

*(saved searches & alerts · weekly city digest · feed & follow ·
sharecards & link‑in‑bio · "book again" reminders · referrals/credits &
anti‑abuse · data models · API · comms · telemetry · cost · tests)*

**What this implements from the non‑technical plan.**\
• **Saved Search → Alert** (ANY/ALL filters, 1/day per search; 30‑day
pause toggle) and **Weekly City Digest**.

NonTechBlueprint

• **Feed & Follow** (single unified feed with role tabs; Verified chip;
Safe‑Mode SFW previews).

NonTechBlueprint

• **Social share loop**: Sharecard generator + link‑in‑bio minisite with
UTM.

NonTechBlueprint

• **Auto "Book Again"** at **7/30/90 days** for recurring packages.

NonTechBlueprint

• **Referrals & Credits (two‑sided)** with monthly caps, ID gate,
device/IP fraud checks, and **clawback if first booking is refunded for
fraud**.

NonTechBlueprint

• **Global Safe‑Mode** defaults and comms constraints for 18+ material.

NonTechBlueprint

We will not leave §1.16 until the checklist at the end is met.

## **1.16.A Canon & invariants**

1691. **Respect Safe‑Mode & policy** in all growth surfaces

### TD-0091 (tech)

<!-- id: TD-0091 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 327600-331600 -->

& Credits (two‑sided)** with monthly caps, ID gate,
device/IP fraud checks, and **clawback if first booking is refunded for
fraud**.

NonTechBlueprint

• **Global Safe‑Mode** defaults and comms constraints for 18+ material.

NonTechBlueprint

We will not leave §1.16 until the checklist at the end is met.

## **1.16.A Canon & invariants**

1691. **Respect Safe‑Mode & policy** in all growth surfaces (SFW
      previews publicly; 18+ only in‑app with Safe‑Mode OFF).

NonTechBlueprint

1692. **No spam:** per‑search alert frequency **≤1/day**; weekly digest
      opt‑in; easy "pause 30 days."

NonTechBlueprint

1693. **Evidence & attribution:** all growth sends include **UTM** and
      first‑party click tokens so conversions are attributable in §1.13.

NonTechBlueprint

1694. **Abuse‑resistant referrals:** hard caps, ID checks, same
      device/IP detection, and **credit clawback** if the first booking
      is fraudulent/refunded.

NonTechBlueprint

1695. **Cost‑conscious**: serverless jobs (EventBridge Scheduler +
      Lambda), dedupe in DynamoDB with TTL, SES/SNS for comms (no heavy
      third‑party tools).

## **1.16.B Data model (Aurora + Dynamo + Typesense)**

### **B.1 Aurora (source of truth)**

*\-- Saved searches (people & studios)*\
*create table saved_search (*\
*search_id text primary key, \-- ssv\_\...*\
*user_id text not null, \-- usr\_\...*\
*scope text not null check (scope in (\'people\',\'studios\')),*\
*query_json jsonb not null, \-- normalized filters (ANY/ALL groups)*\
*city text not null,*\
*paused_until date, \-- 30-day pause*\
*last_alert_dt date, \-- last day an alert was sent*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now()*\
*);*\
\
*\-- Alert sends (daily dedupe)*\
*create table saved_search_alert (*\
*alert_id text primary key, \-- ssa\_\...*\
*search_id text not null references saved_search(search_id) on delete
cascade,*\
*alert_dt date not null,*\
*match_count int not null,*\
*email_sent boolean not null default false,*\
*inapp_created boolean not null default false,*\
*created_at timestamptz not null default now(),*\
*unique (search_id, alert_dt)*\
*);*\
\
*\-- Follow graph (for Feed)*\
*create table follow (*\
*follower_user_id text not null,*\
*target_id text not null, \-- usr\_\... (people) or fsc\_\... (Fan-Sub
creator)*\
*target_kind text not null check (target_kind in
(\'service_profile\',\'fansub_creator\')),*\
*created_at timestamptz not null default now(),*\
*primary key (follower_user_id, target_id, target_kind)*\
*);*\
\
*\-- Feed posts metadata (case studies, availability cards, touring
chips, verified studio slots)*\
*create table feed_post (*\
*feed_id text primary key, \-- fdp\_\...*\
*author_id text not null, \-- usr\_\... or fsc\_\...*\
*role_tags text\[\] not null, \-- \[\'Model\',\'Photog\',\...\]*\
*kind text not null check (kind in
(\'case_study\',\'availability\',\'touring\',\'studio_slot\',\'influence\')),*\
*title text not null,*\
*body_md text,*\
*media_preview jsonb not null default \'\[\]\'::jsonb, \-- SFW
previews*\
*nsfw_band int not null default 0, \-- 0 allow,1 blur,2 block*\
*city text, \-- for touring/availability*\
*verified_chip boolean not null default false,*\
*is_published boolean not null default false,*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now()*\
*);*\
\
*\-- Referrals & credits (ledger-based)*\
*create table referral_program (*\
*program_id text primary key, \-- rpr\_\...*\
*kind text not null check (kind in
(\'provider_invites_provider\',\'buyer_invites_buyer\',\'cross_side\')),*\
*reward_bips int not null default 0, \-- optional future %*\
*reward_fixed_cents int not null default 0, \-- e.g., \$1500 = \$15.00*\
*credit_scope text not null, \-- \'buyer_fee_only\' etc.*\
*monthly_cap int not null default 5, \-- per-user awards cap*\
*active boolean not null default true,*\
*created_at timestamptz not null default now()*\
*);*\
\
*create table referral

### TD-0092 (tech)

<!-- id: TD-0092 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 331200-335200 -->

r\',\'cross_side\')),*\
*reward_bips int not null default 0, \-- optional future %*\
*reward_fixed_cents int not null default 0, \-- e.g., \$1500 = \$15.00*\
*credit_scope text not null, \-- \'buyer_fee_only\' etc.*\
*monthly_cap int not null default 5, \-- per-user awards cap*\
*active boolean not null default true,*\
*created_at timestamptz not null default now()*\
*);*\
\
*create table referral_invite (*\
*invite_id text primary key, \-- rfi\_\...*\
*program_id text not null references referral_program(program_id),*\
*inviter_user_id text not null,*\
*invitee_user_id text, \-- populated after signup*\
*invitee_email_sha text not null, \-- hashed*\
*source text, \-- sharecard/linkinbio/...*\
*device_fp text, \-- device fingerprint*\
*ip_addr_sha text,*\
*created_at timestamptz not null default now(),*\
*accepted_at timestamptz*\
*);*\
\
*\-- Credit ledger entries (immutable)*\
*create table credit_ledger (*\
*entry_id text primary key, \-- crl\_\...*\
*user_id text not null,*\
*kind text not null check (kind in
(\'award\',\'clawback\',\'redeem\')),*\
*program_id text,*\
*amount_cents int not null,*\
*currency text not null default \'USD\',*\
*reason text not null,*\
*related_id text, \-- booking_id, invite_id*\
*created_at timestamptz not null default now()*\
*);*\

### **B.2 DynamoDB (hot path)**

- *saved_search_dedupe*: *(PK=search_id, SK=YYYY-MM-DD)* prevents \>1
  alert/day; TTL auto‑expires older rows.
- *feed_fanout_cursor*: per follower "last seen" cursor to build
  incremental feed pages.
- *referral_device_daily*: counters *(device_fp, date)* and *(ip_hash,
  date)* for rate‑limit and fraud signals.

### **B.3 Search indices (Typesense/OpenSearch)**

- **people_v1** and **studios_v1** already defined; extend with **facets
  for ANY/ALL** groups and **verified/trusted** flags used in alerts.

NonTechBlueprint

## **1.16.C Saved Searches & Alerts (ANY/ALL + 1/day cap)**

### **C.1 Query model**

- **ANY/ALL**: store filters as *{\"any\":\[\...\],\"all\":\[\...\]}*;
  search layer builds a boolean query to Typesense/OpenSearch.

NonTechBlueprint

- Safe‑Mode enforced in the query (e.g., hide nudity tiers beyond
  "Lingerie/Swim" when ON).

NonTechBlueprint

### **C.2 Daily job (EventBridge Scheduler → Lambda)**

1702. For each active *saved_search* not *paused_until \> today*,
      compute **new matches since** ***last_alert_dt***.

1703. If *match_count\>0* and no *saved_search_alert* exists for *today*
      (and no Dynamo dedupe row found), create:

      y.  an **in‑app digest** item,
      z.  an **email** (SES) with at most 20 cards + "View All" deep
          link,
      a.  update *last_alert_dt=today*, write *saved_search_alert*.

1704. **Frequency cap**: exactly **≤1/day/search**.

NonTechBlueprint

1705. **Pause 30 days** toggles *paused_until = today + 30*.

NonTechBlueprint

## **1.16.D Weekly City Digest (opt‑in)**

- Cron weekly per city; content blocks: **featured case studies**,
  **Verified Studios with open slots**, **Top rising creators** (Rep
  growth).

NonTechBlueprint

- Safe‑Mode rules for previews; **no 18+** content in email.

NonTechBlueprint

- Unsubscribe per‑digest type; quiet‑hours respected.

## **1.16.E Feed & Follow**

### **E.1 Surfaces (mirrors plan language)**

- **Single unified feed** per user with **role tabs**
  (Model/Photog/Vid/Creator/Fan‑Sub Creator).

NonTechBlueprint

- Pulls **new case studies**, **availability cards** ("Now booking
  Saturday"), **touring chips** (e.g., "Visiting Austin 11/20--11/22"),
  **Verified Studio open slots**, **Verified influence posts** (SFW
  preview + "Verified" tick).

NonTechBlueprint

- Safe‑Mode default ON for guests/new users; applies to People (18+
  gating) but **never hides Studios**.

NonTechBlueprint

### **E.2 Delivery & ranking**

- Build a **fan‑out‑on‑read** feed: query *feed_post* + follows; rank by
  recency, followed weight, verified chip, and engagement.
- Cursors (time + id) for pagination; **no unbounded fan‑out**.

##

### TD-0093 (tech)

<!-- id: TD-0093 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 334800-338800 -->

iew + "Verified" tick).

NonTechBlueprint

- Safe‑Mode default ON for guests/new users; applies to People (18+
  gating) but **never hides Studios**.

NonTechBlueprint

### **E.2 Delivery & ranking**

- Build a **fan‑out‑on‑read** feed: query *feed_post* + follows; rank by
  recency, followed weight, verified chip, and engagement.
- Cursors (time + id) for pagination; **no unbounded fan‑out**.

### **E.3 Authoring**

- Creators/providers publish feed posts tagged by **role(s)**; one post
  can serve all tabs.

NonTechBlueprint

- Media previews run through the same **NSFW scan** rules as
  §1.10/§1.14; public views stay SFW.

## **1.16.F Social Share & Link‑in‑Bio**

### **F.1 Sharecard generator**

- **Lambda (headless Chromium)** renders responsive PNG/WebP with:
  avatar, name, role(s), city, 1--3 images, **QR** to profile/booking
  link, and **UTM**.

NonTechBlueprint

- Output sizes for IG/TikTok aspect ratios; store in S3 with
  **year‑long** cache.
- Watermark minimal; Safe‑Mode preview rules apply.

### **F.2 Link‑in‑bio minisite**

- Static microsite auto‑generated per user: **packages**,
  **availability**, **contact CTA**; includes **UTM** for attribution.

NonTechBlueprint

- Hosted on CloudFront; vanity URL; Safe‑Mode rules for previews.

## **1.16.G "Book Again" reminders (7/30/90)**

- Scheduler picks eligible past bookings tagged as **recurring
  packages**; sends **"Book Again"** at **7**, **30**, and **90** days
  post‑completion, pre‑filled with last scope and adjusted dates.

NonTechBlueprint

- Frequency caps by buyer/service‑profile pair; auto‑disables when buyer
  opts out.
- No 18+ media in comms; deep link to draft checkout.

## **1.16.H Referrals & Credits (two‑sided, abuse‑resistant)**

### **H.1 Programs (as per plan)**

- **Provider invites provider** → both get **+20 DM credits** after
  invitee **publishes a package** and completes **1 booking**.

NonTechBlueprint

- **Buyer invites buyer** → inviter gets **1 RFP credit** when invitee
  **posts a brief** and **awards** a booking.

NonTechBlueprint

- **Cross‑side referrals**: provider invites buyer; **\$15 buyer
  credit** toward next booking (**buyer fee only**). Guardrails below.

NonTechBlueprint

### **H.2 Guardrails (explicit from plan)**

- **Per‑user monthly caps**; **ID required** to redeem; **same device/IP
  fraud detection**; **clawback** if first booking is **refunded for
  fraud**.

NonTechBlueprint

### **H.3 Mechanics**

- **Invite flow** issues signed links that encode *program_id* and
  inviter; capture device/IP on accept.
- **Qualification events**: "package published," "brief posted,"
  "booking awarded/completed" feed a small **rules engine**; on pass,
  write **credit_ledger (award)**.
- **Clawback**: upon fraud/refund adjudication in §1.15/§1.9, write
  **credit_ledger (clawback)** and revoke unused credits.

## **1.16.I GraphQL API (selected)**

*\# Saved search & alerts*\
*type SavedSearch { searchId: ID!, scope: String!, city: String!,
queryJson: AWSJSON!, pausedUntil: AWSDate }*\
*type SavedSearchAlert { alertId: ID!, alertDt: AWSDate!, matchCount:
Int!, emailSent: Boolean!, inappCreated: Boolean! }*\
\
*type Query {*\
*mySavedSearches: \[SavedSearch!\]!*\
*myFeed(cursor: String, limit: Int = 25, tab: String): FeedPage!*\
*}*\
\
*input SavedSearchInput { scope: String!, city: String!, queryJson:
AWSJSON! }*\
\
*type Mutation {*\
*createSavedSearch(input: SavedSearchInput!): SavedSearch!*\
*pauseSavedSearch(searchId: ID!, days: Int!): SavedSearch! \# 30 days
typical*\
*deleteSavedSearch(searchId: ID!): Boolean!*\
\
*follow(targetId: ID!, targetKind: String!): Boolean!*\
*unfollow(targetId: ID!, targetKind: String!): Boolean!*\
\
*sendReferral(programId: ID!, inviteeEmail: String!): Boolean!*\
*redeemCredit(entryId: ID!, amountCents: Int!): Boolean! \# buyer fee
only scope validated server-side*\
*}*\

**Server guards**: Safe‑Mode checks in feed; per‑search daily dedupe;
per‑user referral caps; ID/age gate for credit rede

### TD-0094 (tech)

<!-- id: TD-0094 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 338400-342400 -->

tId: ID!, targetKind: String!): Boolean!*\
*unfollow(targetId: ID!, targetKind: String!): Boolean!*\
\
*sendReferral(programId: ID!, inviteeEmail: String!): Boolean!*\
*redeemCredit(entryId: ID!, amountCents: Int!): Boolean! \# buyer fee
only scope validated server-side*\
*}*\

**Server guards**: Safe‑Mode checks in feed; per‑search daily dedupe;
per‑user referral caps; ID/age gate for credit redemption where
required.

## **1.16.J Comms & templates**

- **Saved search alert** (daily cap)
- **Weekly city digest** (opt‑in)
- Book again 7/30/90
- **Referral invite** and **award** confirmations\
  All templates deliver **SFW** previews only and include **preference
  links**.

NonTechBlueprint

## **1.16.K Telemetry & experiments (hooked into §1.13)**

- **Events**: *search.saved\|alert.sent\|alert.click*,
  *feed.post.publish\|impression\|click*, *sharecard.create\|click*,
  *lib.microsite.visit*, *book_again.sent\|clicked\|converted*,
  *referral.invite\|accepted\|qualified\|clawback*.
- **Gold KPIs**: alert CTR, digest CTR, follow growth, feed engagement,
  book‑again conversion, referral qualification rate, fraud/clawback
  rate.
- **Guardrails**: unsubscribe/complaint rates; Safe‑Mode breaches
  (should be zero for emails).
- **NRT** ops tiles: today's alerts/digests volume, referral awards vs
  caps, clawbacks.

## **1.16.L Performance & cost**

- **Schedulers**: EventBridge scheduled Lambdas (cron & daily); no
  long‑running workers.
- **Search**: pre‑compute **match hashes** to reduce index scans for
  alerts; use Typesense filters efficiently.
- **Storage**: S3 for sharecards, lifecycle → Intelligent‑Tiering \@30d;
  CloudFront cache hits ≥95%.
- **Email**: SES shared IPs; digest batches to keep costs low.
- **Dynamo**: TTL‑based dedupe tables; RCU/WCU caps.
- **Budgets**: alarms on SES sends/day, Lambda duration, Dynamo
  capacity.

## **1.16.M Error taxonomy (client‑safe)**

- *ALERT_FREQUENCY_LIMIT* --- already sent today for this search.
- *DIGEST_OPTOUT* --- user unsubscribed.
- *SAFE_MODE_BLOCKED* --- attempting to include 18+ in email.
- *REFERRAL_CAP_EXCEEDED* --- monthly cap reached.
- *CREDIT_SCOPE_VIOLATION* --- tried to apply buyer credit to non‑fee
  items.
- Each error returns *code*, *message*, *hint*, and *corrId*.

## **1.16.N Test plan (CI + sandbox)**

**Saved searches & alerts**

1751. ANY/ALL correctness; Safe‑Mode gates; 1/day frequency; 30‑day
      pause respected; alert contains only *new* matches.

NonTechBlueprint

NonTechBlueprint

**Weekly digest**\
2) Opt‑in/out; city content blocks; no 18+ previews in email.

NonTechBlueprint

NonTechBlueprint

**Feed & follow**\
3) Unified feed with role tabs; Verified chip; SFW previews on public;
pagination stable.

NonTechBlueprint

**Sharecards & link‑in‑bio**\
4) Image renders for IG/TT; QR & UTM present; attribution shows in §1.13
marts.

NonTechBlueprint

**Book again**\
5) 7/30/90 schedule; prefill scope; opt‑out honored; conversions
attributed.

NonTechBlueprint

**Referrals & credits**\
6) Program qualifications (publish package / post brief / award +
complete); monthly caps; device/IP checks; clawback on fraud/refund.

NonTechBlueprint

**Telemetry & cost**\
7) Events land Bronze→Silver→Gold; dashboards populate;
SES/Lambda/Dynamo within budgets.

## **1.16.O Work packages (Cursor 4‑agent lanes)**

- **Agent B --- Domain/API**: Saved Search, Feed, Referrals SQL +
  resolvers; daily/weekly schedulers; credit ledger; book‑again job.
- **Agent C --- Search/Index**: ANY/ALL query builder; match hash
  generation; Verified/Trusted facets.
- **Agent A --- Web**: Saved Search UI (ANY/ALL builder), Feed with role
  tabs & Verified chip, link‑in‑bio page, sharecard UI.
- **Agent D --- Comms/QA**: MJML templates
  (alerts/digest/book‑again/referrals), SES setup, test automation for
  dedupe and caps.

## **1.16.P Acceptance criteria (mark §1.16 FINAL only when ALL true)**

1756. Saved Searches support ANY/ALL, Safe‑Mode filters, and **≤1/day**
      alert

### TD-0095 (tech)

<!-- id: TD-0095 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 342000-346000 -->

**: Saved Search UI (ANY/ALL builder), Feed with role
  tabs & Verified chip, link‑in‑bio page, sharecard UI.
- **Agent D --- Comms/QA**: MJML templates
  (alerts/digest/book‑again/referrals), SES setup, test automation for
  dedupe and caps.

## **1.16.P Acceptance criteria (mark §1.16 FINAL only when ALL true)**

1756. Saved Searches support ANY/ALL, Safe‑Mode filters, and **≤1/day**
      alerts with 30‑day pause.

NonTechBlueprint

NonTechBlueprint

1757. Weekly City Digest ships, opt‑in/out respected, **SFW only** in
      email.

NonTechBlueprint

NonTechBlueprint

1758. Unified Feed delivers case studies, availability, touring chips,
      verified studio slots, influence posts with role tabs and Verified
      chip; Safe‑Mode enforced.

NonTechBlueprint

1759. Sharecards and link‑in‑bio microsite generate correctly with UTM
      and QR, and conversions are attributable.

NonTechBlueprint

1760. "Book Again" at 7/30/90 runs with prefilled scope; frequency caps
      and opt‑outs enforced.

NonTechBlueprint

1761. Referrals/credits hit qualification rules, enforce monthly
      caps/ID/device/IP rules, and **claw back** on fraud/refund.

NonTechBlueprint

1762. Telemetry, dashboards, budgets, and alarms are live; cost and SLO
      targets met on a 48‑hour synthetic run.

# **§1.16 --- Artifacts (inline, text‑only)**

**How to paste into your doc:** Keep the headings and the "Recommended
filename/path" comments so your team can find each artifact later.

## **1.16‑A. SQL --- Growth & Referrals schema (Aurora PostgreSQL)**

**Recommended filename/path:** *db/migrations/016_growth_referrals.sql*

*\-- 016_growth_referrals.sql*\
*\-- Saved searches (ANY/ALL filters), alert sends, follow graph, feed
posts,*\
*\-- referrals & credits (ledger), with sensible indexes.*\
\
*begin;*\
\
*create table if not exists saved_search (*\
*search_id text primary key, \-- ssv\_\...*\
*user_id text not null, \-- usr\_\...*\
*scope text not null check (scope in (\'people\',\'studios\')),*\
*query_json jsonb not null, \-- normalized ANY/ALL filters*\
*city text not null,*\
*paused_until date,*\
*last_alert_dt date,*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now()*\
*);*\
*create index if not exists idx_saved_search_user on
saved_search(user_id);*\
*create index if not exists idx_saved_search_city on
saved_search(city);*\
\
*create table if not exists saved_search_alert (*\
*alert_id text primary key, \-- ssa\_\...*\
*search_id text not null references saved_search(search_id) on delete
cascade,*\
*alert_dt date not null,*\
*match_count int not null,*\
*email_sent boolean not null default false,*\
*inapp_created boolean not null default false,*\
*created_at timestamptz not null default now(),*\
*unique (search_id, alert_dt)*\
*);*\
\
*create table if not exists follow (*\
*follower_user_id text not null, \-- usr\_\...*\
*target_id text not null, \-- usr\_\... \| fsc\_\...*\
*target_kind text not null check (target_kind in
(\'service_profile\',\'fansub_creator\')),*\
*created_at timestamptz not null default now(),*\
*primary key (follower_user_id, target_id, target_kind)*\
*);*\
\
*create table if not exists feed_post (*\
*feed_id text primary key, \-- fdp\_\...*\
*author_id text not null,*\
*role_tags text\[\] not null,*\
*kind text not null check (kind in
(\'case_study\',\'availability\',\'touring\',\'studio_slot\',\'influence\')),*\
*title text not null,*\
*body_md text,*\
*media_preview jsonb not null default \'\[\]\'::jsonb, \-- SFW previews
only*\
*nsfw_band int not null default 0, \-- 0 allow,1 blur,2 block*\
*city text,*\
*verified_chip boolean not null default false,*\
*is_published boolean not null default false,*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now()*\
*);*\
*create index if not exists idx_feed_post_pub on feed_post(is_published,
created_at desc);*\
*create index if not exists idx_feed_post_city on feed_post(city);*\
\
*creat

### TD-0096 (tech)

<!-- id: TD-0096 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 345600-349600 -->

lur,2 block*\
*city text,*\
*verified_chip boolean not null default false,*\
*is_published boolean not null default false,*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now()*\
*);*\
*create index if not exists idx_feed_post_pub on feed_post(is_published,
created_at desc);*\
*create index if not exists idx_feed_post_city on feed_post(city);*\
\
*create table if not exists referral_program (*\
*program_id text primary key, \-- rpr\_\...*\
*kind text not null check (kind in
(\'provider_invites_provider\',\'buyer_invites_buyer\',\'cross_side\')),*\
*reward_bips int not null default 0,*\
*reward_fixed_cents int not null default 0,*\
*credit_scope text not null, \-- e.g., \'buyer_fee_only\'*\
*monthly_cap int not null default 5,*\
*active boolean not null default true,*\
*created_at timestamptz not null default now()*\
*);*\
\
*create table if not exists referral_invite (*\
*invite_id text primary key, \-- rfi\_\...*\
*program_id text not null references referral_program(program_id),*\
*inviter_user_id text not null,*\
*invitee_user_id text,*\
*invitee_email_sha text not null,*\
*source text, \-- \'sharecard\',\'linkinbio\', etc.*\
*device_fp text,*\
*ip_addr_sha text,*\
*created_at timestamptz not null default now(),*\
*accepted_at timestamptz*\
*);*\
*create index if not exists idx_rfi_inviter on
referral_invite(inviter_user_id, created_at desc);*\
*create index if not exists idx_rfi_email on
referral_invite(invitee_email_sha);*\
\
*create table if not exists credit_ledger (*\
*entry_id text primary key, \-- crl\_\...*\
*user_id text not null,*\
*kind text not null check (kind in
(\'award\',\'clawback\',\'redeem\')),*\
*program_id text,*\
*amount_cents int not null,*\
*currency text not null default \'USD\',*\
*reason text not null,*\
*related_id text,*\
*created_at timestamptz not null default now()*\
*);*\
*create index if not exists idx_credit_user on credit_ledger(user_id,
created_at desc);*\
\
*commit;*\

## **1.16‑B. DynamoDB --- hot‑path/TTL tables**

**Recommended filename/path:** *infra/dynamodb/016_growth_ttl_tables.md*
*(doc note for infra CDK)*

*Table: saved_search_dedupe*\
*Key: PK = search_id, SK = alert_date (YYYY-MM-DD)*\
*Attributes: ttl_epoch (Number)*\
*Purpose: ensure ≤1 alert/day/search; items auto-expire via TTL.*\
\
*Table: feed_fanout_cursor*\
*Key: PK = user_id, SK = \'cursor\'*\
*Attributes: last_seen_created_at (ISO), last_seen_id*\
*Purpose: incremental paging for unified feed.*\
\
*Table: referral_device_daily*\
*Key: PK = device_fp#YYYY-MM-DD, SK = program_id*\
*Attributes: ip_hash, count*\
*TTL: next day*\
*Purpose: rate-limit & fraud signal for invites/accepts.*\

## **1.16‑C. GraphQL SDL --- Saved Search, Feed, Referrals**

**Recommended filename/path:** *api/schema/growth.graphql*

*\# growth.graphql*\
\
*scalar AWSJSON*\
*scalar AWSDate*\
*scalar AWSDateTime*\
\
*type SavedSearch {*\
*searchId: ID!*\
*scope: String!*\
*city: String!*\
*queryJson: AWSJSON!*\
*pausedUntil: AWSDate*\
*lastAlertDt: AWSDate*\
*createdAt: AWSDateTime!*\
*updatedAt: AWSDateTime!*\
*}*\
\
*type SavedSearchAlert {*\
*alertId: ID!*\
*searchId: ID!*\
*alertDt: AWSDate!*\
*matchCount: Int!*\
*emailSent: Boolean!*\
*inappCreated: Boolean!*\
*createdAt: AWSDateTime!*\
*}*\
\
*type FeedCard {*\
*feedId: ID!*\
*authorId: ID!*\
*roleTags: \[String!\]!*\
*kind: String!*\
*title: String!*\
*bodyMd: String*\
*mediaPreview: AWSJSON!*\
*city: String*\
*verifiedChip: Boolean!*\
*createdAt: AWSDateTime!*\
*}*\
\
*type FeedPage { items: \[FeedCard!\]!, cursor: String }*\
\
*type ReferralInvite { inviteId: ID!, programId: ID!, inviterUserId:
ID!, acceptedAt: AWSDateTime }*\
*type CreditLedger { entryId: ID!, userId: ID!, kind: String!,
amountCents: Int!, reason: String!, createdAt: AWSDateTime! }*\
\
*input SavedSearchInput { scope: String!, city: String!, queryJson:
AWSJSON! }*\
\
*type Query {*\
*mySavedSearches: \[SavedSearch!\]!*\
*myFeed(cursor: String, limit: Int = 25, tab: String): F

### TD-0097 (tech)

<!-- id: TD-0097 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 349200-353200 -->

nviteId: ID!, programId: ID!, inviterUserId:
ID!, acceptedAt: AWSDateTime }*\
*type CreditLedger { entryId: ID!, userId: ID!, kind: String!,
amountCents: Int!, reason: String!, createdAt: AWSDateTime! }*\
\
*input SavedSearchInput { scope: String!, city: String!, queryJson:
AWSJSON! }*\
\
*type Query {*\
*mySavedSearches: \[SavedSearch!\]!*\
*myFeed(cursor: String, limit: Int = 25, tab: String): FeedPage!*\
*myCredits: \[CreditLedger!\]!*\
*}*\
\
*type Mutation {*\
*createSavedSearch(input: SavedSearchInput!): SavedSearch!*\
*pauseSavedSearch(searchId: ID!, days: Int!): SavedSearch!*\
*deleteSavedSearch(searchId: ID!): Boolean!*\
\
*follow(targetId: ID!, targetKind: String!): Boolean!*\
*unfollow(targetId: ID!, targetKind: String!): Boolean!*\
\
*sendReferral(programId: ID!, inviteeEmail: String!): Boolean!*\
*redeemCredit(entryId: ID!, amountCents: Int!): Boolean!*\
*}*\

## **1.16‑D. EventBridge schedules (cron) --- Alerts/Digests/Book‑Again**

**Recommended filename/path:** *infra/schedules/growth-schedules.yml*

*\# growth-schedules.yml (declarative intent; implemented via
CDK/Amplify Gen 2)*\
*schedules:*\
* - name: saved-search-alerts-daily*\
*cron: \"cron(5 13 \* \* ? \*)\" \# 13:05 UTC daily*\
*targetLambda: growthSavedSearchAlerts*\
* - name: weekly-city-digest*\
*cron: \"cron(15 14 ? \* MON \*)\" \# Mondays 14:15 UTC*\
*targetLambda: growthWeeklyDigest*\
* - name: book-again-7d*\
*cron: \"cron(0 12 \* \* ? \*)\"*\
*targetLambda: growthBookAgain7*\
* - name: book-again-30d*\
*cron: \"cron(5 12 \* \* ? \*)\"*\
*targetLambda: growthBookAgain30*\
* - name: book-again-90d*\
*cron: \"cron(10 12 \* \* ? \*)\"*\
*targetLambda: growthBookAgain90*\

## **1.16‑E. Lambda handler skeleton --- Saved Search Alerts**

**Recommended filename/path:**
*apps/functions/growthSavedSearchAlerts.ts*

*// growthSavedSearchAlerts.ts*\
*// Pseudocode: load eligible searches, query index, dedupe (Dynamo),
send in-app + email via SES.*\
\
*import { queryPeople, queryStudios } from \'../lib/search\';*\
*import { getEligibleSavedSearches, markAlertSent } from
\'../lib/savedSearchRepo\';*\
*import { dynamoDedupeHit } from \'../lib/dedupe\';*\
*import { sendEmail } from \'../lib/ses\';*\
*import { createInAppDigest } from \'../lib/inapp\';*\
\
*export const handler = async () =\> {*\
*const searches = await getEligibleSavedSearches();*\
*for (const s of searches) {*\
*const alreadySent = await dynamoDedupeHit(s.searchId);*\
*if (alreadySent) continue;*\
\
*const matches = s.scope === \'people\'*\
*? await queryPeople(s.query_json, s.city)*\
*: await queryStudios(s.query_json, s.city);*\
\
*if (matches.length === 0) continue;*\
\
*await createInAppDigest(s.user_id, s.search_id, matches.slice(0,
20));*\
*await sendEmail({*\
*toUserId: s.user_id,*\
*template: \'saved_search_alert\',*\
*vars: { city: s.city, count: matches.length, cards: matches.slice(0,
20) }*\
*});*\
\
*await markAlertSent(s.search_id, matches.length);*\
*}*\
*};*\

## **1.16‑F. MJML template --- Saved Search Alert (SFW‑only)**

**Recommended filename/path:** *comms/templates/saved_search_alert.mjml*

*\<mjml\>*\
*\<mj-head\>*\
*\<mj-title\>New matches in {{city}}\</mj-title\>*\
*\<mj-attributes\>*\
*\<mj-text font-size=\"14px\" line-height=\"20px\" /\>*\
*\</mj-attributes\>*\
*\</mj-head\>*\
*\<mj-body\>*\
*\<mj-section\>*\
*\<mj-column\>*\
*\<mj-text font-size=\"18px\"\>\<strong\>{{count}}\</strong\> new
match{{#plural count}}es{{/plural}} in {{city}}\</mj-text\>*\
*\<mj-text\>We've found new profiles that match your saved search.
Previews are SFW.\</mj-text\>*\
*\</mj-column\>*\
*\</mj-section\>*\
\
*{{#each cards}}*\
*\<mj-section\>*\
*\<mj-column\>*\
*\<mj-image src=\"{{this.previewUrl}}\" alt=\"{{this.title}} --- SFW
preview\" /\>*\
*\<mj-text\>\<strong\>{{this.title}}\</strong\>\<br/\>{{this.subtitle}}\</mj-text\>*\
*\<mj-button href=\"{{this.deepLink}}\"\>View profile\</mj-button\>*\
*\</mj-column\>*\
*\</mj-section\>*\
*{{/each}}*\
\
*\<mj-section\>*\
*\<mj-column\>*\
*\<mj-t

### TD-0098 (tech)

<!-- id: TD-0098 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 352800-356800 -->

tion\>*\
\
*{{#each cards}}*\
*\<mj-section\>*\
*\<mj-column\>*\
*\<mj-image src=\"{{this.previewUrl}}\" alt=\"{{this.title}} --- SFW
preview\" /\>*\
*\<mj-text\>\<strong\>{{this.title}}\</strong\>\<br/\>{{this.subtitle}}\</mj-text\>*\
*\<mj-button href=\"{{this.deepLink}}\"\>View profile\</mj-button\>*\
*\</mj-column\>*\
*\</mj-section\>*\
*{{/each}}*\
\
*\<mj-section\>*\
*\<mj-column\>*\
*\<mj-text\>If you'd like to pause alerts for 30 days, \<a
href=\"{{pauseLink}}\"\>click here\</a\>.\</mj-text\>*\
*\<mj-text font-size=\"12px\" color=\"#666\"\>No 18+ content is included
in this email. To change preferences, visit Settings.\</mj-text\>*\
*\</mj-column\>*\
*\</mj-section\>*\
*\</mj-body\>*\
*\</mjml\>*\

## **1.16‑G. JSON Schemas --- Key Growth Events**

**Recommended filename/path:** *data/schemas/growth-events/*

*// search.saved.v1.json*\
*{*\
*\"\$id\":
\"*[*https://rastup/schemas/search.saved.v1.json*](https://rastup/schemas/search.saved.v1.json)*\",*\
*\"\$schema\":
\"*[*https://json-schema.org/draft/2020-12/schema*](https://json-schema.org/draft/2020-12/schema)*\",*\
*\"type\": \"object\",*\
*\"required\": \[\"scope\",\"city\",\"query_hash\"\],*\
*\"properties\": {*\
*\"scope\": { \"type\": \"string\", \"enum\": \[\"people\",\"studios\"\]
},*\
*\"city\": { \"type\": \"string\" },*\
*\"query_hash\": { \"type\": \"string\" }*\
*},*\
*\"additionalProperties\": false*\
*}*\

*// alert.sent.v1.json*\
*{*\
*\"\$id\":
\"*[*https://rastup/schemas/alert.sent.v1.json*](https://rastup/schemas/alert.sent.v1.json)*\",*\
*\"\$schema\":
\"*[*https://json-schema.org/draft/2020-12/schema*](https://json-schema.org/draft/2020-12/schema)*\",*\
*\"type\": \"object\",*\
*\"required\": \[\"search_id\",\"count\",\"channel\"\],*\
*\"properties\": {*\
*\"search_id\": { \"type\": \"string\" },*\
*\"count\": { \"type\": \"integer\", \"minimum\": 1 },*\
*\"channel\": { \"type\": \"string\", \"enum\": \[\"email\",\"inapp\"\]
}*\
*},*\
*\"additionalProperties\": false*\
*}*\

*// referral.invite.v1.json*\
*{*\
*\"\$id\":
\"*[*https://rastup/schemas/referral.invite.v1.json*](https://rastup/schemas/referral.invite.v1.json)*\",*\
*\"\$schema\":
\"*[*https://json-schema.org/draft/2020-12/schema*](https://json-schema.org/draft/2020-12/schema)*\",*\
*\"type\": \"object\",*\
*\"required\":
\[\"program_id\",\"inviter_user_id\",\"invitee_email_sha\"\],*\
*\"properties\": {*\
*\"program_id\": { \"type\": \"string\" },*\
*\"inviter_user_id\": { \"type\": \"string\" },*\
*\"invitee_email_sha\": { \"type\": \"string\" },*\
*\"source\": { \"type\": \"string\" }*\
*},*\
*\"additionalProperties\": false*\
*}*\

## **1.16‑H. Cost guardrails (observability notes)**

**Recommended filename/path:** *observability/budgets/growth-guards.md*

*Metrics & alarms:*\
*- SES sends/day: warn at 80% of daily cap; hard stop at 120% (switch to
in-app only).*\
*- Lambda duration: P95 \> 750ms sustained 10m → investigate search
query shapes.*\
*- Dynamo RCU/WCU: consume \> 80% for 15m → auto scale + alert.*\
*- Typesense/OpenSearch: QPS spikes \> 3x baseline → enable precomputed
match hashes for saved-search batch.*\

# **§1.16 --- Artifacts (inline, text-only) --- Continuation**

Below are the remaining **copy-pasteable** blocks for the project plan.
Each includes a **Recommended filename/path** label so your builders can
later lift them into a repo if you choose. These are all text for your
single Word doc.

## **1.16-I. MJML --- Weekly City Digest (SFW-only, opt-in)**

**Recommended filename/path:** *comms/templates/weekly_city_digest.mjml*

*\<mjml\>*\
*\<mj-head\>*\
*\<mj-title\>Your {{city}} weekly creative digest\</mj-title\>*\
*\<mj-attributes\>*\
*\<mj-all font-family=\"Inter, -apple-system, Segoe UI, Roboto,
Helvetica, Arial, sans-serif\" /\>*\
*\<mj-text font-size=\"14px\" line-height=\"20px\" /\>*\
*\<mj-section padding=\"0\" /\>*\
*\<mj-column padding=\"0\" /\>*\
*\</mj-attributes\>*\
*\<mj-style\>*\
*.chip { background:#F2F4F7; border-radius:16px; padding:4px 10px;
fo

### TD-0099 (tech)

<!-- id: TD-0099 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 356400-360400 -->

{{city}} weekly creative digest\</mj-title\>*\
*\<mj-attributes\>*\
*\<mj-all font-family=\"Inter, -apple-system, Segoe UI, Roboto,
Helvetica, Arial, sans-serif\" /\>*\
*\<mj-text font-size=\"14px\" line-height=\"20px\" /\>*\
*\<mj-section padding=\"0\" /\>*\
*\<mj-column padding=\"0\" /\>*\
*\</mj-attributes\>*\
*\<mj-style\>*\
*.chip { background:#F2F4F7; border-radius:16px; padding:4px 10px;
font-size:12px; }*\
*\</mj-style\>*\
*\</mj-head\>*\
\
*\<mj-body background-color=\"#ffffff\"\>*\
\
*\<!\-- Header \--\>*\
*\<mj-section padding=\"16px 24px\"\>*\
*\<mj-column\>*\
*\<mj-text font-size=\"20px\" font-weight=\"600\"\>This week in
{{city}}\</mj-text\>*\
*\<mj-text color=\"#667085\"\>SFW previews only. Update preferences
anytime.\</mj-text\>*\
*\</mj-column\>*\
*\</mj-section\>*\
\
*\<!\-- Featured case studies \--\>*\
*{{#if caseStudies.length}}*\
*\<mj-section padding=\"8px 24px\"\>*\
*\<mj-column\>*\
*\<mj-text font-size=\"16px\" font-weight=\"600\"\>Featured case
studies\</mj-text\>*\
*\</mj-column\>*\
*\</mj-section\>*\
*{{#each caseStudies}}*\
*\<mj-section padding=\"0 24px 12px\"\>*\
*\<mj-column\>*\
*\<mj-image src=\"{{this.preview}}\" alt=\"{{this.title}} --- SFW
preview\" padding-bottom=\"8px\" /\>*\
*\<mj-text\>\<strong\>{{this.title}}\</strong\>\<br/\>{{this.subtitle}}\</mj-text\>*\
*\<mj-text\>\<span class=\"chip\"\>{{this.role}}\</span\> \<span
class=\"chip\"\>{{this.neighborhood}}\</span\>\</mj-text\>*\
*\<mj-button href=\"{{this.link}}\"\>See the full
breakdown\</mj-button\>*\
*\</mj-column\>*\
*\</mj-section\>*\
*{{/each}}*\
*{{/if}}*\
\
*\<!\-- Verified Studios with open slots \--\>*\
*{{#if studios.length}}*\
*\<mj-section padding=\"8px 24px\"\>*\
*\<mj-column\>*\
*\<mj-text font-size=\"16px\" font-weight=\"600\"\>Verified Studios ---
open slots\</mj-text\>*\
*\</mj-column\>*\
*\</mj-section\>*\
*{{#each studios}}*\
*\<mj-section padding=\"0 24px 12px\"\>*\
*\<mj-column\>*\
*\<mj-image src=\"{{this.preview}}\" alt=\"{{this.name}} --- SFW
preview\" padding-bottom=\"8px\" /\>*\
*\<mj-text\>\<strong\>{{this.name}}\</strong\>\<br/\>{{this.amenities}}\</mj-text\>*\
*\<mj-text\>\<span class=\"chip\"\>From {{this.price}}\</span\> \<span
class=\"chip\"\>{{this.slotDates}}\</span\>\</mj-text\>*\
*\<mj-button href=\"{{this.link}}\"\>View studio\</mj-button\>*\
*\</mj-column\>*\
*\</mj-section\>*\
*{{/each}}*\
*{{/if}}*\
\
*\<!\-- Rising creators \--\>*\
*{{#if rising.length}}*\
*\<mj-section padding=\"8px 24px\"\>*\
*\<mj-column\>*\
*\<mj-text font-size=\"16px\" font-weight=\"600\"\>Rising
creators\</mj-text\>*\
*\</mj-column\>*\
*\</mj-section\>*\
*{{#each rising}}*\
*\<mj-section padding=\"0 24px 12px\"\>*\
*\<mj-column\>*\
*\<mj-image src=\"{{this.preview}}\" alt=\"{{this.handle}} --- SFW
preview\" padding-bottom=\"8px\" /\>*\
*\<mj-text\>\<strong\>{{this.handle}}\</strong\>\<br/\>{{this.roles}}\</mj-text\>*\
*\<mj-text\>\<span class=\"chip\"\>Verified\</span\> \<span
class=\"chip\"\>{{this.cityArea}}\</span\>\</mj-text\>*\
*\<mj-button href=\"{{this.link}}\"\>View profile\</mj-button\>*\
*\</mj-column\>*\
*\</mj-section\>*\
*{{/each}}*\
*{{/if}}*\
\
*\<!\-- Footer \--\>*\
*\<mj-section padding=\"24px\"\>*\
*\<mj-column\>*\
*\<mj-text font-size=\"12px\" color=\"#667085\"\>*\
*You're receiving this because you opted into the {{city}} weekly
digest.*\
*SFW only; no 18+ content is emailed. \<a
href=\"{{unsubLink}}\"\>Unsubscribe\</a\> ·*\
*\<a href=\"{{prefsLink}}\"\>Manage preferences\</a\>*\
*\</mj-text\>*\
*\</mj-column\>*\
*\</mj-section\>*\
\
*\</mj-body\>*\
*\</mjml\>*\

## **1.16-J. MJML --- "Book Again" (7/30/90 variants)**

**Recommended filename/path:** *comms/templates/book_again_7d.mjml*
(copy & tweak for *30d*/*90d*)

*\<mjml\>*\
*\<mj-head\>*\
*\<mj-title\>Ready to book {{spName}} again?\</mj-title\>*\
*\<mj-attributes\>*\
*\<mj-text font-size=\"14px\" line-height=\"20px\" /\>*\
*\</mj-attributes\>*\
*\</mj-head\>*\
*\<mj-body\>*\
*\<mj-section padding=\"16px 24px\"\>*\
*\<mj-column\>*\
*\<mj-text fon

### TD-0100 (tech)

<!-- id: TD-0100 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 360000-364000 -->

riants)**

**Recommended filename/path:** *comms/templates/book_again_7d.mjml*
(copy & tweak for *30d*/*90d*)

*\<mjml\>*\
*\<mj-head\>*\
*\<mj-title\>Ready to book {{spName}} again?\</mj-title\>*\
*\<mj-attributes\>*\
*\<mj-text font-size=\"14px\" line-height=\"20px\" /\>*\
*\</mj-attributes\>*\
*\</mj-head\>*\
*\<mj-body\>*\
*\<mj-section padding=\"16px 24px\"\>*\
*\<mj-column\>*\
*\<mj-text font-size=\"20px\" font-weight=\"600\"\>Re-book
{{spName}}\</mj-text\>*\
*\<mj-text\>We pre-filled your last package and scope. Pick a date, and
you're done.\</mj-text\>*\
*\</mj-column\>*\
*\</mj-section\>*\
\
*\<mj-section padding=\"0 24px 12px\"\>*\
*\<mj-column\>*\
*\<mj-image src=\"{{previewUrl}}\" alt=\"{{spName}} --- SFW preview\"
/\>*\
*\<mj-text\>\<strong\>Last package:\</strong\> {{packageName}} ---
{{packagePrice}}\</mj-text\>*\
*\<mj-button href=\"{{draftCheckoutLink}}\"\>Open draft
checkout\</mj-button\>*\
*\</mj-column\>*\
*\</mj-section\>*\
\
*\<mj-section padding=\"16px 24px\"\>*\
*\<mj-column\>*\
*\<mj-text font-size=\"12px\" color=\"#667085\"\>*\
*To stop these reminders for this provider, \<a
href=\"{{stopLink}}\"\>click here\</a\>.*\
*\</mj-text\>*\
*\</mj-column\>*\
*\</mj-section\>*\
*\</mj-body\>*\
*\</mjml\>*\

## **1.16-K. HTML/CSS --- Link-in-Bio microsite (SFW previews)**

**Recommended filename/path:** *web/linkinbio/template.html*

*\<!doctype html\>*\
*\<html lang=\"en\"\>*\
*\<head\>*\
*\<meta charset=\"utf-8\" /\>*\
*\<meta name=\"viewport\" content=\"width=device-width,
initial-scale=1\" /\>*\
*\<title\>{{handle}} --- Link-in-Bio\</title\>*\
*\<style\>*\
*:root{ \--bg:#0e1116; \--card:#151a21; \--text:#e7edf5;
\--muted:#9aa6b2; \--brand:#ECC540; }*\
*body{ margin:0; background:var(\--bg); color:var(\--text); font:
16px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
Arial, sans-serif; }*\
*.wrap{ max-width:780px; margin:0 auto; padding:28px 16px; }*\
*.profile{ display:flex; gap:16px; align-items:center; }*\
*.avatar{ width:72px; height:72px; border-radius:999px;
object-fit:cover; border:2px solid var(\--brand); }*\
*.handle{ font-size:20px; font-weight:600; }*\
*.chip{ display:inline-block; background:#212833; border:1px solid
#2a3442; padding:4px 10px; border-radius:999px; font-size:12px;
margin-right:6px; }*\
*.grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit,
minmax(220px,1fr)); margin-top:16px; }*\
*.card{ background:var(\--card); border:1px solid #222b36;
border-radius:16px; padding:12px; }*\
*.card img{ width:100%; height:160px; object-fit:cover;
border-radius:12px; }*\
*.btn{ display:inline-block; background:var(\--brand); color:#111;
padding:10px 14px; border-radius:12px; font-weight:600;
text-decoration:none; }*\
*.muted{ color:var(\--muted); font-size:13px; }*\
*\</style\>*\
*\</head\>*\
*\<body\>*\
*\<main class=\"wrap\"\>*\
*\<section class=\"profile\"\>*\
*\<img class=\"avatar\" src=\"{{avatarUrl}}\" alt=\"{{handle}}\" /\>*\
*\<div\>*\
*\<div class=\"handle\"\>@{{handle}}\</div\>*\
*\<div class=\"muted\"\>{{city}}\</div\>*\
*{{#if verified}}\<span class=\"chip\"\>Verified\</span\>{{/if}}*\
*{{#each roles}}\<span class=\"chip\"\>{{this}}\</span\>{{/each}}*\
*\</div\>*\
*\</section\>*\
\
*\<section class=\"grid\"\>*\
*\<!\-- Packages \--\>*\
*{{#each packages}}*\
*\<div class=\"card\"\>*\
*\<img src=\"{{this.previewUrl}}\" alt=\"SFW preview for
{{this.name}}\"\>*\
*\<h4\>{{this.name}}\</h4\>*\
*\<p class=\"muted\"\>{{this.description}}\</p\>*\
*\<a class=\"btn\"
href=\"{{this.checkoutLink}}?utm_source=lib&utm_medium=link&utm_campaign=pkg\"\>Book
{{this.price}}\</a\>*\
*\</div\>*\
*{{/each}}*\
\
*\<!\-- Availability \--\>*\
*{{#each availability}}*\
*\<div class=\"card\"\>*\
*\<h4\>Availability: {{this.date}}\</h4\>*\
*\<p class=\"muted\"\>{{this.window}}\</p\>*\
*\<a class=\"btn\"
href=\"{{this.bookLink}}?utm_source=lib&utm_medium=link&utm_campaign=avail\"\>Request\</a\>*\
*\</div\>*\
*{{/each}}*\
*\</section\>*\
\
*\<p class=\"muted\" style=\"margin-top:1

### TD-0101 (tech)

<!-- id: TD-0101 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 363600-367600 -->

\>*\
*\</div\>*\
*{{/each}}*\
\
*\<!\-- Availability \--\>*\
*{{#each availability}}*\
*\<div class=\"card\"\>*\
*\<h4\>Availability: {{this.date}}\</h4\>*\
*\<p class=\"muted\"\>{{this.window}}\</p\>*\
*\<a class=\"btn\"
href=\"{{this.bookLink}}?utm_source=lib&utm_medium=link&utm_campaign=avail\"\>Request\</a\>*\
*\</div\>*\
*{{/each}}*\
*\</section\>*\
\
*\<p class=\"muted\" style=\"margin-top:16px\"\>*\
*Previews are SFW. For 18+ material, Safe-Mode must be OFF and
age-verified in app.*\
*\</p\>*\
*\</main\>*\
*\</body\>*\
*\</html\>*\

## **1.16-L. ANY/ALL Query Builder --- Typesense/OpenSearch spec**

**Recommended filename/path:** *search/spec/any_all_query_builder.md*

*Goal*\
*Support saved searches with (ANY OR ALL) filter groups over
people/studios while enforcing Safe-Mode.*\
\
*Input*\
*queryJson:*\
*{*\
*\"any\": \[*\
*{\"field\":\"roleFields.genres\",\"op\":\"in\",\"value\":\[\"fashion\",\"editorial\"\]},*\
*{\"field\":\"verification.id\",\"op\":\"eq\",\"value\":true}*\
*\],*\
*\"all\": \[*\
*{\"field\":\"city\",\"op\":\"eq\",\"value\":\"Houston\"},*\
*{\"field\":\"priceFromCents\",\"op\":\"between\",\"value\":\[10000,30000\]}*\
*\]*\
*}*\
\
*Algorithm (Typesense flavor)*\
* - Base filters: city:={{city}} AND isPublished:=true AND
safeModeBandMax:\<= {{safeMode?1:2}}*\
* - Build ANY clause:*\
* - Map each criterion to Typesense filter expression:*\
*\* in: field:=\[v1, v2, \...\]*\
*\* eq: field:=value*\
*\* between: field:\>={{lo}} && field:\<={{hi}}*\
* - ANY -\> join with \" \|\| \"*\
* - Build ALL clause: same mapping, join with \" && \"*\
* - Combined: base && ( (ANY) \|\| true_if_any_empty ) && (ALL)*\
* - Sorting: text match score, geo distance, repScore, verifyBoost,
priceFit*\
* - Pagination: cursor API; record query_hash for analytics and
dedupe.*\
\
*OpenSearch variant*\
* - Translate to bool query:*\
*{*\
*\"bool\": {*\
*\"filter\": \[*\
*{\"term\":{\"city\":\"houston\"}},*\
*{\"term\":{\"isPublished\":true}},*\
*{\"range\":{\"safeModeBandMax\":{\"lte\": safeMode?1:2}}}*\
*\],*\
*\"must\": \[ \...ALL\... \],*\
*\"should\": \[ \...ANY\... \],*\
*\"minimum_should_match\": {{ANY? 1 : 0}}*\
*}*\
*}*\

## **1.16-M. UTM & Attribution Rules**

**Recommended filename/path:** *growth/utm_attribution_rules.md*

*UTM structure*\
*utm_source = one of: lib (link-in-bio), sharecard, digest, alert*\
*utm_medium = email \| inapp \| web*\
*utm_campaign = pkg \| avail \| city_digest \| book_again_7 \|
book_again_30 \| book_again_90 \| referral*\
\
*Click tokens*\
*token = HMAC(k, user_id \| ts \| target) \# 5-minute TTL*\
*Store click event -\> attribute conversion to last non-expired click
within 7 days.*\
\
*Attribution in §1.13*\
* - fact_clicks (Silver) join to fact_conversions (checkout.confirmed)
by user_id within window.*\
* - Gold KPI: by (utm_source, utm_campaign), city, role.*\

## **1.16-N. Lambda Skeleton --- Weekly Digest**

**Recommended filename/path:** *apps/functions/growthWeeklyDigest.ts*

*// growthWeeklyDigest.ts*\
*import { pickDigestBlocks } from \'../lib/digestBlocks\';*\
*import { sendEmail } from \'../lib/ses\';*\
*import { createInApp } from \'../lib/inapp\';*\
*import { getOptedInUsersByCity } from \'../lib/digestRepo\';*\
\
*export const handler = async () =\> {*\
*const cities = await getDigestCities();*\
*for (const city of cities) {*\
*const users = await getOptedInUsersByCity(city);*\
*const blocks = await pickDigestBlocks(city); // { caseStudies, studios,
rising }*\
*for (const u of users) {*\
*await createInApp(u.userId, \'weekly_digest\', { city, blocks });*\
*await sendEmail({*\
*toUserId: u.userId,*\
*template: \'weekly_city_digest\',*\
*vars: { city, \...blocks }*\
*});*\
*}*\
*}*\
*};*\

## **1.16-O. Lambda Skeleton --- Book Again (7/30/90)**

**Recommended filename/path:** *apps/functions/growthBookAgain7.ts*
(copy for 30/90)

*// growthBookAgain7.ts*\
*import { findEligibleRebooks } from \'../lib/rebookRepo\';*\
*import { sendEmail } from \'../lib/ses\';*\
\
*export const handle

### TD-0102 (tech)

<!-- id: TD-0102 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 367200-371200 -->

.userId,*\
*template: \'weekly_city_digest\',*\
*vars: { city, \...blocks }*\
*});*\
*}*\
*}*\
*};*\

## **1.16-O. Lambda Skeleton --- Book Again (7/30/90)**

**Recommended filename/path:** *apps/functions/growthBookAgain7.ts*
(copy for 30/90)

*// growthBookAgain7.ts*\
*import { findEligibleRebooks } from \'../lib/rebookRepo\';*\
*import { sendEmail } from \'../lib/ses\';*\
\
*export const handler = async () =\> {*\
*const reb = await findEligibleRebooks({ daysAgo: 7 });*\
*for (const r of reb) {*\
*await sendEmail({*\
*toUserId: r.buyerId,*\
*template: \'book_again_7d\',*\
*vars: {*\
*spName: r.spName,*\
*packageName: r.packageName,*\
*packagePrice: r.packagePriceFmt,*\
*previewUrl: r.previewUrl,*\
*draftCheckoutLink: r.draftCheckoutLink,*\
*stopLink: r.stopLink*\
*}*\
*});*\
*}*\
*};*\

## **1.16-P. Cost & SLO Guardrails (growth jobs)**

**Recommended filename/path:** *observability/slo/growth-jobs.md*

*SLOs*\
* - Saved-search alert job completes \< 10 min p95; per-user dedupe
strictly 1/day/search.*\
* - Weekly digest job \< 20 min p95 per city cohort.*\
* - Book-again jobs \< 5 min p95 each run.*\
\
*Alarms*\
* - SES bounce/complaint spikes \> 0.3% rolling 24h -\> pause
digest/alerts, in-app only.*\
* - Lambda errors \> 1% or duration p95 \> SLO -\> investigate search
query shapes or batch sizes.*\
* - Dynamo TTL dead-letter \> 100/day -\> inspect dedupe miswrites.*\
\
*Cost*\
* - Prefer in-app notifications when SES threshold near daily cap.*\
* - Batch Typesense/OpenSearch queries for alerts by grouping identical
filters.*

# **§1.17 --- SEO, Web Performance & Content Discovery**

*(URL topology · metadata & canonicalization · JSON‑LD · robots/noindex
& Safe‑Mode · sitemaps · hreflang · ISR/SSR caching · Core Web Vitals
budgets · a11y synergy · admin content ops · telemetry · tests · cost)*

**Purpose.** Make the marketplace discoverable while keeping costs down
and content safe. This section defines *exactly* how we structure URLs,
metadata, structured data, crawlers access, internationalization
signals, build & caching strategy, performance budgets, admin workflows,
and monitoring---plus copy‑pasteable artifacts for your Word plan.

## **1.17.A Canon & invariants**

1763. **SFW on the open web.** Public pages show *SFW previews only*.
      Age‑gated/18+ content never leaves the app; no email with 18+
      previews.
1764. **Single canonical per concept.** Every profile, studio, case
      study, and city page has one canonical URL; alternates
      (share/UTM/tracking) 301 to the canonical.
1765. **Server‑rendered entry, cached at the edge.** We use Next.js
      **ISR/SSR** with CloudFront caching and smart revalidation (low
      cost).
1766. **Robots are guests, not owners.** We invite indexing of SFW
      listings and guides; we set *noindex* on anything gated,
      duplicated, or ephemeral (drafts, filters, session pages).
1767. **Accessibility improves SEO.** Headings, landmarks, alt text, and
      readable copy are mandatory---no image‑only text.

## **1.17.B URL topology (stable, human‑readable)**

**People (Service Profiles)**

- */p/{handle}* (canonical)
- */p/{handle}/packages/{slug}* (canonical for package detail)
- */p/{handle}?utm\_\** → 301 → */p/{handle}*

**Studios**

- */s/{slug}* (studio listing)
- */s/{slug}/rates* (rate table, SFW)

**Cities & discovery**

- */city/{city-slug}* --- city hub (SFW)
- */city/{city-slug}/people* --- SFW grid (server‑filtered)
- */city/{city-slug}/studios* --- SFW studios list
- */stories/{slug}* --- case studies/guides (SFW hero)

**System**

- */robots.txt*, */sitemap.xml* (+ segmented sitemaps)
- */legal/{tos\|privacy\|dmca}* (indexable)
- */help/\** (indexable FAQ)
- Anything transactional (*/checkout*, */messages*, */admin*) →
  *noindex, nofollow*.

## **1.17.C Metadata & canonicalization**

- **Required** ***\<head\>*** **tags per page:**

  - *\<title\>* unique, ≤60 chars; *\<meta name=\"description\"\>* ≤160
    chars.
  - \<link rel=\"canonical\" href=\"

### TD-0103 (tech)

<!-- id: TD-0103 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 370800-374800 -->

ml* (+ segmented sitemaps)
- */legal/{tos\|privacy\|dmca}* (indexable)
- */help/\** (indexable FAQ)
- Anything transactional (*/checkout*, */messages*, */admin*) →
  *noindex, nofollow*.

## **1.17.C Metadata & canonicalization**

- **Required** ***\<head\>*** **tags per page:**

  - *\<title\>* unique, ≤60 chars; *\<meta name=\"description\"\>* ≤160
    chars.
  - \<link rel=\"canonical\" href=\"...\"\>
  - OpenGraph (*og:title*, *og:description*, *og:image* SFW, *og:url*,
    *og:type*)
  - Twitter Card (*summary_large_image*)
  - Preconnect only to first‑party + Stripe (at checkout), never to ad
    CDNs.

- **Tracking query params** (*utm\_\**, *ref*) are stripped by a Next.js
  middleware and 301 to canonical (no duplicate content).

- **Case studies** use Article OG tags (*article:published_time*,
  *article:tag*).

## **1.17.D JSON‑LD structured data (copy‑paste)**

**Recommended path:** *web/seo/snippets.md* *(inline in the plan; later
lift to helper functions)*

### **D.1 Service Profile as** ***Person***** +** ***Product*** **(package)**

*\<script type=\"application/ld+json\"\>*\
*{*\
*\"@context\": \"*[*https://schema.org*](https://schema.org)*\",*\
*\"@type\": \"Person\",*\
*\"name\": \"{{displayName}}\",*\
*\"url\":
\"*[*https://rastup.com/p/{{handle*](https://rastup.com/p/%7b%7bhandle)*}}\",*\
*\"jobTitle\": \"{{primaryRole}}\",*\
*\"image\": \"{{sfwAvatarUrl}}\",*\
*\"knowsAbout\": {{json roles}},*\
*\"address\": { \"@type\": \"PostalAddress\", \"addressLocality\":
\"{{city}}\", \"addressRegion\": \"{{region}}\", \"addressCountry\":
\"{{country}}\" }*\
*}*\
*\</script\>*\
\
*\<script type=\"application/ld+json\"\>*\
*{*\
*\"*[*\@context\":\"https://schema.org*]()*\",*\
*\"@type\":\"Product\",*\
*\"name\":\"{{packageName}}\",*\
*\"image\":\[\"{{sfwPackagePreview1}}\",\"{{sfwPackagePreview2}}\"\],*\
*\"description\":\"{{sfwShortDesc}}\",*\
*\"brand\":{\"@type\":\"Brand\",\"name\":\"{{displayName}}\"},*\
*\"offers\":{*\
*\"@type\":\"Offer\",*\
*\"priceCurrency\":\"{{currency}}\",*\
*\"price\":\"{{priceDecimal}}\",*\
*\"availability\":\"https://schema.org/InStock\",*\
*\"url\":\"https://rastup.com/p/{{handle}}/packages/{{slug}}\"*\
*}*\
*}*\
*\</script\>*\

### **D.2 Studio as** ***LocalBusiness***

*\<script type=\"application/ld+json\"\>*\
*{*\
*\"*[*\@context\":\"https://schema.org*]()*\",*\
*\"@type\":\"LocalBusiness\",*\
*\"name\":\"{{studioName}}\",*\
*\"url\":\"https://rastup.com/s/{{slug}}\",*\
*\"image\":\[\"{{sfwPreview1}}\",\"{{sfwPreview2}}\"\],*\
*\"address\":{\"@type\":\"PostalAddress\",\"streetAddress\":\"{{shortAddr}}\",\"addressLocality\":\"{{city}}\",\"addressRegion\":\"{{region}}\",\"postalCode\":\"{{zip}}\",\"addressCountry\":\"{{country}}\"},*\
*\"amenityFeature\":\[*\
*{\"@type\":\"LocationFeatureSpecification\",\"name\":\"Natural
light\",\"value\":{{hasNaturalLight}}},*\
*{\"@type\":\"LocationFeatureSpecification\",\"name\":\"Cyc
wall\",\"value\":{{hasCycWall}}}*\
*\],*\
*\"priceRange\":\"{{priceHint}}\"*\
*}*\
*\</script\>*\

### **D.3 Guides/Case Studies as** ***Article***

*\<script type=\"application/ld+json\"\>*\
*{*\
*\"*[*\@context\":\"https://schema.org*]()*\",*\
*\"@type\":\"Article\",*\
*\"headline\":\"{{title}}\",*\
*\"image\":\[\"{{sfwHero}}\"\],*\
*\"datePublished\":\"{{publishedISO}}\",*\
*\"author\":{\"@type\":\"Organization\",\"name\":\"RastUp\"},*\
*\"mainEntityOfPage\":\"https://rastup.com/stories/{{slug}}\"*\
*}*\
*\</script\>*\

**Rule:** JSON‑LD images must be **SFW previews** only.

## **1.17.E Robots, Safe‑Mode, and** ***noindex*** **policy**

**robots.txt (template)**\
**Recommended path:** *web/public/robots.txt*

*User-agent: \**\
*Disallow: /admin/*\
*Disallow: /messages/*\
*Disallow: /checkout/*\
*Disallow: /\_next/*\
*Disallow: /\*?\**\
*Allow: /\$* \
*Allow: /city/*\
*Allow: /p/*\
*Allow: /s/*\
*Sitemap:*
[*https://rastup.com/sitemap.xml*](https://rastup.com/sitemap.xml)

**X‑Robots‑Tag headers**

- Add *x-robots-tag: noindex, nofollow* to: drafts, preview routes

### TD-0104 (tech)

<!-- id: TD-0104 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 374400-378400 -->

mended path:** *web/public/robots.txt*

*User-agent: \**\
*Disallow: /admin/*\
*Disallow: /messages/*\
*Disallow: /checkout/*\
*Disallow: /\_next/*\
*Disallow: /\*?\**\
*Allow: /\$* \
*Allow: /city/*\
*Allow: /p/*\
*Allow: /s/*\
*Sitemap:*
[*https://rastup.com/sitemap.xml*](https://rastup.com/sitemap.xml)

**X‑Robots‑Tag headers**

- Add *x-robots-tag: noindex, nofollow* to: drafts, preview routes,
  filtered result pages with query params, any page with *nsfw_band \>=
  2* assets, and takedowns (DMCA).
- When Safe‑Mode is ON for a user, we still index the public SFW page;
  no 18+ assets are exposed in HTML/JSON‑LD.

## **1.17.F Sitemaps (segmented, auto‑rotating)**

**Recommended path:** *web/pages/sitemap.xml.ts* *(ISR function)*

- **Sitemap Index** */sitemap.xml* lists child maps:

  - */sitemaps/people-0.xml*, */sitemaps/people-1.xml*, ... (sharded by
    hash)
  - */sitemaps/studios-0.xml*, ...
  - */sitemaps/cities.xml*, */sitemaps/stories.xml*

- **lastmod** from *updated_at*; **changefreq** = *weekly* for
  people/studios, *daily* for cities during launch, *monthly* later.

- Exclude de‑published, unverified, or NSFW‑blocked pages.

**Example child sitemap XML**

*\<?xml version=\"1.0\" encoding=\"UTF-8\"?\>*\
*\<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\"\>*\
*\<url\>*\
*\<loc\>https://rastup.com/p/{{handle}}\</loc\>*\
*\<lastmod\>{{updatedISO}}\</lastmod\>*\
*\<changefreq\>weekly\</changefreq\>*\
*\<priority\>0.8\</priority\>*\
*\</url\>*\
*\</urlset\>*\

## **1.17.G Hreflang & locale routing**

- Default locale *en-US*. Add hreflang alternates when we add
  translations:

  - *\<link rel=\"alternate\" hreflang=\"en\" href=\"...\"\>*, *\<link
    rel=\"alternate\" hreflang=\"es\" href=\"...\"\>*, plus *x-default*.

- URL policy: keep canonical paths without locale prefix; inject
  *hreflang* only (simplifies link sharing).

- Next.js middleware detects *Accept‑Language*, sets *lang* and *dir* on
  *\<html\>*, and formats dates/currency per locale.

**Snippet (Next.js, concept)**\
**Recommended path:** *web/middleware.ts* *(doc block)*

*export function middleware(req: NextRequest) {*\
*const locale = negotiateLocale(req.headers.get(\'accept-language\'));*\
*const res = NextResponse.next();*\
*res.headers.set(\'x-lang\', locale.lang);*\
*res.headers.set(\'x-dir\', locale.dir); // ltr/rtl*\
*return res;*\
*}*\

## **1.17.H Rendering strategy & caching (ISR/SSR + CDN)**

- **People/Studios pages**: ISR with *revalidate: 86400* (24h) on
  low‑change fields; **on‑demand revalidation** when profile edits
  publish.
- **City pages**: ISR, *revalidate: 21600* (6h) at launch → 24h later.
- **Stories**: static at publish; republish on edit.
- **Edge cache**: CloudFront cache policy keyed by *Accept‑Language* and
  *Cookie* *only for Safe‑Mode* flag (avoid leaking modes).
- **Stale‑while‑revalidate** for instant TTFB.
- **ETag** for JSON APIs used by static props.

## **1.17.I Core Web Vitals & performance budgets**

**Targets (P75 on mobile):**

- **LCP ≤ 2.5s**, **CLS ≤ 0.10**, **INP ≤ 200ms**, **TTFB ≤ 800ms**.

**Levers:**

- Use Next/Image for responsive SFW previews; WebP/AVIF; lazy + priority
  on hero.
- Inline **critical CSS** for above‑the‑fold; remove unused CSS via
  CSS‑in‑JS extraction.
- Code‑split heavy modules (editor, charts) behind dynamic import.
- Preconnect to our CDN and Stripe (checkout pages only).
- Ship system fonts or 1 local WOFF2 with *font-display: swap*.
- Avoid blocking analytics; send beacons via *navigator.sendBeacon* to
  our */collect* endpoint.
- Only 1 external script allowed on public pages: the consented
  analytics shim (first‑party). No ad trackers.

**Lighthouse CI budget (inline)**\
**Recommended path:** *observability/budgets/lighthouse-budget.json*

*{*\
*\"resourceSizes\": \[*\
*{\"resourceType\": \"script\", \"budget\": 160},*\
*{\"resourceType\": \"total\", \"budget\": 900}*\
*\],*\
*\"resourceCounts\": \[*\
*{\"resourceType\": \"third-party\", \"budget\": 2},

### TD-0105 (tech)

<!-- id: TD-0105 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 378000-382000 -->

 public pages: the consented
  analytics shim (first‑party). No ad trackers.

**Lighthouse CI budget (inline)**\
**Recommended path:** *observability/budgets/lighthouse-budget.json*

*{*\
*\"resourceSizes\": \[*\
*{\"resourceType\": \"script\", \"budget\": 160},*\
*{\"resourceType\": \"total\", \"budget\": 900}*\
*\],*\
*\"resourceCounts\": \[*\
*{\"resourceType\": \"third-party\", \"budget\": 2},*\
*{\"resourceType\": \"total\", \"budget\": 90}*\
*\],*\
*\"timings\": \[*\
*{\"metric\": \"interactive\", \"budget\": 3500},*\
*{\"metric\": \"first-contentful-paint\", \"budget\": 1800}*\
*\]*\
*}*\

## **1.17.J Accessibility synergy (SEO + a11y)**

- Semantic headings (*h1* unique), landmarks (*header/main/nav/footer*),
  and visible skip‑links.
- All images have **alt**; decorative images *alt=\"\"*.
- Focus outlines enabled; keyboard navigation through interactive
  components; ARIA on custom controls (carousels/cards).
- Color contrast ≥ 4.5:1 for text, 3:1 for large text/icons.
- Descriptive link text ("View studio details"), not "click here".
- Media captions for videos; transcripts for long videos in stories.

## **1.17.K Admin content ops & safeguards**

- **Publish workflow**: drafts → preview (noindex) → publish
  (indexable).
- **Link checker**: nightly job crawls published stories, flags
  404s/5xx.
- **Search Console & Bing Webmaster**: XML verification, sitemaps
  auto‑submit at deploy.
- **DMCA integration**: hidden content adds *x-robots-tag: noindex* and
  is removed from sitemaps on next run.
- **Sharecard sanity**: ensure OG images are SFW versions only.

## **1.17.L Telemetry & dashboards**

- **Core Web Vitals (field)**: RUM beacon reports LCP/CLS/INP by route,
  device, city; dashboard in QuickSight.
- **Crawl health**: sitemap submission status, indexed pages over time,
  top coverage errors (ingested via Search Console API exporter).
- **SEO funnel**: impressions → clicks → profile views → checkout start
  → confirmation (hooked into §1.13).
- **Alerting**: LCP regression \> 10% WoW on top city pages, spike in
  non‑200 response ratio, robots blocking anomalies.

## **1.17.M Test plan (CI + stage)**

1821. **Lighthouse CI** on PRs for */*, */city/{city}*, */p/{handle}*,
      */s/{slug}*, */stories/{slug}*; budgets enforced.
1822. **Structured data** validates
      (Person/Product/LocalBusiness/Article) with schema validator;
      image URLs SFW.
1823. **Canonical/redirects**: UTM/ref variants 301 to canonical; no
      duplicate indexation.
1824. **Robots/noindex**: drafts, filters, admin, checkout and DMCA
      pages return *x-robots-tag: noindex*.
1825. **Sitemaps**: contain only published SFW pages; child sitemaps \<
      50k URLs; index lists all children.
1826. **Hreflang** (when enabled): alternates present and correct.
1827. **A11y**: axe/Pa11y suite passes; keyboard nav end‑to‑end on
      public pages.
1828. **Perf**: p75 CWV targets met under synthetic 3G.

## **1.17.N Cost posture**

- **Edge caching** with ISR keeps SSR compute near‑zero for stable
  pages.
- **Static image transforms** for SFW previews; avoid runtime
  transformations for public pages when possible.
- **No third‑party SEO SaaS** at launch; rely on Search Console/Bing
  free tools; Lighthouse CI self‑hosted runner.
- **Sharecard worker** concurrency capped; aggressively cache results.

## **1.17.O Inline artifacts block**

**O.1 robots.txt** (see §1.17.E)\
**O.2 sitemap child template** (see §1.17.F)\
**O.3 JSON‑LD snippets** (see §1.17.D)\
**O.4 Lighthouse budget JSON** (see §1.17.I)\
**O.5 Next.js middleware snippet** (see §1.17.G)

Copy these directly into your Word doc under an "Artifacts" subheading.

## **1.17.P Acceptance criteria --- mark §1.17 FINAL only when ALL true**

1833. Canonical URL policy implemented; UTM/ref routes 301 correctly.
1834. JSON‑LD present on People, Packages, Studios, and Stories with SFW
      images only.
1835. robots/noindex enforced for drafts, gated/NSFW, filters, admin,
      and checko

### TD-0106 (tech)

<!-- id: TD-0106 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 381600-385600 -->

G)

Copy these directly into your Word doc under an "Artifacts" subheading.

## **1.17.P Acceptance criteria --- mark §1.17 FINAL only when ALL true**

1833. Canonical URL policy implemented; UTM/ref routes 301 correctly.
1834. JSON‑LD present on People, Packages, Studios, and Stories with SFW
      images only.
1835. robots/noindex enforced for drafts, gated/NSFW, filters, admin,
      and checkout routes.
1836. Segmented sitemaps generate & auto‑submit; include only indexable
      pages; refresh cadence set.
1837. Hreflang in place when we enable additional locales; default *en*
      with *x-default*.
1838. ISR/SSR caching + CloudFront policies deliver p75 **LCP ≤ 2.5s**,
      **CLS ≤ 0.10**, **INP ≤ 200ms** on top routes.
1839. a11y checks pass (axe/Pa11y) on public routes; alt text coverage ≥
      99%.
1840. Dashboards show CWV trends, crawl health, and the SEO funnel;
      alerts configured for regressions.
1841. Costs stay within budgets (no third‑party bloat; edge cache hit
      ratio ≥ 90%).

# **§1.17 --- SEO & On‑Site Optimization Deep‑Dive (Expanded)**

## **1.17.1 Crawl & Indexation Control (robots, meta, headers)**

**Goals:** Maximize crawl efficiency on **indexable SFW pages**, prevent
indexing of **gated/duplicate/thin** pages, and make crawler behavior
cheap.

**Policies**

- **Indexable:** Home, City & Role hubs, Search (unfiltered landing
  variants only), Service Profiles (non‑adult), Studios, Case
  Studies/Guides, Legal/Help.
- **Noindex:** age‑gated or login‑required pages; any URL with tracking
  params; filter‑heavy result pages; drafts/preview;
  checkout/messages/admin; duplicate "print/share" variants.
- **Disallow (robots.txt):** */admin/*, */messages/*, */checkout/*,
  internal asset routes, *\_next/*.

**Artifacts**

**A) robots.txt (inline)**\
*Recommended path:* *web/public/robots.txt*

*User-agent: \**\
*Disallow: /admin/*\
*Disallow: /messages/*\
*Disallow: /checkout/*\
*Disallow: /\_next/*\
*Disallow: /\*?\* \# parameters not for indexing*\
*Allow: /\$*\
*Allow: /city/*\
*Allow: /studios*\
*Allow: /studio/*\
*Allow: /models*\
*Allow: /photographers*\
*Allow: /videographers*\
*Allow: /creators*\
*Sitemap:*
[*https://rastup.com/sitemap.xml*](https://rastup.com/sitemap.xml)

**B) X‑Robots‑Tag header policy (server)**\
*Recommended path:* *web/lib/robots.ts* (pseudocode)

*export function robotsHeaderFor(req, page) {*\
*if (page.isAdult \|\| page.requiresLogin \|\| page.isPreview) return
\"noindex, nofollow, noarchive\";*\
*if (req.url.includes(\"?\")) return \"noindex, follow\"; //
filter/param variants are non-canonical*\
*return \"index, follow\";*\
*}*\

**C)** ***\<meta name=\"robots\"\>*** **fallback (HTML)**\
Add a server‑generated *\<meta name=\"robots\" content=\"\...\"\>*
mirroring the header on all public templates.

## **1.17.2 Canonicalization & URL Normalization**

**Rules**

- **Single canonical per entity** (profile */p/{handle}*, studio
  */s/{slug}*, package */p/{handle}/packages/{slug}*).
- Strip ***utm\_\******,** ***ref*****, session and cache‑busting**
  params via 301 to canonical.
- Normalize: lowercase paths, **no trailing slash** (choose one; below
  assumes none), collapse multiple slashes, decode percent‑encoding.
- City context for hubs: canonical as **query param**
  (*/models?city=houston*), not path segments---prevents duplicate city
  pages.

**Artifacts**

**A) Canonical redirect middleware (Next/Edge pseudocode)**\
*Recommended path:* *web/middleware.ts*

*const CANON_QP_BLOCKLIST =
\[\"utm_source\",\"utm_medium\",\"utm_campaign\",\"utm_term\",\"utm_content\",\"ref\",\"gclid\",\"fbclid\"\];*\
*export function middleware(req) {*\
*const url = new URL(req.nextUrl);*\
*// Normalize case and trailing slash*\
*url.pathname =
url.pathname.toLowerCase().replace(/\\/+\$/,\'\').replace(/\\/{2,}/g,\'/\');*\
*// Strip tracking params*\
*for (const p of CANON_QP_BLOCKLIST) url.searchParams.delete(p);*\
*// If changed, 301 to canonical*\
*if (url.toString() !== req.ne

### TD-0107 (tech)

<!-- id: TD-0107 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 385200-389200 -->

ef\",\"gclid\",\"fbclid\"\];*\
*export function middleware(req) {*\
*const url = new URL(req.nextUrl);*\
*// Normalize case and trailing slash*\
*url.pathname =
url.pathname.toLowerCase().replace(/\\/+\$/,\'\').replace(/\\/{2,}/g,\'/\');*\
*// Strip tracking params*\
*for (const p of CANON_QP_BLOCKLIST) url.searchParams.delete(p);*\
*// If changed, 301 to canonical*\
*if (url.toString() !== req.nextUrl.toString()) return
Response.redirect(url, 301);*\
*return;*\
*}*\

**B) Canonical link builder (server)**\
*Recommended path:* *web/lib/canonical.ts*

*export const canonicalFor = (entity) =\>*\
*entity.kind === \"person\" ?
\`https://rastup.com/\${entity.role}/\${entity.slug}\` :*\
*entity.kind === \"studio\" ?
\`https://rastup.com/studio/\${entity.slug}\` :*\
*entity.kind === \"package\" ?
\`https://rastup.com/\${entity.role}/\${entity.slug}/packages/\${entity.pkgSlug}\`
:*\
*\`https://rastup.com/\`;*\

## **1.17.3 Faceted Navigation, Pagination & Filters**

**Objective:** Let users filter richly **without** creating an
indexation explosion.

**Approach**

- **Indexable landing** per role/city **without filters** (e.g.,
  */models?city=houston*).
- **Non‑indexable** filter combinations (e.g., price/amenities) → keep
  crawlable links but serve *noindex, follow* and **self‑canonical** to
  the landing variant.
- Pagination: *?page=2* allowed but **noindex**; canonical to page 1
  landing. Avoid *rel=prev/next* (deprecated); use strong internal links
  instead.

**Artifact --- filter allowlist**\
*Recommended path:* *search/spec/filter-allowlist.md*

*Indexable: (role + city) only*\
*Non-indexable: any additional filters (price, amenity, availability,
verification, rating, etc.) =\> meta robots noindex, self-canonical to
landing*\
*Pagination: ?page=N =\> meta robots noindex, canonical to page=1*\

## **1.17.4 Structured Data (JSON‑LD) --- Full Coverage**

**Entity → schema.org type map**

- **People (Service Profiles)**: *Person* + *Offer*(s) for packages;
  optional *AggregateRating* when policy allows.
- **Studios**: *LocalBusiness* with *amenityFeature*; optional
  *AggregateRating*.
- **Case Studies/Guides**: *Article*/*CreativeWork*.
- **Breadcrumbs**: *BreadcrumbList* on all public pages.
- **Search results** (optional enhancement): *ItemList* on landing
  pages.

**Artifacts**

**A) BreadcrumbList**\
*Recommended path:* *web/lib/ldjson/breadcrumb.ts*

*export const breadcrumbLd = (trail) =\> ({*\
*\"@context\": \"*[*https://schema.org*](https://schema.org)*\",*\
*\"@type\": \"BreadcrumbList\",*\
*\"itemListElement\": trail.map((item, i) =\> ({*\
*\"@type\": \"ListItem\", \"position\": i+1, \"name\": item.name,
\"item\": item.url*\
*}))*\
*});*\

**B) Service Profile with Offers & rating**\
*Recommended path:* *web/lib/ldjson/personOffers.ts*

*export const personWithOffersLd = (p) =\> ({*\
*\"@context\": \"*[*https://schema.org*](https://schema.org)*\",*\
*\"@type\": \"Person\",*\
*\"name\": p.displayName,*\
*\"image\": p.og_image_sfw_url,*\
*\"url\": \`https://rastup.com/\${p.role}/\${p.slug}\`,*\
*\"jobTitle\": p.roleTitle,*\
*\"address\": {\"@type\":\"PostalAddress\",\"addressLocality\":
p.city},*\
*\"makesOffer\": p.packages.map(pkg =\> ({*\
*\"@type\":\"Offer\",*\
*\"priceCurrency\": pkg.currency,*\
*\"price\": (pkg.priceCents/100).toFixed(2),*\
*\"url\":
\`https://rastup.com/\${p.role}/\${p.slug}/packages/\${pkg.slug}\`,*\
*\"availability\":\"https://schema.org/InStock\"*\
*})),*\
*\...(p.ratingCount \>= 5 ? {*\
*\"aggregateRating\": {*\
*\"@type\":\"AggregateRating\",*\
*\"ratingValue\": p.rating.toFixed(1),*\
*\"reviewCount\": p.ratingCount*\
*}*\
*} : {})*\
*});*\

**C) Studio with amenity features**\
*(already covered earlier---kept here for completeness; ensure SFW
images)*

## **1.17.5 Content Templates & On‑Page Optimization**

**Title & Description formulas**\
*Recommended path:* *web/seo/title-desc-formulas.md*

*Service Profile (People):*\
*\<title\> {DisplayName} --- {RoleTitle} in {City} \| RastUp
\</ti

### TD-0108 (tech)

<!-- id: TD-0108 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 388800-392800 -->

unt\": p.ratingCount*\
*}*\
*} : {})*\
*});*\

**C) Studio with amenity features**\
*(already covered earlier---kept here for completeness; ensure SFW
images)*

## **1.17.5 Content Templates & On‑Page Optimization**

**Title & Description formulas**\
*Recommended path:* *web/seo/title-desc-formulas.md*

*Service Profile (People):*\
*\<title\> {DisplayName} --- {RoleTitle} in {City} \| RastUp
\</title\>*\
*\<meta name=\"description\" content=\"{Short role tagline}. Packages,
availability, reviews, and verified badges.\" /\>*\
\
*Studio:*\
*\<title\> {StudioName} --- {City} Studio Rental (Amenities & Rates) \|
RastUp \</title\>*\
*\<meta name=\"description\" content=\"{Short studio pitch}. Amenities:
{Top 3}. From {Price}/hr.\" /\>*\
\
*City/Role landing:*\
*\<title\> {RolePlural} in {City} --- Verified & Bookable \| RastUp
\</title\>*\
*\<meta name=\"description\" content=\"Explore {City} {rolePlural}.
Verified portfolios, packages, and studios.\" /\>*\

**Heading & module order (to reduce CLS + maximize relevance)**\
*Recommended path:* *web/seo/page-templates.md*

*Service Profile:*\
*H1: {DisplayName} --- {RoleTitle} in {City}*\
*Intro block (50--80 words, SFW)*\
*Modules (in order): Packages → Portfolio (SFW grid) → Availability →
Reviews → Badges/Verification → Location (city-only hint) → FAQs*\
*Internal links: \"Similar {rolePlural} in {City}\" (3--8 cards),
\"Studios with {top amenity}\" (2--4 cards)*\
\
*Studio Detail:*\
*H1: {StudioName} --- {City}*\
*Intro (amenity-rich; SFW)*\
*Modules: Gallery (SFW) → Rates & Rules → Amenities → Availability/Slots
→ Host → Location (area only) → FAQs*\
*Internal links: \"People recently booked here\" cards*\
\
*City/Role Landing:*\
*H1: {RolePlural} in {City}*\
*Intro paragraph (\~120--160 words, unique)*\
*Modules: Top Verified → New this week → Budget filters → Case Studies
carousel (SFW)*\

**Internal linking rules**

- Every profile and studio page should expose **two blocks** of curated
  internal links: "Similar in {City}" and a cross‑entity block
  (People↔Studios).
- Keep links **crawlable** (no *nofollow*), descriptive anchor text, and
  **stable** across rebuilds (deterministic selection).

## **1.17.6 Image & Video SEO (SFW‑only)**

**Images**

- Filenames: kebab‑case with role/city cues, e.g.,
  *houston-photographer-jane-doe-portrait-01.webp*.
- Always set *width*/*height* to prevent CLS; use *srcset*/*sizes*;
  serve AVIF/WebP with JPEG fallback.
- *alt* text: short literal description; **no keyword stuffing**; for
  decorative images, *alt=\"\"*.
- Lazy‑load below‑the‑fold; **preload** the hero (LCP) image.

**Videos** (case studies, studio tours)

- Use ***VideoObject*** JSON‑LD with SFW poster frames; duration and
  upload date.
- Provide **captions**; avoid auto‑play with sound (INP risk).

**Artifact --- VideoObject JSON‑LD**\
*Recommended path:* *web/lib/ldjson/video.ts*

*export const videoLd = (v) =\> ({*\
*\"@context\": \"*[*https://schema.org*](https://schema.org)*\",*\
*\"@type\": \"VideoObject\",*\
*\"name\": v.title,*\
*\"description\": v.desc,*\
*\"thumbnailUrl\": \[v.posterSfw\],*\
*\"uploadDate\": v.publishedISO,*\
*\"duration\": \`PT\${v.durationSeconds}S\`,*\
*\"contentUrl\": v.hlsPublicPreview*\
*});*\

## **1.17.7 Performance for SEO (CWV‑first Build)**

**Budgets (mobile P75):** LCP ≤ 2.5s, CLS ≤ 0.10, INP ≤ 200ms, TTFB ≤
800ms.

**Tactics**

- Pick an **LCP element** (hero image) per template; preload it with
  *as=image* and *fetchpriority=\"high\"*.
- Inline **critical CSS**; defer the rest; no blocking fonts (local
  WOFF2 + *font-display: swap*).
- **Code‑split** heavy widgets; ship minimal JS on public pages.
- Preconnect only to **our CDN** and **Stripe** (checkout only).
- Serve **stale‑while‑revalidate** via ISR + CloudFront.
- Use **first‑party analytics** via *sendBeacon* (no third‑party bloat).

**Artifact --- Lighthouse CI budget**\
*Recommended path:* *observability/budgets/lighthouse.json*

*{*\
*\"resourceSizes\": \[*\
*{\"resource

### TD-0109 (tech)

<!-- id: TD-0109 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 392400-396400 -->

*Code‑split** heavy widgets; ship minimal JS on public pages.
- Preconnect only to **our CDN** and **Stripe** (checkout only).
- Serve **stale‑while‑revalidate** via ISR + CloudFront.
- Use **first‑party analytics** via *sendBeacon* (no third‑party bloat).

**Artifact --- Lighthouse CI budget**\
*Recommended path:* *observability/budgets/lighthouse.json*

*{*\
*\"resourceSizes\": \[*\
*{\"resourceType\":\"total\", \"budget\": 900},*\
*{\"resourceType\":\"script\", \"budget\": 160}*\
*\],*\
*\"timings\": \[*\
*{\"metric\": \"interactive\", \"budget\": 3500},*\
*{\"metric\": \"first-contentful-paint\", \"budget\": 1800}*\
*\]*\
*}*\

## **1.17.8 Internationalization (hreflang) & Localization**

- Launch locale: **en‑US**; all public pages must set *\<html
  lang=\"en\"\>*.
- **Hreflang scaffolding** in head for future locales; keep canonical
  **without** locale in path; add *\<link rel=\"alternate\"
  hreflang=\"...\"\>* once translations ship.
- Localize **currency/date/number** rendering server‑side for public
  pages; keep URLs stable.

**Artifact --- hreflang helper**\
*Recommended path:* *web/lib/hreflang.ts*

*export const hreflangLinks = (canonical, alts) =\>*\
*alts.map(a =\> \`\<link rel=\"alternate\" hreflang=\"\${a.lang}\"
href=\"\${a.href}\"\>\`).join(\"\\n\")*\
* + \`\\n\<link rel=\"alternate\" hreflang=\"x-default\"
href=\"\${canonical}\"\>\`;*\

## **1.17.9 Accessibility (A11y) Synergy for SEO**

- Semantic structure (landmarks, headings) and **visible focus**.
- Keyboard‑reachable filters/maps; ARIA for tabs/carousels.
- Image **alt** as above; captions/transcripts on videos.
- Error pages with clear next actions; readable contrast (≥4.5:1 body
  text).

## **1.17.10 Sitemaps (Web, Image, Video)**

**Strategy**

- **Index file** */sitemap.xml* linking to segmented sitemaps (People
  A‑Z, Studios by city, Case Studies, Cities).
- **Image sitemaps** for people/studios (SFW thumbnails only).
- **Video sitemap** for case studies with videos.

**Artifact --- Image sitemap entry (template)**\
*Recommended path:* *web/sitemaps/templates/image-url.xml*

*\<url\>*\
*\<loc\>https://rastup.com/studio/{{slug}}\</loc\>*\
*\<image:image\>*\
*\<image:loc\>https://cdn.rastup.com/sfw/{{imageFile}}\</image:loc\>*\
*\<image:title\>{{imageTitle}}\</image:title\>*\
*\<image:caption\>{{imageCaption}}\</image:caption\>*\
*\</image:image\>*\
*\</url\>*\

## **1.17.11 Internal Linking & Breadcrumbs**

- **Breadcrumbs** everywhere (Home → City → Role → Entity).

- In‑content cross‑links:

  - On profiles: "Similar in {City}", "Studios with {Amenity}"
  - On studios: "People recently booked here"

- Avoid link farms; keep blocks 3--8 items; **deterministic** selection.

## **1.17.12 Log‑File Analysis & Search Console Ingestion**

- Export **edge logs** (CloudFront) + **app access logs** to S3; model
  into Athena (§1.13).
- Build **crawl dashboard**: hits by bot UA, 200/3xx/4xx, coverage of
  sitemaps, crawl waste on non‑indexable pages.
- Ingest **GSC** performance/coverage via API to the lake; build SEO
  funnel (impressions→clicks→profile views→checkout).

**Artifact --- Athena table (simplified)**\
*Recommended path:* *data/sql/cf_logs.sql*

*CREATE EXTERNAL TABLE IF NOT EXISTS cf_logs (*\
*dt string, time string, x_edge_location string, sc_status int,
cs_method string,*\
*cs_uri_stem string, cs_uri_query string, cs_user_agent string,
cs_referer string*\
*)*\
*PARTITIONED BY (date string)*\
*ROW FORMAT SERDE
\'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe\'*\
*LOCATION \'s3://logs/cloudfront/\';*\

## **1.17.13 SEO‑Safe Experimentation**

- **No client‑side cloaking**: bots must see a stable, indexable version
  (avoid A/B that changes indexable content for bots only).
- Keep experiments **server‑side** (SSR/ISR) or **non‑indexable** UI
  variations.
- For content experiments (titles, descriptions), roll out by **entity
  cohorts**; revalidate ISR pages on change.

## **1.17.14 Risk Register & Mitigations**

- **Duplicate content

### TD-0110 (tech)

<!-- id: TD-0110 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 396000-400000 -->



- **No client‑side cloaking**: bots must see a stable, indexable version
  (avoid A/B that changes indexable content for bots only).
- Keep experiments **server‑side** (SSR/ISR) or **non‑indexable** UI
  variations.
- For content experiments (titles, descriptions), roll out by **entity
  cohorts**; revalidate ISR pages on change.

## **1.17.14 Risk Register & Mitigations**

- **Duplicate content** via tracking params → mitigated by canonical
  middleware + 301.
- **Faceted crawl bloat** → *noindex, follow* + allowlist +
  self‑canonical.
- **Accidental 18+ leakage** → centralized SFW image service for
  OG/JSON‑LD; tests in CI.
- **Thin pages** (empty profiles) → hold *noindex* until profile meets
  completeness threshold.
- **CLS regressions** → enforce width/height on images; block unstyled
  font flashes.

## **1.17.15 QA Checklists (Pre‑launch & Ongoing)**

**Pre‑launch**

- Canonical/robots tags verified on top templates.
- Sitemaps (web/image/video) present and validate; robots.txt references
  index.
- JSON‑LD validates on 25 sample pages across types.
- Lighthouse p75 budgets met on emulated mobile.
- All OG images SFW; email templates tested for SFW previews.

**Ongoing**

- Weekly crawl dashboard reviewed; non‑indexable hit rate trending down.
- GSC: errors addressed; CTR and position monitored for top city/role
  pages.
- Uptime for ISR revalidation hooks; cache hit ratio ≥95% for public
  pages.

## **1.17.16 Work Packages (Cursor 4‑agent lanes)**

- **Agent A --- Web:** canonical middleware, meta/LD‑JSON injectors,
  templates (title/desc/headers), image/video sitemaps, breadcrumb
  component.
- **Agent B --- API:** SEO resolvers, slug service, ISR revalidation
  hooks, Search Console export cron.
- **Agent C --- Ops:** CloudFront behaviors, logs→S3→Athena pipeline,
  robots/noindex header policy, cache keys.
- **Agent D --- QA/Perf:** Lighthouse CI, JSON‑LD tests, SFW OG guard,
  crawl dashboards, a11y audits.

## **1.17.17 Acceptance Criteria (mark §1.17 FINAL only when ALL true)**

1907. Canonical URLs, robots **headers + meta**, and parameter stripping
      are live; filter/pagination pages are **noindex** and
      self‑canonical.
1908. City/role landings exist and are indexable; hubs and detail pages
      have **SFW OG** images; age‑gated items are **noindex**.
1909. JSON‑LD present and valid for Person(+Offers), LocalBusiness,
      Article, BreadcrumbList, and (where applicable) VideoObject.
1910. Segmented **web + image + video sitemaps** generate correctly and
      reference only indexable content; robots.txt points to the index.
1911. CWV budgets met (p75 mobile) on Home, City/Role landing, Service
      Profile, Studio Detail, and a Case Study page.
1912. A11y checks pass (axe/Pa11y) on public pages; images have alt;
      keyboard navigation functional.
1913. CloudFront logs + GSC are ingested; crawl waste \<10% of bot hits
      after 30 days; cache hit ratio ≥95%.
1914. SEO‑safe experimentation policy enforced; no client‑side cloaking
      or bot‑variant divergence.

# **§1.18 --- Security, Compliance & DevSecOps**

*(zero‑trust architecture · IAM boundaries · authN/authZ for AppSync ·
secrets & key mgmt · encryption in transit/at rest · data classification
& PII minimization · logging/audit & tamper‑evidence · WAF/bot/DDOS
protections · vulnerability mgmt & CI/CD hardening · incident response &
DR · compliance scaffolding · telemetry, SLOs, tests, costs)*

**Purpose.** Define the end‑to‑end security & compliance posture for the
marketplace (web/app, Amplify/AppSync/Lambda/Aurora/DynamoDB/S3/CF,
Stripe/IDV/esign providers), with **implementation‑grade** controls and
inline artifacts you can paste into the plan. This section will not
advance until it satisfies the **≥99.9%** bar.

## **1.18.A Security canon & threat model**

1915. **Least privilege & zero trust.** Every call is authenticated and
      authorized; no "trusted subnet."
1916. **Default‑deny at edges.** WAF blocks obvious bad traff

### TD-0111 (tech)

<!-- id: TD-0111 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 399600-403600 -->

e/IDV/esign providers), with **implementation‑grade** controls and
inline artifacts you can paste into the plan. This section will not
advance until it satisfies the **≥99.9%** bar.

## **1.18.A Security canon & threat model**

1915. **Least privilege & zero trust.** Every call is authenticated and
      authorized; no "trusted subnet."
1916. **Default‑deny at edges.** WAF blocks obvious bad traffic; API
      throttles by identity.
1917. **PII minimization.** Only store what we must; tokenize or hash
      where possible; keep PII out of logs.
1918. **Compartmentalization.** Separate AWS accounts per env
      (dev/stage/prod) and per blast radius (prod‑data, prod‑ops).
1919. **Tamper‑evident audit.** Immutable trails for money/IDV/policy
      actions.
1920. **Idempotence everywhere.** All webhooks & money operations
      idempotent (no double charges).
1921. **Cost aware.** Prefer managed services (Amplify, Cognito,
      AppSync, WAF, Security Hub) over self‑hosted appliances.

## **1.18.B Identity & access management (IAM) boundaries**

**Recommended path:** *security/policies/iam-boundaries.md*

- Accounts & org

  - AWS **Organizations** with SCPs: deny *\*:\** at root, deny public
    S3 unless explicitly allowed, deny KMS key deletion.
  - Separate accounts: *rastup-dev*, *rastup-stage*, *rastup-prod*, plus
    *rastup-shared* (log archive) and *rastup-security*.

- Roles

  - **Workload roles**: per Lambda/service with minimal permissions
    (AppSync resolver roles; S3 prefixes; DynamoDB tables).
  - **Human roles**: *AdminLimited* (break‑glass), *OpsReadOnly*,
    *Analyst*, *SecurityEngineer*. MFA enforced; session limits (1--4h).
  - **JIT elevation** via IAM Identity Center (formerly SSO) with
    approval; all admin actions audited.

**Inline artifact --- example least‑priv Dynamo policy**\
**Path:** *security/iam/policies/dynamo-least-priv.json*

*{*\
*\"Version\":\"2012-10-17\",*\
*\"Statement\":\[*\
*{\"Effect\":\"Allow\",\"Action\":\[\"dynamodb:PutItem\",\"dynamodb:GetItem\",\"dynamodb:UpdateItem\"\],*\
*\"Resource\":\"arn:aws:dynamodb:us-east-1:{{account}}:table/fansub_entitlement_cache\",*\
*\"Condition\":{\"ForAllValues:StringEquals\":{\"dynamodb:LeadingKeys\":\[\"USER#\"\]}}}*\
*\]*\
*}*\

## **1.18.C Authentication & authorization (Amplify/AppSync/Cognito)**

**AuthN**

- **Cognito User Pool** for end‑users (buyers/sellers/creators/studio
  owners) with email+password and optional social IdPs (Apple/Google).
- **Cognito Identity Pool** for federated access to limited S3 (signed
  uploads of previews only).
- **Admin/agent** access via **OIDC** (IdP such as Google
  Workspace/Okta) → separate AppSync auth mode.

**AuthZ (AppSync multi‑auth)**

- **Cognito JWT** for user operations; **IAM** for server‑to‑server;
  **OIDC** for internal tooling.
- Use **\@auth** rules + VTL/JS resolvers to enforce **row‑level**
  constraints (e.g., user can access only their threads, creator their
  own Fan‑Sub pages, admin by role claims).
- **Fine‑grained**: deny by default; allow by ownership (*ownerId ==
  \$ctx.identity.sub*), role claim (*has(\"admin\")*), or entitlement
  check (Dynamo cache read).

**Inline artifact --- AppSync auth modes**\
**Path:** *security/appsync/multi-auth.md*

*- Default Authorization: AMAZON_COGNITO_USER_POOLS*\
*- Additional:*\
* - AWS_IAM (trusted Lambdas + batch jobs)*\
* - OPENID_CONNECT (Admin console only)*\
*- API Key: \*\*disabled\*\* in prod*\

## **1.18.D Secrets & key management**

- **AWS Secrets Manager**: Stripe keys, Plaid (if adopted), e‑sign
  provider tokens, SMTP creds (if not SES), third‑party API tokens.
- **SSM Parameter Store**: non‑secret config (feature flags, limits).
- **KMS**: dedicated CMKs per data domain (*pii*, *finance*, *legal*)
  with **key policies** bound to minimal roles; automatic rotation
  enabled.

**Inline artifact --- Secrets naming convention**\
**Path:** *security/secrets/naming.md*

*/prod/stripe/secret_key*\
*/prod/stripe/webhook_secret*\
*

### TD-0112 (tech)

<!-- id: TD-0112 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 403200-407200 -->

 SES), third‑party API tokens.
- **SSM Parameter Store**: non‑secret config (feature flags, limits).
- **KMS**: dedicated CMKs per data domain (*pii*, *finance*, *legal*)
  with **key policies** bound to minimal roles; automatic rotation
  enabled.

**Inline artifact --- Secrets naming convention**\
**Path:** *security/secrets/naming.md*

*/prod/stripe/secret_key*\
*/prod/stripe/webhook_secret*\
*/prod/plaid/client_id*\
*/prod/plaid/secret*\
*/prod/esign/api_key*\
*/stage/\...*\

## **1.18.E Encryption (in transit & at rest)**

- **TLS 1.2+** everywhere (CloudFront, ALB, AppSync). HSTS on apex.
- **At rest**: S3 SSE‑KMS; DynamoDB SSE‑KMS; Aurora **encrypted**;
  CloudWatch Logs encrypted; Athena workgroup encryption enforced.
- **Field‑level**: hash emails (*sha256(email.lower().trim())*), store
  last‑4 only for phone if needed; avoid plaintext PII in events.
- **Tokenization**: use surrogate keys (*usr\_*, *sp\_*, *fsc\_*) across
  domains.

## **1.18.F Network & edge protections**

- **CloudFront + WAF**:

  - Managed rule sets (AWS Core, Bot Control), plus custom: block
    obvious scanners, rate‑limit */graphql* and POSTs.
  - Allowlist Stripe & provider IPs for webhook ingress (alternate: use
    API Gateway with a shared secret HMAC).

- **AWS Shield Standard** (at least) enabled on CF/ALB.

- **Lambdas**: in VPC only if they need RDS; otherwise public (reduces
  cold‑start & cost). Use **VPC endpoints** for S3/Secrets if inside
  VPC.

**Inline artifact --- WAF rate rule example**\
**Path:** *security/waf/rate-limit-graphql.json*

*{
\"Name\":\"GraphQLRateLimit\",\"RateLimit\":2000,\"ScopeDownStatement\":*\
*{\"ByteMatchStatement\":{\"SearchString\":\"/graphql\",\"FieldToMatch\":{\"UriPath\":{}},\"TextTransformations\":\[{\"Priority\":0,\"Type\":\"NONE\"}\],\"PositionalConstraint\":\"CONTAINS\"}}*\
*}*\

## **1.18.G Data classification & handling**

**Recommended path:** *security/policies/data-classification.md*

- **Public**: marketing copy, SFW previews.
- **Internal**: ops dashboards, aggregate metrics.
- **Confidential PII**: names, emails, phone (minimize; never in logs).
- **Highly Sensitive**: government IDs, IDV artifacts, payment tokens
  (never store raw PAN).\
  **Rules**
- PII only in **Aurora/Dynamo "private"** schemas; analytics **events
  are PII‑free** (link via surrogate keys).
- **DSAR** tombstone events (see §1.13) applied to Silver/Gold; Bronze
  excluded on read.
- **Retention**: per §1.13 --- Bronze 18 mo, Silver 24--36 mo, Gold 24
  mo; finance facts 7 years.

## **1.18.H Logging, audit, and tamper‑evidence**

- **CloudTrail** to dedicated **log‑archive account** (S3 with **Object
  Lock** + Glacier).
- **App logs**: JSON, structured, **no PII**. Correlation IDs propagate
  (*x‑corr‑id*).
- **Admin actions** (refunds, holds, DMCA, representment) write to an
  **immutable audit table** (Aurora) and **append‑only** S3 log (WORM).
- **Webhook idempotency**: record *event_id* + response; on duplicate →
  200 OK no‑op.

**Inline artifact --- audit event shape**\
**Path:** *security/audit/event-envelope.json*

*{*\
*\"ts\":\"2025-11-06T12:34:56Z\",*\
*\"actor\":\"usr_abc \| sys_lambda \| admin@rastup\",*\
*\"action\":\"refund.issued \| payout.hold.apply \| dmca.hide\",*\
*\"target\":\"leg\_\... \| order\_\... \| content\_\...\",*\
*\"details\":{ \"reason\":\"\...\", \"amount_cents\":1234 },*\
*\"corrId\":\"abc123\"*\
*}*\

## **1.18.I Vulnerability management & CI/CD hardening**

- **Dependency hygiene**: lockfiles checked‑in; Renovate/Dependabot
  weekly PRs; third‑party package allowlist.
- **SAST**: GitHub CodeQL (or equivalent) on PR; custom regex rules for
  secrets.
- **Secrets scanning**: pre‑receive hooks + CI step; block merges on
  positive.
- **Container/Lambda layers**: ECR image scan or *npm audit* gates;
  Lambda base runtime kept current.
- **IaC**: CDK/Terraform scanned with **Checkov**/cfn‑nag.
- **CI**: OIDC‑based deploy roles (no long‑lived keys); branch
  protections; required revi

### TD-0113 (tech)

<!-- id: TD-0113 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 406800-410800 -->

 CodeQL (or equivalent) on PR; custom regex rules for
  secrets.
- **Secrets scanning**: pre‑receive hooks + CI step; block merges on
  positive.
- **Container/Lambda layers**: ECR image scan or *npm audit* gates;
  Lambda base runtime kept current.
- **IaC**: CDK/Terraform scanned with **Checkov**/cfn‑nag.
- **CI**: OIDC‑based deploy roles (no long‑lived keys); branch
  protections; required reviews; signed tags for releases.
- **SBOM**: generate CycloneDX on release; archive to S3.

**Inline artifact --- CI policy checklist**\
**Path:** *security/ci/policy.md*

*- Require PR reviews (2 for prod)*\
*- Status checks: build, test, lint, SAST, IaC scan, license scan*\
*- Protected branches: no force-push, linear history*\
*- OIDC deploy to AWS; no PAT/keys stored*\
*- Secrets only in GitHub OIDC to AWS + Secrets Manager at runtime*\

## **1.18.J Incident response (IR) & disaster recovery (DR)**

- **IR team & runbooks**: security@ group, Slack #secur‑incidents
  (private), paging via SNS.

- **Playbooks**: credential leak, PII exposure, DDOS, data corruption,
  provider breach.

- **Forensics**: isolate role credentials; retrieve CloudTrail & app
  logs; snapshot affected S3 prefixes with Write Once retention.

- **DR**:

  - **Backups**: Aurora PITR, daily snapshots; Dynamo PITR; S3
    versioning + Object Lock for evidence.
  - **RPO/RTO**: core web ≤ 15m RPO / ≤ 60m RTO; payments webhooks ≤ 5m
    / 15m.
  - **Regional**: consider cross‑region S3 replication for evidence
    vault; Aurora global DB if required later.

**Inline artifact --- IR ticket template**\
**Path:** *security/ir/ticket-template.md*

*- Summary:*\
*- Detected by:*\
*- Impacted data/classes:*\
*- Timeline:*\
*- Containment:*\
*- Eradication:*\
*- Recovery:*\
*- Customer comms needed? Y/N*\
*- Follow-up CAPA items:*\

## **1.18.K Compliance scaffolding (SOC 2‑ready baseline)**

- **Policies**: access control, change mgmt, incident response, vendor
  risk, data retention, acceptable use (templates in
  */security/policies/\**).
- **Evidence**: automated exports (CloudTrail sampling, IAM user/role
  diffs, Security Hub findings, backup status, vulnerability scans).
- **Vendor management**: Stripe/IDV/esign risk rating, DPAs stored;
  review annually.
- **Training**: annual security awareness for staff;
  onboarding/offboarding checklist.

## **1.18.L Monitoring & detection**

- **GuardDuty**: enabled in all accounts; alerts → Security account SNS.

- **Security Hub**: aggregates findings; CIS benchmark checks.

- **Access Analyzer**: detect public/broad‑trust resources.

- **CloudWatch/SNS** alerts:

  - WAF blocks spike, 4xx/5xx spikes, AppSync throttles, Lambda DLQ
    growth, KMS key errors, Secrets rotation failure.

- **SIEM (lightweight)**: centralize key logs in S3 + Athena queries;
  optional OpenSearch later.

## **1.18.M SLOs, budgets & costs**

**SLOs**

- **Auth availability** ≥ 99.9% monthly.
- **Webhook idempotency** 100% (no double side‑effects).
- **P0 IR response** ≤ 15 min; **P1** ≤ 1 hour.
- **Secrets rotation** success 100% monthly cadence.

**Budgets**

- WAF: managed rules only at start; add Bot Control if abuse appears.
- Security Hub/GuardDuty: monitor costs; scope to prod + stage at
  launch.
- Logs: 30--90d hot retention; archive to Glacier Instant Retrieval
  thereafter.

## **1.18.N Test plan (security)**

1978. **AuthZ tests**: attempts to access other users' resources denied;
      \@auth rules covered.
1979. **Webhook replay**: replay Stripe/IDV webhooks; verify idempotent
      outcomes.
1980. **Secrets rotation**: rotate Stripe/SES/... in stage; production
      dry‑run window; alarms on failures.
1981. **WAF**: simulate bursts; ensure rate rules and managed sets
      engage; false positives monitored.
1982. **SAST/IaC**: seed a vulnerable branch; CI blocks merge.
1983. **DR**: restore Aurora snapshot into a staging clone; validate
      integrity.
1984. **PII logging**: send synthetic PII; verify logs redaction and
      ale

### TD-0114 (tech)

<!-- id: TD-0114 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 410400-414400 -->

. in stage; production
      dry‑run window; alarms on failures.
1981. **WAF**: simulate bursts; ensure rate rules and managed sets
      engage; false positives monitored.
1982. **SAST/IaC**: seed a vulnerable branch; CI blocks merge.
1983. **DR**: restore Aurora snapshot into a staging clone; validate
      integrity.
1984. **PII logging**: send synthetic PII; verify logs redaction and
      alerts.
1985. **Break‑glass**: test JIT admin; ensure revocation and audit
      entries present.

## **1.18.O Work packages (Cursor 4‑agent lanes)**

- **Agent A --- Auth & AppSync**: Cognito pools/claims, multi‑auth
  rules, entitlement resolvers, admin OIDC, JWT claims mapping.
- **Agent B --- Edge & WAF**: CloudFront behaviors, WAF rules & rate
  limits, webhook ingress gateway, Shield enrollment.
- **Agent C --- Secrets/KMS/Logs**: Secrets Manager structure, KMS CMKs
  & policies, CloudTrail to log‑archive, immutable audit append.
- **Agent D --- CI/CD & Detection**: CodeQL/Checkov gates, OIDC deploy
  roles, Security Hub/GuardDuty, IR runbooks, DR backup policies.

## **1.18.P Acceptance criteria (mark §1.18 FINAL only when ALL true)**

1990. Multi‑auth implemented (Cognito + IAM + OIDC) with least‑privilege
      resolvers; API key **off** in prod.
1991. Secrets stored in Secrets Manager; KMS keys per domain; rotation
      policy in place and tested.
1992. S3/Dynamo/Aurora encrypted; TLS enforced; PII redaction in logs
      verified.
1993. WAF deployed with managed rules + GraphQL rate limits; webhooks
      protected (HMAC or allowlist).
1994. Immutable audit for admin actions present; CloudTrail
      centralization to log‑archive with Object Lock.
1995. CI/CD has SAST/IaC gates; OIDC deployments; SBOM archived.
1996. IR/DR runbooks executed in stage; RPO/RTO met; backup health
      dashboard up.
1997. Security Hub/GuardDuty/Access Analyzer findings triaged; alerts
      wired.
1998. Costs within initial budgets; no paid security appliances required
      at launch.

# **§1.18 --- DevSecOps Addendum (Deep Completeness)**

Everything below is **text‑only artifacts** for your Word doc (each
includes a *Recommended filename/path* to lift later if you choose).

## **1.18.A Threat Model (assets, trust boundaries, controls)**

**Recommended path:** *security/threat-model/overview.md*

*Assets*\
*- A1: Money flows (Stripe Connect, payouts, refunds)*\
*- A2: PII (names, emails, phones), IDV artifacts (age/18+ evidence),
studio contracts*\
*- A3: Content previews (SFW only), deliverable manifests (hashes +
URLs)*\
*- A4: Auth & session tokens (Cognito JWTs, admin OIDC)*\
*- A5: Audit trails & evidence vault (DMCA, chargebacks)*\
*- A6: Secrets & keys (Stripe, KMS, Secrets Manager)*\
\
*Trust Boundaries*\
*- Edge (CloudFront/WAF) → App (Next.js/AppSync/Lambdas)*\
*- App → Data (Aurora/Dynamo/S3/Glue/Athena)*\
*- Providers (Stripe/IDV/e‑sign/SES) via webhooks*\
*- Admin/OIDC → AppSync Admin mode*\
\
*Primary Risks & Controls*\
*- Injection/XXE/SSRF → parameterized queries, SSRF‑blocked by VPC
egress policy, S3 Access Points*\
*- AuthZ bypass → AppSync \@auth rules + resolver checks + test matrix*\
*- Webhook replay → idempotency store + HMAC verification*\
*- PII leakage/logging → structured logs with redaction + log scans*\
*- DoS/Bot → WAF rate rules + GraphQL complexity limits + per‑actor
quotas*\
*- Content abuse → NSFW scanning + Safe‑Mode + DMCA pipeline*\

## **1.18.B Security Headers (CSP, Referrer, Permissions)**

**Recommended path:** *security/headers/response-headers.json*

*{*\
*\"Content-Security-Policy\": \"default-src \'self\'; img-src \'self\'*
[*https://cdn.rastup.com*](https://cdn.rastup.com) *data:; media-src
\'self\'* [*https://cdn.rastup.com*](https://cdn.rastup.com)*;
script-src \'self\'; style-src \'self\' \'unsafe-inline\'; font-src
\'self\' data:; connect-src \'self\'*
[*https://api.rastup.com*](https://api.rastup.com)*; frame-ancestors
\'none\'; base-uri \'self\'; form-action \'self\'\",*\
*\"Referrer-Policy\"

### TD-0115 (tech)

<!-- id: TD-0115 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 414000-418000 -->

img-src \'self\'*
[*https://cdn.rastup.com*](https://cdn.rastup.com) *data:; media-src
\'self\'* [*https://cdn.rastup.com*](https://cdn.rastup.com)*;
script-src \'self\'; style-src \'self\' \'unsafe-inline\'; font-src
\'self\' data:; connect-src \'self\'*
[*https://api.rastup.com*](https://api.rastup.com)*; frame-ancestors
\'none\'; base-uri \'self\'; form-action \'self\'\",*\
*\"Referrer-Policy\": \"strict-origin-when-cross-origin\",*\
*\"Permissions-Policy\": \"camera=(), microphone=(), geolocation=()\",*\
*\"Strict-Transport-Security\": \"max-age=63072000; includeSubDomains;
preload\",*\
*\"X-Content-Type-Options\": \"nosniff\",*\
*\"X-Frame-Options\": \"DENY\",*\
*\"X-XSS-Protection\": \"0\"*\
*}*\

Apply via **CloudFront Response Headers Policy**; for checkout pages add
Stripe to *connect-src*/*frame-src*.

## **1.18.C GraphQL Complexity/Depth Limits + Rate Quotas**

**Recommended path:** *security/graphql/limits.md*

*GraphQL Limits*\
*- Max depth: 8*\
*- Max cost: 2,000 per query (field weights; nested lists penalized)*\
*- Max input payload: 256 KB*\
*- Introspection: enabled in dev/stage; disabled in prod except for
whitelisted admin IPs*\
\
*Rate Quotas (per 5 minutes)*\
*- Anonymous: 120 requests*\
*- Authenticated user: 900 requests*\
*- Admin OIDC: 1,200 requests*\
*- Burst: 20 requests/second/user*\
*Enforced by WAF + AppSync throttling + identity-aware API Gateway usage
plans (if used).*\

**Resolver guard (pseudocode)**\
**Path:** *security/graphql/cost-limiter.ts*

*export function enforceLimits(ctx) {*\
*if (ctx.depth \> 8 \|\| ctx.cost \> 2000) throw new
Error(\"QUERY_LIMIT_EXCEEDED\");*\
*if (ctx.inputSize \> 256\*1024) throw new Error(\"INPUT_TOO_LARGE\");*\
*}*\

## **1.18.D Cookie & Session Policy**

**Recommended path:** *security/cookies/policy.md*

*Cookies*\
*- \_\_Host-rastup: session JWT reference; SameSite=Lax; Secure;
HttpOnly; Path=/; Domain=\<none\>; Prefix=\_\_Host*\
*- consent: preference state; SameSite=Lax; Secure; HttpOnly=false*\
*- cfduid/edge: none (avoid third-party identifiers)*\
\
*Rules*\
*- No third-party trackers on public pages.*\
*- Analytics via first-party beacon only; respect consent.*\
*- JWTs not stored in localStorage; refresh via secure cookie.*\

## **1.18.E Webhook HMAC Verification (Stripe/Plaid)**

**Recommended path:** *security/webhooks/verify.ts*

*import crypto from \'crypto\';*\
\
*export function verifyStripe(rawBody: Buffer, sigHeader: string,
secret: string) {*\
*// Prefer Stripe SDK constructEvent; fallback HMAC check:*\
*const \[tPart, v1Part\] = sigHeader.split(\',\').map(s =\> s.trim());*\
*const t = tPart.split(\'=\')\[1\]; const v1 =
v1Part.split(\'=\')\[1\];*\
*const payload = \`\${t}.\${rawBody.toString()}\`;*\
*const hmac = crypto.createHmac(\'sha256\',
secret).update(payload).digest(\'hex\');*\
*if (!crypto.timingSafeEqual(Buffer.from(hmac), Buffer.from(v1))) throw
new Error(\'INVALID_SIGNATURE\');*\
*}*\

Store last **event_id** in an idempotency table; on duplicate, return
200 OK without re‑execution.

## **1.18.F S3 & CloudFront: Private Origins, No Public ACLs**

**Recommended path:** *security/s3/policies.md*

*{*\
*\"Version\":\"2012-10-17\",*\
*\"Statement\":\[*\
*{\"Sid\":\"DenyPublicACL\",\"Effect\":\"Deny\",\"Principal\":\"\*\",\"Action\":\"s3:PutBucketAcl\",\"Resource\":\"arn:aws:s3:::cdn.rastup.com\"},*\
*{\"Sid\":\"DenyNotUsingTLS\",\"Effect\":\"Deny\",\"Principal\":\"\*\",\"Action\":\"s3:\*\",\"Resource\":\[\"arn:aws:s3:::cdn.rastup.com\",\"arn:aws:s3:::cdn.rastup.com/\*\"\],\"Condition\":{\"Bool\":{\"aws:SecureTransport\":\"false\"}}},*\
*{\"Sid\":\"AllowOACOnly\",\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"cloudfront.amazonaws.com\"},\"Action\":\"s3:GetObject\",\"Resource\":\"arn:aws:s3:::cdn.rastup.com/\*\",\"Condition\":{\"StringEquals\":{\"AWS:SourceArn\":\"arn:aws:cloudfront::\<acct\>:distribution/\<id\>\"}}}*\
*\]*\
*}*\

Use **CloudFront Origin Access Control (OAC)**; disable **Public
Access** and ACLs; use **Object Owners

### TD-0116 (tech)

<!-- id: TD-0116 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 417600-421600 -->

id\":\"AllowOACOnly\",\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"cloudfront.amazonaws.com\"},\"Action\":\"s3:GetObject\",\"Resource\":\"arn:aws:s3:::cdn.rastup.com/\*\",\"Condition\":{\"StringEquals\":{\"AWS:SourceArn\":\"arn:aws:cloudfront::\<acct\>:distribution/\<id\>\"}}}*\
*\]*\
*}*\

Use **CloudFront Origin Access Control (OAC)**; disable **Public
Access** and ACLs; use **Object Ownership = Bucket owner enforced**.

## **1.18.G Pre‑Signed Uploads (size/type guard)**

**Recommended path:** *security/s3/presign.ts*

*export function presignPreviewUpload({ userId, mime, bytes }) {*\
*if (!/\^image\\/(jpe?g\|png\|webp)\$/.test(mime)) throw new
Error(\'UNSUPPORTED_TYPE\');*\
*if (bytes \> 10 \* 1024 \* 1024) throw new Error(\'FILE_TOO_LARGE\');*\
*// key scoped to user prefix, random suffix*\
*const key =
\`previews/\${userId}/\${Date.now()}\_\${Math.random().toString(36).slice(2)}.webp\`;*\
*return s3.getSignedUrl(\'putObject\', { Bucket: \'fansub-previews\',
Key: key, ContentType: mime, Expires: 300 });*\
*}*\

## **1.18.H Break‑Glass & JIT Admin Access**

**Recommended path:** *security/admin/break-glass.md*

*- No standing Admin in prod. Use Identity Center JIT with 1-hour
session TTL.*\
*- Break-glass triggers:*\
*\* Widespread outage, data corruption, compromised credentials.*\
*- Procedure:*\
* 1) PagerDuty page; open IR ticket.*\
*2) Two-person approval; one requests JIT role; one approves.*\
*3) All actions in console shell are screen-recorded; correlation ID
must be attached to commands.*\
*4) Revoke access at TTL; post-mortem includes access diff from
CloudTrail.*\

## **1.18.I Secrets Rotation Runbook (Stripe, SES, KMS)**

**Recommended path:** *security/secrets/rotation-runbook.md*

*Cadence*\
*- Stripe API/Webhook: 90 days*\
*- SES SMTP creds: 180 days*\
*- KMS key rotation: yearly (auto)*\
\
*Steps (Stripe)*\
*1) Create new restricted key (write: charges, read: events).*\
*2) Deploy to stage via Secrets Manager (/stage/stripe/secret_key).*\
*3) Run stage smoke tests (webhooks).*\
*4) In prod, add new key alongside old; rotate webhooks secret.*\
*5) Flip AppSync/Lambdas to new secret; verify live.*\
*6) Disable old key; update runbook timestamps.*\
\
*Verification*\
*- CloudWatch alarm if Stripe auth errors \> 0.1% after rotation.*\

## **1.18.J Vendor Risk Management**

**Recommended path:** *security/vendors/register.md*

*- Stripe (Processor): DPA, SOC1/2 bridge, data location (US), breach
SLA in vendor contract.*\
*- IDV provider: ID docs storage duration & encryption; data deletion
API tested quarterly.*\
*- E-sign: signature evidence retention; tamper-evident hashes.*\
*- Email (SES): region & sending limits; bounce/complaint handling
verified.*\
*- CDN/DNS: CloudFront/Route53; no third-party DNS at launch.*\
*- Annually review DPAs and security reports; track in vendor register
with risk scores.*\

## **1.18.K Pen‑Test Scope & Safe Harbor**

**Recommended path:** *security/testing/pentest-scope.md*

*- In-scope: public web, AppSync API, mobile clients, preview upload
endpoints.*\
*- Out-of-scope: providers (Stripe, IDV), employee-only VPN resources.*\
*- Constraints: no volumetric DoS, no social engineering.*\
*- Data: use synthetic accounts in stage; limited prod tests under
supervision.*\
*- Safe harbor: good-faith testing protected; report via security@ with
proof-of-concept only.*\

## **1.18.L OWASP ASVS Mapping (excerpt)**

**Recommended path:** *security/standards/asvs-mapping.md*

*- V1 Architecture: Zero-trust, least privilege (covered §1.18.B/C)*\
*- V2 Auth: Cognito/OIDC with MFA for admin; session cookie flags
(§1.18.D)*\
*- V4 Access Control: AppSync \@auth + resolver checks (tests in
§1.18.N)*\
*- V5 Validation: JSON Schemas, event validation (see §1.13)*\
*- V9 Data Protection: TLS/HSTS/KMS; PII minimization (this section)*\
*- V14 Config: CSP, headers, secrets management (this section)*\

## **1.18.M DR Drill & Severity Matrix**

**Recommended path:** *security/ir/severity-matrix.md*

### TD-0117 (tech)

<!-- id: TD-0117 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 421200-425200 -->

on cookie flags
(§1.18.D)*\
*- V4 Access Control: AppSync \@auth + resolver checks (tests in
§1.18.N)*\
*- V5 Validation: JSON Schemas, event validation (see §1.13)*\
*- V9 Data Protection: TLS/HSTS/KMS; PII minimization (this section)*\
*- V14 Config: CSP, headers, secrets management (this section)*\

## **1.18.M DR Drill & Severity Matrix**

**Recommended path:** *security/ir/severity-matrix.md*

*Severities*\
*- P0: data exfiltration confirmed; payments outage \> 30 min*\
*- P1: partial outage; suspected credential leak*\
*- P2: localized bug with security impact; WAF false positive spike*\
\
*DR Drill (quarterly)*\
*- Restore Aurora snapshot to stage clone; switch read traffic for an
hour; verify parity.*\
*- Simulate region impairment: serve static from CF + cached ISR;
payments degraded mode on.*\
*- Outcome recorded; gaps turned into CAPA tickets.*\

## **1.18.N SIEM/Athena Queries (suspicious patterns)**

**Recommended path:** *security/siem/queries.sql*

*\-- Excessive GraphQL POSTs per IP in 5 min*\
*SELECT ip, count(\*) AS c*\
*FROM cf_logs*\
*WHERE cs_method=\'POST\' AND cs_uri_stem LIKE \'%/graphql%\' AND
date=CAST(current_date AS varchar)*\
*GROUP BY ip HAVING count(\*) \> 500;*\
\
*\-- Admin OIDC logins outside office hours*\
*SELECT user, ts FROM admin_auth_logs*\
*WHERE hour(ts) NOT BETWEEN 8 AND 20 AND result=\'SUCCESS\';*\

## **1.18.O Access Recertification Schedule**

**Recommended path:** *security/governance/access-recert.yml*

*recertification:*\
*cadence: quarterly*\
*scopes:*\
* - human_roles: \[AdminLimited, OpsReadOnly, Analyst,
SecurityEngineer\]*\
* - workload_roles: all Lambdas/AppSync roles*\
*approvers:*\
* - security_lead*\
* - domain_owner*\
*evidence:*\
* - IAM role membership diff*\
* - Access Analyzer public findings = 0*\

### **§1.18 Determination (post‑addendum)**

With this addendum, **§1.18 Security, Compliance & DevSecOps** covers
the full scope to **≥99.9%**. It includes: identity boundaries, authN/Z
details for AppSync, secrets/KMS, encryption, WAF/bot/DDOS, webhooks +
idempotency, cookie/session policy, CSP/headers, S3/CloudFront
hardening, rate limits & GraphQL complexity, audit, vendor risk,
pen‑test scope, OWASP mapping, incident/DR, SIEM queries, access
recertification, SLOs, budgets, tests, and runbooks --- all as **inline
artifacts** ready for your Word doc. I am **100% confident** we can
proceed.

# **§1.19 --- Internationalization (I18n), Localization (L10n) & Accessibility (A11y) ---** ***Begin***

We will build a fully localized and accessible experience across public
pages (SEO‑sensitive), app flows (checkout, messaging, Fan‑Sub), and
admin tooling---without inflating costs. This section will be exhaustive
and artifact‑rich; I'll keep expanding it across replies until it meets
the 99.9% bar.

## **1.19.A Canon & invariants**

- **Locale‑agnostic URLs** (canonical without locale; hreflang
  alternates in head).
- **Server‑rendered locale content** for SEO; dynamic strings pulled
  from versioned catalogs.
- **Currency, date, number** formats localized server‑side.
- **Right‑to‑left (RTL)** support from day one (dir=rtl).
- **Accessibility first**: WCAG 2.2 AA; keyboard‑first nav; SFW previews
  always carry alt text.
- **Cost**: use message catalogs + ICU; avoid heavy third‑party i18n
  SaaS; translations stored in S3/JSON and cached.

## **1.19.B Locale catalog & message format**

**Recommended path:** *i18n/catalog/en-US.json* (example)

*{*\
*\"nav.home\": \"Home\",*\
*\"nav.city\": \"{city} creatives\",*\
*\"profile.title\": \"{displayName} --- {role} in {city}\",*\
*\"studio.amenities\": \"Amenities\",*\
*\"checkout.pay\": \"Pay {amount, number, ::currency/USD}\",*\
*\"a11y.skip\": \"Skip to main content\"*\
*}*\

**Loader (pseudocode)**\
**Path:** *i18n/loader.ts*

*export async function loadLocale(lang: string) {*\
*const res = await fetch(\`https://cdn.rastup.com/i18n/\${lang}.json\`,
{ cache: \'force-cache\' });*\
*return res.json();*\
*}*\

## **1.19.C Hreflang

### TD-0118 (tech)

<!-- id: TD-0118 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 424800-428800 -->

o.amenities\": \"Amenities\",*\
*\"checkout.pay\": \"Pay {amount, number, ::currency/USD}\",*\
*\"a11y.skip\": \"Skip to main content\"*\
*}*\

**Loader (pseudocode)**\
**Path:** *i18n/loader.ts*

*export async function loadLocale(lang: string) {*\
*const res = await fetch(\`https://cdn.rastup.com/i18n/\${lang}.json\`,
{ cache: \'force-cache\' });*\
*return res.json();*\
*}*\

## **1.19.C Hreflang & negotiation**

**Recommended path:** *web/lib/hreflang.ts* (complements §1.17)

*export const locales =
\[\"en-US\",\"es-ES\",\"fr-FR\",\"ar\",\"de-DE\"\];*\
*export function linksFor(canonical: string, map:
Record\<string,string\>) {*\
*return Object.entries(map).map((\[lang, href\]) =\> \`\<link
rel=\"alternate\" hreflang=\"\${lang}\"
href=\"\${href}\"\>\`).join(\"\\n\")*\
* + \`\\n\<link rel=\"alternate\" hreflang=\"x-default\"
href=\"\${canonical}\"\>\`;*\
*}*\

# **§1.19 --- Internationalization (I18n), Localization (L10n) & Accessibility (A11y) --- Full Spec**

**Goal:** Ship a multilingual, accessible marketplace that preserves
SEO, Safe‑Mode rules, and performance budgets. Everything below is
**text‑only** for your Word doc and includes **Recommended
filename/path** tags for later lift into the repo. We keep costs low (no
heavy SaaS): JSON catalogs in S3, *Intl.\** APIs server/client, and
automated extraction/QA.

## **1.19.1 Canon & invariants**

2005. **Locale‑agnostic canonicals.** Canonical URLs **don't** contain
      locale; we add *hreflang* alternates (ties to §1.17).
2006. **Server‑rendered locale content** for public/SEO pages; client
      hydration matches server strings.
2007. **ICU MessageFormat** everywhere (plural, select, number/currency,
      dates).
2008. **RTL** supported from day one (Arabic/Hebrew): directional CSS,
      logical properties, bidi‑safe UI.
2009. **WCAG 2.2 AA**: keyboard, contrast, focus, forms, motion.
2010. **Cost**: catalogs in S3 (versioned), CDN‑cached; no per‑string
      paid APIs.
2011. **Safe‑Mode** rules: no 18+ previews in public pages/emails;
      localized strings **must not** bypass gating.

## **1.19.2 Data model & user preferences**

**SQL migration**\
**Recommended path:** *db/migrations/019_i18n_user_prefs.sql*

*alter table \"user\"*\
*add column locale text not null default \'en-US\',*\
*add column timezone text not null default \'UTC\',*\
*add column prefers_24h boolean not null default false,*\
*add column reduced_motion boolean not null default false,*\
*add column high_contrast boolean not null default false;*\
\
*create index on \"user\"(locale);*\
*create index on \"user\"(timezone);*\

**GraphQL SDL**\
**Recommended path:** *api/schema/i18n.graphql*

*type UserPrefs {*\
*locale: String!*\
*timezone: String!*\
*prefers24h: Boolean!*\
*reducedMotion: Boolean!*\
*highContrast: Boolean!*\
*}*\
*extend type Query { mePrefs: UserPrefs! }*\
*extend type Mutation {*\
*updatePrefs(locale: String, timezone: String, prefers24h: Boolean,
reducedMotion: Boolean, highContrast: Boolean): UserPrefs!*\
*}*\

**Policy:** never infer locale silently after the user explicitly
chooses one; store choice; still set *lang*/*dir* attributes
server‑side.

## **1.19.3 Locale catalogs & loading**

**Catalog structure (ICU MessageFormat)**\
**Recommended path:** *i18n/catalogs/en-US.json*

*{*\
*\"nav.home\": \"Home\",*\
*\"nav.city\": \"{city} creatives\",*\
*\"cta.book\": \"Book now\",*\
*\"price.perHour\": \"{amount, number, ::currency/USD} per hour\",*\
*\"availability.slots\": \"{count, plural, one {# slot} other {# slots}}
available\",*\
*\"a11y.skip\": \"Skip to main content\",*\
*\"safeMode.disclaimer\": \"Public previews are SFW. Some content
requires Safe-Mode OFF and age verification.\"*\
*}*\

**Other locales** (create *es-ES.json*, *fr-FR.json*, *ar.json*, etc.)
with identical keys; avoid string concatenation---always parametrize.

**Loader (server & client)**\
**Recommended path:** *i18n/loader.ts*

*export async function loadLocaleCatalog(lang: string) {*\
*const url = \`

### TD-0119 (tech)

<!-- id: TD-0119 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 428400-432400 -->

Mode.disclaimer\": \"Public previews are SFW. Some content
requires Safe-Mode OFF and age verification.\"*\
*}*\

**Other locales** (create *es-ES.json*, *fr-FR.json*, *ar.json*, etc.)
with identical keys; avoid string concatenation---always parametrize.

**Loader (server & client)**\
**Recommended path:** *i18n/loader.ts*

*export async function loadLocaleCatalog(lang: string) {*\
*const url = \`https://cdn.rastup.com/i18n/\${lang}.json\`;*\
*const res = await fetch(url, { cache: \"force-cache\" });*\
*if (!res.ok) throw new Error(\"CATALOG_MISSING\");*\
*return res.json();*\
*}*\

**Extraction config**\
**Recommended path:** *i18n/extract.config.json*

*{*\
*\"src\": \[\"web/\*\*/\*.{ts,tsx}\",\"apps/\*\*/\*.{ts,tsx}\"\],*\
*\"funcs\": \[\"t\",\"fmt.t\",\"i18n.t\"\],*\
*\"output\": \"i18n/messages.pot\"*\
*}*\

## **1.19.4 Locale detection & routing (no auto‑redirect loop)**

**Middleware (concept)**\
**Recommended path:** *web/middleware.locale.ts*

*import { NextRequest, NextResponse } from \"next/server\";*\
*import Negotiator from \"negotiator\";*\
*const SUPPORTED = \[\"en-US\",\"es-ES\",\"fr-FR\",\"ar\",\"de-DE\"\];*\
\
*export function middleware(req: NextRequest) {*\
*const res = NextResponse.next();*\
*// Honor explicit choice in cookie first*\
*const chosen = req.cookies.get(\"locale\")?.value;*\
*const lang = chosen \|\| new Negotiator({ headers: {
\"accept-language\": req.headers.get(\"accept-language\") \|\| \"\" }
}).language(SUPPORTED) \|\| \"en-US\";*\
*res.headers.set(\"x-lang\", lang);*\
*res.headers.set(\"x-dir\", lang.startsWith(\"ar\") ? \"rtl\" :
\"ltr\");*\
*return res;*\
*}*\

**UX:** always offer a visible language switcher; **do not** force
redirects based on IP.

## **1.19.5 Numbers, currency, dates & time zones**

**Utility**\
**Recommended path:** *i18n/format.ts*

*export function money(amountCents: number, currency: string, locale:
string) {*\
*return new Intl.NumberFormat(locale, { style: \"currency\", currency
}).format(amountCents / 100);*\
*}*\
*export function dateFmt(dtISO: string, locale: string, tz: string) {*\
*return new Intl.DateTimeFormat(locale, { dateStyle: \"medium\",
timeStyle: \"short\", timeZone: tz }).format(new Date(dtISO));*\
*}*\

**Rules:**

- Always format **server‑side** for SEO pages.
- Respect *prefers_24h* and *timezone*.
- For booking availability, display both **provider local time** and
  **viewer time** when they differ.

## **1.19.6 RTL support & logical CSS**

**Base CSS logical props**\
**Recommended path:** *web/styles/rtl.css*

*html\[dir=\"rtl\"\] { direction: rtl; }*\
*.card { padding-inline: 16px; margin-inline: 8px; }*\
*.icon-chevron { transform: scaleX(var(\--dir-mult, 1)); }*\
*html\[dir=\"rtl\"\] .icon-chevron { \--dir-mult: -1; }*\

**Mirroring images/icons:** use bidirectional icons or auto‑mirrored
SVG; avoid text baked into images.

## **1.19.7 Accessible components (WCAG 2.2 AA)**

**Skip link & landmarks**\
**Recommended path:** *web/components/SkipLink.tsx*

*export const SkipLink = () =\> (*\
*\<a href=\"#main\" className=\"sr-only focus:not-sr-only focus:fixed
focus:top-2 focus:left-2 bg-yellow-300 p-2 rounded\"\>*\
*{t(\"a11y.skip\")}*\
*\</a\>*\
*);*\

**Accessible modal (focus trap, aria)**\
**Recommended path:** *web/components/Modal.tsx*

*export function Modal({ open, titleId, children, onClose }) {*\
*// trap focus, ESC to close, role=\"dialog\" aria-modal=\"true\"
aria-labelledby={titleId}*\
*/\* \...focus management code\... \*/*\
*}*\

**Combobox (search) ARIA**\
**Recommended path:** *web/components/Combobox.tsx*

*/\* role=\"combobox\" aria-expanded aria-controls listbox; options
role=\"option\"; keyboard arrows, Enter, Esc; announces via aria-live
\*/*\

**Color/contrast:** enforce ≥ 4.5:1; expose *high_contrast* toggle that
upgrades token set.

**Reduced motion:** respect *prefers-reduced-motion* and user pref;
disable parallax/animated transitions.

## **1.19.8 Form localization & validation**

- **Names:** do not force first/

### TD-0120 (tech)

<!-- id: TD-0120 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 432000-436000 -->

ria-expanded aria-controls listbox; options
role=\"option\"; keyboard arrows, Enter, Esc; announces via aria-live
\*/*\

**Color/contrast:** enforce ≥ 4.5:1; expose *high_contrast* toggle that
upgrades token set.

**Reduced motion:** respect *prefers-reduced-motion* and user pref;
disable parallax/animated transitions.

## **1.19.8 Form localization & validation**

- **Names:** do not force first/last in all locales; offer single "full
  name" with optional structured fields.
- **Addresses:** use country‑specific layouts (state/province, postal
  code).
- **Phones:** use libphonenumber server‑side and client hints; store
  E.164 format.
- **Error messages:** localized, short, plain language; associate with
  fields via *aria-describedby*.
- **Date pickers:** local week start; localized month/day names;
  keyboard accessible.

**Validation messages catalog**\
**Recommended path:** *i18n/validation/en-US.json*

*{*\
*\"required\": \"This field is required.\",*\
*\"email\": \"Enter a valid email address.\",*\
*\"minLength\": \"Use at least {min} characters.\",*\
*\"invalidPhone\": \"Enter a valid phone number.\"*\
*}*\

## **1.19.9 Public SEO pages: localized metadata & JSON‑LD**

**Head helper**\
**Recommended path:** *web/seo/meta.tsx*

*export function PageMeta({ titleKey, descKey, params }) {*\
*const title = t(titleKey, params);*\
*const desc = t(descKey, params);*\
*return (*\
*\<\>*\
*\<title\>{title}\</title\>*\
*\<meta name=\"description\" content={desc} /\>*\
*{/\* SFW OG image per §1.17 \*/}*\
*\</\>*\
*);*\
*}*\

**Localized JSON‑LD:** translate *headline*, *description*,
*addressLocality* etc., but **never** substitute 18+ images.

## **1.19.10 Emails & notifications localization (MJML)**

**Template with locale switch**\
**Recommended path:** *comms/templates/\_partials/strings.json*

*{*\
*\"en-US\": { \"cta.viewProfile\": \"View profile\", \"digest.header\":
\"This week in {city}\" },*\
*\"es-ES\": { \"cta.viewProfile\": \"Ver perfil\", \"digest.header\":
\"Esta semana en {city}\" }*\
*}*\

**Sender policy:** *From* name localized; subject lines localized; quiet
hours per **recipient timezone**.

## **1.19.11 Translation workflow, QA & pseudolocalization**

**Workflow**

2020. Devs mark strings with *t(\'key\')*.
2021. Extract → *messages.pot* (CI).
2022. Translate in Git (JSON catalogs), not in CMS; PR review by
      language owners.
2023. **Pseudolocalization** stage (*\[!! Ŧêxţ ẽłôñĝąţęđ !!\]*) to catch
      truncation/overflow.
2024. Screenshot diff QA for top pages per locale (Crowd‑shots optional
      later).
2025. Version catalogs; invalidate CDN on merge.

**Pseudolocalizer script**\
**Recommended path:** *i18n/tools/pseudo.ts*

*export function pseudo(s: string){ return s.replace(/\[aAeEiIoOuUc\]/g,
m =\>
({a:\"á\",e:\"ë\",i:\"ï\",o:\"ø\",u:\"ü\",c:\"ç\"}\[m.toLowerCase()\]
\|\| m)).replace(/(\[a-z\])/gi,\"\$1\\u0301\"); }*\

## **1.19.12 A11y testing (automated + manual)**

**Automated (CI):** axe + pa11y on */*, */city/{city}*, */p/{handle}*,
*/s/{slug}*, */checkout*.\
**Manual matrix:** keyboard‑only; screen readers (NVDA/Windows,
VoiceOver/macOS), zoom 200%, high‑contrast mode, reduced‑motion, RTL
reading order.\
**Defect SLAs:** A11y blockers = P1 (fix before release to prod);
contrast/label issues = P2 (fix within 2 sprints).

## **1.19.13 Performance & bundle budgets for i18n**

- **Do not** ship all catalogs to every user: load on demand from CDN.
- Tree‑shake i18n runtime; rely on browser *Intl*; **Node with
  full‑icu** in SSR.
- Pre‑render top locales for city/role pages to hit SEO.

**Bundle budget (public pages)**\
**Recommended path:** *observability/budgets/i18n-budget.json*

*{
\"resourceSizes\":\[{\"resourceType\":\"script\",\"budget\":150},{\"resourceType\":\"total\",\"budget\":850}\]
}*\

## **1.19.14 Governance: language coverage & content policy**

- Launch locales: *en-US*; "Phase 2": *es-ES*; "Phase 3": *fr-FR*,
  *de-DE*, *ar*.
- **Gate publishing** of a locale until: 100% key c

### TD-0121 (tech)

<!-- id: TD-0121 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 435600-439600 -->

 (public pages)**\
**Recommended path:** *observability/budgets/i18n-budget.json*

*{
\"resourceSizes\":\[{\"resourceType\":\"script\",\"budget\":150},{\"resourceType\":\"total\",\"budget\":850}\]
}*\

## **1.19.14 Governance: language coverage & content policy**

- Launch locales: *en-US*; "Phase 2": *es-ES*; "Phase 3": *fr-FR*,
  *de-DE*, *ar*.
- **Gate publishing** of a locale until: 100% key coverage,
  pseudolocalization pass, a11y pass, SEO checks (hreflang).
- Maintain a **glossary** per role/feature to keep translations
  consistent.

## **1.19.15 Work packages (Cursor 4‑agent lanes)**

- **Agent A --- Web/App:** i18n provider, locale switcher, RTL styles,
  A11y components (Modal, Combobox, SkipLink), head meta helper.
- **Agent B --- API/SSR:** user prefs fields/resolvers, server
  formatting helpers, Node full‑icu build, JSON‑LD localization.
- **Agent C --- Comms/SEO:** localized MJML templates, subject/From
  localization, hreflang tags, sitemap alternates.
- **Agent D --- QA/Tooling:** extractor/pseudolocalizer, axe/pa11y CI,
  screenshot diff, catalogs versioning/CDN invalidation.

## **1.19.16 Acceptance criteria --- mark §1.19 FINAL only when ALL true**

2036. Locale selection persists; server adds *lang* & *dir* correctly;
      **no auto‑redirect loops**; hreflang alternates present on SEO
      pages.
2037. ICU MessageFormat is used across web/app/emails;
      prices/dates/numbers localized; dual‑timezone display where
      relevant.
2038. RTL renders correctly: layout mirrored, icons swapped, reading
      order valid; no clipped/truncated text.
2039. A11y: WCAG 2.2 AA checks pass (axe/pa11y + manual SR runs);
      keyboard navigation works across all interactive components.
2040. Public pages (SEO) pre‑render localized
      titles/descriptions/JSON‑LD with **SFW images** only; Safe‑Mode
      rules respected.
2041. Catalogs load per‑locale (no shipping all); bundle budgets met;
      Node SSR has full‑icu.
2042. Translation workflow operational: extraction → PR review →
      pseudolocalized QA → deploy; glossary maintained.
2043. Emails localized, with quiet hours by timezone; no 18+ previews in
      emails.
2044. Costs controlled: catalogs on S3/CDN; no paid localization SaaS at
      launch.

# **§1.20 --- Mobile (PWA + Optional Native Shells), Push, and Device Capabilities**

*(app architecture · PWA config & offline · optional RN/Expo shells ·
deep links & routing · auth/session on device · push notifications
(APNs/FCM/Pinpoint) · file uploads from camera · Safe‑Mode & age‑gated
UX · performance budgets · a11y on mobile · CI/CD & releases · telemetry
· tests · cost posture)*

**Purpose.** Specify the complete mobile experience: a first‑class
**Progressive Web App (PWA)** that covers the entire user journey
(discovery → messages → booking → delivery), with an optional **React
Native (Expo) shell** for app store presence when/if desired. This
section defines how we implement offline, push, deep‑links, device
uploads, Safe‑Mode gating, performance, a11y, telemetry, CI/CD, and
costs. All artifacts are **inline text** for your Word doc with
"Recommended filename/path" tags so your builders can later lift them
into the repo.

## **1.20.A Canon & invariants**

2045. **PWA‑first**: one codebase (Next.js) with service worker, install
      prompt, offline for core routes, and background sync for
      drafts/uploads.
2046. **Optional native shells** (React Native + Expo) wrap the web for
      store distribution and system‑level push; both shells and PWA use
      the same AppSync APIs.
2047. **Safe‑Mode on mobile**: defaults ON for guests/new installs; SFW
      previews only; 18+ features gated behind age verification and
      explicit user choice, never emailed or pushed with previews.
2048. **Cost‑conscious:** APNs/FCM via Amazon **Pinpoint/SNS**, no extra
      third‑party SDK bloat; media uploads are direct‑to‑S3 presigned,
      resized on device.
2049. **Accessibility**: WCAG mobile patterns, la

### TD-0122 (tech)

<!-- id: TD-0122 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 439200-443200 -->

le**: defaults ON for guests/new installs; SFW
      previews only; 18+ features gated behind age verification and
      explicit user choice, never emailed or pushed with previews.
2048. **Cost‑conscious:** APNs/FCM via Amazon **Pinpoint/SNS**, no extra
      third‑party SDK bloat; media uploads are direct‑to‑S3 presigned,
      resized on device.
2049. **Accessibility**: WCAG mobile patterns, large tap targets,
      VoiceOver/TalkBack tested, motion‑safe animations.
2050. **Privacy**: no background location; images EXIF stripped on
      upload (unless user opts in for studio proofs).

## **1.20.B Client architecture**

- **PWA shell** (Next.js): app‑router, service worker, manifest, edge
  caching; GraphQL via AppSync (JWT auth).

- **Native shells** (optional):

  - **React Native** + **Expo** (managed workflow) for iOS/Android.
  - Uses a small native bridge for push tokens, file pickers, camera,
    and device storage; renders either RN screens or a WebView wrapper
    for certain flows if we choose a hybrid approach.

- **Shared modules**: auth/session, GraphQL client, feature flags,
  Safe‑Mode, formatting (ICU), and analytics events shared across PWA
  and RN.

## **1.20.C PWA configuration (manifest, SW, caching, offline)**

**Recommended path:** *web/public/manifest.webmanifest*

*{*\
*\"name\": \"RastUp\",*\
*\"short_name\": \"RastUp\",*\
*\"start_url\": \"/?source=pwa\",*\
*\"display\": \"standalone\",*\
*\"background_color\": \"#0e1116\",*\
*\"theme_color\": \"#0e1116\",*\
*\"icons\": \[*\
*{\"src\": \"/icons/icon-192.png\", \"sizes\": \"192x192\", \"type\":
\"image/png\"},*\
*{\"src\": \"/icons/icon-512.png\", \"sizes\": \"512x512\", \"type\":
\"image/png\"}*\
*\]*\
*}*\

**Service Worker** (Workbox‑style pseudocode)\
**Recommended path:** *web/public/sw.js*

*self.addEventListener(\'install\', e =\> {*\
*e.waitUntil(caches.open(\'rastup-precache-v1\').then(c =\>
c.addAll(\[*\
*\'/\', \'/city\', \'/styles.css\', \'/manifest.webmanifest\'*\
*\])));*\
*});*\
*self.addEventListener(\'fetch\', e =\> {*\
*const url = new URL(e.request.url);*\
*// HTML: NetworkFirst with fallback to cache*\
*if (e.request.mode === \'navigate\') {*\
*e.respondWith(fetch(e.request).then(r =\> {*\
*const copy = r.clone(); caches.open(\'rastup-pages\').then(c =\>
c.put(e.request, copy));*\
*return r;*\
*}).catch(() =\> caches.match(e.request) \|\| caches.match(\'/\')));*\
*return;*\
*}*\
*// Images: Stale-While-Revalidate*\
*if (url.pathname.startsWith(\'/\_next/image\') \|\|
url.pathname.startsWith(\'/images/\')) {*\
*e.respondWith(caches.open(\'img\').then(async c =\> {*\
*const cached = await c.match(e.request);*\
*const fresh = fetch(e.request).then(r =\> { c.put(e.request,
r.clone()); return r; });*\
*return cached \|\| fresh;*\
*}));*\
*}*\
*});*\

**Offline scope:** home, city pages, profile/studio detail (last
viewed), messages list (last page cached), compose drafts.

## **1.20.D Optional native shells (React Native + Expo)**

**Project layout**\
**Recommended path:** *apps/mobile/App.tsx*

*export default function App() {*\
*return (*\
*\<SafeAreaProvider\>*\
*\<NavigationContainer linking={linking}\>*\
*\<Stack.Navigator\>*\
*\<Stack.Screen name=\"Home\" component={HomeScreen}/\>*\
*\<Stack.Screen name=\"Messages\" component={MessagesScreen}/\>*\
*\<Stack.Screen name=\"Booking\" component={BookingScreen}/\>*\
*\<Stack.Screen name=\"Web\" component={WebViewScreen}/\> {/\* for
hybrid routes if needed \*/}*\
*\</Stack.Navigator\>*\
*\</NavigationContainer\>*\
*\</SafeAreaProvider\>*\
*);*\
*}*\

**Deep link config**\
**Recommended path:** *apps/mobile/linking.ts*

*export default {*\
*prefixes: \[\'rastup://\',\'https://rastup.com\'\],*\
*config: { screens: {*\
*Home: \'\',*\
*Messages: \'messages\',*\
*Booking: \'checkout/:id\',*\
*Profile: \'p/:handle\',*\
*Studio: \'s/:slug\'*\
*}}*\
*};*\

**Platform considerations (high‑level policy):** at launch, **PWA can be
primary**. If/when we publish native apps, limit the initial nati

### TD-0123 (tech)

<!-- id: TD-0123 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 442800-446800 -->

* *apps/mobile/linking.ts*

*export default {*\
*prefixes: \[\'rastup://\',\'https://rastup.com\'\],*\
*config: { screens: {*\
*Home: \'\',*\
*Messages: \'messages\',*\
*Booking: \'checkout/:id\',*\
*Profile: \'p/:handle\',*\
*Studio: \'s/:slug\'*\
*}}*\
*};*\

**Platform considerations (high‑level policy):** at launch, **PWA can be
primary**. If/when we publish native apps, limit the initial native
scope to discovery, booking, messages, and studios; keep **Fan‑Sub paid
content flows** in the web experience until we explicitly decide to
support native in‑app purchase workflows.

## **1.20.E Auth & session on device**

- **Cognito** hosted UI or embedded flows; JWTs stored in **HttpOnly
  Secure** cookies for Web/PWA; in RN, keep tokens in **secure storage**
  (Keychain/Keystore).
- **Session refresh** via refresh‑token rotation; background refresh
  guarded by app state.
- **Device trust**: bind push tokens and device fingerprints to user id
  for security & rate‑limits (§1.18).

## **1.20.F Messaging UX on mobile**

- **Thread list** with last message preview, unread counts, typing
  indicators; **thread view** with infinite scroll and media bubbles
  (SFW thumbnails).
- **Composer**: text, camera/gallery picker, quick templates.
- **Offline**: queue outgoing messages; retry with backoff; show pending
  state.
- **Abuse controls**: block/report from header; Safe‑Mode hides 18+
  previews.

## **1.20.G Push notifications (APNs/FCM via Pinpoint/SNS)**

**Token registration**\
**Recommended path:** *apps/mobile/push/register.ts*

*export async function registerPushToken(userId: string, token: string,
platform: \'ios\'\|\'android\'\|\'web\') {*\
*await gql.mutate(\'savePushToken\', { userId, token, platform, tz:
Intl.DateTimeFormat().resolvedOptions().timeZone });*\
*}*\

**Server routing**

- Use Pinpoint/SNS topics per **city** and per **user** for
  rate‑efficient broadcasts and 1:1 messages.
- **Quiet hours** enforce local‑time windows; **daily caps** per
  category (alerts/digests vs direct messages).
- Templates mirror §1.16 MJML text (title/body only; no 18+ previews).

## **1.20.H File uploads from camera/gallery**

- **Direct‑to‑S3 presigned PUT** (see §1.18.G) with client‑side resize
  (e.g., target ≤ 2048px longest).
- **EXIF strip** by default; user can opt‑in to keep GPS/time for studio
  evidence flows.
- **Progress & background**: show %; resume after app pause.
- **Virus/NSFW scan** on ingest (already defined in §1.14 and §1.10).

**Recommended path:** *apps/mobile/upload.ts*

*export async function uploadImage(fileUri: string, mime: string) {*\
*const { url, fields, key } = await gql.mutate(\'getPresignedUrl\', {
mime, purpose: \'preview\' });*\
*const body = await buildMultipart(fileUri, fields); // RN: fetch
blob/file*\
*const res = await fetch(url, { method: \'POST\', body });*\
*if (!res.ok) throw new Error(\'UPLOAD_FAILED\');*\
*return { key };*\
*}*\

## **1.20.I Safe‑Mode & age gating UX**

- **First‑run:** Safe‑Mode ON; explain what it does; clear toggle path
  in **Settings**.
- **Age verification** (when required): IDV web flow in secure webview;
  store only verdict and event id, not raw images (§1.18 data
  minimization).
- **Surface rules:** No push/email with 18+ previews; PWA and RN show
  SFW placeholders until Safe‑Mode OFF + verified.

## **1.20.J Performance budgets (mobile)**

**Targets (mobile P75):** LCP ≤ 2.5s (PWA), INP ≤ 200ms, TTI ≤ 3.5s,
bundle ≤ 900KB total on first load (GZIP).

**Tactics:**

- Code‑split heavy editors/maps; prefetch next screens on tap‑down;
  image lazy‑load with low‑quality placeholders;
  *fetchpriority=\"high\"* for LCP hero; local fonts with *font-display:
  swap*.
- For RN: Hermes engine, RAM bundles, Flipper disabled in prod,
  animation worklets only where needed.

**Budget file**\
**Recommended path:** *observability/budgets/mobile.json*

*{ \"pwaFirstLoadKB\": 900, \"pwaScriptKB\": 160, \"pwaImgPolicy\":
\"webp/avif\", \"rnBundleKB\": 420 }*\

## **1.20.K A

### TD-0124 (tech)

<!-- id: TD-0124 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 446400-450400 -->

y placeholders;
  *fetchpriority=\"high\"* for LCP hero; local fonts with *font-display:
  swap*.
- For RN: Hermes engine, RAM bundles, Flipper disabled in prod,
  animation worklets only where needed.

**Budget file**\
**Recommended path:** *observability/budgets/mobile.json*

*{ \"pwaFirstLoadKB\": 900, \"pwaScriptKB\": 160, \"pwaImgPolicy\":
\"webp/avif\", \"rnBundleKB\": 420 }*\

## **1.20.K Accessibility (mobile a11y)**

- **VoiceOver/TalkBack** labels on all controls; proper roles for
  tabs/lists; visible focus on PWA.
- **Touch targets ≥ 44px**; dynamic type support; prefers‑reduced‑motion
  disables parallax and spinners.
- Color contrast tokens switchable to high‑contrast palette (user pref
  from §1.19).

## **1.20.L Deep links & universal links**

- **iOS** *apple‑app‑site‑association* and **Android** Asset Links
  hosted under */.well-known/*.
- Universal link handling maps to Profile/Studio/Checkout/Message
  screens; unknown routes open in in‑app webview.

**Recommended path:**
*web/public/.well-known/apple-app-site-association*

*{\"applinks\":{\"apps\":\[\],\"details\":\[{\"appID\":\"TEAMID.com.rastup.app\",\"paths\":\[\"/p/\*\",\"/s/\*\",\"/checkout/\*\",\"/messages\*\"\]}\]}}*\

## **1.20.M CI/CD & releases (PWA + RN shells)**

- **PWA**: GitHub Actions build → deploy to Amplify Hosting/CloudFront;
  invalidation of changed paths; Lighthouse CI budget gate.
- **RN shells** *(optional)*: Expo EAS build & submit; internal test
  tracks (Play) and TestFlight; codepush‑style OTA (for JS only, not for
  policy‑sensitive features).
- **Signing & secrets** in GitHub OIDC + Secrets Manager; no long‑lived
  signing keys in repo (§1.18).

## **1.20.N Telemetry & crash reporting**

- PWA: first‑party analytics via *navigator.sendBeacon*; CWV field data
  per route; soft‑error logging.
- RN: minimal crash reporter (e.g., Sentry‑like equivalent can be added
  later) but keep SDKs lean; at launch, start with OS crash logs + our
  event pipeline.
- **Mobile event taxonomy** aligns with §1.13 (e.g., *app.install*,
  *pwa.install_prompt*, *push.opt_in*, *message.send*,
  *upload.start/success*, *booking.start/complete*).

## **1.20.O Error taxonomy (client‑safe)**

- *UPLOAD_FAILED*, *UNSUPPORTED_TYPE*, *FILE_TOO_LARGE*, *PUSH_DENIED*,
  *SAFE_MODE_BLOCKED*, *AUTH_EXPIRED*, *OFFLINE_RETRYING*.
- Each error includes user‑friendly copy and retry guidance.

## **1.20.P Test plan (device & CI)**

2086. **Installability** (PWA): manifest audit, offline home/city,
      revalidation behavior.
2087. **Messaging**: send/receive, offline queue, image upload retry.
2088. **Booking**: flow from profile → package → checkout;
      date/timezones; Apple/Google Pay via web Stripe (where
      applicable).
2089. **Push**: token registration; quiet hours; category caps; deep
      link opens correct screen.
2090. **Safe‑Mode**: previews stay SFW with Safe‑Mode ON; age‑gated
      features blocked until verified.
2091. **A11y**: VoiceOver/TalkBack; high‑contrast; reduced‑motion.
2092. **Performance**: p75 budgets met on mid‑range Android (Moto
      G‑class).
2093. **RN shells** (if used): deep links, file uploads, push, fallback
      to webview for long‑tail routes.

## **1.20.Q Work packages (Cursor 4‑agent lanes)**

- **Agent A --- PWA/UX**: service worker, manifest, offline scopes,
  Safe‑Mode toggles, upload UI.
- **Agent B --- RN Shells** (optional): Expo app, push bridge, deep
  links, secure storage, hybrid webview wrappers.
- **Agent C --- Backend/Comms**: Pinpoint/SNS setup, push templates,
  quiet hours & caps, presigned uploads, AppSync mutations.
- **Agent D --- QA/Perf**: device matrix, Lighthouse CI, CWV field
  beacons, a11y runs, perf tuning.

## **1.20.R Acceptance criteria --- mark §1.20 FINAL only when ALL true**

2098. PWA installable; offline works for defined scopes; background
      retry for uploads/messages.
2099. Push notifications delivered via Pinpoint/SNS to Web/iOS/Android
      with quiet hours & caps; deep l

### TD-0125 (tech)

<!-- id: TD-0125 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 450000-454000 -->

 mutations.
- **Agent D --- QA/Perf**: device matrix, Lighthouse CI, CWV field
  beacons, a11y runs, perf tuning.

## **1.20.R Acceptance criteria --- mark §1.20 FINAL only when ALL true**

2098. PWA installable; offline works for defined scopes; background
      retry for uploads/messages.
2099. Push notifications delivered via Pinpoint/SNS to Web/iOS/Android
      with quiet hours & caps; deep links open the correct screen.
2100. Camera/gallery uploads succeed with on‑device resize, EXIF strip
      by default, S3 presigned PUT, and server‑side scans.
2101. Safe‑Mode and age gating enforced consistently; no 18+ previews in
      notifications or public pages.
2102. Mobile performance budgets met; a11y checks pass on PWA and RN
      shells (if used).
2103. CI/CD pipelines in place for PWA (Amplify/CloudFront) and, if
      used, RN shells (EAS/TestFlight/Play internal).
2104. Telemetry and crash/error reporting active; event taxonomy
      integrated with §1.13.

# **§1.21 --- Search, Discovery & Ranking Engine (Re‑issued in full, sequential order)**

*This is the same complete §1.21 I produced earlier, re‑posted here to
maintain strict numeric order in your master Word document. Everything
is text‑only and copy‑pasteable, with "Recommended filename/path"
markers for later lift‑and‑shift.*

## **1.21.A Index documents & schemas**

We maintain two primary collections: *people_v1* and *studios_v1*. All
public fields are **SFW‑only** (no 18+ media or attributes).
Private/sensitive fields never enter search docs.

**Recommended path:** *search/schemas/typesense.json*

*{*\
*\"collections\": \[*\
*{*\
*\"name\": \"people_v1\",*\
*\"fields\": \[*\
*{\"name\":\"id\",\"type\":\"string\"},*\
*{\"name\":\"handle\",\"type\":\"string\"},*\
*{\"name\":\"displayName\",\"type\":\"string\"},*\
*{\"name\":\"roles\",\"type\":\"string\[\]\",\"facet\":true},*\
*{\"name\":\"genres\",\"type\":\"string\[\]\",\"facet\":true},*\
*{\"name\":\"city\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"region\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"country\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"lat\",\"type\":\"float\"},*\
*{\"name\":\"lon\",\"type\":\"float\"},*\
*{\"name\":\"verified\",\"type\":\"bool\",\"facet\":true},*\
*{\"name\":\"trusted\",\"type\":\"bool\",\"facet\":true},*\
*{\"name\":\"nsfw_band\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"priceFromCents\",\"type\":\"int64\",\"facet\":true},*\
*{\"name\":\"priceToCents\",\"type\":\"int64\",\"facet\":true},*\
*{\"name\":\"amenities\",\"type\":\"string\[\]\",\"facet\":true},*\
*{\"name\":\"packagesCount\",\"type\":\"int32\"},*\
*{\"name\":\"repScore\",\"type\":\"float\"},*\
*{\"name\":\"recencyScore\",\"type\":\"float\"},*\
*{\"name\":\"engagementScore\",\"type\":\"float\"},*\
*{\"name\":\"availabilityScore\",\"type\":\"float\"},*\
*{\"name\":\"completenessScore\",\"type\":\"float\"},*\
*{\"name\":\"updatedAt\",\"type\":\"int64\"},*\
*{\"name\":\"createdAt\",\"type\":\"int64\"}*\
*\],*\
*\"default_sorting_field\": \"updatedAt\"*\
*},*\
*{*\
*\"name\":\"studios_v1\",*\
*\"fields\":\[*\
*{\"name\":\"id\",\"type\":\"string\"},*\
*{\"name\":\"slug\",\"type\":\"string\"},*\
*{\"name\":\"name\",\"type\":\"string\"},*\
*{\"name\":\"city\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"region\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"country\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"lat\",\"type\":\"float\"},*\
*{\"name\":\"lon\",\"type\":\"float\"},*\
*{\"name\":\"verified\",\"type\":\"bool\",\"facet\":true},*\
*{\"name\":\"nsfw_band\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"amenities\",\"type\":\"string\[\]\",\"facet\":true},*\
*{\"name\":\"priceFromCents\",\"type\":\"int64\",\"facet\":true},*\
*{\"name\":\"priceToCents\",\"type\":\"int64\",\"facet\":true},*\
*{\"name\":\"sizeSqFt\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"recencyScore\",\"type\":\"float\"},*\
*{\"name\":\"engagementScore\",\"type\":\"float\"},*\
*

## Pre-Run Ritual (HARD)

- [ ] Read your last run report.
- [ ] Read any related run reports for the same WBS or feature.
- [ ] Summarise Plan vs Done vs Pending before writing new code.

## Locking & Access (HARD)

- Acquire your lock file at `ops/locks/AGENT-1.lock` before modifying files.
- Declare your scope_paths[] in your run report.
- If you detect overlapping scopes or foreign changes, STOP and hand back to the Orchestrator.

## Required Run Report Content (HARD)

- Context Snapshot (WBS IDs, blueprint IDs, assumptions).
- What Was Done vs Planned.
- How It Was Done (architecture/implementation narrative).
- Testing (commands, results, coverage, security scans) + 'Testing Proof' paragraph.
- Issues & Problems (with root causes where possible).
- Locations / Touch Map (files created/modified/removed, migrations, databases touched).
- Suggestions for Next Agents.
- Progress & Checklist.

## Orchestrator Attach Pack (HARD)

- Place under `docs/orchestrator/from-agents/AGENT-1/run-<timestamp>-attach.zip`.
- Include: run report, diff summary, CI/test artifacts, performance/security results,
  and a manifest.json (agent, run_id, wbs_ids, blueprint_ids, status).

## Testing (HARD)

- Define a test plan before coding.
- Implement unit/integration/E2E tests where appropriate.
- Record all test commands and results in the run report.
- If you cannot implement or run tests, mark the task partial and propose follow-up WBS items.

## Implementation Notes

(Use this space during your run.)

## Issues & Risks

(Document any issues, risks, or TODOs you discover.)

## Suggestions for Next Agents

(Document any guidance for follow-up work.)
