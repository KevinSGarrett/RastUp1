# Task for AGENT-1: WBS-021 — Security, Privacy, and Compliance

You are a Cursor CLI agent working under a central Orchestrator.

## WBS Task

- ID: WBS-021
- Title: Security, Privacy, and Compliance
- Phase: Ops
- Agent: AGENT-1
- Depends on: WBS-001
- Blueprint IDs: TD-0290, TD-0291, TD-0292, TD-0293, TD-0294, TD-0295, TD-0296, TD-0297, TD-0298, TD-0299, TD-0300, TD-0301, TD-0302, TD-0303, TD-0304, TD-0305, TD-0306, TD-0307, TD-0308, TD-0309, TD-0310, TD-0311, TD-0312, TD-0313, TD-0314, TD-0315, TD-0316, TD-0317, TD-0318, TD-0319, TD-0320, TD-0321, TD-0322, TD-0323, TD-0324, TD-0325, TD-0326, TD-0327, TD-0328, TD-0329

### Description

Implement security controls including least-privilege IAM, KMS encryption, secrets rotation, WAF with bot control and rate limiting, and immutable audit logs with chain hashes. Enforce privacy with PII minimization, DSAR export and deletion workflows, legal holds, and redaction in logs and views. Conduct quarterly pen tests, vulnerability scans, and security training. Implement incident response with severity levels, runbooks, and drills. Enforce PCI DSS compliance with Stripe Connect and no raw PAN storage. Provide RBAC with just-in-time elevation and multi-factor authentication. Integrate logging, monitoring, and alerting for security events.

### Acceptance Criteria

- Least-privilege IAM and KMS encryption with secrets rotation
- WAF with bot control, rate limiting, and abuse detection
- Immutable audit logs with chain hashes and WORM storage
- PII minimization, DSAR export/deletion, legal holds, and redaction
- Quarterly pen tests, vulnerability scans, and security training
- Incident response with severity levels, runbooks, and drills
- PCI DSS compliance with Stripe Connect and no raw PAN storage
- RBAC with just-in-time elevation and MFA enforced
- Logging, monitoring, and alerting for security events
- Tests cover security controls, privacy enforcement, and incident handling


## Relevant Blueprint Chunks

### TD-0290 (tech)

<!-- id: TD-0290 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1044000-1048000 -->

gs**: 30--90 days hot → Glacier 12 months.

**Deletion & DSAR propagation.**

- **Graph**: user→orders/threads/reviews/media→search index→analytics
  sessions.
- **Guarantee**: search purge ≤ 5m; analytics tombstones within nightly
  jobs.
- **Backups**: immutable; deletion not retroactive but not restored
  except for DR (documented).

**Artifacts.** *privacy/data_lifecycle.md*,
*ops/scripts/s3_lifecycle.yml*, *services/dsar/propagate.ts*.

**Acceptance.** DSAR E2E test shows redaction across
app/search/analytics; S3 lifecycle & DB TTL policies active; audit log
events recorded.

## **A4. Payments --- SCA/3DS, Apple/Google Pay, ACH posture, refunds kernel hardening**

**Checkout.**

- Stripe **PaymentIntents** with automatic SCA (3DS2) and fallback to
  challenge.
- **Apple Pay / Google Pay** via Stripe Elements (wallets) enabled at
  launch.
- **ACH**: **Phase‑2** option via **Stripe Financial Connections** or
  Plaid; not MVP (reduces complexity & risk).
- **Stored cards**: off by default at MVP; plan tokenization later (PCI
  SAQ‑A preserved).

**Refund kernel (policy engine).**

- Time‑bands (full/partial/none) tied to provider policy; fee retention
  caps; chargeback evidence pack generation.
- **Idempotency** & **webhook reconciliation**: *refund.succeeded*
  aligns with ledger.

**Payouts.**

- MFA on changing payout destination; velocity limits for first 30 days;
  hold on fraud flags.

**Tests.** 3DS challenge success/failure; partial & full refunds;
dispute creation; payout change MFA; ACH sandbox (if enabled).

**Artifacts.** *ops/runbooks/stripe_wallets.md*,
*services/payments/refund_kernel.ts*, *contracts/stripe/\*.json*.

**Acceptance.** p95 checkout \< 600ms server time (excl. challenge);
wallet success rate tracked; refunds/chargebacks reconcile.

## **A5. Accessibility --- Assistive Technology Matrix & Manual QA**

**Assistive tech matrix (must‑test):**

- **Screen readers:** NVDA (Windows/Chrome), JAWS (Windows/Chrome),
  VoiceOver (macOS/Safari), TalkBack (Android/Chrome), VoiceOver
  (iOS/Safari).
- **Keyboard‑only:** all flows reachable; focus order logical; skip
  links.
- **Color/contrast:** WCAG AA (large text ≥ 3:1, normal ≥ 4.5:1).
- **Motion & prefers‑reduced‑motion:** disable non‑essential animations.

**Manual scripts (per surface):**

- Auth forms (login/signup/reset)
- Profile editor (avatar/crop; gallery reorder)
- Search filters (facet toggles)
- Checkout (error summaries, card field labels)
- Messaging (thread navigation)

**Artifacts.** *a11y/manual_matrix.md*, *web/tests/a11y.spec.ts*,
*web/a11y/aria-map.md*.

**Acceptance.** 0 **critical** violations in axe; manual matrix passes
on at least one device per OS.

## **A6. Supply‑Chain & SBOM / Vulnerability Management**

**Controls.**

- **SBOM** generated on every release (CycloneDX).
- **Dependency scans** (SCA) + **SAST**; severity SLAs: Critical 48h,
  High 7d, Medium 30d.
- **Container scanning** (Typesense images); minimal base images.
- **Update bot** (Renovate) with weekly PR cadence; lockfile integrity.
- **Artifact integrity**: build provenance (GitHub OIDC→AWS); image
  signing optional (cosign).

**Artifacts.** *.github/workflows/security.yml*,
*security/sbom/README.md*, *ops/policies/vuln_sla.md*.

**Acceptance.** No open Critical vulns in prod deps; SBOM attached to
each release; mean time to remediate meets SLA.

## **"Is anything else missing?" Quick scorecard**

  ---------------------------------------------- ----------------------------- --------------------------------------------------
  **Area**                                       **Status**                    **What we added here**
  Functional UX (auth, profiles, public pages)   ✅ Covered in §1.31           Screen‑level specs, validations, uploads, states
  SEO & programmatic landings                    ✅ §1.17 + §1.31              CWV budgets, sitemaps, OG SFW, hreflang
  Search/discovery                               ✅ §1.18                      Index schemas, rank

### TD-0291 (tech)

<!-- id: TD-0291 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1047600-1051600 -->

     **Status**                    **What we added here**
  Functional UX (auth, profiles, public pages)   ✅ Covered in §1.31           Screen‑level specs, validations, uploads, states
  SEO & programmatic landings                    ✅ §1.17 + §1.31              CWV budgets, sitemaps, OG SFW, hreflang
  Search/discovery                               ✅ §1.18                      Index schemas, ranking, caching, safety
  Payments & refunds                             ✅ §1.13 (+A4 expands)        SCA/wallets details, refund hardening
  Security/privacy/compliance                    ✅ §1.24 (+A1/A3/A6 expand)   Threat model, lifecycle, SBOM/SLA
  DR/BCP                                         ⚠️ Expanded in **A2**         RTO/RPO targets + drill runbooks
  Accessibility                                  ✅ §1.25 (+A5 expands)        Assistive tech matrix & manual QA
  ---------------------------------------------- ----------------------------- --------------------------------------------------

**Bottom line:** With **A1--A6** included, the plan is
**production‑grade and audit‑ready**. If you want deeper
jurisdiction‑specific compliance (e.g., regional **data residency**,
**age‑gating** requirements), I can append a **Data Residency &
Jurisdictional Addendum** the same way.

## **Paste‑ready artifacts index (for the new addenda)**

- security/threat_model.md
- ops/runbooks/abuse_playbooks.md
- ops/runbooks/dr_restore.md
- ops/scripts/typesense_rebuild.ts
- privacy/data_lifecycle.md
- ops/scripts/s3_lifecycle.yml
- services/dsar/propagate.ts
- ops/runbooks/stripe_wallets.md
- services/payments/refund_kernel.ts
- contracts/stripe/\*.json
- a11y/manual_matrix.md
- .github/workflows/security.yml
- security/sbom/README.md
- ops/policies/vuln_sla.md

# **Master punch‑list of final expansions (prioritized)**

**What these are:** highly practical, low‑ambiguity details reviewers
and operators ask for in production. For each, I include what to add,
the artifacts to create, and done‑criteria.

### **P0‑1. Configuration & Secrets Registry (per‑service, per‑env)**

- **Add:** authoritative list of all environment variables, default
  values, allowed ranges, secret locations (SSM/KMS), owners, rotation
  frequency.
- **Artifacts:** *ops/config/registry.md*, *ops/config/flags.yaml*.
- **Acceptance:** new engineer can recreate a working env from the
  registry with no guesswork; secret rotation drill passes.

➡️ **Fully written as Appendix J below.**

### **P0‑2. API Error & Semantics Registry (HTTP/GraphQL/Webhooks)**

- **Add:** canonical error codes/messages, idempotency semantics,
  pagination rules, rate‑limit headers, deprecation policy.
- **Artifacts:** *api/docs/errors.md*, *contracts/errors.json*.
- **Acceptance:** same input yields same error code across surfaces;
  partners can implement once and be stable.

➡️ **Fully written as Appendix K below.**

### **P0‑3. CDN/Cache Key Matrix (CloudFront + ISR + API caching)**

- **Add:** per‑route TTLs, cache keys (*Vary* on language/safe‑mode),
  invalidation triggers, ISR revalidation rules, edge header allowlists.
- **Artifacts:** *ops/cache/cache_matrix.md*, *infra/cdk/edge_cache.ts*.
- **Acceptance:** cache hit‑rates & p95 fall within targets; no privacy
  leaks via caching.

➡️ **Fully written as Appendix L below.**

### **P0‑4. Logging, Event Schema & PII Redaction Policy**

- **Add:** JSON log schema (fields, levels), correlation IDs, PII
  "do‑not‑log" list, sampling rules, retention & access controls.
- **Artifacts:** *observability/log_schema.md*,
  *observability/redaction_policy.md*.
- **Acceptance:** secret scan finds 0 PII in logs; traceability across
  services works.

➡️ **Fully written as Appendix M below.**

### **P0‑5. Disaster Recovery Matrix (RTO/RPO per subsystem)**

- **Add:** timed restore steps for Aurora/S3/Typesense, cross‑region
  posture, DNS failover, quarterly drill script.
- **Artifacts:** *ops/dr_plan.md*, *ops/runbooks/dr_restore.md*.
- **Acceptance:** last DR 

### TD-0292 (tech)

<!-- id: TD-0292 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1051200-1055200 -->

ceptance:** secret scan finds 0 PII in logs; traceability across
  services works.

➡️ **Fully written as Appendix M below.**

### **P0‑5. Disaster Recovery Matrix (RTO/RPO per subsystem)**

- **Add:** timed restore steps for Aurora/S3/Typesense, cross‑region
  posture, DNS failover, quarterly drill script.
- **Artifacts:** *ops/dr_plan.md*, *ops/runbooks/dr_restore.md*.
- **Acceptance:** last DR drill met **RPO ≤ 15m** and **RTO ≤ 60m**
  end‑to‑end.

*(We outlined DR earlier; this appendix pins exact timings and
commands.)*

### **P1‑6. Data Governance: Retention, Classification, Masking, Lineage**

- **Add:** per‑table retention schedule, PII classification map, Stage
  masking rules, lineage from app→search→warehouse.
- **Artifacts:** *data/governance/catalog.yaml*,
  *data/retention_policies.md*.
- **Acceptance:** automated enforcement jobs run; Stage has no live PII.

### **P1‑7. Deliverability Program (Email + A2P‑10DLC)**

- **Add:** registration checklist, warmup ladder, complaint/bounce
  suppression, DMARC aggregate review cadence.
- **Artifacts:** *messaging/deliverability_playbook.md*,
  *messaging/10dlc_checklist.md*.
- **Acceptance:** inbox placement verified on seed list; carrier
  registrations approved.

### **P1‑8. Legal/Policy Ops**

- **Add:** ToS/Privacy consent capture model, cookie consent variants,
  community guidelines enforcement ladder, law‑enforcement request SOP.
- **Artifacts:** *legal/consent_model.md*,
  *policy/enforcement_ladder.md*, *legal/law_enforcement_sop.md*.
- **Acceptance:** consent evidence is queryable; enforcement actions
  auditable.

### **P1‑9. Access Management & Staff Device Policy**

- **Add:** SSO groups → RBAC mapping, joiner/mover/leaver SOP, device
  posture (disk encryption, screen lock), privileged session recording
  for admin console.
- **Artifacts:** *security/iam_matrix.md*, *security/jml_sop.md*.
- **Acceptance:** offboarding removes access within SLA; admin actions
  trace to a person.

### **P2‑10. Data Quality Rules (domain constraints)**

- **Add:** explicit FK/unique/check constraints for domain rules (e.g.,
  price bands, refund band monotonicity), validation SQL.
- **Artifacts:** *db/constraints.sql*, *db/quality_tests.sql*.
- **Acceptance:** migrations enforce rules; nightly job flags violations
  = 0.

### **P2‑11. Synthetic Monitoring (user flows)**

- **Add:** headless checks from multiple regions for login, search,
  checkout, messages; alert routes.
- **Artifacts:** *synthetics/\*.yml*,
  *observability/alarms/synthetics.yml*.
- **Acceptance:** failures page on‑call; MTTR within target.

### **P2‑12. Vendor/Sub‑processor Register & SLAs**

- **Add:** list all vendors (email/SMS, Stripe, geo/IP, moderation),
  data categories processed, DPA links, outage playbooks.
- **Artifacts:** *legal/subprocessors.md*, *ops/vendor_sla_watch.md*.
- **Acceptance:** SLAs tracked; failover/fallback defined where
  feasible.

Below are the **fully written appendices** for the top four items so you
can paste them into your master document **as‑is**.

## **Appendix J --- Configuration & Flags Registry (paste‑ready)**

**Purpose.** Single source of truth for environment variables, secrets,
feature flags, and their safe defaults.

**J.1 Structure**

- **Registry file:** *ops/config/registry.md*
- **Columns:** *Key*, *Service*, *Env* (*dev\|stage\|prod*), *Type*,
  *Default*, *Allowed values*, *Secret store*, *Owner*, *Rotation*,
  *Notes*.

**J.2 Canonical entries (representative)**

- *APP_ENV* --- web/api --- all --- enum --- *dev* ---
  *{dev,stage,prod}* --- plain --- Platform --- n/a --- controls
  telemetry sampling.
- *GRAPHQL_URL* --- web --- dev/stage --- URL --- (env‑specific) ---
  must be HTTPS in prod --- plain --- Platform --- n/a.
- *JWT_AUDIENCE* --- api --- all --- string --- *rastup-app* --- fixed
  --- plain --- Security --- n/a.
- *KMS_KEY_APP* --- api --- prod --- ARN --- none --- required --- KMS
  --- Security --- yearly --- app‑level encryption.
- *

### TD-0293 (tech)

<!-- id: TD-0293 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1054800-1058800 -->

 --- n/a --- controls
  telemetry sampling.
- *GRAPHQL_URL* --- web --- dev/stage --- URL --- (env‑specific) ---
  must be HTTPS in prod --- plain --- Platform --- n/a.
- *JWT_AUDIENCE* --- api --- all --- string --- *rastup-app* --- fixed
  --- plain --- Security --- n/a.
- *KMS_KEY_APP* --- api --- prod --- ARN --- none --- required --- KMS
  --- Security --- yearly --- app‑level encryption.
- *DB_SECRET_ARN* --- api --- stage/prod --- ARN --- none --- required
  --- Secrets Manager --- Security --- 90d.
- *STRIPE_SECRET_KEY* --- api --- stage/prod --- secret --- none ---
  required --- Secrets Manager --- Finance --- rotate if compromised.
- *STRIPE_WEBHOOK_SECRET* --- api --- stage/prod --- secret --- none ---
  required --- Secrets Manager --- Finance --- rotate on leak.
- *TYPESENSE_API_KEY* --- api/indexer --- all --- secret --- none ---
  required --- Secrets Manager --- Search --- 180d.
- *EMAIL_FROM* --- notifications --- prod --- email ---
  [*noreply@rastup.com*](mailto:noreply@rastup.com) --- domain must pass
  DMARC --- plain --- Comms --- n/a.
- *PWA_WEBP_QUALITY* --- web --- all --- int --- *75* --- 50--90 ---
  plain --- Web --- n/a.
- *SAFE_MODE_DEFAULT* --- web/api --- all --- bool --- *true* ---
  true/false --- plain --- Safety --- n/a.
- *FEATURE_INSTANT_BOOK* --- web/api --- all --- flag --- *off* ---
  *{off,canary,100%}* --- Launch --- n/a.

**J.3 Secrets handling**

- All *\*\_SECRET\** keys live in **AWS Secrets Manager**; access via
  IAM least‑privilege roles; audited.
- **Rotation runbook:** *ops/runbooks/secret_rotation.md* (generate new,
  deploy, verify, decommission old).

**J.4 Feature flags**

- File: *ops/config/flags.yaml* (keys, owner, rollout guardrails, kill
  switch).
- Changes require PR + approver; no runtime "hot editing" outside Admin
  console with audit.

**J.5 Acceptance**

- Every service boots using only this registry; CI check refuses unknown
  env keys; secrets rotation rehearsed quarterly.

## **Appendix K --- API Error & Semantics Registry (paste‑ready)**

**Purpose.** Make errors predictable across REST, GraphQL, and webhooks.

**K.1 Error model**

- **HTTP**:

  - *400* validation, *401* auth, *403* authz, *404* not found, *409*
    conflict (idempotency/booking race), *422* domain rule violation,
    *429* rate limit, *5xx* server.

- **GraphQL**: *errors\[\].extensions* carries *code* (*BAD_USER_INPUT*,
  *UNAUTHENTICATED*, *FORBIDDEN*, *NOT_FOUND*, *CONFLICT*,
  *RATE_LIMITED*, *INTERNAL*).

- **Webhooks**: signed; *2xx* = success; any non‑2xx triggers retry with
  backoff; *410* unsubscribes endpoint.

**K.2 Error codes (canonical subset)**

- *AUTH.INVALID_CREDENTIALS* (401) --- message: "Email or password is
  incorrect."
- *AUTH.MFA_REQUIRED* (401) --- message: "Step‑up verification
  required."
- *BOOKING.SLOT_TAKEN* (409) --- message: "That time was just booked.
  Pick another slot."
- *PAYMENT.CARD_DECLINED* (402/GraphQL error) --- message: "Your bank
  declined the charge."
- *RATE.LIMITED* (429) --- headers include *X‑RateLimit‑Limit*,
  *X‑RateLimit‑Remaining*, *Retry‑After*.
- *WEBHOOK.SIGNATURE_INVALID* (400) --- message: "Signature invalid or
  timestamp skew too large."

**K.3 Idempotency**

- All *POST* endpoints accept *Idempotency‑Key*. On duplicate, return
  prior **status + body** with *Idempotent-Replay: true*.

**K.4 Pagination**

- Cursor‑based; response includes *next_cursor*; absence = end. Limit
  caps documented per resource.

**K.5 Deprecation**

- Header *Sunset* with RFC date; *Deprecation: true* on deprecated
  routes; docs banner; 90‑day notice.

**K.6 Acceptance**

- Contract tests pass across all surfaces; partner SDK examples
  round‑trip the codes above; idempotent replays proven in CI.

## **Appendix L --- CDN / Cache Key Matrix (paste‑ready)**

**Purpose.** Eliminate guesswork in caching; protect privacy while
hitting performance budgets.

**L.1 Behaviors (CloudFront)**

- **/ (Home)** --- TTL **600s**; Key: *Host, Path, Accept‑Lan

### TD-0294 (tech)

<!-- id: TD-0294 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1058400-1062400 -->



**K.6 Acceptance**

- Contract tests pass across all surfaces; partner SDK examples
  round‑trip the codes above; idempotent replays proven in CI.

## **Appendix L --- CDN / Cache Key Matrix (paste‑ready)**

**Purpose.** Eliminate guesswork in caching; protect privacy while
hitting performance budgets.

**L.1 Behaviors (CloudFront)**

- **/ (Home)** --- TTL **600s**; Key: *Host, Path, Accept‑Language
  (2‑letter), Safe‑Mode*; Invalidate on *home:content_publish*.
- **/city/** --- TTL **1800s**; Key: *Host, Path, Query(role,sort,page),
  Accept‑Language, Safe‑Mode*; Warm top 100.
- **/people\|/studios\|/work** (search grids) --- **no edge cache** for
  personalized; server‑side **Dynamo cache** 60--300s keyed by
  normalized filters + personalization digest.
- **/help/** --- TTL **1--7d**; Key: *Host, Path, Accept‑Language*;
  invalidate on article publish.
- **/assets/** --- immutable; *Cache‑Control: public, max‑age=31536000,
  immutable*.
- **/api/** --- not cached at edge; AppSync GETs may be cached 60s only
  for truly public read endpoints (none for personalized).

**L.2 ISR (Next.js)**

- Regenerate on publish events; fallback blocking for top 1k pages;
  *revalidate* intervals recorded per template.

**L.3 Vary & privacy**

- Keys always include **Safe‑Mode**; never vary by cookies except the
  minimal Next/Amplify preview cookie in non‑prod.

**L.4 Invalidation triggers**

- Help/article publish → */help/\** path.
- Profile/studio edit (public fields) → that page + city landing;
  batched per minute.
- DMCA takedown → page + related grids.

**L.5 Acceptance**

- Edge hit ratio ≥ target for public pages; no leakage of personalized
  state; p95 TTFB meets budgets post‑warm.

## **Appendix M --- Logging, Event Schema & PII Redaction (paste‑ready)**

**Purpose.** Consistent, privacy‑safe logs and analytics with
traceability.

**M.1 Log schema (JSON)**

*{*\
*\"ts\": \"2025-11-06T12:34:56.789Z\",*\
*\"sev\": \"INFO\",*\
*\"svc\": \"search-api\",*\
*\"req_id\": \"r-abc123\",*\
*\"user_id\": \"u_123\" ,*\
*\"route\": \"/search/people\",*\
*\"lat_ms\": 132,*\
*\"remote_ip\": \"REDACTED\",*\
*\"msg\": \"search ok\",*\
*\"extra\": { \"city\": \"LA\", \"role\": \"photographer\", \"cache\":
\"hit\" }*\
*}*\

- **Required fields:** *ts, sev, svc, req_id, msg*.
- **Correlation:** *req_id* propagates across services; GraphQL
  resolvers include it.
- **Do‑not‑log PII:** emails, phone numbers, card tokens, addresses,
  EXIF raw, OAuth tokens.
- **Sampling:** 100% WARN/ERROR; INFO sample 10--20% on hot paths; raise
  to 100% during incidents.
- **Retention:** 30--90 days hot; archive to Glacier 12 months.

**M.2 Redaction & tokenization**

- Mask last‑4 for pan/phone; hash email usernames; scrub IPs before
  storage except in security logs (separate, restricted).

**M.3 Event analytics schema**

- Standard event fields: *event_name, user_id (hash), session_id, page,
  surface, ts, city, role, experiment_assignments*.
- Contracts live in *analytics/contracts/\*.json*; validation runs in
  CI.

**M.4 Acceptance**

- Secret scans find **0** PII; correlation works across services; event
  validator passes with 0 schema drifts.

# **Technical Appendices (canonical index for your master doc)**

- **H.** UI/UX Reference --- page layouts, fields, validations, states
  *(already delivered; re‑use as your Appendix H)*
- **I.** Configuration & Flags Registry *(reprinted below)*
- **J.** API Error & Semantics Registry *(reprinted below)*
- **K.** CDN / Cache Key Matrix *(reprinted below)*
- **L.** Logging, Event Schema & PII Redaction *(reprinted below)*
- **M.** SBOM & Dependency Policy *(new, as you requested)*
- **N.** Disaster Recovery Matrix (RTO/RPO) & DR Runbooks *(new)*
- **O.** Data Governance (Retention, Classification, Masking, Lineage)
  *(new)*
- **P.** Requirements Traceability Matrix (RTM) --- framework & seed
  entries *(new)*

## **Appendix I --- Configuration & Flags Registry (paste‑ready)**

**Purpose.** Single source of truth

### TD-0295 (tech)

<!-- id: TD-0295 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1062000-1066000 -->

*
- **M.** SBOM & Dependency Policy *(new, as you requested)*
- **N.** Disaster Recovery Matrix (RTO/RPO) & DR Runbooks *(new)*
- **O.** Data Governance (Retention, Classification, Masking, Lineage)
  *(new)*
- **P.** Requirements Traceability Matrix (RTM) --- framework & seed
  entries *(new)*

## **Appendix I --- Configuration & Flags Registry (paste‑ready)**

**Purpose.** Single source of truth for environment variables, secrets,
feature flags, and safe defaults.

**I.1 Registry file & columns**

- File: *ops/config/registry.md*
- Columns: **Key**, **Service**, **Env** (*dev\|stage\|prod*), **Type**,
  **Default**, **Allowed values**, **Secret store**, **Owner**,
  **Rotation**, **Notes**.

**I.2 Canonical entries (representative)**

- *APP_ENV* --- web/api --- all --- enum --- *dev* ---
  *{dev,stage,prod}* --- plain --- Platform --- n/a --- telemetry
  sampling.
- *GRAPHQL_URL* --- web --- dev/stage --- URL --- (env‑specific) ---
  must be HTTPS in prod --- plain --- Platform --- n/a.
- *JWT_AUDIENCE* --- api --- all --- string --- *rastup-app* --- fixed
  --- plain --- Security --- n/a.
- *DB_SECRET_ARN* --- api --- stage/prod --- ARN --- none --- required
  --- **Secrets Manager** --- Security --- **90d**.
- *KMS_KEY_APP* --- api --- prod --- ARN --- none --- required ---
  **KMS** --- Security --- **annual**.
- *STRIPE_SECRET_KEY* --- api --- stage/prod --- secret --- none ---
  required --- **Secrets Manager** --- Finance --- rotate on leak.
- *STRIPE_WEBHOOK_SECRET* --- api --- stage/prod --- secret --- none ---
  required --- **Secrets Manager** --- Finance --- rotate on leak.
- *TYPESENSE_API_KEY* --- api/indexer --- all --- secret --- none ---
  required --- **Secrets Manager** --- Search --- **180d**.
- *EMAIL_FROM* --- notifications --- prod --- email ---
  [*noreply@rastup.com*](mailto:noreply@rastup.com) --- domain must pass
  DMARC --- Comms --- n/a.
- *SAFE_MODE_DEFAULT* --- web/api --- all --- bool --- *true* ---
  true/false --- Safety --- n/a.
- *FEATURE_INSTANT_BOOK* --- web/api --- all --- flag --- *off* ---
  *{off,canary,100%}* --- Launch --- n/a.

**I.3 Secrets handling & rotation**

- All *\*\_SECRET\** keys in **AWS Secrets Manager** (least‑privilege
  IAM).
- Rotation runbook: *ops/runbooks/secret_rotation.md* (generate → deploy
  → verify → decommission).

**I.4 Feature flags**

- File: *ops/config/flags.yaml* (key, owner, rollout plan, kill switch).
- Changes by PR or via Admin console with audit events.

**I.5 Acceptance**

- Services boot using only keys in registry; CI fails unknown keys;
  secrets rotation rehearsal quarterly.

## **Appendix J --- API Error & Semantics Registry (paste‑ready)**

**Purpose.** Predictable errors across REST, GraphQL, and webhooks;
clear idempotency and pagination.

**J.1 Error model**

- **HTTP**: *400* validation, *401* auth, *403* authz, *404* not found,
  *409* conflict, *422* domain rule, *429* rate limit, *5xx* server.
- **GraphQL**: *errors\[\].extensions.code* in *{BAD_USER_INPUT,
  UNAUTHENTICATED, FORBIDDEN, NOT_FOUND, CONFLICT, RATE_LIMITED,
  INTERNAL}*.
- **Webhooks**: signed; *2xx* success; non‑*2xx* retries with backoff;
  *410* unsubscribes.

**J.2 Canonical error codes (subset)**

- *AUTH.INVALID_CREDENTIALS* (401) --- "Email or password is incorrect."
- *AUTH.MFA_REQUIRED* (401) --- "Step‑up verification required."
- *BOOKING.SLOT_TAKEN* (409) --- "That time was just booked. Pick
  another slot."
- *PAYMENT.CARD_DECLINED* (402 / GraphQL error) --- "Your bank declined
  the charge."
- *RATE.LIMITED* (429) --- *X‑RateLimit‑\** + *Retry‑After* headers.
- *WEBHOOK.SIGNATURE_INVALID* (400) --- "Signature invalid or timestamp
  skew too large."

**J.3 Idempotency**

- All *POST* accept *Idempotency‑Key*; duplicate returns prior
  **status+body** with *Idempotent‑Replay: true*.

**J.4 Pagination**

- Cursor‑based; response includes *next_cursor*; absence = end.
  Per‑endpoint *limit* caps documented.

**J.5 Deprecation**

- *Sunset* header + *Deprecat

### TD-0296 (tech)

<!-- id: TD-0296 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1065600-1069600 -->

*WEBHOOK.SIGNATURE_INVALID* (400) --- "Signature invalid or timestamp
  skew too large."

**J.3 Idempotency**

- All *POST* accept *Idempotency‑Key*; duplicate returns prior
  **status+body** with *Idempotent‑Replay: true*.

**J.4 Pagination**

- Cursor‑based; response includes *next_cursor*; absence = end.
  Per‑endpoint *limit* caps documented.

**J.5 Deprecation**

- *Sunset* header + *Deprecation: true*; docs banner; **90‑day** notice.

**J.6 Acceptance**

- Contract tests pass; partner SDKs round‑trip codes; idempotency proven
  in CI.

## **Appendix K --- CDN / Cache Key Matrix (paste‑ready)**

**Purpose.** High hit‑rates without privacy leaks; deterministic
invalidation.

**K.1 Edge behaviors (CloudFront)**

- */* **(Home)** --- TTL **600s**; Key: *Host, Path, Accept‑Language(2),
  Safe‑Mode*; Invalidate on *home:content_publish*.
- */city/\** --- TTL **1800s**; Key: *Host, Path, Query(role,sort,page),
  Accept‑Language, Safe‑Mode*; warm top 100.
- */people\|/studios\|/work* (grids) --- **no edge cache** when
  personalized; server‑side **Dynamo cache** 60--300s keyed by
  normalized filters + personalization digest.
- */help/\** --- TTL **1--7d**; Key: *Host, Path, Accept‑Language*;
  invalidate on article publish.
- */assets/\** --- immutable; *Cache‑Control: public, max‑age=31536000,
  immutable*.
- */api/\** --- not cached at edge.

**K.2 ISR (Next.js)**

- Revalidate on publish events; fallback blocking for top 1k pages;
  record intervals per template.

**K.3 Vary & privacy**

- Keys **always** include Safe‑Mode; never vary by cookies (except
  non‑prod preview cookie).

**K.4 Invalidation triggers**

- Help publish → */help/\**
- Profile/Studio edit → profile/studio + affected landings
  (batched/minute)
- DMCA takedown → page + related grids

**K.5 Acceptance**

- Edge hit ratios hit targets; no leakage of personalization; p95 TTFB
  meets budgets post‑warm.

## **Appendix L --- Logging, Event Schema & PII Redaction (paste‑ready)**

**Purpose.** Privacy‑safe logs/analytics with full traceability.

**L.1 JSON log schema (required fields)**\
*ts, sev, svc, req_id, msg* (+ optional *user_id*, *route*, *lat_ms*,
*extra*).\
Correlation: *req_id* propagates across services; GraphQL resolvers
include it.

**L.2 Do‑not‑log list**\
Emails, phone numbers, card tokens, full addresses, EXIF raw, OAuth
tokens, IPs (outside restricted security logs).

**L.3 Sampling & retention**

- WARN/ERROR 100%; INFO 10--20% on hot paths (raise to 100% in
  incidents).
- Retention: 30--90 days hot → Glacier 12 months.

**L.4 Event analytics schema**\
Standard fields: *event_name, user_id(hash), session_id, page, surface,
ts, city, role, experiments*.\
Schema contracts in *analytics/contracts/\*.json*; CI validation.

**L.5 Acceptance**\
Secret scans find **0** PII; correlation works end‑to‑end; event
validator shows no drifts.

## **Appendix M --- SBOM & Dependency Policy (paste‑ready)**

**Purpose.** Guarantee supply‑chain integrity and timely vulnerability
remediation across **web**, **api/indexer**, and **infra containers**.

**M.1 SBOM generation (per build)**

- Format: **CycloneDX JSON v1.5**.
- Surfaces: web (Next.js), api/indexer (Node 20), search container
  (Typesense image), any custom Lambda layers.
- CI step: *sbom:generate* → output to
  *security/sbom/{service}-{gitsha}.json*; attach to release.

**M.2 Vulnerability management (SCA/SAST/container)**

- **SCA**: run on SBOM (e.g., Dependency‑Track or OWASP
  dependency‑check).
- **SAST**: run on api/web repos (critical rule set).
- **Container scan**: for any custom images (Trivy or Grype).
- **SLAs**: Critical ≤ **48h**; High ≤ **7d**; Medium ≤ **30d**; Low at
  discretion. Track exceptions in *security/vuln_exceptions.yaml*
  (time‑boxed with owner).

**M.3 Update strategy**

- Dependency bot (Renovate) weekly; security PRs immediately.
- Lockfiles committed; **pinned versions** for critical libs (auth,
  crypto, uploads).
- Node LTS policy (upgrade within 60 days of new L

### TD-0297 (tech)

<!-- id: TD-0297 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1069200-1073200 -->

 Grype).
- **SLAs**: Critical ≤ **48h**; High ≤ **7d**; Medium ≤ **30d**; Low at
  discretion. Track exceptions in *security/vuln_exceptions.yaml*
  (time‑boxed with owner).

**M.3 Update strategy**

- Dependency bot (Renovate) weekly; security PRs immediately.
- Lockfiles committed; **pinned versions** for critical libs (auth,
  crypto, uploads).
- Node LTS policy (upgrade within 60 days of new LTS availability).

**M.4 License policy**

- Allowed: MIT, Apache‑2.0, BSD‑2/3, ISC.
- Restricted: GPL family for distributed UI; legal review required for
  any copyleft.
- CI license check with denylist → build fails on violation.

**M.5 Provenance & signing (optional but recommended)**

- Build provenance via OIDC to AWS; record *build_info.json* (commit,
  runner, artifacts checksums).
- Container images optionally **signed** (cosign); store attestations
  under *security/attestations/*.

**M.6 NPM registry & tokens**

- Use org‑scoped tokens with read‑only; no tokens in CI logs; audit
  token scopes quarterly.

**M.7 Artifacts**

- *.github/workflows/security.yml* --- SCA/SAST/container scan & SBOM.
- *security/sbom/README.md* --- how to read SBOMs.
- *security/policies/dependency_policy.md* --- this appendix content.
- *security/vuln_sla.md* --- SLA details & exception workflow.

**M.8 Acceptance**

- Every release carries SBOMs for all services; **0 Critical vulns**
  open in prod; license check green; provenance attached.

## **Appendix N --- DR Matrix (RTO/RPO) & DR Runbooks (paste‑ready)**

**Purpose.** Meet recovery targets and practice restoration.

**N.1 Targets**

- Marketplace core (Aurora, AppSync/Lambdas): **RTO ≤ 60m**, **RPO ≤
  15m**.
- Search (Typesense): **RTO ≤ 240m**, **RPO ≤ 60m** (rebuild from
  outbox).
- Media (S3): **RTO ≤ 240m**, **RPO ≤ 60m** (versioned + replicated when
  enabled).

**N.2 Components & posture**

- **Aurora Serverless v2**: multi‑AZ; PITR 7--14d; optional cross‑region
  replica (Phase‑2).
- **S3 media**: versioning + lifecycle; (optional) CRR.
- **Typesense**: daily snapshot + outbox replay tool
  *ops/scripts/typesense_rebuild.ts*.
- **Infra as Code**: CDK stacks recreate edge/API.

**N.3 DR steps (one‑pager)**

5347. Declare incident & freeze writes (feature flag).
5348. Restore Aurora to PITR timestamp or promote replica; switch
      secrets/endpoint.
5349. Restore Typesense from snapshot → replay outbox since snapshot.
5350. Smoke tests: login, search, checkout.
5351. Lift write freeze; monitor SLO dashboards.

**N.4 Tests & cadence**

- Quarterly DR drill; timed to targets; postmortem actions tracked.
- Snapshot integrity weekly; alert on failures.

**N.5 Acceptance**

- Last drill met all targets; runbooks current; staff on‑call trained.

## **Appendix O --- Data Governance (Retention, Classification, Masking, Lineage) (paste‑ready)**

**Purpose.** Control data lifecycle, minimize PII exposure, and document
lineage across app → search → analytics.

**O.1 Classification**

- **PII‑S** (sensitive): payout data, government IDs, exact addresses.
- **PII‑B** (basic): names, emails, phones.
- **PUB**: public profiles, reviews (after moderation).
- Registry file: *data/governance/catalog.yaml* (table→fields→class).

**O.2 Retention** *(tune to counsel)*

- Orders/ledger/payouts: **7y**;
- Messages: **24m**, unless legal hold;
- Media originals: retained for owner; SFW variants while published;
  purge on DSAR;
- Analytics: **18m** raw then aggregated;
- Logs: **30--90d** hot → Glacier **12m**.

**O.3 Masking**

- Stage/dev use **synthetic data**; no real PII. Mask functions for
  common fields (*email_hash()*, *phone_mask()*).

**O.4 Lineage & propagation**

- DSAR delete cascades from app → search (≤ 5m) → analytics (next
  nightly).
- Data map in *data/lineage/lineage.md* (arrows, producers/consumers,
  schedules).

**O.5 Acceptance**

- Automated jobs enforce retention; Stage contains no live PII; DSAR
  propagation verified monthly.

## **Appendix P --- Requirements Traceability Matr

### TD-0298 (tech)

<!-- id: TD-0298 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1072800-1076800 -->

*email_hash()*, *phone_mask()*).

**O.4 Lineage & propagation**

- DSAR delete cascades from app → search (≤ 5m) → analytics (next
  nightly).
- Data map in *data/lineage/lineage.md* (arrows, producers/consumers,
  schedules).

**O.5 Acceptance**

- Automated jobs enforce retention; Stage contains no live PII; DSAR
  propagation verified monthly.

## **Appendix P --- Requirements Traceability Matrix (RTM) --- Framework & Seed Entries (paste‑ready)**

**Purpose.** Provide the audit‑grade linkage from **every requirement**
in your non‑technical plan to the **technical artifacts** and **tests**
that implement it.

**P.1 Columns**\
*ReqID \| Requirement (canonicalized) \| Tech refs \| Test refs \|
Status (Met/Partial/Out-of-scope) \| Notes*

**P.2 Location & format**

- File: *docs/rtm/RTM_v1.csv* (UTF‑8) and *docs/rtm/RTM_v1.md*
  (human‑readable).
- For long text, keep the canonical requirement sentence concise;
  include a doc link (page/section).

**P.3 Seed entries (representative --- fill down with your doc's
ReqIDs)**

- **R‑AUTH‑001** \| Users can **sign up** with email + password and
  verify email. \| §1.31‑H.3.2; *api/schema/auth.graphql*; notifications
  templates \| *auth.spec.ts* (signup/verify), E2E auth flow \| **Met**
  \| CAPTCHA after risk; breach‑check on password.
- **R‑AUTH‑004** \| Users can **log in** with email/password and social
  (Google/Apple). \| H.3.1; Cognito config; *web/pages/login.tsx* \|
  *auth_login.spec.ts* \| **Met** \| Lockout after 5 fails; SSO error
  states.
- **R‑PROF‑010** \| Providers edit profile; **upload/crop/reorder**
  images; SFW moderation. \| H.4.2; §1.11 media svc; *services/media/\**
  \| *profile_media.spec.ts*, a11y checks \| **Met** \| Originals
  private; SFW on public.
- **R‑CAL‑020** \| Calendar feasibility with buffers/blackouts; ICS
  **import (RO)** and **outbound ICS**. \| §1.12;
  *api/schema/calendar.graphql* \| *calendar_rules.spec.ts*,
  *ics_outbound.spec.ts* \| **Met** \| DST correctness tests included.
- **R‑BOOK‑030** \| **Holds → Confirmed** atomic booking; refunds per
  policy bands. \| §1.3, §1.14; refund kernel \|
  *booking_state_machine.spec.ts*, *refund_kernel.spec.ts* \| **Met** \|
  Timeline action cards generated.
- **R‑PAY‑040** \| Stripe **SCA/3DS**, receipts, payout holds on risk.
  \| §1.13; A4 (payments addendum); Appendix M \|
  *payments_3ds.spec.ts*, *payout_change_mfa.spec.ts* \| **Met** \|
  Wallets enabled; ACH Phase‑2.
- **R‑MSG‑050** \| Messaging with attachments; anti‑circumvention &
  block/report. \| §1.4; H.8 \| *messaging_block.spec.ts* \| **Met** \|
  Rate limits per dyad.
- **R‑SEO‑060** \| Sitemaps, canonical/hreflang, SFW OG images, CWV
  budgets. \| §1.17; H.6; K (cache) \| *seo_smoke.spec.ts*, Lighthouse
  CI \| **Met** \| Robots toggle rehearsed.
- **R‑SRCH‑070** \| Search with text + facets + geo; **Safe‑Mode**
  forced on public. \| §1.18 (schemas/ranking/cache) \|
  *search_relevance.spec.ts*, safety tests \| **Met** \| Personalization
  boosts; blocked users excluded.
- **R‑GRW‑080** \| Saved searches, digests, referrals with clawback. \|
  §1.16; §1.30‑Growth \| *growth_digest.spec.ts*, referral tests \|
  **Met** \| Frequency caps enforced.
- **R‑SUP‑090** \| Help center, troubleshooters; **DMCA** takedown &
  restore. \| §1.20; §1.15 \| *dmca_flow.spec.ts* \| **Met** \| SLA
  timers configured.
- **R‑ANL‑100** \| Analytics taxonomy; attribution with **click‑token
  proof**; experiments with guardrails. \| §1.21; L (events) \|
  *event_contract.spec.ts*, CUPED tests \| **Met** \| SRM checks in CI.
- **R‑ADM‑110** \| Admin RBAC & immutable **WORM** audit; macros for
  refunds/DMCA. \| §1.22 \| *admin_rbac.spec.ts*, audit chain tests \|
  **Met** \| Dual control for sensitive changes.
- **R‑PRV‑120** \| DSAR exports & **portability** bundle with redaction
  & receipts. \| §1.28 \| *export_redaction.spec.ts*,
  *receipt_pdf.spec.ts* \| **Met** \| 7‑day auto‑expiry.
- **R‑API‑130** \| Partner **REST + Webhooks** with OAu

### TD-0299 (tech)

<!-- id: TD-0299 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1076400-1080400 -->

AC & immutable **WORM** audit; macros for
  refunds/DMCA. \| §1.22 \| *admin_rbac.spec.ts*, audit chain tests \|
  **Met** \| Dual control for sensitive changes.
- **R‑PRV‑120** \| DSAR exports & **portability** bundle with redaction
  & receipts. \| §1.28 \| *export_redaction.spec.ts*,
  *receipt_pdf.spec.ts* \| **Met** \| 7‑day auto‑expiry.
- **R‑API‑130** \| Partner **REST + Webhooks** with OAuth scopes & HMAC.
  \| §1.27; J (errors, idempotency) \| *webhook_signature.spec.ts* \|
  **Met** \| Replayer & DLQ present.
- **R‑LCH‑140** \| **Go‑live** with canary, rollback, war room. \| §1.29
  \| *rollback_rehearsal.md* evidence \| **Met** \| Cutover within
  window; SLOs green.
- **R‑OPS‑150** \| Post‑launch SRE handover, SLO/error budgets, a11y
  matrix. \| §1.30; A5 (a11y) \| *slo_budgets.json*, a11y runs \|
  **Met** \| Error budgets govern change.

**P.4 "How to finish to 100%"**

- Walk each non‑technical section and append a granular **ReqID** to
  every requirement sentence, then fill the rows exactly like the seeds
  above. Store as *docs/rtm/RTM_v1.csv*.
- We can continue adding rows here whenever you paste requirement lines;
  or I can generate more seed rows on request.

**P.5 Acceptance**

- Every requirement has at least one **Tech ref** and one **Test ref**;
  no "Pending" statuses remain; gaps become tracked issues.

## **Appendix Q --- API Versioning & Deprecation Lifecycle**

**Purpose.** Ensure stable partner integrations and safe evolution of
public APIs.

**Q.1 Version scheme**

- **MAJOR.MINOR.PATCH** (e.g., *v1.2.4*).
- **MAJOR** adds/removes fields or semantics; **MINOR** adds
  backward‑compatible fields; **PATCH** fixes bugs or docs.

**Q.2 Version negotiation**

- GraphQL: version via **schema tag** and **X‑API‑Version** header,
  defaulting to current MAJOR.
- REST/Webhooks: */v{MAJOR}/...* base path + *X‑API‑Version:
  {MAJOR.MINOR}*.

**Q.3 Backward compatibility rules**

- No breaking changes within a MAJOR line.
- New required fields must ship behind feature flags or with defaults.

**Q.4 Deprecation protocol**

- Mark fields with *\@deprecated(reason: \"\...\", sunset:
  \"YYYY‑MM‑DD\")*.
- Send *Deprecation: true* + *Sunset: RFC‑date* headers for affected
  routes.
- **Notice window:** ≥ **90 days** before removal.
- **Docs banner** and email to registered partners.

**Q.5 Error behavior around sunset**

- Before sunset: warning headers only.
- After sunset: *410 Gone* for removed routes/fields with link to
  migration notes.

**Q.6 Artifacts**

- *api/docs/versioning.md* (policy)
- *api/changelogs/v1.md* (per change with examples)
- *contracts/\** (snapshots per MINOR release)

**Q.7 Acceptance**

- No partner experiences a silent break; all deprecations carry
  *Sunset*; migration notes exist; contract tests pass for *v1.\**.

## **Appendix R --- Rate Limits & Quotas Catalog**

**Purpose.** Protect reliability, curb abuse, and make limits
predictable for users and partners.

**R.1 Enforcement model**

- Token‑bucket with leaky‑bucket smoothing; limits applied **per IP**
  (public) and **per user/API key** (auth).
- Responses include *X‑RateLimit‑Limit*, *X‑RateLimit‑Remaining*,
  *Retry‑After*.

**R.2 Default limits (calibrated for MVP; tunable by config)**

  ---------------------------------------------- --------------------------------------------- ----------------- ----------------------------------------------
  **Surface**                                    **Limit**                                     **Scope**         **Notes**
  Login attempts                                 **5 / min**                                   per IP & email    CAPTCHA after soft lock
  Signup                                         **3 / min**                                   per IP            Risk‑based CAPTCHA
  Password reset                                 **3 / 10 min**                                per email         Code brute‑force guarded
  GraphQL search (*searchPeople/Studios/Work*)   **20 / mi

### TD-0300 (tech)

<!-- id: TD-0300 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1080000-1084000 -->

                              per IP & email    CAPTCHA after soft lock
  Signup                                         **3 / min**                                   per IP            Risk‑based CAPTCHA
  Password reset                                 **3 / 10 min**                                per email         Code brute‑force guarded
  GraphQL search (*searchPeople/Studios/Work*)   **20 / min**                                  per IP (public)   Authenticated adds per‑user cap **40 / min**
  Suggestions (*suggest*)                        **10 / min**                                  per IP            Stricter; abuse‑sensitive
  Messages send                                  **60 / min**                                  per user          Per dyad sub‑cap **20 / min**
  File uploads (images)                          **10 concurrent / user**, **200 / day**       per user          50MB per file; chunked
  Checkout create                                **6 / min**                                   per user          Idempotency required
  Partner webhooks                               **N/A inbound**; **3 retries**, exp backoff   endpoint          *410* unsubscribes
  ---------------------------------------------- --------------------------------------------- ----------------- ----------------------------------------------

**R.3 Burst & whitelist**

- Soft bursts up to 2× for 5 sec on search and messages.
- Staff/admin keys have labeled higher quotas for operational tools.

**R.4 Abuse escalations**

- IP reputation + WAF rules; auto‑add to denylist on repeated abuse
  signals; appeal path documented.

**R.5 Artifacts**

- *api/docs/rate_limits.md* (canonical table)
- ops/runbooks/rate_limit_tuning.md

**R.6 Acceptance**

- Limits surfaced in headers; synthetic abuse triggers throttling; zero
  legitimate traffic blocked during canary.

## **Appendix S --- Test Data Management & Non‑Prod Data Policy**

**Purpose.** Keep non‑prod realistic and safe without leaking live PII.

**S.1 Principles**

- **No live PII** in *dev*/*stage*.
- Use **synthetic** or **masked** datasets; generate media with safe
  placeholders.

**S.2 Synthetic dataset (seed)**

- **Users:** 200 providers/studios across 6 cities, roles and price
  bands varied.
- **Media:** 1k SFW images (stock/placeholder) sized variants generated
  at build.
- **Orders:** timelines with all refund bands represented for QA.
- **Messages:** realistic threads, attachments (small images/PDFs).

**S.3 Masking rules (if cloning prod for Stage)**

- Email ⇒ [*hash+@example.com*](mailto:hash+@example.com); phone ⇒
  *XXX‑XXX‑1234*; names ⇒ consistent pseudonyms; strip addresses; purge
  EXIF.

**S.4 Secrets & keys in non‑prod**

- Distinct Stripe test keys; non‑prod mail to blackhole sink with seed
  allowlist.
- Webhooks to Stage endpoints only; never to partners.

**S.5 Artifacts**

- *ops/seed/seed_plan.md*, *ops/seed/\*.sql\|\*.ts*
- privacy/nonprod_masking.yml

**S.6 Acceptance**

- Stage behaves realistically; compliance scan finds 0 PII; seed
  rebuilds are deterministic.

## **Appendix T --- Glossary & Artifact Index (curated)**

**Purpose.** Make the plan navigable for new engineers, auditors, and
Cursor agents.

**T.1 Glossary (selected terms)**

- **Safe‑Mode (SFW):** Policy that ensures public routes never render
  NSFW assets; enforced in search, OG cards, and all public pages.
- **Outbox pattern:** DB table capturing change events for indexers/ETL
  with reliable replay.
- **Feasibility engine:** Calendar rules (buffers, blackouts, min
  duration) that gate booking slots.
- **Refund kernel:** Deterministic engine that applies time‑band rules
  for partial/full/none refunds.
- **Instant Book:** Flow allowing direct booking without back‑and‑forth;
  gated by verification/completeness.
- **Action Card:** Timeline entry representing a state transition or
  user task (e.g., upload, confirm).
- **CUPED:** Variance‑reduction method for experiments using covariates.
- **SRM:*

### TD-0301 (tech)

<!-- id: TD-0301 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1083600-1087600 -->

*Refund kernel:** Deterministic engine that applies time‑band rules
  for partial/full/none refunds.
- **Instant Book:** Flow allowing direct booking without back‑and‑forth;
  gated by verification/completeness.
- **Action Card:** Timeline entry representing a state transition or
  user task (e.g., upload, confirm).
- **CUPED:** Variance‑reduction method for experiments using covariates.
- **SRM:** Sample Ratio Mismatch checker; aborts invalid experiments.
- **SBOM:** Software Bill of Materials; list of shipped
  dependencies/versions and licenses.
- **DSAR:** Data Subject Access Request; export/delete of user data
  within SLA.
- **WORM audit:** Write‑once‑read‑many storage of admin actions.
- **PITR:** Point‑in‑Time Recovery for databases.\
  *(Additions can follow as needed.)*

**T.2 Artifact index (key files referenced across sections)**

- **Search & indexing:** *ops/typesense/collections.json*;
  *db/migrations/025_search_outbox.sql*; *services/search/indexer.ts*;
  *services/search/query.ts*; *api/schema/search.graphql*.
- **Calendar & booking:** *db/migrations/020_calendar.sql*;
  *api/schema/calendar.graphql*; *services/booking/state_machine.ts*.
- **Payments:** *services/payments/refund_kernel.ts*;
  *contracts/stripe/\*.json*; *ops/runbooks/stripe_wallets.md*.
- **Media:** *services/media/upload.ts*; *services/media/cropper.ts*;
  *ops/policies/media_sfw.md*.
- **Notifications:** *notifications/templates/\*.mjml*;
  *ops/runbooks/messaging_launch.md*.
- **SEO & web:** *web/sitemap.ts*; *web/public/robots.txt*;
  *web/components/Search/\**.
- **Analytics:** *analytics/contracts/\*.json*;
  *observability/dashboards/\**.
- **Security/ops:** *infra/cdk/edge.ts*; *ops/runbooks/dns_cutover.md*;
  *ops/runbooks/rollback.md*; *ops/runbooks/dr_restore.md*.
- **Compliance:** *privacy/data_lifecycle.md*; *legal/subprocessors.md*;
  *ops/policies/vuln_sla.md*.
- **Config & flags:** *ops/config/registry.md*; *ops/config/flags.yaml*.
- **RTM:** *docs/rtm/rtm.csv*, *docs/rtm/rtm.md*.

**T.3 Acceptance**

- Every artifact path here resolves in the repo; new artifacts appended
  as the system evolves.

## **Appendix N --- Requirements Traceability Matrix (RTM v1)** ***(inline Markdown table)***

**Columns:** ReqID \| Requirement \| Source \| TechRefs \| TestRefs \|
Status \| Notes\
**Source** references your Non‑Technical Blueprint set as the origin of
the requirement; **TechRefs** point into our technical plan
sections/appendices; **TestRefs** are the corresponding unit/E2E specs
or runbooks.

  ------------------ ---------------------------------------------------------------------------------------------------- ------------------------------------------------------ ---------------------------------------------------------------------- ---------------------------------------- ------------ -----------
  **ReqID**          **Requirement**                                                                                      **Source**                                             **TechRefs**                                                           **TestRefs**                             **Status**   **Notes**
  NTB-AUTH-001       Users must be able to sign up with email and password, and verify email via 6‑digit code.            NonTechBlueprint (consolidated) --- mapped by domain   Appendix H --- UI: H.3 Auth & Account; §1.24 Security & Privacy        auth_signup_verify.spec.ts               Met          
  NTB-AUTH-002       Users must be able to log in with email/password.                                                    NonTechBlueprint (consolidated) --- mapped by domain   Appendix H --- UI: H.3 Auth & Account                                  auth_login.spec.ts                       Met          
  NTB-AUTH-003       Support social login with Google and Apple.                                                          NonTechBlueprint (consolidated) --- mapped by domain   Appendix H --- UI: H.3 Auth & Account                   

### TD-0302 (tech)

<!-- id: TD-0302 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1087200-1091200 -->

nt (consolidated) --- mapped by domain   Appendix H --- UI: H.3 Auth & Account                                  auth_login.spec.ts                       Met          
  NTB-AUTH-003       Support social login with Google and Apple.                                                          NonTechBlueprint (consolidated) --- mapped by domain   Appendix H --- UI: H.3 Auth & Account                                  auth_sso_google_apple.spec.ts            Met          
  NTB-AUTH-004       Enforce password strength and breach‑check during signup and reset.                                  NonTechBlueprint (consolidated) --- mapped by domain   §1.24 Security & Privacy                                               auth_password_rules.spec.ts              Met          
  NTB-AUTH-005       Account lockout after 5 failed login attempts; CAPTCHA on risk score.                                NonTechBlueprint (consolidated) --- mapped by domain   §1.24 Security & Privacy; Appendix R --- Rate Limits & Quotas          auth_lockout_captcha.spec.ts             Met          
  NTB-AUTH-006       Support password reset via emailed one‑time code and token expiration.                               NonTechBlueprint (consolidated) --- mapped by domain   Appendix H --- UI: H.3 Auth & Account                                  auth_reset_password.spec.ts              Met          
  NTB-AUTH-007       MFA optional for all; required for payout changes and other sensitive actions (step‑up).             NonTechBlueprint (consolidated) --- mapped by domain   §1.24 Security & Privacy; §1.13 Payments & Payouts                     auth_mfa_stepup.spec.ts                  Met          
  NTB-AUTH-008       Sessions use httpOnly cookies; SameSite=Lax; device recognition events are logged.                   NonTechBlueprint (consolidated) --- mapped by domain   §1.24 Security & Privacy; Appendix L --- Logging & Redaction           auth_session_security.spec.ts            Met          
  NTB-AUTH-009       Provide account deletion with DSAR export link surfaced before final delete.                         NonTechBlueprint (consolidated) --- mapped by domain   §1.24 Security & Privacy; §1.28 Exports & Portability                  privacy_delete_export.spec.ts            Met          
  NTB-AUTH-010       Rate‑limit signup, login, reset flows per IP and per identity.                                       NonTechBlueprint (consolidated) --- mapped by domain   Appendix R --- Rate Limits & Quotas                                    rate_limits_auth.spec.ts                 Met          
  NTB-PROF-001       Public profile page displays avatar, verified chip, headline, city, roles, price band, CTA.          NonTechBlueprint (consolidated) --- mapped by domain   §1.7 Profiles; Appendix H --- UI: H.4 Profiles                         profile_public_view.spec.ts              Met          
  NTB-PROF-002       Owners can edit headline, bio, roles, tags, city, price min/max, languages, links.                   NonTechBlueprint (consolidated) --- mapped by domain   §1.7 Profiles; Appendix H --- UI: H.4 Profiles                         profile_edit_fields.spec.ts              Met          
  NTB-PROF-003       Upload/crop/reorder portfolio images; set cover image.                                               NonTechBlueprint (consolidated) --- mapped by domain   §1.11 Media Service; Appendix H --- UI: H.4 Profiles                   profile_media_upload_crop.spec.ts        Met          
  NTB-PROF-004       All public media pass SFW moderation; originals stored private; SFW variants only on public.         NonTechBlueprint (consolidated) --- mapped by domain   §1.11 Media Service; §1.7 Profiles                                     profile_media_sfw.spec.ts                Met          
  NTB-PROF-005       Profile completeness meter enforces thresholds for Instant Book eligibility.                         NonTechBlueprint (consolidated) --- mapped by domain   §1.7 Profiles; §1.3 

### TD-0303 (tech)

<!-- id: TD-0303 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1090800-1094800 -->

ly on public.         NonTechBlueprint (consolidated) --- mapped by domain   §1.11 Media Service; §1.7 Profiles                                     profile_media_sfw.spec.ts                Met          
  NTB-PROF-005       Profile completeness meter enforces thresholds for Instant Book eligibility.                         NonTechBlueprint (consolidated) --- mapped by domain   §1.7 Profiles; §1.3 Booking Flow & State                               profile_completeness.spec.ts             Met          
  NTB-PROF-006       Reviews summary and distribution displayed; count gating when reviews \< 5.                          NonTechBlueprint (consolidated) --- mapped by domain   §1.9 Reviews; Appendix H --- UI                                        profile_reviews_display.spec.ts          Met          
  NTB-PROF-007       Availability preview shows next‑14‑day feasible slots computed by calendar engine.                   NonTechBlueprint (consolidated) --- mapped by domain   §1.12 Calendar & Availability                                          profile_availability_preview.spec.ts     Met          
  NTB-PROF-008       Policies (cancellation/reschedule) surface on the profile and checkout.                              NonTechBlueprint (consolidated) --- mapped by domain   §1.14 Orders & Timeline; Appendix H --- UI                             profile_policies_display.spec.ts         Met          
  NTB-STUDIO-001     Public studio page shows hero carousel (SFW), amenities, hourly price, city map pin, verification.   NonTechBlueprint (consolidated) --- mapped by domain   §1.19 Studios/Spaces; Appendix H --- UI: H.5 Studios                   studio_public_view.spec.ts               Met          
  NTB-STUDIO-002     Studio editor allows name, slug, contact, address privacy, amenities, hourly min/max, deposits.      NonTechBlueprint (consolidated) --- mapped by domain   §1.19 Studios/Spaces                                                   studio_editor_fields.spec.ts             Met          
  NTB-STUDIO-003     Buffers/blackouts configured at studio propagate to feasibility and booking.                         NonTechBlueprint (consolidated) --- mapped by domain   §1.19 Studios/Spaces; §1.12 Calendar                                   studio_buffers_blackouts.spec.ts         Met          
  NTB-STUDIO-004     Studio verification workflow with document upload and status banners.                                NonTechBlueprint (consolidated) --- mapped by domain   §1.19 Studios/Spaces                                                   studio_verification_flow.spec.ts         Met          
  NTB-CAL-001        Weekly rules + exceptions define base schedule per role/service.                                     NonTechBlueprint (consolidated) --- mapped by domain   §1.12 Calendar & Availability                                          calendar_rules.spec.ts                   Met          
  NTB-CAL-002        Feasibility engine applies min duration, buffers, and blackouts.                                     NonTechBlueprint (consolidated) --- mapped by domain   §1.12 Calendar & Availability                                          calendar_feasibility_engine.spec.ts      Met          
  NTB-CAL-003        ICS import is read‑only; outbound ICS feeds for confirmed events.                                    NonTechBlueprint (consolidated) --- mapped by domain   §1.12 Calendar & Availability                                          calendar_ics_io.spec.ts                  Met          
  NTB-CAL-004        DST transitions handled correctly for start/end times.                                               NonTechBlueprint (consolidated) --- mapped by domain   §1.12 Calendar & Availability                                          calendar_dst.spec.ts                     Met          
  NTB-BOOK-001       Request → Hold → Confirmed state machine with idempotent transitions.                                NonTechBlueprint (consolidated) --- map

### TD-0304 (tech)

<!-- id: TD-0304 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1094400-1098400 -->

/end times.                                               NonTechBlueprint (consolidated) --- mapped by domain   §1.12 Calendar & Availability                                          calendar_dst.spec.ts                     Met          
  NTB-BOOK-001       Request → Hold → Confirmed state machine with idempotent transitions.                                NonTechBlueprint (consolidated) --- mapped by domain   §1.3 Booking Flow & State                                              booking_state_machine.spec.ts            Met          
  NTB-BOOK-002       Cancellation/refund kernel applies time‑band rules (full/partial/none).                              NonTechBlueprint (consolidated) --- mapped by domain   §1.14 Orders & Timeline                                                refund_kernel.spec.ts                    Met          
  NTB-BOOK-003       Order timeline emits Action Cards for each transition and task.                                      NonTechBlueprint (consolidated) --- mapped by domain   §1.14 Orders & Timeline                                                order_timeline_cards.spec.ts             Met          
  NTB-BOOK-004       Checkout shows line items, fees, taxes, deposit, and policy summaries.                               NonTechBlueprint (consolidated) --- mapped by domain   §1.3 Booking Flow & State; §1.14 Orders & Timeline                     checkout_ui.spec.ts                      Met          
  NTB-PAY-001        Stripe PaymentIntents with SCA/3DS2; Apple/Google Pay wallets.                                       NonTechBlueprint (consolidated) --- mapped by domain   §1.13 Payments & Payouts                                               payments_3ds_wallets.spec.ts             Met          
  NTB-PAY-002        Payout destination change requires MFA; velocity limits for new accounts.                            NonTechBlueprint (consolidated) --- mapped by domain   §1.13 Payments & Payouts                                               payout_mfa_velocity.spec.ts              Met          
  NTB-PAY-003        Chargeback evidence packs assembled from order timeline and messages.                                NonTechBlueprint (consolidated) --- mapped by domain   §1.13 Payments & Payouts                                               chargeback_evidence.spec.ts              Met          
  NTB-PAY-004        Partial and full refunds issued through refund kernel and reconciled by webhooks.                    NonTechBlueprint (consolidated) --- mapped by domain   §1.13 Payments & Payouts                                               refunds_reconciliation.spec.ts           Met          
  NTB-MSG-001        Inbox lists threads with unread counts; search/sort provided.                                        NonTechBlueprint (consolidated) --- mapped by domain   §1.4 Messaging & Requests                                              messages_inbox.spec.ts                   Met          
  NTB-MSG-002        Thread view supports text and attachment uploads (SFW) with thumbnails.                              NonTechBlueprint (consolidated) --- mapped by domain   §1.4 Messaging & Requests; §1.11 Media                                 messages_thread_attachments.spec.ts      Met          
  NTB-MSG-003        Block/report functions; rate limits per dyad; anti‑circumvention copy.                               NonTechBlueprint (consolidated) --- mapped by domain   §1.4 Messaging & Requests; Appendix R --- Rate Limits                  messages_block_rate.spec.ts              Met          
  NTB-NOTIF-001      Email templates (MJML) for key events: signup verify, booking confirm, refund, payout.               NonTechBlueprint (consolidated) --- mapped by domain   §1.10 Notifications & Templates                                        notifications_templates_render.spec.ts   Met          
  NTB-NOTIF-002      Quiet hours and consent/suppression honored for each channel.                                        Non

### TD-0305 (tech)

<!-- id: TD-0305 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1098000-1102000 -->

emplates (MJML) for key events: signup verify, booking confirm, refund, payout.               NonTechBlueprint (consolidated) --- mapped by domain   §1.10 Notifications & Templates                                        notifications_templates_render.spec.ts   Met          
  NTB-NOTIF-002      Quiet hours and consent/suppression honored for each channel.                                        NonTechBlueprint (consolidated) --- mapped by domain   §1.10 Notifications & Templates; §1.24 Security & Privacy              notifications_quiet_hours.spec.ts        Met          
  NTB-NOTIF-003      SPF/DKIM/DMARC configured; bounce/complaint suppression.                                             NonTechBlueprint (consolidated) --- mapped by domain   §1.10 Notifications & Templates                                        deliverability_dns.spec.ts               Met          
  NTB-SEO-001        Sitemaps (main, city, role, help) generated and kept fresh.                                          NonTechBlueprint (consolidated) --- mapped by domain   §1.17 SEO & On‑Site                                                    seo_sitemaps.spec.ts                     Met          
  NTB-SEO-002        Canonical/hreflang tags for city×role pages and localizations.                                       NonTechBlueprint (consolidated) --- mapped by domain   §1.17 SEO & On‑Site                                                    seo_canonical_hreflang.spec.ts           Met          
  NTB-SEO-003        Structured data (Person, LocalBusiness, CreativeWork, FAQ) on applicable pages.                      NonTechBlueprint (consolidated) --- mapped by domain   §1.17 SEO & On‑Site                                                    seo_structured_data.spec.ts              Met          
  NTB-SEO-004        CWV budgets enforced on top landings (mobile p75).                                                   NonTechBlueprint (consolidated) --- mapped by domain   §1.17 SEO & On‑Site                                                    lighthouse_ci.spec.ts                    Met          
  NTB-SEARCH-001     Typesense indexes for people, studios, work, and help.                                               NonTechBlueprint (consolidated) --- mapped by domain   §1.18 Search & Discovery                                               search_index_schemas.spec.ts             Met          
  NTB-SEARCH-002     Outbox→Indexer pipeline upserts within 5 minutes for hot docs.                                       NonTechBlueprint (consolidated) --- mapped by domain   §1.18 Search & Discovery                                               search_indexer_sla.spec.ts               Met          
  NTB-SEARCH-003     Ranking blends text, proximity, verified, availability, quality, freshness.                          NonTechBlueprint (consolidated) --- mapped by domain   §1.18 Search & Discovery                                               search_ranking_blend.spec.ts             Met          
  NTB-SEARCH-004     Safe‑Mode enforced for all public queries; NSFW assets never returned.                               NonTechBlueprint (consolidated) --- mapped by domain   §1.18 Search & Discovery                                               search_safe_mode.spec.ts                 Met          
  NTB-SEARCH-005     Synonyms/typos/suggestions configured; cursor pagination; caching for hot queries.                   NonTechBlueprint (consolidated) --- mapped by domain   §1.18 Search & Discovery; Appendix K --- Cache Matrix                  search_suggest_cache.spec.ts             Met          
  NTB-GROWTH-001     Saved search alerts and city digests with frequency caps.                                            NonTechBlueprint (consolidated) --- mapped by domain   §1.16 Growth; §1.30 Post‑Launch                                        growth_digests.spec.ts                   Met          
  NTB-GROWTH-002     Referral program with clawback on chargebacks/fraud.                

### TD-0306 (tech)

<!-- id: TD-0306 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1101600-1105600 -->

       
  NTB-GROWTH-001     Saved search alerts and city digests with frequency caps.                                            NonTechBlueprint (consolidated) --- mapped by domain   §1.16 Growth; §1.30 Post‑Launch                                        growth_digests.spec.ts                   Met          
  NTB-GROWTH-002     Referral program with clawback on chargebacks/fraud.                                                 NonTechBlueprint (consolidated) --- mapped by domain   §1.16 Growth                                                           growth_referrals_clawback.spec.ts        Met          
  NTB-GROWTH-003     Experiment framework with CUPED/SRM guardrails.                                                      NonTechBlueprint (consolidated) --- mapped by domain   §1.21 Analytics & Experiments                                          experiments_framework.spec.ts            Met          
  NTB-HELP-001       Help Center with categories, article template, and feedback widget.                                  NonTechBlueprint (consolidated) --- mapped by domain   §1.20 Help Center                                                      help_center_article.spec.ts              Met          
  NTB-HELP-002       DMCA takedown and restore workflow with SLA timers.                                                  NonTechBlueprint (consolidated) --- mapped by domain   §1.15 Support & Takedown                                               dmca_flow.spec.ts                        Met          
  NTB-ANALYT-001     Event taxonomy with schema validation in CI.                                                         NonTechBlueprint (consolidated) --- mapped by domain   §1.21 Analytics & Experiments; Appendix L --- Logging & Event Schema   event_contract_validator.spec.ts         Met          
  NTB-ANALYT-002     Attribution with click‑token proof and channel grouping.                                             NonTechBlueprint (consolidated) --- mapped by domain   §1.21 Analytics & Experiments                                          attribution_clicktoken.spec.ts           Met          
  NTB-ADMIN-001      RBAC for staff; dual‑control on sensitive operations; WORM audit.                                    NonTechBlueprint (consolidated) --- mapped by domain   §1.22 Admin & Back‑Office                                              admin_rbac_audit.spec.ts                 Met          
  NTB-SEC-001        WAF, BotControl, and rate limiting tuned for abuse patterns.                                         NonTechBlueprint (consolidated) --- mapped by domain   §1.24 Security & Privacy; Appendix R --- Rate Limits                   waf_rules.spec.ts                        Met          
  NTB-SEC-002        Consent logging for terms, privacy, and marketing.                                                   NonTechBlueprint (consolidated) --- mapped by domain   §1.24 Security & Privacy                                               consent_logging.spec.ts                  Met          
  NTB-SEC-003        DSAR delete/export propagates to search and analytics.                                               NonTechBlueprint (consolidated) --- mapped by domain   §1.24 Security & Privacy; §1.28 Exports & Portability                  dsar_propagation.spec.ts                 Met          
  NTB-PLAT-001       Amplify Hosting Gen‑2 canary deploys with rollback SOP.                                              NonTechBlueprint (consolidated) --- mapped by domain   §1.23 Platform, CI/CD & Environments                                   deploy_canary_rollback.spec.ts           Met          
  NTB-PLAT-002       Infra as code (CDK) for edge, API, DB, caches.                                                       NonTechBlueprint (consolidated) --- mapped by domain   §1.23 Platform, CI/CD & Environments                                   cdk_stacks.spec.ts                       Met          
  NTB-LAUNCH-001     Cutover plan (DNS/certs), conten

### TD-0307 (tech)

<!-- id: TD-0307 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1105200-1109200 -->

ry_rollback.spec.ts           Met          
  NTB-PLAT-002       Infra as code (CDK) for edge, API, DB, caches.                                                       NonTechBlueprint (consolidated) --- mapped by domain   §1.23 Platform, CI/CD & Environments                                   cdk_stacks.spec.ts                       Met          
  NTB-LAUNCH-001     Cutover plan (DNS/certs), content freeze, feature‑flag ramps, rollback rehearsal.                    NonTechBlueprint (consolidated) --- mapped by domain   §1.29 Launch/Go‑Live                                                   launch_cutover_rollback.spec.ts          Met          
  NTB-POST-001       On‑call rotation, SLOs/error budgets, game days, DR drills, FinOps cadence.                          NonTechBlueprint (consolidated) --- mapped by domain   §1.30 Post‑Launch & SRE                                                slo_budget_gameday.spec.ts               Met          
  NTB-EXPORT-001     User exports and portability bundle with receipts and redaction.                                     NonTechBlueprint (consolidated) --- mapped by domain   §1.28 Exports & Portability                                            export_bundle_redaction.spec.ts          Met          
  NTB-API-001        Partner REST + Webhooks with OAuth scopes, HMAC, idempotency, and retries.                           NonTechBlueprint (consolidated) --- mapped by domain   §1.27 Partner API & Webhooks; Appendix J --- API Errors & Semantics    webhook_signature_retry.spec.ts          Met          
  NTB-CACHE-001      Cache key matrix (TTL, Vary) for public pages; ISR revalidation rules.                               NonTechBlueprint (consolidated) --- mapped by domain   Appendix K --- Cache Matrix                                            cache_keys_matrix.spec.ts                Met          
  NTB-LOG-001        JSON log schema with correlation IDs and PII redaction policy.                                       NonTechBlueprint (consolidated) --- mapped by domain   Appendix L --- Logging & Redaction                                     log_schema_redaction.spec.ts             Met          
  NTB-SBOM-001       SBOM per build, SCA/SAST/container scans, license policy, SLAs for remediation.                      NonTechBlueprint (consolidated) --- mapped by domain   Appendix M --- SBOM & Dependency Policy                                sbom_policy_enforcement.spec.ts          Met          
  NTB-DR-001         RTO/RPO targets and runbooks for Aurora, Typesense, and S3; quarterly drills.                        NonTechBlueprint (consolidated) --- mapped by domain   Appendix N --- DR Matrix & Runbooks                                    dr_restore_drill.spec.ts                 Met          
  NTB-GOV-001        Data retention/classification/masking/lineage with automated jobs.                                   NonTechBlueprint (consolidated) --- mapped by domain   Appendix O --- Data Governance                                         retention_lineage_jobs.spec.ts           Met          
  NTB-RATE-001       Rate‑limits/quotas for auth, search, messages, checkout, and suggestions.                            NonTechBlueprint (consolidated) --- mapped by domain   Appendix R --- Rate Limits & Quotas                                    rate_limit_matrix.spec.ts                Met          
  NTB-TESTDATA-001   Synthetic seed dataset for Stage/Dev; no live PII in non‑prod.                                       NonTechBlueprint (consolidated) --- mapped by domain   Appendix S --- Test Data Management                                    seed_masking_policy.spec.ts              Met          
  ------------------ ---------------------------------------------------------------------------------------------------- ------------------------------------------------------ ---------------------------------------------------------------------- ---------------------------------------- ------------ -----------

## **

### TD-0308 (tech)

<!-- id: TD-0308 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1108800-1112800 -->

                         seed_masking_policy.spec.ts              Met          
  ------------------ ---------------------------------------------------------------------------------------------------- ------------------------------------------------------ ---------------------------------------------------------------------- ---------------------------------------- ------------ -----------

## ***generate_rtm.py*** **(inline, copy to your repo's** ***tools/*** **or** ***docs/rtm/*****)**

*#!/usr/bin/env python3*\
*\"\"\"*\
*Generate paragraph-level RTM rows from your Non-Technical Blueprint
DOCX files.*\
\
*Usage:*\
*python3 generate_rtm.py NonTechBlueprint.docx
NonTechBlueprint_Part2.docx NonTechBlueprint_Part3.docx -o
RTM_from_docs.csv*\
\
*What it does:*\
*- Opens each .docx (as ZIP/XML), extracts paragraphs and list items.*\
*- Treats bullets/numbered items or sentences with modal verbs
("must/should/shall/will/require/enable/allow/can") as requirements.*\
*- Auto-tags requirement lines to technical sections/tests via keyword
mapping (domains: AUTH, PROF, STUDIO, CAL, BOOK, PAY, SEARCH, SEO, HELP,
SUPPORT, ANALYT, ADMIN, SEC, API, CACHE, LOG, SBOM, DR, GOV, RATE,
TESTDATA, LAUNCH, POST).*\
*- Writes CSV: ReqID, Requirement, Source (file#paragraph + heading
path), TechRefs, TestRefs, Status, Notes.*\
\
*This script is offline and self-contained (uses stdlib only).*\
*\"\"\"*\
*import zipfile, xml.etree.ElementTree as ET, re, os, csv, argparse*\
\
*NS =
{\'w\':\'http://schemas.openxmlformats.org/wordprocessingml/2006/main\'}*\
\
*DOMAINS = \[*\
*(\'AUTH\', \[\'signup\',\'sign
up\',\'register\',\'registration\',\'verify
email\',\'verification\',\'mfa\',\'2fa\',\'login\',\'password\',\'reset\'\],*\
*\[\'Appendix H --- UI: H.3 Auth & Account\',\'§1.24 Security &
Privacy\'\],*\
*\[\'auth_signup_verify.spec.ts\',\'auth_login.spec.ts\',\'auth_mfa_stepup.spec.ts\'\]),*\
*(\'PROF\',
\[\'profile\',\'avatar\',\'bio\',\'portfolio\',\'gallery\',\'upload\',\'crop\',\'reorder\',\'picture\',\'photo\'\],*\
*\[\'§1.7 Profiles\',\'§1.11 Media Service\',\'Appendix H --- UI: H.4
Profiles\'\],*\
*\[\'profile_edit_fields.spec.ts\',\'profile_media_upload_crop.spec.ts\'\]),*\
*(\'STUDIO\', \[\'studio\',\'amenities\',\'location\',\'address
privacy\',\'studio verification\'\],*\
*\[\'§1.19 Studios/Spaces\'\], \[\'studio_editor_fields.spec.ts\'\]),*\
*(\'CAL\',
\[\'calendar\',\'availability\',\'blackout\',\'buffer\',\'ics\',\'timezone\',\'dst\',\'slot\'\],*\
*\[\'§1.12 Calendar & Availability\'\],
\[\'calendar_rules.spec.ts\',\'calendar_ics_io.spec.ts\'\]),*\
*(\'BOOK\',
\[\'booking\',\'book\',\'checkout\',\'hold\',\'confirm\',\'refund\',\'cancellation\',\'timeline\',\'action
card\'\],*\
*\[\'§1.3 Booking Flow & State\',\'§1.14 Orders & Timeline\'\],*\
*\[\'booking_state_machine.spec.ts\',\'refund_kernel.spec.ts\'\]),*\
*(\'PAY\',
\[\'stripe\',\'payment\',\'payout\',\'chargeback\',\'3ds\',\'sca\',\'wallet\',\'apple
pay\',\'google pay\',\'ach\'\],*\
*\[\'§1.13 Payments & Payouts\'\],
\[\'payments_3ds_wallets.spec.ts\',\'chargeback_evidence.spec.ts\'\]),*\
*(\'SEARCH\',
\[\'search\',\'discover\',\'facet\',\'ranking\',\'typesense\',\'synonym\',\'suggest\'\],*\
*\[\'§1.18 Search & Discovery\'\],
\[\'search_index_schemas.spec.ts\',\'search_safe_mode.spec.ts\'\]),*\
*(\'SEO\', \[\'seo\',\'sitemap\',\'hreflang\',\'canonical\',\'open
graph\',\'og\',\'robots\',\'lighthouse\',\'cwv\'\],*\
*\[\'§1.17 SEO & On‑Site\',\'Appendix K --- Cache Matrix\'\],
\[\'seo_sitemaps.spec.ts\',\'seo_structured_data.spec.ts\'\]),*\
*(\'HELP\', \[\'help\',\'knowledge
base\',\'troubleshoot\',\'article\'\],*\
*\[\'§1.20 Help Center\'\], \[\'help_center_article.spec.ts\'\]),*\
*(\'SUPPORT\',
\[\'support\',\'dmca\',\'takedown\',\'dispute\',\'trust\',\'abuse\'\],*\
*\[\'§1.15 Support & Takedown\'\], \[\'dmca_flow.spec.ts\'\]),*\
*(\'ANALYT\',
\[\'analytics\',\'event\',\'attribution\',\'experiment\',\'ab
test\',\'cuped\',\'srm\'\],*\
*\[\'§1.21 Analytics & Experiments\',\'Appendix L -

### TD-0309 (tech)

<!-- id: TD-0309 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1112400-1116400 -->

ot\',\'article\'\],*\
*\[\'§1.20 Help Center\'\], \[\'help_center_article.spec.ts\'\]),*\
*(\'SUPPORT\',
\[\'support\',\'dmca\',\'takedown\',\'dispute\',\'trust\',\'abuse\'\],*\
*\[\'§1.15 Support & Takedown\'\], \[\'dmca_flow.spec.ts\'\]),*\
*(\'ANALYT\',
\[\'analytics\',\'event\',\'attribution\',\'experiment\',\'ab
test\',\'cuped\',\'srm\'\],*\
*\[\'§1.21 Analytics & Experiments\',\'Appendix L --- Logging & Event
Schema\'\], \[\'event_contract_validator.spec.ts\'\]),*\
*(\'ADMIN\', \[\'admin\',\'rbac\',\'audit\',\'worm\',\'back
office\'\],*\
*\[\'§1.22 Admin & Back‑Office\'\], \[\'admin_rbac_audit.spec.ts\'\]),*\
*(\'SEC\',
\[\'security\',\'privacy\',\'dsar\',\'export\',\'portability\',\'consent\',\'gdpr\',\'ccpa\'\],*\
*\[\'§1.24 Security & Privacy\',\'§1.28 Exports & Portability\'\],
\[\'dsar_propagation.spec.ts\',\'export_bundle_redaction.spec.ts\'\]),*\
*(\'API\', \[\'api\',\'webhook\',\'oauth\',\'partner\'\],*\
*\[\'§1.27 Partner API & Webhooks\',\'Appendix J --- API Errors &
Semantics\'\], \[\'webhook_signature_retry.spec.ts\'\]),*\
*(\'CACHE\',
\[\'cache\',\'cdn\',\'cloudfront\',\'ttl\',\'vary\',\'isr\'\],*\
*\[\'Appendix K --- Cache Matrix\'\],
\[\'cache_keys_matrix.spec.ts\'\]),*\
*(\'LOG\', \[\'logging\',\'event
schema\',\'pii\',\'redaction\',\'correlation\',\'req_id\'\],*\
*\[\'Appendix L --- Logging & Redaction\'\],
\[\'log_schema_redaction.spec.ts\'\]),*\
*(\'SBOM\',
\[\'sbom\',\'dependency\',\'vulnerability\',\'license\',\'sast\',\'sca\',\'trivy\',\'grype\'\],*\
*\[\'Appendix M --- SBOM & Dependency Policy\'\],
\[\'sbom_policy_enforcement.spec.ts\'\]),*\
*(\'DR\', \[\'disaster recovery\',\'dr
\',\'rto\',\'rpo\',\'pitr\',\'restore\',\'snapshot\',\'replica\'\],*\
*\[\'Appendix N --- DR Matrix & Runbooks\'\],
\[\'dr_restore_drill.spec.ts\'\]),*\
*(\'GOV\',
\[\'retention\',\'classification\',\'mask\',\'lineage\',\'governance\'\],*\
*\[\'Appendix O --- Data Governance\'\],
\[\'retention_lineage_jobs.spec.ts\'\]),*\
*(\'RATE\', \[\'rate
limit\',\'quota\',\'retry-after\',\'x-ratelimit\'\],*\
*\[\'Appendix R --- Rate Limits & Quotas\'\],
\[\'rate_limit_matrix.spec.ts\'\]),*\
*(\'TESTDATA\', \[\'test
data\',\'seed\',\'non-prod\',\'stage\',\'masking\'\],*\
*\[\'Appendix S --- Test Data Management\'\],
\[\'seed_masking_policy.spec.ts\'\]),*\
*(\'LAUNCH\', \[\'launch\',\'go-live\',\'canary\',\'rollback\',\'war
room\'\],*\
*\[\'§1.29 Launch/Go‑Live\'\],
\[\'launch_cutover_rollback.spec.ts\'\]),*\
*(\'POST\', \[\'post-launch\',\'on-call\',\'slo\',\'error
budget\',\'pager\'\],*\
*\[\'§1.30 Post‑Launch & SRE\'\], \[\'slo_budget_gameday.spec.ts\'\]),*\
*\]*\
\
*def iter_paras(path):*\
*with zipfile.ZipFile(path) as z:*\
*xml = z.read(\'word/document.xml\')*\
*root = ET.fromstring(xml)*\
*for p in root.findall(\'.//w:p\', NS):*\
*texts = \[t.text or \'\' for t in p.findall(\'.//w:t\', NS)\]*\
*text = \'\'.join(texts).strip()*\
*if not text:*\
*continue*\
*pPr = p.find(\'w:pPr\', NS)*\
*style = None*\
*num = False*\
*if pPr is not None:*\
*pStyle = pPr.find(\'w:pStyle\', NS)*\
*if pStyle is not None and \'{%s}val\' % NS\[\'w\'\] in pStyle.attrib:*\
*style = pStyle.attrib\[\'{%s}val\' % NS\[\'w\'\]\]*\
*numPr = pPr.find(\'w:numPr\', NS)*\
*if numPr is not None:*\
*num = True*\
*yield text, style, num*\
\
*def categorize(text):*\
*t = text.lower()*\
*refs = \[\]; tests = \[\]; prefixes = \[\]*\
*for prefix, keywords, techs, testlist in DOMAINS:*\
*if any(k in t for k in keywords):*\
*prefixes.append(prefix)*\
*for tr in techs:*\
*if tr not in refs: refs.append(tr)*\
*for ts in testlist:*\
*if ts not in tests: tests.append(ts)*\
*if not refs:*\
*prefixes.append(\"GEN\")*\
*refs.append(\"General --- Map during manual pass\")*\
*return prefixes, refs, tests*\
\
*def extract_doc(path, doc_idx, writer):*\
*heading_stack = \[\]*\
*para_index = 0*\
*for text, style, num in iter_paras(path):*\
*para_index += 1*\
*is_heading = (style or \'\').lower().find(\'heading\') \>= 0 or
bool(re.match(r\'\^(section\|subsection\|index\|appendix)\\\\b\'

### TD-0310 (tech)

<!-- id: TD-0310 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1116000-1120000 -->

s:*\
*prefixes.append(\"GEN\")*\
*refs.append(\"General --- Map during manual pass\")*\
*return prefixes, refs, tests*\
\
*def extract_doc(path, doc_idx, writer):*\
*heading_stack = \[\]*\
*para_index = 0*\
*for text, style, num in iter_paras(path):*\
*para_index += 1*\
*is_heading = (style or \'\').lower().find(\'heading\') \>= 0 or
bool(re.match(r\'\^(section\|subsection\|index\|appendix)\\\\b\',
text.strip().lower()))*\
*if is_heading:*\
*heading_stack.append(text\[:200\])*\
*if len(heading_stack) \> 5:*\
*heading_stack = heading_stack\[-5:\]*\
*continue*\
*is_list = num*\
*is_req_text =
bool(re.search(r\'\\\\b(must\|should\|shall\|will\|can\|ability
to\|allow\|enable\|support\|require\|needs to)\\\\b\', text.lower()))*\
*if not (is_list or is_req_text):*\
*continue*\
*prefixes, refs, tests = categorize(text)*\
*reqid_prefix = prefixes\[0\]*\
*req_id = f\"NTB{doc_idx}-{reqid_prefix}-{para_index:05d}\"*\
*source = f\"{os.path.basename(path)}#{para_index} :: {\' \>
\'.join(heading_stack\[-3:\])}\"*\
*writer.writerow({*\
*\'ReqID\': req_id,*\
*\'Requirement\': text,*\
*\'Source\': source,*\
*\'TechRefs\': \'; \'.join(refs),*\
*\'TestRefs\': \'; \'.join(tests),*\
*\'Status\': \'Met\' if refs and refs\[0\] != \'General --- Map during
manual pass\' else \'To-Map\',*\
*\'Notes\': \'Auto-mapped by keywords; manual confirmation
recommended.\'*\
*})*\
\
*def main():*\
*ap = argparse.ArgumentParser()*\
*ap.add_argument(\"docs\", nargs=\"+\", help=\"Paths to DOCX files
(non-technical plan parts)\")*\
*ap.add_argument(\"-o\", \"\--out\", default=\"RTM_from_docs.csv\")*\
*args = ap.parse_args()*\
*with open(args.out, \"w\", newline=\"\", encoding=\"utf-8\") as f:*\
*writer = csv.DictWriter(f,
fieldnames=\[\'ReqID\',\'Requirement\',\'Source\',\'TechRefs\',\'TestRefs\',\'Status\',\'Notes\'\])*\
*writer.writeheader()*\
*for i, path in enumerate(args.docs, start=1):*\
*extract_doc(path, i, writer)*\
*print(\"Wrote\", args.out)*\
\
*if \_\_name\_\_ == \"\_\_main\_\_\":*\
*main()*\

Appendix N --- RTM\
\
ReqID,Requirement,Source,TechRefs,TestRefs,Status,Notes
NTB-AUTH-001,\"Users must be able to sign up with email and password,
and verify email via 6‑digit code.\",\"NonTechBlueprint (consolidated)
--- mapped by domain; see attached DOCX set\",\"Appendix H --- UI: H.3
Auth & Account; §1.24 Security &
Privacy\",auth_signup_verify.spec.ts,Met, NTB-AUTH-002,Users must be
able to log in with email/password.,\"NonTechBlueprint (consolidated)
--- mapped by domain; see attached DOCX set\",\"Appendix H --- UI: H.3
Auth & Account\",auth_login.spec.ts,Met, NTB-AUTH-003,Support social
login with Google and Apple.,\"NonTechBlueprint (consolidated) ---
mapped by domain; see attached DOCX set\",\"Appendix H --- UI: H.3 Auth
& Account; §1.24 Security & Privacy\",auth_sso_google_apple.spec.ts,Met,
NTB-AUTH-004,Enforce password strength and breach‑check during signup
and reset.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix H --- UI: H.3 Auth & Account; §1.24
Security & Privacy\",auth_password_rules.spec.ts,Met,
NTB-AUTH-005,Account lockout after 5 failed login attempts; CAPTCHA on
risk score.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix H --- UI: H.3 Auth & Account; §1.24
Security & Privacy\",auth_lockout_captcha.spec.ts,Met,
NTB-AUTH-006,Support password reset via emailed one‑time code and token
expiration.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix H --- UI: H.3 Auth & Account; §1.24
Security & Privacy\",auth_reset_password.spec.ts,Met, NTB-AUTH-007,\"MFA
optional for all; required for payout changes and other sensitive
actions (step‑up).\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"Appendix H --- UI: H.3 Auth & Account;
§1.24 Security & Privacy\",auth_mfa_stepup.spec.ts,Met,
NTB-AUTH-008,\"Sessions use httpOnly cookies; SameSite=Lax; device
recognition events are logged.\",\"NonTechB

### TD-0311 (tech)

<!-- id: TD-0311 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1119600-1123600 -->

s,Met, NTB-AUTH-007,\"MFA
optional for all; required for payout changes and other sensitive
actions (step‑up).\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"Appendix H --- UI: H.3 Auth & Account;
§1.24 Security & Privacy\",auth_mfa_stepup.spec.ts,Met,
NTB-AUTH-008,\"Sessions use httpOnly cookies; SameSite=Lax; device
recognition events are logged.\",\"NonTechBlueprint (consolidated) ---
mapped by domain; see attached DOCX set\",\"Appendix H --- UI: H.3 Auth
& Account; §1.24 Security & Privacy\",auth_session_security.spec.ts,Met,
NTB-AUTH-009,\"Provide account deletion with DSAR export link surfaced
before final delete.\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.24 Security & Privacy; §1.28
Exports & Portability\",privacy_delete_export.spec.ts,Met,
NTB-AUTH-010,\"Rate‑limit signup, login, reset flows per IP and per
identity.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix R --- Rate Limits &
Quotas\",rate_limits_auth.spec.ts,Met, NTB-PROF-001,\"Public profile
page displays avatar, verified chip, headline, city, roles, price band,
CTA.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.7 Profiles; §1.11 Media Service; Appendix H ---
UI: H.4 Profiles\",profile_public_view.spec.ts,Met,
NTB-PROF-002,\"Owners can edit headline, bio, roles, tags, city, price
min/max, languages, links.\",\"NonTechBlueprint (consolidated) ---
mapped by domain; see attached DOCX set\",\"§1.7 Profiles; §1.11 Media
Service; Appendix H --- UI: H.4
Profiles\",profile_edit_fields.spec.ts,Met,
NTB-PROF-003,\"Upload/crop/reorder portfolio images; set cover
image.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.7 Profiles; §1.11 Media Service; Appendix H ---
UI: H.4 Profiles\",profile_media_upload_crop.spec.ts,Met,
NTB-PROF-004,\"All public media pass SFW moderation; originals stored
private; SFW variants only on public.\",\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.7
Profiles; §1.11 Media Service; Appendix H --- UI: H.4
Profiles\",profile_media_sfw.spec.ts,Met, NTB-PROF-005,Profile
completeness meter enforces thresholds for Instant Book
eligibility.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.7 Profiles; §1.11 Media Service; Appendix H ---
UI: H.4 Profiles\",profile_completeness.spec.ts,Met,
NTB-PROF-006,\"Reviews summary and distribution displayed; count gating
when reviews \< 5.\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.9 Reviews; Appendix H --- UI:
H.4\",profile_reviews_display.spec.ts,Met, NTB-PROF-007,\"Availability
preview shows next‑14‑day feasible slots computed by calendar
engine.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.12 Calendar & Availability; Appendix H ---
UI\",profile_availability_preview.spec.ts,Met, NTB-PROF-008,\"Policies
(cancellation/reschedule) surface on the profile and
checkout.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.14 Orders & Timeline; Appendix H ---
UI\",profile_policies_display.spec.ts,Met, NTB-STUDIO-001,\"Public
studio page shows hero carousel (SFW), amenities, hourly price, city map
pin, verification.\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.19 Studios/Spaces; Appendix H ---
UI: H.5 Studios\",studio_public_view.spec.ts,Met,
NTB-STUDIO-002,\"Studio editor allows name, slug, contact, address
privacy, amenities, hourly min/max, deposits.\",\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.19
Studios/Spaces; Appendix H --- UI: H.5
Studios\",studio_editor_fields.spec.ts,Met,
NTB-STUDIO-003,\"Buffers/blackouts configured at studio propagate to
feasibility and booking.\",\"NonTechBlueprint (consolidated) --- mapped
by domain; see attached D

### TD-0312 (tech)

<!-- id: TD-0312 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1123200-1127200 -->

ntact, address
privacy, amenities, hourly min/max, deposits.\",\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.19
Studios/Spaces; Appendix H --- UI: H.5
Studios\",studio_editor_fields.spec.ts,Met,
NTB-STUDIO-003,\"Buffers/blackouts configured at studio propagate to
feasibility and booking.\",\"NonTechBlueprint (consolidated) --- mapped
by domain; see attached DOCX set\",\"§1.19;
§1.12\",studio_buffers_blackouts.spec.ts,Met, NTB-STUDIO-004,Studio
verification workflow with document upload and status
banners.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.19\",studio_verification_flow.spec.ts,Met,
NTB-CAL-001,Weekly rules + exceptions define base schedule per
role/service.,\"NonTechBlueprint (consolidated) --- mapped by domain;
see attached DOCX set\",\"§1.12 Calendar &
Availability\",calendar_rules.spec.ts,Met, NTB-CAL-002,Feasibility
engine applies min duration, buffers, and blackouts.,\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.12
Calendar & Availability\",calendar_feasibility_engine.spec.ts,Met,
NTB-CAL-003,\"ICS import is read‑only; outbound ICS feeds for confirmed
events.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.12 Calendar &
Availability\",calendar_ics_io.spec.ts,Met, NTB-CAL-004,DST transitions
handled correctly for start/end times.,\"NonTechBlueprint (consolidated)
--- mapped by domain; see attached DOCX set\",\"§1.12 Calendar &
Availability\",calendar_dst.spec.ts,Met, NTB-BOOK-001,\"Request → Hold →
Confirmed state machine with idempotent
transitions.\",\"NonTechBlueprint (consolidated) --- mapped by domain;
see attached DOCX set\",\"§1.3 Booking Flow & State; §1.14 Orders &
Timeline\",booking_state_machine.spec.ts,Met,
NTB-BOOK-002,\"Cancellation/refund kernel applies time‑band rules
(full/partial/none).\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.3 Booking Flow & State; §1.14
Orders & Timeline\",refund_kernel.spec.ts,Met, NTB-BOOK-003,Order
timeline emits Action Cards for each transition and
task.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.14 Orders &
Timeline\",order_timeline_cards.spec.ts,Met, NTB-BOOK-004,\"Checkout
shows line items, fees, taxes, deposit, and policy
summaries.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.3 Booking Flow & State; §1.14 Orders &
Timeline\",checkout_ui.spec.ts,Met, NTB-PAY-001,\"Stripe PaymentIntents
with SCA/3DS2; Apple/Google Pay wallets.\",\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.13
Payments & Payouts\",payments_3ds_wallets.spec.ts,Met,
NTB-PAY-002,Payout destination change requires MFA; velocity limits for
new accounts.,\"NonTechBlueprint (consolidated) --- mapped by domain;
see attached DOCX set\",\"§1.13 Payments &
Payouts\",payout_mfa_velocity.spec.ts,Met, NTB-PAY-003,Chargeback
evidence packs assembled from order timeline and
messages.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.13 Payments &
Payouts\",chargeback_evidence.spec.ts,Met, NTB-PAY-004,Partial and full
refunds issued through refund kernel and reconciled by
webhooks.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.13 Payments &
Payouts\",refunds_reconciliation.spec.ts,Met, NTB-MSG-001,Inbox lists
threads with unread counts; search/sort provided.,\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.4
Messaging & Requests\",messages_inbox.spec.ts,Met, NTB-MSG-002,\"Thread
view supports text and attachment uploads (SFW) with
thumbnails.\",\"NonTechBlueprint (consolidated) --- mapped by domain;
see attached DOCX set\",\"§1.4 Messaging & Requests; §1.11
Media\",messages_thread_attachments.spec.ts,Met,
NTB-MSG-003,\"Block/report functions; rate limits per dyad;
anti‑circumvention copy.\",

### TD-0313 (tech)

<!-- id: TD-0313 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1126800-1130800 -->

\",\"§1.4
Messaging & Requests\",messages_inbox.spec.ts,Met, NTB-MSG-002,\"Thread
view supports text and attachment uploads (SFW) with
thumbnails.\",\"NonTechBlueprint (consolidated) --- mapped by domain;
see attached DOCX set\",\"§1.4 Messaging & Requests; §1.11
Media\",messages_thread_attachments.spec.ts,Met,
NTB-MSG-003,\"Block/report functions; rate limits per dyad;
anti‑circumvention copy.\",\"NonTechBlueprint (consolidated) --- mapped
by domain; see attached DOCX set\",\"§1.4 Messaging & Requests; Appendix
R --- Rate Limits\",messages_block_rate.spec.ts,Met,
NTB-NOTIF-001,\"Email templates (MJML) for key events: signup verify,
booking confirm, refund, payout.\",\"NonTechBlueprint (consolidated) ---
mapped by domain; see attached DOCX set\",\"§1.10 Notifications &
Templates\",notifications_templates_render.spec.ts,Met,
NTB-NOTIF-002,Quiet hours and consent/suppression honored for each
channel.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.10 Notifications & Templates; §1.24 Security &
Privacy\",notifications_quiet_hours.spec.ts,Met,
NTB-NOTIF-003,SPF/DKIM/DMARC configured; bounce/complaint
suppression.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.10 Notifications &
Templates\",deliverability_dns.spec.ts,Met, NTB-SEO-001,Sitemaps (main,
city, role, help) generated and kept fresh.,\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.17 SEO
& On‑Site; Appendix K --- Cache Matrix\",seo_sitemaps.spec.ts,Met,
NTB-SEO-002,Canonical/hreflang tags for city×role pages and
localizations.,\"NonTechBlueprint (consolidated) --- mapped by domain;
see attached DOCX set\",\"§1.17 SEO & On‑Site; Appendix K --- Cache
Matrix\",seo_canonical_hreflang.spec.ts,Met, NTB-SEO-003,\"Structured
data (Person, LocalBusiness, CreativeWork, FAQ) on applicable
pages.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.17 SEO & On‑Site; Appendix K --- Cache
Matrix\",seo_structured_data.spec.ts,Met, NTB-SEO-004,CWV budgets
enforced on top landings (mobile p75).,\"NonTechBlueprint (consolidated)
--- mapped by domain; see attached DOCX set\",\"§1.17 SEO & On‑Site;
Appendix K --- Cache Matrix\",lighthouse_ci.spec.ts,Met,
NTB-SEARCH-001,Typesense indexes for people, studios, work, and
help.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.18 Search &
Discovery\",search_index_schemas.spec.ts,Met,
NTB-SEARCH-002,Outbox→Indexer pipeline upserts within 5 minutes for hot
docs.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.18 Search &
Discovery\",search_indexer_sla.spec.ts,Met, NTB-SEARCH-003,\"Ranking
blends text, proximity, verified, availability, quality,
freshness.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.18 Search &
Discovery\",search_ranking_blend.spec.ts,Met, NTB-SEARCH-004,\"Safe‑Mode
enforced for all public queries; NSFW assets never
returned.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.18 Search &
Discovery\",search_safe_mode.spec.ts,Met,
NTB-SEARCH-005,\"Synonyms/typos/suggestions configured; cursor
pagination; caching for hot queries.\",\"NonTechBlueprint (consolidated)
--- mapped by domain; see attached DOCX set\",\"§1.18 Search &
Discovery; Appendix K --- Cache
Matrix\",search_suggest_cache.spec.ts,Met, NTB-GROWTH-001,Saved search
alerts and city digests with frequency caps.,\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.16
Growth; §1.30 Post‑Launch\",growth_digests.spec.ts,Met,
NTB-GROWTH-002,Referral program with clawback on
chargebacks/fraud.,\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.16
Growth\",growth_referrals_clawback.spec.ts,Met,
NTB-GROWTH-003,Experiment framework with CUPED/SRM
guardrails.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DO

### TD-0314 (tech)

<!-- id: TD-0314 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1130400-1134400 -->

§1.16
Growth; §1.30 Post‑Launch\",growth_digests.spec.ts,Met,
NTB-GROWTH-002,Referral program with clawback on
chargebacks/fraud.,\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.16
Growth\",growth_referrals_clawback.spec.ts,Met,
NTB-GROWTH-003,Experiment framework with CUPED/SRM
guardrails.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.21 Analytics &
Experiments\",experiments_framework.spec.ts,Met, NTB-HELP-001,Help
Center with categories, article template, and feedback
widget.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.20 Help
Center\",help_center_article.spec.ts,Met, NTB-HELP-002,DMCA takedown and
restore workflow with SLA timers.,\"NonTechBlueprint (consolidated) ---
mapped by domain; see attached DOCX set\",\"§1.15 Support &
Takedown\",dmca_flow.spec.ts,Met, NTB-ANALYT-001,Event taxonomy with
schema validation in CI.,\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.21 Analytics & Experiments;
Appendix L --- Logging & Event
Schema\",event_contract_validator.spec.ts,Met,
NTB-ANALYT-002,Attribution with click‑token proof and channel
grouping.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.21 Analytics &
Experiments\",attribution_clicktoken.spec.ts,Met, NTB-ADMIN-001,RBAC for
staff; dual‑control on sensitive operations; WORM
audit.,\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"§1.22 Admin &
Back‑Office\",admin_rbac_audit.spec.ts,Met, NTB-SEC-001,WAF, BotControl,
and rate limiting tuned for abuse patterns.,\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.24
Security & Privacy; Appendix R --- Rate Limits &
Quotas\",waf_rules.spec.ts,Met, NTB-SEC-002,Consent logging for terms,
privacy, and marketing.,\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"§1.24 Security &
Privacy\",consent_logging.spec.ts,Met, NTB-SEC-003,DSAR delete/export
propagates to search and analytics.,\"NonTechBlueprint (consolidated)
--- mapped by domain; see attached DOCX set\",\"§1.24;
§1.28\",dsar_propagation.spec.ts,Met, NTB-PLAT-001,Amplify Hosting Gen‑2
canary deploys with rollback SOP.,\"NonTechBlueprint (consolidated) ---
mapped by domain; see attached DOCX set\",\"§1.23 Platform, CI/CD &
Environments\",deploy_canary_rollback.spec.ts,Met, NTB-PLAT-002,\"Infra
as code (CDK) for edge, API, DB, caches.\",\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.23
Platform, CI/CD & Environments\",cdk_stacks.spec.ts,Met,
NTB-LAUNCH-001,\"Cutover plan (DNS/certs), content freeze, feature‑flag
ramps, rollback rehearsal.\",\"NonTechBlueprint (consolidated) ---
mapped by domain; see attached DOCX set\",\"§1.29
Launch/Go‑Live\",launch_cutover_rollback.spec.ts,Met,
NTB-POST-001,\"On‑call rotation, SLOs/error budgets, game days, DR
drills, FinOps cadence.\",\"NonTechBlueprint (consolidated) --- mapped
by domain; see attached DOCX set\",\"§1.30 Post‑Launch &
SRE\",slo_budget_gameday.spec.ts,Met, NTB-EXPORT-001,\"User exports and
portability bundle with receipts and redaction.\",\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"§1.28
Exports & Portability\",export_bundle_redaction.spec.ts,Met,
NTB-API-001,\"Partner REST + Webhooks with OAuth scopes, HMAC,
idempotency, and retries.\",\"NonTechBlueprint (consolidated) --- mapped
by domain; see attached DOCX set\",\"§1.27 Partner API & Webhooks;
Appendix J --- API Errors &
Semantics\",webhook_signature_retry.spec.ts,Met, NTB-CACHE-001,\"Cache
key matrix (TTL, Vary) for public pages; ISR revalidation
rules.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix K --- Cache
Matrix\",cache_keys_matrix.spec.ts,Met, NTB-LOG-001,\"JSON log schema
with correlation IDs and PII redaction policy.\",\"NonTechBlueprint
(consolidated) --- mapped

### TD-0315 (tech)

<!-- id: TD-0315 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1134000-1138000 -->

ntics\",webhook_signature_retry.spec.ts,Met, NTB-CACHE-001,\"Cache
key matrix (TTL, Vary) for public pages; ISR revalidation
rules.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix K --- Cache
Matrix\",cache_keys_matrix.spec.ts,Met, NTB-LOG-001,\"JSON log schema
with correlation IDs and PII redaction policy.\",\"NonTechBlueprint
(consolidated) --- mapped by domain; see attached DOCX set\",\"Appendix
L --- Logging & Redaction\",log_schema_redaction.spec.ts,Met,
NTB-SBOM-001,\"SBOM per build, SCA/SAST/container scans, license policy,
SLAs for remediation.\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"Appendix M --- SBOM & Dependency
Policy\",sbom_policy_enforcement.spec.ts,Met, NTB-DR-001,\"RTO/RPO
targets and runbooks for Aurora, Typesense, and S3; quarterly
drills.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix N --- DR Matrix &
Runbooks\",dr_restore_drill.spec.ts,Met, NTB-GOV-001,\"Data
retention/classification/masking/lineage with automated
jobs.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix O --- Data
Governance\",retention_lineage_jobs.spec.ts,Met,
NTB-RATE-001,\"Rate‑limits/quotas for auth, search, messages, checkout,
and suggestions.\",\"NonTechBlueprint (consolidated) --- mapped by
domain; see attached DOCX set\",\"Appendix R --- Rate Limits &
Quotas\",rate_limit_matrix.spec.ts,Met, NTB-TESTDATA-001,\"Synthetic
seed dataset for Stage/Dev; no live PII in
non‑prod.\",\"NonTechBlueprint (consolidated) --- mapped by domain; see
attached DOCX set\",\"Appendix S --- Test Data
Management\",seed_masking_policy.spec.ts,Met,

# **Appendix U --- Threat Modeling & Abuse Cases (STRIDE + Abuse/Anti‑Circumvention)**

**Purpose.** Identify and mitigate security threats and growth‑abuse
vectors early; prove mitigations by test.

**U.1 Scope**\
Surfaces: Auth, Profiles/Studios, Media, Messaging, Search,
Checkout/Payments, Partner API/Webhooks, Admin.

**U.2 Data‑Flow (text DFD)**

- *Edge (CloudFront/WAF)* → *Web (Next.js)* → *AppSync/GraphQL* →
  *Lambdas* → *Aurora*
- *Upload client* → *S3 pre‑signed PUT* → *Media processor Lambda* → *S3
  (variants)* → *CloudFront*
- *Event outbox (Aurora)* → *Indexer Lambda* → *Typesense*
- *Stripe/Webhooks* → *Webhook handler* → *Orders/Timeline*
- *Admin console* → *Admin APIs* → *WORM audit store*

**U.3 STRIDE risks & mitigations (representative)**

- **S**poofing: credential stuffing → *CAPTCHA after risk, lockout,
  breach‑check, MFA step‑up for payouts.*
- **T**ampering: IDOR on profile/media IDs → *row‑level auth checks,
  signed URLs, never expose S3 keys.*
- **R**epudiation: admin actions → *WORM audit, dual control for
  sensitive ops.*
- **I**nfo disclosure: NSFW leaks → *Safe‑Mode invariant in search & OG;
  originals never public.*
- **D**oS: search spam → *per‑IP/user QPS + leaky bucket; hard limits on
  suggestions.*
- **E**levation: partner API token misuse → *scoped OAuth, HMAC
  webhooks, rotate secrets.*

**U.4 Abuse cases & countermeasures**

- **Message solicitation bypass** (sharing emails) → *keyword
  redaction + strike system; rate‑limit per dyad.*
- **Spam profile creation** → *email verification, risk scoring, manual
  review on velocity spikes.*
- **Search gaming** (keyword stuffing) → *rank clamp on over‑edited
  accounts; quality signals (rating, reviews).*
- **Chargeback farming** → *refund kernel transparency, evidence packs,
  referral clawbacks.*
- **Storage abuse** → *upload caps, virus scan (if enabled), image type
  allow‑list.*

**U.5 Artifacts**

- *security/threat_model.md* (this content)
- *security/abuse_playbook.md* (signals, thresholds, actions)
- *security/controls_matrix.csv* (Threat→Control→Owner→Test)

**U.6 Acceptance**

- Each STRIDE item maps to at least one **control** and **test**.
- Red‑team checklist executed pre‑launch; critical findings remediated.

# **Appendix V --- Per

### TD-0316 (tech)

<!-- id: TD-0316 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1137600-1141600 -->

ed), image type
  allow‑list.*

**U.5 Artifacts**

- *security/threat_model.md* (this content)
- *security/abuse_playbook.md* (signals, thresholds, actions)
- *security/controls_matrix.csv* (Threat→Control→Owner→Test)

**U.6 Acceptance**

- Each STRIDE item maps to at least one **control** and **test**.
- Red‑team checklist executed pre‑launch; critical findings remediated.

# **Appendix V --- Performance, Load & Capacity Plan**

**Purpose.** Set budgets, prove them under load, and define
scale‑up/scale‑down rules.

**V.1 Budgets (targets at p95 unless noted)**

- **Web**: TTFB ≤ **400 ms**, LCP ≤ **2.5 s** (mobile p75), CLS ≤
  **0.1**, INP ≤ **200 ms**.
- **GraphQL**: cached ≤ **200 ms**, miss ≤ **450 ms**; steady **RPS
  150**, burst **500**.
- **Typesense**: median **\< 50 ms**, p95 **\< 150 ms** at **QPS 200**.
- **Uploads**: 50 MB per file, 10 concurrent per user.
- **Aurora**: CPU \< **60%**, connections \< **70%** of soft cap at
  steady state.

**V.2 Tests**

- **Load** (k6/gatling) for search, profile view, checkout; 30‑min
  steady + 5‑min burst.
- **Soak** 8‑hour run to catch leaks; **Chaos** single‑AZ failover
  rehearsal.
- **CWV** Lighthouse CI on top landings.

**V.3 Scale rules**

- Lambda provisioned concurrency ramps when p95 \> 450 ms for 5 min.
- Aurora ACU step‑up when CPU \>60% for 10 min.
- Typesense: move to 3‑node HA when index \> 20M docs or p95 \> 150 ms.

**V.4 Artifacts**

- *perf/k6/\*.js* (scenarios)
- *.github/workflows/perf.yml* (CI perf gates)
- *observability/dashboards/perf.json* (SLIs)

**V.5 Acceptance**

- All budgets green in CI; soak test passes; chaos drill documented.

# **Appendix W --- Internationalization (i18n), Localization (L10n) & Currency**

**Purpose.** Make locale, copy, and currency deterministic and SEO‑safe.

**W.1 Locales & routing**

- Locales: *en-US* (MVP), plan for *en-GB*, *fr-FR*, *de-DE*.
- Route pattern */\[locale\]/...* with default redirects; **hreflang** +
  canonical per §1.17.

**W.2 Catalog & formatting**

- ICU messages in *web/i18n/\*.json*; number/date/currency via Intl API.
- **Currency**: display user currency; charge in provider's settlement
  currency (Stripe).

**W.3 Translations**

- Keys freeze weekly; export → vendor → import; fallback to *en-US*.

**W.4 Acceptance**

- No hard‑coded strings; hreflang & canonical present; currency & dates
  respect locale.

# **Appendix X --- Accessibility (WCAG 2.2 AA) Plan**

**Purpose.** Guarantee accessibility across critical flows.

**X.1 Standards**

- WCAG 2.2 AA; ARIA 1.2; keyboard navigable; focus visible; color
  contrast ≥ 4.5:1.

**X.2 Flows covered**

- Auth, profile edit, search+filters, messaging, checkout, help
  articles.

**X.3 Tests**

- Axe CI on PRs; manual screen‑reader passes (NVDA/JAWS/VoiceOver);
  keyboard‑only E2Es.

**X.4 Artifacts**

- *a11y/checklist.md*, *a11y/violations_baseline.json*,
  *a11y/aria_map.md*

**X.5 Acceptance**

- Zero **serious/critical** Axe violations on top pages; manual passes
  recorded.

# **Appendix Y --- Legal Pack, Subprocessors & Consent (non‑legal template)**

**Purpose.** Document compliance surfaces (not legal advice).

**Y.1 Deliverables**

- Terms of Service, Privacy Policy, Cookie Policy.
- **Subprocessor inventory** (AWS, Stripe, email provider, error
  tracking).
- **CMP** (consent management) behavior for tracking cookies.

**Y.2 Records**

- *legal/subprocessors.md*, *privacy/data_lifecycle.md*,
  *privacy/dpia_summary.md*.

**Y.3 Acceptance**

- CMP banner in EU/UK; logs consent events; policies linked in footer.

# **Appendix Z --- Incident Management (SEV Ladder & Comms Templates)**

**Purpose.** Standardize response and communication.

**Z.1 Severity ladder**

- **SEV1**: outage/payments broken; **SEV2**: major impact; **SEV3**:
  partial; **SEV4**: minor.

**Z.2 Roles**

- Incident Commander, Ops, Comms, Scribe; 30‑min updates for SEV1/2.

**Z.3 Templates**

- Slack/Status page/email comms; postmortem template with action items &
  owners.


### TD-0317 (tech)

<!-- id: TD-0317 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1141200-1145200 -->

 (SEV Ladder & Comms Templates)**

**Purpose.** Standardize response and communication.

**Z.1 Severity ladder**

- **SEV1**: outage/payments broken; **SEV2**: major impact; **SEV3**:
  partial; **SEV4**: minor.

**Z.2 Roles**

- Incident Commander, Ops, Comms, Scribe; 30‑min updates for SEV1/2.

**Z.3 Templates**

- Slack/Status page/email comms; postmortem template with action items &
  owners.

**Z.4 Acceptance**

- Last drill completed within targets; templates in repo; paging routes
  tested.

# **Appendix AA --- Schema Migration & Data Backfill Playbook**

**Purpose.** Zero‑downtime migrations and safe rollbacks.

**AA.1 Expand/contract**

- Add nullable columns → dual‑write/read → backfill → cutover → drop
  old.

**AA.2 Tools**

- *db/migrations/\*.sql*, *ops/backfill/\*.ts* (idempotent).

**AA.3 Acceptance**

- Migration rehearsed in Stage with prod‑sized data; rollback tested.

# **Appendix AB --- QA Strategy & Test Matrix**

**Purpose.** Ensure coverage of critical business flows.

**AB.1 Test types**

- Unit, contract (GraphQL), E2E (Playwright), performance, security,
  accessibility, smoke.

**AB.2 Critical paths**

- Signup→verify, Profile edit, Search→view→checkout, Messaging with
  attachments, Refund, DSAR.

**AB.3 Gates**

- Coverage thresholds: **80% lines**, **95% functions on core
  services**; smoke must pass before deploy.

**AB.4 Artifacts**

- *qa/test_matrix.xlsx*, *.github/workflows/ci.yml* (gates),
  *qa/release_checklist.md*.

**AB.5 Acceptance**

- All gates green in Stage; release checklist signed.

# **Appendix AC --- FinOps & Cost Guardrails**

**Purpose.** Keep MVP costs low with elastic scaling.

**AC.1 Budgets & alerts**

- AWS Budgets: monthly targets for S3, Lambda, Aurora, CloudFront,
  Typesense.
- Alert at **70/90/100%** spend; anomaly detection on \> 2× daily
  baseline.

**AC.2 Unit economics**

- Track **\$/successful booking** and **\$/MAU**; dashboard derived from
  costs + analytics.

**AC.3 Rightsizing**

- TTLs and storage classes for S3; Dynamo TTLs; Aurora v2 autoscaling
  min/max set.

**AC.4 Acceptance**

- Budgets configured; alerts firing to on‑call; dashboard visible.

# **Appendix AD --- Cursor Agent Orchestration (4 Agents, Autopilot Build)**

**Purpose.** Make multi‑agent development deterministic, safe, and
efficient.

**AD.1 Roles**

- **Agent A (Backend/API):** GraphQL schema, Lambdas, migrations, tests.
- **Agent B (Frontend/UX):** Next.js pages/components, a11y, SEO.
- **Agent C (Infra/Ops):** CDK stacks, CI/CD, observability.
- **Agent D (Quality/SRE):** tests, dashboards, perf/chaos, RTM updates.

**AD.2 Guardrails**

- PR size caps; one agent per directory; CODEOWNERS; contract tests
  auto‑run on schema change.
- "Design‑first" protocol: edit schema/contract → generate stubs →
  implement.

**AD.3 Prompts & checklists**

- Each agent runs with a pinned prompt that references: RTM, appendices,
  acceptance criteria, and repository paths.

**AD.4 Acceptance**

- No cross‑agent drift; all PRs reference a **ReqID** from RTM; CI
  contract tests green.

# **Appendix V --- Performance, Load & Capacity (deep version)**

## **V.1 Budgets (exact numbers)**

**Web (mobile focus, p75 unless noted)**

- LCP ≤ **2500 ms**, INP ≤ **200 ms**, CLS ≤ **0.10**
- TTFB ≤ **400 ms** (edge cache hit ≤ **120 ms**, miss ≤ **400 ms**)
- JS initial ≤ **150 KB** gzip; CSS ≤ **70 KB**; images above-the-fold ≤
  **250 KB**

**GraphQL/API (p95)**

- Cached ≤ **200 ms**, Miss ≤ **450 ms**, Error rate ≤ **0.5%**

**Search (Typesense)**

- Median **\< 50 ms**, p95 **\< 150 ms**, Index freshness **≤ 5 min**

**Checkout**

- Server processing (excl. 3DS challenge) ≤ **600 ms** p95

## **V.2 k6 Scenarios (copy to** ***perf/k6/*****)**

***perf/k6/search.js***

*import http from \'k6/http\';*\
*import { check, sleep } from \'k6\';*\
*import { Trend, Rate } from \'k6/metrics\';*\
\
*export let SearchLat = new Trend(\'search_latency_ms\');*\
*export let SearchOK = new Rate(\'search_ok\');*\
\
*exp

### TD-0318 (tech)

<!-- id: TD-0318 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1144800-1148800 -->

5 min**

**Checkout**

- Server processing (excl. 3DS challenge) ≤ **600 ms** p95

## **V.2 k6 Scenarios (copy to** ***perf/k6/*****)**

***perf/k6/search.js***

*import http from \'k6/http\';*\
*import { check, sleep } from \'k6\';*\
*import { Trend, Rate } from \'k6/metrics\';*\
\
*export let SearchLat = new Trend(\'search_latency_ms\');*\
*export let SearchOK = new Rate(\'search_ok\');*\
\
*export const options = {*\
*stages: \[*\
*{ duration: \'2m\', target: 50 }, // ramp*\
*{ duration: \'5m\', target: 200 }, // steady*\
*{ duration: \'2m\', target: 0 }, // ramp down*\
*\],*\
*thresholds: {*\
*\'search_latency_ms\': \[\'p(95)\<150\'\],*\
*\'search_ok\': \[\'rate\>0.995\'\],*\
*},*\
*};*\
\
*const BASE = \_\_ENV.BASE_URL \|\|
\'*[*https://rastup.com*](https://rastup.com)*\';*\
*const Q = encodeURIComponent(\'photographer\');*\
*const CITY = encodeURIComponent(\'los-angeles\');*\
\
*export default function () {*\
*const url =
\`\${BASE}/api/search/people?q=\${Q}&city=\${CITY}&limit=24\`;*\
*const res = http.get(url, { headers: { \'Accept\': \'application/json\'
}});*\
*SearchLat.add(res.timings.duration);*\
*const ok = check(res, {*\
*\'status 200\': r =\> r.status === 200,*\
*\'json present\': r =\> r.headers\[\'Content-Type\'\] &&
r.headers\[\'Content-Type\'\].includes(\'application/json\'),*\
*});*\
*SearchOK.add(ok);*\
*sleep(0.3);*\
*}*\

***perf/k6/checkout.js***

*import http from \'k6/http\';*\
*import { check, sleep } from \'k6\';*\
*import { Trend, Rate } from \'k6/metrics\';*\
\
*export let PayLat = new Trend(\'checkout_latency_ms\');*\
*export let PayOK = new Rate(\'checkout_ok\');*\
\
*export const options = {*\
*stages: \[*\
*{ duration: \'1m\', target: 20 },*\
*{ duration: \'4m\', target: 60 },*\
*{ duration: \'1m\', target: 0 },*\
*\],*\
*thresholds: {*\
*\'checkout_latency_ms\': \[\'p(95)\<600\'\],*\
*\'checkout_ok\': \[\'rate\>0.995\'\],*\
*},*\
*};*\
\
*const BASE = \_\_ENV.BASE_URL \|\|
\'*[*https://rastup.com*](https://rastup.com)*\';*\
\
*export default function () {*\
*// 1) Start a "quote" (fake user flow; replace with Stage endpoint)*\
*let res = http.post(\`\${BASE}/api/checkout/start\`, JSON.stringify({*\
*serviceProfileId: \'spf_demo\',*\
*startTs: new Date(Date.now()+86400000).toISOString(),*\
*endTs: new Date(Date.now()+90000000).toISOString(),*\
*extras: \[\]*\
*}), { headers: { \'Content-Type\': \'application/json\' }});*\
*check(res, { \'start 200\': r =\> r.status === 200 });*\
*PayLat.add(res.timings.duration);*\
\
*// 2) Confirm payment (mocked in Stage or test-mode)*\
*const body = { txnId: res.json(\'txnId\'), method: \'card:test\' };*\
*res = http.post(\`\${BASE}/api/checkout/confirm\`,
JSON.stringify(body), { headers: { \'Content-Type\':
\'application/json\' }});*\
*const ok = check(res, { \'confirm 200\': r =\> r.status === 200 });*\
*PayOK.add(ok);*\
*sleep(1);*\
*}*\

***perf/k6/messages.js***

*import http from \'k6/http\';*\
*import { sleep, check } from \'k6\';*\
*import { Trend, Rate } from \'k6/metrics\';*\
\
*export let MsgLat = new Trend(\'messages_latency_ms\');*\
*export let MsgOK = new Rate(\'messages_ok\');*\
\
*export const options = {*\
*vus: 50, duration: \'5m\',*\
*thresholds: { \'messages_latency_ms\': \[\'p(95)\<250\'\],
\'messages_ok\': \[\'rate\>0.995\'\] },*\
*};*\
\
*const BASE = \_\_ENV.BASE_URL \|\|
\'*[*https://rastup.com*](https://rastup.com)*\';*\
\
*export default function () {*\
*// get inbox*\
*let res = http.get(\`\${BASE}/api/messages/inbox\`, { headers: {
\'Accept\': \'application/json\' }});*\
*check(res, { \'inbox 200\': r =\> r.status === 200 });*\
*MsgLat.add(res.timings.duration);*\
*// open thread*\
*if (res.status === 200 && res.json(\'threads\')?.length) {*\
*const id = res.json(\'threads\')\[0\].id;*\
*res = http.get(\`\${BASE}/api/messages/thread/\${id}\`);*\
*const ok = check(res, { \'thread 200\': r =\> r.status === 200 });*\
*MsgOK.add(ok);*\
*}*\
*sleep(0.5);*\
*}*\

**CI workflow (*****.github/workflows/perf.yml*****)**

*name: perf*\
*

### TD-0319 (tech)

<!-- id: TD-0319 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1148400-1152400 -->

.add(res.timings.duration);*\
*// open thread*\
*if (res.status === 200 && res.json(\'threads\')?.length) {*\
*const id = res.json(\'threads\')\[0\].id;*\
*res = http.get(\`\${BASE}/api/messages/thread/\${id}\`);*\
*const ok = check(res, { \'thread 200\': r =\> r.status === 200 });*\
*MsgOK.add(ok);*\
*}*\
*sleep(0.5);*\
*}*\

**CI workflow (*****.github/workflows/perf.yml*****)**

*name: perf*\
*on:*\
*workflow_dispatch:*\
*schedule:*\
* - cron: \"0 6 \* \* \*\" \# daily 06:00 UTC*\
*jobs:*\
*k6:*\
*runs-on: ubuntu-latest*\
*strategy:*\
*matrix:*\
*script: \[search.js, checkout.js, messages.js\]*\
*steps:*\
* - uses: actions/checkout@v4*\
* - name: Install k6*\
*run: \|*\
*sudo gpg -k \|\| true*\
*curl -s*
[*https://packagecloud.io/install/repositories/loadimpact/k6/script.deb.sh*](https://packagecloud.io/install/repositories/loadimpact/k6/script.deb.sh)
*\| sudo bash*\
*sudo apt-get install -y k6*\
* - name: Run k6*\
*env: { BASE_URL: \${{ secrets.PERF_BASE_URL }} }*\
*run: k6 run perf/k6/\${{ matrix.script }}*\

# **Appendix Z --- Incident Management (deep version)**

## **Z.1 Severity levels & examples**

- **SEV-1** (Critical): payments down, major PII exposure, widespread
  outage.
- **SEV-2** (High): checkout degradation, search results invalid, DMCA
  flood.
- **SEV-3** (Medium): minor feature outage, partial region issue.
- **SEV-4** (Low): cosmetic bugs, minor latency.

## **Z.2 Roles**

- **Incident Commander (IC)**, **Ops**, **Comms**, **Scribe**,
  **Resolver(s)**.

## **Z.3 Paging rules**

- Alerts that page must be **actionable**; no pages for known noisy
  metrics.
- SEV-1: page **primary & secondary** simultaneously; IC within 5
  minutes.

## **Z.4 Comms templates (copy into** ***ops/templates/*****)**

**Slack (war-room channel)**

*\[SEV-\<n\>\] \<short title\>*\
*Start: \<UTC time\>*\
*IC: \<name\>, Scribe: \<name\>*\
*Impact: \<who/what/where\>*\
*Hypotheses:*\
*Mitigations tried:*\
*Next update at: \<time\>*\

**Status page --- initial**

*Title: Degraded performance in \<component\>*\
*Body: We are investigating elevated errors/latency in \<component\>.
Bookings and messaging may be impacted for some users.*\
*Start: \<time UTC\>*\
*Next update: \<+30 minutes\>*\

**Customer email --- resolved**

*Subject: Incident on \<date\> has been resolved*\
*Body: Between \<time range UTC\>, some users experienced \<impact\>.
The issue has been resolved. Root cause: \<high-level\>. We are taking
the following steps to prevent recurrence: \<bullets\>. We apologize for
the disruption.*\

## **Z.5 Timeline of a typical SEV-1**

5540. IC declared, roles assigned, status page updated.
5541. Mitigate (flip feature flags, rollback, scale).
5542. Diagnose with logs/traces; fix; monitor.
5543. Resolve & close; postmortem within **5 business days**.

## **Z.6 Postmortem template**

*Summary:*\
*Timeline:*\
*Customer impact:*\
*Root cause:*\
*Fix:*\
*Action items (owner, due):*\
*Lessons:*\

## **Z.7 Acceptance**

- Last drill met paging and comms SLAs; postmortems exist for SEV-1/2;
  action items tracked.

# **Appendix AC --- FinOps & Cost Guardrails (deep version)**

## **AC.1 AWS Budgets YAML (*****ops/finops/budgets.yml*****)**

*budgets:*\
* - name: s3-monthly*\
*amount_usd: 250*\
*tag: service:s3*\
*alerts:*\
* - threshold: 70*\
* - threshold: 90*\
* - threshold: 100*\
* - name: lambda-monthly*\
*amount_usd: 400*\
*tag: service:lambda*\
*alerts: \[70, 90, 100\]*\
* - name: aurora-monthly*\
*amount_usd: 1200*\
*tag: service:aurora*\
*alerts: \[70, 90, 100\]*\
* - name: cloudfront-monthly*\
*amount_usd: 600*\
*tag: service:cloudfront*\
*alerts: \[70, 90, 100\]*\
* - name: typesense-monthly*\
*amount_usd: 300*\
*tag: service:typesense*\
*alerts: \[70, 90, 100\]*\

## **AC.2 Unit-economics SQL (Athena) ---** ***analytics/sql/unit_economics.sql***

*WITH cost AS (*\
*SELECT service, SUM(cost_usd) AS usd*\
*FROM finops.daily_service_cost*\
*WHERE dt BETWEEN date_trunc(\'month\', current_date) AND current_date*\
*GROUP BY 1*

### TD-0320 (tech)

<!-- id: TD-0320 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1152000-1156000 -->

dfront*\
*alerts: \[70, 90, 100\]*\
* - name: typesense-monthly*\
*amount_usd: 300*\
*tag: service:typesense*\
*alerts: \[70, 90, 100\]*\

## **AC.2 Unit-economics SQL (Athena) ---** ***analytics/sql/unit_economics.sql***

*WITH cost AS (*\
*SELECT service, SUM(cost_usd) AS usd*\
*FROM finops.daily_service_cost*\
*WHERE dt BETWEEN date_trunc(\'month\', current_date) AND current_date*\
*GROUP BY 1*\
*),*\
*bookings AS (*\
*SELECT COUNT(\*) AS c*\
*FROM gold.fact_orders*\
*WHERE created_at BETWEEN date_trunc(\'month\', current_date) AND
current_date*\
*AND status = \'COMPLETED\'*\
*)*\
*SELECT*\
*(SELECT usd FROM cost WHERE service = \'total\') / NULLIF((SELECT c
FROM bookings), 0) AS usd_per_booking,*\
*(SELECT usd FROM cost WHERE service = \'cloudfront\') / NULLIF((SELECT
c FROM bookings), 0) AS usd_per_booking_cf,*\
*(SELECT usd FROM cost WHERE service = \'typesense\') / NULLIF((SELECT c
FROM bookings), 0) AS usd_per_booking_search;*\

## **AC.3 Rightsizing script stub (Node) ---** ***ops/scripts/rightsizing.ts***

*import { CloudWatchClient, GetMetricStatisticsCommand } from
\"@aws-sdk/client-cloudwatch\";*\
*// Fetch Aurora CPU + Typesense latency, output suggestions to
raise/lower capacity.*\

## **AC.4 Acceptance**

- Budgets exist and alert; unit-economics dashboard shows \$/booking;
  one rightsizing action shipped per quarter.

# **Appendix U --- Threat Modeling & Abuse Automation (deep version)**

**Purpose.** Identify, prevent, detect, respond to, and learn from both
traditional security threats (STRIDE) and product‑abuse vectors (spam,
scraping, circumvention, chargeback farming). This appendix is **fully
actionable**: it includes a controls matrix, automation rules, storage
schemas, queries, WAF examples, resolver hooks, runbooks, dashboards,
and acceptance criteria.

**Stack context (assumed):** CloudFront + WAF (BotControl) → Next.js
(Amplify Gen‑2 Hosting) → AppSync (GraphQL) → Lambda → Aurora Serverless
v2 (Postgres) → S3/CloudFront (media) → Typesense (search) → Stripe
(payments) → EventBridge (events) → DynamoDB (abuse/ratelimit/feature
store).

## **U.0 Scope & Trust Boundaries**

**Surfaces:** Auth, Profiles/Studios & Media, Messaging, Search,
Booking/Payments, Partner API/Webhooks, Admin/Back‑office,
Platform/Infra.

**Trust boundaries (text DFD):**

- **Edge:** CloudFront/WAF/BotControl, rate‑limit, Geo/IP reputation,
  TLS termination.
- **API boundary:** AppSync Authorization (Cognito/JWT, IAM for
  internal), Resolver authz checks.
- **Data boundary:** Aurora (PII), S3 private originals, S3 public SFW
  variants, Typesense (public indices).
- **External:** Stripe webhooks, OAuth providers, email/SMS provider.

## **U.1 Controls Matrix (STRIDE + Abuse)**

**IDs (U‑xx)** are referenced by tests, alerts, and runbooks.

  ---------- ------------------ -------------------------- ----------------------------------------------------------------------------- --------------------------------------------------- ------------------------------------------------------------- ------------------
  **ID**     **Surface**        **Threat/Abuse**           **Prevent (P)**                                                               **Detect (D)**                                      **Respond (R)**                                               **Owner**
  **U‑01**   Auth               Credential stuffing        WAF BotControl; per‑IP login QPS; breach‑check; CAPTCHA on risk; lockout 5×   Login fail rate/ASNs dashboard; anomaly alerts      Auto‑throttle IP/ASN; flag account; require MFA challenge     Security
  **U‑02**   Auth               Account takeover           Device fingerprint; email verify; step‑up MFA on payout/edit                  New‑device + geo‑velocity events                    Session revoke; password reset; notify user                   Security/Support
  **U‑03**   Profiles/Media     NSFW leak on public        S3 originals private; SFW‑only variants; Safe‑Mode filters everywhere         "Public rende

### TD-0321 (tech)

<!-- id: TD-0321 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1155600-1159600 -->

              Account takeover           Device fingerprint; email verify; step‑up MFA on payout/edit                  New‑device + geo‑velocity events                    Session revoke; password reset; notify user                   Security/Support
  **U‑03**   Profiles/Media     NSFW leak on public        S3 originals private; SFW‑only variants; Safe‑Mode filters everywhere         "Public render with NSFW \> 0" sentinel             Immediate deindex from Typesense; purge cache; strike media   Safety
  **U‑04**   Messaging          Spam/solicitation bypass   Per‑dyad QPS; keyword redaction; new‑user probation                           Spam classifiers; user reports; high QPS detector   Shadow‑limit, mute, or suspend per strike ladder              Trust & Safety
  **U‑05**   Search             Scraping / query spam      WAF rate‑limit; API keys for partners; suggestions hard cap                   Zero‑result spikes; IP entropy; UA mix              Soft CAPTCHA; temp block subnet                               Security
  **U‑06**   Search             Ranking gaming             Edit‑rate clamp; verified boost only after KYC; min reviews gating            Rank‑drift monitors by cohort                       Reduce weight; manual review queue                            Product/Safety
  **U‑07**   Booking/Payments   Chargeback farming         Refund kernel transparency; velocity limits; step‑up MFA for payout           CB ratio by cohort; disputed order patterns         Claw back referral; suspend payouts; evidence packs           Payments
  **U‑08**   Webhooks/API       Replay/forgery             HMAC signatures; timestamp window; idempotency keys                           Signature failure rate                              Quarantine + DLQ; rotate secret                               Platform
  **U‑09**   Admin              IDOR / privilege abuse     RBAC; row‑level checks; dual‑control for destructive ops                      WORM audit + anomaly                                Immediate session kill; break‑glass log                       Security
  **U‑10**   Platform           Data exfil/log PII         Log redaction; zero PII in debug; scoped IAM                                  PII scanners; S3 Access logs                        Rotate creds; redact & re‑ingest                              Platform
  **U‑11**   Availability       DoS/burst                  WAF rate policies; Leaky bucket in API; cache hot queries                     p95 latency; 5XX spikes; queue depth                Scale up; shed load; degrade non‑critical                     SRE
  **U‑12**   Compliance         DSAR gaps                  Consent logs; delete/export pipelines                                         DSAR SLA timers                                     Escalation to privacy officer                                 Privacy
  ---------- ------------------ -------------------------- ----------------------------------------------------------------------------- --------------------------------------------------- ------------------------------------------------------------- ------------------

**Acceptance of matrix:** Each item has at least one **Prevent, Detect,
Respond** mapped to a **test** and **alert** (see U.7, U.9).

## **U.2 Event & Feature Schemas (Abuse store)**

**DynamoDB tables (serverless, low‑cost):**

- ***abuse_events*** *(PK: entity#\<type\>#\<id\>, SK: ISO ts, TTL
  180d)*\
  Fields: *entity_type (user\|ip\|device\|email\|dyad\|media\|order)*,
  *event_type*, *value*, *ctx {ip, asn, ua, geo}*, *score_delta*,
  *trace_id*.
- ***abuse_entities*** *(PK: entity#\<type\>#\<id\>)*\
  Fields: *score*, *strikes {spam:int, nsfw:int, chargeback:int, ...}*,
  *status (ok\|shadow\|mute\|suspend)*, *notes*, *updated_at*.
- ***abuse_actions*** *(PK: action#\<id\>)*\
  Fields: *entity_ref*, *action (warn\|shadow\|mute\|suspend\|restore)*,
  *reason*, *actor (system\|staff)*, *expires_at*, *created_at*.

**Aurora (for joins/analytics):** mirrored v

### TD-0322 (tech)

<!-- id: TD-0322 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1159200-1163200 -->

s*** *(PK: entity#\<type\>#\<id\>)*\
  Fields: *score*, *strikes {spam:int, nsfw:int, chargeback:int, ...}*,
  *status (ok\|shadow\|mute\|suspend)*, *notes*, *updated_at*.
- ***abuse_actions*** *(PK: action#\<id\>)*\
  Fields: *entity_ref*, *action (warn\|shadow\|mute\|suspend\|restore)*,
  *reason*, *actor (system\|staff)*, *expires_at*, *created_at*.

**Aurora (for joins/analytics):** mirrored via nightly ETL into
***gold.abuse\_\**** in Athena for reporting.

## **U.3 Rules Engine (abuse automation)**

**Rule DSL (YAML) ---** ***safety/rules.yaml*****:**

*version: 1*\
*rules:*\
* - id: MSG-SPAM-001*\
*when:*\
*all:*\
* - event_type: \"message.sent\"*\
* - window: { size: \"10m\", group_by: \[\"dyad_id\"\], count_gt: 40 }*\
*then:*\
*action: \"shadow\"*\
*duration: \"2h\"*\
*reason: \"Per-dyad QPS exceeded\"*\
* - id: MSG-SOLICIT-KEYWORD-001*\
*when:*\
*all:*\
* - event_type: \"message.sent\"*\
* - text_contains_any: \[\"@\", \"dot com\", \"telegram\", \"whatsapp\",
\"cashapp\"\]*\
* - actor_age_lt_days: 3*\
*then:*\
*action: \"mute\"*\
*duration: \"24h\"*\
*reason: \"Contact bypass keywords\"*\
* - id: MEDIA-NSFW-001*\
*when:*\
*all:*\
* - event_type: \"media.moderated\"*\
* - field: \"nsfw_score\"* \
*op: \"gte\"*\
*value: 0.8*\
* - actor_age_lt_days: 7*\
*then:*\
*action: \"suspend\"*\
*duration: \"72h\"*\
*reason: \"High NSFW on new account\"*\
* - id: SEARCH-SPAM-001*\
*when:*\
*all:*\
* - event_type: \"search.query\"*\
* - window: { size: \"1m\", group_by: \[\"ip\"\], count_gt: 120 }*\
*then:*\
*action: \"ip_temp_block\"*\
*duration: \"10m\"*\
*reason: \"Search spam\"*\
* - id: PAY-CB-COHORT-001*\
*when:*\
*all:*\
* - event_type: \"chargeback.opened\"*\
* - cohort_rate_gt: { window_days: 30, threshold: 0.02, group:
\"referrer_code\" }*\
*then:*\
*action: \"disable_referrals\"*\
*reason: \"Chargeback cohort risk\"*\

**Evaluator Lambda ---** ***services/safety/evaluator.ts***
**(pseudocode):**

*export async function handler(evt: EventBridgeEnvelope\[\]) {*\
*for (const e of evt) {*\
*await recordAbuseEvent(e); // write to abuse_events*\
*const context = await loadEntityContext(e); // user age, past strikes,
cohort*\
*const matches = matchRules(e, context, rulesYaml);*\
*for (const m of matches) {*\
*const act = decideAction(m, context); // ladder aware*\
*await applyAction(act); // write abuse_actions, flip flags in user
profile*\
*await notifySystems(act); // invalidate caches, reduce rank weight,
etc.*\
*}*\
*}*\
*}*\

**Strike ladder (ladder‑aware actions):**

- **Warn → Shadow → Mute → Suspend** (escalation decays over time;
  ladders are **type‑specific**).
- Decay windows: warn 24h, shadow 72h, mute 7d, suspend 14d.

## **U.4 WAF & Rate‑Limit Examples**

**CloudFront WAF (JSON excerpt) ---** ***ops/waf/rules.json*****:**

*{*\
*\"Name\": \"rastup-waf\",*\
*\"Scope\": \"CLOUDFRONT\",*\
*\"DefaultAction\": { \"Allow\": {} },*\
*\"Rules\": \[*\
*{*\
*\"Name\": \"RateLimitSearch\",*\
*\"Priority\": 10,*\
*\"Statement\": { \"RateBasedStatement\": {*\
*\"Limit\": 3000,*\
*\"AggregateKeyType\": \"IP\",*\
*\"ScopeDownStatement\": {*\
*\"ByteMatchStatement\": {*\
*\"FieldToMatch\": {\"UriPath\": {}},*\
*\"PositionalConstraint\": \"STARTS_WITH\",*\
*\"SearchString\": \"/api/search\",*\
*\"TextTransformations\": \[{\"Type\":\"NONE\", \"Priority\":0}\]*\
*}*\
*}*\
*}},*\
*\"Action\": { \"Block\": {} },*\
*\"VisibilityConfig\": {\"SampledRequestsEnabled\": true,
\"CloudWatchMetricsEnabled\": true, \"MetricName\":
\"RateLimitSearch\"}*\
*},*\
*{*\
*\"Name\": \"BotControlManaged\",*\
*\"Priority\": 20,*\
*\"Statement\": { \"ManagedRuleGroupStatement\": {*\
*\"VendorName\": \"AWS\",*\
*\"Name\": \"AWSManagedRulesBotControlRuleSet\"*\
*}},*\
*\"OverrideAction\": { \"None\": {} },*\
*\"VisibilityConfig\": {\"SampledRequestsEnabled\": true,
\"CloudWatchMetricsEnabled\": true, \"MetricName\": \"BotControl\"}*\
*}*\
*\]*\
*}*\

**AppSync pre‑resolver guard (JS function) ---**
***api/functions/rateGuard.js*****:**

*export function r

### TD-0323 (tech)

<!-- id: TD-0323 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1162800-1166800 -->

eGroupStatement\": {*\
*\"VendorName\": \"AWS\",*\
*\"Name\": \"AWSManagedRulesBotControlRuleSet\"*\
*}},*\
*\"OverrideAction\": { \"None\": {} },*\
*\"VisibilityConfig\": {\"SampledRequestsEnabled\": true,
\"CloudWatchMetricsEnabled\": true, \"MetricName\": \"BotControl\"}*\
*}*\
*\]*\
*}*\

**AppSync pre‑resolver guard (JS function) ---**
***api/functions/rateGuard.js*****:**

*export function request(ctx) {*\
*const key = \`user#\${ctx.identity.sub}#op#\${ctx.info.fieldName}\`;*\
*const now = Date.now();*\
*// burst: 40/min on searchPeople for authenticated*\
*const limit = (ctx.info.fieldName.startsWith(\'search\')) ? 40 : 60;*\
*const ok = rateLimitCheck(key, limit, 60_000); // uses Dynamo
\'rate_limits\' table*\
*if (!ok) util.error(\"Rate limit exceeded\", \"Throttled\", 429);*\
*return ctx.prev.result;*\
*}*\
*export function response(ctx) { return ctx.result; }*\

**Dynamo "rate_limits" table (token bucket):** PK=*key*,
fields=*allowance*, *last_ts*. Update in single conditional write.

## **U.5 Detection Queries & Alerts**

**CloudWatch Logs Insights --- login stuffing:**

*filter \@message like /login.failed/*\
*\| stats count() as fails, approx_distinct(ip) as ips by bin(5m)*\
*\| filter fails \> 200 and ips \< 20*\

**Athena (abuse rates by cohort):**

*SELECT referrer_code,*\
*SUM(case when event_type=\'chargeback.opened\' then 1 else 0
end)::double / NULLIF(COUNT(\*) FILTER (WHERE
event_type=\'order.completed\'),0) AS cb_rate_30d*\
*FROM gold.abuse_events*\
*WHERE event_ts \>= date_add(\'day\', -30, current_date)*\
*GROUP BY 1*\
*HAVING cb_rate_30d \> 0.02;*\

**Typesense rank‑gaming detector (edit‑rate):**

*SELECT user_id, COUNT(\*) AS edits_24h*\
*FROM gold.profile_edits*\
*WHERE ts \>= current_timestamp - interval \'24 hours\'*\
*GROUP BY 1*\
*HAVING COUNT(\*) \> 30;*\

**Alerts (CloudWatch/Datadog):**

- **LoginFailRateHigh**: *\> 5%* over 5 min, page on‑call.
- **SearchSpamIP**: WAF rule *RateLimitSearch* blocks \> 100 IPs in 10
  min, create SEV‑3 ticket.
- **NSFWSurge**: *media.moderated(nsfw_score\>=0.8)* \> 20 in 30 min →
  pause new uploads for flagged cohort; page Safety.

## **U.6 Content Safety & Redaction**

- **Message filters:** redact emails, phone numbers, payment handles in
  client preview and server save (store original in encrypted field for
  appeals).
- **OG/Preview safety:** OG images generated **only from SFW variants**;
  force Safe‑Mode on all public search/feeds.
- **Logging:** no raw message bodies in logs; store *hash(body)* for
  dedup; **PII redaction** before emission.

## **U.7 Tests (security & abuse)**

- **Credential stuffing sim**: 500 login attempts from single ASN →
  lockout + CAPTCHA; ensure legitimate logins unaffected.
- **IDOR tests**: All profile/media/order resolvers enforce owner/staff
  checks.
- **Message spam**: 50 msgs/10 min in a dyad → shadow within 1 minute;
  unshadow after 2h.
- **NSFW leak tests**: public GET never returns non‑SFW URL; admin
  override only with signed header.
- **Webhook replay**: old timestamp + wrong signature → quarantined; no
  side effects.
- **Ranking gaming**: edit‑rate clamp reduces rank contribution; AB test
  protects CTR.

All tests live under *security/\*.spec.ts*, *safety/\*.spec.ts*, and run
in CI nightly.

## **U.8 Runbooks**

**RB‑U‑01 Credential Stuffing**

5567. Confirm spike (dashboard).
5568. Enable stricter WAF rate on */auth/\** (template policy).
5569. Turn on CAPTCHA hard‑enforcement; increase lockout to 30 min.
5570. After 2h stable, relax to normal; export offending ASNs to
      denylist.

**RB‑U‑02 NSFW Leak**

5571. Flip Safe‑Mode **global** (config flag).
5572. Purge CloudFront path for affected assets.
5573. Deindex entities from Typesense; add *policy_hold=true*.
5574. Post‑mortem: check pipeline regression tests; add new unit.

**RB‑U‑03 Partner Webhook Forgery**

5575. Move endpoint to **quarantine mode** (accept, store to DLQ only).
5576. Rotate secrets; re‑enable with tighter clock skew (±3 min).
557

### TD-0324 (tech)

<!-- id: TD-0324 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1166400-1170400 -->

. Flip Safe‑Mode **global** (config flag).
5572. Purge CloudFront path for affected assets.
5573. Deindex entities from Typesense; add *policy_hold=true*.
5574. Post‑mortem: check pipeline regression tests; add new unit.

**RB‑U‑03 Partner Webhook Forgery**

5575. Move endpoint to **quarantine mode** (accept, store to DLQ only).
5576. Rotate secrets; re‑enable with tighter clock skew (±3 min).
5577. Re‑process quarantined events with new key.

## **U.9 Dashboards & KPIs**

**Dashboards:** *observability/dashboards/security.json*\
**KPIs:** login fail %, search QPS & block %, message spam rate, NSFW
moderation pass %, chargeback rate, webhook signature failures, WAF
block counts.\
**Targets:** All within thresholds defined in §1.24 and Appendix R;
spikes create tickets automatically.

## **U.10 Artifacts to add to repo**

*security/threat_model.md*\
*security/controls_matrix.csv*\
*safety/rules.yaml*\
*services/safety/evaluator.ts*\
*ops/waf/rules.json*\
*api/functions/rateGuard.js*\
*ops/runbooks/RB-U-01_credential_stuffing.md*\
*ops/runbooks/RB-U-02_nsfw_leak.md*\
*ops/runbooks/RB-U-03_webhook_forgery.md*\
*observability/dashboards/security.json*\

## **U.11 Acceptance (Appendix U = FINAL)**

- Controls matrix (U‑01...U‑12) present and linked to tests & alerts.
- *safety/rules.yaml* deployed; evaluator Lambda applying actions;
  strike ladder in effect.
- WAF rules active; AppSync pre‑resolver guard live on spam‑sensitive
  fields.
- Dashboards/alerts in place; last drill for **RB‑U‑01** and **RB‑U‑02**
  completed within SLA.
- Evidence stores (WORM audit, abuse_events) searchable for 180 days.

# **Appendix N --- Disaster Recovery (DR Matrix & Runbooks) --- deep version**

**Goal.** Recover **quickly** (RTO) with **minimal data loss** (RPO)
under likely failure modes: regional outage, data corruption, accidental
deletes, index loss, and third‑party disruption. This appendix is
**actionable** (step‑by‑step commands, scripts, and checklists) and
cost‑conscious (pilot‑light in secondary region with defined upgrade
path).

## **N.0 Scope & assumptions**

**Stack:** CloudFront + WAF → Next.js (Amplify Gen‑2 Hosting) → AppSync
(GraphQL) → Lambda → Aurora Postgres (Serverless v2) → DynamoDB (rate
limits, abuse flags) → S3 (media; originals private, SFW variants
public) → Typesense (search) → EventBridge → Stripe (payments).

**DR posture (MVP):**

- **Primary region:** *REGION_A* (active).
- **Secondary (pilot‑light) region:** *REGION_B* (preprovisioned IaC, S3
  CRR, DNS failover, DynamoDB Global Tables for small hot data).
- **Upgrade option:** move Aurora to **Multi‑Region** (e.g., Global
  Database/read‑replica) for sub‑minute RPO if/when justified.

## **N.1 RTO/RPO targets & DR matrix**

  ----------------------------------------- -------------------------- ------------------------ --------------------------------------- --------------------------------------------------------------- ------------------------------------------------------------------------------------------------------------ -------------------
  **System**                                **Source of Truth**        **RPO**                  **RTO**                                 **Replication/Backup**                                          **Failover Strategy**                                                                                        **Runbook**
  **Aurora Postgres**                       Orders, users, profiles    ≤ **5--15 min** (PITR)   ≤ **60--90 min**                        Automated PITR (7--30d), daily x‑region snapshot copy           **Restore to latest restorable time** in *REGION_A* (or *REGION_B* if regional outage), then attach writer   RB‑N‑02 / RB‑N‑01
  **DynamoDB** (rate limits, abuse flags)   Small/ephemeral            **\< 1 min**             **\< 15 min**                           **Global Tables** (A↔B)                                         Active‑active; app env chooses nearest table                                        

### TD-0325 (tech)

<!-- id: TD-0325 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1170000-1174000 -->

o latest restorable time** in *REGION_A* (or *REGION_B* if regional outage), then attach writer   RB‑N‑02 / RB‑N‑01
  **DynamoDB** (rate limits, abuse flags)   Small/ephemeral            **\< 1 min**             **\< 15 min**                           **Global Tables** (A↔B)                                         Active‑active; app env chooses nearest table                                                                 RB‑N‑05
  **S3 (media)**                            Originals + SFW variants   0 (versioned)            **\< 30 min**                           **Versioning + Object Lock (selected buckets)** + **CRR** A→B   Undelete/restore versions; switch origin if needed                                                           RB‑N‑03
  **Typesense (search)**                    **Derived** from DB        N/A (derived)            **\< 2--4 h** full; **\< 15 min** hot   Treat as **ephemeral**; reindex from outbox/source              Recreate cluster; run reindex pipeline                                                                       RB‑N‑04
  **Amplify Hosting / Web**                 Git                        0                        **\< 30 min**                           Redeploy from repo (IaC)                                        Deploy to B; Route53 failover                                                                                RB‑N‑01
  **AppSync/Lambda**                        IaC                        0                        **\< 30 min**                           CDK stacks mirrored                                             Deploy to B; swap endpoints                                                                                  RB‑N‑01
  **Stripe**                                Stripe                     0                        **\< 30 min**                           Idempotent processors; DLQ                                      Replay events from Stripe API; idempotent writes                                                             RB‑N‑06
  **Email (SES/3rd)**                       Provider                   0                        **\< 30 min**                           Secondary provider ready                                        Switch SMTP/API key                                                                                          RB‑N‑07
  **CloudFront/DNS**                        Config                     0                        **\< 15--30 min**                       Health‑checked failover                                         Flip to B origins                                                                                            RB‑N‑01
  ----------------------------------------- -------------------------- ------------------------ --------------------------------------- --------------------------------------------------------------- ------------------------------------------------------------------------------------------------------------ -------------------

**Why Typesense is "ephemeral."** It holds no authority; we can always
rebuild from Aurora + outbox. This keeps costs low and speeds DR.

## **N.2 "DR‑Ready" baseline (checklist)**

5586. **IaC parity:** All stacks (Amplify, AppSync, Lambdas, WAF,
      CloudFront, Route53, Aurora, Dynamo, Typesense) defined in CDK and
      **synthesized for both regions**.
5587. **Secrets replicated:** Secrets Manager/Parameter Store values
      **exist in both regions** (automated sync job).
5588. **S3:** Versioning **ON**; **Object Lock (governance mode)** for
      critical buckets; **CRR** A→B for originals and SFW.
5589. **Aurora:** PITR retention ≥ **7 days**; scheduled **snapshot
      copy** to *REGION_B*.
5590. **DynamoDB:** **Global Tables** for small, hot, ephemeral data.
5591. **DNS:** Route53 failover records with health checks; ACM certs
      prepared (CloudFront cert in *us‑east‑1*).
5592. **Reindex pipeline:** A single command/script can rebuild
      Typesense from DB (hot filters first).
5593. **Ru

### TD-0326 (tech)

<!-- id: TD-0326 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1173600-1177600 -->

. **Aurora:** PITR retention ≥ **7 days**; scheduled **snapshot
      copy** to *REGION_B*.
5590. **DynamoDB:** **Global Tables** for small, hot, ephemeral data.
5591. **DNS:** Route53 failover records with health checks; ACM certs
      prepared (CloudFront cert in *us‑east‑1*).
5592. **Reindex pipeline:** A single command/script can rebuild
      Typesense from DB (hot filters first).
5593. **Runbooks & drills:** Quarterly drills; time‑stamped results.

## **N.3 Backups, replication & rotation**

- **Aurora PITR:** automated; window covers at least one release cycle.
  **Snapshot copy** to *REGION_B* nightly.
- **S3:** *BucketPolicy* blocks *s3:DeleteObjectVersion* except via
  break‑glass role; Object Lock 7--30 days for compliance buckets.
- **DynamoDB:** Global Tables across A/B; enable PITR in both.
- **Configs:** Export CloudFront, WAF, Route53 configs to IaC; store in
  repo.
- **Secrets:** A small Lambda replicates secret updates A→B with
  encryption context.

## **N.4 Runbooks (step‑by‑step)**

Commands use placeholders --- set these at runtime:

*export PRIMARY=REGION_A*\
*export SECONDARY=REGION_B*\
*export AURORA_CLUSTER_ID=prod-core-cluster*\
*export NEW_CLUSTER_ID=dr-core-\$(date +%Y%m%d%H%M)*\
*export RESTORE_TS=\"2025-11-06T12:30:00Z\" \# use "latest restorable"
for corruption; exact TS for user error*\
*export TYPESENSE_ENDPOINT=https://ts-dr.example.com*\
*export S3_ORIG_BUCKET=media-originals-prod*\
*export S3_SFW_BUCKET=media-sfw-prod*\
*export HOSTED_ZONE_ID=Z123456*\
*export PROD_DOMAIN=rastup.com*\

### **RB‑N‑01 --- Regional failover (A → B)**

**When:** Region‑wide outage; multi‑AZ failure; long control‑plane
incident.\
**RTO target:** ≤ **90 min** (pilot‑light); faster with warm standby.

5599. **Declare SEV & freeze writes** (feature flag
      *global_readonly=true* if A partially alive).
5600. Stand up core in B via CDK:

*cdk deploy \--all \--profile prod \--context region=\$SECONDARY*\

5601. **Aurora restore in B** (from most recent cross‑region snapshot or
      PITR):\
      List snapshots:

*aws rds describe-db-cluster-snapshots \--region \$SECONDARY
\--db-cluster-identifier \$AURORA_CLUSTER_ID*\

Restore:

*aws rds restore-db-cluster-from-snapshot \\*\
*\--region \$SECONDARY \\*\
*\--db-cluster-identifier \$NEW_CLUSTER_ID \\*\
*\--snapshot-identifier
arn:aws:rds:\$SECONDARY:\...:cluster-snapshot:\... \\*\
*\--engine aurora-postgresql*\
*\# create a writer instance for the cluster*\
*aws rds create-db-instance \\*\
*\--region \$SECONDARY \\*\
*\--db-instance-identifier \${NEW_CLUSTER_ID}-writer \\*\
*\--db-cluster-identifier \$NEW_CLUSTER_ID \\*\
*\--db-instance-class db.serverless*\

5602. **Point app env to B DB/Lambdas/Typesense.** Update
      Secrets/Parameter Store in B with new endpoints.
5603. **Typesense in B (fresh cluster):** run reindex (RB‑N‑04).
5604. **CloudFront failover**: update origins to B; **Route53** swap
      (weighted→failover or health‑checked alias):

*aws route53 change-resource-record-sets \--hosted-zone-id
\$HOSTED_ZONE_ID \--change-batch*
[*file://ops/dr/route53-failover-to-B.json*](file://ops/dr/route53-failover-to-B.json)

5605. **Smoke tests:** auth, search, profile, checkout (test mode),
      messaging.
5606. **Lift read‑only**, monitor error rates.
5607. **Post‑incident:** document delta, costs, and back‑sync plan A↔B.

### **RB‑N‑02 --- Aurora point‑in‑time restore (logical corruption)**

**When:** bad migration, accidental mass delete/update, application
bug.\
**RPO:** ≤ **5--15 min** (to latest restorable) or exact known
timestamp.

5608. **Declare SEV, freeze writes** (*global_readonly=true*).
5609. **Restore new cluster to TS**:

*aws rds restore-db-cluster-to-point-in-time \\*\
*\--region \$PRIMARY \\*\
*\--db-cluster-identifier \$NEW_CLUSTER_ID \\*\
*\--source-db-cluster-identifier \$AURORA_CLUSTER_ID \\*\
*\--restore-to-time \"\$RESTORE_TS\" \\*\
*\--use-latest-restorable-time false \\*\
*\--engine aurora-postgresql*\
*aws rds create-db-instance 

### TD-0327 (tech)

<!-- id: TD-0327 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1177200-1181200 -->

e writes** (*global_readonly=true*).
5609. **Restore new cluster to TS**:

*aws rds restore-db-cluster-to-point-in-time \\*\
*\--region \$PRIMARY \\*\
*\--db-cluster-identifier \$NEW_CLUSTER_ID \\*\
*\--source-db-cluster-identifier \$AURORA_CLUSTER_ID \\*\
*\--restore-to-time \"\$RESTORE_TS\" \\*\
*\--use-latest-restorable-time false \\*\
*\--engine aurora-postgresql*\
*aws rds create-db-instance \\*\
*\--region \$PRIMARY \\*\
*\--db-instance-identifier \${NEW_CLUSTER_ID}-writer \\*\
*\--db-cluster-identifier \$NEW_CLUSTER_ID \\*\
*\--db-instance-class db.serverless*\

5610. **Run data validation suite** (row counts by table; hash of key
      business tables).
5611. **Swap connections** (Secrets/Parameter Store → new hostnames).
5612. **Decommission old cluster** after backup (retain snapshot).
5613. **Unfreeze writes**; monitor.

### **RB‑N‑03 --- S3 undelete/restore (versioned buckets)**

**When:** accidental delete/overwrite; NSFW purge rollback.

5614. List object versions:

*aws s3api list-object-versions \--bucket \$S3_ORIG_BUCKET \--prefix
path/to/object.jpg*\

5615. Restore a prior version (copy over latest):

*aws s3api copy-object \\*\
*\--bucket \$S3_ORIG_BUCKET \\*\
*\--key path/to/object.jpg \\*\
*\--copy-source
\${S3_ORIG_BUCKET}/path/to/object.jpg?versionId=\<VERSION\> \\*\
*\--metadata-directive REPLACE*\

5616. Purge CDN for keys:

*aws cloudfront create-invalidation \--distribution-id EABC123 \--paths
\"/path/to/object.jpg\"*\

5617. **If a large batch:** run *ops/dr/s3-restore-list.sh* (iterates
      CSV of keys+versions).

### **RB‑N‑04 --- Typesense loss → full reindex**

**When:** cluster loss/corruption; schema upgrade failure.

5618. **Create new cluster** (ECS/EC2 or managed host) in region.

5619. **Apply schemas** (*ops/typesense/collections.json*).

5620. **Run reindex script** (*ops/dr/typesense_reindex.ts*):

      n.  Pull **hot slices first** (top cities/roles) for fast partial
          recovery.
      o.  Then backfill full corpus.

**Sample reindex skeleton (Node):**

*import { Client } from \'typesense\';*\
*import pg from \'pg\';*\
\
*const ts = new Client({ nodes: \[{ host: process.env.TS_HOST, port:
443, protocol: \'https\' }\], apiKey: process.env.TS_KEY });*\
*const db = new pg.Pool({ connectionString: process.env.DB_URL });*\
\
*async function stream(q: string, f: any, toCollection: string) {*\
*const rows = await db.query(q, f);*\
*const batch = rows.rows.map(normalize);*\
*await ts.collections(toCollection).documents().import(batch, { action:
\'upsert\' });*\
*}*\
\
*(async () =\> {*\
*await stream(\"select \* from search.people_hot(\$1)\", \[/\* city/role
hot list \*/\], \"people\");*\
*await stream(\"select \* from search.people_all()\", \[\],
\"people\");*\
*await stream(\"select \* from search.studios_all()\", \[\],
\"studios\");*\
*await stream(\"select \* from search.work_all()\", \[\], \"work\");*\
*})();*\

### **RB‑N‑05 --- DynamoDB: table restore or global cutover**

**When:** table corruption or mis‑deployment.

- If **Global Tables**: flip app to **secondary replica** (no change
  needed; both active).
- **PITR restore** to new table:

*aws dynamodb restore-table-to-point-in-time \\*\
*\--source-table-name rate_limits \\*\
*\--target-table-name rate_limits_restore\_\$(date +%s) \\*\
*\--use-latest-restorable-time*\

- **Swap** environment variable/alias to new table; archive the old one.

### **RB‑N‑06 --- Stripe webhook outage → replay**

**When:** webhook endpoint down; missed events.

5624. **Identify last processed event time/id** (persisted by your
      processor).
5625. **List events since that point (pseudocode)**:

*\# Using curl or Stripe SDK; pagination by created timestamp*\
*curl -G*
[*https://api.stripe.com/v1/events*](https://api.stripe.com/v1/events)
*\\*\
*-u sk_live\_\...: \\*\
*\--data-urlencode \"created\[gte\]=\<unix_ts\>\" \\*\
*\--data-urlencode \"limit=100\"*\

5626. **Replay** each event into your **idempotent** handler (HTTP POST)
      or **ca

### TD-0328 (tech)

<!-- id: TD-0328 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1180800-1184800 -->

**List events since that point (pseudocode)**:

*\# Using curl or Stripe SDK; pagination by created timestamp*\
*curl -G*
[*https://api.stripe.com/v1/events*](https://api.stripe.com/v1/events)
*\\*\
*-u sk_live\_\...: \\*\
*\--data-urlencode \"created\[gte\]=\<unix_ts\>\" \\*\
*\--data-urlencode \"limit=100\"*\

5626. **Replay** each event into your **idempotent** handler (HTTP POST)
      or **call the processor** directly with retrieved payloads (avoid
      signature check in replay mode; mark *replayed=true*).
5627. **Reconcile** orders/payouts; inspect DLQ.

### **RB‑N‑07 --- Email (SES/secondary) failover**

**When:** SES region incident or block.

5628. **Switch provider credentials** (Secrets in region B).
5629. **Re‑send failed critical notifications** (queue maintains failed
      IDs).
5630. **Warm‑up rate** to avoid reputation spikes.

### **RB‑N‑08 --- CloudFront/DNS invalidation & cutback**

- **Invalidate** critical paths after restores.
- **Rollback** Route53 to primary when stable; keep B warm for 24--48h.

## **N.5 Scripts & templates (repo paths)**

*ops/dr/aurora_pitr_restore.sh*\
*ops/dr/aurora_restore_from_snapshot.sh*\
*ops/dr/s3-restore-list.sh*\
*ops/dr/typesense_reindex.ts*\
*ops/dr/route53-failover-to-B.json*\
*ops/dr/route53-restore-to-A.json*\
*ops/dr/checks/smoke.sh*\
*ops/dr/checks/data_consistency.sql*\

***ops/dr/aurora_pitr_restore.sh*** **(template)**

*#!/usr/bin/env bash*\
*set -euo pipefail*\
*: \"\${PRIMARY:?} \${AURORA_CLUSTER_ID:?} \${RESTORE_TS:?}\"*\
*NEW_CLUSTER_ID=\"dr-core-\$(date +%Y%m%d%H%M)\"*\
*aws rds restore-db-cluster-to-point-in-time \\*\
*\--region \"\$PRIMARY\" \\*\
*\--db-cluster-identifier \"\$NEW_CLUSTER_ID\" \\*\
*\--source-db-cluster-identifier \"\$AURORA_CLUSTER_ID\" \\*\
*\--restore-to-time \"\$RESTORE_TS\" \\*\
*\--use-latest-restorable-time false \\*\
*\--engine aurora-postgresql*\
*aws rds create-db-instance \\*\
*\--region \"\$PRIMARY\" \\*\
*\--db-instance-identifier \"\${NEW_CLUSTER_ID}-writer\" \\*\
*\--db-cluster-identifier \"\$NEW_CLUSTER_ID\" \\*\
*\--db-instance-class db.serverless*\
*echo \"New cluster: \$NEW_CLUSTER_ID\"*\

***ops/dr/checks/data_consistency.sql***

*\-- Row counts & sums for sanity*\
*SELECT \'users\' AS t, COUNT(\*) AS c FROM public.users*\
*UNION ALL SELECT \'orders\', COUNT(\*) FROM public.orders*\
*UNION ALL SELECT \'payments\', COUNT(\*) FROM public.payments*\
*UNION ALL SELECT \'messages\', COUNT(\*) FROM public.messages;*\
\
*\-- Hash of critical business keys*\
*SELECT md5(string_agg(id::text \|\| \':\' \|\| updated_at::text, \',\'
ORDER BY id)) AS orders_hash FROM public.orders;*\

## **N.6 DR drills & evidence**

- **Quarterly drill plan:**\
  **Q1** --- Aurora PITR (RB‑N‑02).\
  **Q2** --- Region failover A→B (RB‑N‑01).\
  **Q3** --- Typesense total loss with reindex (RB‑N‑04).\
  **Q4** --- S3 mass undelete with CDN purge (RB‑N‑03).
- **Evidence stored in** *ops/dr/drill_reports/YYYY‑QX.md*: start→end
  timestamps, RTO achieved, variances, follow‑ups.

## **N.7 Cost posture & upgrade path**

- **MVP (pilot‑light):** Lowest steady cost. RPO tied to PITR window
  (**minutes**), RTO \~ **1--1.5 h**.

- Upgrade (warm standby / active‑active):

  - Promote **Aurora Multi‑Region** (if supported by chosen engine
    config) to reach **RPO \< 1 min, RTO \< 15--30 min**.
  - Keep **Typesense** hot‑hot with async replica (optional).
  - Increase Route53 automated failover (health checks + alarms).

## **N.8 Acceptance criteria (Appendix N = FINAL)**

5637. **DR matrix** reviewed; RTO/RPO targets documented and signed off.
5638. **Backups & replication** verified: Aurora PITR on, S3
      versioning+CRR, Dynamo Global Tables live.
5639. **Runbooks RB‑N‑01...RB‑N‑08** exist in repo and execute cleanly
      (dry‑runs where applicable).
5640. **Reindex** completes within stated window (hot slices \< 15 min,
      full \< 4 h); scripts work against Stage clone.
5641. **Quarterly drills** captured with measured RTO; deviations have
      

### TD-0329 (tech)

<!-- id: TD-0329 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1184400-1188400 -->

eplication** verified: Aurora PITR on, S3
      versioning+CRR, Dynamo Global Tables live.
5639. **Runbooks RB‑N‑01...RB‑N‑08** exist in repo and execute cleanly
      (dry‑runs where applicable).
5640. **Reindex** completes within stated window (hot slices \< 15 min,
      full \< 4 h); scripts work against Stage clone.
5641. **Quarterly drills** captured with measured RTO; deviations have
      action items.
5642. **DNS/CloudFront** failover tested at least once pre‑launch.

# **Appendix O --- Data Governance (field‑level retention map, enforcement & automation) --- deep version**

**Purpose.** Ensure lawful, safe, and cost‑efficient handling of data
from collection through deletion. This appendix provides a **field‑level
catalog**, **retention & masking rules**, **DSAR** (export/delete)
procedures, **lineage**, **classification tags**, **automations**
(SQL/Lambda/Glue), and **acceptance criteria**. It plugs into §1.24
(Security & Privacy), §1.28 (Exports & Portability), Appendix L (Logging
& Redaction), Appendix R (Rate Limits), and Appendix AC (FinOps).

**Scope.** All production stores: Aurora Postgres, DynamoDB
(rate/abuse), S3 (originals & SFW variants), Typesense, CloudFront logs,
email provider logs, analytics lake (optional), plus derived caches.

## **O.0 Taxonomy (controlled vocab)**

**Classification (*****class*****)**: *PUBLIC*, *INTERNAL*,
*CONFIDENTIAL*, *RESTRICTED*.\
**PII tag (*****pii*****)**: *none*, *direct* (e.g., email), *indirect*
(e.g., city + handle), *special* (payment tokens, government IDs).\
**Regimes (*****regime*****)**: *gdpr*, *ccpa*, *can-spam*, *pci-lite*
(no PAN storage; Stripe tokenized).\
**Masking policy (*****mask*****)**: *none*, *hash*, *partial*,
*redact*, *tokenize*.\
**Retention action (*****action*****)**: *expire*, *anonymize*,
*archive*, *retain*.\
**Subject (*****subject*****)**: *end_user*, *provider*, *staff*,
*system*.

These keys are used consistently across CSV/YAML below.

## **O.1 Field‑level data catalog & retention map** ***(paste into a CSV or keep here)***

**Columns:** dataset.table \| field \| class \| pii \| regime \| mask \|
retention \| action \| purpose \| notes

*dataset.table,field,class,pii,regime,mask,retention,action,purpose,notes*\
*users,id,RESTRICTED,none,gdpr;ccpa,none,ret=account_life+6m,retain,Primary
key,Non-PII UUID*\
*users,email,RESTRICTED,direct,gdpr;ccpa,partial,ret=account_life+30d,anonymize,Auth
& notifications,Masked in logs; unique index*\
*users,phone,RESTRICTED,direct,gdpr;ccpa,partial,ret=account_life+30d,anonymize,2FA
& comms,Optional field*\
*users,password_hash,RESTRICTED,special,gdpr,redact,ret=account_life+30d,delete,Auth,Argon2id/bcrypt;
never exported*\
*users,display_name,CONFIDENTIAL,indirect,gdpr,none,ret=account_life+90d,anonymize,Public
profile,May remain in reviews as pseudonym*\
*users,city,CONFIDENTIAL,indirect,gdpr,none,ret=account_life+90d,anonymize,Search
facet,Coarse locality*\
*users,country,CONFIDENTIAL,indirect,gdpr,none,ret=account_life+90d,anonymize,Search
facet,*\
*users,consents
(json),RESTRICTED,none,gdpr,none,ret=account_life+6y,retain,Legal
consent ledger,Immutable events*\
*profiles,user_id,RESTRICTED,none,gdpr,none,ret=account_life+90d,anonymize,Join
to users,On delete→cascade anonymize*\
*profiles,headline,PUBLIC,none,,none,ret=account_life+90d,anonymize,Public
content,*\
*profiles,bio,PUBLIC,none,,redact,ret=account_life+90d,anonymize,Public
content,Remove links on delete*\
*profiles,price_min,INTERNAL,none,,none,ret=account_life+90d,anonymize,Search/ranking,*\
*profiles,tags\[\],PUBLIC,none,,none,ret=account_life+90d,anonymize,Discovery,*\
*studios,id,RESTRICTED,none,,none,ret=account_life+90d,anonymize,Studio
entity,*\
*studios,name,PUBLIC,none,,none,ret=account_life+90d,anonymize,Public
content,*\
*studios,address_privacy,RESTRICTED,none,,none,ret=account_life+90d,retain,Privacy
flag,*\
*studios,amenities\[\],PUBLIC,none,,none,ret=account_life+90d,anonymize,Search
facet,*\
*media_assets,id,RESTRICTED

## Pre-Run Ritual (HARD)

- [ ] Read your last run report.
- [ ] Read any related run reports for the same WBS or feature.
- [ ] Summarise Plan vs Done vs Pending before writing new code.

## Locking & Access (HARD)

- Acquire your lock file at `ops/locks/AGENT-1.lock` before modifying files.
- Declare your scope_paths[] in your run report.
- If you detect overlapping scopes or foreign changes, STOP and hand back to the Orchestrator.

## Required Run Report Content (HARD)

- Context Snapshot (WBS IDs, blueprint IDs, assumptions).
- What Was Done vs Planned.
- How It Was Done (architecture/implementation narrative).
- Testing (commands, results, coverage, security scans) + 'Testing Proof' paragraph.
- Issues & Problems (with root causes where possible).
- Locations / Touch Map (files created/modified/removed, migrations, databases touched).
- Suggestions for Next Agents.
- Progress & Checklist.

## Orchestrator Attach Pack (HARD)

- Place under `docs/orchestrator/from-agents/AGENT-1/run-<timestamp>-attach.zip`.
- Include: run report, diff summary, CI/test artifacts, performance/security results,
  and a manifest.json (agent, run_id, wbs_ids, blueprint_ids, status).

## Testing (HARD)

- Define a test plan before coding.
- Implement unit/integration/E2E tests where appropriate.
- Record all test commands and results in the run report.
- If you cannot implement or run tests, mark the task partial and propose follow-up WBS items.

## Implementation Notes

(Use this space during your run.)

## Issues & Risks

(Document any issues, risks, or TODOs you discover.)

## Suggestions for Next Agents

(Document any guidance for follow-up work.)
