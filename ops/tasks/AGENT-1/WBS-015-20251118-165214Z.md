# Task for AGENT-1: WBS-015 — Communications and Notifications System

You are a Cursor CLI agent working under a central Orchestrator.

## WBS Task

- ID: WBS-015
- Title: Communications and Notifications System
- Phase: Ops
- Agent: AGENT-1
- Depends on: WBS-001, WBS-002
- Blueprint IDs: TD-0050, TD-0051, TD-0052, TD-0053, TD-0054, TD-0055, TD-0056

### Description

Build a cost-efficient, privacy-safe communications layer delivering email (SES), push (Pinpoint), SMS (SNS/Twilio), and in-app notifications with user preferences, quiet hours, and critical exceptions. Use templated MJML documents with localization, A/B testing, and immutable audit trails. Implement deduplication, batching, and suppression on bounces/complaints. Provide admin consoles for template management, suppression lists, and audit logs with dual approvals. Integrate link tracking respecting privacy and DNT. Enforce deliverability best practices including SPF, DKIM, DMARC, and warmup. Provide observability dashboards, alerts, and runbooks.

### Acceptance Criteria

- Multi-channel communications with user preferences and quiet hours
- Templated MJML documents with localization and A/B testing
- Deduplication, batching, and suppression on bounces and complaints
- Admin consoles for template and suppression management with audit logs
- Link tracking respecting privacy and DNT
- Deliverability with SPF, DKIM, DMARC, and warmup
- Observability dashboards, alerts, and runbooks implemented
- Tests cover routing, delivery, suppression, and compliance


## Relevant Blueprint Chunks

### TD-0050 (tech)

<!-- id: TD-0050 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 180000-184000 -->

ays in Tax Payable.
925. Statements (buyer/seller) accurate and downloadable; platform
     exports ready for accounting.
926. Telemetry complete; SLOs met; costs within budget alarms.

# **§1.10 --- Notifications & Comms**

*(templates & variables · channels (email/push/SMS/in‑app) · quiet hours
& preferences · deliverability & bounces · dedupe & batching · audits ·
admin · telemetry · tests · cost)*

**Purpose.** Build a cost‑efficient, privacy‑safe, and auditable
communications layer that delivers the right message on the right
channel at the right time---without noise, policy risk, or surprises.
This section specifies **data models, providers, APIs, message
templates, preference/quiet‑hours logic, deliverability & suppression,
dedupe & batching, admin tools, telemetry, SLOs, tests, and cost
levers**. We will *not* move on until §1.10 reaches your 99.9% bar.

**Note on scope alignment:** §1.10 covers platform communications
(system emails, SMS, push, and in‑app notifications). Thread messages
and action cards live in §1.4; finance emails/statements are integrated
but defined here for sending rules.

We'll complete §1.10 in **two parts** in case length exceeds limits.
This reply delivers **Part 1** (architecture, data model, templates,
providers, preferences/quiet hours, API, dedupe/batching). Next reply
(still §1.10) will cover **deliverability (DKIM/DMARC),
suppression/bounces, in‑app notification center,
experiments/localization, admin console, telemetry/SLOs, test matrix,
and cost**.

## **1.10.A Canon & invariants**

927. **User control first:** channel‑level **preferences** (opt‑in/out
     by category) and **quiet hours** are enforced server‑side for all
     non‑critical comms.
928. **Critical vs non‑critical:** payment receipts, security, and legal
     notices always send (with minimal content); marketing is opt‑in and
     rate‑limited.
929. **One source of truth:** every message is a **templated document**
     with **variables** and an **audit trail** (who/what/why/when).
930. **Dedupe & batching:** collapse bursts (e.g., 5 rapid messages → 1
     digest) and never notify a user about their **own** action unless
     explicitly warranted.
931. **Deliverability & compliance:** authenticated domains
     (SPF/DKIM/DMARC), bounce/complaint suppression, List‑Unsubscribe,
     CAN‑SPAM/TCPA/GDPR hygiene.
932. **Cost aware:** SES for email (default); FCM/APNs for push;
     SNS/Twilio for SMS behind a cost gate; in‑app first where possible.

## **1.10.B Providers & architecture**

- **Email**: Amazon **SES** (default). Optional SendGrid adapter
  (feature‑flag).
- **Push**: Web push via Firebase **FCM**; mobile push via **APNs**
  (iOS) and **FCM** (Android).
- **SMS**: AWS **SNS SMS** (default) or **Twilio** via adapter
  (feature‑flag & per‑country pricing).
- **In‑app**: Real‑time via AppSync subscriptions; persisted in Aurora
  for unread counters.

**Pipeline (event‑driven):**\
Domain event → **Comms Router** (rules engine) → **Renderer** (select
template, fill variables, localize) → **Channel workers**
(email/push/SMS/in‑app) → Provider → **Webhook ingesters** (deliveries,
opens, bounces, complaints) → **Suppression & analytics**.

**Backpressure & retries:** SQS queues per channel with DLQ; exponential
backoff with idempotency keys.

## **1.10.C Data model (Aurora + DynamoDB + S3)**

*\-- 1) Template catalog (versioned)*\
*create table comms_template (*\
*template_id text primary key, \-- tpl\_\...*\
*name text not null, \-- \"booking_confirmed_buyer\"*\
*version int not null,*\
*channel text not null check (channel in
(\'email\',\'push\',\'sms\',\'inapp\')),*\
*locale text not null default \'en-US\',*\
*category text not null, \--
\'transactional\',\'security\',\'legal\',\'product\',\'marketing\'*\
*subject_mjml text, \-- for email (subject pre-render)*\
*body_mjml text, \-- email MJML or HTML*\
*body_text text, \-- fallback plain text*\
*push_json jsonb, \-- title/body/data for push*\
*sms_text text, \-- SMS 

### TD-0051 (tech)

<!-- id: TD-0051 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 183600-187600 -->


(\'email\',\'push\',\'sms\',\'inapp\')),*\
*locale text not null default \'en-US\',*\
*category text not null, \--
\'transactional\',\'security\',\'legal\',\'product\',\'marketing\'*\
*subject_mjml text, \-- for email (subject pre-render)*\
*body_mjml text, \-- email MJML or HTML*\
*body_text text, \-- fallback plain text*\
*push_json jsonb, \-- title/body/data for push*\
*sms_text text, \-- SMS body*\
*inapp_json jsonb, \-- in-app payload template*\
*variables_json jsonb not null, \-- required vars schema*\
*is_active boolean default true,*\
*created_by text not null,*\
*created_at timestamptz not null default now(),*\
*published_at timestamptz,*\
*unique (name, version, locale, channel)*\
*);*\
\
*\-- 2) Preference categories (system-defined)*\
*create table comms_category (*\
*category_id text primary key, \-- cat\_\...*\
*key text unique not null, \--
\'booking\',\'messages\',\'reviews\',\'promotions\',\'security\',\'legal\'*\
*description text not null,*\
*critical boolean not null default false \-- if true, cannot fully
opt-out*\
*);*\
\
*\-- 3) User preferences & quiet hours*\
*create table comms_pref (*\
*pref_id text primary key, \-- prf\_\...*\
*user_id text not null, \-- usr\_\...*\
*channel text not null check (channel in
(\'email\',\'push\',\'sms\',\'inapp\')),*\
*category_key text not null references comms_category(key),*\
*opted_in boolean not null default true, \-- default true except
marketing/SMS*\
*updated_at timestamptz not null default now(),*\
*unique (user_id, channel, category_key)*\
*);*\
\
*create table comms_quiet_hours (*\
*user_id text primary key, \-- usr\_\...*\
*tz text not null, \-- IANA tz string*\
*start_local time not null, \-- e.g., \'21:00:00\'*\
*end_local time not null \-- e.g., \'08:00:00\'*\
*);*\
\
*\-- 4) Message audit & status*\
*create table comms_message (*\
*msg_id text primary key, \-- cms\_\...*\
*user_id text not null, \-- recipient*\
*channel text not null,*\
*template_name text not null,*\
*template_version int not null,*\
*category_key text not null,*\
*locale text not null,*\
*dedupe_key text not null, \-- for collapsing bursts*\
*subject text,*\
*body_rendered_s3 text, \-- emails: rendered HTML in S3 (immutable)*\
*body_text text, \-- plaintext snapshot (where safe)*\
*status text not null check (status in
(\'queued\',\'sent\',\'delivered\',\'bounced\',\'complained\',\'dropped\',\'suppressed\',\'failed\')),*\
*provider_ref text, \-- SES message id, etc.*\
*cause_event text not null, \-- domain event name*\
*cause_ref text not null, \-- leg_id/lbg_id/thread_id/etc.*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now()*\
*);*\
\
*\-- 5) Suppression & bounces (email/SMS)*\
*create table comms_suppression (*\
*suppress_id text primary key, \-- sup\_\...*\
*channel text not null,*\
*address_hash text not null, \-- hashed email or phone*\
*reason text not null check (reason in
(\'hard_bounce\',\'complaint\',\'manual\')),*\
*created_at timestamptz not null default now(),*\
*unique (channel, address_hash)*\
*);*\
\
*\-- 6) In-app notifications*\
*create table inapp_notification (*\
*inapp_id text primary key, \-- iap\_\...*\
*user_id text not null,*\
*category_key text not null,*\
*title text not null,*\
*body text not null,*\
*deep_link text,*\
*unread boolean not null default true,*\
*created_at timestamptz not null default now()*\
*);*\

**DynamoDB (hot path):**

- *comms_tokens* (push tokens per device, per user, with expiry,
  platform).
- *comms_dedupe* (keyed by *dedupe_key*, TTL 2--5 minutes) to collapse
  bursts.
- *comms_queue_cursor* to preserve stable batches during paging.

**S3:**

- *comms-rendered/...* stores immutable HTML bodies & PDFs (statements)
  referenced by *comms_message.body_rendered_s3*.

## **1.10.D Template system & variables**

- **Authoring**: Email uses **MJML** → compiled to inline‑styled HTML.
  SMS uses strict text length (truncate & link to in‑app). Push uses
  *{title, body, data}*. In‑app stores 

### TD-0052 (tech)

<!-- id: TD-0052 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 187200-191200 -->

r* to preserve stable batches during paging.

**S3:**

- *comms-rendered/...* stores immutable HTML bodies & PDFs (statements)
  referenced by *comms_message.body_rendered_s3*.

## **1.10.D Template system & variables**

- **Authoring**: Email uses **MJML** → compiled to inline‑styled HTML.
  SMS uses strict text length (truncate & link to in‑app). Push uses
  *{title, body, data}*. In‑app stores *{title, body, deep_link}*.
- **Variables**: Declared in *variables_json* with type, description,
  and required flag. Types: *string*, *int*, *money_cents*, *date*,
  *datetime*, *duration*, *enum{...}*, *url*.
- **Localization**: Templates can exist per *locale* (start with
  *en-US*). Fallback: *en-US* if no locale‑specific template.

**Core templates (MVP, examples)**

- Booking lifecycle: *booking_confirmed_buyer*,
  *booking_confirmed_seller*, *booking_rescheduled*,
  *booking_cancellation_outcome*.
- Docs: *doc_sign_request*, *doc_sign_reminder*, *doc_complete*.
- Payments: *charge_receipt*, *refund_receipt*, *payout_queued*,
  *payout_paid*, *statement_ready*.
- Messaging: *new_message_digest*, *deliverable_posted*,
  *review_reminder*.
- Trust: *idv_start*, *idv_reminder*, *bg_invited*, *badge_awarded*.
- Promotions: *promo_low_balance*, *promo_statement_ready*.

*(I can include full MJML bodies upon request; they're verbose.)*

**Variable resolution**

- Resolver library maps domain objects → template variables (e.g., leg
  dates in local timezone, names, amounts with currency formatting, doc
  links with signed URLs).
- Hard **PII minimization**: SMS never includes full names + addresses +
  money in the same text; use in‑app deep links.

## **1.10.E Routing rules (Comms Router)**

**Input**: domain event *{name, user_id(s), cause_ref, payload}*.

**Steps**

952. **Select template(s)** for event + role (buyer/seller/admin).
953. **Apply preferences** and **quiet hours** for the recipient (skip
     or schedule).
954. **Dedupe** using *dedupe_key* (e.g., *THREAD:{id}:{minute}* for
     rapid message bursts; *BOOKING:{lbg}:{state}*).
955. **Batch**: gather multiple low‑priority items into digest (e.g.,
     daily message digest).
956. **Render** with locale detection; push to channel queues with
     idempotency keys.

**Critical overrides**

- Security, legal, receipts ignore quiet hours and opt‑out (except SMS
  jurisdiction where consent is required---then fallback to
  email/in‑app).
- If a channel is suppressed (hard bounce/complaint), auto‑fallback to
  in‑app + email to an alternate verified address (if present).

## **1.10.F Preferences & quiet hours (user‑facing)**

**Categories (initial)**

- *security* (critical), *legal* (critical), *booking*, *messages*,
  *reviews*, *promotions* (marketing), *finance* (receipts/statements).

**Defaults**

- Email: opt‑in for all except *promotions* (opt‑out default ON).
- Push: opt‑in for *booking*, *messages*, *reviews* only after device
  grants permission.
- SMS: **opt‑out by default**; explicit opt‑in per category where used
  (*booking* status or *security*).
- In‑app: always on; controlled by red dot/unread.

**Quiet hours**

- Store *tz*, *start_local*, *end_local*.
- Router schedules non‑critical notifications inside allowed windows
  (e.g., 8 am--9 pm local).
- Per‑category overrides (e.g., allow *booking* during quiet hours).

**GraphQL API (user settings)**

*type CommsPreference {*\
*channel: String!*\
*categoryKey: String!*\
*optedIn: Boolean!*\
*updatedAt: AWSDateTime!*\
*}*\
\
*type QuietHours { tz: String!, startLocal: String!, endLocal: String!
}*\
\
*type Query {*\
*commsPreferences: \[CommsPreference!\]!*\
*quietHours: QuietHours*\
*}*\
\
*type Mutation {*\
*setCommsPreference(channel: String!, categoryKey: String!, optedIn:
Boolean!): \[CommsPreference!\]!*\
*setQuietHours(tz: String!, startLocal: String!, endLocal: String!):
QuietHours!*\
*unsubscribeAllEmail(): Boolean! \# sets all email categories to
optedIn=false except critical*\
*}*\

**List‑Unsubscribe

### TD-0053 (tech)

<!-- id: TD-0053 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 190800-194800 -->

mmsPreferences: \[CommsPreference!\]!*\
*quietHours: QuietHours*\
*}*\
\
*type Mutation {*\
*setCommsPreference(channel: String!, categoryKey: String!, optedIn:
Boolean!): \[CommsPreference!\]!*\
*setQuietHours(tz: String!, startLocal: String!, endLocal: String!):
QuietHours!*\
*unsubscribeAllEmail(): Boolean! \# sets all email categories to
optedIn=false except critical*\
*}*\

**List‑Unsubscribe**

- Email headers include *List-Unsubscribe* mailto + HTTPS link to a
  **one‑click** suppression endpoint (sets *comms_pref* to opted‑out for
  marketing categories and records *comms_suppression* if required by
  provider).

## **1.10.G Channel workers & dedupe/batching**

**Email worker (SES)**

- Receives rendered HTML + text, sets **SPF/DKIM domains**,
  **List‑Unsubscribe** headers, adds **message‑id** for threading,
  queues to SES.
- Stores a copy of rendered HTML in S3 and writes *comms_message*.

**Push worker**

- Sends to device tokens (APNs/FCM) with *collapse_key* to dedupe on
  device; respects per‑device language; drops invalid tokens and prunes
  from *comms_tokens*.

**SMS worker**

- Enforces country gating and high cost flags; trims body to length;
  inserts short links; checks suppression and opt‑in.
- Templated STOP/HELP footer where required.

**Batching**

- **Message digest**: compile last N thread updates into one email if
  user inactive for M minutes; include counts and deep links.
- **Review reminders**: send at 24 h and 72 h unless user already
  reviewed; cancel if review arrives.

**Idempotency & replays**

- All workers use *(template_name, user_id, cause_ref, version)* as
  idempotency key; retries do not duplicate sends or audits.

## **1.10.H Error taxonomy (client‑safe and admin)**

- *COMMS_PREF_BLOCKED* --- user opted out for that category/channel.
- *COMMS_QUIET_HOURS* --- scheduled due to quiet hours (not an error;
  informational).
- *COMMS_SUPPRESSED* --- address on suppression list (hard
  bounce/complaint).
- *COMMS_TEMPLATE_MISSING_VAR* --- variable resolver missing data
  (developer error; logged).
- *COMMS_PROVIDER_FAIL* --- provider transient error; retried with
  backoff.
- *COMMS_RATE_LIMITED* --- SMS or push throttled.

## **1.10.I Work packages (Cursor agent lanes)**

- **Agent B --- Comms Core**\
  WP‑COMMS‑01: SQL for
  templates/prefs/quiet‑hours/messages/suppression/in‑app.\
  WP‑COMMS‑02: Comms Router & Renderer (MJML compile, variable resolver,
  locale fallback).\
  WP‑COMMS‑03: Channel workers (SES, APNs/FCM, SNS/Twilio) with
  idempotency & retries.
- **Agent A --- Web (Settings & UX)**\
  WP‑WEB‑COMMS‑01: Notification Preferences UI + Quiet Hours UI +
  List‑Unsubscribe landing.\
  WP‑WEB‑COMMS‑02: In‑app notification center (bell, unread counts,
  pagination, mark read).
- **Agent C --- Integrations/Deliverability**\
  WP‑DLV‑01: Domain auth (SPF/DKIM/DMARC), bounce/complaint webhooks,
  suppression list processor.\
  WP‑DLV‑02: Link tracking & UTM, open pixel (email only) with privacy
  guardrails.
- **Agent D --- Admin & QA**\
  WP‑ADM‑COMMS‑01: Template manager (versioning, preview, publish with
  dual approval for legal/security).\
  WP‑QA‑COMMS‑01: Full test matrix automation (see Part 2), synthetic
  provider sandboxes.

## **1.10.J Acceptance criteria (for Part 1) --- we won't move to Part 2 until all hold**

986. Template catalog exists with MJML→HTML render and variable schemas;
     at least the MVP templates are authored (booking, docs, payments,
     messages, trust, promotions).
987. Providers wired (SES, APNs/FCM, SNS/Twilio behind flags); Comms
     Router applies preferences, quiet hours, dedupe, and batching.
988. Message audits stored with immutable link to rendered bodies
     (email) or payload snapshots (push/SMS/in‑app).
989. User Preference & Quiet Hours UI/APIs functional; List‑Unsubscribe
     endpoints live and audited.
990. Channel workers respect cost gates (e.g., SMS limited to critical
     flows where configured).
991. Idempotency & retrie

### TD-0054 (tech)

<!-- id: TD-0054 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 194400-198400 -->

s preferences, quiet hours, dedupe, and batching.
988. Message audits stored with immutable link to rendered bodies
     (email) or payload snapshots (push/SMS/in‑app).
989. User Preference & Quiet Hours UI/APIs functional; List‑Unsubscribe
     endpoints live and audited.
990. Channel workers respect cost gates (e.g., SMS limited to critical
     flows where configured).
991. Idempotency & retries verified; dedupe prevents burst spam.

# **§1.10 --- Notifications & Comms**

**Part 2/2: deliverability, suppression, in‑app center, experiments &
localization, tracking & privacy, admin, telemetry/SLOs, full test
matrix, acceptance**

This completes the communications layer begun in §1.10 (Part 1). We
won't move to the next major subsection until §1.10 passes the 99.9%
bar.

## **1.10.R Deliverability setup (email)**

**R.1 Domain authentication (SES, production domain e.g.,**
***notify.rastup.com*****)**

- **SPF**: *v=spf1 include:amazonses.com -all*
- **DKIM**: enable **Easy DKIM** in SES; publish 3 CNAMEs; rotate
  annually (calendar reminder + auto‑rotate playbook).
- **DMARC**: start with *v=DMARC1; p=quarantine;*
  [*rua=mailto:dmarc@rastup.com*](mailto:rua=mailto:dmarc@rastup.com)*;*
  [*ruf=mailto:dmarc@rastup.com*](mailto:ruf=mailto:dmarc@rastup.com)*;
  fo=1; pct=50*, graduate to *p=reject* after warmup.
- **BIMI** (optional, post‑DMARC‑reject): publish SVG logo and VMC
  (later, cost‑gated flag).

**R.2 SES configuration**

- Verify domain + sender identities
  ([*no-reply@notify.rastup.com*](mailto:no-reply@notify.rastup.com) for
  system, *billing@notify...* for finance, *support@...* for support).
- **Event destinations** → SNS topics for *Delivery*, *Bounce*,
  *Complaint*, *Open* (optional), *Click* (optional).
- Shared IPs at MVP; consider **dedicated IPs** after steady volume
  (requires warmup).

**R.3 IP warmup (if dedicated IPs)**

- Ramp plan for first 2--4 weeks: daily volume ladder + mix of
  high‑engagement templates (booking receipts) to build reputation.
- Dashboards: deliverability by mailbox provider (Gmail, Outlook,
  Yahoo), bounce/complaint thresholds.

**R.4 From/Reply‑To policy**

- Transactional: *From: RastUp \<no-reply@notify...\>* with **Reply‑To
  support** when useful.
- Avoid sending marketing from transactional subdomain.

## **1.10.S Bounce/complaint handling & suppression**

**S.1 Webhooks → suppression list**

- **Hard bounce** or **complaint** → write *comms_suppression*
  (*channel=\'email\'*, *reason=\'hard_bounce\'\|\'complaint\'*,
  *address_hash=SHA256(email)*), set
  *comms_message.status=\'bounced\'\|\'complained\'*.
- **Soft bounces** (4xx) → retry with backoff; if ≥3 within 72h →
  convert to suppression (*reason=\'manual\'*) pending user correction.

**S.2 Unsubscribe & re‑permissioning**

- **List‑Unsubscribe**: one‑click HTTPS endpoint sets
  *comms_pref.email.promotions=false* (and any non‑critical marketing
  categories).
- Re‑permission only via explicit user action in settings; no automatic
  re‑enable after a bounce/complaint.

**S.3 Global blocklist**

- Maintain **platform blocklist** (legal/compliance). Any send to these
  addresses is dropped with *status=\'suppressed\'* and audited.

## **1.10.T In‑app Notification Center (details)**

**T.1 Data & pagination**

- *inapp_notification* (already defined) stores immutable items; add
  indices for *(user_id, created_at desc)*.
- Pagination: cursor by *(created_at, id)* to ensure stable ordering.

**T.2 UX contract**

- **Bell** icon shows unread count; badge hides during DND/quiet hours
  logic (but count still increments).
- **Grouping**: coalesce similar events (e.g., "3 new thread updates").
- **Actions**: "Mark all read", per‑item "Mark read", per‑group clear.
- **Pinning**: high‑priority items (security, legal) appear pinned until
  dismissed.

**T.3 Retention**

- Default retention 90 days; archive older items (user can fetch via
  "Load older" until 1 year, then cold storage).
- Privacy: no sensitive PII in in‑

### TD-0055 (tech)

<!-- id: TD-0055 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 198000-202000 -->

 **Grouping**: coalesce similar events (e.g., "3 new thread updates").
- **Actions**: "Mark all read", per‑item "Mark read", per‑group clear.
- **Pinning**: high‑priority items (security, legal) appear pinned until
  dismissed.

**T.3 Retention**

- Default retention 90 days; archive older items (user can fetch via
  "Load older" until 1 year, then cold storage).
- Privacy: no sensitive PII in in‑app bodies; deep link to secure pages.

## **1.10.U Experiments & localization**

**U.1 Experiments**

- **Bucketing**: sticky, per user (UUID‑v4 salted hash).
- Testable assets: email subject/preview text, CTA wording, send‑time
  (outside quiet hours), digest cadence.
- Metrics: delivery→open→click→conversion, unsubscribe delta; guardrails
  (bounce/complaint ceilings).
- Rollouts: feature flag controls + staged %; automatic rollback on
  guardrail breach.

**U.2 Localization**

- Locale resolution order: user setting → browser *Accept-Language* →
  city default → *en-US*.
- Templates per locale (name/version stable). Fallback to *en-US* when
  missing.
- Pluralization rules (CLDR), local date/time formatting using
  recipient's **timezone** (from quiet hours setting).
- Right‑to‑Left support in MJML (dir attribute), font fallback stacks.

## **1.10.V Link tracking & privacy**

- **Link wrapper**: */l/{token}* where *token =
  HMAC(user_id\|template_name\|msg_id\|url)*; logs *click* then 302 to
  *url*.
- **No tracking** for security/legal emails (privacy first) and
  unsubscribe links.
- **Open pixel** optional; respect **DNT** and suppress tracking for
  sensitive categories.
- **UTM** parameters for non‑critical emails only; strip PII.
- **Data minimization**: SMS never includes full names + full
  addresses + amounts in combination; use in‑app deep links.

## **1.10.W Admin console (Comms)**

- **Template Manager**: search, diff, preview (with sample variables),
  MJML validation, multi‑locale versions, **dual approval** for
  security/legal templates; staged rollout with kill‑switch.
- **Test send**: to whitelisted addresses only; record as
  *status=\'sent\'* with *cause_event=\'admin.test\'*.
- **Suppression Viewer**: search by hashed email/phone; show reasons;
  **re‑permission** only on explicit user opt‑in.
- **Campaigns/Digests**: configure digest cadence, review experiment
  assignments; simulate send volumes with cost estimates.
- **Audit log**: all admin actions immutable with actor, reason, diffs.

## **1.10.X Telemetry, dashboards & SLOs**

**X.1 Metrics**

- Volume per channel, delivery %, soft/hard bounces, complaints, opens,
  clicks, unsubscribe rate, digest suppression %, send latency
  (event→queue→provider), cost per 1k sends (email/SMS), push invalid
  token rate.

**X.2 SLOs**

- Event→queued **≤ 150 ms p95**; queued→provider **≤ 1 s p95**.
- Delivery rate ≥ **98.5%** on transactional (ex‑bounces/complaints).
- Complaint rate ≤ **0.1%**; hard bounce ≤ **0.3%** rolling 7‑day.
- In‑app notification fetch **≤ 120 ms p95**.

**X.3 Alerts**

- Bounce/complaint spikes by provider; quiet‑hours scheduler backlog;
  SMS spend anomalies; push invalid token surges.

## **1.10.Y Full test matrix (Part 2)**

**Deliverability**

1040. SPF/DKIM/DMARC pass; BIMI optional path.
1041. Shared IP warm sends; dedicated IP warmup plan verified (if
      enabled).
1042. From/Reply‑To policies applied; DMARC alignment OK.

**Suppression**\
4) Hard bounce → suppression; retry rules for soft bounces; complaint →
global suppression.\
5) One‑click unsubscribe toggles correct categories; re‑permission
requires explicit user action.

**In‑app**\
6) Pagination, grouping, unread counts, pinning; accessibility
roles/labels.

**Experiments**\
7) Stable bucketing; hold‑out analyses; guardrail auto‑rollback
triggers.

**Localization**\
8) Locale fallback path; pluralization; timezone formatting.

**Tracking & privacy**\
9) Link wrapper logs click; no tracking for security/legal; UTM only on
allowed templates; DNT honored.

**Admin**\
10) Templ

### TD-0056 (tech)

<!-- id: TD-0056 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 201600-205600 -->


6) Pagination, grouping, unread counts, pinning; accessibility
roles/labels.

**Experiments**\
7) Stable bucketing; hold‑out analyses; guardrail auto‑rollback
triggers.

**Localization**\
8) Locale fallback path; pluralization; timezone formatting.

**Tracking & privacy**\
9) Link wrapper logs click; no tracking for security/legal; UTM only on
allowed templates; DNT honored.

**Admin**\
10) Template versioning diff + dual approval; test sends whitelisted
only; suppression viewer actions audited.

**Performance & cost**\
11) Event→send SLOs met under synthetic load; SMS cost gates observed;
SES cost within envelope.

## **1.10.Z Acceptance criteria --- mark §1.10 FINAL only when ALL true**

1043. **Comms Router** applies preferences, quiet hours,
      dedupe/batching; channel workers deliver idempotently with
      retries.
1044. Domain authentication (SPF/DKIM/DMARC) configured;
      bounces/complaints generate suppressions; unsubscribe pathway
      honored.
1045. In‑app notification center functions with grouping, unread,
      pinning, and retention; p95 ≤ 120 ms.
1046. Experiments and localization pipelines operate with guardrails and
      correct fallbacks.
1047. Link tracking respects privacy rules; no tracking on sensitive
      templates; DNT honored.
1048. Admin console supports template lifecycle, test sends, suppression
      viewing, and campaign controls with immutable audits and dual
      approvals where required.
1049. Telemetry & SLOs green for 48h synthetic run; costs within budget
      alarms.

# **§1.11 --- Studios (Place Listings) & Amenities**

*(data model · onboarding & verification · pricing & deposits ·
availability & buffers · attach‑in‑flow · search facets · images &
safety · house rules & compliance docs · APIs · admin · telemetry ·
tests · cost)*

**Purpose.** Specify studios as **place listings** that buyers can book
directly or attach in‑flow to a talent booking. Studios are distinct
commercial legs with independent policies, taxes, deposits, reviews,
payouts, and verification---never mixed with person (Service Profile)
ratings or badges.

## **1.11.A Canon & invariants**

1050. **Studios are places**, not people. Ratings, verification, search
      facets, and policies are **separate** from Service Profiles (SPs).
1051. **Independent leg math**: a Studio leg has its own price, taxes,
      deposit policy, refunds, receipts, payout, and
      dispute/deposit-claim flows (see §1.3).
1052. **Attach‑in‑flow**: a Studio can be added during Talent checkout.
      Confirmation is **atomic** across legs (all‑or‑nothing).
1053. **Verification before boost**: only **verified studios** are
      eligible for "Verified Studio" badge and advertising (see §1.7).
1054. **Safe content**: public thumbnails are SFW; NSFW scanning rules
      apply to any images.
1055. **Cost‑conscious**: asset storage minimal (previews only),
      intelligent S3 tiering, lean search indices, and throttled scans.

## **1.11.B Data model (Aurora Postgres, source of record)**

*create table studio (*\
*studio_id text primary key, \-- std\_\...*\
*owner_user_id text not null, \-- usr\_\...*\
*title text not null,*\
*slug text not null unique, \-- /studio/{slug}*\
*description text not null,*\
*city text not null,*\
*region text not null, \-- state/province*\
*country text not null default \'US\',*\
*geo_lat numeric(9,6) not null,*\
*geo_lon numeric(9,6) not null,*\
*address_json jsonb not null, \--
{line1,line2,city,region,postal,country}; private UI*\
*is_published boolean not null default false,*\
*verified_studio boolean not null default false,*\
*verification_json jsonb not null default \'{}\'::jsonb, \-- docs
summary (no images)*\
*deposit_required boolean not null default false,*\
*deposit_auth_cents int not null default 0, \-- default auth amount (can
be 0)*\
*capacity_people int not null default 0,*\
*size_sqft int, \-- optional*\
*house_rules_json jsonb not null default \'\[\]\'::jsonb,*\
*amenities_json jsonb not nul

## Pre-Run Ritual (HARD)

- [ ] Read your last run report.
- [ ] Read any related run reports for the same WBS or feature.
- [ ] Summarise Plan vs Done vs Pending before writing new code.

## Locking & Access (HARD)

- Acquire your lock file at `ops/locks/AGENT-1.lock` before modifying files.
- Declare your scope_paths[] in your run report.
- If you detect overlapping scopes or foreign changes, STOP and hand back to the Orchestrator.

## Required Run Report Content (HARD)

- Context Snapshot (WBS IDs, blueprint IDs, assumptions).
- What Was Done vs Planned.
- How It Was Done (architecture/implementation narrative).
- Testing (commands, results, coverage, security scans) + 'Testing Proof' paragraph.
- Issues & Problems (with root causes where possible).
- Locations / Touch Map (files created/modified/removed, migrations, databases touched).
- Suggestions for Next Agents.
- Progress & Checklist.

## Orchestrator Attach Pack (HARD)

- Place under `docs/orchestrator/from-agents/AGENT-1/run-<timestamp>-attach.zip`.
- Include: run report, diff summary, CI/test artifacts, performance/security results,
  and a manifest.json (agent, run_id, wbs_ids, blueprint_ids, status).

## Testing (HARD)

- Define a test plan before coding.
- Implement unit/integration/E2E tests where appropriate.
- Record all test commands and results in the run report.
- If you cannot implement or run tests, mark the task partial and propose follow-up WBS items.

## Implementation Notes

(Use this space during your run.)

## Issues & Risks

(Document any issues, risks, or TODOs you discover.)

## Suggestions for Next Agents

(Document any guidance for follow-up work.)
