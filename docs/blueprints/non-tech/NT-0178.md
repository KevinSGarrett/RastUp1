<!-- id: NT-0178 | source: ProjectPlans\Combined_Master_PLAIN_Non_Tech_001.docx | range: 640800-644800 -->

-without double counting, breaking joins, or violating
privacy/retention policies.

A\) When to Replay vs Backfill (choose the right tool)

B\) Event Replay Policy (Bronzefirst, idempotent)

What it does\
Replays original events through the current pipeline so new
parsing/enrichment applies.

How

Replay Tool accepts event_name, date range, optional ids
(booking_leg_id, lbg_id, user_id).

Finds events in archived Bronze (≤90day hot, longer in cold storage) →
republishes to Event Bus with headers: replayed_at=\<ts\>; payload is
unchanged.

Idempotency:

If the original event_id is available, reuse it → Bronze sink stores a
shadow row with replay=true (kept for audit), Silver/Gold upserts
deterministically by natural keys (e.g., event_id or leg/line keys).

If original event_id was missing/invalid, the replay assigns a stable
synthetic key derived from the original record hash.

Guardrails

Scope preview shows row counts and blast radius (downstream tables via
lineage).

Dryrun computes deltas (counts, money sums) without writing.

Privacy tiers respected---no new PII appears.

Freeze windows: during finance close, heavy replays are queued.

C\) Backfill Manager (Admin UI/CLI workflow)

1\) Define the job

Type: Silver fix / Gold finance reclose / SCD2 rebuild / Promotions
recompute / Tax refresh.

Scope: date range, city(ies), role(s), entity filters (ids).

Mode: dryrun → plan; then execute.

2\) Plan output

Tables to recompute, row estimates, money impact (pre vs post),
dependencies (lineage graph).

Runtime and cost estimates; throttling plan.

3\) Execute

Chunked by day×city; idempotent merges with checkpointing; failure
autoresume.

Writes job_id to every affected row (adjustment_job_id) for audit.

4\) Review & finalize

Diff report: row deltas, GMV/Revenue/Tax variances, counts by status.

Signoff gates (Finance for money, Privacy for sensitive scopes).

Publish change notes to Data Catalog & Metric Catalog.

D\) Scoping Impact: lineagebased blast radius

Use table lineage (from §5.4 I) to enumerate downstream objects that
will change (facts, materialized views, dashboards).

Compute metric deltas for catalog keys (from §5.6) in the selected
window: GMV, platform revenue, take rate, tax, CPB/ROAS if promotions
touched.

Flag locked periods (e.g., monthly revenue closed) and switch to
Adjustment Ledger (see G).

E\) Idempotency & Dedup (how we avoid double counts)

Bronze keeps both original and replay shadows; Silver upserts by natural
keys (e.g., event_id or (charge_id,line_no)).

Gold facts use stable keys (booking_leg_id, charge_id, payout_id,
promotion_campaign_id,dt) and overwrite the partition deterministically.

Rerunning the same job with the same scope does not change totals
(idempotent by key).

Compensating events are not required; we prefer deterministic recompute
over appendonly corrections in analytics.

F\) SCD2 Rebuilds & "AsOf" correctness

For dim_service_profile, dim_user, dim_policy, rebuild SCD2 from CDC
(silver.dim\_\*\_cdc) maintaining valid_from/valid_to.

Rebuild ensures no overlaps, exactly one current_flag=true.

Pointintime queries (e.g., price at booking time) are guaranteed by
joining on occurred_at BETWEEN valid_from AND valid_to.

Policy/version drift handled: facts carry policy_id used at the time;
rebuild does not swap historic policy ids.

G\) Gold Finance Reclose & Adjustment Ledger

When

Allocation bug, settlement corrections, tax provider fix, deposit
handling fix, ACH fee miscalc, etc.

How

Lock the target period (e.g., a cityday or full month).

Recompute fact_payment, fact_booking_leg, fact_payout, fact_tax,
fact_deposit for the scope.

If the period is preclose → overwrite facts (idempotent) and publish
diffs.

If postclose (books closed):

Do not overwrite; write to gold.fact_adjustment_ledger with:
adjustment_id, scope, reason_code, delta_cents by line type (gmv,
provider fee, buyer fee, processor fee, tax, payout).

The semantic layer uses facts + Σ adjustments for reporti