<!-- id: NT-0161 | source: ProjectPlans\Combined_Master_PLAIN_Non_Tech_001.docx | range: 579600-583600 -->

.

L\) Acceptance Criteria (mark §5.2 FINAL)

ID catalog (names, prefixes, examples) published and used consistently
by all services & events.

Entity graph documented with cardinalities; enforced via Silver/Gold FK
tests.

LBG semantics implemented: legs roll up, payments group at checkout,
receipts/doc links per leg + group.

Multirole separation: search/reviews/rep attached to service_profile_id;
rollup to user shown in UI.

Lifecycle states defined for key entities; state transitions emit §5.1
events.

Softdelete and legal hold patterns applied; no cascaded hard deletes.

Validation rules in pipeline block malformed joins; data quality tests
green.

Warehouse hints (partitioning/clustering) documented and followed in
§5.5 schemas.

M\) Why this works

Keeps multirole users sane (clean, rolespecific search and reviews)
while preserving a single account.

Group bookings (LBG) capture realworld flows (talent + studio) without
muddying payments or disputes.

Opaque, wellscoped IDs plus soft deletion and legal holds make audits
and merges safe.

Analysts, Finance, T&S, and Ops all get consistent joins---no double
counts, no missing links.

§5.3 --- Ingest & Pipelines (Stream/Batch)

Goal: Move events from clients/services to analyticsready tables with
\<15minute freshness for ops and dayaccurate finance---safely, cheaply,
and replayably. Enforce contracts from §5.1, IDs from §5.2, privacy
gates, and exactlyonce semantics at sinks.

A\) Architecture at a Glance

Producers (web/mobile/services/admin) → Edge Collector (HTTP/gRPC) →
Event Bus (ordered, durable) →\
Bronze landing (appendonly, validated, partitioned) → Silver streaming
transforms (typed, PIImasked, enriched + CDC) →\
Gold batch close (daily finance/tax facts; reconciled) → BI/ML/alerts.

Control planes: Schema Registry (contracts), Feature Flags (rates,
sampling), DLQ/Quarantine UI, Replay tool, Data Quality monitors.

B\) Edge Collection (client/sdk rules)

Envelope required (per §5.1). SDKs batch events, gzip, and send over
TLS; retriable with exponential backoff.

Size limits: payload ≤ 64 KB; batch ≤ 512 KB; queue cap per device to
avoid memory blowups.

Clock skew: include device time; collector normalizes to UTC and adds
received_at.

PII filter at edge: reject events that contain forbidden fields (email,
phone, TIN, full address, PAN), return 4xx to SDK with reason; do not
store.

Sampling: off by default; can enable for highvolume impression events
later (never for money/safety).

Auth: producer token (rotated); admin events require mTLS and role
claim.

Idempotency: SDK must reuse the same event_id on retry; collector dedups
per event_id for a short window.

C\) Event Bus (topics, keys, ordering)

Topics by domain (mirror namespaces): search, msg, booking, deliver,
fin, promo, tax, studio, sup, ts, cms, obs, bulk, legal.

Partition key defaults:

booking, deliver, fin: booking_leg_id (preserves perleg order).

lbgscoped payments/tax: lbg_id.

msg: message_thread_id.

profile/search/promo: service_profile_id.

Fallback to actor_user_id if others null.

Ordering guarantees: within a key/partition. Processors must handle late
arrivals; don't assume global order.

D\) Bronze Landing (appendonly, validated)

Store immutable events as columnar files (e.g., Parquet) partitioned by
dt = occurred_at::date and event_name.

Schema validation: every record validated against Schema Registry; add
validation_status (ok\|warn\|fail).

Dedup: unique on event_id; keep the first arrival (subsequent duplicates
to bronze.dedup_skipped).

Privacy tagging: persist privacy_tier; events with forbidden PII never
land (blocked at edge).

DLQs / Quarantine families:

schema_violation (unknown name/version, wrong types),

oversize (exceeds limits),

unknown_actor (missing/invalid ID),

contract_break (required field missing),

poison_pill (processor crash repro sample).

Lineage stamps: ingest_id, collector_id, bus_offset.

E\) Silver Transforms (streaming; \<15min SLA)

Engines: stream