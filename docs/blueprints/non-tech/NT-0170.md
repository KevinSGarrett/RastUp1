<!-- id: NT-0170 | source: ProjectPlans\Combined_Master_PLAIN_Non_Tech_001.docx | range: 612000-616000 -->

id, dt, COUNT(\*) AS accepts

FROM gold.fact_booking_leg WHERE status = \'accepted\' GROUP BY 1,2

denominator_sql: \|

SELECT provider_user_id, dt, COUNT(\*) AS decisions

FROM gold.fact_booking_leg WHERE status IN (\'accepted\',\'declined\')
GROUP BY 1,2

expression: \"(Σaccepts / NULLIF(Σdecisions,0)) \* 100\"

allowed_dimensions: \[dt, city_id, service_role, service_profile_id,
instant_book\]

\- key: safety_reports_per_1k@1.0.0

title: Safety Report Rate (per 1k)

owner: Trust & Safety

grain: city_day

base_table: gold.fact_ts_case

expression: \"(COUNT(\*) / NULLIF( (SELECT COUNT(\*) FROM
gold.fact_booking_leg WHERE status=\'completed\' AND
gold.fact_booking_leg.city_id = dim.city_id AND gold.fact_booking_leg.dt
= dim.dt), 0)) \* 1000\"

allowed_dimensions: \[dt, city_id, severity, type\]

Notes: The actual implementation can live in a metrics framework; YAML
shown for clarity.

E\) Semantic layer (views/API) --- how it protects us

Conformed dimensions: Expose a single dim_time (day/week/month),
dim_city, dim_role, dim_service_profile, dim_campaign so all metrics
"slice" the same way.

Guardrails:

LBG vs leg: The layer blocks queries that mix LBGgrain money (GMV) with
leggrain fields without a safe join path; it proposes an allowed rollup
(e.g., aggregate legs first).

Attribution filters: Promotions metrics require promotion_campaign_id or
type; you can't ask for ROAS without a campaign context.

Privacy: Queries that try to expose PII columns from vault are denied;
only masked views are available (gold_restricted).

Ratios: When you add dimensions, the semantic layer recomputes ratios
properly (numerator/denominator recomputed at the new grain).

APIs:

/metrics/query accepts: metric keys, time grain, allowed
dimensions/filters, and returns typed series with definition_hash and
catalog_version.

/metrics/inspect returns the SQL and upstream lineage for any metric
key@version.

F\) Tests & data quality (per metric)

Definition tests: Nonnegative money, denominators not zero,
reconciliation to settlements for finance metrics.

Drift tests: Compare latest week vs prior week distribution; alert on
large swings (beyond set thresholds).

Freshness: Every metric key declares its expected freshness (ops ≤15
min; finance daily 06:00). Dashboards show a freshness badge.

G\) Versioning & change management

Semver per metric: gmv_cents@1.0.0 → add fields or improve logic →
1.1.0. Breaking definition changes → new key (e.g.,
gmv_cents_excl_travel@1.0.0).

Deprecation: Dashboards show "this tile uses v1.0.0; v1.1.0 available."
Migration windows and change notes documented.

Owner required: Each metric has an owner team; CI blocks unowned metrics
or edits without owner approval.

H\) Allowed dimensions (starter set)

Time: dt, week, month

Geo: city_id, state, tier

Role: service_role, leg_role

Identity (masked): service_profile_id, user_id (provider/buyer) --- only
in restricted views

Channels: platform (web/ios/android), promotion_campaign_id, type
(boost/featured)

Policy: policy_band_on_cancel, instant_book

Trust: rep_decile, id_verified, trusted_pro

The catalog rejects adhoc dimensions that break grain or privacy.

I\) Example SQL (reference)

GMV (day × city × role)

SELECT

l.dt,

l.primary_city_id AS city_id,

CASE

WHEN l.has_talent_leg THEN \'talent\'

WHEN l.has_studio_leg THEN \'studio\'

ELSE \'mixed\'

END AS role_group,

SUM(l.subtotal_cents + l.addons_total_cents + l.travel_total_cents +
l.license_total_cents) AS gmv_cents

FROM gold.fact_lbg l

GROUP BY 1,2,3;

Take Rate (booking revenue / GMV)

WITH booking_rev AS (

SELECT dt, city_id, SUM(provider_fee_cents + buyer_fee_cents_alloc) AS
rev_cents

FROM gold.fact_booking_leg

GROUP BY 1,2

),

gmv AS (

SELECT dt, primary_city_id AS city_id,

SUM(subtotal_cents + addons_total_cents + travel_total_cents +
license_total_cents) AS gmv_cents

FROM gold.fact_lbg

GROUP BY 1,2

)

SELECT g.dt, g.city_id, (br.rev_cents / NULLIF(g.gmv_cents,0)) \* 100 AS
take_rate_pc