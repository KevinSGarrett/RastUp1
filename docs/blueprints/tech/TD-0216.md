<!-- id: TD-0216 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 777600-781600 -->

ey,*\
*order_id text not null references pay.order_payment(order_id) on delete
cascade,*\
*jurisdiction text not null, \-- e.g., \'US-TX-Harris\'*\
*tax_type text not null, \-- \'sales\', \'occupancy\', \'local\'*\
*rate_bp int not null, \-- basis points (e.g., 825 = 8.25%)*\
*taxable_cents int not null,*\
*tax_cents int not null*\
*);*\
\
*\-- Track marketplace facilitator status at time of charge (immutable
snapshot)*\
*alter table pay.order_payment add column tax_facilitator boolean not
null default false;*\
\
*commit;*\

### **B.2 Calculation strategy**

- **MVP**: *tax_cents = 0* unless **facilitator=true** for the
  city/state and the booked item is taxable → then compute from matrix.
- **Phase‑2**: plug **Stripe Tax** or Avalara via an adapter producing
  *pay.tax_line\[\]*; persist snapshot on order.

### **B.3 Acceptance**

- Orders in a **tax‑on** city produce at least one *tax_line*; totals
  equal *Σ tax_line.tax_cents*.

## **1.13.C Reserves & early payout (risk‑aware)**

Keep dispute liability manageable by delaying part of a provider's
payout.

### **C.1 Data model (add‑on DDL)**

*begin;*\
\
*create table pay.reserve (*\
*reserve_id text primary key, \-- rsv\_\...*\
*order_id text not null references pay.order_payment(order_id) on delete
cascade,*\
*provider_user_id text not null,*\
*percent_bp int not null, \-- e.g., 1000 = 10%*\
*hold_days int not null default 7,*\
*amount_cents int not null,*\
*release_on timestamptz not null,*\
*released boolean not null default false,*\
*created_at timestamptz default now()*\
*);*\
\
*commit;*\

### **C.2 Behavior**

- On capture: schedule **transfer (net − reserve)**; post a **reserve**
  journal (*platform→reserve*).
- On release: journal *reserve→provider*; create transfer for the
  released amount.
- Enable **Early Payout** for high‑rep providers (flag + threshold) →
  *percent_bp* drops to 0.

### **C.3 Tests**

- Reserve enforced; release at *release_on*; disputes freeze release.

## **1.13.D Dispute evidence pack --- structure & generation**

### **D.1 Evidence bundle (S3)**

*s3://evidence/{order_id}/chargeback/{dispute_id}/*\
*/summary.md \# narrative & policy mapping*\
*/contract.pdf \# signed SOW/terms*\
*/timeline.csv \# key events (booking, messages, proofs, approvals,
check-in/out)*\
*/media/ \# proof thumbnails, deliverable hashes*\
*/policy_snapshot.json \# refund/cancel policy at time*\
*/receipts/\* \# payment/payout receipts*\

### **D.2 Generation**

- Lambda builds **summary.md** from templates + order facts.
- Upload to Stripe with dispute metadata; update
  *pay.dispute.evidence_s3*.

### **D.3 Acceptance**

- For *charge.dispute.created*, bundle is generated within **15
  minutes**, and submissions log confirmation.

## **1.13.E Coupons, credits & subsidies**

### **E.1 Data model (add‑on DDL)**

*begin;*\
\
*create table pay.coupon (*\
*coupon_id text primary key, \-- cpn\_\...*\
*code text unique not null,*\
*kind text not null check (kind in (\'percent\',\'fixed\')),*\
*value int not null, \-- % or cents*\
*starts_at timestamptz,*\
*ends_at timestamptz,*\
*max_redemptions int,*\
*active boolean not null default true*\
*);*\
\
*create table pay.coupon_redemption (*\
*coupon_id text not null references pay.coupon(coupon_id) on delete
cascade,*\
*order_id text not null references pay.order_payment(order_id) on delete
cascade,*\
*amount_cents int not null,*\
*created_at timestamptz default now(),*\
*primary key (coupon_id, order_id)*\
*);*\
\
*commit;*\

### **E.2 Ledger**

- Apply as **negative platform fee**: journal *platform→buyer* for the
  discount amount.

## **1.13.F Feature flags & city gates (operational control)**

- Flags: *ff.pay.ach*, *ff.pay.deposit*, *ff.pay.reserve*,
  *ff.pay.instant_payouts*, *ff.tax.engine*, *ff.pay.lbg*.
- **City allow‑lists** enable staged rollout and quick rollback.

## **1.13.G Warehouse exports (finance facts)**

- Daily export of **payments**, **refunds**, **transfers**, **payouts**,
  **ledger** to analytic