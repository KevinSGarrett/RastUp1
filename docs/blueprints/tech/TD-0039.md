<!-- id: TD-0039 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 140400-144400 -->

_mask\')),*\
*reason_code text not null, \--
\'hate_speech\',\'doxxing\',\'fraud_ring\',\'by_request\', etc.*\
*actor_user_id text not null, \-- admin*\
*details_json jsonb not null default \'{}\'::jsonb,*\
*created_at timestamptz not null default now()*\
*);*\
\
*\-- Reports (user flags)*\
*create table review_report (*\
*report_id text primary key, \-- rr\_\...*\
*review_id text not null references review(review_id) on delete
cascade,*\
*reporter_user_id text not null,*\
*reason_code text not null,*\
*details text,*\
*created_at timestamptz not null default now()*\
*);*\

**Indexes**

- *review(target_type, target_id, status)* for listing.
- *review(author_user_id, created_at)* to detect bursts.
- *reputation_aggregate(target_type, rating_recent_avg desc)* for search
  surfacing.

## **1.8.C Write rules & lifecycle**

740. **Eligibility check** on *createReview*:

     j.  *leg.status ∈ {completed}* and *leg.buyer_user_id =
         author_user_id*.
     k.  No prior review by the same author for this *leg_id*.

741. **Edit window**: author may update title/body/facets within 24 h
     (config), but not the **rating** (to prevent score gaming).

742. **Photos**: preview-size only; NSFW scan; Safe-Mode on public
     surfaces.

743. **Status transitions**: *published → hidden/removed* (moderation),
     *removed → restored* (appeal).

744. **Deletion**: no hard delete---use *removed* + audit.

## **1.8.D API (GraphQL) --- user-facing**

*type Review {*\
*reviewId: ID!*\
*targetType: String!*\
*targetId: ID!*\
*rating: Int!*\
*title: String*\
*body: String*\
*facets: AWSJSON*\
*photos: \[Attachment!\]!*\
*status: String!*\
*createdAt: AWSDateTime!*\
*}*\
\
*type Reputation {*\
*ratingAvg: Float!*\
*ratingCount: Int!*\
*ratingRecentAvg: Float!*\
*facetAvgs: AWSJSON*\
*lastReviewAt: AWSDateTime*\
*}*\
\
*input CreateReviewInput {*\
*legId: ID!*\
*targetType: String! \# \'service_profile\' or \'studio\'*\
*targetId: ID!*\
*rating: Int!*\
*title: String*\
*body: String*\
*facets: AWSJSON*\
*photos: \[AttachmentInput!\]*\
*}*\
\
*type Query {*\
*reviews(targetType: String!, targetId: ID!, cursor: String, limit: Int
= 10): ReviewPage!*\
*reputation(targetType: String!, targetId: ID!): Reputation!*\
*myEligibleToReview: \[LegRef!\]! \# legs completed but not yet
reviewed*\
*}*\
\
*type Mutation {*\
*createReview(input: CreateReviewInput!): Review!*\
*editReview(reviewId: ID!, title: String, body: String, facets:
AWSJSON): Review! \# within window*\
*reportReview(reviewId: ID!, reason: String!, details: String):
Boolean!*\
*}*\

**Server guards**

- Verify target matches the leg's counterparty (SP for talent leg;
  Studio for studio leg).
- Deny self-review (*author_user_id == seller_user_id*), deny
  cross-scope attempts.
- Rate-limit review write attempts per user.

## **1.8.E Weighting, decay & aggregation**

**Base average:** simple mean over *published* reviews only.\
**Recent-weighted average:** apply exponential decay with half-life *H*
(e.g., 180 days) to emphasize recent performance:\
*weighted_score = Σ (rating \* e\^{-Δt/H}) / Σ e\^{-Δt/H}*.

**Minimum sample guard:**

- If *rating_count \< K* (e.g., 5), show **"New --- limited reviews"**;
  still display stars but deemphasize in ranking.
- For search ranking, combine *rating_recent_avg* with count via a
  Wilson interval or Laplace smoothing.

**Facet aggregation:**

- Per facet mean and count; show as radar or bar chips; used in filters
  later.

**Fraud signal:**

- Score 0--1 from heuristics (see 1.8.F). If \> threshold, suppress the
  review from aggregates pending T&S review.

**Update cadence:**

- On every write/mod decision, recompute aggregates; also nightly full
  recompute for consistency.

## **1.8.F Fraud & abuse controls**

**Heuristics (near-real-time):**

- **Self-review**: author matches seller or same household (IP/device
  cluster) → block.
- **Ring behavior**: small set of accounts reviewing each other
  frequently across short intervals.
- **Burst anom