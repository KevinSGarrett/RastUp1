<!-- id: TD-0275 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 990000-994000 -->

a.csv*: takedown requests initiated by the user; outcomes &
  timestamps.

## **1.28.3 Data model (Aurora) --- paste‑ready DDL**

Create *db/migrations/035_exports.sql*:

*begin;*\
\
*create schema if not exists exports;*\
\
*create type exports.status as enum
(\'REQUESTED\',\'VERIFIED\',\'PROCESSING\',\'READY\',\'EXPIRED\',\'FAILED\',\'CANCELLED\');*\
\
*create table exports.request (*\
*export_id text primary key, \-- exp\_\...*\
*user_id text not null,*\
*kind text not null check (kind in
(\'PORTABILITY\',\'DSAR\',\'ADMIN_FOR_USER\')),*\
*status exports.status not null default \'REQUESTED\',*\
*requested_at timestamptz default now(),*\
*verified_at timestamptz,*\
*started_at timestamptz,*\
*ready_at timestamptz,*\
*expires_at timestamptz,*\
*failure_reason text,*\
*est_size_bytes bigint, \-- for UI progress estimate*\
*parts int default 1, \-- multi-part zips if large*\
*manifest_s3_key text, \-- s3://\.../manifest.json*\
*bundle_s3_key text \-- s3://\.../bundle.zip (or prefix if multi-part)*\
*);*\
*create index on exports.request (user_id, status, requested_at);*\
\
*\-- Optional queue for large table scans (or use EventBridge
directly)*\
*create table exports.job (*\
*job_id bigserial primary key,*\
*export_id text not null references exports.request(export_id) on delete
cascade,*\
*phase text not null, \-- e.g., \"orders\",\"messages\",\"media\"*\
*status text not null default \'PENDING\',*\
*started_at timestamptz,*\
*finished_at timestamptz,*\
*error_text text*\
*);*\
\
*commit;*\

## **1.28.4 GraphQL (AppSync) --- paste‑ready schema**

Create *api/schema/exports.graphql*:

*scalar AWSDateTime*\
*scalar AWSURL*\
\
*enum ExportKind { PORTABILITY DSAR }*\
*enum ExportStatus { REQUESTED VERIFIED PROCESSING READY EXPIRED FAILED
CANCELLED }*\
\
*type ExportRequest {*\
*id: ID!, kind: ExportKind!, status: ExportStatus!,*\
*requestedAt: AWSDateTime!, verifiedAt: AWSDateTime, readyAt:
AWSDateTime, expiresAt: AWSDateTime,*\
*estSizeBytes: Int, parts: Int*\
*}*\
\
*type Query {*\
*myExports: \[ExportRequest!\]!*\
*getExport(id: ID!): ExportRequest*\
*getExportDownloadUrl(id: ID!, part: Int = 1): AWSURL! \# returns
short-lived app-gated URL (not raw S3)*\
*}*\
\
*type Mutation {*\
*requestExport(kind: ExportKind!): ID!*\
*verifyExport(id: ID!): Boolean! \# requires re-auth + MFA; sets
status=VERIFIED*\
*cancelExport(id: ID!): Boolean!*\
*}*\

**Access model**

- *getExportDownloadUrl* returns a **server‑gated URL** (our endpoint)
  that **requires a live user session**; the server then streams from S3
  using service credentials. We **do not** expose raw long‑TTL
  pre‑signed S3 links.

## **1.28.5 Pipeline & packaging (serverless, low cost)**

**Flow**

4731. **User** clicks *Request export* → *exports.request* row created
      (*REQUESTED*).
4732. **Verify** (re‑auth + MFA) → *status=VERIFIED*; enqueue
      EventBridge events for phases.
4733. **Lambdas** per phase stream data directly into **S3** (JSON/CSV
      files) under *s3://exports/{export_id}/data/\...*.
4734. **Manifest builder** writes *manifest.json* (file list + sizes +
      SHA‑256) and a human‑readable **index.html**.
4735. **Receipt generator** renders PDF receipts (see 1.28.8) and a
      **summary.pdf** ("Your data on RastUp").
4736. **Bundler** zips the directory (or multiple parts for \>2GB) →
      writes *bundle.zip* + updates DB (*READY*, *expires_at =
      ready_at + 7d*).
4737. User downloads via *getExportDownloadUrl* (single‑use tokens, 24h
      TTL).
4738. **Lifecycle**: S3 bucket policy auto‑deletes bundles after 7 days
      (*EXPIRED*).

**Scaling**

- Each phase Lambda paginates (e.g., 5k rows/chunk) to keep memory
  small.
- Messages phase streams JSONL per thread to avoid huge single files.
- Very large exports split into *bundle.part1.zip*,
  *bundle.part2.zip*... with **parity manifest** in each part.

**Integrity**

- UI displays manifest checksums; optional user‑side verifier CLI
  snippet provided.

## **1.28.6 Redaction & content ru