<!-- id: TD-0008 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 28800-32800 -->

',\'awaiting_docs\',\'awaiting_payment\',\'confirmed\',\'in_progress\',\'completed\',\'cancelled\',\'failed\')),
city text not null, start_at timestamptz not null, \-- group reference
window end_at timestamptz not null, acceptance_until timestamptz, \--
buyer acceptance window end currency text not null default \'USD\',
created_at timestamptz not null default now(), updated_at timestamptz
not null default now(), version bigint not null default 0); \-- Booking
legs (one per seller/role or per studio)create type leg_type as enum
(\'talent\',\'studio\'); create table booking_leg ( leg_id text primary
key, \-- leg\_\... lbg_id text references lbg(lbg_id) on delete cascade,
type leg_type not null, seller_user_id text not null, \-- usr\_\... (for
studio, owner_user_id) service_profile_id text, \-- talent leg
(srv\_\*), null for studio leg studio_id text, \-- studio leg (std\_\*),
null for talent leg title text not null, \-- shown on receipt start_at
timestamptz not null, end_at timestamptz not null, \-- pricing snapshot
(immutable after confirm; use amendments for changes) subtotal_cents int
not null, tax_cents int not null default 0, fees_cents int not null
default 0, \-- platform/service fees for this leg total_cents int not
null, \-- subtotal + tax + fees currency text not null default \'USD\',
policy_json jsonb not null default \'{}\'::jsonb, \-- cancel windows,
change windows doc_pack_id text, \-- e-sign envelope id status text not
null check (status in
(\'draft\',\'awaiting_docs\',\'awaiting_payment\',\'confirmed\',\'in_progress\',\'completed\',\'cancelled\',\'failed\')),
created_at timestamptz not null default now(), updated_at timestamptz
not null default now(), version bigint not null default 0); \-- Charges
(one LBG-level charge holds buyer funds; legs reference splits)create
table charge ( charge_id text primary key, \-- chg\_\... lbg_id text not
null references lbg(lbg_id) on delete cascade, processor text not null,
\-- \'stripe\' processor_intent text not null, \-- pi\_\...
(PaymentIntent) status text not null check (status in
(\'requires_action\',\'authorized\',\'captured\',\'succeeded\',\'canceled\',\'failed\')),
amount_cents int not null, currency text not null default \'USD\',
payment_method text, \-- \'card\',\'ach_debit\' created_at timestamptz
not null default now(), updated_at timestamptz not null default now(),
unique (processor, processor_intent)); \-- Charge allocations per
legcreate table charge_split ( charge_id text references
charge(charge_id) on delete cascade, leg_id text references
booking_leg(leg_id) on delete cascade, amount_cents int not null,
primary key (charge_id, leg_id)); \-- Studio deposits (separate
auth/hold via SetupIntent)create table deposit_auth ( deposit_id text
primary key, \-- dep\_\... leg_id text not null references
booking_leg(leg_id) on delete cascade, \-- studio leg only processor
text not null, \-- \'stripe\' processor_setup text not null, \--
seti\_\... status text not null check (status in
(\'requires_action\',\'authorized\',\'captured\',\'voided\',\'expired\')),
authorized_cents int not null, captured_cents int not null default 0,
currency text not null default \'USD\', created_at timestamptz not null
default now(), updated_at timestamptz not null default now(), unique
(processor, processor_setup)); \-- Amendments (change orders,
extras/overtime); each produces delta lines and tax recalcscreate table
amendment ( amendment_id text primary key, \-- amd\_\... leg_id text not
null references booking_leg(leg_id) on delete cascade, kind text not
null check (kind in
(\'change_order\',\'overtime\',\'refund_line\',\'admin_adjustment\')),
delta_subtotal_cents int not null, delta_tax_cents int not null,
delta_fees_cents int not null, delta_total_cents int not null, note
text, created_by text not null, \-- usr\_\... (buyer, seller, admin)
created_at timestamptz not null default now()); \-- Payouts per leg
(Connect transfers)create table payout ( payout_id text primary key, \--
pay\_\... 