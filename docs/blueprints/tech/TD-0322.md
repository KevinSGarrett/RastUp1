<!-- id: TD-0322 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1159200-1163200 -->

s*** *(PK: entity#\<type\>#\<id\>)*\
  Fields: *score*, *strikes {spam:int, nsfw:int, chargeback:int, ...}*,
  *status (ok\|shadow\|mute\|suspend)*, *notes*, *updated_at*.
- ***abuse_actions*** *(PK: action#\<id\>)*\
  Fields: *entity_ref*, *action (warn\|shadow\|mute\|suspend\|restore)*,
  *reason*, *actor (system\|staff)*, *expires_at*, *created_at*.

**Aurora (for joins/analytics):** mirrored via nightly ETL into
***gold.abuse\_\**** in Athena for reporting.

## **U.3 Rules Engine (abuse automation)**

**Rule DSL (YAML) ---** ***safety/rules.yaml*****:**

*version: 1*\
*rules:*\
* - id: MSG-SPAM-001*\
*when:*\
*all:*\
* - event_type: \"message.sent\"*\
* - window: { size: \"10m\", group_by: \[\"dyad_id\"\], count_gt: 40 }*\
*then:*\
*action: \"shadow\"*\
*duration: \"2h\"*\
*reason: \"Per-dyad QPS exceeded\"*\
* - id: MSG-SOLICIT-KEYWORD-001*\
*when:*\
*all:*\
* - event_type: \"message.sent\"*\
* - text_contains_any: \[\"@\", \"dot com\", \"telegram\", \"whatsapp\",
\"cashapp\"\]*\
* - actor_age_lt_days: 3*\
*then:*\
*action: \"mute\"*\
*duration: \"24h\"*\
*reason: \"Contact bypass keywords\"*\
* - id: MEDIA-NSFW-001*\
*when:*\
*all:*\
* - event_type: \"media.moderated\"*\
* - field: \"nsfw_score\"* \
*op: \"gte\"*\
*value: 0.8*\
* - actor_age_lt_days: 7*\
*then:*\
*action: \"suspend\"*\
*duration: \"72h\"*\
*reason: \"High NSFW on new account\"*\
* - id: SEARCH-SPAM-001*\
*when:*\
*all:*\
* - event_type: \"search.query\"*\
* - window: { size: \"1m\", group_by: \[\"ip\"\], count_gt: 120 }*\
*then:*\
*action: \"ip_temp_block\"*\
*duration: \"10m\"*\
*reason: \"Search spam\"*\
* - id: PAY-CB-COHORT-001*\
*when:*\
*all:*\
* - event_type: \"chargeback.opened\"*\
* - cohort_rate_gt: { window_days: 30, threshold: 0.02, group:
\"referrer_code\" }*\
*then:*\
*action: \"disable_referrals\"*\
*reason: \"Chargeback cohort risk\"*\

**Evaluator Lambda ---** ***services/safety/evaluator.ts***
**(pseudocode):**

*export async function handler(evt: EventBridgeEnvelope\[\]) {*\
*for (const e of evt) {*\
*await recordAbuseEvent(e); // write to abuse_events*\
*const context = await loadEntityContext(e); // user age, past strikes,
cohort*\
*const matches = matchRules(e, context, rulesYaml);*\
*for (const m of matches) {*\
*const act = decideAction(m, context); // ladder aware*\
*await applyAction(act); // write abuse_actions, flip flags in user
profile*\
*await notifySystems(act); // invalidate caches, reduce rank weight,
etc.*\
*}*\
*}*\
*}*\

**Strike ladder (ladder‑aware actions):**

- **Warn → Shadow → Mute → Suspend** (escalation decays over time;
  ladders are **type‑specific**).
- Decay windows: warn 24h, shadow 72h, mute 7d, suspend 14d.

## **U.4 WAF & Rate‑Limit Examples**

**CloudFront WAF (JSON excerpt) ---** ***ops/waf/rules.json*****:**

*{*\
*\"Name\": \"rastup-waf\",*\
*\"Scope\": \"CLOUDFRONT\",*\
*\"DefaultAction\": { \"Allow\": {} },*\
*\"Rules\": \[*\
*{*\
*\"Name\": \"RateLimitSearch\",*\
*\"Priority\": 10,*\
*\"Statement\": { \"RateBasedStatement\": {*\
*\"Limit\": 3000,*\
*\"AggregateKeyType\": \"IP\",*\
*\"ScopeDownStatement\": {*\
*\"ByteMatchStatement\": {*\
*\"FieldToMatch\": {\"UriPath\": {}},*\
*\"PositionalConstraint\": \"STARTS_WITH\",*\
*\"SearchString\": \"/api/search\",*\
*\"TextTransformations\": \[{\"Type\":\"NONE\", \"Priority\":0}\]*\
*}*\
*}*\
*}},*\
*\"Action\": { \"Block\": {} },*\
*\"VisibilityConfig\": {\"SampledRequestsEnabled\": true,
\"CloudWatchMetricsEnabled\": true, \"MetricName\":
\"RateLimitSearch\"}*\
*},*\
*{*\
*\"Name\": \"BotControlManaged\",*\
*\"Priority\": 20,*\
*\"Statement\": { \"ManagedRuleGroupStatement\": {*\
*\"VendorName\": \"AWS\",*\
*\"Name\": \"AWSManagedRulesBotControlRuleSet\"*\
*}},*\
*\"OverrideAction\": { \"None\": {} },*\
*\"VisibilityConfig\": {\"SampledRequestsEnabled\": true,
\"CloudWatchMetricsEnabled\": true, \"MetricName\": \"BotControl\"}*\
*}*\
*\]*\
*}*\

**AppSync pre‑resolver guard (JS function) ---**
***api/functions/rateGuard.js*****:**

*export function r