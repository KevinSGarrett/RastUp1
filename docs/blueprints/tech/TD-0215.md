<!-- id: TD-0215 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 774000-778000 -->

cur at correct times relative to event.
3527. Refunds (auto per policy + admin override) function; ledger
      reflects captures/refunds/fees correctly; daily close passes
      integrity checks.
3528. Providers onboard to **Stripe Connect**; payouts schedule; failed
      payouts alert and surface actionable errors.
3529. Disputes integrate end‑to‑end: webhook intake, evidence bundle,
      outcome handling, ledger posting.
3530. All webhooks are idempotent & HMAC‑verified; no sensitive card or
      bank PII stored on our side.
3531. Observability dashboards live; alerts trigger on failures/spikes;
      costs within plan.

# **§1.13 --- Payments, Fees, Refunds, Disputes & Payouts (Stripe‑first; ACH optional)**

**Addenda & deepening details (closing all remaining gaps)**

Below are the **additional paste‑ready artifacts and specifications** to
ensure §1.13 reaches ≥99.9% completeness and mirrors every requirement
tied to money, taxes, and reconciliation in your non‑technical plan.

## **1.13.A Linked Booking Group (LBG) & multi‑leg allocations --- Phase‑2 upgrade path**

Your blueprint anticipates **LBG** (a single checkout containing
multiple legs, e.g., **talent + studio**). MVP can remain single‑leg,
but we wire the data model now so the later switch is configuration, not
surgery.

### **A.1 Data model (add‑on DDL)**

Append to *db/migrations/021_payments.sql* (or create
*022_payments_lbg.sql*):

*begin;*\
\
*\-- Parent \"group\" covering one or more legs (orders)*\
*create table pay.booking_group (*\
*group_id text primary key, \-- lbg\_\...*\
*buyer_user_id text not null,*\
*currency text not null default \'usd\',*\
*subtotal_cents int not null default 0,*\
*tax_cents int not null default 0,*\
*fee_cents int not null default 0,*\
*total_cents int not null default 0,*\
*created_at timestamptz default now()*\
*);*\
\
*\-- Each leg (child order) participates with an allocation of the group
payment*\
*create table pay.group_allocation (*\
*group_id text not null references pay.booking_group(group_id) on delete
cascade,*\
*order_id text not null references pay.order_payment(order_id) on delete
cascade,*\
*alloc_subtotal_cents int not null,*\
*alloc_tax_cents int not null default 0,*\
*alloc_fee_cents int not null default 0,*\
*alloc_total_cents int not null,*\
*primary key (group_id, order_id)*\
*);*\
\
*\-- Optional: per-leg transfer override (e.g., studio deposits)*\
*alter table pay.transfer add column group_id text references
pay.booking_group(group_id) on delete set null;*\
\
*commit;*\

**Ledger rule:** every group capture writes one **parent journal**
(buyer→platform), then **per‑leg journals** on transfer/reversal so
reports reconcile at both **group** and **leg** grain.

### **A.2 Allocation algorithm (deterministic)**

- Split **subtotal** across legs in proportion to their leg subtotals
  (pre‑tax/pre‑fee).
- Allocate **fee** and **tax** by the same weight; any rounding residue
  goes to the largest leg.
- **Refunds** reverse allocations first (leg‑scoped).

### **A.3 Tests (add to §1.13.14)**

- Group with **2 legs** (talent \$600, studio \$400) → 60/40 allocations
  on subtotal/fee/tax; refund studio leg only reverses 40% of the parent
  charge; ledger balances.

## **1.13.B Sales tax engine & jurisdiction matrix --- hooks & storage**

Your appendices carry a **jurisdiction matrix**. We keep MVP lean (many
services are non‑taxable), but wire the hooks.

### **B.1 Data model (add‑on DDL)**

*begin;*\
\
*\-- Optional per-order tax detail lines (jurisdiction-level)*\
*create table pay.tax_line (*\
*id bigserial primary key,*\
*order_id text not null references pay.order_payment(order_id) on delete
cascade,*\
*jurisdiction text not null, \-- e.g., \'US-TX-Harris\'*\
*tax_type text not null, \-- \'sales\', \'occupancy\', \'local\'*\
*rate_bp int not null, \-- basis points (e.g., 825 = 8.25%)*\
*taxable_cents int not null,*\
*tax_cents int not null*\
*);*\
\
*\-- Track marketplace facilitator status at time of charg