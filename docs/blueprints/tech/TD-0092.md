<!-- id: TD-0092 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 331200-335200 -->

r\',\'cross_side\')),*\
*reward_bips int not null default 0, \-- optional future %*\
*reward_fixed_cents int not null default 0, \-- e.g., \$1500 = \$15.00*\
*credit_scope text not null, \-- \'buyer_fee_only\' etc.*\
*monthly_cap int not null default 5, \-- per-user awards cap*\
*active boolean not null default true,*\
*created_at timestamptz not null default now()*\
*);*\
\
*create table referral_invite (*\
*invite_id text primary key, \-- rfi\_\...*\
*program_id text not null references referral_program(program_id),*\
*inviter_user_id text not null,*\
*invitee_user_id text, \-- populated after signup*\
*invitee_email_sha text not null, \-- hashed*\
*source text, \-- sharecard/linkinbio/...*\
*device_fp text, \-- device fingerprint*\
*ip_addr_sha text,*\
*created_at timestamptz not null default now(),*\
*accepted_at timestamptz*\
*);*\
\
*\-- Credit ledger entries (immutable)*\
*create table credit_ledger (*\
*entry_id text primary key, \-- crl\_\...*\
*user_id text not null,*\
*kind text not null check (kind in
(\'award\',\'clawback\',\'redeem\')),*\
*program_id text,*\
*amount_cents int not null,*\
*currency text not null default \'USD\',*\
*reason text not null,*\
*related_id text, \-- booking_id, invite_id*\
*created_at timestamptz not null default now()*\
*);*\

### **B.2 DynamoDB (hot path)**

- *saved_search_dedupe*: *(PK=search_id, SK=YYYY-MM-DD)* prevents \>1
  alert/day; TTL auto‑expires older rows.
- *feed_fanout_cursor*: per follower "last seen" cursor to build
  incremental feed pages.
- *referral_device_daily*: counters *(device_fp, date)* and *(ip_hash,
  date)* for rate‑limit and fraud signals.

### **B.3 Search indices (Typesense/OpenSearch)**

- **people_v1** and **studios_v1** already defined; extend with **facets
  for ANY/ALL** groups and **verified/trusted** flags used in alerts.

NonTechBlueprint

## **1.16.C Saved Searches & Alerts (ANY/ALL + 1/day cap)**

### **C.1 Query model**

- **ANY/ALL**: store filters as *{\"any\":\[\...\],\"all\":\[\...\]}*;
  search layer builds a boolean query to Typesense/OpenSearch.

NonTechBlueprint

- Safe‑Mode enforced in the query (e.g., hide nudity tiers beyond
  "Lingerie/Swim" when ON).

NonTechBlueprint

### **C.2 Daily job (EventBridge Scheduler → Lambda)**

1702. For each active *saved_search* not *paused_until \> today*,
      compute **new matches since** ***last_alert_dt***.

1703. If *match_count\>0* and no *saved_search_alert* exists for *today*
      (and no Dynamo dedupe row found), create:

      y.  an **in‑app digest** item,
      z.  an **email** (SES) with at most 20 cards + "View All" deep
          link,
      a.  update *last_alert_dt=today*, write *saved_search_alert*.

1704. **Frequency cap**: exactly **≤1/day/search**.

NonTechBlueprint

1705. **Pause 30 days** toggles *paused_until = today + 30*.

NonTechBlueprint

## **1.16.D Weekly City Digest (opt‑in)**

- Cron weekly per city; content blocks: **featured case studies**,
  **Verified Studios with open slots**, **Top rising creators** (Rep
  growth).

NonTechBlueprint

- Safe‑Mode rules for previews; **no 18+** content in email.

NonTechBlueprint

- Unsubscribe per‑digest type; quiet‑hours respected.

## **1.16.E Feed & Follow**

### **E.1 Surfaces (mirrors plan language)**

- **Single unified feed** per user with **role tabs**
  (Model/Photog/Vid/Creator/Fan‑Sub Creator).

NonTechBlueprint

- Pulls **new case studies**, **availability cards** ("Now booking
  Saturday"), **touring chips** (e.g., "Visiting Austin 11/20--11/22"),
  **Verified Studio open slots**, **Verified influence posts** (SFW
  preview + "Verified" tick).

NonTechBlueprint

- Safe‑Mode default ON for guests/new users; applies to People (18+
  gating) but **never hides Studios**.

NonTechBlueprint

### **E.2 Delivery & ranking**

- Build a **fan‑out‑on‑read** feed: query *feed_post* + follows; rank by
  recency, followed weight, verified chip, and engagement.
- Cursors (time + id) for pagination; **no unbounded fan‑out**.

##