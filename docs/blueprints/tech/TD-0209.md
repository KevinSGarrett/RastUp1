<!-- id: TD-0209 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 752400-756400 -->

erves original tz; recurrence instances stored in UTC
  with a *recurrence_id*.

## **1.12.9 ICS outbound (attachments & feeds)**

- **Attachments**: include *.ics* on booking confirmations and
  reschedules (provider & buyer); update on changes; cancel events send
  *.ics* cancellations.
- **Per‑user ICS feed**: tokenized URL displaying confirmed events (and
  optionally holds if *include_holds=true*); cache for 60 s; regenerate
  token on compromise.

## **1.12.10 Observability & KPIs**

- **Events**: *cal.rule.updated*, *cal.exception.upserted*,
  *cal.hold.created\|expired*, *cal.event.confirmed\|cancelled*,
  *cal.ics.poll.ok\|error*, *cal.feasible.cache.hit\|miss*.
- **KPIs**: IB success rate; time‑to‑reschedule (RTB); % holds expiring
  unused; ICS error rate; feasibility latency p95; calendar‑related
  tickets per 100 bookings.
- **Alerts**: poller error spikes; webhook renewal failures (Phase‑2);
  feasibility compute latency or error spikes; hold backlog \>
  threshold.

## **1.12.11 Cost posture & limits**

- Serverless functions; feasibility **cache** in Dynamo; compact indices
  and differential polling.
- Limits: max external sources/user (e.g., 3), max polls/hour/user, max
  slots/response; adaptive polling (more frequent for very active
  providers).
- **Back‑pressure**: if poll queue grows, widen polling interval
  automatically; degrade to conflict‑safe "IB off; RTB only" if external
  sync is severely stale.

## **1.12.12 Work packages (Cursor --- 4 agents)**

- **Agent A --- Data & API**: migrations, GraphQL resolvers, feasibility
  engine, holds & atomic conversion, ICS feed generator.
- **Agent B --- External Sync**: ICS poller (ETag), recurring expansion,
  back‑off; Phase‑2 OAuth/webhooks with Secrets Manager.
- **Agent C --- UI/UX**: Availability Editor, Exceptions UI, Calendar
  Connect, Bookable preview, Reschedule picker.
- **Agent D --- Ops/Observability**: EventBridge schedules,
  alarms/dashboards, cache warmers, cost throttles, integration tests.

## **1.12.13 Tests (representative)**

3416. **Feasibility happy path**: weekly rules + available override + no
      external busy → expected slots; IB checkout validates freshness;
      atomic hold→event.
3417. **Lead‑time/booking window**: slots earlier than lead time or
      beyond window excluded.
3418. **Exceptions**: "unavailable" removes slice; "available" adds
      slice on a normally closed day.
3419. **Holds**: overlapping checkout attempts → only first confirmation
      succeeds; others receive "slot taken."
3420. **ICS import**: recurring with EXDATE; ETag unmodified → no write;
      modified → delta insert/update; throttling on repeated errors.
3421. **Time zones**: DST spring‑forward trim and fall‑back duplication
      both correct; conversions match IANA database.
3422. **Reschedule**: candidate list excludes conflicts and respects
      original duration & lead time.
3423. **Performance/cost**: cache hit rate ≥ target; poll cadence adapts
      by activity; limits enforced.
3424. **Security**: ICS feed tokens unguessable; OAuth tokens (Phase‑2)
      never in DB; Secrets Manager access policy works.

## **1.12.14 Artifacts (paste‑ready)**

- *db/migrations/020_calendar.sql* --- DDL above.
- *api/schema/calendar.graphql* --- queries/mutations above.
- *services/calendar/feasibility.ts* --- rule→slot engine with tz/DST
  helpers.
- *services/calendar/ics-poller.ts* --- ETag‑aware ICS fetcher + parser.
- *web/components/AvailabilityEditor/\** --- editor UI.
- *web/components/CalendarConnect/\** --- connect/status UI.
- *web/components/ReschedulePicker/\** --- candidate picker.
- *observability/dashboards/calendar.md* --- KPIs & alert specs.
- *ops/runbooks/calendar-ics-errors.md* --- feed error handling &
  back‑off.

## **1.12.15 Acceptance criteria --- mark §1.12 FINAL only when ALL true**

3434. Providers can configure availability (weekly + exceptions), lead
      time, booking window, and min duration; preview bookable slots.
3