<!-- id: TD-0063 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 226800-230800 -->

ES identities, SNS/SQS for bounces, in‑app store).
- **AdminStack** (Amplify Admin UI access scopes, RBAC seeds).

## **1.12.E Networking & security baseline**

- **VPC** for Aurora + Typesense/OpenSearch; Lambdas in private subnets
  with NAT **only where needed** (watch NAT cost).
- **Security groups**: least privilege; no public RDS; AppSync → Lambda
  via VPC endpoints if required.
- **WAF** on CloudFront: bot rate limits, SQLi/XSS rules, country blocks
  (configurable).
- **TLS**: ACM certs for all domains; enforced HTTPS everywhere.
- **KMS**: CMKs for RDS, Dynamo, S3 buckets (customer-managed where
  necessary).
- **CORS & CSP**: locked to app domains + Stripe/e‑sign domains.
- **PII partitioning**: sensitive data in Aurora; no PII in search
  indexes or logs.

## **1.12.F Data stores & retention**

**Aurora (PostgreSQL Serverless v2)**

- **Schemas:** *core* (users, profiles, bookings), *finance*, *docs*,
  *promo*, *trust*, *studios*, *comms*.
- **Backups:** PITR enabled; snapshots retained 7--30 days in dev/stage,
  35--90 days in prod.
- **Migrations:** Sqitch/Prisma/Migrate (choose one; locked in CI).

**DynamoDB**

- Tables: *threads*, *presence*, *comms_tokens*, *comms_dedupe*,
  *promo_active_by_city*, *trust_cache*.
- **TTL**: presence/typing; dedupe caches; in‑app archivals after 90
  days.

**S3**

- Buckets: *public-assets*, *user-previews*, *docs-rendered*,
  *logs-raw*.
- **Lifecycle:** move to Intelligent‑Tiering after 30 days; cold/archive
  after 90/180 days where safe.
- **Block public access** by default; use CF OAI/ORI for public access.

**Search**

- **Typesense** single small node (or managed) at launch; replica
  optional.
- Adapter layer ready to switch to **OpenSearch Serverless** if scale
  demands; **OCU** cap alarms.

## **1.12.G Identity & access (Cognito)**

- **User Pool** with hosted UI (email, Apple/Google OAuth).
- **Groups/Roles:** *buyer*, *seller*, *studio_owner*, *admin*, *trust*,
  *support*, *finance*.
- **MFA** optional at signup; required for Admin roles.
- **Age‑gate** attribute on user (*\>18*) linked to IDV status (§1.6).
- **Identity Pool** for S3 direct uploads (scoped IAM policies per
  bucket/prefix).
- **Session length** tuned per role; refresh token rotation.

## **1.12.H API shape (AppSync)**

- **Schema‑first** in repo; codegen to TS types.

- **Auth modes**: Cognito JWT (primary) + API key (dev only) + IAM
  (admin tools).

- **Pipeline resolvers** enforce:

  - input validation & normalization
  - rate limits (token bucket per IP/user)
  - role/age gates (e.g., Fan‑sub)

- **Subscriptions** for messaging & notifications.

**Limits**: page sizes capped; cursors opaque; error taxonomy
standardized per prior sections.

## **1.12.I CI/CD and migrations**

- **CI (per PR):** typecheck, lint, unit tests, contract tests for
  GraphQL, build Next.js, synth CDK, **cost‑diff** (cdk‑nag + infracost
  if configured).

- **DB migrations**: gated step; runs against dev and stage; prod
  migrations require approval & safe mode (online migrations,
  lock‑timeout, backfills through batch jobs).

- Deploy:

  - *develop* → dev, auto.
  - *main* → stage, auto with smoke tests.
  - *release/\** → prod, requires approvals; feature flags off by
    default, enabled progressively.

**Feature flags** via AppConfig: search promotions, LBG, deposits,
Fan‑sub, OpenSearch switch, instant payouts, etc.

## **1.12.J Observability**

- **Metrics**: p50/p95/p99 latency, error rates per resolver/function,
  queue depths, index lag, OCU/RCU/ACU usage, Stripe/tax/e‑sign error
  rates.
- **Logs**: structured JSON; correlation ids from edge → backend; PII
  scrubbers.
- **Tracing**: X‑Ray/OpenTelemetry from AppSync → Lambda → DB.
- **Dashboards/Alerts**: SLO burn alerts, 5xx spikes, RDS ACU thrash,
  Dynamo throttles, WAF blocks, SES bounce/complaint spikes.

## **1.12.K Security posture**

- **Least‑privilege IAM** for each Lambda.
- **Secrets** in Secrets Manager; rotation policies; no secrets in en