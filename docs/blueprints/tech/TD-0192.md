<!-- id: TD-0192 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 691200-695200 -->

el notify_channel not null,*\
*enabled boolean not null,*\
*updated_at timestamptz default now(),*\
*primary key (user_id, event_key, channel)*\
*);*\
\
*\-- Quiet hours and exceptions*\
*create table notify_quiet (*\
*user_id text primary key,*\
*start_local time not null,*\
*end_local time not null,*\
*timezone text not null,*\
*exceptions jsonb not null default \'\[\]\' \--
\[\"booking_start_12h\",\"payment_failure\",\"dispute_activity\"\]*\
*);*\
\
*\-- Consent & suppression ledger (immutable)*\
*create table notify_consent (*\
*id bigserial primary key,*\
*user_id text not null,*\
*channel notify_channel not null,*\
*action text not null check (action in
(\'opt_in\',\'opt_out\',\'unsubscribe\',\'resubscribe\',\'hard_bounce\',\'complaint\')),*\
*source text not null, \--
\'ui\',\'email_link\',\'import\',\'system\',\'webhook\'*\
*ip inet,*\
*user_agent text,*\
*created_at timestamptz default now()*\
*);*\
\
*\-- Devices/tokens*\
*create table notify_device_token (*\
*user_id text not null,*\
*device_id text not null,*\
*platform text not null check (platform in
(\'ios\',\'android\',\'web\')),*\
*push_token text not null,*\
*last_seen timestamptz default now(),*\
*primary key (user_id, device_id)*\
*);*\
\
*\-- In-app notifications*\
*create table notify_inapp (*\
*id text primary key, \-- nin\_\...*\
*user_id text not null,*\
*title text not null,*\
*body text not null,*\
*cta jsonb, \-- {label, deepLink}*\
*read_at timestamptz,*\
*created_at timestamptz default now(),*\
*expires_at timestamptz*\
*);*\
\
*\-- Send log (denormalized for analytics)*\
*create table notify_send_log (*\
*send_id text primary key, \-- snd\_\...*\
*user_id text not null,*\
*event_key text not null,*\
*channel notify_channel not null,*\
*template_key text not null,*\
*status text not null, \-- queued\|sent\|failed\|suppressed\|quiet*\
*provider_id text, \-- SES MessageId / Pinpoint MessageId*\
*meta jsonb, \-- e.g., bounce reason*\
*created_at timestamptz default now()*\
*);*\
\
*commit;*\

**DynamoDB (ephemeral)**

- *notify_rate* (token bucket per user/channel/event)
- *notify_idem* (idempotency: *pk=eventId:userId:channel*)
- *quiet_cache* (next window edges per user for fast checks; TTL refresh
  daily)

## **1.8.4 GraphQL schema (Preferences & In‑App)**

***api/schema/notify.graphql*** **(selected)**

*enum NotifyChannel { EMAIL PUSH INAPP }*\
*type QuietHours { startLocal: String!, endLocal: String!, timezone:
String!, exceptions: \[String!\]! }*\
\
*type Pref { eventKey: String!, channel: NotifyChannel!, enabled:
Boolean! }*\
*type InAppNotice { id: ID!, title: String!, body: String!, cta:
AWSJSON, readAt: AWSDateTime, createdAt: AWSDateTime, expiresAt:
AWSDateTime }*\
\
*type Query {*\
*myNotifyPrefs: \[Pref!\]! \@aws_cognito_user_pools*\
*myQuietHours: QuietHours \@aws_cognito_user_pools*\
*myInApp(page: Int = 1): \[InAppNotice!\]! \@aws_cognito_user_pools*\
*}*\
\
*type Mutation {*\
*setPref(eventKey: String!, channel: NotifyChannel!, enabled: Boolean!):
Boolean! \@aws_cognito_user_pools*\
*setQuietHours(startLocal: String!, endLocal: String!, timezone:
String!, exceptions: \[String!\]): Boolean! \@aws_cognito_user_pools*\
*registerDevice(deviceId: ID!, platform: String!, pushToken: String!):
Boolean! \@aws_cognito_user_pools*\
*markInAppRead(id: ID!): Boolean! \@aws_cognito_user_pools*\
*unsubscribeAll(channel: NotifyChannel!): Boolean!
\@aws_cognito_user_pools*\
*}*\

**Invariants**

- **Required‑service** emails (receipts, security, legal) ignore
  per‑event prefs but still honor **unsubscribe‑all for marketing
  only**.
- Quiet‑hours exceptions: *booking_start_12h*, *reschedule_expiring_6h*,
  *dispute_activity*, *payment_failure*.

## **1.8.5 Event taxonomy & routing**

**Core events (initial catalog)**

- **Booking**: *booking.confirmed*, *booking.rescheduled*,
  *booking.reminder_24h*, *booking.reminder_1h*, *booking.completed*,
  *booking.review_window_opened*, *booking.review_window_closing*,
  *booking.cancelled.{buyer\|provider