<!-- id: TD-0214 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 770400-774400 -->

ntents**,
  **Transfers**, **Payouts**, **Refunds**, **Disputes**.
- **Daily close job**: roll up to revenue, liabilities, taxes payable;
  export to data warehouse; integrity checks (sum(lines)=0).

## **1.13.12 Security, privacy & compliance**

- **PCI DSS**: all sensitive card data handled by Stripe elements; we
  never store PANs.
- **PII**: payout details in Stripe; we store only status & IDs.
- **HMAC** verification for webhooks; retries with exponential back‑off.
- **Audit log**: every refund, dispute, admin override (who/why/when)
  immutable.

## **1.13.13 Observability, KPIs & alerts**

- **Events**: *checkout.initiated\|abandoned\|completed*,
  *payment.authorized\|captured\|failed*, *refund.issued*,
  *dispute.opened\|won\|lost*, *payout.scheduled\|paid\|failed*.
- **KPIs**: checkout conversion, SCA challenge rate, authorization →
  capture conversion, refund rate, dispute rate & win rate, payout
  failure rate, fees as % GMV, cost/txn.
- **Alerts**: capture failures spike; webhook backlog; dispute surge;
  payout failures; tax calc errors.

## **1.13.14 Work packages (Cursor --- 4 agents)**

- **Agent A --- Pricing & Quotes**: price engine, fee/tax calc, Quote
  API, policy snapshots, tests.
- **Agent B --- Checkout & Intents**: PaymentIntent/SetupIntent flows
  (cards + wallets), deposit/split capture, receipts, webhooks.
- **Agent C --- Payouts & Reconciliation**: Connect onboarding,
  transfers/payout mirroring, ledger, daily close.
- **Agent D --- Refunds/Disputes**: policy evaluation, refund API,
  evidence pack builder, admin tools, notifications.

## **1.13.15 Tests (representative)**

3507. **Quote correctness** across roles/extras; fee/tax rounding;
      deposit flows.
3508. **Checkout happy path** (card): PI created → SCA if needed →
      capture → order created; receipt link present.
3509. **Deposit model**: deposit captured now; balance captured on
      schedule; cancellation triggers auto‑refund calculation.
3510. **Refund**: partial/full; ledger reversals correct; Stripe refund
      id stored; notifications sent.
3511. **Dispute**: webhook opens case; evidence bundle
      prepared/uploaded; status changes mirrored; ledger posts outcome.
3512. **Payouts**: account onboarding; restricted accounts blocked from
      payout; transfer & payout success path; failure retry & alerts.
3513. **Idempotency**: webhook retries don't double‑book journal
      entries.
3514. **Security**: webhook signature validation; no PAN/PII stored;
      HMAC secrets rotation works.
3515. **Performance/cost**: average checkout time within target; API
      calls minimal; card fees tracked.

## **1.13.16 Artifacts (paste‑ready)**

- *db/migrations/021_pay_core.sql* --- tables above.
- *api/schema/payments.graphql* --- schema above.
- *services/pay/pricing.ts* --- fee/tax/deposit calculator.
- *services/pay/checkout.ts* --- PaymentIntent orchestration
  (deposit/split capture).
- *services/pay/webhooks.ts* --- idempotent handlers
  (PI/Charge/Refund/Dispute/Transfer/Payout).
- *services/pay/ledger.ts* --- double‑entry posting helpers.
- *ops/runbooks/stripe-webhooks.md* --- key rotation, replay handling.
- *observability/dashboards/payments.md* --- KPIs/alerts definitions.
- *documents/templates/receipt.html* → *pdf/receipt.pdf* Lambda.

## **1.13.17 Acceptance criteria --- mark §1.13 FINAL only when ALL true**

3525. Buyers can complete checkout with **cards + wallets** (ACH off at
      MVP), receive receipts, and see accurate price/fee/tax breakdowns.
3526. **Deposit or full‑capture** models work as configured; captures
      occur at correct times relative to event.
3527. Refunds (auto per policy + admin override) function; ledger
      reflects captures/refunds/fees correctly; daily close passes
      integrity checks.
3528. Providers onboard to **Stripe Connect**; payouts schedule; failed
      payouts alert and surface actionable errors.
3529. Disputes integrate end‑to‑end: webhook intake, evidence bundle,
      outc