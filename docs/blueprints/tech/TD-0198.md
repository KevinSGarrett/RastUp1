<!-- id: TD-0198 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 712800-716800 -->

onal\',\'required\',\'optional\',\'marketing\');*\
\
*create table notify_event_catalog (*\
*event_key text primary key, \-- e.g., \'booking.confirmed\'*\
*kind notify_kind not null,*\
*default_enabled boolean not null default true,*\
*description text not null*\
*);*\
\
*create table notify_pref (*\
*user_id text not null,*\
*event_key text not null references notify_event_catalog(event_key) on
delete cascade,*\
*channel notify_channel not null,*\
*enabled boolean not null,*\
*updated_at timestamptz default now(),*\
*primary key (user_id, event_key, channel)*\
*);*\
\
*create table notify_quiet (*\
*user_id text primary key,*\
*start_local time not null,*\
*end_local time not null,*\
*timezone text not null,*\
*exceptions jsonb not null default \'\[\]\' \--
\[\"booking_start_12h\",\"reschedule_expiring_6h\",\"payment_failure\",\"dispute_activity\"\]*\
*);*\
\
*create table notify_consent (*\
*id bigserial primary key,*\
*user_id text not null,*\
*channel notify_channel not null,*\
*action text not null check (action in
(\'opt_in\',\'opt_out\',\'unsubscribe\',\'resubscribe\',\'hard_bounce\',\'complaint\')),*\
*source text not null, \--
\'ui\',\'email_link\',\'import\',\'system\',\'webhook\'*\
*ip inet,*\
*user_agent text,*\
*created_at timestamptz default now()*\
*);*\
\
*create table notify_device_token (*\
*user_id text not null,*\
*device_id text not null,*\
*platform text not null check (platform in
(\'ios\',\'android\',\'web\')),*\
*push_token text not null,*\
*last_seen timestamptz default now(),*\
*primary key (user_id, device_id)*\
*);*\
\
*create table notify_inapp (*\
*id text primary key, \-- nin\_\...*\
*user_id text not null,*\
*title text not null,*\
*body text not null,*\
*cta jsonb, \-- {label, deepLink}*\
*read_at timestamptz,*\
*created_at timestamptz default now(),*\
*expires_at timestamptz*\
*);*\
\
*create table notify_template (*\
*template_key text not null, \-- e.g., \'booking.confirmed.provider\'*\
*locale text not null default \'en-US\',*\
*subject text,*\
*mjml text,*\
*text_body text,*\
*push_title text,*\
*push_body text,*\
*inapp_title text,*\
*inapp_body text,*\
*variables jsonb not null default \'\[\]\',*\
*version int not null default 1,*\
*status text not null check (status in (\'draft\',\'active\')) default
\'active\',*\
*primary key (template_key, locale, version)*\
*);*\
\
*create table notify_send_log (*\
*send_id text primary key, \-- snd\_\...*\
*user_id text not null,*\
*event_key text not null,*\
*channel notify_channel not null,*\
*template_key text not null,*\
*status text not null, \-- queued\|sent\|failed\|suppressed\|quiet*\
*provider_id text, \-- SES/Pinpoint MessageId*\
*meta jsonb,*\
*created_at timestamptz default now()*\
*);*\
\
*commit;*\

**Ephemeral Dynamo tables**

- *notify_rate* --- token bucket per user/channel/event.
- *notify_idem* --- idempotency key: *eventId:userId:channel*.
- *quiet_cache* --- next window edges per user (TTL daily).

## **1.10.4 GraphQL (Preferences, Quiet Hours, Inâ€‘App) --- schema artifact**

*api/schema/notify.graphql*:

*enum NotifyChannel { EMAIL PUSH INAPP }*\
*type QuietHours { startLocal: String!, endLocal: String!, timezone:
String!, exceptions: \[String!\]! }*\
*type Pref { eventKey: String!, channel: NotifyChannel!, enabled:
Boolean! }*\
*type InAppNotice { id: ID!, title: String!, body: String!, cta:
AWSJSON, readAt: AWSDateTime, createdAt: AWSDateTime, expiresAt:
AWSDateTime }*\
\
*type Query {*\
*myNotifyPrefs: \[Pref!\]! \@aws_cognito_user_pools*\
*myQuietHours: QuietHours \@aws_cognito_user_pools*\
*myInApp(page: Int = 1): \[InAppNotice!\]! \@aws_cognito_user_pools*\
*}*\
\
*type Mutation {*\
*setPref(eventKey: String!, channel: NotifyChannel!, enabled: Boolean!):
Boolean! \@aws_cognito_user_pools*\
*setQuietHours(startLocal: String!, endLocal: String!, timezone:
String!, exceptions: \[String!\]): Boolean! \@aws_cognito_user_pools*\
*registerDevice(deviceId: ID!, platform: String!, pushToken: String!):
Boolean! \@aws_cognito_user_p