<!-- id: TD-0194 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 698400-702400 -->

ect after
  warmup), brand alignment (same envelope/from).
- **Warmup**: ramp volume over 2--3 weeks; preferentially send
  booking/receipt (high‑engagement) first.
- **Feedback loops**: SES webhooks write
  ***notify_consent(action=\'hard_bounce\'\|\'complaint\')***;
  automatically suppress further sends; display banner in app to
  re‑confirm email.
- **Link tracking**: restricted to analytics on transactional messages
  **without** altering core links that might trigger spam filters; never
  track in safety/IDV/legal mail.

## **1.8.10 Security, privacy & compliance**

- **Consent ledger** for every opt‑in/out/unsubscribe; immutable,
  time‑stamped with IP/UA.
- **CAN‑SPAM & regional rules**: required footer, company address,
  one‑click unsubscribe for marketing (kept off at MVP).
- **Age gates**: never send NSFW references in email/push; FanSub
  content never previewed in notifications.
- **PII minimization**: no door codes/phone numbers in templates; deep
  links to in‑app views.

## **1.8.11 Rate limits & cost controls**

- Per‑user/channel token buckets (Dynamo) for optional notifications;
  transactional are exempt but still idempotent.
- **SES**: single region pool, monitor spend; fall back to low‑volume
  provider (Resend/Mailgun) via adapter if SES rate‑limited.
- **Pinpoint**: only register active device tokens; expire tokens after
  90 days of inactivity.

## **1.8.12 Observability & KPIs**

- **Events**: *notify.sent\|failed\|suppressed\|quieted*,
  *notify.open\|click* (email), *push.open*, *digest.sent*,
  *pref.changed*, *unsubscribe*.
- **KPIs**: Delivery rate, open/click, push open rate, digest
  engagement, opt‑out rate, quiet‑hour suppression count, cost per 1k
  sends, notifications per booking.
- **Alerts**: bounce/complaint spikes, SES/Pinpoint errors, digest job
  failures, template compile errors.

## **1.8.13 Work packages (Cursor 4‑agent lanes)**

- **Agent A --- Data & API**: DDL, GraphQL resolvers, preferences UI
  endpoints, consent ledger, device token flows.
- **Agent B --- Orchestrator & Templates**: event routing, template
  registry, MJML compile pipeline, localization.
- **Agent C --- Delivery & Compliance**: SES/Pinpoint integration,
  SPF/DKIM/DMARC setup, bounce/complaint handlers, suppression.
- **Agent D --- Digests & Quiet Hours**: digest builder, timezone
  scheduling, quiet‑hour policy & exceptions, rate limits.

## **1.8.14 Tests**

3183. **Preferences**: toggle per‑event/channel; verify sends suppressed
      except **required‑service**.
3184. **Quiet Hours**: optional notifications delayed; exceptions still
      deliver; ICS present for reminders.
3185. **Routing**: booking confirmed/rescheduled → provider & buyer
      receive correct templates; Action Card expiries escalate during
      quiet hours.
3186. **Digests**: daily and weekly contain correct sections; de‑dup
      logic works; timezone windows honored.
3187. **Deliverability**: hard bounce/complaint suppresses future sends;
      ledger records action; banner prompts re‑confirm.
3188. **Idempotency & rate limits**: duplicate events do not re‑send;
      optional notification floods are throttled.
3189. **Push tokens**: invalid tokens cleaned; per‑device opt‑out
      honored.
3190. **Security**: no PII or NSFW previews leak in templates; deep
      links require auth.

## **1.8.15 Artifacts (paste‑ready)**

- *db/migrations/018_notify.sql* --- tables above.
- *api/schema/notify.graphql* --- queries/mutations above.
- *services/notify/orchestrator.ts* --- event→audience→template routing
  skeleton.
- *services/notify/providers/ses.ts* & *providers/pinpoint.ts* ---
  senders with retries/backoff.
- *templates/email/\*.mjml* --- compiled at publish; S3 cache.
- *ops/runbooks/notify-bounce-complaint.md* --- immediate actions,
  suppression verification.
- *observability/dashboards/notify.md* --- metric definitions & example
  queries.

## **1.8.16 Acceptance criteria --- mark §1.8 FINAL only when ALL true**

3198. Users