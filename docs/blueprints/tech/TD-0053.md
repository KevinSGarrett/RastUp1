<!-- id: TD-0053 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 190800-194800 -->

mmsPreferences: \[CommsPreference!\]!*\
*quietHours: QuietHours*\
*}*\
\
*type Mutation {*\
*setCommsPreference(channel: String!, categoryKey: String!, optedIn:
Boolean!): \[CommsPreference!\]!*\
*setQuietHours(tz: String!, startLocal: String!, endLocal: String!):
QuietHours!*\
*unsubscribeAllEmail(): Boolean! \# sets all email categories to
optedIn=false except critical*\
*}*\

**List‑Unsubscribe**

- Email headers include *List-Unsubscribe* mailto + HTTPS link to a
  **one‑click** suppression endpoint (sets *comms_pref* to opted‑out for
  marketing categories and records *comms_suppression* if required by
  provider).

## **1.10.G Channel workers & dedupe/batching**

**Email worker (SES)**

- Receives rendered HTML + text, sets **SPF/DKIM domains**,
  **List‑Unsubscribe** headers, adds **message‑id** for threading,
  queues to SES.
- Stores a copy of rendered HTML in S3 and writes *comms_message*.

**Push worker**

- Sends to device tokens (APNs/FCM) with *collapse_key* to dedupe on
  device; respects per‑device language; drops invalid tokens and prunes
  from *comms_tokens*.

**SMS worker**

- Enforces country gating and high cost flags; trims body to length;
  inserts short links; checks suppression and opt‑in.
- Templated STOP/HELP footer where required.

**Batching**

- **Message digest**: compile last N thread updates into one email if
  user inactive for M minutes; include counts and deep links.
- **Review reminders**: send at 24 h and 72 h unless user already
  reviewed; cancel if review arrives.

**Idempotency & replays**

- All workers use *(template_name, user_id, cause_ref, version)* as
  idempotency key; retries do not duplicate sends or audits.

## **1.10.H Error taxonomy (client‑safe and admin)**

- *COMMS_PREF_BLOCKED* --- user opted out for that category/channel.
- *COMMS_QUIET_HOURS* --- scheduled due to quiet hours (not an error;
  informational).
- *COMMS_SUPPRESSED* --- address on suppression list (hard
  bounce/complaint).
- *COMMS_TEMPLATE_MISSING_VAR* --- variable resolver missing data
  (developer error; logged).
- *COMMS_PROVIDER_FAIL* --- provider transient error; retried with
  backoff.
- *COMMS_RATE_LIMITED* --- SMS or push throttled.

## **1.10.I Work packages (Cursor agent lanes)**

- **Agent B --- Comms Core**\
  WP‑COMMS‑01: SQL for
  templates/prefs/quiet‑hours/messages/suppression/in‑app.\
  WP‑COMMS‑02: Comms Router & Renderer (MJML compile, variable resolver,
  locale fallback).\
  WP‑COMMS‑03: Channel workers (SES, APNs/FCM, SNS/Twilio) with
  idempotency & retries.
- **Agent A --- Web (Settings & UX)**\
  WP‑WEB‑COMMS‑01: Notification Preferences UI + Quiet Hours UI +
  List‑Unsubscribe landing.\
  WP‑WEB‑COMMS‑02: In‑app notification center (bell, unread counts,
  pagination, mark read).
- **Agent C --- Integrations/Deliverability**\
  WP‑DLV‑01: Domain auth (SPF/DKIM/DMARC), bounce/complaint webhooks,
  suppression list processor.\
  WP‑DLV‑02: Link tracking & UTM, open pixel (email only) with privacy
  guardrails.
- **Agent D --- Admin & QA**\
  WP‑ADM‑COMMS‑01: Template manager (versioning, preview, publish with
  dual approval for legal/security).\
  WP‑QA‑COMMS‑01: Full test matrix automation (see Part 2), synthetic
  provider sandboxes.

## **1.10.J Acceptance criteria (for Part 1) --- we won't move to Part 2 until all hold**

986. Template catalog exists with MJML→HTML render and variable schemas;
     at least the MVP templates are authored (booking, docs, payments,
     messages, trust, promotions).
987. Providers wired (SES, APNs/FCM, SNS/Twilio behind flags); Comms
     Router applies preferences, quiet hours, dedupe, and batching.
988. Message audits stored with immutable link to rendered bodies
     (email) or payload snapshots (push/SMS/in‑app).
989. User Preference & Quiet Hours UI/APIs functional; List‑Unsubscribe
     endpoints live and audited.
990. Channel workers respect cost gates (e.g., SMS limited to critical
     flows where configured).
991. Idempotency & retrie