<!-- id: TD-0219 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 788400-792400 -->

_id) on delete cascade,*\
*responder_user_id text not null,*\
*action text not null, \--
\'accept\',\'decline\',\'counter\',\'approve\',\'request_changes\',\'upload\'*\
*payload jsonb not null default \'{}\',*\
*created_at timestamptz default now()*\
*);*\
\
*\-- Lightweight optimistic locking per order (for concurrent cards)*\
*create table ord.order_lock (*\
*order_id text primary key references ord.order(order_id) on delete
cascade,*\
*version bigint not null default 0,*\
*updated_at timestamptz default now()*\
*);*\
\
*commit;*\

## **1.14.4 GraphQL API --- pasteâ€‘ready schema (*****api/schema/orders.graphql*****)**

*enum OrderState { CREATED AUTHORIZED CONFIRMED IN_PROGRESS COMPLETED
CANCELLED DISPUTED CLOSED }*\
*enum CardType { RESCHEDULE EXTRAS PROOFS EXPENSE COMPLETE DISPUTE }*\
*enum CardState { OPEN ACCEPTED DECLINED EXPIRED CANCELLED SUPERSEDED
CLOSED }*\
\
*type Order {*\
*id: ID!*\
*buyerId: ID!*\
*providerId: ID!*\
*role: String!*\
*startUtc: AWSDateTime!*\
*endUtc: AWSDateTime!*\
*timezone: String!*\
*state: OrderState!*\
*price: AWSJSON! \# price_snapshot*\
*policy: AWSJSON! \# policy_snapshot*\
*timeline(page: Int = 1): \[TimelineEvent!\]!*\
*openCards: \[ActionCard!\]!*\
*}*\
\
*type TimelineEvent { id: ID!, kind: String!, subtype: String!,
actorUserId: ID, payload: AWSJSON!, createdAt: AWSDateTime! }*\
\
*interface ActionCard {*\
*id: ID!*\
*type: CardType!*\
*state: CardState!*\
*dueAt: AWSDateTime*\
*expiresAt: AWSDateTime*\
*createdBy: ID!*\
*payload: AWSJSON!*\
*}*\
\
*type RescheduleCard implements ActionCard { id: ID!, type: CardType!,
state: CardState!, dueAt: AWSDateTime, expiresAt: AWSDateTime,
createdBy: ID!, payload: AWSJSON! }*\
*type ExtrasCard implements ActionCard { id: ID!, type: CardType!,
state: CardState!, dueAt: AWSDateTime, expiresAt: AWSDateTime,
createdBy: ID!, payload: AWSJSON! }*\
*type ProofsCard implements ActionCard { id: ID!, type: CardType!,
state: CardState!, dueAt: AWSDateTime, expiresAt: AWSDateTime,
createdBy: ID!, payload: AWSJSON! }*\
*type ExpenseCard implements ActionCard { id: ID!, type: CardType!,
state: CardState!, dueAt: AWSDateTime, expiresAt: AWSDateTime,
createdBy: ID!, payload: AWSJSON! }*\
*type CompleteCard implements ActionCard { id: ID!, type: CardType!,
state: CardState!, dueAt: AWSDateTime, expiresAt: AWSDateTime,
createdBy: ID!, payload: AWSJSON! }*\
*type DisputeCard implements ActionCard { id: ID!, type: CardType!,
state: CardState!, dueAt: AWSDateTime, expiresAt: AWSDateTime,
createdBy: ID!, payload: AWSJSON! }*\
\
*type Query {*\
*order(id: ID!): Order! \@aws_cognito_user_pools*\
*myOrders(page: Int = 1, state: OrderState): \[Order!\]!
\@aws_cognito_user_pools*\
*}*\
\
*input RescheduleProposeInput { orderId: ID!, slots: \[AWSDateTime!\]!,
durationMin: Int!, note: String }*\
*input RescheduleRespondInput { cardId: ID!, acceptSlot: AWSDateTime,
declineReason: String }*\
\
*input ExtrasRequestInput { orderId: ID!, items: AWSJSON!, note: String
} \# items = \[{code, label, qty, unitPriceCents}\]*\
*input ExtrasRespondInput { cardId: ID!, acceptItems: AWSJSON,
declineReason: String }*\
\
*input ProofsSubmitInput { orderId: ID!, galleryId: ID!, note: String
}*\
*input ProofsRespondInput { cardId: ID!, approveIds: \[ID!\],
changeNotes: AWSJSON } \# {assetId: note}*\
\
*input ExpenseSubmitInput { orderId: ID!, items: AWSJSON!, receipts:
\[ID!\]!, note: String } \# items = \[{label, amountCents}\]*\
*input ExpenseRespondInput { cardId: ID!, approve: Boolean!, note:
String }*\
\
*input CompleteSubmitInput { orderId: ID!, confirmTime: AWSDateTime,
note: String }*\
*input DisputeOpenInput { orderId: ID!, reason: String!, note: String,
attachments: \[ID!\] }*\
\
*type Mutation {*\
*proposeReschedule(input: RescheduleProposeInput!): ID!
\@aws_cognito_user_pools*\
*respondReschedule(input: RescheduleRespondInput!): Boolean!
\@aws_cognito_user_pools*\
\
*requestExtras(input: ExtrasRequestInput!): ID!
\@aws_cognito_user_pools*\
*respondExtras(input: ExtrasRespondInpu