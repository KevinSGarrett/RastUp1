<!-- id: TD-0208 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 748800-752800 -->

ekdayMask: Int!, startLocal: String!,
endLocal: String!,*\
*timezone: String!, minDurationMin: Int, leadTimeHours: Int,
bookingWindowDays: Int, active: Boolean): ID!*\
*upsertException(dateLocal: AWSDate!, timezone: String!, kind: String!,
startLocal: String, endLocal: String, note: String): ID!*\
*createHold(role: String!, startUtc: AWSDateTime!, endUtc: AWSDateTime!,
source: String!, orderId: ID, ttlMinutes: Int = 30): ID!*\
*releaseHold(id: ID!): Boolean!*\
*connectICS(url: AWSURL!): ID!*\
*disconnectExternal(srcId: ID!): Boolean!*\
*createIcsFeed(includeHolds: Boolean = false): String! \# returns ICS
url*\
*}*\

**Guards**

- *feasibleSlots* = **weekly rules − exceptions − external busy −
  confirmed events − active holds**, then apply **lead_time** and
  **booking_window** and **min_duration_min**.
- *createHold* idempotent for (user, start, end, source); default TTL
  **30 min**; expired holds auto‑purged.
- Only **IDV‑verified** Providers with a published **Service Profile**
  (§1.7) surface slots in Search/IB.

## **1.12.5 Feasibility computation (deterministic)**

**Engine (Lambda):**

3381. Load *weekly_rule* for user/role; build candidate local windows
      within the target range.
3382. Apply *exception* slices (unavailable → remove; available → add).
3383. Convert to UTC using **IANA tz** (Luxon/date‑fns‑tz); handle DST
      properly.
3384. Subtract **confirmed events** and **active holds**.
3385. Subtract **external busy** from *external_event* (if any sources
      are connected).
3386. Enforce **lead time**, **booking window**, and **min duration**.
3387. Return **FeasibleSlot\[\]**, capped (e.g., ≤100) and cached in
      Dynamo with 2--10 min TTL.

**Reschedule candidates** use the same engine with the order's original
**duration** and a narrower search window (e.g., ±14 days).

## **1.12.6 External calendar sync**

**MVP --- read‑only ICS import**

- Provider adds a private **ICS URL** (Google/Apple/Outlook).
- Poller uses **ETag/If‑Modified‑Since** for differential fetch; parses
  with *ical.js*; normalizes RRULE/RDATE/EXDATE into instances in
  *external_event*.
- Cadence: 5--15 min when active; exponential back‑off on errors;
  per‑user caps (e.g., ≤3 sources).

**Phase‑2 --- two‑way (optional)**

- **Google**: OAuth with offline refresh; **watch channels** per
  calendar (expire \~7 days → auto‑renew). Only write/read **busy**
  blocks (privacy‑preserving).
- **Microsoft 365**: Graph subscriptions with renewal cadence.
- **Outbound**: when order confirmed/rescheduled/cancelled, optionally
  write a busy event to connected calendar.
- **Security**: tokens in **Secrets Manager**; DB keeps only a ref;
  rotate on errors.

## **1.12.7 Instant Book (IB) & RTB enforcement**

- **IB toggle** is available only after **IDV PASSED** (§1.5) and
  profile **completeness ≥ 80** (§1.7).
- IB can only pick from **feasibleSlots**; server validates the selected
  slot is still free right before checkout.
- **Race handling**: checkout creates a **hold**; confirmation is atomic
  → **hold → event**; if user abandons, hold **expires** on TTL.
- RTB **reschedule** proposals also create **reschedule holds** until
  accept/decline.

## **1.12.8 Time zones & DST edge cases**

- Store *timezone* on rules/exceptions; compute UTC at evaluation time.
- **Spring forward**: if the local window overlaps the missing hour,
  **trim** it.
- **Fall back**: duplicated hour creates **two** UTC windows.
- Changing a user's timezone later does **not** mutate prior rules;
  create a new rule with the new tz and sunset the old one.
- ICS parsing preserves original tz; recurrence instances stored in UTC
  with a *recurrence_id*.

## **1.12.9 ICS outbound (attachments & feeds)**

- **Attachments**: include *.ics* on booking confirmations and
  reschedules (provider & buyer); update on changes; cancel events send
  *.ics* cancellations.
- **Per‑user ICS feed**: tokenized URL displaying confirmed events (and
  optionally holds if *include_holds=t