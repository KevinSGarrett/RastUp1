<!-- id: TD-0130 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 468000-472000 -->

der(orderId: ID!, reason: String!): Order!*\
*}*\

## **1.22.5 Stripe Connect onboarding (providers)**

- **Type:** **Express** accounts; Stripe‑hosted onboarding/updates.
- Enable capabilities for payments/transfers; Stripe handles KYC; we
  reflect verification status in UI (*account.updated* webhooks).
- **Payout schedule:** weekly by default; consider T+1/T+7 policy gates
  (see §1.22.11).

**Artifact --- onboarding link resolver**\
**Recommended path:** *api/resolvers/payments/onboarding.ts*

*export async function createOnboardingLink(userId: string) {*\
*const acct = await lookupOrCreateStripeAccount(userId); // acct\_\...*\
*const link = await stripe.accountLinks.create({*\
*account: acct,*\
*refresh_url: \`\${HOST}/onboarding/refresh\`,*\
*return_url: \`\${HOST}/onboarding/return\`,*\
*type: \'account_onboarding\'*\
*});*\
*return link.url;*\
*}*\

## **1.22.6 Charges & transfers pattern**

Choose **one** per order for simplicity:

- Destination charge

  - Charge on connected account; include *application_fee_amount*.
  - **Pros:** Simple split; Stripe handles fee. **Cons:** Fewer methods;
    less transfer timing control.

- **Separate charges & transfers** (recommended)

  - Charge on platform; attach *transfer_group=order_id*; create
    **Transfer** to provider on completion.
  - **Pros:** Full payout timing control; clean refunds. **Cons:**
    Platform temporarily carries liability.

## **1.22.7 Webhooks, idempotency & order state machine**

**Listen to:**\
*payment_intent.succeeded*, *payment_intent.payment_failed*,
*charge.refunded*, *charge.dispute.created\|closed*, *account.updated*,
*transfer.paid\|reversed*, *payout.paid\|failed*.

**Order states:** *draft → authorized? → captured → completed →
(refunded\|disputed)*.

**Artifact --- webhook handler skeleton**\
**Recommended path:** *apps/functions/stripeWebhook.ts*

*import { verifyStripe } from \'../../security/webhooks/verify\'; //
§1.18.E*\
\
*export const handler = async (evt) =\> {*\
*const sig = evt.headers\[\'stripe-signature\'\];*\
*const raw = Buffer.from(evt.body, \'utf8\');*\
*const event = stripe.webhooks.constructEvent(raw, sig,
process.env.STRIPE_WEBHOOK_SECRET);*\
\
*switch (event.type) {*\
*case \'payment_intent.succeeded\': await
onPiSucceeded(event.data.object); break;*\
*case \'payment_intent.payment_failed\': await
onPiFailed(event.data.object); break;*\
*case \'charge.refunded\': await onRefund(event.data.object); break;*\
*case \'charge.dispute.created\': await onDispute(event.data.object);
break;*\
*case \'charge.dispute.closed\': await
onDisputeClosed(event.data.object); break;*\
*case \'transfer.paid\': await onTransferPaid(event.data.object);
break;*\
*}*\
*return { statusCode: 200, body: \'{}\' };*\
*};*\

**Idempotency store:** record processed *event.id* in Dynamo with TTL;
duplicates are no‑ops.

## **1.22.8 Refunds, cancellations & disputes**

- **Refunds**: compute per policy; create Stripe Refunds; write
  *refund_ledger*. Partial refunds supported.

- **Disputes**: on *charge.dispute.created* → **pause transfer** if
  pending; if already paid, prepare potential clawback.

  - Evidence pack = messages, deliverables, ToS acceptance, studio
    confirmations; submit via API or dashboard.
  - On closure: if **lost**, finalize refund ledger; claw back provider
    payout; if **won**, release reserve/hold.

**Artifact --- refund policy JSON (for UI)**\
**Recommended path:** *payments/policy/refund-policy.json*

*{*\
*\"before_accept\": {\"buyer\":\"100%\", \"provider\":\"0%\"},*\
*\"accepted_gt_48h\": {\"buyer\":\"subtotal - cancel_fee\",
\"provider\":\"cancel_fee\"},*\
*\"accepted_lt_48h\": {\"buyer\":\"partial at platform discretion\",
\"provider\":\"minimum_guarantee\"}*\
*}*\

## **1.22.9 Credits, vouchers & taxes**

- **Credits (referral/promos)** reduce **platform fee** (buyer_fee) only
  unless promo explicitly subsidizes subtotal.
- If a promo reduces **subtotal**, it's platform‑funded; treat as
  **negative revenue** i