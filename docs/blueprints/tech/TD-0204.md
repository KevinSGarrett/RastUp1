<!-- id: TD-0204 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 734400-738400 -->

download logs stored (for
  licensing evidence).

## **1.11.6 Upload & processing flows**

**A) Upload (client → S3)**

3310. Client calls *requestUpload* with **kind/mime/size**.
3311. Server validates quotas/types; returns **presigned PUT** URL &
      headers.
3312. Client uploads directly to *media-raw* (chunked/resumable if
      large).
3313. Client calls *completeUpload(assetId)*; server verifies object
      exists & size matches → emits *media.ingested*.

**B) Quarantine & AV scan**

- S3 event → Lambda runs **ClamAV**; failures set *status=\'blocked\'* +
  *blocked_reason=\'AV\'* and delete processed variants if any.

**C) Image pipeline**

- **Transforms (sharp)**: *1920*, *1280*, *640*, *cover* crop;
  WebP/AVIF + JPEG fallback; EXIF orientation fix; strip GPS; set color
  profile sRGB.
- **Watermark**: for Proof variants (semi‑transparent diagonal +
  footer).
- **Safe‑Mode Tier‑0**: fast classifier; if uncertain/high‑reach →
  Tier‑1 (Rekognition). Set *sfw_band* & *safeModeRequired*.

**D) Video pipeline**

- MediaConvert job template: **renditions** 1080/8Mbps, 720/5Mbps,
  480/1.5Mbps; audio AAC 128kbps; HLS master + poster frames at 3 sizes.
- For Proofs: overlay watermark on all renditions.
- MP4 progressive rendition for simple download (deliverables).

**E) Publish**

- Write *media.variant* rows; set *status=\'ready\'*; emit
  *media.published*.
- Notify thread (if tied to Action Card), or nudge in onboarding if in
  profile context.

## **1.11.7 Safe‑Mode & public surfaces**

- Public pages (profiles, SPs, search) only render **SFW** variants; if
  *safeModeRequired=true*, show blurred placeholder with label.
- Email/push never include NSFW previews (link to in‑app).
- **FanSub/NSFW** (elsewhere in plan) uses protected variants only and
  never leaks to public/CDN without auth.

## **1.11.8 Proofs, approvals & deliverables**

- **Proof galleries** (Action Card: *type=\"proofs\"* in §1.4):

  - Watermarked images/video + gallery expires (default 30 days).
  - Buyer can **Approve** or **Request changes**; approvals can be
    per‑selection (IDs returned).

- **Deliverables** (final):

  - Non‑watermarked variants; license metadata baked into asset *meta*
    and deliverable record (*license_code*, timestamp, orderId).
  - Download link is **short‑lived signed URL**; each download is logged
    (evidence for disputes/chargebacks & licensing).

## **1.11.9 Security, privacy, and legal**

- **KMS** keys per bucket; server‑side encryption (SSE‑KMS).
- **CloudFront signed URLs** + origin access control (no public S3).
- **Anti‑hotlinking**: signed URLs + referer checks; throttled link‑gen.
- **PII minimization**: strip EXIF GPS; redact filenames in public URLs;
  move any PII attachments to **protected** scope.
- **Legal hold**: evidence bucket enabled with **Object Lock**; hash
  recorded in *EvidenceBlob* (§1.5).

## **1.11.10 Cost controls & lifecycle**

- **Lifecycle**: raw objects → S3‑IA at 30 days; proofs assets → S3‑IA
  at 60 days; **auto‑delete** expired proof galleries (configurable);
  deliverables retained; video intermediates (transcode scratch)
  auto‑deleted post‑publish.
- **Adaptive transcode**: if file \<720p, skip 1080; if duration \< 30s,
  skip 480.
- **Quota**: per user/day bytes and max count; per file hard caps (e.g.,
  250 MB images, 5 GB video at MVP).
- **Dedupe**: SHA‑256 based; if identical asset already exists for same
  owner, reuse variants.

## **1.11.11 Observability & KPIs**

- **Events**:
  *media.ingested\|scanned\|transcoded\|classified\|published*,
  *proofs.created*, *deliverable.published*, *download.performed*.
- **KPIs**: p95 ingest→ready latency, transcode failure rate, AV
  false‑positive/negative rates (spot QA), storage by class, CDN egress,
  proof→approval rate, deliverables download rate.
- **Alarms**: high failure spikes, queue backlog, elevated CDN 4xx/5xx.

## **1.11.12 Work packages (Cursor --- 4 agents)**

- **Agent A --- API & Models**: migrations, GraphQ