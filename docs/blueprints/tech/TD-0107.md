<!-- id: TD-0107 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 385200-389200 -->

ef\",\"gclid\",\"fbclid\"\];*\
*export function middleware(req) {*\
*const url = new URL(req.nextUrl);*\
*// Normalize case and trailing slash*\
*url.pathname =
url.pathname.toLowerCase().replace(/\\/+\$/,\'\').replace(/\\/{2,}/g,\'/\');*\
*// Strip tracking params*\
*for (const p of CANON_QP_BLOCKLIST) url.searchParams.delete(p);*\
*// If changed, 301 to canonical*\
*if (url.toString() !== req.nextUrl.toString()) return
Response.redirect(url, 301);*\
*return;*\
*}*\

**B) Canonical link builder (server)**\
*Recommended path:* *web/lib/canonical.ts*

*export const canonicalFor = (entity) =\>*\
*entity.kind === \"person\" ?
\`https://rastup.com/\${entity.role}/\${entity.slug}\` :*\
*entity.kind === \"studio\" ?
\`https://rastup.com/studio/\${entity.slug}\` :*\
*entity.kind === \"package\" ?
\`https://rastup.com/\${entity.role}/\${entity.slug}/packages/\${entity.pkgSlug}\`
:*\
*\`https://rastup.com/\`;*\

## **1.17.3 Faceted Navigation, Pagination & Filters**

**Objective:** Let users filter richly **without** creating an
indexation explosion.

**Approach**

- **Indexable landing** per role/city **without filters** (e.g.,
  */models?city=houston*).
- **Non‑indexable** filter combinations (e.g., price/amenities) → keep
  crawlable links but serve *noindex, follow* and **self‑canonical** to
  the landing variant.
- Pagination: *?page=2* allowed but **noindex**; canonical to page 1
  landing. Avoid *rel=prev/next* (deprecated); use strong internal links
  instead.

**Artifact --- filter allowlist**\
*Recommended path:* *search/spec/filter-allowlist.md*

*Indexable: (role + city) only*\
*Non-indexable: any additional filters (price, amenity, availability,
verification, rating, etc.) =\> meta robots noindex, self-canonical to
landing*\
*Pagination: ?page=N =\> meta robots noindex, canonical to page=1*\

## **1.17.4 Structured Data (JSON‑LD) --- Full Coverage**

**Entity → schema.org type map**

- **People (Service Profiles)**: *Person* + *Offer*(s) for packages;
  optional *AggregateRating* when policy allows.
- **Studios**: *LocalBusiness* with *amenityFeature*; optional
  *AggregateRating*.
- **Case Studies/Guides**: *Article*/*CreativeWork*.
- **Breadcrumbs**: *BreadcrumbList* on all public pages.
- **Search results** (optional enhancement): *ItemList* on landing
  pages.

**Artifacts**

**A) BreadcrumbList**\
*Recommended path:* *web/lib/ldjson/breadcrumb.ts*

*export const breadcrumbLd = (trail) =\> ({*\
*\"@context\": \"*[*https://schema.org*](https://schema.org)*\",*\
*\"@type\": \"BreadcrumbList\",*\
*\"itemListElement\": trail.map((item, i) =\> ({*\
*\"@type\": \"ListItem\", \"position\": i+1, \"name\": item.name,
\"item\": item.url*\
*}))*\
*});*\

**B) Service Profile with Offers & rating**\
*Recommended path:* *web/lib/ldjson/personOffers.ts*

*export const personWithOffersLd = (p) =\> ({*\
*\"@context\": \"*[*https://schema.org*](https://schema.org)*\",*\
*\"@type\": \"Person\",*\
*\"name\": p.displayName,*\
*\"image\": p.og_image_sfw_url,*\
*\"url\": \`https://rastup.com/\${p.role}/\${p.slug}\`,*\
*\"jobTitle\": p.roleTitle,*\
*\"address\": {\"@type\":\"PostalAddress\",\"addressLocality\":
p.city},*\
*\"makesOffer\": p.packages.map(pkg =\> ({*\
*\"@type\":\"Offer\",*\
*\"priceCurrency\": pkg.currency,*\
*\"price\": (pkg.priceCents/100).toFixed(2),*\
*\"url\":
\`https://rastup.com/\${p.role}/\${p.slug}/packages/\${pkg.slug}\`,*\
*\"availability\":\"https://schema.org/InStock\"*\
*})),*\
*\...(p.ratingCount \>= 5 ? {*\
*\"aggregateRating\": {*\
*\"@type\":\"AggregateRating\",*\
*\"ratingValue\": p.rating.toFixed(1),*\
*\"reviewCount\": p.ratingCount*\
*}*\
*} : {})*\
*});*\

**C) Studio with amenity features**\
*(already covered earlier---kept here for completeness; ensure SFW
images)*

## **1.17.5 Content Templates & On‑Page Optimization**

**Title & Description formulas**\
*Recommended path:* *web/seo/title-desc-formulas.md*

*Service Profile (People):*\
*\<title\> {DisplayName} --- {RoleTitle} in {City} \| RastUp
\</ti