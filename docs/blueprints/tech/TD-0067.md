<!-- id: TD-0067 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 241200-245200 -->

fra (§1.12):** *waf.block*, *alarm.triggered*,
  *deploy.succeeded\|failed* (for internal SRE metrics).

We will ship **JSON Schemas** per event type with unit tests to
guarantee backward‑compatible evolution (*v* increments only on breaking
changes).

## **1.13.D Bronze → Silver → Gold modeling**

**Bronze (raw):**\
*s3://data/bronze/events/dt=YYYY‑MM‑DD/hour=HH/\*.json*

- Append‑only; immutable.
- Glue Catalog table *bronze_events* with partitions (*dt*, *hour*).

**Silver (typed/curated):** primary tables

- *fact_search_impressions*, *fact_search_clicks* (joinable via
  *impression_id*).
- *fact_booking_legs* (one row per leg status change with snapshots).
- *fact_payments*, *fact_refunds*, *fact_payouts*, *fact_disputes*.
- *fact_promotions_events* (impressions/clicks/invalids),
  *fact_promotions_spend*.
- *fact_messages*, *fact_action_cards*, *fact_notifications*.
- *fact_docs*, *fact_idv_bg*, *fact_reviews*.
- **Dimensions**: *dim_user_public* (no PII), *dim_service_profile*,
  *dim_studio*, *dim_city*, *dim_device*, *dim_campaign*.

**Gold (marts/KPIs):**

- **Marketplace**: *kpi_gmv_daily*, *kpi_take_rate*,
  *kpi_conversion_funnel* (search→profile→checkout→confirm),
  *kpi_cancellations*, *kpi_refunds*, *kpi_disputes*.
- **Supply**: *kpi_seller_activation*, *kpi_studio_verification_rate*,
  *kpi_acceptance_window_hist*.
- **Trust**: *kpi_idv_pass_rate*, *kpi_bg_clear_rate*,
  *kpi_risk_buckets*.
- **Promotions**: *kpi_promo_ctr*, *kpi_invalid_rate*,
  *kpi_spend_vs_budget*.
- **Comms**: *kpi_delivery*, *kpi_bounce*, *kpi_complaint*,
  *kpi_open_click* (non‑sensitive).
- **SRE**: *kpi_api_latency_p95*, *kpi_error_rates*, *kpi_waf_blocks*.

**Build strategy**

- Glue/CTAS jobs materialize Silver to Parquet partitioned by *dt* (and
  sometimes *city*).
- Gold uses **dbt models** (on Athena) with tests (unique keys, not
  null, referential integrity), incremental by *dt*.

## **1.13.E Near‑real‑time ops views**

Some ops metrics (recon gates, payout backlogs, dispute queues) require
freshness **\<15 min**.

- Create **NRT materialized views** in S3 via Athena CTAS running every
  **5--10 min**, small partitions only for today's hours.
- Admin consoles read from these materialized Parquet tables for stable,
  fast loads.

## **1.13.F Experimentation framework**

**Assignment**

- Sticky bucket per *user_id* (or *anon_id* pre‑login) via salted hash
  (e.g., *hash(user_id + exp_key) % 100*).
- Variants defined in AppConfig (feature flags). Exposure logged as
  *exp.exposed* at first checkpoint.

**Metrics & guardrails**

- Primary metrics per experiment pre‑declared; guardrails include:
  refund rate, complaint rate, SLO latency, bounce for comms.
- **CUPED** or stratified analyses supported by exporting **per‑user
  aggregates** (pre‑period covariates).
- **Sequential** or fixed horizon; maintain cookbook for analysts.

**Data**

- *dim_exposure* table links *user_id*/*anon_id* to *exp_key*,
  *variant*, *exposed_at*.
- Gold layer produces per‑variant metric tables with p‑values/CI
  (analyst notebooks).

## **1.13.G Data quality, validation & lineage**

- **Contract tests**: every event schema tested in CI; unknown event
  fields flagged but preserved in Bronze.
- **Great Expectations** (or **Deequ**) on Silver/Gold: uniqueness of
  ids, non‑nulls, ranges (e.g., *rating between 1..5*), monotonicity
  (e.g., payout queue should drain).
- **Lineage**: dbt docs + event schema registry show upstream/downstream
  for each mart.
- **Alerts**: failed expectations page Ops; large deltas in GMV/CTR vs
  7‑day average trigger review.

## **1.13.H Privacy, governance & retention**

- **Lake Formation** for table/column permissions; analysts get
  **row‑level filtering** by environment and city if required.

- **Hashing**: *email_sha256*, *phone_sha256* kept only in **Silver
  private** area (not in Gold); never in events.

- **DSAR/Deletion**: user deletion writes a **tombstone event**; nightly
  job purges Silver/Gold joins that 