<!-- id: TD-0171 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 615600-619600 -->

ated_at timestamptz default now(),*\
*primary key (blocker_user, blocked_user)*\
*);*\
\
*\-- Inbox indexing for fast lists*\
*create table inbox_index (*\
*user_id text not null,*\
*thread_id text not null,*\
*last_msg_ts timestamptz not null,*\
*folder text not null check (folder in
(\'all\',\'action\',\'bookings\',\'offers\',\'archived\',\'spam\')),*\
*unread_count int not null default 0,*\
*pinned boolean not null default false,*\
*primary key (user_id, thread_id)*\
*);*\
\
*commit;*\

**DynamoDB (ephemeral & rate‑limit)**

- *msg_typing* (*pk=thread_id*, *sk=user_id*, TTL 10s).
- *msg_rate* (*pk=user_id*, counters for message starts/hour; burst
  windows).
- *request_pending* (gate caches with TTL for quick pending checks).

**S3 prefixes**

- *threads/{threadId}/attachments/\** (images/proofs/receipts; virus
  scan lambda on upload).
- *threads/{threadId}/cards/\** (rendered PDFs if a card generates a doc
  preview).

## **1.4.4 GraphQL schema (selected)**

**Recommended path:** *api/schema/messaging.graphql*

*enum ThreadKind { INQUIRY BOOKING STUDIO INVITE SUPPORT }*\
*enum MessageKind { TEXT IMAGE FILE CARD }*\
*enum RequestStatus { PENDING ACCEPTED DECLINED BLOCKED EXPIRED }*\
\
*type Thread {*\
*id: ID!, kind: ThreadKind!, subject: String, orderId: ID,*\
*participants: \[Participant!\]!, lastMessageAt: AWSDateTime,
unreadCount: Int*\
*}*\
\
*type Participant { userId: ID!, role: String, status: String,
lastReadAt: AWSDateTime, mutedUntil: AWSDateTime }*\
\
*type Message {*\
*id: ID!, kind: MessageKind!, bodyText: String, cardType: String,
cardPayload: AWSJSON,*\
*attachment: AWSJSON, senderUser: ID!, createdAt: AWSDateTime!,
editedAt: AWSDateTime*\
*}*\
\
*type MessageRequestGate { id: ID!, threadId: ID!, targetUser: ID!,
status: RequestStatus!, expiresAt: AWSDateTime, reason: String }*\
\
*input SendTextInput { threadId: ID!, bodyText: String! }*\
*input SendFileInput { threadId: ID!, fileName: String!, contentType:
String! } \# returns presigned URL*\
*input CreateThreadInput { kind: ThreadKind!, subject: String, toUserId:
ID, orderId: ID }*\
*input AcceptGateInput { gateId: ID! }*\
*input DeclineGateInput { gateId: ID!, reason: String }*\
*input BlockUserInput { userId: ID!, reason: String }*\
*input CardInput { threadId: ID!, type: String!, payload: AWSJSON! } \#
reschedule, extras, proofs, expense, complete, dispute, safety*\
\
*type Query {*\
*inbox(folder: String, page: Int = 1): \[Thread!\]!*\
*thread(threadId: ID!): Thread!*\
*messages(threadId: ID!, page: Int = 1): \[Message!\]!*\
*requestGate(threadId: ID!, forUserId: ID!): MessageRequestGate*\
*}*\
\
*type Mutation {*\
*createThread(input: CreateThreadInput!): ID!*\
*sendText(input: SendTextInput!): ID!*\
*getFileUploadUrl(input: SendFileInput!): AWSJSON!*\
*sendCard(input: CardInput!): ID!*\
\
*acceptMessageRequest(input: AcceptGateInput!): Boolean!*\
*declineMessageRequest(input: DeclineGateInput!): Boolean!*\
*blockUser(input: BlockUserInput!): Boolean!*\
\
*markRead(threadId: ID!): Boolean!*\
*moveToFolder(threadId: ID!, folder: String!): Boolean!*\
*setMuted(threadId: ID!, until: AWSDateTime): Boolean!*\
*}*\

**Notes**

- **Message Request** flow: a new thread *does not* notify or display
  fully until the recipient **accepts**; preview shows limited
  profile/card. **Decline** closes the gate and moves the thread to
  *Spam*. **Block** creates *user_block* and hides future attempts.
- **Action Cards** are first‑class messages with *cardType* and
  structured *cardPayload* (see §1.4.6).

## **1.4.5 Inbox UX & folders**

- **Folders** (*inbox_index.folder*):

  - **Action Required** --- threads containing pending **Action Cards**
    or **Message Requests** awaiting the user.
  - **Bookings** --- threads linked to confirmed orders or studio
    bookings.
  - **Offers/Requests** --- RTB/Smart Invite negotiations not yet
    confirmed.
  - **Archived** --- user archived.
  - **Spam/Blocked** --- declined/blocked senders; auto‑purged after N
    days.
