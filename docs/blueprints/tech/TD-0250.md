<!-- id: TD-0250 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 900000-904000 -->

ons, experiment exposures) stored as Iceberg tables.
- **Serve**: Athena for ad‑hoc and scheduled reports; Redshift
  Serverless for dashboards with concurrency; QuickSight or Superset for
  BI.
- **Privacy**: Lake Formation governs access; DSAR delete jobs redact
  across all layers.

## **1.21.3 Event envelope v1 (contract)**

**Event key fields (always present):**

*{*\
*\"event_id\": \"evt_01H\...\", // ULID*\
*\"ts\": \"2025-11-06T20:15:23.412Z\",// ISO-8601*\
*\"name\": \"search.query\", // see taxonomy*\
*\"app\": { \"name\":\"web\", \"ver\":\"1.3.2\", \"build\": 4132 },*\
*\"user\": { \"user_id\": \"usr\_\...\", \"anon_id\": \"a\_\...\",
\"role\": \"buyer\|provider\|null\" },*\
*\"session_id\": \"s\_\...\", // 30-min inactivity timeout*\
*\"device\": { \"ua\":\"\...\", \"os\":\"\...\", \"model\":\"\...\",
\"lang\":\"en-US\" },*\
*\"geo\": { \"country\":\"US\", \"region\":\"CA\", \"city\":\"Los
Angeles\" }, // coarse, from IP*\
*\"page\": { \"path\":\"/los-angeles/photographers\",
\"ref\":\"https://\...\" },*\
*\"campaign\": {*\
*\"utm_source\":\"digest\|alert\|search\|referral\|sharecard\|\...\",
\"utm_medium\":\"email\|inapp\|web\|cpc\",*\
*\"utm_campaign\":\"book_again_30\|city_digest\|\...\",*\
*\"click_token\":\"ct\_\...\" // §1.16 HMAC token; optional*\
*},*\
*\"payload\": { } // event-specific JSON (see taxonomy)*\
*}*\

**PII Policy:** never include raw email/phone in events; use **user_id**
and hashed IDs. Redact free‑text for known PII patterns at ingest.

## **1.21.4 Event taxonomy (non‑exhaustive core)**

**Identity/session**

- *app.start*, *app.end*, *session.start*, *session.end*,
  *consent.update* (marketing consent flags).

**Discovery** *(§1.18)*

- *search.query* *{ q, filters, sort, results }*
- *search.result_click* *{ hit_id, rank, scope }*
- *suggest.view* *{ scope, q, items }*

**Profile/Studio views** *(§1.7, §1.19)*

- *profile.view* *{ profile_id, role, verified }*
- *studio.view* *{ studio_id, verified }*

**Messaging & Actions** *(§1.4, §1.14)*

- *thread.open* *{ thread_id, counterpart_role }*
- *action_card.open\|complete* *{ kind, order_id, delta }*

**Checkout & orders** *(§1.13--§1.14)*

- *checkout.start* *{ order_id, context: \"person\|studio\",
  subtotal_cents }*
- *checkout.payment_succeeded* *{ order_id, amount_cents, method }*
- *checkout.abandon* *{ order_id, step }*

**Growth & referrals** *(§1.16)*

- *growth.alert.open\|click*, *digest.open\|click*, *book_again.click*
- referral.invite\|accept\|award\|clawback

**SEO & content** *(§1.17, §1.20 help)*

- *landing.view* *{ city, role }*
- *help.view* *{ slug }*, *help.feedback* *{ slug, helpful }*

**Support & disputes** *(§1.15)*

- *support.case.open\|assign\|resolve*,
  *refund.proposed\|succeeded\|failed*
- chargeback.open\|submit\|closed

**Experiments** *(§1.16 experimentation hooks)*

- *exp.view* *{ exp_id, var }* fired once per surface per session
- *exp.convert* *{ exp_id, order_id? }* on primary outcome

## **1.21.5 Identity graph & stitching rules**

- **Keys**: *user_id* (auth), *anon_id* (cookie or device), *device_fp*
  (fingerprint hash), *session_id*.

- **Stitch**: when a user logs in, we write *identity.link* *{ user_id,
  anon_id, device_fp }*.

- **Resolution**: nightly job produces *dim_identity*:

  - *identity_id* (stable)
  - latest *user_id* if known
  - set of *anon_ids*, *device_fps*
  - derived attributes: first_seen, last_seen, role, country

**DSAR**: when a delete arrives, drop all rows where *user_id* matches
and obfuscate remaining rows referencing the same *anon_ids/device_fps*
(replace with tombstones).

## **1.21.6 Ingest & storage --- paste‑ready IaC/DDL**

**S3 layout**

*s3://analytics/*\
*raw/event_dt=YYYY-MM-DD/HH/evt-\*.ndjson \# Bronze (WORM)*\
*silver/events/iceberg/\... \# Iceberg tables by event family*\
*gold/{fact_sessions,fact_orders,\...}/\... \# dbt models*\

**Athena/Iceberg DDL (Silver) --- events supertable**

*CREATE TABLE IF NOT EXISTS lake.events*\
*(*\
*event_dt date,*