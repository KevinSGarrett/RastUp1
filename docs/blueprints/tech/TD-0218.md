<!-- id: TD-0218 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 784800-788800 -->

/policy snapshotting,
    timeline append, idempotency & locking.
  - **Cards Service**: create/respond/close per card type; fan‑out to
    Calendar (§1.12), Payments (§1.13), Media (§1.11), Notifications
    (§1.10), Reviews window (§1.9).
  - **Calendar**: holds for reschedule proposals; confirm events on
    acceptance.
  - **Payments**: captures, partial refunds, transfer reversals;
    reserves freeze/unfreeze.
  - **Media**: proof galleries; deliverables after completion.
  - **Notifications**: *card.requested.\**, *card.expiring.\**,
    *card.closed.\** with Quiet Hour exceptions when close to start
    (§1.10).

- Storage

  - **Aurora (schema** ***ord*****)** for order, timeline, action cards,
    responses, locks.
  - **Dynamo** for optimistic locks, idempotency keys
    (*order:card:type:nonce*), short‑lived counters.
  - **S3** for card attachments (via Media pipeline §1.11).

- **Events**:
  *order.created\|confirmed\|in_progress\|completed\|cancelled*, plus
  *card.\** events for observability and search.

## **1.14.3 Data model --- paste‑ready DDL (*****db/migrations/022_orders_cards.sql*****)**

*begin;*\
\
*create schema if not exists ord;*\
\
*create type ord.order_state as enum (*\
*\'created\',\'authorized\',\'confirmed\',\'in_progress\',\'completed\',\'cancelled\',\'disputed\',\'closed\'*\
*);*\
\
*create table ord.order (*\
*order_id text primary key, \-- ord\_\...*\
*buyer_user_id text not null,*\
*provider_user_id text not null,*\
*role_code text not null, \-- model\|photographer\|\...*\
*start_utc timestamptz not null,*\
*end_utc timestamptz not null,*\
*timezone text not null,*\
*location_json jsonb not null default \'{}\', \-- {city, lat, lng,
address?}*\
*policy_snapshot jsonb not null, \-- cancel/refund policy at time of
quote*\
*price_snapshot jsonb not null, \-- line items/fees/taxes snapshot from
§1.13*\
*state ord.order_state not null default \'created\',*\
*created_at timestamptz default now(),*\
*updated_at timestamptz default now()*\
*);*\
\
*\-- Timeline: immutable event stream*\
*create table ord.timeline_event (*\
*event_id text primary key, \-- tev\_\...*\
*order_id text not null references ord.order(order_id) on delete
cascade,*\
*kind text not null, \-- \'system\|card\|payment\|calendar\|note\'*\
*subtype text not null, \-- e.g.,
\'order.confirmed\',\'card.reschedule.proposed\'*\
*actor_user_id text, \-- null if system*\
*payload jsonb not null default \'{}\',*\
*created_at timestamptz default now()*\
*);*\
\
*\-- Action Cards (typed via enum + payload)*\
*create type ord.card_type as enum
(\'reschedule\',\'extras\',\'proofs\',\'expense\',\'complete\',\'dispute\');*\
*create type ord.card_state as enum
(\'open\',\'accepted\',\'declined\',\'expired\',\'cancelled\',\'superseded\',\'closed\');*\
\
*create table ord.card (*\
*card_id text primary key, \-- acd\_\...*\
*order_id text not null references ord.order(order_id) on delete
cascade,*\
*type ord.card_type not null,*\
*state ord.card_state not null default \'open\',*\
*created_by text not null, \-- user id*\
*due_at timestamptz, \-- e.g., reschedule acceptance deadline*\
*expires_at timestamptz, \-- card auto-closes if not acted on*\
*superseded_by text references ord.card(card_id) on delete set null,*\
*payload jsonb not null, \-- type-specific (see §1.14.6 schemas)*\
*created_at timestamptz default now(),*\
*updated_at timestamptz default now()*\
*);*\
\
*\-- Responses (e.g., accept/decline/changes requested)*\
*create table ord.card_response (*\
*response_id text primary key, \-- acr\_\...*\
*card_id text not null references ord.card(card_id) on delete cascade,*\
*responder_user_id text not null,*\
*action text not null, \--
\'accept\',\'decline\',\'counter\',\'approve\',\'request_changes\',\'upload\'*\
*payload jsonb not null default \'{}\',*\
*created_at timestamptz default now()*\
*);*\
\
*\-- Lightweight optimistic locking per order (for concurrent cards)*\
*create table ord.order_lock (*\
*order_id text primary key references