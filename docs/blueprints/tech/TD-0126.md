<!-- id: TD-0126 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 453600-457600 -->

:\"int32\",\"facet\":true},*\
*{\"name\":\"amenities\",\"type\":\"string\[\]\",\"facet\":true},*\
*{\"name\":\"priceFromCents\",\"type\":\"int64\",\"facet\":true},*\
*{\"name\":\"priceToCents\",\"type\":\"int64\",\"facet\":true},*\
*{\"name\":\"sizeSqFt\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"recencyScore\",\"type\":\"float\"},*\
*{\"name\":\"engagementScore\",\"type\":\"float\"},*\
*{\"name\":\"bookingScore\",\"type\":\"float\"},*\
*{\"name\":\"updatedAt\",\"type\":\"int64\"},*\
*{\"name\":\"createdAt\",\"type\":\"int64\"}*\
*\],*\
*\"default_sorting_field\": \"updatedAt\"*\
*}*\
*\]*\
*}*\

## **1.21.B Ingest & indexing pipeline**

**Sources:** Aurora (entities), S3 (SFW previews/derived tags),
computed‑signals service.

**Flow:** publish/edit/booking → **Kinesis change topic** → **Indexer
Lambda** → Typesense *upsert*.

**Recommended path:** *search/events/entity-change.json*

*{ \"kind\":\"entity.updated\", \"entity\":\"person\|studio\",
\"id\":\"sp\_\...\|st\_\...\",
\"reason\":\"publish\|edit\|review\|booking\|availability\",
\"ts\":\"2025-11-06T15:10:01Z\" }*\

**Recommended path:** *search/indexer/indexer.ts*

*for (const evt of stream) {*\
*const base = await loadEntity(evt.entity, evt.id);*\
*const signals = await computeSignals(evt.entity, evt.id);*\
*const doc = toSearchDocument(base, signals); // SFW-only*\
*await typesense.collections(coll(evt.entity)).documents().upsert(doc, {
\'dirty_values\':\'coerce_or_drop\' });*\
*}*\

**Reindex runbook** (alias flip, dual‑write, shadow compare):
*search/runbooks/reindex.md*.

## **1.21.C Query model (ANY/ALL, Safe‑Mode, geo/price)**

Input mirrors §1.16's saved‑search format:

*{*\
*\"scope\":\"people\|studios\",*\
*\"city\":\"houston\",*\
*\"any\":\[{\"field\":\"genres\",\"op\":\"in\",\"value\":\[\"fashion\",\"editorial\"\]}\],*\
*\"all\":\[{\"field\":\"priceFromCents\",\"op\":\"between\",\"value\":\[10000,30000\]},{\"field\":\"verified\",\"op\":\"eq\",\"value\":true}\],*\
*\"safeMode\":true,*\
*\"sort\":\"best\|new\|distance\|price_low\|price_high\",*\
*\"origin\":{\"lat\":29.7604,\"lon\":-95.3698}*\
*}*\

- **Safe‑Mode ON:** filter *nsfw_band \<= 1*.
- **Distance:** add *\_distance(lat,lon)* for sort and expose
  *distanceKm* in results.
- **Price:** hard filter via ranges; soft fitness in ranking (below).

## **1.21.D Autocomplete & suggestions**

2108. **Prefix autocomplete** across *displayName/handle/genres/city*
      with typo tolerance.
2109. **Query suggestions** materialized from analytics (last 30 days),
      ranked by CTR and deduped; cached.

**Recommended path:** *search/api/autocomplete.ts*

*export async function autocomplete({ q, scope, city }) {*\
*const params = {*\
*q,*\
*query_by: scope===\'people\' ? \'displayName,handle,genres,city\' :
\'name,amenities,city\',*\
*filter_by: \[\`city:=\${city}\`, \'nsfw_band:\<=1\'\].join(\' && \'),*\
*per_page: 8,*\
*prefix: true,*\
*num_typos: 2*\
*};*\
*return typesense.collections(coll(scope)).documents().search(params);*\
*}*\

**Materialization SQL:** *search/suggestions/materialize.sql* (CTR@30d,
thresholds, limit 2k).

## **1.21.E Ranking & boosts (default "best" sort)**

**People**

*score = 0.25\*rep + 0.20\*recency + 0.15\*engagement +
0.15\*availability*\
* + 0.10\*verifiedBoost + 0.05\*trustedBoost + 0.05\*priceFitness*\
* - 0.10\*distancePenalty*\

**Studios**

*score = 0.30\*booking + 0.20\*recency + 0.15\*engagement*\
* + 0.15\*verifiedBoost + 0.10\*amenityFitness*\
* - 0.10\*distancePenalty*\

Signals are normalized to \[0,1\]. Boosts are **bounded** to avoid
overwhelming organic signals; tie‑breakers: recency, id.

**Spec:** *search/signals/compute.md*
(sigmoid/exp‑decay/gaussian/Jaccard formulas).

## **1.21.F Synonyms, stemming & typo tolerance**

- Domain synonyms (e.g., *"cyclorama" ⇄ "cyc wall"*), city nicknames
  (*"NYC" ⇄ "New York City"*).
- Typos: **2** for terms \>5 chars, **1** for 3--5 chars, exact for ≤2
  chars.
- **Recommended path:** *search/schemas/synonyms.json*.

##