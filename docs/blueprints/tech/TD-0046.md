<!-- id: TD-0046 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 165600-169600 -->

counting, and reconciliation. This section makes our booking money
flows audit‑grade and implementation‑ready across **data model, fee
math, GL entries, APIs, admin tools, telemetry, SLOs, and tests**. It
aligns with §§1.3 (Checkout), 1.4 (Messaging/Project Panel), and 1.7
(Promotions).

We will not advance to §1.10 until §1.9 satisfies your 99.9% bar.

## **1.9.A Canon & invariants**

864. Money in integer cents (UTC timestamps).

865. **One buyer charge per LBG** (already in §1.3), with **per‑leg
     allocations** and **escrow‑like holds** (payouts only on
     completion/acceptance window).

866. **Platform fee ≠ GMV.** Fees are **not** the seller's price; fees
     are separate lines and recognized as **revenue** for the platform
     only when *earned*.

867. **Taxes split correctly**: (a) **service taxes** on the seller's
     service (pass‑through liability to seller or to tax authority
     depending on "merchant‑of‑record" (MoR) configuration), and (b)
     **platform fee taxes** (platform's own tax obligation) --- never
     recognized as revenue.

868. **Two distinct credits**:

     n.  **Ads credits**: for §1.7 promotions (advertiser side).
     o.  **Buyer wallet**: marketplace credits for buyers (refund
         residuals, goodwill, referrals). **These must not mingle.**

869. **Accounting gates**: daily close/reconciliation must be green to
     release payouts (ties to §1.3.V).

870. **Idempotency & lineage everywhere** (PI ids, transfer ids, refund
     ids, ledger ids; stable joins for recon).

## **1.9.B Fee taxonomy (launch)**

Keep MVP simple, configurable in AppConfig. All fees are computed **per
leg** so partial cancels/refunds work cleanly.

- **Marketplace (buyer) fee** --- percentage + floor/ceiling; charged to
  buyer; per‑leg line *platform_fee_cents*.
- **Platform fee tax** --- via tax adapter (city‑aware), per‑leg line
  *platform_fee_tax_cents*.
- **Payment processing fee** --- Stripe fees (variable + fixed);
  *expense* on the platform (not charged to buyer at MVP).
- **Optional seller fee (withheld)** --- **off** at MVP; if enabled
  later, it reduces seller payout and is recognized as revenue when
  earned.
- **Rounding** --- leg‑local, banker's only if tax provider requires;
  otherwise pure cents math.

Result per **leg** at confirmation snapshot:

*buyer_pays_leg_total*\
*= (seller_subtotal + service_tax)*\
* + platform_fee_cents*\
* + platform_fee_tax_cents*\

Totals across legs roll up to **LBG charge amount**.

## **1.9.C Data model (SQL additions for fees, wallet & GL)**

Extends §1.3 schema.

*\-- Per-leg fee snapshot (immutable after confirm; amendments add new
rows)*\
*alter table booking_leg*\
*add column platform_fee_cents int not null default 0,*\
*add column platform_fee_tax_cents int not null default 0;*\
\
*\-- Wallet for BUYERS (not advertisers)*\
*create table wallet_account (*\
*wallet_id text primary key, \-- wlt\_\...*\
*user_id text unique not null, \-- usr\_\...*\
*currency text not null default \'USD\',*\
*balance_cents int not null default 0,*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now()*\
*);*\
\
*create table wallet_txn (*\
*wallet_txn_id text primary key, \-- wtx\_\...*\
*wallet_id text not null references wallet_account(wallet_id) on delete
cascade,*\
*kind text not null check (kind in
(\'credit\',\'debit\',\'adjustment\')),*\
*source text not null check (source in
(\'refund_residual\',\'goodwill\',\'referral\',\'checkout_apply\',\'reversal\')),*\
*lbg_id text,*\
*leg_id text,*\
*amount_cents int not null, \-- positive; sign inferred by kind*\
*note text,*\
*idempotency_key text not null,*\
*created_at timestamptz not null default now()*\
*);*\
*create index on wallet_txn(wallet_id, created_at desc);*\
*create unique index on wallet_txn(idempotency_key);*\
\
*\-- Platform fee ledger (deferrals→earned)*\
*create table fee_ledger (*\
*fee_entry_id text primary key, \-- fle\_\...*\
*leg_id text not null,*\
*stage 