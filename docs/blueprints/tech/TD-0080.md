<!-- id: TD-0080 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 288000-292000 -->

costs.
- **Search**: PPV/creator discovery in Typesense with lean fields (no
  captions in index).

## **1.14.N Error taxonomy (client‑safe)**

- *FANSUB_IDV_REQUIRED* --- user not age‑verified.
- *FANSUB_CREATOR_NOT_PUBLISHED* --- creator page not live.
- *FANSUB_PRICE_OUT_OF_RANGE* --- violates pricing policy.
- *FANSUB_ENTITLEMENT_REQUIRED* --- trying to access locked content.
- *FANSUB_REQUEST_STATE_INVALID* --- bad action order.
- *FANSUB_MEDIA_BLOCKED* --- preview failed safety checks.
- *PAYMENT_FAILED* --- Stripe failure; include retriable hints.

Each error includes *code*, *message*, *hint*, *corrId*.

## **1.14.O Test plan (CI + sandbox)**

**Eligibility & gating**

1503. Creator cannot publish until IDV passed; fan cannot subscribe/buy
      PPV until age‑verified.

**Subscriptions**\
2) Subscribe success → entitlement; invoice failure → status *past_due*;
dunning recovers; cancel resumes access until period end.

**Tips/PPV**\
3) Tip flow success; duplicate/double‑submit idempotent.\
4) PPV buy grants access; re‑buy blocked.

**Requests**\
5) Quote → pay → deliver → approve; revision loop; refund path via
policy.\
6) Action cards in thread reflect state; receipts correct.

**Media**\
7) Previews scanned & watermarked; finals referenced via manifest;
access tokens expire; rate limits enforced.

**Moderation/DMCA**\
8) Flagged preview hidden; DMCA takedown hides content; counter‑notice
restores.

**Analytics**\
9) Events land in Bronze; Silver facts & Gold KPIs update; NRT views
show earnings/backlog.

**Performance/cost**\
10) p95 entitlement check ≤ 60 ms (cached); preview loads ≤ 200 ms from
CF; Stripe webhooks idempotent; storage/egress within budget alarms.

## **1.14.P Work packages (Cursor 4‑agent lanes)**

- **Agent C --- Domain/API**\
  WP‑FS‑01: SQL for *fansub\_\** tables; GraphQL resolvers; entitlement
  cache.\
  WP‑FS‑02: Action cards for requests; tie‑ins to §1.4 flows; receipts &
  lineage.
- **Agent B --- Payments/Taxes**\
  WP‑FS‑PAY‑01: Stripe Billing subs; PPV/tips PaymentIntents; Connect
  payouts; tax adapter lines.\
  WP‑FS‑PAY‑02: Webhooks normalization (*invoice.\**,
  *payment_intent.\**, *charge.\**) + idempotency.
- **Agent A --- Web**\
  WP‑FS‑WEB‑01: Creator page, PPV catalog, subscribe/tip/buy flows;
  thread UI for requests.\
  WP‑FS‑WEB‑02: Watermarked preview renderer; entitlement‑aware media
  components.
- **Agent D --- Safety/Admin/QA**\
  WP‑FS‑SAFE‑01: NSFW scan + watermarking pipeline; anticircumvention in
  captions.\
  WP‑FS‑ADM‑01: DMCA/moderation/finance consoles; audits.\
  WP‑FS‑QA‑01: Full test matrix automation; synthetic earnings reports.

## **1.14.Q Acceptance criteria (mark §1.14 FINAL only when ALL true)**

1508. Age‑gated eligibility enforced; creators with IDV can publish;
      fans 18+ can pay.
1509. Subscriptions, tips, PPV, and requests work end‑to‑end with
      receipts, taxes, and payouts.
1510. Media pipeline (previews vs finals) functions with watermarking,
      safety scans, and access tokens; no finals stored internally.
1511. Messaging action cards cover the entire request lifecycle;
      approvals & revisions audited.
1512. Moderation & DMCA tooling live; anticircumvention active;
      violations audited.
1513. Dashboards & NRT views show earnings/churn/backlog; experiments
      and guardrails instrumented.
1514. Cost posture holds (previews only, limited HLS, caching); p95
      performance targets met.

# **§1.14 --- Fan‑Sub (Paid Content, Requests, Tips & PPV) --- Expanded Spec**

This augments the earlier §1.14 with **implementation‑grade detail**:
exact Stripe object mappings, state machines, watermarking/preview
specs, entitlement tokens, manifest contracts, moderation & DMCA flows,
tax/fee math, GL entries, comms templates, errors, and runbooks.

## **1.14.1 Roles, gates, and global invariants (recap + expansions)**

- **Eligibility gates** (server‑enforced before any Fan‑Sub surface or
  API):

  - **Age**: both creator and fan must have