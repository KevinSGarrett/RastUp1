<!-- id: TD-0036 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 129600-133600 -->

ssions, clicks, CPC,
  charges, credits, net spend.

**Phase‑up (optional): Stripe Billing metered**

- Create a metered product *promoted_click*; report usage daily; Stripe
  invoices monthly (postpaid).
- Keep **internal ledger** regardless for exact traceability and fraud
  credits.

**Tax on ad fees**

- If applicable by jurisdiction, apply sales tax to **ad
  purchases/top‑ups** (separate from marketplace taxes). Use the same
  tax adapter.

**Accounting separation**

- Ad revenue is **non‑GMV**; in analytics, keep separate revenue streams
  and costs to avoid inflating marketplace take.

## **1.7.J GraphQL API (seller‑facing & admin)**

*\# Seller APIs*\
*type Campaign {*\
*campaignId: ID!*\
*name: String!*\
*status: String!*\
*surface: String!*\
*format: String!*\
*targetEntityId: ID!*\
*cities: \[String!\]!*\
*cpcCents: Int!*\
*dailyBudgetCents: Int!*\
*totalBudgetCents: Int*\
*spendTodayCents: Int!*\
*spendTotalCents: Int!*\
*}*\
\
*type CampaignStats {*\
*campaignId: ID!*\
*date: AWSDate!*\
*impressions: Int!*\
*clicks: Int!*\
*ctr: Float!*\
*avgCpcCents: Int!*\
*invalidClicks: Int!*\
*creditsCents: Int!*\
*}*\
\
*type Query {*\
*myCampaigns: \[Campaign!\]!*\
*campaignStats(campaignId: ID!, from: AWSDate!, to: AWSDate!):
\[CampaignStats!\]!*\
*adBalance: Int! \# current prepaid credits*\
*}*\
\
*input CampaignInput {*\
*targetEntityId: ID!*\
*surface: String!*\
*format: String!*\
*cities: \[String!\]!*\
*cpcCents: Int!*\
*dailyBudgetCents: Int!*\
*totalBudgetCents: Int*\
*keywords: \[String!\]*\
*startDate: AWSDate!*\
*endDate: AWSDate*\
*}*\
\
*type Mutation {*\
*createCampaign(input: CampaignInput!): Campaign!*\
*updateCampaign(campaignId: ID!, input: CampaignInput!): Campaign!*\
*pauseCampaign(campaignId: ID!): Campaign!*\
*resumeCampaign(campaignId: ID!): Campaign!*\
*topUpAdCredits(amountCents: Int!): Boolean!*\
*}*\
\
*\# Admin APIs*\
*type Mutation {*\
*setPromoPolicy(surface: String!, role: String, city: String!,
cpcFloorCents: Int!, maxDensityTop20: Int!, maxAboveFold: Int!):
Boolean!*\
*suspendCampaign(campaignId: ID!, reason: String!): Boolean!*\
*issuePromoCredit(campaignId: ID!, amountCents: Int!, reason: String!):
Boolean!*\
*}*\

**Server guards**

- *createCampaign* validates eligibility, floors (*cpc_cents \>=
  cpc_floor*), and city allowlists; seeds pacing counters.
- *topUpAdCredits* creates a Stripe PaymentIntent and writes a *topup*
  ledger entry on success.

## **1.7.K Admin consoles**

- **Policy board**: edit *cpc_floor* and density caps by city/role;
  publish with two‑person approval; rollback versions.
- **Campaign review**: search/suspend/restore; see trust posture and
  rule hits; city coverage visual.
- **Fraud dashboard**: invalid click streams, IP/FP heatmaps,
  auto‑pauses, and make‑good credits.
- **Billing**: top‑ups, balances, monthly statements; export CSVs;
  reconciliation status against Stripe.

All actions are audited (actor, reason, before/after).

## **1.7.L Telemetry & reconciliation**

**Events**

- promo.campaign.create\|activate\|pause\|resume\|end\|suspend
- *promo.policy.update* (with version)
- *promo.impression*, *promo.click*, *promo.invalid_click*
- *promo.spend.debit*, *promo.credit.issue*,
  *promo.topup.charge.succeeded\|failed*
- promo.recon.variance.notice

**Recon jobs (daily)**

- Compare **Σvalid_clicks × CPC** to **Σledger.spends**; verify against
  Stripe top‑ups/invoices.
- Variance \> threshold gates campaign serving in affected city until
  resolved (flag‑gated).

## **1.7.M Error taxonomy (client‑safe)**

- *PROMO_ELIGIBILITY_FAILED* --- trust, completeness, or policy not met.
- *PROMO_CPC_BELOW_FLOOR* --- CPC under city/role floor.
- *PROMO_BUDGET_EXHAUSTED* --- daily/total budget hit.
- *PROMO_INVALID_CITY* --- city not allowlisted.
- *PROMO_PAYMENT_FAILED* --- top‑up failed.
- *PROMO_SUSPENDED* --- admin or auto policy suspension.
- *PROMO_CLICK_INVALIDATED* --- click rejected; user is never shown
  this, used in logs/analytics.

## **1.7.N Perfo