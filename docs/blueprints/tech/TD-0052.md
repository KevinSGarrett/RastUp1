<!-- id: TD-0052 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 187200-191200 -->

r* to preserve stable batches during paging.

**S3:**

- *comms-rendered/...* stores immutable HTML bodies & PDFs (statements)
  referenced by *comms_message.body_rendered_s3*.

## **1.10.D Template system & variables**

- **Authoring**: Email uses **MJML** → compiled to inline‑styled HTML.
  SMS uses strict text length (truncate & link to in‑app). Push uses
  *{title, body, data}*. In‑app stores *{title, body, deep_link}*.
- **Variables**: Declared in *variables_json* with type, description,
  and required flag. Types: *string*, *int*, *money_cents*, *date*,
  *datetime*, *duration*, *enum{...}*, *url*.
- **Localization**: Templates can exist per *locale* (start with
  *en-US*). Fallback: *en-US* if no locale‑specific template.

**Core templates (MVP, examples)**

- Booking lifecycle: *booking_confirmed_buyer*,
  *booking_confirmed_seller*, *booking_rescheduled*,
  *booking_cancellation_outcome*.
- Docs: *doc_sign_request*, *doc_sign_reminder*, *doc_complete*.
- Payments: *charge_receipt*, *refund_receipt*, *payout_queued*,
  *payout_paid*, *statement_ready*.
- Messaging: *new_message_digest*, *deliverable_posted*,
  *review_reminder*.
- Trust: *idv_start*, *idv_reminder*, *bg_invited*, *badge_awarded*.
- Promotions: *promo_low_balance*, *promo_statement_ready*.

*(I can include full MJML bodies upon request; they're verbose.)*

**Variable resolution**

- Resolver library maps domain objects → template variables (e.g., leg
  dates in local timezone, names, amounts with currency formatting, doc
  links with signed URLs).
- Hard **PII minimization**: SMS never includes full names + addresses +
  money in the same text; use in‑app deep links.

## **1.10.E Routing rules (Comms Router)**

**Input**: domain event *{name, user_id(s), cause_ref, payload}*.

**Steps**

952. **Select template(s)** for event + role (buyer/seller/admin).
953. **Apply preferences** and **quiet hours** for the recipient (skip
     or schedule).
954. **Dedupe** using *dedupe_key* (e.g., *THREAD:{id}:{minute}* for
     rapid message bursts; *BOOKING:{lbg}:{state}*).
955. **Batch**: gather multiple low‑priority items into digest (e.g.,
     daily message digest).
956. **Render** with locale detection; push to channel queues with
     idempotency keys.

**Critical overrides**

- Security, legal, receipts ignore quiet hours and opt‑out (except SMS
  jurisdiction where consent is required---then fallback to
  email/in‑app).
- If a channel is suppressed (hard bounce/complaint), auto‑fallback to
  in‑app + email to an alternate verified address (if present).

## **1.10.F Preferences & quiet hours (user‑facing)**

**Categories (initial)**

- *security* (critical), *legal* (critical), *booking*, *messages*,
  *reviews*, *promotions* (marketing), *finance* (receipts/statements).

**Defaults**

- Email: opt‑in for all except *promotions* (opt‑out default ON).
- Push: opt‑in for *booking*, *messages*, *reviews* only after device
  grants permission.
- SMS: **opt‑out by default**; explicit opt‑in per category where used
  (*booking* status or *security*).
- In‑app: always on; controlled by red dot/unread.

**Quiet hours**

- Store *tz*, *start_local*, *end_local*.
- Router schedules non‑critical notifications inside allowed windows
  (e.g., 8 am--9 pm local).
- Per‑category overrides (e.g., allow *booking* during quiet hours).

**GraphQL API (user settings)**

*type CommsPreference {*\
*channel: String!*\
*categoryKey: String!*\
*optedIn: Boolean!*\
*updatedAt: AWSDateTime!*\
*}*\
\
*type QuietHours { tz: String!, startLocal: String!, endLocal: String!
}*\
\
*type Query {*\
*commsPreferences: \[CommsPreference!\]!*\
*quietHours: QuietHours*\
*}*\
\
*type Mutation {*\
*setCommsPreference(channel: String!, categoryKey: String!, optedIn:
Boolean!): \[CommsPreference!\]!*\
*setQuietHours(tz: String!, startLocal: String!, endLocal: String!):
QuietHours!*\
*unsubscribeAllEmail(): Boolean! \# sets all email categories to
optedIn=false except critical*\
*}*\

**List‑Unsubscribe