<!-- id: TD-0018 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 64800-68800 -->

ty allowlists; **Promotions** density caps; eligibility toggles;
  invalid-click credits.

**RBAC**: least-privilege by role; JIT elevation for sensitive ops;
**immutable audits** on every admin action.

## **1.3.X Error & Incident Playbook (selected)**

- **PI fail after docs** → user sees *CHK_ATOMIC_FAIL*; LBG remains
  awaiting payment; guide to retry or change method.
- **ACH return** → auto-notify; re-attempt as allowed; payouts halted
  until resolution.
- **Payout failed** → retry; if repeated, set *paused* and notify
  Finance; show Seller banner.
- **Recon gate** → payouts paused; visible banner in Admin; action
  required to unpause.
- **Deposit claim abuse** → T&S review; throttle studio claims; require
  additional evidence.

## **1.3.Y Full E2E Test Matrix (implement in CI + sandbox)**

**Booking & Payment**

368. Single-leg, card.
369. LBG, card + studio deposit auth.
370. Single-leg, ACH (settlement wait).
371. 3DS challenge.
372. Atomic failure → no charge.
373. Retry with different method.

**Docs & Receipts**\
7. Doc pack gating; signatures required; hashes on receipts.\
8. PDF receipts (leg + group), immutable & downloadable.

**Amendments**\
9. Change order pre-session → delta math & tax.\
10. Overtime during session → incremental capture/new PI, receipts
updated.

**Cancellations/Refunds**\
11. Provider cancel → full refund to buyer.\
12. Buyer cancel across 72h/48h/12h bands.\
13. Partial LBG cancel (one leg only).

**Acceptance & Payouts**\
14. Buyer accept → payouts queued; reserve applied.\
15. Auto-accept → payouts queued.\
16. Instant payout allowed vs denied (risk).\
17. Payout webhook sync to *paid*.

**Disputes**\
18. Dispute open → evidence build → submit → won.\
19. Dispute lost → clawback; receipts/Gold reflect.

**Recon & Close**\
20. Daily close green.\
21. Inject small variance → payouts paused → adjustment → green.\
22. Webhook duplication → idempotent handling.

**Performance**\
23. Checkout p95 \< 2s with tax/3DS mix.\
24. Payout queue drain \< 15 min on completion spikes.

**Cost**\
25. Renderer throttling; OpenSearch/Typesense calls within budget;
Stripe/Tax cost alarms quiet.

## **1.3.Z Acceptance Criteria --- mark §1.3 FINAL only when ALL true**

374. **Atomic LBG**, **Docs-before-Pay**, **Deposits**, **Amendments**,
     **Refunds**, **Disputes**, **Payouts/Reserves**, **Acceptance
     Window** all function as specified.
375. Receipts (leg + group) include line items, taxes, doc hashes,
     amendments, refunds, payouts.
376. Scheduler/Step Functions drive end-to-end state reliably; retries
     are idempotent.
377. Finance **daily close** runs green for 5 consecutive days;
     variances gate payouts correctly.
378. Admin consoles (Finance/Support/Trust/City Ops) provide the actions
     above with immutable audits and dual approvals where required.
379. Telemetry is complete (events listed across 1.3); observability
     dashboards green.
380. p95 **Checkout ≤ 2s**, payout drain ≤ 15m, and costs stay within
     budget alarms.
381. The **full E2E test matrix** passes in CI and sandbox
     (card/ACH/3DS/atomic/cancel/dispute/recon).

# **§1.4 --- Messaging & Project Panel (threads, action cards, deliverables, approvals)**

**Goal.** Implement a role‑aware, booking‑aware messaging system with a
**Project Panel** embedded in the conversation: briefs, moodboard, shot
list, files (previews + external manifests), docs & e‑sign status,
expenses/amendments, and one‑click **action cards** (reschedule, extras,
overtime, deliverable approvals, deposit claims, dispute/report). This
section gives the **full technical spec**---data models, APIs, realtime
behavior, file pipeline, moderation/safety rules, notifications, admin
tooling, telemetry, SLOs, tests, and cost levers.

We will not move to §1.5 until §1.4 hits your **99.9% coverage** bar.

## **1.4.A Canon & invariants**

- Thread kinds.

  - **Inquiry thread** (pre‑booking; can transition into a project on
    accept).
  - **Project thr