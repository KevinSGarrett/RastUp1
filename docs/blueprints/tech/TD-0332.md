<!-- id: TD-0332 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1195200-1199200 -->

hard delete older than 18m; mask newer if retention
window not yet elapsed*\
*DELETE FROM messages WHERE sender_id = p_user_id AND created_at \<
now() - interval \'18 months\';*\
*UPDATE messages SET body_ciphertext = decode(\'\', \'hex\') WHERE
sender_id = p_user_id;*\
\
*\-- reviews: keep stars, anonymize author reference*\
*UPDATE reviews SET author_id = governance.pseudonymize_uuid(author_id)
WHERE author_id = p_user_id;*\
\
*\-- search/outbox: clean derived*\
*DELETE FROM search.outbox WHERE payload-\>\>\'entity_id\' =
p_user_id::text;*\
\
*\-- audit*\
*INSERT INTO dsar_audit(user_id, action, at) VALUES (p_user_id,
\'anonymize\', now());*\
*END;*\
*\$\$;*\

**Propagation hooks**: After *anonymize_user*, publish an event to:

- **Typesense** indexer (delete/upsert),
- **S3 purge queue** for media,
- **Cache invalidation**.

### **O.3.3 DynamoDB TTL**

For *abuse_events*, *rate_limits*, set item‑level TTL:

*{*\
*\"TableName\": \"abuse_events\",*\
*\"TimeToLiveSpecification\": { \"Enabled\": true, \"AttributeName\":
\"ttl_epoch\" }*\
*}*\

### **O.3.4 S3 lifecycle & Object Lock**

**Lifecycle** (paste to bucket policy):

*{*\
*\"Rules\": \[*\
*{ \"ID\":\"orig-transitions\", \"Status\":\"Enabled\",*\
*\"Filter\": { \"Prefix\": \"uploads/\" },*\
*\"Transitions\": \[*\
*{ \"Days\": 30, \"StorageClass\":\"STANDARD_IA\" },*\
*{ \"Days\": 90, \"StorageClass\":\"GLACIER\" }*\
*\],*\
*\"Expiration\": { \"Days\": 365 }*\
*},*\
*{ \"ID\":\"sfw-expire\", \"Status\":\"Enabled\",*\
*\"Filter\": { \"Prefix\": \"sfw/\" }, \"Expiration\": { \"Days\": 180
}*\
*}*\
*\]*\
*}*\

**Object Lock (governance)** on originals bucket (configured once),
prevents destructive deletes without break‑glass.

### **O.3.5 CloudWatch/Provider log retention**

- **App logs**: 30 days.
- **WAF/CloudFront logs**: 90 days in S3, then Glacier.
- **Email provider logs**: 90 days.
- IaC sets *retentionDays* in CDK for each log group.

## **O.4 Consent & preferences ledger**

**Table** ***consent_events*** (append‑only, WORM S3 export monthly):\
*id, user_id, type (tos\|privacy\|marketing), source (web\|api),
version, value (true\|false), at, ip, ua, evidence (hash)*.

**API rules**

- Changing marketing opt‑in persists a **consent_events** row and
  updates *users.consent_state*.
- All emails honor suppression list.
- DSAR exports include **consent_events** subset for the requester.

## **O.5 DSAR workflows (export & delete)**

### **O.5.1 Export (T‑24h SLA)**

Steps:

5653. Verify identity (fresh login + email OTP).
5654. Queue job *dsar.export.requested(user_id)*.
5655. Gather: *users*, *profiles*, *orders* (with redaction), *payments*
      tokens, *messages* (≤ 18m), *media* metadata, *consent_events*,
      *reviews*.
5656. Package as *zip* with JSON files + README, store for 7 days in a
      **private, expiring** S3 URL.
5657. Log into *dsar_audit*.

**Sample export manifest
(*****governance/dsar/export_manifest.json*****)**

*{*\
*\"users\":
\[\"id\",\"email\",\"display_name\",\"city\",\"country\",\"created_at\"\],*\
*\"profiles\":
\[\"user_id\",\"headline\",\"bio\",\"tags\",\"price_min\",\"price_max\"\],*\
*\"orders\":
\[\"id\",\"status\",\"created_at\",\"total\",\"buyer_id\",\"seller_id\"\],*\
*\"messages\":
\[\"id\",\"thread_id\",\"created_at\",\"body_plaintext_redacted?\"\],*\
*\"media_assets\": \[\"id\",\"sfw_s3_key\",\"created_at\"\],*\
*\"consent_events\": \[\"type\",\"value\",\"version\",\"at\"\]*\
*}*\

### **O.5.2 Delete (T‑30d SLA)**

- Execute *governance.anonymize_user(user_id)* (above).
- Asynchronous **purge** for media and Typesense; invalidate caches;
  evidence to *dsar_audit*.
- **Legal holds** override delete (e.g., active disputes); status
  communicated to user.

## **O.6 Lineage & cataloging**

- **Operational → Derived:**\
  Aurora (OLTP) → EventBridge → (optional) S3 data lake
  (raw/staged/curated) → Athena/QuickSight dashboards.
- **Catalog**: Glue Data Catalog tables tagged with *class*, *pii*,
  *regime* (table & column propertie