<!-- id: TD-0135 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 486000-490000 -->

ping(threadId: ID!, on: Boolean!): Boolean!*\
*markRead(threadId: ID!, upToTs: AWSDateTime!): Boolean!*\
*acceptRequest(threadId: ID!): Boolean!*\
*declineRequest(threadId: ID!, reason: String): Boolean!*\
*blockUser(userId: ID!, reason: String): Boolean!*\
*reportMessage(messageId: ID!, reason: String!, detail: String):
Boolean!*\
*}*\
\
*input AttachmentInput { key: String!, mime: String!, bytes: Int!,
thumbKey: String }*\
*type Subscription {*\
*onThreadEvent(threadId: ID!): Message! \@aws_subscribe(mutations:
\[\"sendMessage\"\])*\
*}*\

**Mapping:** Types, statuses, and action cards mirror the non‑tech
definitions and project panel contents.

NonTechBlueprint

## **1.23.4 Realtime Delivery, Receipts & Typing**

- **Transport:** AppSync subscriptions (WebSocket).
- **Delivery states:** server writes *DELIVERED* state‑messages for
  recipients online; **read‑receipts** are explicit *markRead()*
  mutations that upsert *STATE* messages for *READ*. This maps to "sent
  ✓, delivered ✓✓, read ✓✓ filled."

NonTechBlueprint

- **Typing:** ephemeral *STATE TYPING_ON/OFF* messages with TTL (15s),
  not persisted in Aurora.

**Lambda fan‑out:** Kinesis stream from *msg_messages* → Lambda → push
(Pinpoint) when user offline; quiet hours respected (§1.20).

## **1.23.5 Message Requests, Credits & Contact Filters**

- **Requests:** First‑time contacts to a user route to *REQUESTS* until
  accepted; the inbox shows a separate **Requests** folder. Accept moves
  to normal inbox; Decline keeps a passive block entry.

NonTechBlueprint

- Credits:

  - Ledger *message_credit_ledger* grants **monthly "new conversation"
    credits** (amount configurable). Spending 1 credit allows
    *startConversation*. **Replies** do not consume credits; **booking
    threads** are exempt (unlimited).

NonTechBlueprint

- **Contact filters:** Enforce per recipient settings: **ID‑verified
  only**, **budget disclosed**, **date provided**. If unmet, present an
  **Action Card** form to collect missing fields before allowing send.

NonTechBlueprint

## **1.23.6 Action Cards (Structured Forms in Chat)**

Implements the non‑tech Action Cards list and ensures cards trigger the
right domain workflows (booking update, add‑on, dispute, etc.).

NonTechBlueprint

- **ProposeTime/Reschedule:** writes a pending booking change request;
  recipient can **Accept/Counter/Decline** → updates booking schedule.
- **AddExtras/Overtime:** creates draft **order adjustments** (subtotal
  delta) and posts a summary; acceptance updates the order and, if
  needed, collects additional payment (ties to §1.22).
- **UploadProofs/RequestApproval:** uploads to S3 proofs bucket;
  approval marks deliverables accepted; denial loops with comments.
- **ExpenseReceipt:** attaches expense and moves to project finance
  view.
- **MarkCompleted:** flips booking state and triggers transfer
  scheduling (per §1.22).
- **OpenDispute:** creates a **DISPUTE** thread subtype and generates a
  finance hold.
- **ShareLocation:** ephemeral card visible until *until* timestamp.
- **SafetyFlag:** routes to T&S queue with policy tags.

**Validation:** JSON Schemas per card under
*messaging/action-cards/\*.schema.json*.

## **1.23.7 Attachments & Previews (S3 + Safe‑Mode)**

- **Direct‑to‑S3** presigned PUTs; client‑side resize; max size/polices
  from §1.18.G.
- **Virus/NSFW scans** on ingest; thumbnails stored; raw files retained
  per user choice (privacy).
- **Safe‑Mode:** previews in **inbox list** and **message bubbles** are
  SFW thumbnails when Safe‑Mode is ON; full‑res only after user opts
  into Safe‑Mode OFF + verified age. This follows public‑surface policy
  but applies to messaging previews too.

NonTechBlueprint_Part3

## **1.23.8 Inbox Folders, Filters & Search**

- **Folders:** All, Unread, Starred, Inquiries, Invites, **Bookings**,
  **Disputes**, Archived, Spam---exactly as in non‑tech.

NonTechBlueprint

- **Filters:** by Role, Status (Awaiting reply, Payment pending),
  City/Date, Has fil