<!-- id: TD-0129 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 464400-468400 -->

\
*subtotal_cents int not null,*\
*buyer_fee_cents int not null, \-- platform fee charged to buyer*\
*tax_cents int not null default 0,*\
*credit_applied_cents int not null default 0, \-- credits applied to
buyer_fee*\
*status text not null check (status in
(\'draft\',\'authorized\',\'captured\',\'completed\',\'refunded\',\'voided\',\'disputed\')),*\
*booking_dt timestamptz,*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now()*\
*);*\
\
*create table payment_intent (*\
*pi_id text primary key, \-- pi\_\...*\
*order_id text not null references \"order\"(order_id),*\
*stripe_pi text not null, \-- PaymentIntent id*\
*client_secret text not null,*\
*method text not null, \-- \'card\',\'ach\',\'wallet\'*\
*capture_method text not null check (capture_method in
(\'automatic\',\'manual\')) default \'automatic\',*\
*amount_cents int not null,*\
*currency text not null,*\
*status text not null, \--
\'requires_payment_method\',\'succeeded\',\'requires_capture\',\'canceled\'*\
*last_error text,*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now(),*\
*unique (order_id, stripe_pi)*\
*);*\
\
*create table transfer_ledger (*\
*xfer_id text primary key, \-- xfr\_\...*\
*order_id text not null references \"order\"(order_id),*\
*provider_account text not null, \-- acct\_\... (Stripe Connect)*\
*amount_cents int not null,*\
*currency text not null,*\
*stripe_transfer text, \-- tr\_\...*\
*status text not null check (status in
(\'pending\',\'paid\',\'reversed\',\'canceled\')),*\
*created_at timestamptz not null default now()*\
*);*\
\
*create table refund_ledger (*\
*refund_id text primary key, \-- rfd\_\...*\
*order_id text not null,*\
*stripe_refund text,*\
*amount_cents int not null,*\
*reason text not null,*\
*initiator text not null, \--
\'buyer\',\'provider\',\'platform\',\'dispute\'*\
*created_at timestamptz not null default now()*\
*);*\
\
*commit;*\

Separate from the **credit_ledger** in §1.16 (promos/referrals). Card
numbers are never stored---only Stripe ids.

## **1.22.4 Checkout & payment flows**

### **A) Card (default) --- immediate capture**

2150. Create **Order (draft)** → compute totals (apply credit to
      buyer_fee before tax).
2151. Create **PaymentIntent** for *amount = subtotal + buyer_fee + tax
      − credit_applied*.
2152. Confirm PI (Stripe SDK or server) → on success, **capture now**;
      set order = *captured*.
2153. **Transfers** occur after completion (e.g., T+24h) or as per
      policy; platform fee retained.

### **B) Manual capture (short hold)**

- Use *capture_method=\'manual\'* for time‑sensitive bookings.
  **Authorize now**, **capture on completion** (within Stripe's hold
  window). If completion exceeds hold window, re‑authorize or charge
  immediately with a delayed transfer.

### **C) ACH (Phase 2) --- Financial Connections**

- *payment_method_types=\[\'us_bank_account\'\]*; confirm with bank
  link; longer settlement; transfer **after funds clear**.

**Artifact --- GraphQL mutations**\
**Recommended path:** *api/schema/payments.graphql*

*type Order { orderId: ID!, status: String!, amountCents: Int!,
currency: String!, clientSecret: String }*\
*input OrderInput { serviceProfileId: ID!, studioId: ID, packageId: ID!,
date: AWSDateTime!, addons: \[ID!\], currency: String! }*\
\
*type Mutation {*\
*createOrder(input: OrderInput!): Order!*\
*applyCredit(orderId: ID!, amountCents: Int!): Order!*\
*createPaymentIntent(orderId: ID!, method: String!, capture: String):
Order!*\
*confirmOrder(orderId: ID!): Order!*\
*cancelOrder(orderId: ID!, reason: String!): Order!*\
*}*\

## **1.22.5 Stripe Connect onboarding (providers)**

- **Type:** **Express** accounts; Stripe‑hosted onboarding/updates.
- Enable capabilities for payments/transfers; Stripe handles KYC; we
  reflect verification status in UI (*account.updated* webhooks).
- **Payout schedule:** weekly by default; consider T+1/T+7 policy gates
  (see §1.22.11).

**