<!-- id: TD-0199 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 716400-720400 -->

! \@aws_cognito_user_pools*\
*}*\
\
*type Mutation {*\
*setPref(eventKey: String!, channel: NotifyChannel!, enabled: Boolean!):
Boolean! \@aws_cognito_user_pools*\
*setQuietHours(startLocal: String!, endLocal: String!, timezone:
String!, exceptions: \[String!\]): Boolean! \@aws_cognito_user_pools*\
*registerDevice(deviceId: ID!, platform: String!, pushToken: String!):
Boolean! \@aws_cognito_user_pools*\
*markInAppRead(id: ID!): Boolean! \@aws_cognito_user_pools*\
*unsubscribeAll(channel: NotifyChannel!): Boolean!
\@aws_cognito_user_pools*\
*}*\

**Invariants**

- **Required service** messages (security receipts, legal) are always
  on; user cannot disable them per CAN‑SPAM/GDPR norms.
- **Quiet Hours** honor exceptions so time‑critical booking items still
  deliver (see §1.10.8). Your plan explicitly requires DND with silent
  summaries for requests; we implement quiet suppression + digest, plus
  exceptions for urgent events.

NonTechBlueprint

## **1.10.5 Event taxonomy (initial catalog)**

**Booking**: *booking.confirmed*, *booking.rescheduled*,
*booking.reminder_24h*, *booking.reminder_1h*, *booking.completed*,
*booking.cancelled.{buyer\|provider}*,
*booking.review_window_opened\|closing*.\
**Messaging & Cards**: *msg.request.received\|accepted\|declined*,
*card.requested.{reschedule\|extras\|proofs\|expense\|complete\|dispute}*,
*files.uploaded*. These reflect the blueprint list (approvals requested,
reschedule proposal, dispute updates).

NonTechBlueprint

**Payments**: *payment.captured*, *refund.processed*,
*payout.scheduled\|released\|failed*. Payout sent is explicitly listed.

NonTechBlueprint

**Trust & Safety**: *idv.started\|passed\|failed*,
*safety.case.opened\|updated* (ties to §1.5).\
**Support**: *ticket.created\|updated\|resolved* (ties to §1.6).\
**Nudges (optional)**: *onboarding.incomplete*, *portfolio.nudge* (kept
optional/marketing‑off at MVP).

Each entry lives in *notify_event_catalog* with *kind* and default
enablement matching blueprint intent (transactional on by default;
optional requires opt‑in where applicable).

NonTechBlueprint

## **1.10.6 Notification Orchestrator (routing)**

**Flow:**

3242. **Consume event** from bus.
3243. **Build audience** (single user or pair) and gather variables
      (names, local times, deep links, ICS payloads).
3244. **Policy gates**: preferences, **Quiet Hours** window, exceptions.
3245. **Rate‑limit** (optional notices) + **idempotency** check.
3246. **Render** templates (email MJML → HTML; text fallback; push;
      in‑app).
3247. **Send** via SES/Pinpoint or write **in‑app** row + AppSync
      fan‑out.
3248. **Log** to *notify_send_log*.

**ICS attachments**: booking reminders and reschedules include *.ics*
files; your plan calls for **ICS export** as part of MVP.

NonTechBlueprint

## **1.10.7 Templates (email/push/in‑app)**

- Store templates in *notify_template*.
- Compile MJML → HTML at publish time; cache HTML in S3 for low latency.
- Strongly typed **variables** per event (*{buyerName, startTsLocal,
  city, ctaUrl, orderId, providerName}* etc.).
- Localization: *en‑US* at launch; structure supports more locales
  later.
- **No NSFW previews** of media in email/push; link to in‑app instead
  (aligns with Safe‑Mode).

**Example (artifact --- booking confirmation, provider):**

*template_key: booking.confirmed.provider*\
*locale: en-US*\
*subject: Your booking with {{buyerName}} is confirmed ---
{{startTsLocal}}*\
*mjml: \<mjml\>\<mj-body\>\<mj-section\>\<mj-column\>*\
*\<mj-text\>Hi {{providerName}},\</mj-text\>*\
*\<mj-text\>Your booking with {{buyerName}} on {{startTsLocal}} in
{{city}} is confirmed.\</mj-text\>*\
*\<mj-button href=\"{{ctaUrl}}\"\>Open booking\</mj-button\>*\
*\</mj-column\>\</mj-section\>\</mj-body\>\</mjml\>*\
*text_body: Booking confirmed with {{buyerName}} on {{startTsLocal}}.
Details: {{ctaUrl}}*\
*push_title: Booking confirmed*\
*push_body: {{buyerName}} --- {{startTsLocal}}. Tap for details.*\
*inapp_title: Booking confirmed*\
*