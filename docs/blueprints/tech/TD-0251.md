<!-- id: TD-0251 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 903600-907600 -->

es).

## **1.21.6 Ingest & storage --- paste‑ready IaC/DDL**

**S3 layout**

*s3://analytics/*\
*raw/event_dt=YYYY-MM-DD/HH/evt-\*.ndjson \# Bronze (WORM)*\
*silver/events/iceberg/\... \# Iceberg tables by event family*\
*gold/{fact_sessions,fact_orders,\...}/\... \# dbt models*\

**Athena/Iceberg DDL (Silver) --- events supertable**

*CREATE TABLE IF NOT EXISTS lake.events*\
*(*\
*event_dt date,*\
*event_name string,*\
*event_ts timestamp,*\
*event_id string,*\
*user_id string,*\
*anon_id string,*\
*session_id string,*\
*page_path string,*\
*country string,*\
*city string,*\
*utm_source string,*\
*utm_medium string,*\
*utm_campaign string,*\
*click_token string,*\
*payload map\<string, string\>, \-- JSON flattened to string map where
feasible*\
*\_raw string \-- full JSON for backstop*\
*)*\
*PARTITIONED BY (event_dt)*\
*TABLE_FORMAT=\'ICEBERG\'*\
*LOCATION \'s3://analytics/silver/events/\';*\

**Dimensional tables (Gold) --- dbt models**

- *dim_identity*, *dim_profile*, *dim_studio*, *dim_campaign*
- *fact_sessions*, *fact_search*, *fact_views*, *fact_messages*,
  *fact_checkouts*, *fact_orders*, *fact_payouts*, *fact_support*,
  *fact_dmca*, *fact_growth_mail*, *fact_referrals*, *fact_experiments*.

## **1.21.7 Attribution (multi‑touch with click‑token proof)**

**Sources**: saved‑search alerts & digests (§1.16), SEO landings
(§1.17), ads (future), sharecards/shortlinks (§1.16), referrals (§1.16).

**Rules (configurable)**:

- **Channel precedence**: last **non‑direct** click within **7‑day**
  lookback for checkout; 30‑day for referrals.
- **Click‑token binding**: when *click_token* present, it **wins** over
  UTM because it proves origin.
- **Organic direct**: only if no prior qualifying touchpoint exists in
  the lookback.
- **Fraud filter**: discard if device_fp/identity repeats \>N times in
  10 min for the same campaign.

**Outputs**:

- *fact_attribution_checkout* (one row per order with channel, source,
  campaign, proof flag).
- *fact_attribution_referral* (awards and clawbacks with source).

**Sample SQL (Athena) --- last‑non‑direct with click‑token preference**

*WITH touches AS (*\
*SELECT o.order_id, e.event_ts, e.utm_source, e.utm_medium,
e.utm_campaign, e.click_token,*\
*ROW_NUMBER() OVER (PARTITION BY o.order_id ORDER BY* \
*(e.click_token IS NOT NULL) DESC, e.event_ts DESC) AS rk*\
*FROM gold.fact_orders o*\
*JOIN lake.events e*\
*ON e.identity_id = o.identity_id*\
*AND e.event_name IN
(\'growth.alert.click\',\'digest.click\',\'sharecard.click\',\'search.result_click\',\'landing.view\')*\
*AND e.event_ts BETWEEN o.created_at - INTERVAL \'7\' DAY AND
o.created_at*\
*AND COALESCE(e.utm_medium,\'(direct)\') \<\> \'(direct)\'*\
*)*\
*SELECT o.order_id,* \
*CASE WHEN t.rk = 1 THEN COALESCE(t.utm_source,\'direct\') END AS
source,*\
*CASE WHEN t.rk = 1 THEN t.utm_medium END AS medium,*\
*CASE WHEN t.rk = 1 THEN t.utm_campaign END AS campaign,*\
*CASE WHEN t.rk = 1 THEN (t.click_token IS NOT NULL) END AS
has_click_proof*\
*FROM gold.fact_orders o*\
*LEFT JOIN touches t ON o.order_id = t.order_id AND t.rk = 1;*\

## **1.21.8 Experimentation framework (productionized)**

**Namespaces & config**

- *config/experiments/\*.yaml* with: *exp_id*, *surface*, *variants*,
  *weights*, *targeting*, *primary_metric*, *guardrails*.
- Assignment: *hash(identity_id, exp_id)* → bucket; persisted in
  *dim_identity_traits*.
- Exposure: fire *exp.view* when a variant first renders per session.
- Conversion: *exp.convert* on **checkout.complete** (default) or custom
  metric.
- **Guardrails**: SRM alert if assignment ratios deviate \>2 p.p.;
  kill‑switch.

**Estimators**

- CUPED for mean‑difference metrics; Bayesian beta‑binomial for rates.
- **MDE** calculator used before launch; sample size gate.
- Reporting: dbt builds *fact_experiment_result* with lift,
  p‑values/credible intervals, time‑to‑decision.

**Compliance**

- No cloaking; crawler sees control variant for public SEO pages
  (§1.17).
- Experiments never change legal t