<!-- id: TD-0202 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 727200-731200 -->

ng), deliverable bundles (licensed,
  non‑watermarked), retention & legal hold.
- **Cost posture:** lifecycle to S3‑IA/Glacier, adaptive transcode
  ladder, dedupe, quotas, and throttles.

## **1.11.2 Architecture (Amplify Gen‑2 posture)**

- **Frontend**:

  - Web (Next.js): Uploader component with chunk/resume, client crop,
    progress, and preflight checks (type/size).
  - Mobile (React Native): native pickers + background upload w/
    presigned URLs.

- **Backend**:

  - **AppSync GraphQL** mutations for presign requests & completion
    acks.
  - **S3 buckets**: *media-raw* (ingest), *media-public* (processed
    public), *media-protected* (processed private/proofs/deliverables),
    *evidence* (admin/legal).
  - **Processing Lambdas** (S3 event → Step Functions): AV scan →
    image/video pipeline → Safe‑Mode classifier → metadata → publish.
  - **Video**: AWS **MediaConvert** job templates (adaptive HLS ladder +
    progressive MP4).
  - **CDN**: CloudFront distributions (public & protected origins) with
    URL‑signing for protected.
  - **Events**: *media.ingested*, *media.scanned*, *media.transcoded*,
    *media.classified*, *media.published*, *proofs.created*,
    *deliverable.published*.

**Out‑of‑box modules (suggested/optional)**

- **FE uploader**: Uppy or tus‑js‑client (resumable; OSS, highly
  customizable).
- **Image processing**: *sharp* (Lambda).
- **AV scanning**: ClamAV Lambda layer (common OSS pattern).
- **NSFW/Safe‑Mode**: light open‑source classifier for Tier‑0 +
  Rekognition for escalations (§1.5).\
  (We picked OSS first for cost/customization per your direction; all
  are swappable.)

## **1.11.3 S3 layout & naming (deterministic keys)**

- **Raw uploads**:
  *s3://media-raw/{userId}/{yyyy}/{MM}/{dd}/{uuid}.{ext}*
- **Processed (public)**: *s3://media-public/{assetId}/{variant}.{ext}*
  (e.g., *1920.webp*, *1280.webp*, *cover.webp*)
- **Processed (protected)**:
  *s3://media-protected/{assetId}/{variant}.{ext}* (e.g.,
  *watermarked.webp*, *hls/master.m3u8*, *mp4/1080.mp4*)
- **Evidence**: *s3://evidence/{caseId}/{sha256}.{ext}* (immutable;
  Object Lock if legal hold)

Naming is **content‑addressable** where possible (sha256 in metadata)
for dedupe.

## **1.11.4 Data model (Aurora schema** ***media*****)**

**Paste into** *db/migrations/019_media.sql*:

*begin;*\
\
*create type media_kind as enum
(\'image\',\'video\',\'audio\',\'pdf\',\'zip\',\'other\');*\
*create type media_status as enum
(\'ingested\',\'quarantined\',\'processing\',\'blocked\',\'ready\');*\
\
*create table media.asset (*\
*asset_id text primary key, \-- ast\_\...*\
*owner_user_id text not null,*\
*kind media_kind not null,*\
*bytes bigint not null,*\
*mime text not null,*\
*sha256 text, \-- for dedupe/integrity*\
*raw_s3 text not null, \-- media-raw key*\
*status media_status not null default \'ingested\',*\
*width int, height int, \-- if image/video*\
*duration_sec numeric, \-- if audio/video*\
*sfw_band smallint not null default 0, \-- 0=safe,1=lingerie,2=mature*\
*safe_mode_required boolean not null default false,*\
*blocked_reason text, \-- AV fail, policy, DMCA*\
*meta jsonb not null default \'{}\', \-- EXIF, codecs, etc.*\
*created_at timestamptz default now(),*\
*updated_at timestamptz default now()*\
*);*\
\
*create table media.variant (*\
*variant_id text primary key, \-- var\_\...*\
*asset_id text not null references media.asset(asset_id) on delete
cascade,*\
*scope text not null check (scope in (\'public\',\'protected\')),*\
*name text not null, \-- \'1920\',\'cover\',\'watermarked\',\'hls\'*\
*s3_key text not null,*\
*mime text not null,*\
*width int, height int, bitrate int,*\
*created_at timestamptz default now()*\
*);*\
\
*\-- Proof galleries (watermarked, expiring)*\
*create table media.proof_gallery (*\
*gallery_id text primary key, \-- prf\_\...*\
*order_id text not null, \-- ord\_\...*\
*owner_user_id text not null,*\
*title text,*\
*expires_at timestamptz,*\
*allow_selections boolean not null default true,