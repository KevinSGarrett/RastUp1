<!-- id: TD-0127 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 457200-461200 -->

breakers: recency, id.

**Spec:** *search/signals/compute.md*
(sigmoid/exp‑decay/gaussian/Jaccard formulas).

## **1.21.F Synonyms, stemming & typo tolerance**

- Domain synonyms (e.g., *"cyclorama" ⇄ "cyc wall"*), city nicknames
  (*"NYC" ⇄ "New York City"*).
- Typos: **2** for terms \>5 chars, **1** for 3--5 chars, exact for ≤2
  chars.
- **Recommended path:** *search/schemas/synonyms.json*.

## **1.21.G Safe‑Mode, policy & exclusion**

- Safe‑Mode ON excludes *nsfw_band \>= 2*.
- Policy: DMCA/policy cases remove entities from index; reinstate when
  cleared.
- Thin profiles (completeness \< threshold) are not searchable until
  improved.

## **1.21.H Caching, throughput & cost**

- Edge‑cache **query suggestions** (1--5 min TTL).
- Short server‑side memoization for hot city/role landings (30--60s).
- Alert/scheduler batch queries off‑peak.
- Cluster sizing targets 95p latency \< 120 ms at launch; monitor and
  scale.

## **1.21.I Admin & curation tools**

- **Pins** per city/query; TTL; stored in *search_curation* (DDL below).
- **Synonym editor** (admin UI) persisted in Aurora and synced to
  Typesense.
- **Bad queries** dashboard for zero‑results & low CTR.

**Recommended path:** *db/migrations/021_search_curations.sql*

*create table if not exists search_curation (*\
*cur_id text primary key, \-- scu\_\...*\
*scope text not null check (scope in (\'people\',\'studios\')),*\
*city text not null,*\
*query text,*\
*pin_ids text\[\] not null,*\
*expires_at timestamptz,*\
*created_at timestamptz not null default now()*\
*);*\

## **1.21.J Telemetry, evaluation & experimentation**

- **Events:** *search.query\|results\|click\|zero_results*,
  *search.autocomplete.select*, *search.suggest.click*.
- **Quality:** CTR@k, save rate@k, message‑start/booking
  start&complete@k, zero‑results rate.
- **Offline eval:** compute **NDCG@10** weekly from interaction labels;
  compare weight variants; guardrails for result diversity.

**NDCG SQL (simplified):** *search/eval/ndcg.sql*.

## **1.21.K API (GraphQL)**

**Recommended path:** *api/schema/search.graphql*

*type SearchResult {*\
*id: ID!*\
*kind: String!*\
*score: Float!*\
*distanceKm: Float*\
*priceFromCents: Int*\
*priceToCents: Int*\
*city: String!*\
*displayName: String*\
*name: String*\
*verified: Boolean!*\
*trusted: Boolean*\
*preview: AWSJSON*\
*}*\
\
*type SearchPage { items: \[SearchResult!\]!, total: Int!, nextCursor:
String }*\
\
*input SearchFilter {*\
*scope: String!, city: String!,*\
*any: AWSJSON, all: AWSJSON,*\
*safeMode: Boolean = true,*\
*originLat: Float, originLon: Float,*\
*sort: String = \"best\", pageSize: Int = 24, cursor: String*\
*}*\
\
*type Query {*\
*search(input: SearchFilter!): SearchPage!*\
*autocomplete(q: String!, scope: String!, city: String!): \[String!\]!*\
*}*\

## **1.21.L Test plan**

2126. Indexing correctness & reindex safety; DMCA hide works.
2127. ANY/ALL logic; Safe‑Mode; distance/price sorts; synonyms; typos;
      autocomplete.
2128. Ranking weights & bounded boosts; diversity guardrails.
2129. Zero‑results suggestions & logging.
2130. Load: 95p \< 120 ms for 95% queries; bursts handled.
2131. Security: WAF throttles; no PII in docs; admin curation
      role‑gated.
2132. Cost: alert jobs complete within budget.

## **1.21.M Acceptance criteria --- mark §1.21 FINAL only when ALL true**

2133. *people_v1*/*studios_v1* live with SFW‑only docs; ingest
      pipeline + reindex runbook in place.
2134. Query model supports ANY/ALL, Safe‑Mode, geo origin, standard
      sorts; autocomplete & suggestions operational.
2135. Ranking implemented with bounded boosts, price/amenity fitness,
      distance penalty; diversity guardrails active.
2136. Synonyms/typos configured; city nicknames resolved; zero‑results
      rate below target.
2137. Admin pinning & synonym tools available; analytics dashboards show
      CTR@k, save rate@k, booking conversions, NDCG@10.
2138. Latency & throughput SLOs met; costs within launch budget; WAF &
      policy gat