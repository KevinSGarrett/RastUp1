<!-- id: TD-0081 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 291600-295600 -->

exact Stripe object mappings, state machines, watermarking/preview
specs, entitlement tokens, manifest contracts, moderation & DMCA flows,
tax/fee math, GL entries, comms templates, errors, and runbooks.

## **1.14.1 Roles, gates, and global invariants (recap + expansions)**

- **Eligibility gates** (server‑enforced before any Fan‑Sub surface or
  API):

  - **Age**: both creator and fan must have *idv_status=passed* and
    *age_verified=true* (§1.6).
  - **Trust**: creator must be *ID Verified*; **Trusted Pro** badge is
    **not** required for Fan‑Sub (optional boost).
  - **Policy clean**: creator not suspended; no unresolved DMCA strike
    blocking publish.

- Safe‑Mode & visibility:

  - Public pages show **SFW previews only**; finals require explicit
    entitlement + Safe‑Mode OFF (for adult categories).
  - City/region gates respected if configured by creator or policy.

- **Media storage stance**: we **store only previews**; **finals** live
  off‑platform (creator‑controlled) and are referenced via **immutable
  manifests** (with file checksums).

- **Money separation**: Marketplace GMV for Fan‑Sub (subs, PPV,
  requests, tips) is separate from booking GMV. Platform fees are
  separate revenue per §1.9.

## **1.14.2 Data contracts (DB, cache, storage)**

### **1.14.2.1 SQL (additions & refinements)**

*\-- Creator storefront settings & policy*\
*alter table fansub_creator*\
*add column preview_policy jsonb not null default jsonb_build_object(*\
*\'image_max_px\', 1600, \'video_preview_sec\', 15, \'watermark\', true,
\'nsfw_on_public\', false*\
*),*\
*add column payout_schedule text not null default \'standard\', \--
\'standard\' \| \'weekly\' (Stripe Connect)*\
*add column tos_accepted_at timestamptz,*\
*add column dmca_contact_email text;*\
\
*\-- Subscription invoice snapshots (for statements & taxes)*\
*create table fansub_subscription_invoice (*\
*inv_id text primary key, \-- fsi\_\...*\
*sub_id text not null references fansub_subscription(sub_id),*\
*provider_invoice text not null, \-- Stripe invoice id*\
*period_start timestamptz not null,*\
*period_end timestamptz not null,*\
*amount_cents int not null, \-- subtotal (creator portion)*\
*tax_cents int not null,*\
*fee_cents int not null, \-- platform fee taken (if any)*\
*fee_tax_cents int not null,*\
*currency text not null default \'USD\',*\
*status text not null check (status in
(\'paid\',\'void\',\'uncollectible\')),*\
*created_at timestamptz not null default now()*\
*);*\
\
*\-- Creator payout ledger (join to Stripe balance txns)*\
*create table fansub_payout (*\
*payout_id text primary key, \-- fpo\_\...*\
*creator_id text not null,*\
*provider_transfer text not null, \-- Stripe transfer/payout id*\
*amount_cents int not null,*\
*status text not null check (status in
(\'queued\',\'paid\',\'failed\')),*\
*scheduled_for timestamptz,*\
*created_at timestamptz not null default now()*\
*);*\

### **1.14.2.2 DynamoDB (hot‑path caches)**

- ***fansub_entitlement_cache*** item shape:

*{*\
*\"pk\": \"USER#usr_123\",*\
*\"sk\": \"CREATOR#fsc_789\", // or \"PPV#fpp_456\"*\
*\"entitled\": true,*\
*\"exp\": 1734567890 // TTL (epoch seconds)*\
*}*\

- ***fansub_rate_limits***: keys like *TIP#usr_123#2025-11-06* with
  counters.

### **1.14.2.3 S3 keys & CF**

- s3://fansub-previews/{creator_id}/ppv\_{ppv_id}/img\_{n}.webp
- s3://fansub-previews/{creator_id}/req\_{request_id}/proof\_{n}.webp
- All served via **CloudFront** with *Cache-Control: public,
  max-age=86400* and **WAF** throttles.

## **1.14.3 Manifests for final media (off‑platform)**

**Rationale:** Preserve creator control, reduce our media costs/risks,
keep **immutable evidence** via hashes.

### **1.14.3.1 Manifest JSON (v1)**

*{*\
*\"manifest_version\": 1,*\
*\"creator_id\": \"fsc_123\",*\
*\"kind\": \"ppv\" \| \"request\",*\
*\"entity_id\": \"fpp_456\" \| \"fsr_789\",*\
*\"created_at\": \"2025-11-06T15:22:10Z\",*\
*\"files\": \[*\
*{*\
*\"file_id\": \"F001\",*\
*\"name\": \"set1_001.jpg\",*\
*\"sha25