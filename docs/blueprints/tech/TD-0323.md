<!-- id: TD-0323 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1162800-1166800 -->

eGroupStatement\": {*\
*\"VendorName\": \"AWS\",*\
*\"Name\": \"AWSManagedRulesBotControlRuleSet\"*\
*}},*\
*\"OverrideAction\": { \"None\": {} },*\
*\"VisibilityConfig\": {\"SampledRequestsEnabled\": true,
\"CloudWatchMetricsEnabled\": true, \"MetricName\": \"BotControl\"}*\
*}*\
*\]*\
*}*\

**AppSync pre‑resolver guard (JS function) ---**
***api/functions/rateGuard.js*****:**

*export function request(ctx) {*\
*const key = \`user#\${ctx.identity.sub}#op#\${ctx.info.fieldName}\`;*\
*const now = Date.now();*\
*// burst: 40/min on searchPeople for authenticated*\
*const limit = (ctx.info.fieldName.startsWith(\'search\')) ? 40 : 60;*\
*const ok = rateLimitCheck(key, limit, 60_000); // uses Dynamo
\'rate_limits\' table*\
*if (!ok) util.error(\"Rate limit exceeded\", \"Throttled\", 429);*\
*return ctx.prev.result;*\
*}*\
*export function response(ctx) { return ctx.result; }*\

**Dynamo "rate_limits" table (token bucket):** PK=*key*,
fields=*allowance*, *last_ts*. Update in single conditional write.

## **U.5 Detection Queries & Alerts**

**CloudWatch Logs Insights --- login stuffing:**

*filter \@message like /login.failed/*\
*\| stats count() as fails, approx_distinct(ip) as ips by bin(5m)*\
*\| filter fails \> 200 and ips \< 20*\

**Athena (abuse rates by cohort):**

*SELECT referrer_code,*\
*SUM(case when event_type=\'chargeback.opened\' then 1 else 0
end)::double / NULLIF(COUNT(\*) FILTER (WHERE
event_type=\'order.completed\'),0) AS cb_rate_30d*\
*FROM gold.abuse_events*\
*WHERE event_ts \>= date_add(\'day\', -30, current_date)*\
*GROUP BY 1*\
*HAVING cb_rate_30d \> 0.02;*\

**Typesense rank‑gaming detector (edit‑rate):**

*SELECT user_id, COUNT(\*) AS edits_24h*\
*FROM gold.profile_edits*\
*WHERE ts \>= current_timestamp - interval \'24 hours\'*\
*GROUP BY 1*\
*HAVING COUNT(\*) \> 30;*\

**Alerts (CloudWatch/Datadog):**

- **LoginFailRateHigh**: *\> 5%* over 5 min, page on‑call.
- **SearchSpamIP**: WAF rule *RateLimitSearch* blocks \> 100 IPs in 10
  min, create SEV‑3 ticket.
- **NSFWSurge**: *media.moderated(nsfw_score\>=0.8)* \> 20 in 30 min →
  pause new uploads for flagged cohort; page Safety.

## **U.6 Content Safety & Redaction**

- **Message filters:** redact emails, phone numbers, payment handles in
  client preview and server save (store original in encrypted field for
  appeals).
- **OG/Preview safety:** OG images generated **only from SFW variants**;
  force Safe‑Mode on all public search/feeds.
- **Logging:** no raw message bodies in logs; store *hash(body)* for
  dedup; **PII redaction** before emission.

## **U.7 Tests (security & abuse)**

- **Credential stuffing sim**: 500 login attempts from single ASN →
  lockout + CAPTCHA; ensure legitimate logins unaffected.
- **IDOR tests**: All profile/media/order resolvers enforce owner/staff
  checks.
- **Message spam**: 50 msgs/10 min in a dyad → shadow within 1 minute;
  unshadow after 2h.
- **NSFW leak tests**: public GET never returns non‑SFW URL; admin
  override only with signed header.
- **Webhook replay**: old timestamp + wrong signature → quarantined; no
  side effects.
- **Ranking gaming**: edit‑rate clamp reduces rank contribution; AB test
  protects CTR.

All tests live under *security/\*.spec.ts*, *safety/\*.spec.ts*, and run
in CI nightly.

## **U.8 Runbooks**

**RB‑U‑01 Credential Stuffing**

5567. Confirm spike (dashboard).
5568. Enable stricter WAF rate on */auth/\** (template policy).
5569. Turn on CAPTCHA hard‑enforcement; increase lockout to 30 min.
5570. After 2h stable, relax to normal; export offending ASNs to
      denylist.

**RB‑U‑02 NSFW Leak**

5571. Flip Safe‑Mode **global** (config flag).
5572. Purge CloudFront path for affected assets.
5573. Deindex entities from Typesense; add *policy_hold=true*.
5574. Post‑mortem: check pipeline regression tests; add new unit.

**RB‑U‑03 Partner Webhook Forgery**

5575. Move endpoint to **quarantine mode** (accept, store to DLQ only).
5576. Rotate secrets; re‑enable with tighter clock skew (±3 min).
557