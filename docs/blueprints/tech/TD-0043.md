<!-- id: TD-0043 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 154800-158800 -->

',\'dispute\'*\
*created_at timestamptz not null default now()*\
*);*\
\
*\-- GL journal (exportable to accounting)*\
*create table gl_entry (*\
*gl_id text primary key, \-- gl\_\...*\
*occurred_at timestamptz not null,*\
*lbg_id text,*\
*leg_id text,*\
*account_dr text not null, \-- e.g., \'Cash:Stripe\',
\'Deferred:PlatformFees\'*\
*account_cr text not null, \-- e.g., \'Liability:SellerPayable\'*\
*amount_cents int not null,*\
*memo text,*\
*ext_ref text, \-- stripe bal_txn id, charge id, payout id*\
*created_at timestamptz not null default now()*\
*);*\
*create index on gl_entry(occurred_at);*\
*create index on gl_entry(lbg_id, leg_id);*\

**Note:** Advertiser **ads credits** ledger from §1.7 remains separate
(*promo_budget_ledger*). Buyer wallet and promo credits **never** touch
each other.

## **1.9.D Accounting model & GL entries (MVP)**

We model journal entries so Finance can export them or sync to a
downstream system.

### **D.1 At capture (LBG confirmed & charge succeeded)**

Let:

- *Σseller_subtotal+service_tax* across legs = **SellerPayable** (if
  seller remits tax).
- *Σplatform_fee_cents* = **PlatformFeesDeferred**.
- *Σplatform_fee_tax_cents* = **PlatformFeeTaxPayable**.

**Entry 1: Record cash and liabilities**

*Dr Cash:Stripe total_charge_cents*\
*Cr Liability:SellerPayable Σ(seller_subtotal + service_tax)*\
*Cr Deferred:PlatformFees Σ(platform_fee_cents)*\
*Cr Liability:TaxPayable:PlatformFeeTax Σ(platform_fee_tax_cents)*\

If **platform** is MoR for service tax, split accordingly:

*Cr Liability:TaxPayable:ServiceTax Σ(service_tax)*\
*Cr Liability:SellerPayable Σ(seller_subtotal)*\

**Entry 2: Record Stripe processing fees (when balance txn posts)**

*Dr Expense:PaymentProcessing stripe_fee_cents*\
*Cr Cash:Stripe stripe_fee_cents*\

**Fee ledger row**: *stage=\'deferred\'*, reason=\'confirm\' for each
leg.

### **D.2 On completion/accept (leg earns platform fee revenue)**

*Dr Deferred:PlatformFees platform_fee_cents*\
*Cr Revenue:PlatformFees platform_fee_cents*\

**Fee ledger**: add *stage=\'earned\'*, reason=\'complete\' for the leg.

### **D.3 On payout transfer to seller (per leg)**

*Dr Liability:SellerPayable transfer_amount_cents*\
*Cr Cash:Stripe transfer_amount_cents*\

### **D.4 Refunds (leg policy or admin)**

- Reverse revenue if already earned; otherwise reduce deferral.
- Service tax and platform fee tax reversed per provider rules.

**If refund before completion (unearned):**

*Dr Deferred:PlatformFees refund_platform_fee_cents*\
*Dr Liability:TaxPayable:PlatformFeeTax refund_platform_fee_tax_cents*\
*Dr Liability:SellerPayable refund_service_total_cents*\
*Cr Cash:Stripe total_refund_cents*\

**If refund after completion (earned):**

*Dr Revenue:PlatformFees refund_platform_fee_cents*\
*Dr Liability:TaxPayable:PlatformFeeTax refund_platform_fee_tax_cents*\
*Dr Liability:SellerPayable refund_service_total_cents*\
*Cr Cash:Stripe total_refund_cents*\

### **D.5 Chargebacks (lost dispute)**

*Dr Expense:Chargebacks disputed_amount_cents*\
*Cr Cash:Stripe disputed_amount_cents*\

Then adjust liabilities/deferrals/revenue as needed (mirror of D.4 based
on timing).

## **1.9.E Wallet (buyer credits) --- rules & flows**

**Use cases:** residuals from partial refunds, goodwill credits,
referral bonuses.\
**Important:** wallet *reduces* the **PaymentIntent** amount at
checkout; it is never auto‑withdrawn to bank/card.

**Flows**

- **Credit**: create *wallet_txn(kind=\'credit\',
  source=\'refund_residual\'\|\'goodwill\'\|\'referral\')*; increase
  balance.
- **Apply at checkout**: before creating PI, debit wallet up to
  available balance (*kind=\'debit\', source=\'checkout_apply\'*) and
  reduce charge amount; store the applied amount on the LBG for
  receipts.
- **Reversal**: if a checkout fails post‑debit, write *reversal* credit
  with same idempotency key to restore balance.

**GraphQL**

*type Wallet { balanceCents: Int!, currency: String! }*\
*type WalletTxn { walletTxnId: ID!, kind: Stri