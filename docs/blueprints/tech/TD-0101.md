<!-- id: TD-0101 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 363600-367600 -->

\>*\
*\</div\>*\
*{{/each}}*\
\
*\<!\-- Availability \--\>*\
*{{#each availability}}*\
*\<div class=\"card\"\>*\
*\<h4\>Availability: {{this.date}}\</h4\>*\
*\<p class=\"muted\"\>{{this.window}}\</p\>*\
*\<a class=\"btn\"
href=\"{{this.bookLink}}?utm_source=lib&utm_medium=link&utm_campaign=avail\"\>Request\</a\>*\
*\</div\>*\
*{{/each}}*\
*\</section\>*\
\
*\<p class=\"muted\" style=\"margin-top:16px\"\>*\
*Previews are SFW. For 18+ material, Safe-Mode must be OFF and
age-verified in app.*\
*\</p\>*\
*\</main\>*\
*\</body\>*\
*\</html\>*\

## **1.16-L. ANY/ALL Query Builder --- Typesense/OpenSearch spec**

**Recommended filename/path:** *search/spec/any_all_query_builder.md*

*Goal*\
*Support saved searches with (ANY OR ALL) filter groups over
people/studios while enforcing Safe-Mode.*\
\
*Input*\
*queryJson:*\
*{*\
*\"any\": \[*\
*{\"field\":\"roleFields.genres\",\"op\":\"in\",\"value\":\[\"fashion\",\"editorial\"\]},*\
*{\"field\":\"verification.id\",\"op\":\"eq\",\"value\":true}*\
*\],*\
*\"all\": \[*\
*{\"field\":\"city\",\"op\":\"eq\",\"value\":\"Houston\"},*\
*{\"field\":\"priceFromCents\",\"op\":\"between\",\"value\":\[10000,30000\]}*\
*\]*\
*}*\
\
*Algorithm (Typesense flavor)*\
* - Base filters: city:={{city}} AND isPublished:=true AND
safeModeBandMax:\<= {{safeMode?1:2}}*\
* - Build ANY clause:*\
* - Map each criterion to Typesense filter expression:*\
*\* in: field:=\[v1, v2, \...\]*\
*\* eq: field:=value*\
*\* between: field:\>={{lo}} && field:\<={{hi}}*\
* - ANY -\> join with \" \|\| \"*\
* - Build ALL clause: same mapping, join with \" && \"*\
* - Combined: base && ( (ANY) \|\| true_if_any_empty ) && (ALL)*\
* - Sorting: text match score, geo distance, repScore, verifyBoost,
priceFit*\
* - Pagination: cursor API; record query_hash for analytics and
dedupe.*\
\
*OpenSearch variant*\
* - Translate to bool query:*\
*{*\
*\"bool\": {*\
*\"filter\": \[*\
*{\"term\":{\"city\":\"houston\"}},*\
*{\"term\":{\"isPublished\":true}},*\
*{\"range\":{\"safeModeBandMax\":{\"lte\": safeMode?1:2}}}*\
*\],*\
*\"must\": \[ \...ALL\... \],*\
*\"should\": \[ \...ANY\... \],*\
*\"minimum_should_match\": {{ANY? 1 : 0}}*\
*}*\
*}*\

## **1.16-M. UTM & Attribution Rules**

**Recommended filename/path:** *growth/utm_attribution_rules.md*

*UTM structure*\
*utm_source = one of: lib (link-in-bio), sharecard, digest, alert*\
*utm_medium = email \| inapp \| web*\
*utm_campaign = pkg \| avail \| city_digest \| book_again_7 \|
book_again_30 \| book_again_90 \| referral*\
\
*Click tokens*\
*token = HMAC(k, user_id \| ts \| target) \# 5-minute TTL*\
*Store click event -\> attribute conversion to last non-expired click
within 7 days.*\
\
*Attribution in ยง1.13*\
* - fact_clicks (Silver) join to fact_conversions (checkout.confirmed)
by user_id within window.*\
* - Gold KPI: by (utm_source, utm_campaign), city, role.*\

## **1.16-N. Lambda Skeleton --- Weekly Digest**

**Recommended filename/path:** *apps/functions/growthWeeklyDigest.ts*

*// growthWeeklyDigest.ts*\
*import { pickDigestBlocks } from \'../lib/digestBlocks\';*\
*import { sendEmail } from \'../lib/ses\';*\
*import { createInApp } from \'../lib/inapp\';*\
*import { getOptedInUsersByCity } from \'../lib/digestRepo\';*\
\
*export const handler = async () =\> {*\
*const cities = await getDigestCities();*\
*for (const city of cities) {*\
*const users = await getOptedInUsersByCity(city);*\
*const blocks = await pickDigestBlocks(city); // { caseStudies, studios,
rising }*\
*for (const u of users) {*\
*await createInApp(u.userId, \'weekly_digest\', { city, blocks });*\
*await sendEmail({*\
*toUserId: u.userId,*\
*template: \'weekly_city_digest\',*\
*vars: { city, \...blocks }*\
*});*\
*}*\
*}*\
*};*\

## **1.16-O. Lambda Skeleton --- Book Again (7/30/90)**

**Recommended filename/path:** *apps/functions/growthBookAgain7.ts*
(copy for 30/90)

*// growthBookAgain7.ts*\
*import { findEligibleRebooks } from \'../lib/rebookRepo\';*\
*import { sendEmail } from \'../lib/ses\';*\
\
*export const handle