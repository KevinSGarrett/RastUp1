<!-- id: TD-0195 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 702000-706000 -->

rs/ses.ts* & *providers/pinpoint.ts* ---
  senders with retries/backoff.
- *templates/email/\*.mjml* --- compiled at publish; S3 cache.
- *ops/runbooks/notify-bounce-complaint.md* --- immediate actions,
  suppression verification.
- *observability/dashboards/notify.md* --- metric definitions & example
  queries.

## **1.8.16 Acceptance criteria --- mark §1.8 FINAL only when ALL true**

3198. Users can manage **per‑event/channel** prefs and **Quiet Hours**;
      exceptions work as specified.
3199. Orchestrator consumes product events and dispatches
      **email/push/in‑app** with correct templates and localization.
3200. **Transactional** messages (receipts, booking, safety, payments)
      always deliver; **optional** messages respect prefs/quiet
      hours/digests.
3201. **Deliverability** is production‑ready (SPF/DKIM/DMARC set;
      bounce/complaint suppression active; warmup plan executed).
3202. **Consent ledger** records every opt action; unsubscribe links
      function; marketing remains OFF at MVP.
3203. **Observability** dashboards live; alerts wired; costs within plan
      (SES/Pinpoint pay‑as‑you‑go; idle scale‑to‑zero).

# **§1.9 --- Ratings, Reviews & Reputation --- Gap Audit & Finalization**

In my prior §1.9 draft (mis‑numbered as 1.8), I delivered:
verified‑booking‑only reviews, double‑blind publishing, SP‑level
aggregates + Bayesian smoothing, provider‑level **Reputation Score**,
Safe‑Mode on review media, moderation/reporting/DMCA, GraphQL, DDL,
tests, KPIs, and acceptance.

**New items below** close the last gaps I found when cross‑checking your
non‑technical plan:

## **A) Studios get their own reviews & aggregates (space‑scoped)**

Your plan states: **Service reviews remain role‑scoped; Studio reviews
are space‑scoped; no coupling of reviews** between them. To reflect
this:

### **A.1 Delta DDL (add Studio review tables)**

***db/migrations/018b_reviews_studios.sql***

*begin;*\
\
*create type studio_review_status as enum
(\'pending\',\'hidden\',\'published\',\'removed\',\'blocked\');*\
\
*create table reviews.studio_review (*\
*review_id text primary key, \-- srvw\_\...*\
*order_id text not null, \-- ord\_\...*\
*studio_id text not null, \-- std\_\...*\
*author_user_id text not null,*\
*side review_side not null, \-- buyer\|provider*\
*rating smallint not null check (rating between 1 and 5),*\
*title text,*\
*body text,*\
*media_s3 jsonb default \'\[\]\',*\
*sfw_band smallint not null default 0,*\
*helpful_up int not null default 0,*\
*helpful_down int not null default 0,*\
*status studio_review_status not null default \'pending\',*\
*submitted_at timestamptz,*\
*published_at timestamptz,*\
*removed_reason text,*\
*created_at timestamptz default now(),*\
*updated_at timestamptz default now(),*\
*unique (order_id, side)*\
*);*\
\
*create table reviews.studio_aggregate (*\
*studio_id text primary key,*\
*avg_rating numeric not null default 0,*\
*rcount int not null default 0,*\
*dist_1 int not null default 0,*\
*dist_2 int not null default 0,*\
*dist_3 int not null default 0,*\
*dist_4 int not null default 0,*\
*dist_5 int not null default 0,*\
*bayesian_avg numeric not null default 0,*\
*updated_at timestamptz default now()*\
*);*\
\
*commit;*\

**UI rule:**\
• **Service Profile pages**: show only **Service Profile** reviews
(role‑scoped).\
• **Studio pages**: show only **Studio** reviews (space‑scoped), with an
**AggregateRating** block **only if rcount ≥ 3** (as your plan suggests
to avoid low‑sample bias). Studio reviews **never** appear on Service
Profile pages.

### **A.2 GraphQL additions**

*\# api/schema/reviews.graphql (additions)*\
*type StudioReview {*\
*id: ID!, orderId: ID!, studioId: ID!,*\
*side: ReviewSide!, rating: Int!, title: String, body: String,*\
*media: \[Media!\], status: ReviewStatus!, submittedAt: AWSDateTime,
publishedAt: AWSDateTime,*\
*helpfulUp: Int!, helpfulDown: Int!, reply: Reply*\
*}*\
*type StudioAggregate { studioId: ID!, avgRating: Float!, rcount: Int!,
dist: \[In