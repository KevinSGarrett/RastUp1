<!-- id: TD-0346 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1245600-1249600 -->

i}.png\`;*\
*const body = pngBytes(1200, 800, \`Demo \${i}\`);*\
*await s3.send(new PutObjectCommand({ Bucket: bucket, Key: key, Body:
body, ContentType: \"image/png\", CacheControl:
\"public,max-age=31536000\" }));*\
*console.log(\`uploaded s3://\${bucket}/\${key}\`);*\
*}*\
*})();*\

- Produces neutral, SFW images with **no real people**.
- Manifest (*/media-fixtures/manifest.json*) lists keys/urls for the
  seeder to attach to *media_assets*.

## **S.7 Typesense reindex for seeds ---** ***/typesense/reindex_seed.ts***

*import { Client } from \'typesense\';*\
*import { Pool } from \'pg\';*\
\
*const ts = new Client({ nodes: \[{ host: process.env.TS_HOST!, port:
443, protocol: \'https\' }\], apiKey: process.env.TS_KEY! });*\
*const db = new Pool({ connectionString: process.env.DB_URL });*\
\
*async function indexPeople() {*\
*const { rows } = await db.query(\`*\
*SELECT p.user_id as id, u.display_name, p.roles, p.city, p.country,
p.verified,*\
*p.price_min, p.price_max, p.lat, p.lng, 0 as nsfw_band, p.updated_at*\
*FROM profiles p JOIN users u ON p.user_id = u.id WHERE p.published_at
IS NOT NULL*\
*\`);*\
*const docs = rows.map(r =\> ({ \...r, updated_at: Math.floor(new
Date(r.updated_at).getTime()/1000) }));*\
*await ts.collections(\'people\').documents().import(docs, { action:
\'upsert\' });*\
*}*\
\
*(async()=\>{ await indexPeople(); process.exit(0); })();*\

## **S.8 CI minimal seed (Playwright/E2E friendly)**

Create a **tiny** dataset used by CI:

- One **verified** provider with 6 SFW images and a published profile.
- One **buyer** user with a funding source **mocked** in Stripe test
  mode.
- A studio with "Wi‑Fi" & "Lights".
- One available slot **today + 1 day** (Calendar §1.12).
- A single review (rating 5).

Provide **data IDs** as environment variables so tests don't need to
search.

*/seeds/ci_minimal.sql*:

*\-- Deterministic IDs & emails for CI logins*\
*\-- Ensure passwords match the non-prod constant*\

*.github/workflows/e2e.yml* runs:

*- run: psql \$DB_URL -f seeds/sql/baseline.sql*\
*- run: node -r esbuild-register seeds/seed.ts ci*\
*- run: node -r esbuild-register media-fixtures/gen_images.ts*\
*- run: node -r esbuild-register typesense/reindex_seed.ts*\
*- run: pnpm test:e2e*\

## **S.9 Stage masked clone (from prod) ---** ***/masking/stage_clone.sh***

**Goal:** Create a Stage database from a **fresh snapshot** of Prod
**with masking** before exposure to any non‑prod service.

*#!/usr/bin/env bash*\
*set -euo pipefail*\
*: \"\${PROD_DB_SNAPSHOT:?} \${STAGE_DB_CLUSTER:?}\"*\
\
*\# 1) Restore snapshot to temp cluster*\
*aws rds restore-db-cluster-from-snapshot \\*\
*\--db-cluster-identifier temp-stage-\$(date +%Y%m%d%H%M) \\*\
*\--snapshot-identifier \"\$PROD_DB_SNAPSHOT\" \\*\
*\--engine aurora-postgresql*\
\
*\# 2) Attach writer instance (wait until available)*\
*\# 3) Run masking SQL*\
*psql \"\$TEMP_DB_URL\" -f masking/stage_masking.sql*\
\
*\# 4) Swap Stage apps to temp cluster; decommission old Stage cluster*\

**Field‑level masking SQL** --- */masking/stage_masking.sql*

Mirrors Appendix O policy. This **does not** remove business
integrity---joins remain valid.

*\-- Emails → hashed aliases; phones removed; names pseudonymized;
message bodies replaced.*\
*UPDATE users SET*\
*email = \'u\_\' \|\|
substr(encode(digest(id::text,\'sha256\'),\'hex\'),1,12) \|\|
\'*[*\@example.invalid*](mailto:@example.invalid)*\',*\
*phone = NULL,*\
*display_name = initcap(split_part(md5(id::text), \'\', 1)) \-- or
\'User \'\|\|substr(\...)*\
*;*\
\
*UPDATE profiles SET*\
*bio = \'Sample profile for staging. No real personal information.\',*\
*tags = ARRAY\[\'portrait\',\'studio\'\],*\
*verified = false;*\
\
*\-- Replace media references with SFW fixtures*\
*UPDATE media_assets SET*\
*original_s3_key = NULL,*\
*sfw_s3_key = \'sfw/demo\_\' \|\|
(abs((\'x\'\|\|substr(md5(id::text),1,6))::bit(24)::int) % 300)::text
\|\| \'.png\',*\
*nsfw_score = 0;*\
\
*\-- Messages: encrypt empty body or lorem; keep timelines*\
*UPDA