<!-- id: TD-0123 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 442800-446800 -->

* *apps/mobile/linking.ts*

*export default {*\
*prefixes: \[\'rastup://\',\'https://rastup.com\'\],*\
*config: { screens: {*\
*Home: \'\',*\
*Messages: \'messages\',*\
*Booking: \'checkout/:id\',*\
*Profile: \'p/:handle\',*\
*Studio: \'s/:slug\'*\
*}}*\
*};*\

**Platform considerations (high‑level policy):** at launch, **PWA can be
primary**. If/when we publish native apps, limit the initial native
scope to discovery, booking, messages, and studios; keep **Fan‑Sub paid
content flows** in the web experience until we explicitly decide to
support native in‑app purchase workflows.

## **1.20.E Auth & session on device**

- **Cognito** hosted UI or embedded flows; JWTs stored in **HttpOnly
  Secure** cookies for Web/PWA; in RN, keep tokens in **secure storage**
  (Keychain/Keystore).
- **Session refresh** via refresh‑token rotation; background refresh
  guarded by app state.
- **Device trust**: bind push tokens and device fingerprints to user id
  for security & rate‑limits (§1.18).

## **1.20.F Messaging UX on mobile**

- **Thread list** with last message preview, unread counts, typing
  indicators; **thread view** with infinite scroll and media bubbles
  (SFW thumbnails).
- **Composer**: text, camera/gallery picker, quick templates.
- **Offline**: queue outgoing messages; retry with backoff; show pending
  state.
- **Abuse controls**: block/report from header; Safe‑Mode hides 18+
  previews.

## **1.20.G Push notifications (APNs/FCM via Pinpoint/SNS)**

**Token registration**\
**Recommended path:** *apps/mobile/push/register.ts*

*export async function registerPushToken(userId: string, token: string,
platform: \'ios\'\|\'android\'\|\'web\') {*\
*await gql.mutate(\'savePushToken\', { userId, token, platform, tz:
Intl.DateTimeFormat().resolvedOptions().timeZone });*\
*}*\

**Server routing**

- Use Pinpoint/SNS topics per **city** and per **user** for
  rate‑efficient broadcasts and 1:1 messages.
- **Quiet hours** enforce local‑time windows; **daily caps** per
  category (alerts/digests vs direct messages).
- Templates mirror §1.16 MJML text (title/body only; no 18+ previews).

## **1.20.H File uploads from camera/gallery**

- **Direct‑to‑S3 presigned PUT** (see §1.18.G) with client‑side resize
  (e.g., target ≤ 2048px longest).
- **EXIF strip** by default; user can opt‑in to keep GPS/time for studio
  evidence flows.
- **Progress & background**: show %; resume after app pause.
- **Virus/NSFW scan** on ingest (already defined in §1.14 and §1.10).

**Recommended path:** *apps/mobile/upload.ts*

*export async function uploadImage(fileUri: string, mime: string) {*\
*const { url, fields, key } = await gql.mutate(\'getPresignedUrl\', {
mime, purpose: \'preview\' });*\
*const body = await buildMultipart(fileUri, fields); // RN: fetch
blob/file*\
*const res = await fetch(url, { method: \'POST\', body });*\
*if (!res.ok) throw new Error(\'UPLOAD_FAILED\');*\
*return { key };*\
*}*\

## **1.20.I Safe‑Mode & age gating UX**

- **First‑run:** Safe‑Mode ON; explain what it does; clear toggle path
  in **Settings**.
- **Age verification** (when required): IDV web flow in secure webview;
  store only verdict and event id, not raw images (§1.18 data
  minimization).
- **Surface rules:** No push/email with 18+ previews; PWA and RN show
  SFW placeholders until Safe‑Mode OFF + verified.

## **1.20.J Performance budgets (mobile)**

**Targets (mobile P75):** LCP ≤ 2.5s (PWA), INP ≤ 200ms, TTI ≤ 3.5s,
bundle ≤ 900KB total on first load (GZIP).

**Tactics:**

- Code‑split heavy editors/maps; prefetch next screens on tap‑down;
  image lazy‑load with low‑quality placeholders;
  *fetchpriority=\"high\"* for LCP hero; local fonts with *font-display:
  swap*.
- For RN: Hermes engine, RAM bundles, Flipper disabled in prod,
  animation worklets only where needed.

**Budget file**\
**Recommended path:** *observability/budgets/mobile.json*

*{ \"pwaFirstLoadKB\": 900, \"pwaScriptKB\": 160, \"pwaImgPolicy\":
\"webp/avif\", \"rnBundleKB\": 420 }*\

## **1.20.K A