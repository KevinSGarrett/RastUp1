<!-- id: TD-0206 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 741600-745600 -->

and later Studios), power **Instant Book** (IB) and
**Request‑to‑Book** (RTB), support **rescheduling**, generate/consume
**calendar events (ICS)**, and (MVP) perform **read‑only external
imports** with an upgrade path to **two‑way sync**. Enforce
lead‑time/booking‑window rules, resolve conflicts deterministically, and
keep costs elastic.

## **1.12.1 Scope → Technical**

- **Availability**: weekly rules, per‑date exceptions
  (available/unavailable), vacations/blackouts, **booking window
  (days)**, **minimum lead time (hours)**, **minimum duration**.
- **Feasibility**: compute **bookable slots** from rules − exceptions −
  external busy − confirmed events − active holds.
- **Holds**: checkout/reschedule **soft blocks** with TTL; atomic
  conversion to **confirmed events** at booking/reschedule.
- **External calendars (MVP)**: **read‑only ICS import**
  (Google/Apple/Outlook private ICS); **outbound ICS** attachments on
  booking/reschedule emails (see §1.10).
- **Phase‑2 upgrade**: **Google Calendar** / **Microsoft 365** two‑way
  sync via webhooks/subscriptions.
- **Time zones & DST**: first‑class IANA time zones; correct handling of
  spring‑forward/fall‑back edge cases.
- **Cost**: serverless jobs, differential polling, feasibility cache;
  per‑user limits.

## **1.12.2 Architecture (Amplify Gen‑2 posture)**

- Frontend

  - **Availability Editor** (web + React Native): weekday windows,
    copy/paste week, per‑date overrides, vacation days; lead time,
    booking window, min duration; **preview calendar** of bookable
    times.
  - **Calendar Connect**: OAuth for Google/Microsoft (Phase‑2), or paste
    **ICS URL** (MVP); status, last sync time, resync button.

- Backend

  - **AppSync GraphQL** for CRUD (rules/exceptions), feasibility
    queries, holds, event conversion, external connect/disconnect,
    generating a tokenized **ICS feed URL** per user.
  - **Aurora Postgres (*****cal*** **schema)** for weekly rules,
    exceptions, holds, confirmed events, external sources & flattened
    external events, ICS feed configuration.
  - **DynamoDB** (ephemeral) for feasibility caches, reschedule
    candidate sets (short TTL), idempotency on hold creation.
  - **Jobs**: EventBridge scheduled Lambdas / Step Functions: ICS
    pollers, cache rebuilds, stale‑hold cleanup, feed generation.
  - **Events**: *cal.rule.updated*, *cal.exception.upserted*,
    *cal.hold.created\|expired*, *order.booked\|rescheduled\|cancelled*,
    *cal.ics.poll.ok\|error*.

- Delivery

  - **ICS attachments** in booking/reschedule emails (already defined in
    §1.10).
  - Optional personal **ICS feed** URL per provider with long random
    token.

## **1.12.3 Data model (Aurora schema** ***cal*****) --- paste‑ready DDL**

Create *db/migrations/020_calendar.sql* with:

*begin;*\
\
*\-- Weekly recurring availability rules*\
*create table cal.weekly_rule (*\
*rule_id text primary key, \-- wr\_*\
*user_id text not null, \-- provider*\
*role_code text not null, \-- model\|photographer\|\...*\
*weekday_mask int not null, \-- bitmask Mon..Sun*\
*start_local time not null,*\
*end_local time not null,*\
*timezone text not null, \-- IANA tz*\
*min_duration_min int not null default 60,*\
*lead_time_hours int not null default 24,*\
*booking_window_days int not null default 60,*\
*active boolean not null default true,*\
*created_at timestamptz default now(),*\
*updated_at timestamptz default now()*\
*);*\
\
*\-- Per-date overrides (vacation day, extended hours, special blocks)*\
*create table cal.exception (*\
*exc_id text primary key, \-- ex\_*\
*user_id text not null,*\
*date_local date not null,*\
*timezone text not null,*\
*kind text not null check (kind in (\'available\',\'unavailable\')),*\
*start_local time,*\
*end_local time,*\
*note text,*\
*created_at timestamptz default now()*\
*);*\
\
*\-- Holds (soft blocks) created by checkout/reschedule/admin*\
*create table cal.hold (*\
*hold_id text primary key, \-- hld\_*\
*user_id text not null,*\
*role_code