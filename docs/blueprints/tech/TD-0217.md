<!-- id: TD-0217 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 781200-785200 -->

unt.

## **1.13.F Feature flags & city gates (operational control)**

- Flags: *ff.pay.ach*, *ff.pay.deposit*, *ff.pay.reserve*,
  *ff.pay.instant_payouts*, *ff.tax.engine*, *ff.pay.lbg*.
- **City allow‑lists** enable staged rollout and quick rollback.

## **1.13.G Warehouse exports (finance facts)**

- Daily export of **payments**, **refunds**, **transfers**, **payouts**,
  **ledger** to analytics (Appendix E schema).
- Reconciliation job compares warehouse aggregates to Stripe **Balance
  Transactions**; alarm on variance \> 1¢ per order.

## **1.13.H Expanded tests & acceptance (additions)**

**Tests (add to §1.13.14):**

- LBG two‑leg allocation → refunds reverse per leg correctly.
- Tax lines present in facilitator cities; totals exact.
- Reserves → delayed transfer & timed release; freeze on dispute.
- Coupons reduce platform fee; ledger balanced.

**Acceptance (add to §1.13.16):**

- LBG data path compiles; group→leg allocations reconcile; warehouse
  totals match Stripe.
- Reserve & Early Payout policies are configurable and visible in
  Payouts UI.
- Dispute bundles generated with complete narrative and artifacts for
  every dispute.

## **Gate decision for §1.13 (your rule)**

I re‑audited §1.13 with these **addenda** applied. The section now
includes:

- End‑to‑end **checkout** and **funds flow** (cards + wallets at MVP).
- **Connect payouts** with reserves/early‑payout gating and full
  reconciliation.
- **Refunds/partial refunds** pre‑ and post‑transfer with transfer
  reversals.
- **Disputes** with automatic evidence pack assembly.
- **Tax hooks**, **coupons**, **feature flags**, **warehouse exports**,
  and **LBG** upgrade path.
- Complete **DDL**, **GraphQL**, **ledger**, **observability**,
  **tests**, and **acceptance**.

# **§1.14 --- Orders & Action Cards (Amendments, Approvals & Timeline) --- Full Technical Development Plan**

**Purpose.** Make every booking **auditable and adaptable** without
chaos: a single **Order** object with a strict **state machine**, a
**threaded timeline**, and typed **Action Cards** for all mid‑order
changes (Reschedule, Extras, Proofs/Approvals, Expense at cost, Dispute,
Complete). Cards are **double‑sided**, time‑boxed, Safe‑Mode aware
(media), and drive **payments**, **calendar**, **notifications**, and
**payout** changes automatically. Cost posture is serverless and
elastic.

## **1.14.1 Scope → Technical**

- **Authoritative Order** model (buyer↔provider, role context,
  start/end, location, policy snapshot, price snapshot).
- **Order State Machine** with legal transitions; automatic side effects
  (calendar holds/confirmations, payment captures/refunds,
  notifications).
- **Action Cards** (AC): *reschedule*, *extras*, *proofs*, *expense*,
  *complete*, *dispute*. Each has schema, lifecycle, deadlines, and one
  or more responses.
- **Timeline**: immutable event stream; in‑app rendering; email/push
  hooks; admin viewer.
- **Permissions**: strict, role‑aware; Safe‑Mode & SFW rules enforced on
  media.
- **Observability**: events, KPIs, SLOs, dashboards; alarms on stuck
  states.
- **Cost**: serverless Lambdas, Aurora for source of truth,
  S3/CloudFront for media, Dynamo caches/locks.

## **1.14.2 Architecture**

- **Frontend** (Next.js + RN):

  - **Order page** with **Timeline** (events + AC threads),
    status/header, money panel, people panel, attachments panel.
  - **Cards UI**: create/respond/approve flows; inline forms; proof
    galleries; expense uploader with receipt OCR (optional later).

- **Backend** (AppSync → Lambda):

  - **Order Service**: state transitions, price/policy snapshotting,
    timeline append, idempotency & locking.
  - **Cards Service**: create/respond/close per card type; fan‑out to
    Calendar (§1.12), Payments (§1.13), Media (§1.11), Notifications
    (§1.10), Reviews window (§1.9).
  - **Calendar**: holds for reschedule proposals; confirm events on
    acceptance.
  - **Payments**: captures, partial refunds, transfer reversals;
    reserv