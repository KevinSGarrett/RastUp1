<!-- id: TD-0333 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1198800-1202800 -->

s;
  evidence to *dsar_audit*.
- **Legal holds** override delete (e.g., active disputes); status
  communicated to user.

## **O.6 Lineage & cataloging**

- **Operational → Derived:**\
  Aurora (OLTP) → EventBridge → (optional) S3 data lake
  (raw/staged/curated) → Athena/QuickSight dashboards.
- **Catalog**: Glue Data Catalog tables tagged with *class*, *pii*,
  *regime* (table & column properties).
- **Column lineage**: optional **OpenMetadata** or **DataHub** adoption;
  capture joins and transforms for *orders*/*payments*.

**Glue example properties (per table):**

*Table Properties:*\
*governance:class=RESTRICTED*\
*governance:pii=direct*\
*governance:regime=gdpr,ccpa*\
*governance:retention=7y*\

## **O.7 Logging & redaction alignment (with Appendix L)**

- App logs **forbid** raw *messages.body* and *email*; only
  *hash(email)* and *message_id*.
- Structured log fields: *req_id*, *user_id(pseudo)*, *route*, *status*,
  *lat_ms*, *error_code*.
- Redaction helpers applied at logger boundary; CI test fails if
  "forbidden keys" appear.

## **O.8 Security controls**

- **KMS**: Multi‑Region keys for S3 objects and Secrets; key policies
  scoped (no wildcard principals).
- **Row‑level authorization** on all PII reads.
- **Audit**: all export/download of DSAR bundle logged with IP/UA.
- **Backups** encrypted; restore requires dual‑control (two approvers).

## **O.9 Automation jobs (schedulers & code stubs)**

### **O.9.1 Retention executor (Lambda) ---** ***governance/retention_job.ts*** **(skeleton)**

*import { Client as Pg } from \'pg\';*\
*import { S3Client, PutObjectCommand } from \'@aws-sdk/client-s3\';*\
\
*export const handler = async () =\> {*\
*const db = new Pg({ connectionString: process.env.DB_URL });*\
*await db.connect();*\
\
*// messages: drop old partitions*\
*await db.query(\"SELECT governance.drop_old_partitions(\'messages\',
interval \'18 months\')\");*\
\
*// logs_app/search_outbox: truncate older rows*\
*await db.query(\"DELETE FROM search.outbox WHERE created_at \< now() -
interval \'30 days\'\");*\
*await db.query(\"SELECT governance.apply_user_deletion_queue()\"); //
processes staged DSAR deletes*\
\
*await db.end();*\
*return { ok: true };*\
*};*\

### **O.9.2 Helper SQL ---** ***governance/sql/helpers.sql***

*CREATE OR REPLACE FUNCTION governance.drop_old_partitions(tbl text,
keep interval) RETURNS void AS \$\$*\
*DECLARE*\
*p record;*\
*cutoff text := to_char(date_trunc(\'month\', now() -
keep),\'YYYYMM\');*\
*BEGIN*\
*FOR p IN SELECT inhrelid::regclass::text AS name*\
*FROM pg_inherits WHERE inhparent =
(quote_ident(\'public\')\|\|\'.\'\|\|quote_ident(tbl))::regclass*\
*LOOP*\
*IF p.name \< tbl\|\|\'\_\'\|\|cutoff THEN*\
*EXECUTE \'DROP TABLE IF EXISTS \'\|\|p.name\|\|\' CASCADE\';*\
*END IF;*\
*END LOOP;*\
*END;*\
*\$\$ LANGUAGE plpgsql;*\

## **O.10 KPIs, alerts & audits**

- **DSAR**: export SLA met %, delete SLA met %.
- **Data retention**: rows purged per day; partitions dropped; S3
  lifecycle transitions completed.
- **Leak sentinel**: logs with forbidden keys **= 0** (Appendix L).
- **Consent**: mismatch rate between CMP and *consent_events* **= 0**.
- **Alerts**: failure of retention job; S3 lifecycle errors; DSAR
  backlog \> threshold; Object Lock bypass attempts.

## **O.11 Acceptance criteria (Appendix O = FINAL)**

5676. **Field‑level catalog** exists (CSV above or
      *governance/data_catalog.csv*) with
      *class/pii/regime/mask/retention/action* for every stored field
      in: *users*, *profiles*, *studios*, *media_assets*,
      *orders/payments/refunds*, *reviews*, *messages*, *calendar\_\**,
      *search.outbox*, *abuse\_\**, *logs\_\**, *consent_events*,
      *dsar_audit*.

5677. **Retention policies** are codified in
      *governance/retention_policies.yml* and enforced by:

      z.  Postgres partitions + scheduled jobs,
      a.  Dynamo TTLs,
      b.  S3 lifecycle + Object Lock,
      c.  Typesense reindexing.

5678. **DSAR** export and delete runbooks implemente