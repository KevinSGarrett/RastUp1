<!-- id: TD-0045 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 162000-166000 -->

d).

## **1.9.K SLOs & cost posture**

- **SLOs**:

  - Fee compute latency: **\<100 ms** p95.
  - Wallet apply latency: **\<75 ms** p95.
  - Daily close completes by **T+8h** local time; variance gating works.

- **Cost**: entirely serverless; no always‑on compute. S3 lifecycle on
  statements and exports (cold storage after 90 days). Stripe fees are
  pass‑through expenses; tax adapter paid per transaction.

## **1.9.L Error taxonomy (client‑safe)**

- *FEE_RULE_MISSING* --- no fee rule for city/role.
- *WALLET_INSUFFICIENT_FUNDS* --- requested apply exceeds balance.
- *WALLET_STALE_APPLY* --- PI amount changed; recompute then apply.
- *GL_EXPORT_RANGE_TOO_LARGE* --- split into batches.
- *MOR_MISCONFIGURED* --- MoR toggle inconsistent with tax settings
  (admin‑only).

## **1.9.M Test plan (CI + sandbox)**

**Fees & taxes**

852. Compute per‑leg fees & fee tax for different cities/roles; verify
     rounding; receipts show lines.
853. Earn revenue on completion; deferral → earned; reverse on refund
     both pre‑ and post‑earn.

**Wallet**\
3) Credit on refund residual; apply to checkout; reversal on failed PI;
double‑debit prevented by idempotency key.

**GL & recon**\
4) GL entries written at capture, completion, payout, refund, dispute;
sums balance.\
5) Recon: Σcharges == Cash delta ± Stripe fees; Σtransfers == Seller
Payable delta; variance gates payouts when off.

**MoR switch**\
6) Service tax to Seller Payable vs Tax Payable toggles correctly and
flows to statements/reports.

**Seller/Buyer statements**\
7) Generate period statements; totals tie to underlying
legs/payouts/charges.

**Performance**\
8) Fee compute p95 \< 100 ms; wallet apply p95 \< 75 ms under load.

## **1.9.N Work packages (Cursor agents)**

- Agent B --- Domain/Finance

  - WP‑FIN‑01: SQL migrations for *fee_ledger*, *wallet\_\**,
    *gl_entry*; fee calculator; MoR switch.
  - WP‑FIN‑02: GL writer and export; tie into §1.3 events; recon joins
    vs Stripe balance txns.

- Agent C --- Integrations

  - WP‑FIN‑TAX‑01: Tax adapter for platform fee tax; refund handling.
  - WP‑FIN‑STR‑01: Stripe balance transaction fetcher; mapping;
    webhooks.

- Agent A --- Web

  - WP‑WEB‑FIN‑01: Wallet UI and statements pages (buyer/seller).
  - WP‑WEB‑FIN‑02: Fee disclosure UI at checkout.

- Agent D --- Admin & QA

  - WP‑ADM‑FIN‑01: Finance console (rules, wallet adjustments, GL
    exports, MoR).
  - WP‑QA‑FIN‑01: Full test matrix automation; golden GL snapshots.

## **1.9.O Acceptance criteria (mark §1.9 FINAL only when ALL true)**

858. Platform fees computed per leg; fee taxes quoted; shown on
     receipts; earned on completion.
859. Wallet credits/debits behave atomically; cannot overdraft;
     idempotent reversals on failure paths.
860. GL entries capture capture/earn/payout/refund/dispute correctly;
     exports work; daily recon green 5/5 days.
861. MoR toggle correctly routes **service tax** to Seller Payable vs
     Tax Payable; platform fee tax always stays in Tax Payable.
862. Statements (buyer/seller) accurate and downloadable; platform
     exports ready for accounting.
863. Telemetry complete; SLOs met; costs within budget alarms.

# **§1.9 --- Payments & Wallet**

*(Platform fees · Taxes on fees · Separate "ads" credits vs. buyer
wallet · Statements · Accounting & revenue recognition · GL & recon ·
APIs · Admin · Telemetry · Tests · Cost)*

**Purpose.** Define the *financial core* that separates marketplace
**GMV** from **platform fee revenue**, treats **taxes correctly**, keeps
"ads credits" separate from "buyer wallet," and drives statements,
accounting, and reconciliation. This section makes our booking money
flows audit‑grade and implementation‑ready across **data model, fee
math, GL entries, APIs, admin tools, telemetry, SLOs, and tests**. It
aligns with §§1.3 (Checkout), 1.4 (Messaging/Project Panel), and 1.7
(Promotions).

We will not advance to §1.10 until §1.9 satisfies your 99.9% bar.

## **1.9.A Canon & invariants**

864. Money 