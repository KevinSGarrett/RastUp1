<!-- id: TD-0019 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 68400-72400 -->

he **full technical spec**---data models, APIs, realtime
behavior, file pipeline, moderation/safety rules, notifications, admin
tooling, telemetry, SLOs, tests, and cost levers.

We will not move to §1.5 until §1.4 hits your **99.9% coverage** bar.

## **1.4.A Canon & invariants**

- Thread kinds.

  - **Inquiry thread** (pre‑booking; can transition into a project on
    accept).
  - **Project thread** (post‑accept; bound to a **leg** or an **LBG**;
    unlocks Project Panel + action cards).

- **Project Panel anchors the contract.** It exposes structured tabs
  *inside* the conversation: **Brief**, **Moodboard**, **Shot list**,
  **Files**, **Docs & e‑sign**, **Expenses/Adjustments**, **Actions**.

- **Action cards** are typed, stateful message objects that **invoke
  domain flows** (reschedule, extras, overtime, deliverables
  accept/changes, cancellations/refunds, deposit claim, dispute). All
  are idempotent and audit‑friendly.

- **Files: "storage‑sane."** Public previews only in S3; final
  deliverables stay external (Drive/Dropbox/S3 owner links) captured as
  **immutable manifests** (name, size, checksum, URL).

- **Safety & policy.** Safe‑Mode thumbnails; NSFW scanning;
  anti‑circumvention nudges; role‑scoped moderation; report/block tools.

## **1.4.B Data model & storage**

**Hot path** in DynamoDB (messages, presence, ephemeral states).
**Source of truth** for bookings/legs/LBG/docs in Aurora (§1.3). S3 for
previews/manifests; EventBridge for async; AppSync GraphQL for API &
realtime.

### **B.1 DynamoDB single‑table (messaging)**

**Partition & sort:**

- **PK** = *THR#{threadId}*

- **SK**:

  - *THR* --- thread metadata (one item)
  - *PART#{userId}* --- participant membership & read cursors
  - *MSG#{ts}#{messageId}* --- message frames (append‑only)
  - *CARD#{messageId}* --- action‑card shadow (current state)
  - *TAB#{tab}* --- project panel tab state (denormalized snapshot for
    fast read)

**Core items:**

- Thread (THR)

*{*\
*pk: \"THR#thrd\_\...\",*\
*sk: \"THR\",*\
*kind: \"inquiry\|project\",*\
*lbgId: \"lbg\_\...\" \| null,*\
*legId: \"leg\_\...\" \| null,*\
*buyerUserId: \"usr\_\...\",*\
*sellerUserId: \"usr\_\...\",*\
*participants: \[\"usr\_\...\", \"usr\_\...\"\],*\
*city: \"Houston\",*\
*createdAt, updatedAt,*\
*status: \"open\|archived\|locked\",*\
*lastMessageAt,*\
*safeModeRequired: true\|false*\
*}*\

- Participant (PART#user)

*{*\
*pk: \"THR#thrd\_\...\",*\
*sk: \"PART#usr\_\...\",*\
*roleContext: \"buyer\|seller\|admin\",*\
*lastReadMsgId: \"msg\_\...\",*\
*lastReadAt,*\
*muted: bool,*\
*blockedUntil: ISO \| null*\
*}*\

- Message (MSG#ts#id)

*{*\
*pk: \"THR#thrd\_\...\",*\
*sk: \"MSG#2025-11-05T14:12:07.123Z#msg\_\...\",*\
*type: \"text\|asset\|system\|action\",*\
*body: \"sanitized markdown or plaintext\",*\
*attachments: \[ { kind: \"preview\|manifest\", s3Key\|manifestRef,
mime, w, h } \],*\
*action: { type, payload, state, version } \| null,*\
*authorUserId: \"usr\_\...\",*\
*nsfwBand: 0\|1\|2,*\
*flags: { moderation: \"clean\|flagged\|blocked\", policyHints: \[\...\]
},*\
*createdAt*\
*}*\

- Project Panel tab state (TAB#{tab})

  - *TAB#brief*, *TAB#moodboard*, *TAB#shotlist*, *TAB#files*,
    *TAB#docs*, *TAB#expenses*, *TAB#actions*\
    Snapshot JSON for fast open; canonical data lives in Aurora when
    contractual (docs, amendments, receipts).

**GSIs:**

- **GSI1 (inbox list)**: *GSI1PK = PARTICIPANT#usr\_\...*, *GSI1SK =
  lastMessageAt desc → threadId* (materialized via write fan‑out).
- **GSI2 (project threads by lbg/leg)**: *GSI2PK = LBG#lbg\_\...* or
  *LEG#leg\_\...*, *GSI2SK = createdAt*.

### **B.2 Presence & typing (ephemeral)**

- **Presence table** (DDB) with TTL (e.g., 60s):
  *presence#threadId#userId = lastSeen, typing=true/false*.
- Subscriptions broadcast presence changes; server filters access by
  membership.

### **B.3 S3 buckets (previews only)**

- *msg-previews* --- public‑size thumbs/videos (auto‑transcoded on
  upload); NSFW scan assigns *nsfwBand*.