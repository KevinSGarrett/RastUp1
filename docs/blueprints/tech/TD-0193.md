<!-- id: TD-0193 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 694800-698800 -->

ns: *booking_start_12h*, *reschedule_expiring_6h*,
  *dispute_activity*, *payment_failure*.

## **1.8.5 Event taxonomy & routing**

**Core events (initial catalog)**

- **Booking**: *booking.confirmed*, *booking.rescheduled*,
  *booking.reminder_24h*, *booking.reminder_1h*, *booking.completed*,
  *booking.review_window_opened*, *booking.review_window_closing*,
  *booking.cancelled.{buyer\|provider}*
- **Messaging/Inbox**: *msg.request.received*, *msg.request.accepted*,
  *card.requested.{reschedule\|extras\|proofs\|expense\|complete}*,
  *msg.unread_digest.daily\|weekly*
- **Payments**: *payout.scheduled*, *payout.released*, *payout.failed*,
  *payment.failed*, *refund.processed*
- **Trust & Safety**: *idv.started\|passed\|failed*,
  *bg.started\|adjudicated*, *safety.case.opened\|updated*
- **Support**: *ticket.created\|updated\|resolved*
- **Product nudges**: *onboarding.incomplete*, *portfolio.nudge*,
  *studio.nudge* (respect marketing toggles)

**Routing logic (Notification Orchestrator)**

3147. **Receive event** (SNS/Kinesis).
3148. **Build audience** (usually single user + sometimes counterpart).
3149. **Apply policy gates** (quiet hours, channel prefs, exceptions).
3150. **Select template** by event + role + locale.
3151. **Rate‑limit/idempotency** check.
3152. **Send** via SES/Pinpoint or enqueue **in‑app** row and WebSocket
      fan‑out.
3153. **Log** to *notify_send_log*.

## **1.8.6 Template system**

- **Storage**: *notify_template* (Aurora) with fields: *template_key*,
  *kind*, *locale*, *subject*, *mjml*, *text*, *push_title*,
  *push_body*, *inapp_title*, *inapp_body*, *variables\[\]*, *version*,
  *status(draft\|active)*.
- **Compilation**: MJML → HTML at publish time; cache compiled HTML in
  S3.
- **Variables**: strongly typed contract per event (e.g.,
  *{providerName, startTsLocal, city, ctaUrl}*); server fills variables;
  no client logic in templates.
- **Localization**: store per‑locale template variants; fallback to
  *en-US*.
- **A/B (Phase 2)**: optional *variant* field; split by percentage.

**Example (text‑only artifact)**

*template_key: booking.confirmed.provider.en-US*\
*subject: Your booking with {{buyerName}} is confirmed ---
{{startTsLocal}}*\
*mjml: \<mjml\>\...{{buyerName}}\...{{startTsLocal}}\...\<mj-button
href=\"{{ctaUrl}}\"\>Open booking\</mj-button\>\...\</mjml\>*\
*text: Booking confirmed with {{buyerName}} on {{startTsLocal}}.
Details: {{ctaUrl}}*\
*push_title: Booking confirmed*\
*push_body: {{buyerName}} on {{startTsLocal}} --- tap for details*\
*inapp_title: Booking confirmed*\
*inapp_body: {{buyerName}} on {{startTsLocal}}*\

## **1.8.7 Quiet Hours & critical exceptions**

- **User‑set window** (e.g., 22:00--07:00 local). During quiet hours,
  optional notifications **queue** for digest or delay until window end.

- **Always allow (unless user explicitly disables exceptions)**:

  - booking.reminder_24h\|1h
  - *reschedule_expiring_6h* (Action Card pending close)
  - *payment.failed*, *payout.failed*
  - safety.case.opened

- **ICS attachments**: Reminders include *.ics* files; these still send
  during quiet hours (critical timeline).

## **1.8.8 Digests (daily/weekly)**

- **Builder job** (Lambda scheduled) aggregates: new message requests,
  pending approvals (Action Cards), upcoming bookings with ICS links,
  recent files.
- **De‑dup** if a transactional mail already went out in the last N
  hours.
- **Timezone‑aware windows** per user; fallback to region default if tz
  missing.

## **1.8.9 Deliverability & suppression**

- **Domain setup**: SPF, DKIM, DMARC (p=quarantine → p=reject after
  warmup), brand alignment (same envelope/from).
- **Warmup**: ramp volume over 2--3 weeks; preferentially send
  booking/receipt (high‑engagement) first.
- **Feedback loops**: SES webhooks write
  ***notify_consent(action=\'hard_bounce\'\|\'complaint\')***;
  automatically suppress further sends; display banner in app to
  re‑confirm email.
- **Link tracking**: restricted to analytics o