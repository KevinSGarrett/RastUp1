<!-- id: TD-0170 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 612000-616000 -->

ccept/decline/block; credits and contact
  filters; anti‑spam throttles; rate limits for new accounts.
- **Action Cards** inside threads: **Propose/Reschedule**,
  **Extras/Overtime**, **Send Proofs/Approvals**, **Expense/Receipt**,
  **Mark Complete / Deliver**, **Dispute / Safety Flag**.
- **Notifications**: push/email real‑time + **daily/weekly digest**; ICS
  attachment for confirmed bookings.
- **Preferences**: per‑channel toggles, **Quiet Hours**,
  role/city‑specific alerts.
- **Safety**: block/report, nudges against off‑platform payment,
  Safe‑Mode image preview rules, content filters.
- **Search in Inbox**: by participant, date, keywords, attachments,
  action‑card types.
- **Privacy & audit**: immutable audit for escalations; case‑bound
  access for Admin.

## **1.4.2 Architecture (elastic & low‑cost)**

- **Frontend**: Next.js (web) + React Native (mobile). Inbox =
  virtualized lists; thread = sticky composer + cards.

- **API**: AppSync GraphQL with Lambda resolvers.

- **Storage**:

  - **Aurora Postgres** for threads, participants, message metadata,
    cards, and inbox indexes.
  - **S3** for attachments (images, proofs, receipts) with short‑TTL
    pre‑signed URLs.
  - **DynamoDB** for ephemeral **typing/presence**, **rate limits**,
    **idempotency**, and **Message Request** pending gates.

- **Events**: Kinesis/SNS bus (*msg.sent*, *card.accepted*,
  *request.accepted*, etc.) feeds notifications, analytics, and Admin.

- **Search**: Typesense collection *inbox_index* for fast
  participant/keyword search (sanitized; no sensitive PII).

## **1.4.3 Data model (Aurora + Dynamo + S3)**

**Recommended path:** *db/migrations/014_messaging_inbox.sql*

*begin;*\
\
*create type thread_kind as enum
(\'inquiry\',\'booking\',\'studio\',\'invite\',\'support\');*\
*create type request_status as enum
(\'pending\',\'accepted\',\'declined\',\'blocked\',\'expired\');*\
*create type message_kind as enum
(\'text\',\'image\',\'file\',\'card\');*\
\
*create table thread (*\
*thread_id text primary key, \-- thr\_\...*\
*kind thread_kind not null,*\
*subject text,*\
*owner_order_id text, \-- nullable; booking/studio link*\
*opened_by_user text not null,*\
*created_at timestamptz default now(),*\
*updated_at timestamptz default now(),*\
*last_msg_ts timestamptz*\
*);*\
\
*create table thread_participant (*\
*thread_id text references thread(thread_id) on delete cascade,*\
*user_id text not null,*\
*role text, \-- buyer\|provider\|host\|support*\
*status text not null check (status in
(\'active\',\'left\',\'blocked\')),*\
*last_read_ts timestamptz,*\
*muted_until timestamptz,*\
*primary key (thread_id, user_id)*\
*);*\
\
*create table message (*\
*message_id text primary key, \-- msg\_\...*\
*thread_id text not null references thread(thread_id) on delete
cascade,*\
*sender_user text not null,*\
*kind message_kind not null,*\
*body_text text, \-- for kind=\'text\'*\
*card_type text, \-- for kind=\'card\' (reschedule, extras, proofs,
expense, complete, dispute, safety)*\
*card_payload jsonb,*\
*attachment_meta jsonb, \-- for images/files*\
*created_at timestamptz default now(),*\
*edited_at timestamptz*\
*);*\
\
*create table message_request_gate (*\
*gate_id text primary key, \-- rqt\_\...*\
*thread_id text not null,*\
*target_user text not null, \-- the recipient who must accept/decline*\
*status request_status not null default \'pending\',*\
*expires_at timestamptz, \-- auto-expire if no action*\
*reason text \-- spam heuristic reason*\
*);*\
\
*create table user_block (*\
*blocker_user text not null,*\
*blocked_user text not null,*\
*created_at timestamptz default now(),*\
*primary key (blocker_user, blocked_user)*\
*);*\
\
*\-- Inbox indexing for fast lists*\
*create table inbox_index (*\
*user_id text not null,*\
*thread_id text not null,*\
*last_msg_ts timestamptz not null,*\
*folder text not null check (folder in
(\'all\',\'action\',\'bookings\',\'offers\',\'archived\',\'spam\')),*\
*unread_count int not null default 0,*\
*pi