<!-- id: TD-0320 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1152000-1156000 -->

dfront*\
*alerts: \[70, 90, 100\]*\
* - name: typesense-monthly*\
*amount_usd: 300*\
*tag: service:typesense*\
*alerts: \[70, 90, 100\]*\

## **AC.2 Unit-economics SQL (Athena) ---** ***analytics/sql/unit_economics.sql***

*WITH cost AS (*\
*SELECT service, SUM(cost_usd) AS usd*\
*FROM finops.daily_service_cost*\
*WHERE dt BETWEEN date_trunc(\'month\', current_date) AND current_date*\
*GROUP BY 1*\
*),*\
*bookings AS (*\
*SELECT COUNT(\*) AS c*\
*FROM gold.fact_orders*\
*WHERE created_at BETWEEN date_trunc(\'month\', current_date) AND
current_date*\
*AND status = \'COMPLETED\'*\
*)*\
*SELECT*\
*(SELECT usd FROM cost WHERE service = \'total\') / NULLIF((SELECT c
FROM bookings), 0) AS usd_per_booking,*\
*(SELECT usd FROM cost WHERE service = \'cloudfront\') / NULLIF((SELECT
c FROM bookings), 0) AS usd_per_booking_cf,*\
*(SELECT usd FROM cost WHERE service = \'typesense\') / NULLIF((SELECT c
FROM bookings), 0) AS usd_per_booking_search;*\

## **AC.3 Rightsizing script stub (Node) ---** ***ops/scripts/rightsizing.ts***

*import { CloudWatchClient, GetMetricStatisticsCommand } from
\"@aws-sdk/client-cloudwatch\";*\
*// Fetch Aurora CPU + Typesense latency, output suggestions to
raise/lower capacity.*\

## **AC.4 Acceptance**

- Budgets exist and alert; unit-economics dashboard shows \$/booking;
  one rightsizing action shipped per quarter.

# **Appendix U --- Threat Modeling & Abuse Automation (deep version)**

**Purpose.** Identify, prevent, detect, respond to, and learn from both
traditional security threats (STRIDE) and product‑abuse vectors (spam,
scraping, circumvention, chargeback farming). This appendix is **fully
actionable**: it includes a controls matrix, automation rules, storage
schemas, queries, WAF examples, resolver hooks, runbooks, dashboards,
and acceptance criteria.

**Stack context (assumed):** CloudFront + WAF (BotControl) → Next.js
(Amplify Gen‑2 Hosting) → AppSync (GraphQL) → Lambda → Aurora Serverless
v2 (Postgres) → S3/CloudFront (media) → Typesense (search) → Stripe
(payments) → EventBridge (events) → DynamoDB (abuse/ratelimit/feature
store).

## **U.0 Scope & Trust Boundaries**

**Surfaces:** Auth, Profiles/Studios & Media, Messaging, Search,
Booking/Payments, Partner API/Webhooks, Admin/Back‑office,
Platform/Infra.

**Trust boundaries (text DFD):**

- **Edge:** CloudFront/WAF/BotControl, rate‑limit, Geo/IP reputation,
  TLS termination.
- **API boundary:** AppSync Authorization (Cognito/JWT, IAM for
  internal), Resolver authz checks.
- **Data boundary:** Aurora (PII), S3 private originals, S3 public SFW
  variants, Typesense (public indices).
- **External:** Stripe webhooks, OAuth providers, email/SMS provider.

## **U.1 Controls Matrix (STRIDE + Abuse)**

**IDs (U‑xx)** are referenced by tests, alerts, and runbooks.

  ---------- ------------------ -------------------------- ----------------------------------------------------------------------------- --------------------------------------------------- ------------------------------------------------------------- ------------------
  **ID**     **Surface**        **Threat/Abuse**           **Prevent (P)**                                                               **Detect (D)**                                      **Respond (R)**                                               **Owner**
  **U‑01**   Auth               Credential stuffing        WAF BotControl; per‑IP login QPS; breach‑check; CAPTCHA on risk; lockout 5×   Login fail rate/ASNs dashboard; anomaly alerts      Auto‑throttle IP/ASN; flag account; require MFA challenge     Security
  **U‑02**   Auth               Account takeover           Device fingerprint; email verify; step‑up MFA on payout/edit                  New‑device + geo‑velocity events                    Session revoke; password reset; notify user                   Security/Support
  **U‑03**   Profiles/Media     NSFW leak on public        S3 originals private; SFW‑only variants; Safe‑Mode filters everywhere         "Public rende