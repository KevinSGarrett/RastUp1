<!-- id: TD-0072 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 259200-263200 -->

Search impressions (Silver)

*CREATE TABLE IF NOT EXISTS silver.fact_search_impressions*\
*WITH (format=\'PARQUET\', parquet_compression=\'SNAPPY\',
partitioned_by=array\[\'dt\'\]) AS*\
*SELECT*\
*date_format(received_at, \'%Y-%m-%d\') AS dt,*\
*received_at,*\
*coalesce(user_id, anon_id) AS actor_key,*\
*(payload_json -\>\> \'query_hash\') AS query_hash,*\
*(payload_json -\>\> \'result_pos\')::int AS result_pos,*\
*(payload_json -\>\> \'target_type\') AS target_type,*\
*(payload_json -\>\> \'target_id\') AS target_id,*\
*city,*\
*context.role AS role,*\
*ids\[\'impression_id\'\] AS impression_id*\
*FROM (*\
*SELECT event, received_at, user_id, anon_id, city, context, ids,*\
*json_parse(payload) AS payload_json*\
*FROM bronze_events*\
*WHERE event=\'search.card_impression\' AND env=\'prod\'*\
*) b;*\

- **Booking legs snapshot stream (Silver)**\
  (built from *leg.\** status events + finance webhooks)

*CREATE TABLE IF NOT EXISTS silver.fact_booking_legs*\
*WITH (format=\'PARQUET\', parquet_compression=\'SNAPPY\',
partitioned_by=array\[\'dt\'\]) AS*\
*SELECT*\
*date_format(received_at, \'%Y-%m-%d\') AS dt,*\
*ids\[\'leg_id\'\] AS leg_id,*\
*max_by(payload_json, received_at) AS latest_payload, \-- snapshot
reducer*\
*max(received_at) AS last_event_at*\
*FROM (*\
*SELECT event, received_at, ids, json_parse(payload) AS payload_json*\
*FROM bronze_events*\
*WHERE event LIKE \'leg.%\' AND env=\'prod\'*\
*) s*\
*GROUP BY 1, 2;*\

For full fidelity, prefer **dbt** incremental models on Athena to
express joins across *leg.\**, *refund.\**, *payout.\**.

### **D.2 dbt project skeleton (Athena adapter)**

*/data/dbt_project.yml*

*name: rastup_analytics*\
*version: 1.0.0*\
*profile: rastup_athena*\
*model-paths: \[\"models\"\]*\
*tests-paths: \[\"tests\"\]*\
*vars:*\
*env: prod*\

*/data/models/silver/fact_promotions_events.sql*

*{{ config(materialized=\'incremental\', unique_key=\'event_id\',
partition_by={\'field\': \'dt\'}) }}*\
\
*with base as (*\
*select*\
*md5(concat(event, cast(received_at as varchar),
coalesce(ids\[\'impression_id\'\], \'\'),
coalesce(ids\[\'campaign_id\'\], \'\'))) as event_id,*\
*date_format(received_at, \'%Y-%m-%d\') as dt,*\
*event,*\
*received_at,*\
*ids\[\'impression_id\'\] as impression_id,*\
*ids\[\'campaign_id\'\] as campaign_id,*\
*city,*\
*context.role as role,*\
*json_extract_scalar(payload, \'\$.invalid_reason\') as invalid_reason*\
*from {{ ref(\'bronze_events\') }}*\
*where env=\'{{ var(\"env\") }}\'*\
*and event in
(\'promo.impression\',\'promo.click\',\'promo.invalid_click\')*\
*{% if is_incremental() %}*\
*and received_at \> (select coalesce(max(received_at), timestamp
\'1970-01-01\') from {{ this }})*\
*{% endif %}*\
*)*\
*select \* from base;*\

*/data/models/gold/kpi_promo_ctr.sql*

*{{ config(materialized=\'table\', partition_by={\'field\':\'dt\'}) }}*\
*select*\
*dt,*\
*campaign_id,*\
*count_if(event=\'promo.impression\') as impressions,*\
*count_if(event=\'promo.click\') as clicks,*\
*(count_if(event=\'promo.click\') /
nullif(count_if(event=\'promo.impression\'),0)) as ctr*\
*from {{ ref(\'fact_promotions_events\') }}*\
*group by 1,2;*\

*/data/models/schema.yml* (tests)

*version: 2*\
*models:*\
* - name: fact_promotions_events*\
*columns:*\
* - name: event_id*\
*tests: \[not_null, unique\]*\
* - name: kpi_promo_ctr*\
*columns:*\
* - name: dt*\
*tests: \[not_null\]*\

## **1.13.G (expanded) --- Data Quality, Validation & Lineage**

### **G.1 Great Expectations suite (examples)**

*/data/quality/expectations/fact_booking_legs.yml*

*expectations:*\
* - expect_table_columns_to_match_ordered_list:*\
*column_list: \[dt, leg_id, latest_payload, last_event_at\]*\
* - expect_column_values_to_not_be_null:*\
*column: leg_id*\
* - expect_column_values_to_be_between:*\
*column: latest_payload.total_cents*\
*min_value: 0*\
* - expect_compound_columns_to_be_unique:*\
*column_list: \[dt, leg_id\]*\

*/data/quality/expectations/fact_promotions_events.yml*

*expectations:*\
* - expect_column_values_to_b