<!-- id: TD-0051 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 183600-187600 -->


(\'email\',\'push\',\'sms\',\'inapp\')),*\
*locale text not null default \'en-US\',*\
*category text not null, \--
\'transactional\',\'security\',\'legal\',\'product\',\'marketing\'*\
*subject_mjml text, \-- for email (subject pre-render)*\
*body_mjml text, \-- email MJML or HTML*\
*body_text text, \-- fallback plain text*\
*push_json jsonb, \-- title/body/data for push*\
*sms_text text, \-- SMS body*\
*inapp_json jsonb, \-- in-app payload template*\
*variables_json jsonb not null, \-- required vars schema*\
*is_active boolean default true,*\
*created_by text not null,*\
*created_at timestamptz not null default now(),*\
*published_at timestamptz,*\
*unique (name, version, locale, channel)*\
*);*\
\
*\-- 2) Preference categories (system-defined)*\
*create table comms_category (*\
*category_id text primary key, \-- cat\_\...*\
*key text unique not null, \--
\'booking\',\'messages\',\'reviews\',\'promotions\',\'security\',\'legal\'*\
*description text not null,*\
*critical boolean not null default false \-- if true, cannot fully
opt-out*\
*);*\
\
*\-- 3) User preferences & quiet hours*\
*create table comms_pref (*\
*pref_id text primary key, \-- prf\_\...*\
*user_id text not null, \-- usr\_\...*\
*channel text not null check (channel in
(\'email\',\'push\',\'sms\',\'inapp\')),*\
*category_key text not null references comms_category(key),*\
*opted_in boolean not null default true, \-- default true except
marketing/SMS*\
*updated_at timestamptz not null default now(),*\
*unique (user_id, channel, category_key)*\
*);*\
\
*create table comms_quiet_hours (*\
*user_id text primary key, \-- usr\_\...*\
*tz text not null, \-- IANA tz string*\
*start_local time not null, \-- e.g., \'21:00:00\'*\
*end_local time not null \-- e.g., \'08:00:00\'*\
*);*\
\
*\-- 4) Message audit & status*\
*create table comms_message (*\
*msg_id text primary key, \-- cms\_\...*\
*user_id text not null, \-- recipient*\
*channel text not null,*\
*template_name text not null,*\
*template_version int not null,*\
*category_key text not null,*\
*locale text not null,*\
*dedupe_key text not null, \-- for collapsing bursts*\
*subject text,*\
*body_rendered_s3 text, \-- emails: rendered HTML in S3 (immutable)*\
*body_text text, \-- plaintext snapshot (where safe)*\
*status text not null check (status in
(\'queued\',\'sent\',\'delivered\',\'bounced\',\'complained\',\'dropped\',\'suppressed\',\'failed\')),*\
*provider_ref text, \-- SES message id, etc.*\
*cause_event text not null, \-- domain event name*\
*cause_ref text not null, \-- leg_id/lbg_id/thread_id/etc.*\
*created_at timestamptz not null default now(),*\
*updated_at timestamptz not null default now()*\
*);*\
\
*\-- 5) Suppression & bounces (email/SMS)*\
*create table comms_suppression (*\
*suppress_id text primary key, \-- sup\_\...*\
*channel text not null,*\
*address_hash text not null, \-- hashed email or phone*\
*reason text not null check (reason in
(\'hard_bounce\',\'complaint\',\'manual\')),*\
*created_at timestamptz not null default now(),*\
*unique (channel, address_hash)*\
*);*\
\
*\-- 6) In-app notifications*\
*create table inapp_notification (*\
*inapp_id text primary key, \-- iap\_\...*\
*user_id text not null,*\
*category_key text not null,*\
*title text not null,*\
*body text not null,*\
*deep_link text,*\
*unread boolean not null default true,*\
*created_at timestamptz not null default now()*\
*);*\

**DynamoDB (hot path):**

- *comms_tokens* (push tokens per device, per user, with expiry,
  platform).
- *comms_dedupe* (keyed by *dedupe_key*, TTL 2--5 minutes) to collapse
  bursts.
- *comms_queue_cursor* to preserve stable batches during paging.

**S3:**

- *comms-rendered/...* stores immutable HTML bodies & PDFs (statements)
  referenced by *comms_message.body_rendered_s3*.

## **1.10.D Template system & variables**

- **Authoring**: Email uses **MJML** → compiled to inline‑styled HTML.
  SMS uses strict text length (truncate & link to in‑app). Push uses
  *{title, body, data}*. In‑app stores 