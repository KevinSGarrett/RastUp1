<!-- id: TD-0203 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 730800-734800 -->

e text not null,*\
*width int, height int, bitrate int,*\
*created_at timestamptz default now()*\
*);*\
\
*\-- Proof galleries (watermarked, expiring)*\
*create table media.proof_gallery (*\
*gallery_id text primary key, \-- prf\_\...*\
*order_id text not null, \-- ord\_\...*\
*owner_user_id text not null,*\
*title text,*\
*expires_at timestamptz,*\
*allow_selections boolean not null default true,*\
*created_at timestamptz default now()*\
*);*\
\
*create table media.proof_item (*\
*gallery_id text not null references media.proof_gallery(gallery_id) on
delete cascade,*\
*asset_id text not null references media.asset(asset_id) on delete
cascade,*\
*ordinal int not null default 0,*\
*primary key (gallery_id, asset_id)*\
*);*\
\
*\-- Deliverable bundles (final, non-watermarked)*\
*create table media.deliverable (*\
*deliverable_id text primary key, \-- del\_\...*\
*order_id text not null,*\
*owner_user_id text not null,*\
*title text,*\
*license_code text, \-- maps to §1.7 license tiers*\
*created_at timestamptz default now()*\
*);*\
\
*create table media.deliverable_item (*\
*deliverable_id text not null references
media.deliverable(deliverable_id) on delete cascade,*\
*asset_id text not null references media.asset(asset_id) on delete
cascade,*\
*ordinal int not null default 0,*\
*primary key (deliverable_id, asset_id)*\
*);*\
\
*commit;*\

We intentionally separate **Asset** (single source of truth) from
**Variants** (renditions), **Proof Galleries** (watermarked, expiring)
and **Deliverables** (final licensed set).

## **1.11.5 GraphQL API (AppSync)**

**Paste into** *api/schema/media.graphql* *(selected but complete for
MVP)*

*enum AssetKind { IMAGE VIDEO AUDIO PDF ZIP OTHER }*\
*enum AssetStatus { INGESTED QUARANTINED PROCESSING BLOCKED READY }*\
\
*type Asset {*\
*id: ID!, ownerUserId: ID!, kind: AssetKind!, bytes: Int!, mime:
String!,*\
*status: AssetStatus!, width: Int, height: Int, durationSec: Float,*\
*sfwBand: Int!, safeModeRequired: Boolean!, variants: \[Variant!\]!,
meta: AWSJSON*\
*}*\
\
*type Variant { id: ID!, scope: String!, name: String!, url: AWSURL!,
mime: String!, width: Int, height: Int, bitrate: Int }*\
\
*type ProofGallery { id: ID!, orderId: ID!, title: String, expiresAt:
AWSDateTime, allowSelections: Boolean!, items: \[Asset!\]! }*\
*type Deliverable { id: ID!, orderId: ID!, title: String, licenseCode:
String, items: \[Asset!\]! }*\
\
*input RequestUploadInput { kind: AssetKind!, bytes: Int!, mime:
String!, fileName: String! }*\
*type RequestUploadResult { assetId: ID!, uploadUrl: AWSURL!, headers:
AWSJSON!, expiresAt: AWSDateTime! }*\
\
*type Mutation {*\
*requestUpload(input: RequestUploadInput!): RequestUploadResult!
\@aws_cognito_user_pools*\
*completeUpload(assetId: ID!): Boolean! \@aws_cognito_user_pools*\
\
*createProofGallery(orderId: ID!, title: String, expiresAt: AWSDateTime,
allowSelections: Boolean = true, assetIds: \[ID!\]!): ID!
\@aws_cognito_user_pools*\
*createDeliverable(orderId: ID!, title: String, licenseCode: String,
assetIds: \[ID!\]!): ID! \@aws_cognito_user_pools*\
*}*\
\
*type Query {*\
*asset(id: ID!): Asset! \@aws_cognito_user_pools*\
*proofGallery(id: ID!): ProofGallery! \@aws_cognito_user_pools*\
*deliverable(id: ID!): Deliverable! \@aws_cognito_user_pools*\
*}*\

**Access rules**

- **Assets**: owner read; participants read via **thread/order scope**
  (AppSync auth rule checks); public variants accessed through **signed
  CloudFront URLs** (Safe‑Mode respected).
- **Proofs**: buyer & provider read; public surfaces never show proof
  URLs.
- **Deliverables**: buyer & provider read; download logs stored (for
  licensing evidence).

## **1.11.6 Upload & processing flows**

**A) Upload (client → S3)**

3310. Client calls *requestUpload* with **kind/mime/size**.
3311. Server validates quotas/types; returns **presigned PUT** URL &
      headers.
3312. Client uploads directly to *media-raw* (chunked/resumable if
      large).
3313. Client calls *completeUpload(assetId)*; server ve