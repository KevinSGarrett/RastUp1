<!-- id: TD-0066 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 237600-241600 -->

UPED‑ready metrics.

## **1.13.B High‑level architecture**

- Ingestion (near real‑time):

  - App & web clients send event envelopes to an authenticated
    **/collect** endpoint (AppSync → Lambda).
  - Backend services publish **domain events** (the ones we enumerated
    across §§1.3--1.12) to **EventBridge**.
  - External providers (Stripe, e‑sign, SES) → webhook ingesters →
    normalized events → EventBridge.

- Transport & storage:

  - **EventBridge → Kinesis Firehose → S3** (partitioned
    *dt=YYYY‑MM‑DD/hour=HH*).
  - Bronze stored as **newline‑delimited JSON**; compaction jobs produce
    **Parquet** for Athena.
  - **Glue Catalog** defines tables for Bronze and Silver; partitions
    registered automatically.

- Transformations:

  - **AWS Glue** (PySpark) or **Athena CTAS** jobs to build Silver/Gold
    on schedules (NRT 5--15 min for ops, hourly/daily for heavy facts).
  - **dbt‑core on Athena** for modeling, tests, and lineage (optional
    but recommended).

- Serving & BI:

  - **Athena** for ad‑hoc; **QuickSight** (SPICE) for dashboards;
    optional **Metabase** (open‑source) on top of Athena/Redshift.
  - **Ops pages** in Admin use **materialized views** (Athena CTAS to
    Parquet) for low‑latency.

## **1.13.C Event envelope & contracts**

**Envelope (all events)**

*{*\
*\"event\": \"string\", // e.g., \"checkout.start\", \"payout.paid\"*\
*\"v\": 1, // schema version*\
*\"occurred_at\": \"2025-11-06T15:24:18Z\",*\
*\"received_at\": \"2025-11-06T15:24:19Z\",*\
*\"user_id\": \"usr\_\...\", // optional for anon*\
*\"anon_id\": \"an\_\...\", // sticky browser/device id when user not
logged in*\
*\"session_id\": \"ses\_\...\", // client session*\
*\"city\": \"houston\", // normalized city code when relevant*\
*\"device\": { \"ua\": \"hash\", \"os\": \"iOS\", \"app_ver\": \"1.0.3\"
},*\
*\"context\": { \"role\": \"buyer\|seller\|studio_owner\|admin\" },*\
*\"ids\": { \"lbg_id\": \"lbg\_\...\", \"leg_id\": \"leg\_\...\",
\"doc_id\": \"doc\_\...\" },*\
*\"money\": { \"amount_cents\": 12345, \"currency\": \"USD\" }, //
present when applicable*\
*\"payload\": { /\* event-specific fields, see below \*/ }*\
*}*\

**Conventions**

- **Amounts** always in integer cents.
- **Durations** in seconds.
- **Booleans** plain; **enums** strict strings.
- **PII** (names, emails, phones, addresses) **never** included---join
  on ids in Silver when necessary.

**Example families (non‑exhaustive; aligned to earlier sections)**

- **Search (§1.2):** *search.query*, *search.results_view*,
  *search.card_impression*, *search.card_click*, *search.save*,
  *search.alert.create\|triggered*.
- **Checkout/Booking (§1.3):** *checkout.start*,
  *docs.pack.create\|signed*,
  *payment.intent.created\|succeeded\|failed*, *lbg.confirmed*,
  *leg.in_progress\|completed*, *amendment.added*,
  *refund.created\|succeeded*, *payout.queued\|paid\|failed*.
- **Messaging (§1.4):** *thread.create*, *message.send*,
  *action.create\|state_change*, *deliverable.proof\|final\|approved*.
- **Docs (§1.5):** *doc.pack.issued\|signed*, *doc.pdf.hash_verified*.
- **Trust (§1.6):** *idv.started\|passed\|failed*,
  *bg.invited\|clear\|consider*, *risk.score.updated*.
- **Promotions (§1.7):** *promo.impression\|click\|invalid_click*,
  *promo.spend.debit\|credit*, *promo.topup.charge.succeeded*.
- **Reviews (§1.8):** *review.create\|hide\|remove\|restore*,
  *reputation.recompute*.
- **Comms (§1.10):** *notification.sent*,
  *email.bounce\|complaint\|unsubscribe*.
- **Studios (§1.11):** *studio.quote.request\|response*,
  *studio.verification.approved\|revoked*.
- **Infra (§1.12):** *waf.block*, *alarm.triggered*,
  *deploy.succeeded\|failed* (for internal SRE metrics).

We will ship **JSON Schemas** per event type with unit tests to
guarantee backward‑compatible evolution (*v* increments only on breaking
changes).

## **1.13.D Bronze → Silver → Gold modeling**

**Bronze (raw):**\
*s3://data/bronze/events/dt=YYYY‑MM‑DD/hour=HH/\*.json*

- Append‑only; immutable