<!-- id: TD-0191 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 687600-691600 -->

no open gaps versus your
non‑technical plan. Per your instruction, I'm proceeding
**sequentially** to **§1.8** and I will **not** move past it until §1.8
also meets the ≥99.9% bar.

# **§1.8 --- Notifications, Email, Push & Communication Preferences --- Full Technical Spec**

**Purpose.** Provide a single, compliant, cost‑efficient system for
**transactional** (e.g., booking confirmed), **behavioral** (e.g.,
pending approvals), and **digest** communications across **email, push,
and in‑app banners**, with **Quiet Hours**, **exceptions for
time‑critical events**, **global/user‑level preferences**,
**deliverability management (bounces/complaints)**, and **immutable
consent records**. This section centralizes pieces referenced in §1.3
(Bookings), §1.4 (Inbox & digests), §1.5 (Trust gates), §1.6 (Support),
§1.27 (SEO OG images), and ensures they use one pipeline.

## **1.8.1 Scope → Technical**

- **Channels:** Email (SES), Push (APNs/FCM via Amazon Pinpoint), In‑App
  (banner/toast/inbox).
- **Message types:** Transactional, Required‑service (e.g.,
  security/receipts), Optional notifications (user‑tunable), Marketing
  (off by default; future).
- **Preferences:** Global + per‑event granularity; **Quiet Hours** +
  **critical exceptions**; per‑device push opt‑in/out.
- **Templates:** MJML → HTML for email, text fallbacks, push payloads,
  in‑app JSON; localization‑ready.
- **Compliance:** consent capture, unsubscribe/suppression,
  CAN‑SPAM/GDPR/CCPA basics, age/region rules, data retention.
- **Deliverability:** signed domains (SPF/DKIM/DMARC), bounce/complaint
  processing, domain/IP warmup.
- **Cost:** serverless, SES/Pinpoint pay‑as‑you‑go; no third‑party ESP
  lock‑in at launch; adapters for Resend/Mailgun if needed later.

## **1.8.2 Architecture & vendors (cost‑conscious)**

- **Frontend**: Next.js & React Native **Preferences UI** and **in‑app
  notification components**.

- **Backend**: AppSync GraphQL → Lambda resolvers →

  - **SES** for email send, **Pinpoint** for push (APNs/FCM tokens
    managed per device), and **in‑app** via Aurora rows + WebSocket
    fan‑out (AppSync subscriptions).
  - **Event bus**: SNS/Kinesis topics (*booking.confirmed*,
    *card.requested*, *payout.failed*, *idv.passed*, etc.) feed a
    **Notification Orchestrator** (Lambda or Step Functions) that maps
    events → audiences → templates → deliveries.

- **Storage**:

  - **Aurora**: user preferences, consent ledger, template registry,
    in‑app notifications, digest schedules.
  - **DynamoDB**: rate‑limit tokens, idempotency keys per send,
    quiet‑hours cache, device tokens by user.
  - **S3**: template assets (logos), compiled MJML cache, SES event logs
    archive.

- **Amplify**: Use **Amplify Gen‑2** (not "classic") for Next.js hosting
  & CI/CD; environment variables for SES/Pinpoint; API category for
  AppSync; push credentials injected per platform.

## **1.8.3 Data model (Aurora schema** ***notify*****)**

**DDL --- pasteable** ***db/migrations/018_notify.sql***

*begin;*\
\
*create type notify_channel as enum (\'email\',\'push\',\'inapp\');*\
*create type notify_kind as enum
(\'transactional\',\'required\',\'optional\',\'marketing\');*\
\
*\-- Catalog of events we can notify on*\
*create table notify_event_catalog (*\
*event_key text primary key, \-- e.g., \'booking.confirmed\'*\
*kind notify_kind not null,*\
*default_enabled boolean not null default true,*\
*description text not null*\
*);*\
\
*\-- User-level preferences (global + per event)*\
*create table notify_pref (*\
*user_id text not null,*\
*event_key text not null,*\
*channel notify_channel not null,*\
*enabled boolean not null,*\
*updated_at timestamptz default now(),*\
*primary key (user_id, event_key, channel)*\
*);*\
\
*\-- Quiet hours and exceptions*\
*create table notify_quiet (*\
*user_id text primary key,*\
*start_local time not null,*\
*end_local time not null,*\
*timezone text not null,*\
*exceptions jsonb not null default \'\[\]\' \--
\[\"booking_start_12