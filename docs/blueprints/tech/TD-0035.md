<!-- id: TD-0035 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 126000-130000 -->

 (MVP):**

658. Start with campaigns active in *surface* + *city* (+ *role* if
     people).
659. Filter out those failing **eligibility** (trust, policy,
     completeness, Safe‑Mode).
660. Filter by **query filters** (price range, availability day if
     required, etc.).
661. Apply **budget availability** (daily balance left) & **pacing**
     (even distribution: remaining_budget / remaining_slots).
662. Produce a ranked **candidate set** ordered by: compliance →
     campaign freshness → spend vs target pacing (under‑pacing gets
     slight priority) → random tiebreaker for fairness.
663. Blend into organic results per §1.7.F.

## **1.7.F Blending & fairness**

**Density rules (configurable via** ***promo_policy*****):**

- At most *max_density_top20* promoted results in top‑20.
- At most *max_above_fold* promoted slots within the first screen.
- Never two promoted results back‑to‑back unless inventory is extremely
  low (flag‑gated).

**Featured slots**: reserve fixed positions (e.g., #2, #8). If fewer
eligible than slots, leave slot organic.

**Boosted slots**: insert after every *N* organic results starting after
position *P* (e.g., start at #6, then every 5 cards). Skip if no
eligible candidates.

**Diversity & rotation:**

- Per owner: at most one promoted result **from the same owner** in the
  top‑N to avoid crowd‑out.
- Rotation window ensures that if a campaign lost a slot in this query
  earlier, it gets priority next time (pacing).
- City‑wide fairness health metric monitors share of voice (%
  impressions) by owner.

## **1.7.G Click validation & fraud defenses**

**Instrumentation:**

- Every impression returns a unique ***impression_id*** embedded in the
  card.
- Clicks POST back with *{ impression_id }* + signed token; server
  enriches with *ip_hash*, *ua_hash*, *anon_fp_hash*, *user_id*.

**Dedup & windows:**

- Deduplicate multiple clicks from the **same session+impression**
  within **T seconds** (e.g., 45s).
- Only bill the **first valid click** per impression.

**Invalid click detection (near‑real‑time):**

- Heuristics: excessive frequency per IP block/FP, impossible geos vs
  city, bot UA, scroll‑less clicks, zero‑dwell.
- Scores and thresholds → if invalid: log *invalid_click* and **do not
  bill**.
- If billed earlier and later flagged in batch re‑processing → issue
  **make‑good credit** (ledger *kind=\'credit\'*).

**Abuse control:**

- Rate‑limit by IP block/FP; hard ban patterns into WAF; suspicious
  campaigns auto‑pause with alert to Admin.

## **1.7.H Budgets, pacing & pausing**

- **Budgets**: *daily_budget_cents* and optional *total_budget_cents*.

- **Pacing**:

  - *Even*: estimate eligible query volume and drip impressions/clicks
    over the day; slow or pause when spend exceeds expected pace.
  - *Accelerated*: allow faster delivery while respecting caps and
    eligibility.

- **Auto‑pause** when: daily budget exhausted, total budget reached,
  policy violation, or Trust score drops below threshold.

- **Resume rules**: manual or next day reset; spending resumes when
  budget refills or policy clears.

## **1.7.I Billing & credits (cost‑conscious MVP)**

**MVP billing model: Prepaid credits (lowest complexity)**

- Advertiser tops up credits via **Stripe** (platform customer).
- Spend ledger debits for each **valid click** at campaign's
  *cpc_cents*.
- When balance low (\< threshold), show in‑product **"low balance"**
  banner; auto‑recharge (optional).
- **Make‑good credits** issued on invalid‑click findings as positive
  ledger entries.
- Monthly statements available (CSV/PDF) with impressions, clicks, CPC,
  charges, credits, net spend.

**Phase‑up (optional): Stripe Billing metered**

- Create a metered product *promoted_click*; report usage daily; Stripe
  invoices monthly (postpaid).
- Keep **internal ledger** regardless for exact traceability and fraud
  credits.

**Tax on ad fees**

- If applicable by jurisdiction, apply sales tax to **ad
  purchases/top‑ups** (separate fro