<!-- id: TD-0236 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 849600-853600 -->

:true},*\
*{\"name\":\"verified\",\"type\":\"bool\",\"facet\":true},*\
*{\"name\":\"price_min\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"price_max\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"rating\",\"type\":\"float\",\"facet\":true},*\
*{\"name\":\"review_count\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"availability_score\",\"type\":\"float\"},*\
*{\"name\":\"lat\",\"type\":\"float\"},
{\"name\":\"lng\",\"type\":\"float\"},*\
*{\"name\":\"nsfw_band\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"tags\",\"type\":\"string\[\]\",\"facet\":true},*\
*{\"name\":\"published_at\",\"type\":\"int64\"}, // epoch seconds*\
*{\"name\":\"updated_at\",\"type\":\"int64\"},*\
*{\"name\":\"bio\",\"type\":\"string\"},*\
*{\"name\":\"headline\",\"type\":\"string\"},*\
*{\"name\":\"sfw_image_urls\",\"type\":\"string\[\]\"}*\
*\],*\
*\"default_sorting_field\":\"updated_at\",*\
*\"token_separators\":\[\"-\",\"\_\",\"/\",\".\"\],*\
*\"enable_nested_fields\":false*\
*},*\
*\"studios\": {*\
*\"fields\": \[*\
*{\"name\":\"id\",\"type\":\"string\"},*\
*{\"name\":\"handle\",\"type\":\"string\"},*\
*{\"name\":\"name\",\"type\":\"string\"},*\
*{\"name\":\"city\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"country\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"amenities\",\"type\":\"string\[\]\",\"facet\":true},*\
*{\"name\":\"verified\",\"type\":\"bool\",\"facet\":true},*\
*{\"name\":\"hourly_min\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"rating\",\"type\":\"float\",\"facet\":true},*\
*{\"name\":\"review_count\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"lat\",\"type\":\"float\"},
{\"name\":\"lng\",\"type\":\"float\"},*\
*{\"name\":\"availability_score\",\"type\":\"float\"},*\
*{\"name\":\"nsfw_band\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"published_at\",\"type\":\"int64\"},*\
*{\"name\":\"updated_at\",\"type\":\"int64\"},*\
*{\"name\":\"sfw_image_urls\",\"type\":\"string\[\]\"}*\
*\],*\
*\"default_sorting_field\":\"updated_at\"*\
*},*\
*\"work\": {*\
*\"fields\": \[*\
*{\"name\":\"id\",\"type\":\"string\"},*\
*{\"name\":\"author_id\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"title\",\"type\":\"string\"},*\
*{\"name\":\"roles\",\"type\":\"string\[\]\",\"facet\":true},*\
*{\"name\":\"city\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"nsfw_band\",\"type\":\"int32\",\"facet\":true},*\
*{\"name\":\"published_at\",\"type\":\"int64\"},*\
*{\"name\":\"sfw_image_urls\",\"type\":\"string\[\]\"},*\
*{\"name\":\"body\",\"type\":\"string\"}*\
*\],*\
*\"default_sorting_field\":\"published_at\"*\
*},*\
*\"help\": {*\
*\"fields\": \[*\
*{\"name\":\"id\",\"type\":\"string\"},*\
*{\"name\":\"slug\",\"type\":\"string\"},*\
*{\"name\":\"title\",\"type\":\"string\"},*\
*{\"name\":\"category\",\"type\":\"string\",\"facet\":true},*\
*{\"name\":\"body\",\"type\":\"string\"},*\
*{\"name\":\"updated_at\",\"type\":\"int64\"}*\
*\],*\
*\"default_sorting_field\":\"updated_at\"*\
*}*\
*}*\

**Safe‑Mode invariant:** All three public collections carry *nsfw_band*.
Public queries always enforce *nsfw_band \<= 1*. Email/OG previews never
fetch non‑SFW fields.

## **1.18.4 Indexer pipeline**

**Outbox table** (*db/migrations/025_search_outbox.sql*):

*begin;*\
*create schema if not exists search;*\
\
*create table search.outbox (*\
*event_id bigserial primary key,*\
*entity text not null check (entity in
(\'person\',\'studio\',\'work\',\'help\')),*\
*entity_id text not null,*\
*op text not null check (op in (\'upsert\',\'delete\')),*\
*payload jsonb not null,*\
*created_at timestamptz default now(),*\
*processed boolean not null default false*\
*);*\
*create index on search.outbox (processed, created_at);*\
*commit;*\

**Flow**

3882. Application services write normalized docs into *payload* (already
      SFW‑filtered if public).
3883. **Indexer Lambda** (every 1--2 minutes, or triggered by DB notify)
      upserts/deletes in Typesense.
3884. On success, mark *processed=true*. Failures retry 