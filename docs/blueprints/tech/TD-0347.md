<!-- id: TD-0347 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1249200-1253200 -->

al information.\',*\
*tags = ARRAY\[\'portrait\',\'studio\'\],*\
*verified = false;*\
\
*\-- Replace media references with SFW fixtures*\
*UPDATE media_assets SET*\
*original_s3_key = NULL,*\
*sfw_s3_key = \'sfw/demo\_\' \|\|
(abs((\'x\'\|\|substr(md5(id::text),1,6))::bit(24)::int) % 300)::text
\|\| \'.png\',*\
*nsfw_score = 0;*\
\
*\-- Messages: encrypt empty body or lorem; keep timelines*\
*UPDATE messages SET body_ciphertext = pgp_sym_encrypt(\'Sample staging
message\', \'stage_key\');*\
\
*\-- Payments: keep tokens only; drop any PII (last4 may remain if
business requires)*\
*UPDATE payments SET payout_destination_last4 = NULL;*\
\
*\-- Reviews: keep stars/text but ensure no personal data*\
*UPDATE reviews SET body = regexp_replace(body,
\'(\[A-Za-z0-9.\_%+-\]+@\[A-Za-z0-9.-\]+)\',\'\[redacted\]\',\'gi\');*\

For irreversible anonymization, you can call
*governance.anonymize_user()* for flagged cohorts; Stage should
**never** contain live PII.

## **S.10 S3 object rewrites for Stage**

A small job rewrites any media keys that are not in the *demo\_\** set:

*// masking/s3_rewrite.ts (pseudo)*\
*for (const key of listNonDemoKeys()) {*\
*const replacement = \`sfw/demo\_\${hash(key)%300}.png\`;*\
*putDB(\`UPDATE media_assets SET sfw_s3_key=\$1 WHERE sfw_s3_key=\$2\`,
\[replacement, key\]);*\
*}*\

## **S.11 Kill‑switches & side‑effect safety**

- **Email/SMS**: In Stage/Demo/CI, SMTP keys point to **black‑hole**
  accounts; app enforces *ALLOW_EXTERNAL_EMAILS=0*.
- **Stripe**: *STRIPE_TESTMODE=1*; webhooks go to test handler; **live
  secret keys must not be present** in non‑prod.
- **Webhooks (outbound)**: destinations disabled or pointed to a test
  sink; never hit partner systems.

## **S.12 KPIs & checks**

- Seeder execution time (dev/ci/demo).
- Row counts by entity; % with media; coverage of reviews.
- Masking coverage report: % emails in *\@example.invalid*, % messages
  altered, % media replaced.
- CI gate: **fail** if any email not ending in *\@example.invalid* is
  found in Stage/Demo.

**Example CI check (psql)**:

*psql \$DB_URL -Atc \"SELECT COUNT(\*) FROM users WHERE email NOT LIKE
\'*[*%@example.invalid*](mailto:%25@example.invalid)*\'\" \| grep
\'\^0\$\'*\

## **S.13 Runbooks**

**RB‑S‑01 Seed Dev**

*make db:reset*\
*psql \$DB_URL -f seeds/sql/baseline.sql*\
*node -r esbuild-register seeds/seed.ts dev*\
*node -r esbuild-register media-fixtures/gen_images.ts*\
*node -r esbuild-register typesense/reindex_seed.ts*\

**RB‑S‑02 Seed CI**

- Called by CI; minimal volumes; headless; no Typesense if unit‑only.

**RB‑S‑03 Stage Masked Clone**

5820. Restore latest snapshot to temp.
5821. Run */masking/stage_masking.sql* + *s3_rewrite.ts*.
5822. Smoke test (auth, search, profile, checkout in Stripe test).
5823. Swap Stage.
5824. Destroy old Stage.

## **S.14 Acceptance (Appendix S = FINAL)**

5825. **Seeders** run locally/CI/demo with deterministic outputs and no
      external side‑effects.
5826. **Media fixtures** exist and all non‑prod media are **synthetic**.
5827. **Stage** uses a **masked** clone; masking SQL & S3 rewrites
      executed on every refresh.
5828. **Typesense** reindex works after seeding; search returns
      realistic results.
5829. CI **gates** ensure no real PII, and seeds are available before
      E2E tests run.
5830. Runbooks RB‑S‑01...03 are documented and pass a dry‑run in the
      last 30 days.

# **Appendix T --- Glossary & Artifact Index (repo tree with paths) --- deep version**

**Purpose.** Make the plan navigable for engineers, auditors, and Cursor
agents. This appendix gives an **alphabetized glossary** and a **repo
file tree** mapping every major artifact referenced in §§1.0--1.30 and
Appendices H--S, plus U--R, Q, N, O, M, AC, Z, V, AA, AD.

## **T.1 Glossary (A→Z)**

- **Action Card** --- Typed order timeline message (e.g., *reschedule*,
  *extras*, *proofs*) that can mutate a booking on accept; spec in
  §1.14; UI in Appendix H.
- **Admin WORM Audit** --- Immutable, chained adm