<!-- id: TD-0044 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 158400-162400 -->

bit wallet up to
  available balance (*kind=\'debit\', source=\'checkout_apply\'*) and
  reduce charge amount; store the applied amount on the LBG for
  receipts.
- **Reversal**: if a checkout fails post‑debit, write *reversal* credit
  with same idempotency key to restore balance.

**GraphQL**

*type Wallet { balanceCents: Int!, currency: String! }*\
*type WalletTxn { walletTxnId: ID!, kind: String!, source: String!,
amountCents: Int!, createdAt: AWSDateTime! }*\
\
*type Query { myWallet: Wallet!, myWalletTxns(limit:Int=50,
cursor:String): \[WalletTxn!\]! }*\
*type Mutation {*\
*applyWalletToCheckout(draftId: ID!, maxCents: Int!): ApplyWalletResult!
\# returns appliedCents*\
*}*\

**Constraints**

- One wallet per user per currency (USD MVP).
- Wallet cannot go negative.
- Expiry on promo/referral credits optional (tracked in *note* or
  extended field later).

## **1.9.F Taxes on platform fees**

- Use same **Tax adapter** as §1.3 (TaxJar/Avalara/Stripe Tax).
- Quote **per leg** for *platform_fee_cents* → *platform_fee_tax_cents*
  using the buyer's tax nexus vs city gate rules.
- Record *TaxPayable:PlatformFeeTax* at capture; reverse appropriately
  on refunds.
- Include platform fee tax lines in buyer receipts and in platform tax
  reports.

## **1.9.G Statements & exports**

**Seller statement (monthly)**

- Payouts by date with links to legs/LBGs; adjustments (reserves,
  corrections); net totals.
- CSV + PDF; downloadable from Seller Finance console.
- If seller is MoR for service tax, clearly state seller‑level tax
  totals.

**Buyer statement (optional monthly)**

- Charges and refunds grouped; wallet credits/debits; tax totals;
  downloadable from account billing.

**Platform finance exports**

- **GL export**: *gl_entry* within date range.
- **Tax reports**: platform fee tax totals by city.
- **Stripe recon**: extract of balance transactions (charges, refunds,
  fees, transfers, payouts) and our correlated ids.

## **1.9.H APIs (GraphQL) --- finance views**

*type ChargeSummary { lbgId: ID!, amountCents: Int!, capturedAt:
AWSDateTime!, method: String! }*\
*type PayoutSummary { legId: ID!, amountCents: Int!, status: String!,
scheduledFor: AWSDateTime }*\
*type StatementLink { url: AWSURL!, kind: String!, period: String! }*\
\
*type Query {*\
*myCharges(from: AWSDate!, to: AWSDate!): \[ChargeSummary!\]!*\
*myPayouts(from: AWSDate!, to: AWSDate!): \[PayoutSummary!\]!*\
*myStatements(period: String): \[StatementLink!\]! \# \'2025-11\'*\
*}*\

Server enforces least‑privilege (buyer sees their charges; seller sees
their payouts; admins see all).

## **1.9.I Admin consoles (Finance)**

- **Fees & taxes**: fee rules by city/role; dry‑run previews on example
  legs; dual‑approval for rule changes.
- **Wallet**: credit/debit/adjustment tools with reason; hard caps for
  goodwill per admin.
- **GL & recon**: daily close board (tie‑in to §1.3.V), variance tiles,
  drill‑down to *gl_entry* and Stripe balance txn ids.
- **MoR toggle** (city gate): determines whether service taxes go to
  Seller Payable or Tax Payable.
- **Exports**: GL CSV, statements batch, tax reports.
- **Audits**: every money‑affecting admin action logged with
  before/after and two‑person approval when required.

## **1.9.J Telemetry & lineage**

- *fee.compute*, *fee.deferred.recorded*, *fee.earned.recorded*,
- *wallet.credit\|debit\|reversal*,
- *gl.entry.write*, *gl.export*,
- *recon.daily.start\|succeeded\|failed*, *recon.variance.notice*.\
  Every event includes *lbg_id/leg_id*, amounts, and relevant external
  refs (PI id, refund id, transfer id, balance txn id).

## **1.9.K SLOs & cost posture**

- **SLOs**:

  - Fee compute latency: **\<100 ms** p95.
  - Wallet apply latency: **\<75 ms** p95.
  - Daily close completes by **T+8h** local time; variance gating works.

- **Cost**: entirely serverless; no always‑on compute. S3 lifecycle on
  statements and exports (cold storage after 90 days). Stripe fees are
  pass‑through expenses; tax adapter paid per 