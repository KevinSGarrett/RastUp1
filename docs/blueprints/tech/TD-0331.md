<!-- id: TD-0331 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1191600-1195600 -->

\
*profiles:*\
*delete_after: account_life + 90d*\
*action: anonymize*\
*media_assets:*\
*delete_after: account_life + 90d*\
*action: delete \# originals & variants removed; tombstone retained
30d*\
*messages:*\
*delete_after: 18m*\
*action: delete*\
*orders:*\
*delete_after: 7y*\
*action: anonymize \# keep financial record, replace user references
with tokens*\
*payments:*\
*delete_after: 7y*\
*action: retain \# tokenized; required for reconciliation*\
*refunds:*\
*delete_after: 7y*\
*action: retain*\
*reviews:*\
*delete_after: account_life + 90d*\
*action: anonymize \# keep stars & text minus PII*\
*logs_app:*\
*delete_after: 30d*\
*action: delete*\
*search_outbox:*\
*delete_after: 30d*\
*action: delete*\
*abuse_events:*\
*delete_after: 180d*\
*action: delete*\
*analytics_events:*\
*delete_after: 25m*\
*action: delete*\
*consent_events:*\
*delete_after: 6y*\
*action: retain*\
*dsar_audit:*\
*delete_after: 6y*\
*action: retain*\

## **O.3 Enforcement mechanisms**

### **O.3.1 Postgres (Aurora) --- partitioning + scheduled jobs**

**Timeâ€‘range partitions** for *messages*, *logs_app*, *search_outbox*
enable **fast DROP**:

*\-- Example for messages monthly partitions*\
*CREATE TABLE public.messages (*\
*id uuid PRIMARY KEY,*\
*thread_id uuid NOT NULL,*\
*sender_id uuid NOT NULL,*\
*body_ciphertext bytea NOT NULL,*\
*created_at timestamptz NOT NULL*\
*) PARTITION BY RANGE (created_at);*\
\
*\-- Create partitions for 24 months rolling*\
*DO \$\$*\
*DECLARE m date := date_trunc(\'month\', now()) - interval \'12
months\';*\
*BEGIN*\
*WHILE m \<= date_trunc(\'month\', now()) + interval \'12 months\'
LOOP*\
*EXECUTE format(*\
*\'CREATE TABLE IF NOT EXISTS public.messages\_%s PARTITION OF
public.messages*\
*FOR VALUES FROM (%L) TO (%L);\',*\
*to_char(m, \'YYYYMM\'),*\
*m::timestamptz, (m + interval \'1 month\')::timestamptz*\
*);*\
*m := m + interval \'1 month\';*\
*END LOOP;*\
*END\$\$;*\

**Retention job** (runs nightly):

*\-- Drop partitions older than 18 months*\
*DO \$\$*\
*DECLARE cutoff date := date_trunc(\'month\', now() - interval \'18
months\');*\
*DECLARE p record;*\
*BEGIN*\
*FOR p IN SELECT relname FROM pg_class*\
*WHERE relname LIKE \'messages\_%\' AND relname \<
\'messages\_\'\|\|to_char(cutoff, \'YYYYMM\')*\
*LOOP*\
*EXECUTE \'DROP TABLE IF EXISTS
public.\'\|\|quote_ident(p.relname)\|\|\' CASCADE\';*\
*END LOOP;*\
*END\$\$;*\

### **O.3.2 Anonymization functions for DSAR/retention**

*CREATE EXTENSION IF NOT EXISTS pgcrypto;*\
\
*CREATE OR REPLACE FUNCTION governance.pseudonymize_uuid(u uuid) RETURNS
uuid AS \$\$*\
*SELECT (\'00000000-0000-0000-0000-\' \|\|
right(encode(digest(u::text,\'sha256\'),\'hex\'), 12))::uuid;*\
*\$\$ LANGUAGE SQL IMMUTABLE;*\
\
*CREATE OR REPLACE PROCEDURE governance.anonymize_user(p_user_id uuid)*\
*LANGUAGE plpgsql*\
*AS \$\$*\
*BEGIN*\
*\-- users*\
*UPDATE users SET*\
*email = concat(\'deleted+\', substr(md5(users.id::text),1,8),
\'*[*\@example.invalid*](mailto:@example.invalid)*\'),*\
*phone = NULL,*\
*display_name = \'Deleted User\',*\
*city = NULL, country = NULL*\
*WHERE id = p_user_id;*\
\
*\-- orders: keep financial record but break link to real user*\
*UPDATE orders SET buyer_id = governance.pseudonymize_uuid(buyer_id)
WHERE buyer_id = p_user_id;*\
*UPDATE orders SET seller_id = governance.pseudonymize_uuid(seller_id)
WHERE seller_id = p_user_id;*\
\
*\-- profiles*\
*UPDATE profiles SET headline = NULL, bio = NULL, tags = \'{}\' WHERE
user_id = p_user_id;*\
\
*\-- media: mark for asynchronous purge*\
*UPDATE media_assets SET deleted_at = now() WHERE owner_id =
p_user_id;*\
\
*\-- messages: hard delete older than 18m; mask newer if retention
window not yet elapsed*\
*DELETE FROM messages WHERE sender_id = p_user_id AND created_at \<
now() - interval \'18 months\';*\
*UPDATE messages SET body_ciphertext = decode(\'\', \'hex\') WHERE
sender_id = p_user_id;*\
\
*\-- reviews: keep stars, anonymize author reference*\
*UPDATE reviews SET author_id = governance.pseudonymize_uuid(author_id)
