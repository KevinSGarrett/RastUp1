<!-- id: TD-0268 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 964800-968800 -->

en and weekly active mobile users justify it
(threshold set in §1.21 dashboards).

## **1.26.3 App architecture**

**PWA (web)**

- **Routing**: */m/\** routes mirror desktop; no separate codebase.

- **Service Worker** (SW):

  - *app-shell* cache (stale‑while‑revalidate),
  - *help/\** cached (1--7 days),
  - API GETs for read‑only pages cached (1--5 min) with **Safe‑Mode**
    awareness (cache keys include *sfw=1*).

- **Storage**: IndexedDB via *idb* for drafts, outbox queue, and media
  chunk manifests.

**React Native (Expo, future)**

- **State**: Apollo Client normalized cache + SQLite offline store.
- **Background tasks**: Expo Task Manager --- periodic flush of outbox &
  upload chunks; resume on connectivity.

## **1.26.4 GraphQL additions (device & push) --- paste‑ready schema**

Create *api/schema/device.graphql*:

*enum DeviceKind { WEB_PWA IOS ANDROID }*\
*type DeviceToken { id: ID!, kind: DeviceKind!, token: String!,
createdAt: AWSDateTime!, lastSeenAt: AWSDateTime }*\
*type NotificationPref { email: Boolean!, sms: Boolean!, push: Boolean!,
quietStart: String, quietEnd: String }*\
\
*extend type Mutation {*\
*deviceRegister(kind: DeviceKind!, token: String, webPushEndpoint:
AWSURL, webPushP256dh: String, webPushAuth: String): Boolean!*\
*deviceUnregister(id: ID!): Boolean!*\
*setNotificationPrefs(prefs: NotificationPref!): Boolean!*\
*}*\
*extend type Query {*\
*getNotificationPrefs: NotificationPref!*\
*}*\

**Notes**

- For **Web Push**, store endpoint + keys; for **APNs/FCM**, store token
  only.
- *quietStart/quietEnd* inform §1.10 delivery rules.

## **1.26.5 Data model (Aurora) --- paste‑ready DDL**

Create *db/migrations/033_device_push.sql*:

*begin;*\
\
*create schema if not exists device;*\
\
*create type device.kind as enum (\'web_pwa\',\'ios\',\'android\');*\
\
*create table device.token (*\
*token_id text primary key, \-- dtk\_\...*\
*user_id text not null, \-- owner*\
*kind device.kind not null,*\
*token text, \-- apns/fcm*\
*web_endpoint text, \-- VAPID endpoint (web push)*\
*web_p256dh text,*\
*web_auth text,*\
*last_seen_at timestamptz default now(),*\
*created_at timestamptz default now(),*\
*unique (user_id, kind, coalesce(token, web_endpoint))*\
*);*\
\
*\-- Notification preferences per user*\
*create table device.pref (*\
*user_id text primary key,*\
*email boolean not null default true,*\
*sms boolean not null default true,*\
*push boolean not null default true,*\
*quiet_start time, \-- local time string (e.g., \'22:00\')*\
*quiet_end time*\
*);*\
\
*commit;*\

## **1.26.6 Camera & media uploads (mobile‑first flow)**

**Flow**

4566. Client requests **pre‑signed URLs** for a file (create "upload
      session" with chunk count & hashes).
4567. Client **chunks** (5--15 MB) and uploads directly to S3 with
      *Content‑MD5*.
4568. On *complete*, Lambda composes parts, strips EXIF (privacy),
      generates **SFW variant** (thumb/preview), and enqueues
      **moderation** (§1.24).
4569. When moderation passes, we **publish** asset to
      profile/work/gallery; otherwise stays private with reason banner.

**Resilience**

- Chunk manifest stored in IndexedDB/SQLite; retries on network change;
  resume upload by chunk index.
- Progress events update UI; background tasks continue after app
  minimize (RN) or resume on next foreground (PWA).

**Limits**

- Max file size and max duration per media type; reject HEIC if web
  delivery needs conversion; server converts to AVIF/WebP/MP4
  (h264/h265) for public SFW variants.

## **1.26.7 Offline & outbox**

- **Outbox model** (client): queue mutations (*message.send*,
  *profile.edit*, *media.upload.complete*, *checkout.start*) with
  conflict handling:

  - **Last‑write‑wins** on idempotent edits;
  - **Merge** for drafts;
  - **Abort** for expired checkouts.

- **Read caching**: profile/studio pages & help articles cached;
  invalidate via SW message on publish events.

- **Safe‑Mode when offline**: render only **SFW** cached content;
  non‑SFW or