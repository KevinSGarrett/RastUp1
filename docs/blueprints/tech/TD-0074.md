<!-- id: TD-0074 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 266400-270400 -->

ith CUPED
  pre‑period covariates (e.g., prior 28‑day spend or visits).

**Example (Gold) CUPED prep**

*CREATE TABLE gold.exp_metric_checkout_cuped AS*\
*SELECT*\
*e.exp_key, e.variant, e.user_id,*\
*count_if(m.event=\'checkout.start\') AS y_observed,*\
*\-- theta estimate computed offline or via regression; simplified
here*\
*avg(pre.y_baseline) as theta,*\
*(count_if(m.event=\'checkout.start\') - avg(pre.y_baseline)) as
y_cuped*\
*FROM dim_exposure e*\
*LEFT JOIN fact_events m ON e.user_id = m.user_id*\
*LEFT JOIN preperiod_agg pre ON e.user_id = pre.user_id*\
*WHERE e.exp_key=\'EXP_SEARCH_UI_A\'*\
*GROUP BY 1,2,3;*\

## **1.13.I (expanded) --- BI Datasets & Dashboards**

### **I.1 Datasets (QuickSight SPICE)**

- ***ds_kpi_marketplace*** (from *gold.kpi\_\**): GMV, bookings, take
  rate, conversion funnel.
- ***ds_ops_health***: payout backlog, recon variance, dispute queue,
  acceptance windows.
- ***ds_trust***: IDV/BG funnels, risk buckets, dispute outcomes.
- ***ds_promotions***: impressions, clicks, CTR, invalid rate, spend vs
  budget.
- ***ds_comms***: delivery, bounces, complaints, opt‑outs, digest
  suppression.
- ***ds_studios***: verification rate, amenity usage, quote success.

**Row‑level security**: if city‑restricted analyst roles exist, attach a
mapping table *analyst_city_scope* and enforce RLS in QuickSight
datasets.

### **I.2 Dashboard tiles (definitions)**

- **Executive**:

  - *GMV & Bookings*: *sum(gold.kpi_gmv_daily.gmv_cents)/100* with 7‑day
    trend.
  - *Take Rate*: *sum(platform_fees)/sum(gmv)*.
  - *Conversion Funnel*: stages from impressions→clicks→profile
    views→checkout→confirm.

- **Operations**:

  - *Recon variance*: *abs(charges - (payouts + refunds + fees))* with
    gate alarms.
  - *Payout backlog*: from NRT view *ops_payout_backlog*.

- **Trust**:

  - *IDV pass rate*: *idv.passed / (idv.passed + idv.failed)*.
  - *Risk buckets*: distribution over Watch/Action/Critical.

...(the rest are similar; all pull from Gold/NRT views above)

## **1.13.J (expanded) --- Cost Posture & Performance**

- **Firehose**: small buffers to limit latency; GZIP + dynamic
  partitioning; DLQ for failed records.

- **Athena**:

  - Enforce **workgroup** with **encryption on**, **query bytes cap**,
    and **results location** per env.
  - Use **CTAS** with *bucketed_by* only if needed (careful with cost).
  - Partition filters **always applied** (*WHERE dt BETWEEN ...*); add
    **city partition** to high‑volume facts (search, promotions) when
    warranted.

- **Glue**: schedule transforms during off‑peak; use minimal DPUs (e.g.,
  2--3) and **Athena CTAS** for many transforms to avoid Glue cost.

- **QuickSight**: prefer SPICE; schedule no more than 4--6 daily
  refreshes; monitor SPICE capacity and prune unused visuals.

**Budget alarms (per env):** S3 storage, Athena scanned bytes, Glue
DPU‑hours, QuickSight capacity, Firehose PUTs.

## **1.13.K (expanded) --- Admin & Runbooks**

- **Schema registry site** generated from */schemas/\*\*.json* + dbt
  docs; published to internal Amplify Hosting.

- **Backfill runner**: Step Functions flow

  - pick date range
  - CTAS Bronze→Silver for those partitions
  - rebuild impacted Gold models
  - verify Great Expectations → if fail, auto‑rollback.

- **Incident runbooks**:

  - *Pipeline lag*: pause heavy CTAS, widen Firehose buffers, notify
    Ops, degrade BI refresh to daily only.
  - *High Athena spend*: identify runaway queries in workgroup metrics;
    kill/limit; pin dashboards to SPICE only.
  - *Schema break*: move invalid events to *\_bad* quarantine; hotfix
    schema or add adapter transform.

## **1.13.L/M/N/O (expanded) --- Error Taxonomy, SLOs, Tests, Work Packages**

### **L. Error codes (operational)**

- *EVENT_SCHEMA_INVALID*, *EVENT_ENVELOPE_INVALID*, *EVENT_PUT_FAILED*,
- *PIPELINE_LAG_EXCEEDED*, *CTAS_FAILURE*, *QUALITY_CHECK_FAILED*,
- *ATHENA_SCANNED_BYTES_BREACH*, *BI_REFRESH_FAILED*, *DSAR_CONFLICT*.

Each emits a **CloudWatch metr