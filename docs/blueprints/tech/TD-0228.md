<!-- id: TD-0228 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 820800-824800 -->

\
*type ReferralInvite { inviteId: ID!, programId: ID!, inviterUserId:
ID!, acceptedAt: AWSDateTime }*\
*type CreditLedger { entryId: ID!, userId: ID!, kind: String!,
amountCents: Int!, reason: String!, createdAt: AWSDateTime! }*\
\
*input SavedSearchInput { scope: String!, city: String!, queryJson:
AWSJSON! }*\
\
*type Query {*\
*mySavedSearches: \[SavedSearch!\]!*\
*myFeed(cursor: String, limit: Int = 25, tab: String): FeedPage!*\
*myCredits: \[CreditLedger!\]!*\
*}*\
\
*type Mutation {*\
*createSavedSearch(input: SavedSearchInput!): SavedSearch!*\
*pauseSavedSearch(searchId: ID!, days: Int!): SavedSearch!*\
*deleteSavedSearch(searchId: ID!): Boolean!*\
\
*follow(targetId: ID!, targetKind: String!): Boolean!*\
*unfollow(targetId: ID!, targetKind: String!): Boolean!*\
\
*sendReferral(programId: ID!, inviteeEmail: String!): Boolean!*\
*redeemCredit(entryId: ID!, amountCents: Int!): Boolean!*\
*}*\

## **3) Schedules & workers (EventBridge + Lambdas)**

- **Saved-search alerts (daily)**: compute **new** matches since
  *last_alert_dt*, enforce **≤1/day/search**, create in-app + email (SFW
  previews only), update *last_alert_dt*.
- **Weekly city digest** (opt-in): "Featured case studies," "Verified
  Studios open slots," "Rising creators." No 18+ assets in email.
- **Book-Again**: send at **7/30/90 days** post-completion with
  prefilled scope.

## **4) Templates (MJML) --- alerts & "book again"**

- *saved_search_alert.mjml*: list up to 20 cards with SFW image, title,
  role, chips; include **Pause 30 days** link.
- *weekly_city_digest.mjml*: sections for case studies / verified
  studios / rising creators; unsubscribe/manage prefs links.
- *book_again_7d.mjml* (and 30/90): SFW preview, prior package
  name/price, **Open draft checkout** CTA.

## **5) Search ANY/ALL logic (Typesense/OpenSearch)**

- Query model: *{\"any\":\[\...\],\"all\":\[\...\]}* → base filter *city
  && isPublished && nsfw_band\<=1* (Safe-Mode) + *(ANY \|\| true) &&
  ALL*.
- Sorts: best/new/distance/price_low/high; distance only when origin
  present.
- Saved-search stored as normalized JSON; daily worker replays with
  **"new since last_alert_dt"** constraint.

## **6) UTM & attribution rules**

- *utm_source*: *lib\|sharecard\|digest\|alert*; *utm_medium*:
  *email\|inapp\|web*; *utm_campaign*:
  *pkg\|avail\|city_digest\|book_again_7\|book_again_30\|book_again_90\|referral*.
- Click token: *HMAC(user_id\|ts\|target)* 5-minute TTL → join to
  conversions in analytics (§1.13/§1.21).

## **7) Referral program mechanics (fraud-resistant)**

- **Programs**: provider↔provider, buyer↔buyer, cross-side (provider
  invites buyer).
- **Guardrails**: per-user **monthly caps**, ID verification gate to
  redeem, **same device/IP** detection, **clawback** if the invitee's
  first booking is refunded for fraud.
- **Credits scope**: apply to **platform fees only** (never reduce
  provider payout).
- **Award triggers**: "package published + 1st booking complete"
  (providers) / "brief posted + awarded + completed" (buyers).
- **Clawbacks**: write *credit_ledger(kind=\'clawback\')* when
  fraud/refund confirmed.

## **8) Feed & Follow**

- Unified feed with role tabs; SFW previews; Verified chip; ranking by
  recency + followed weight + verified; cap density to avoid spam.
- "Pair with Talent/Studio" deep-links retain date/city filters.

## **9) Tests (representative)**

3737. Saved-search new-matches only; **≤1/day/search** enforcements;
      30-day pause works.
3738. Weekly digest has SFW images only; opt-in respected.
3739. Feed role tabs return correct cards; Safe-Mode respected;
      pagination stable.
3740. Book-Again 7/30/90 prefill works; opt-out honored; conversions
      attributed via UTM/click tokens.
3741. Referrals: awards after qualification; monthly caps; device/IP
      checks; clawbacks on fraud/refund.
3742. Attribution pipeline joins click tokens to checkout conversions in
      analytics.

## **10) Acceptance criteria (mark §1.16 FINAL only when A