<!-- id: TD-0050 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 180000-184000 -->

ays in Tax Payable.
925. Statements (buyer/seller) accurate and downloadable; platform
     exports ready for accounting.
926. Telemetry complete; SLOs met; costs within budget alarms.

# **§1.10 --- Notifications & Comms**

*(templates & variables · channels (email/push/SMS/in‑app) · quiet hours
& preferences · deliverability & bounces · dedupe & batching · audits ·
admin · telemetry · tests · cost)*

**Purpose.** Build a cost‑efficient, privacy‑safe, and auditable
communications layer that delivers the right message on the right
channel at the right time---without noise, policy risk, or surprises.
This section specifies **data models, providers, APIs, message
templates, preference/quiet‑hours logic, deliverability & suppression,
dedupe & batching, admin tools, telemetry, SLOs, tests, and cost
levers**. We will *not* move on until §1.10 reaches your 99.9% bar.

**Note on scope alignment:** §1.10 covers platform communications
(system emails, SMS, push, and in‑app notifications). Thread messages
and action cards live in §1.4; finance emails/statements are integrated
but defined here for sending rules.

We'll complete §1.10 in **two parts** in case length exceeds limits.
This reply delivers **Part 1** (architecture, data model, templates,
providers, preferences/quiet hours, API, dedupe/batching). Next reply
(still §1.10) will cover **deliverability (DKIM/DMARC),
suppression/bounces, in‑app notification center,
experiments/localization, admin console, telemetry/SLOs, test matrix,
and cost**.

## **1.10.A Canon & invariants**

927. **User control first:** channel‑level **preferences** (opt‑in/out
     by category) and **quiet hours** are enforced server‑side for all
     non‑critical comms.
928. **Critical vs non‑critical:** payment receipts, security, and legal
     notices always send (with minimal content); marketing is opt‑in and
     rate‑limited.
929. **One source of truth:** every message is a **templated document**
     with **variables** and an **audit trail** (who/what/why/when).
930. **Dedupe & batching:** collapse bursts (e.g., 5 rapid messages → 1
     digest) and never notify a user about their **own** action unless
     explicitly warranted.
931. **Deliverability & compliance:** authenticated domains
     (SPF/DKIM/DMARC), bounce/complaint suppression, List‑Unsubscribe,
     CAN‑SPAM/TCPA/GDPR hygiene.
932. **Cost aware:** SES for email (default); FCM/APNs for push;
     SNS/Twilio for SMS behind a cost gate; in‑app first where possible.

## **1.10.B Providers & architecture**

- **Email**: Amazon **SES** (default). Optional SendGrid adapter
  (feature‑flag).
- **Push**: Web push via Firebase **FCM**; mobile push via **APNs**
  (iOS) and **FCM** (Android).
- **SMS**: AWS **SNS SMS** (default) or **Twilio** via adapter
  (feature‑flag & per‑country pricing).
- **In‑app**: Real‑time via AppSync subscriptions; persisted in Aurora
  for unread counters.

**Pipeline (event‑driven):**\
Domain event → **Comms Router** (rules engine) → **Renderer** (select
template, fill variables, localize) → **Channel workers**
(email/push/SMS/in‑app) → Provider → **Webhook ingesters** (deliveries,
opens, bounces, complaints) → **Suppression & analytics**.

**Backpressure & retries:** SQS queues per channel with DLQ; exponential
backoff with idempotency keys.

## **1.10.C Data model (Aurora + DynamoDB + S3)**

*\-- 1) Template catalog (versioned)*\
*create table comms_template (*\
*template_id text primary key, \-- tpl\_\...*\
*name text not null, \-- \"booking_confirmed_buyer\"*\
*version int not null,*\
*channel text not null check (channel in
(\'email\',\'push\',\'sms\',\'inapp\')),*\
*locale text not null default \'en-US\',*\
*category text not null, \--
\'transactional\',\'security\',\'legal\',\'product\',\'marketing\'*\
*subject_mjml text, \-- for email (subject pre-render)*\
*body_mjml text, \-- email MJML or HTML*\
*body_text text, \-- fallback plain text*\
*push_json jsonb, \-- title/body/data for push*\
*sms_text text, \-- SMS 