<!-- id: TD-0028 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 100800-104800 -->

 webhook rejected.
- *DOC_REISSUE_REQUIRED* --- leg change invalidated pack; re‑issue
  needed.
- *DOC_LEGAL_HOLD* --- action blocked until hold removed.

All error payloads include *code*, *message*, *hint*, *corrId*.

## **1.5.O Performance & cost**

- Rendering happens in Lambda with **concurrency caps**; fall back to a
  headless render service if pages \> threshold.
- E‑sign costs are **per envelope**; we minimize packs to one Talent
  pack and one Studio pack at MVP.
- S3 + lifecycle rules keep storage costs low; PDFs are compacted (fonts
  embedded once) and gzipped for transport.

## **1.5.P Test plan (CI + sandbox)**

**Library & templates**

543. Create/publish clause v2; ensure v1 remains immutable; template
     references correct clause versions.
544. City/role gates: Houston‑only template isn't applied in non‑gated
     city.
545. Variables: missing var → *DOC_VARS_MISSING* with exact field list.

**Pack assembly & signing**\
4) Generate packs for LBG (Talent + Studio); envelopes created;
Doc‑Before‑Pay enforced.\
5) Signer email bounce → re‑send after email change.\
6) Envelope expired → re‑issue pack; prior PDFs retained as superseded.

**Hashing & evidence**\
7) Render & store PDF; verify pre‑sign vs post‑sign hash strategy;
receipts reference post‑sign hash.\
8) Evidence export contains PDFs, metadata, and sign events.

**Re‑issue triggers**\
9) Reschedule booking time → pack invalidated; re‑generated; prior pack
voided.\
10) Change deposit or deliverables → pack invalidated; new pack
required.

**Admin**\
11) Clause edit requires dual approval; diff viewer shows exact changes;
publish logs audit.\
12) Void envelope audit trail present; legal hold blocks changes.

**Integration**\
13) Messaging panel shows live doc status; action cards prompt signing;
completion system message posted.\
14) Checkout blocks payment until all envelopes completed; then proceeds
to payment intent confirm.

## **1.5.Q Work packages (Cursor 4‑agent lanes)**

- **Agent A --- Docs CMS & Templates**\
  WP‑DOCS‑01: SQL for *doc_clause*, *doc_template*, *doc_pack*,
  *doc_instance*, *doc_sign_event*.\
  WP‑DOCS‑02: Clause & Template authoring UI in Admin
  (create/edit/publish, preview with variable binding).\
  WP‑DOCS‑03: Variable resolver library (maps from
  *leg*/*LBG*/profile/brief to variables).
- **Agent B --- Rendering & Storage**\
  WP‑REND‑01: Markdown→PDF renderer (headless) with layout json; S3
  write; SHA‑256 hash.\
  WP‑REND‑02: Evidence export builder (ZIP + JSON manifest).
- **Agent C --- E‑sign Adapter**\
  WP‑SIGN‑01: Envelope create/void; signer link flows; webhooks with
  HMAC verify; status mapper.\
  WP‑SIGN‑02: Retry and error handling; email change + re‑send;
  expiration handling.
- **Agent D --- Product Integration**\
  WP‑CHK‑DOCS‑01: Checkout gating (Docs‑Before‑Pay) + GraphQL mutations
  (*createDocPack*, *markDocSigned*).\
  WP‑MSG‑DOCS‑01: Messaging Project Panel "Docs & e‑sign" tab + action
  cards.\
  WP‑QA‑DOCS‑01: Full test matrix above in CI & sandbox.

## **1.5.R Acceptance criteria --- mark §1.5 FINAL only when ALL true**

550. Clause & Template library supports versioning, city/role gates,
     previews, and dual approvals for publish.
551. Pack assembly resolves variables, renders PDFs, creates envelopes,
     and enforces Docs‑Before‑Pay across both legs in an LBG.
552. Completed envelopes change pack status to *signed*; payment capture
     proceeds; receipts reference doc IDs and **post‑sign hashes**.
553. Re‑issue logic invalidates packs when
     scope/time/location/party/deposit changes; prior PDFs retained and
     auditable.
554. Hashing verified; S3 storage and retention policies active; legal
     hold works.
555. Messaging displays doc status and action prompts; Admin can
     search/void/resend with full audits.
556. Telemetry complete; evidence export works; error taxonomy produced
     for all failure modes.
557. Costs within budget; renderer concurrency capped; e‑sign envelopes
   