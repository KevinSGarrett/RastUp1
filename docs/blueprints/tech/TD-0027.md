<!-- id: TD-0027 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 97200-101200 -->

lope_id*,
  signer URLs (embedded) or email invites.
- *void_envelope(envelope_id, reason)* (on re‑issue).
- Webhooks: *envelope.sent*, *recipient.viewed*, *recipient.signed*,
  *envelope.completed*, *envelope.declined*, *envelope.voided*,
  *envelope.expired*.

**Security & idempotency**

- HMAC‑verified webhooks; store *provider_event_id*; dedupe.
- Signer links time‑limited; deep links route through our app to enforce
  auth and logging.

**Signer experience**

- In‑app embedded signing preferred; email fallback.
- Save/resume; clear error for expired/voided.

**Failure handling**

- *ENVELOPE_EMAIL_BOUNCE* → allow email change & re‑send (admin or
  user).
- *ENVELOPE_EXPIRED* → re‑issue pack (new doc version).

## **1.5.H Hashing & immutability**

- After rendering, compute **SHA‑256** of PDF bytes; store in
  *doc_instance.render_pdf_sha256*.
- Include the hash (shortened) in the PDF footer.
- All envelopes completed → verify provider's returned PDF by
  recomputing a **post‑sign hash**; store both **pre‑sign** and
  **post‑sign** hashes with a small allowed delta (some providers stamp
  signatures).
- **Receipts** reference *doc_id* and *post_sign_hash*.
- **Evidence export** pulls PDFs and a CSV/JSON of envelope metadata +
  sign events.

## **1.5.I Access control & privacy**

- Doc packs visible to **buyer**, **seller**, and **studio owner** (for
  studio packs), plus **admins** per RBAC.
- PII fields are masked in UI except where legally required.
- Downloads are signed URLs; access logged (actor, time, reason for
  admin).
- **Legal hold** blocks deletions and re‑issues until released.

## **1.5.J Integrations with §§1.3--1.4**

- **Checkout (§1.3):** *createDocPack* and *markDocSigned* mutations;
  payment step hard‑blocked until all envelopes are *completed*.
- **Messaging (§1.4):** Doc status appears in Project Panel "Docs &
  e‑sign" tab; **action card** prompts sign; completion posts a system
  message with doc ids and hashes.

## **1.5.K Notifications & templates**

- Triggers: envelope sent, signer reminder (24h cadence), nearing
  expiry, completed.
- Channels: email (primary), push (secondary), SMS (reminders only, no
  links to PII).
- Templates parameterized by *{role}*, *{doc_name}*, *{deadline}*,
  *{thread_url}*; live in the Comms adapter.

## **1.5.L Admin console (Legal, Support, City Ops)**

- **Clause Library:** create/edit/publish clause versions; preview with
  variable fills; city/role gates; diff viewer.
- **Templates:** compose clauses, manage signer roles, publish; A/B
  testing slot (flag‑gated).
- **Packs:** search by *pack_id*, *leg_id*, *lbg_id*, *status*;
  void/re‑issue; change signer email; resend invites.
- **Audits:** immutable logs of every change and envelope event; export
  function for legal.
- **Dual approval:** Required to publish templates or clauses that
  affect **money/safety/legal**.

## **1.5.M Telemetry & lineage**

- doc.pack.create\|issued\|signed\|voided\|superseded
- doc.envelope.sent\|viewed\|signed\|completed\|declined\|expired
- *doc.pdf.rendered*, *doc.pdf.hash_verified*
- doc.admin.publish_clause\|publish_template\|void_envelope
- Correlate with *leg_id*, *lbg_id*, *charge_id* for end‑to‑end
  traceability.

## **1.5.N Error taxonomy**

- *DOC_VARS_MISSING* --- required variables absent or invalid.
- *DOC_TEMPLATE_GATED* --- template not available for city/role.
- *DOC_SIGNER_MISSING* --- signer role not mapped to a valid email/user.
- *DOC_RENDER_FAIL* --- renderer error (retry with backoff).
- *ENVELOPE_CREATE_FAIL* --- provider API error.
- *ENVELOPE_HMAC_INVALID* --- webhook rejected.
- *DOC_REISSUE_REQUIRED* --- leg change invalidated pack; re‑issue
  needed.
- *DOC_LEGAL_HOLD* --- action blocked until hold removed.

All error payloads include *code*, *message*, *hint*, *corrId*.

## **1.5.O Performance & cost**

- Rendering happens in Lambda with **concurrency caps**; fall back to a
  headless render service if pages \> threshold.
- E‑sign costs are **per e