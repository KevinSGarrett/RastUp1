<!-- id: TD-0238 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 856800-860800 -->

ch*.
- **Suggestions**: prefix search over *handle*, *display_name*, *city*,
  and frequent tags with Safe‑Mode gate.

## **1.18.9 Availability & pricing integration**

- **availability_score** = sigmoid of available slot count in next 14
  days for the role; updated hourly during active hours.
- **price bands**: server computes band field (*\$*, *\$\$*, *\$\$\$*)
  from price_min/max; used for faceting and sort.

## **1.18.10 Caching, pagination & rate limits**

- **Caching**: Dynamo (2--10 min TTL) for hot queries (top city×role
  combos). Cache keys include normalized filters and **user
  personalization hash** (follow list digest) so boosts don't leak.
- **Pagination**: Typesense *page* mapped to **cursor** tokens (opaque).
- **Rate limits**: per‑IP and per‑user QPS with soft CAPTCHA on abuse;
  suggestion endpoint stricter.

## **1.18.11 Security, safety & privacy**

- **Safe‑Mode** always appended on public; staff/admin override via
  signed header only on internal consoles.
- **PII** never indexed (emails, phones); we index only public‑consent
  fields.
- **Takedowns** (DMCA/policy from §1.15) result in outbox *delete*
  events; purge within **≤ 5 minutes**.

## **1.18.12 Observability & KPIs**

- **Events**: *search.query*, *search.suggest*, *search.result_click*,
  *search.zero_results*, *index.upsert\|delete\|error*.
- **KPIs**: query→profile‑view CTR, profile‑view→checkout start rate,
  zero‑result rate, cache hit rate, p95 search latency, index staleness
  (time since last upsert for hot docs).
- **Alerts**: zero‑results spike, index backlog \> N, search latency p95
  \> target, outbox error rate.

## **1.18.13 Work packages (Cursor --- 4 agents)**

- **Agent A --- Indexer**: outbox DDL, indexer Lambda (upsert/delete),
  normalization, retries/back‑off, poison‑queue alarms.
- **Agent B --- Search API**: GraphQL schema & resolver, query builder,
  ranking, Safe‑Mode enforcement, caching & cursoring.
- **Agent C --- Frontend UX**: search box + suggestions, filters/facets,
  result cards, sort modes, skeletons, empty‑state flows.
- **Agent D --- Ops & Quality**: synonyms/typos config,
  dashboards/alerts, AB test hooks for ranking weights.

## **1.18.14 Tests (representative)**

3918. **Relevance**: exact match outranks partial; verified/available
      boosts apply; proximity sorting stable.
3919. **Safety**: NSFW assets never appear in public results; staff
      override works only with signed header.
3920. **Index freshness**: profile update triggers outbox → upsert →
      visible within SLA (\<5 min).
3921. **Spelling**: 1--2 typos produce correct top‑k; synonyms map
      correctly.
3922. **Personalization**: followed creators boosted; blocked excluded;
      cache separation by personalization digest.
3923. **Performance**: p95 search API latency \< 200 ms for cached; \<
      450 ms for cache misses at steady load.
3924. **Abuse**: rapid query spam triggers rate limit; suggestions
      endpoint throttles earlier.
3925. **Zero results**: "did‑you‑mean" suggestions shown; log for
      analysis.

## **1.18.15 Artifacts (paste‑ready)**

- *ops/typesense/collections.json* --- schema above.
- *db/migrations/025_search_outbox.sql* --- outbox table.
- *api/schema/search.graphql* --- GraphQL API.
- *services/search/indexer.ts* --- upsert/delete pipeline.
- *services/search/query.ts* --- query builder & ranker.
- *web/components/Search/\** --- UX components (search box, results,
  facets).
- *observability/dashboards/search.md* --- KPIs & alert specs.
- *ops/runbooks/search-index.md* --- reindex, synonyms, and rollback
  procedures.

## **1.18.16 Acceptance criteria --- mark §1.18 FINAL only when ALL true**

3934. People/Studios/Work are indexed with Safe‑Mode fields and upsert
      within **≤ 5 minutes** of changes.
3935. Search supports **text + facets + geo + sort**, with **ANY/ALL**
      filters, cursor pagination, and suggestions; public queries never
      leak NSFW.
3936. Ranking blends relevance, proximity,