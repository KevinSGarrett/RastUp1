<!-- id: TD-0207 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 745200-749200 -->

l,*\
*date_local date not null,*\
*timezone text not null,*\
*kind text not null check (kind in (\'available\',\'unavailable\')),*\
*start_local time,*\
*end_local time,*\
*note text,*\
*created_at timestamptz default now()*\
*);*\
\
*\-- Holds (soft blocks) created by checkout/reschedule/admin*\
*create table cal.hold (*\
*hold_id text primary key, \-- hld\_*\
*user_id text not null,*\
*role_code text not null,*\
*start_utc timestamptz not null,*\
*end_utc timestamptz not null,*\
*source text not null check (source in
(\'checkout\',\'reschedule\',\'admin\')),*\
*order_id text, \-- optional linkage*\
*ttl_expires_at timestamptz not null,*\
*created_at timestamptz default now()*\
*);*\
\
*\-- Confirmed booking instances (authoritative)*\
*create table cal.event (*\
*event_id text primary key, \-- cev\_*\
*user_id text not null,*\
*role_code text not null,*\
*order_id text not null,*\
*start_utc timestamptz not null,*\
*end_utc timestamptz not null,*\
*status text not null check (status in (\'confirmed\',\'cancelled\')),*\
*created_at timestamptz default now(),*\
*updated_at timestamptz default now()*\
*);*\
\
*\-- External calendar connections*\
*create table cal.external_source (*\
*src_id text primary key, \-- cxs\_*\
*user_id text not null,*\
*kind text not null check (kind in
(\'ics\',\'google\',\'microsoft\')),*\
*url_or_remote_id text not null, \-- ICS url or remote calendar id*\
*status text not null check (status in
(\'active\',\'paused\',\'error\')) default \'active\',*\
*last_poll_at timestamptz,*\
*last_etag text,*\
*created_at timestamptz default now(),*\
*updated_at timestamptz default now()*\
*);*\
\
*\-- Flattened external events (busy) for conflict checks*\
*create table cal.external_event (*\
*ext_event_id text primary key, \-- xev\_*\
*src_id text not null references cal.external_source(src_id) on delete
cascade,*\
*user_id text not null,*\
*start_utc timestamptz not null,*\
*end_utc timestamptz not null,*\
*busy boolean not null default true,*\
*summary text,*\
*recurrence_id text, \-- normalized id for recurring instances*\
*updated_at timestamptz default now()*\
*);*\
\
*\-- Per-user outbound ICS feed (tokenized URL)*\
*create table cal.ics_feed (*\
*feed_id text primary key, \-- ifd\_*\
*user_id text not null,*\
*token text not null unique, \-- long random token*\
*include_holds boolean not null default false,*\
*created_at timestamptz default now()*\
*);*\
\
*commit;*\

## **1.12.4 GraphQL API (AppSync) --- pasteâ€‘ready schema**

Create *api/schema/calendar.graphql*:

*type WeeklyRule {*\
*id: ID!, role: String!, weekdayMask: Int!,*\
*startLocal: String!, endLocal: String!, timezone: String!,*\
*minDurationMin: Int!, leadTimeHours: Int!, bookingWindowDays: Int!,
active: Boolean!*\
*}*\
*type Exception {*\
*id: ID!, dateLocal: AWSDate!, timezone: String!,*\
*kind: String!, startLocal: String, endLocal: String, note: String*\
*}*\
*type Hold { id: ID!, startUtc: AWSDateTime!, endUtc: AWSDateTime!,
source: String!, orderId: ID, ttlExpiresAt: AWSDateTime! }*\
*type CalEvent { id: ID!, orderId: ID!, startUtc: AWSDateTime!, endUtc:
AWSDateTime!, status: String! }*\
*type FeasibleSlot { startUtc: AWSDateTime!, endUtc: AWSDateTime! }*\
\
*type Query {*\
*myWeeklyRules(role: String!): \[WeeklyRule!\]!*\
*myExceptions(dateFrom: AWSDate!, dateTo: AWSDate!): \[Exception!\]!*\
*myCalendar(dateFrom: AWSDateTime!, dateTo: AWSDateTime!):
\[CalEvent!\]!*\
*feasibleSlots(role: String!, dateFrom: AWSDateTime!, dateTo:
AWSDateTime!, durationMin: Int!): \[FeasibleSlot!\]!*\
*}*\
\
*type Mutation {*\
*upsertWeeklyRule(role: String!, weekdayMask: Int!, startLocal: String!,
endLocal: String!,*\
*timezone: String!, minDurationMin: Int, leadTimeHours: Int,
bookingWindowDays: Int, active: Boolean): ID!*\
*upsertException(dateLocal: AWSDate!, timezone: String!, kind: String!,
startLocal: String, endLocal: String, note: String): ID!*\
*createHold(role: String!, startUtc: AWSDateTime!, endUtc: AWSDateTime!,
source: String!, orderId: ID