<!-- id: TD-0012 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 43200-47200 -->

ed.
- *REFUND_POLICY_BLOCK* --- requested refund outside policy window.
- *DEPOSIT_CLAIM_DENIED* --- claim exceeds policy/evidence.

Error payloads include *code*, *message*, *hint*, *corrId*, and
suggested next steps.

## **1.3.P Test plan (must‑pass, CI + sandbox)**

**Happy paths**

227. **Single‑leg Talent booking** (card): docs → pay → confirm →
     complete → payout queued.
228. **LBG Talent + Studio** (card+deposit auth): attach studio → docs
     for both legs → confirm → complete → studio deposit voided
     automatically → payouts queued.

**Alternates**\
3) **ACH flow**: bank link → confirm → settlement window; payouts
delayed.\
4) **3DS challenge**: requires_action → client completes → webhook
resumes.

**Edge & failure**\
5) **Atomicity fail**: after docs, Talent ok but Studio deposit auth
fails → no charge; both legs remain *awaiting_payment*.\
6) **Change order**: add overtime → new charge or incremental capture;
receipts updated; taxes re‑quoted.\
7) **Cancellation banding**: test each policy window; verify computed
refunds per leg and group summary.\
8) **Dispute**: receive dispute webhook → evidence pack built → outcome
recorded; payout clawback applied if lost.\
9) **Reconciliation**: daily close matches sums; artificial mismatch
triggers red alert and payout pause.\
10) **Idempotency**: duplicate webhook deliveries don't double‑apply
state; duplicate client calls return same objects.

## **1.3.Q Work packages (Cursor agents)**

- **Agent B (Domain/API)**\
  WP‑CHK‑01: SQL migrations for
  lbg/leg/charge/split/deposit/tax_txn/refund/dispute/payout/amendment.\
  WP‑CHK‑02: GraphQL mutations/queries/subscriptions (see 1.3.I).\
  WP‑CHK‑03: Step Functions saga + Lambda handlers; idempotency store.
- **Agent C (Integrations)**\
  WP‑INT‑PAY‑01: Stripe adapter (PI, SI, transfers, refunds, disputes) +
  webhooks + mappers.\
  WP‑INT‑TAX‑01: Tax adapter (quote/commit/refund).\
  WP‑INT‑ESIGN‑01: Doc pack builder (Dropbox Sign/DocuSign) + gating.
- **Agent A (Web)**\
  WP‑WEB‑CHK‑01: Checkout UI with LBG container, attach‑studio pane,
  docs step, payment step, acceptance window UI, receipts.\
  WP‑WEB‑CHK‑02: Overtime/extras flows from thread/project panel.
- **Agent D (Admin & QA)**\
  WP‑ADM‑FIN‑01: Finance panel (ledger, payouts, reserves, refunds).\
  WP‑ADM‑SUP‑01: Support tools (policy simulator, cancel/refund
  wizard).\
  WP‑QA‑CHK‑01: E2E scenarios 1--10; synthetic Stripe/Tax/ESign
  sandboxes.

## **1.3.R Acceptance criteria (mark §1.3 FINAL only when ALL true)**

233. **Atomic LBG**: Both legs confirm together or neither does;
     receipts & tax per leg; group summary rendered.
234. **Docs‑before‑pay** gating enforced; envelopes signed and hashed on
     receipts.
235. **Main charge captured** at confirm; **payouts delayed** until
     completion/acceptance window; studio **deposit** authorized
     separately and auto‑voided absent approved claim.
236. **Amendments** (extras/overtime) produce correct deltas and taxes;
     payments succeed for deltas; receipts updated.
237. **Refunds** computed per leg policy; processed; receipts amended;
     taxes refunded per provider rules.
238. **Disputes** lifecycle fully supported; evidence packs produced;
     outcomes reflected in ledgers.
239. **Reconciliation** daily close green 5/5 days; SLOs met for
     checkout and payout queue.
240. **Telemetry** events present end‑to‑end; idempotency verified;
     error taxonomy used.
241. **Cost** within budget; no always‑on compute; Stripe/Tax usage
     aligns with traffic.

# **§1.3 --- Booking & Checkout**

**(Linked Booking Group, Docs‑before‑Pay, Taxes, Deposits, Refunds,
Disputes)**

We will complete §1.3 in multiple parts. **Part 1** (previous reply)
delivered: entities, state machines, core Aurora schema, checkout API
contracts, "Docs before Pay," charge/deposit strategy, Stripe/Tax
adapters, error taxonomy, and Part‑1 test plan.\
Below is **Part 2/3**, which covers **change orders & overtime,
cancellation/