<!-- id: TD-0005 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 18000-22000 -->

*repScore*: f(ratingAvg, ratingCount) with Laplace smoothing to avoid
  low‑sample overweighting.
- *verifyBoost*: +X if ID Verified, +Y if Trusted Pro (BG passed).
- *priceFit*: penalty for large deviation from user budget (if set).
- *availBoost*: +Z if the requested date is in *availabilityBuckets*.
- *recency*: mild boost for recently updated profiles (helps cold
  start).

**Fairness & diversity constraints**

- **Provider diversity**: impose a max of K results per owner within the
  top N (avoid multi‑role flooding).
- **New‑seller floor**: ensure a minimum presence (M slots in top N
  reserved for low‑history but complete/verified profiles).
- **Studio diversity**: different studio owners in top M.
- **Policy penalties**: suppress results if *policySignals* exceed
  thresholds (dispute, late delivery). Thresholds configured via Admin.

**Promotions blending (when enabled)**

- **Featured**: eligible results can occupy fixed slots (e.g., 1--2
  positions in top 20) but **never break filters**.
- **Boost**: cost‑per‑click uplift---insert additional slots every X
  organic results after position P.
- Both obey density caps: e.g., ≤2 Featured in top 20; ≤1 above the
  fold.

## **1.2.H Promotions integrity (invalid‑click handling)**

- Real‑time click stream with fingerprinting (device, IP block, user id,
  session id).
- **Deduplicate** multiple clicks from same session/user within T
  seconds.
- **Invalid click rules**: excessive repeat clicks, out‑of‑geo
  anomalies, bot signals → flagged and **not billed**.
- **Make‑good credits** auto‑issued for flagged traffic (logged as
  ledger entries).
- Holdouts (A/B) maintain an organic control set for unbiased impact
  analysis.

## **1.2.I Caching, rate limits, and SLOs**

**Result caching**

- Key: hash of normalized *SearchInput* (without page) + city + role +
  safeMode + version.
- TTL 60--120s (config), **stale‑while‑revalidate** to keep p95 low.
- Pagination cursors cached separately for short time (120s).

**Rate limits**

- Per IP and per account; stricter for anonymous traffic; separate
  limits for suggest vs full search.

**SLOs (MVP)**

- p95 latency: **≤350ms** for cached hits, **≤600ms** for cold queries
  at launch city scale.
- Error rate (5xx) \< 0.5%; availability ≥99.9% monthly for the API.

## **1.2.J Ingestion & update pipeline**

**Write sources**

- SP publish/update, rating updates, verification/badge changes,
  availability updates, policy signals, studio verification toggles.

**Mechanics**

- **Outbox** on mutations → SQS → Indexer Lambda → engine upsert.
- **Nightly backfill** per city to guarantee convergence.
- **On booking accept**: emit event to add date to *availabilityBuckets*
  for the participant SP and studio (if applicable).
- **On cancellation**: remove bucket(s) if time still in future.
- **On policy change** (Safe‑Mode, city gate, eligibility): bulk partial
  update.

**Consistency**

- If index write fails, retry with exponential backoff; stale card
  renders are guarded by server query filters.

## **1.2.K Telemetry & analytics**

**Events**

- *search.open*, *search.filters.apply*, *search.query.execute*,
  *search.results.render*, *search.result.impression*,
  *search.result.click*, *search.result.save*, *search.error*,
  *search.latency*.
- Promotions: *promo.slot.impression*, *promo.slot.click*,
  *promo.invalid_click.flag*, *promo.credit.issued*.
- Integrity: *search.integrity.invalid_request*,
  *search.abuse.robot_detected*.

**Metrics**

- CTR by role/facet; budget fit distribution; verified share;
  availability hit rate; density cap compliance; diversity indices.

## **1.2.L Admin tools (console)**

**Search Admin**

- **Reindex** city/role; **dry‑run** to preview doc deltas.
- **Synonyms** & stopwords editor; import/export.
- **Density caps** (Featured/Boost) with city gates.
- **Eligibility rules** (e.g., verified‑only for certain placements).
- **Invalid click** dashboard with credit issuance.
- **Index health**: doc coun