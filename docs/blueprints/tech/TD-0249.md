<!-- id: TD-0249 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 896400-900400 -->

lity:** city‑level usage and abuse signals (e.g.,
  mass‑spam attempts) in the console.

*(No schema change needed---the existing tables already key by user_id;
we're specifying the **account role** is "buyer/brand" for this
wallet.)*

### **1.20.19 Compliance, labels & fairness**

- **Labeling:** "Sponsored"/"Featured" chip on all paid units; tooltip
  explains matching rules.
- **Organic share guardrail:** maintain **≥ X%** organic exposure per
  page (configurable, default 80%).
- **Daily exposure caps:** per account, per city×role, to avoid
  starvation of others.
- **Protected classes:** no targeting or optimization on protected
  attributes; QS features exclude proxies.
- **Auditability:** all eligibility changes and city config edits are
  included in the **immutable admin audit log** (mirrored to S3 WORM).

### **1.20.20 Additional tests & acceptance extensions**

- **QS ordering test:** higher *order_score* wins within sponsored
  slots; verify no leakage beyond slots.
- **Auto‑coaching:** ROAS thresholds trigger messages; actions logged;
  dismissal persists.
- **Buyer RFP credits:** broadcast to 5 new recipients consumes 5
  credits; re‑inviting a recipient with an active thread consumes 0.
- **Organic share protection:** simulated heavy paid demand still leaves
  ≥ configured organic exposure on each page.

**Acceptance additions (append to §1.20.15):**

- QS pipeline runs nightly; online serving uses *order_score*;
  monitoring dashboards show CTR/AUC and uplift sanity.
- Auto‑coaching thresholds and copy are configurable; events flow to
  analytics.
- RFP credits enforced on **buyer** accounts; consumption, refunds, and
  renewals visible in ledger.

# **§1.21 --- Analytics, Attribution & Experimentation Platform**

**Full Technical Development Plan (single copy‑paste block for your
master doc)**

**Purpose.** Provide a privacy‑safe, cost‑efficient, and auditable
analytics stack that measures **end‑to‑end behavior** (search → view →
message → checkout → payout), powers **growth attribution** (UTM/click
tokens, referral/paid), and runs **experiments** with guardrails.
Integrates with **Amplify (web/app)**, **AppSync**, **Stripe**,
**Typesense**, **Calendar/Orders/Support** (Sections §1.12--§1.15),
**Growth/SEO/Search** (§1.16--§1.18), and **Studios** (§1.19).

## **1.21.1 Objectives & invariants**

4119. **Trust first**: event contracts are versioned, PII‑safe by
      default, and deletions propagate within SLA.
4120. **One identity graph**: stitch **anon_id ↔ user_id** across
      sessions, devices, and channels.
4121. **Attribution that's honest**: last non‑direct + configurable
      lookback, with **click‑token proof** for growth surfaces (§1.16).
4122. **Experiments with guardrails**: sticky assignment, SRM checks,
      CUPED/Bayesian estimators, and **no cloaking**.
4123. **Cost‑conscious**: serverless ingest → S3 data lake
      (Iceberg/Parquet) → Athena/dbt transforms → Redshift Serverless
      *only* for heavy interactive BI.
4124. **Observability**: schema drift, event loss, and lag alarms;
      reproducible **metric definitions**.

## **1.21.2 High‑level architecture**

- **Ingest**: Web/App send to */e* (API Gateway → Lambda). Back‑office
  services send via Kinesis SDK.
- **Landing (Bronze)**: raw NDJSON files in
  *s3://analytics/raw/{event_dt}/* with object lock (WORM) + partition
  pruning.
- **Refine (Silver)**: Glue job or Athena CTAS converts to
  **Iceberg/Parquet** partitioned tables in *s3://analytics/silver/*.
- **Model (Gold)**: *dbt* builds **semantic models** (sessions, funnels,
  attributions, experiment exposures) stored as Iceberg tables.
- **Serve**: Athena for ad‑hoc and scheduled reports; Redshift
  Serverless for dashboards with concurrency; QuickSight or Superset for
  BI.
- **Privacy**: Lake Formation governs access; DSAR delete jobs redact
  across all layers.

## **1.21.3 Event envelope v1 (contract)**

**Event key fields (always present):**

*{*\
*\"event_id\": \"evt_01H