<!-- id: TD-0015 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 54000-58000 -->

putes process available.

### **N.3 API & data**

*input DepositClaimInput { legId: ID!, amountCents: Int!, reason:
String!, evidenceRefs: \[String!\] }type DepositClaimResult { legId:
ID!, capturedCents: Int!, status: String! } extend type Mutation {
fileDepositClaim(input: DepositClaimInput!): DepositClaimResult!
approveDepositClaim(claimId: ID!, amountCents: Int!):
DepositClaimResult! denyDepositClaim(claimId: ID!):
DepositClaimResult!}*

- Store claims in a *deposit_claim* table with audit fields and evidence
  links.

### **N.4 Constraints**

- Max capture ≤ authorized amount; must be within studio policy claim
  window (e.g., 72h).
- Requires admin approval; two‑person rule optional for high amounts.

## **1.3.O Receipts (Per‑Leg + Group Summary)**

### **O.1 Templates**

- **Per‑leg**: role/studio header, booking window, itemization (base,
  extras), taxes (jurisdiction lines), platform fees attribution,
  payments/adjustments (amendments, refunds), doc pack hashes, dispute
  links.
- **Group**: LBG summary (both legs), subtotal/tax/fees/total, payment
  method summary (PI id), deposit (if any) separate.

### **O.2 Rendering**

- Deterministic JSON → server‑rendered PDF via headless Chromium or a
  PDF service; stored in S3 (immutable), linked to receipts and emails.

### **O.3 Rounding**

- Use **banker's rounding** only where required by tax provider;
  otherwise all math in **integer cents**.

## **1.3.P Webhooks → Normalized Events (Mapping)**

### **P.1 Stripe (examples)**

- *payment_intent.succeeded* → *fin.charge.succeeded* (lbg_id,
  leg_ids\[\], amount_cents).
- *charge.refunded* → *fin.refund.succeeded* (leg_id, amount_cents).
- *dispute.created* → *fin.dispute.opened* (leg_id, reason,
  evidence_due_at).
- *payout.paid/failed* (covered in Part 3).

**Idempotency**: Deduplicate by *(provider_event_id)*; store last
processed id per event type.

### **P.2 Tax provider**

- *quote.response* and *commit.response* summarized into *tax.quote*,
  *tax.commit* with jurisdiction payloads.

### **P.3 E‑sign vendor**

- *envelope.completed* → *doc.envelope.completed* (leg_id, envelope_id,
  pdf_hash).

## **1.3.Q Error Taxonomy (additions for this part)**

- *AMENDMENT_NOT_ALLOWED_WINDOW* --- change order outside allowed
  window.
- *AMENDMENT_PAYMENT_FAILED* --- delta payment failed.
- *CANCEL_POLICY_BAND* --- cancellation falls into a specific band;
  hints show computed amounts.
- *DEPOSIT_CLAIM_WINDOW_EXPIRED* --- claim filed after allowed window.
- *RECEIPT_RENDER_FAIL* --- PDF renderer error (server retries; user
  gets fallback HTML).

## **1.3.R Test Plan (Part 2 focus)**

301. **Change Order** (pre‑session): positive delta → taxes re‑quoted →
     payment collected → amendment row saved → receipts updated.
302. **Overtime** (in‑session): card incremental capture; fall back to
     second PI if incremental capture not allowed; ACH always second PI.
303. **Cancellation bands**: simulate 96h/48h/12h cases; verify buyer
     refund and seller retention match policy; tax refunds correct.
304. **Partial LBG cancel**: cancel studio leg; talent leg remains;
     group receipt shows correct summary; buyer warned.
305. **Acceptance window**: buyer accepts vs auto‑accept; payouts queued
     accordingly (Part 3 will verify payouts).
306. **Deposit claim**: studio files claim; approve partial capture;
     receipts updated and buyer notified.
307. **Receipts**: verify line math and PDF rendering; hashes stored;
     email links valid.
308. **Webhooks mapping**: Stripe refund, dispute created, e‑sign
     completed → normalized events created once (idempotency).

## **1.3.S Acceptance Criteria (Part 2)**

We will mark **§1.3 (Part 2) COMPLETE** only when **all** are true:

- Change orders & overtime create amendment lines, collect payments
  properly, and re‑quote tax.
- Cancellation engine returns accurate band outcomes and executes
  refunds; partial LBG cancellation handled with clear UX and math.
- Acceptance window log