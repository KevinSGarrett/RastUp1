<!-- id: TD-0212 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 763200-767200 -->

.dispute (*\
*dispute_id text primary key, \-- dsp\_\...*\
*txn_id text not null references pay.txn(txn_id) on delete cascade,*\
*stripe_dispute text, \-- dp\_\...*\
*reason text,*\
*status text not null check (status in
(\'needs_response\',\'under_review\',\'won\',\'lost\',\'warning_closed\')),*\
*evidence_s3 text, \-- zipped evidence bundle path*\
*due_by timestamptz,*\
*created_at timestamptz default now(),*\
*updated_at timestamptz default now()*\
*);*\
\
*\-- Double-entry ledger (journal + lines)*\
*create table pay.journal (*\
*journal_id bigserial primary key,*\
*occurred_at timestamptz not null default now(),*\
*reference text, \-- txn_id / refund_id / payout_id*\
*kind text not null \--
\'capture\',\'refund\',\'fee\',\'payout\',\'reserve\'*\
*);*\
\
*create table pay.line (*\
*line_id bigserial primary key,*\
*journal_id bigint not null references pay.journal(journal_id) on delete
cascade,*\
*account_code text not null, \-- e.g.,
\'cash_stripe\',\'escrow_liability\',\'revenue_fee\',\'tax_payable\',\'provider_payable\'*\
*currency text not null,*\
*amount_cents int not null \-- debit (+) or credit (-)*\
*);*\
\
*commit;*\

## **1.13.4 GraphQL API --- schema artifacts**

Create *api/schema/payments.graphql*:

*type PriceBreakdown {*\
*currency: String!, subtotalCents: Int!, platformFeeCents: Int!,
taxCents: Int!, depositCents: Int!, totalCents: Int!*\
*policy: AWSJSON!*\
*}*\
*type Quote { id: ID!, breakdown: PriceBreakdown!, createdAt:
AWSDateTime! }*\
*type Txn { id: ID!, status: String!, method: String!, amountCents:
Int!, authorizedAt: AWSDateTime, capturedAt: AWSDateTime }*\
\
*input QuoteInput {*\
*providerId: ID!, role: String!, startUtc: AWSDateTime!, endUtc:
AWSDateTime!,*\
*basePriceCents: Int!, extras: AWSJSON, coupon: String*\
*}*\
\
*type Query {*\
*getQuote(input: QuoteInput!): Quote! \@aws_cognito_user_pools*\
*}*\
\
*type Mutation {*\
*startCheckout(quoteId: ID!, method: String!): Txn!
\@aws_cognito_user_pools*\
*confirmPayment(txnId: ID!): Txn! \@aws_cognito_user_pools*\
*cancelPayment(txnId: ID!): Boolean! \@aws_cognito_user_pools*\
*requestRefund(txnId: ID!, amountCents: Int!, reason: String!): ID!
\@aws_cognito_user_pools*\
\
*\# Providers: payouts*\
*connectPayouts: AWSURL! \@aws_cognito_user_pools \# returns Stripe
onboarding link*\
*refreshPayoutsLink: AWSURL! \@aws_cognito_user_pools*\
*}*\

**Invariants**

- **IDV/KYC lock**: *connectPayouts* available only after Trust checks
  (§1.5).
- **Fees/Taxes snapshot** stored on **Quote** and carried to **Txn** →
  immutable for evidence.
- **Capture timing**: Deposit now + remaining N hours before shoot
  (configurable) **or** full capture at booking (MVP toggle).

## **1.13.5 Checkout & money flow**

**A) Quote & price breakdown**

3461. Client calls *getQuote* with timebox, base price, extras.
3462. Server computes: *subtotal* + **platform fee** (tiered/flat) +
      **tax** (Stripe Tax) + **deposit** (if enabled) → *total*.
3463. Quote persisted with **policy snapshot** (cancellation/refund
      rules at that moment).

**B) Payment intent**

3464. *startCheckout(quoteId, method)* creates Stripe **PaymentIntent**
      with amount = *total*.
3465. For **deposit** model: either two PaymentIntents (deposit now,
      balance later) or one PI with **split capture** (capture partial
      now, rest later).
3466. 3DS/SCA handled via client secret; Apple/Google Pay via Stripe.
3467. On **confirm**, we create **order** (§1.3), create a **hold** in
      calendar (§1.12) if not already, and emit *payment.captured* or
      *payment.authorized*.

**C) Capture & settlement**

- If **full capture at booking** (MVP simplest): capture immediately.
- If **escrow / split capture**: authorize at booking (or capture
  deposit) and capture balance **N hours** before start or after
  completion depending on policy.
- Platform fee realization at capture; provider payable moves from
  escrow liability to provider payable.

**D) Receipts & notifications**

- Generate **P