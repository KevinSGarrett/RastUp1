<!-- id: TD-0020 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 72000-76000 -->

K = createdAt*.

### **B.2 Presence & typing (ephemeral)**

- **Presence table** (DDB) with TTL (e.g., 60s):
  *presence#threadId#userId = lastSeen, typing=true/false*.
- Subscriptions broadcast presence changes; server filters access by
  membership.

### **B.3 S3 buckets (previews only)**

- *msg-previews* --- public‑size thumbs/videos (auto‑transcoded on
  upload); NSFW scan assigns *nsfwBand*.
- *msg-quarantine* --- for flagged items pending T&S review.
- **No finals**: refer to external manifests stored in Aurora
  *deliverable_manifest* (by leg).

## **1.4.C GraphQL API (AppSync) --- types, queries, mutations, subscriptions**

**Note:** Field‑level auth via Cognito + server checks (membership). All
mutations emit domain events to EventBridge.

### **C.1 Core types (excerpt)**

*enum ThreadKind { INQUIRY PROJECT }*\
*enum MessageType { TEXT ASSET SYSTEM ACTION }*\
*enum ActionType {*\
*RESCHEDULE REQUEST_EXTRA OVERTIME_START OVERTIME_STOP*\
*DELIVERABLE_PROOF DELIVERABLE_FINAL APPROVE_DELIVERABLE
REQUEST_REVISIONS*\
*CANCEL_REQUEST REFUND_REQUEST ACCEPTANCE_ACK*\
*DEPOSIT_CLAIM_OPEN DISPUTE_OPEN*\
*}*\
\
*type Thread {*\
*threadId: ID!*\
*kind: ThreadKind!*\
*lbgId: ID*\
*legId: ID*\
*participants: \[User!\]!*\
*lastMessageAt: AWSDateTime!*\
*status: String!*\
*projectPanel: ProjectPanel!*\
*}*\
\
*type ProjectPanel {*\
*brief: Brief*\
*moodboard: Moodboard*\
*shotlist: Shotlist*\
*files: FileShelf*\
*docs: DocStatus*\
*expenses: Expenses*\
*actions: \[ActionCard!\]!*\
*}*\
\
*type Message {*\
*messageId: ID!*\
*type: MessageType!*\
*author: User!*\
*body: String*\
*attachments: \[Attachment!\]*\
*action: ActionCard*\
*createdAt: AWSDateTime!*\
*nsfwBand: Int!*\
*}*\
\
*type ActionCard {*\
*actionId: ID!*\
*type: ActionType!*\
*payload: AWSJSON!*\
*state: String! \# e.g., PENDING\|ACCEPTED\|DECLINED\|PAID\|CLOSED*\
*version: Int!*\
*createdBy: User!*\
*createdAt: AWSDateTime!*\
*updatedAt: AWSDateTime!*\
*}*\

### **C.2 Queries**

*type Query {*\
*inbox(limit: Int = 25, cursor: String): InboxPage! \# lists user\'s
threads*\
*thread(threadId: ID!): Thread!*\
*messages(threadId: ID!, cursor: String, limit: Int = 50):
MessagePage!*\
*projectPanel(threadId: ID!): ProjectPanel!*\
*}*\

### **C.3 Mutations (selected)**

*type Mutation {*\
*\# Inquiry → Project promotion happens when checkout succeeds (webhook
promotes)*\
*startInquiry(sellerServiceProfileId: ID!, buyerBrief: BriefInput!):
Thread!*\
\
*sendMessage(threadId: ID!, body: String!, attachments:
\[AttachmentInput!\]): Message!*\
\
*\# Action cards (all idempotent; server enforces state)*\
*proposeReschedule(threadId: ID!, newTime: DateTimeRange!):
ActionCard!*\
*requestExtra(threadId: ID!, name: String!, priceCents: Int!):
ActionCard!*\
*startOvertime(threadId: ID!, minutes: Int!): ActionCard!*\
*stopOvertime(threadId: ID!): ActionCard!*\
\
*postDeliverableProof(threadId: ID!, manifestRef: ID!, note: String):
ActionCard!*\
*postDeliverableFinal(threadId: ID!, manifestRef: ID!, note: String):
ActionCard!*\
*approveDeliverable(threadId: ID!, deliverableId: ID!): ActionCard!*\
*requestRevisions(threadId: ID!, deliverableId: ID!, note: String!):
ActionCard!*\
\
*requestCancel(threadId: ID!, legId: ID!, reason: String!):
ActionCard!*\
*requestRefund(threadId: ID!, legId: ID!, reason: String!, amountCents:
Int): ActionCard!*\
\
*acknowledgeCompletion(threadId: ID!): ActionCard! \# buyer acceptance*\
\
*openDepositClaim(threadId: ID!, amountCents: Int!, reason: String!,
evidence: \[String!\]): ActionCard!*\
*openDispute(threadId: ID!, legId: ID!, reason: String!, details:
String!): ActionCard!*\
*}*\

Each action card mutates both **DynamoDB** (message frame + CARD shadow)
and **Aurora** (leg/LBG state via §1.3 services). For example,
*requestExtra* calls the **Checkout/Amendments** service to price &
charge the delta.

### **C.4 Subscriptions**

*type Subscription {*\
*threadEvents(threadId: ID!): ThreadEvent! \# message new, edited,
action state, presence*\
*inboxEvents: I