<!-- id: TD-0131 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 471600-475600 -->

\",
\"provider\":\"cancel_fee\"},*\
*\"accepted_lt_48h\": {\"buyer\":\"partial at platform discretion\",
\"provider\":\"minimum_guarantee\"}*\
*}*\

## **1.22.9 Credits, vouchers & taxes**

- **Credits (referral/promos)** reduce **platform fee** (buyer_fee) only
  unless promo explicitly subsidizes subtotal.
- If a promo reduces **subtotal**, it's platform‑funded; treat as
  **negative revenue** in analytics.
- **Tax** on platform fees depends on jurisdiction; at launch either (a)
  enable **Stripe Tax** for the fee component, or (b) restrict to
  jurisdictions where fees are non‑taxable. Provider service tax remains
  provider's responsibility at launch; we show guidance.

**Artifact --- platform invoice MJML (fee line item)**\
**Recommended path:** *comms/templates/invoice_platform_fee.mjml*\
*(Structure mirrors §1.16 MJML; includes order id, buyer fee, tax (if
any), and payment method.)*

## **1.22.10 Payout scheduling & reserves**

- Default **T+1** transfer after completion; **T+7** for new providers
  until reaching a reputation threshold.
- **Rolling reserve** (e.g., 10% for 30 days) for high‑risk providers
  (dispute/cancellation rates).
- Manual **hold/release** flags for risk (see §1.22.12); all changes are
  audited.

**Artifact --- payout policy**\
**Recommended path:** *payments/policy/payout-schedule.md*

*- New providers (\<5 completed bookings): T+7*\
*- Verified/Trusted Pro: T+1*\
*- Reserve triggers: dispute rate \>1%, abnormal cancellations, risk
flags*\

## **1.22.11 Fraud controls & risk flags (tied to §1.18 / §1.15)**

- Signals: rapid multi‑card attempts, device fingerprint mismatch, same
  IP across multiple buyers, new provider with unusually high prices,
  excessive outbound messages/spam.
- Actions: enforce **3DS** on high‑risk cards, **manual review** holds,
  increase **reserve**, delay transfer until IDV passes.
- Every decision is written to the **immutable audit** trail (see
  §1.18.H).

## **1.22.12 Reconciliation --- ledgers & analytics lake**

**Bronze**: raw webhook dumps + Stripe balance transactions → S3.\
**Silver**: normalized facts: *fact_payments*, *fact_transfers*,
*fact_refunds*, *fact_payouts* joined by *order_id*/*transfer_group*.\
**Gold**: revenue dashboards (by city/role), take‑rate, dispute rate,
net provider earnings.

**Artifact --- reconciliation SQL (Silver build)**\
**Recommended path:** *data/sql/recon_build.sql*

*CREATE OR REPLACE TABLE fact_payments AS*\
*SELECT o.order_id, p.stripe_pi, bt.id as balance_tx, bt.amount, bt.fee,
bt.net, bt.created*\
*FROM stripe_balance_tx bt*\
*JOIN payment_intent p ON bt.source = p.stripe_pi*\
*JOIN \"order\" o ON o.order_id = p.order_id;*\
\
*CREATE OR REPLACE TABLE fact_transfers AS*\
*SELECT t.order_id, t.stripe_transfer, bt.amount, bt.fee, bt.net,
bt.created*\
*FROM stripe_balance_tx bt*\
*JOIN transfer_ledger t ON bt.source = t.stripe_transfer;*\

**Dashboards:** revenue by city/role, average booking value, platform
take‑rate, refunds %, disputes %, payout SLA compliance.

## **1.22.13 Admin finance console**

- Search orders by id/email; view PI/charge; see transfers; issue
  refunds; apply holds/releases; apply credits; upload dispute evidence.
- **Audit trail** for every action (immutable table; see §1.18.H).
- **Access:** OIDC Admin role only; irreversible actions require
  two‑step confirmation.

**Artifact --- admin GraphQL**\
**Recommended path:** *api/schema/payments.admin.graphql*

*type PaymentAdmin {*\
*orderId: ID!, stripePi: String, amountCents: Int!, currency: String!,*\
*status: String!, providerAccount: String, transfers: \[Transfer!\]!,
refunds: \[Refund!\]!*\
*}*\
*type Transfer { xferId: ID!, stripeTransfer: String, amountCents: Int!,
status: String! }*\
*type Refund { refundId: ID!, stripeRefund: String, amountCents: Int!,
reason: String! }*\
\
*extend type Query {*\
*adminGetOrder(orderId: ID!): PaymentAdmin! \@auth(role: \"admin\")*\
*}*\
*extend type Mutation {*\
*adminRefund(orderId: ID!, amountCents: Int!, 