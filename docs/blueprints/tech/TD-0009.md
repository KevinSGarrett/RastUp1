<!-- id: TD-0009 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 32400-36400 -->

time\',\'refund_line\',\'admin_adjustment\')),
delta_subtotal_cents int not null, delta_tax_cents int not null,
delta_fees_cents int not null, delta_total_cents int not null, note
text, created_by text not null, \-- usr\_\... (buyer, seller, admin)
created_at timestamptz not null default now()); \-- Payouts per leg
(Connect transfers)create table payout ( payout_id text primary key, \--
pay\_\... leg_id text not null references booking_leg(leg_id) on delete
cascade, processor text not null, \-- \'stripe\' processor_payout text,
\-- po\_\... status text not null check (status in
(\'queued\',\'in_transit\',\'paid\',\'failed\',\'canceled\',\'paused\')),
amount_cents int not null, currency text not null default \'USD\',
scheduled_for timestamptz, created_at timestamptz not null default
now(), updated_at timestamptz not null default now()); \-- Tax
transactions (per leg)create table tax_txn ( tax_txn_id text primary
key, \-- tax\_\... leg_id text not null references booking_leg(leg_id)
on delete cascade, provider text not null, \-- \'taxjar\' or \'avalara\'
or \'stripe_tax\' provider_id text not null, jurisdiction_json jsonb not
null, \-- state/city, rates quote_cents int not null, committed boolean
not null default false, created_at timestamptz not null default now());
\-- Refunds & disputescreate table refund ( refund_id text primary key,
\-- rfd\_\... lbg_id text not null references lbg(lbg_id) on delete
cascade, leg_id text not null references booking_leg(leg_id) on delete
cascade, processor text not null, processor_refund text, \-- re\_\...
amount_cents int not null, reason text not null, status text not null
check (status in (\'pending\',\'succeeded\',\'failed\')), created_at
timestamptz not null default now()); create table dispute ( dispute_id
text primary key, \-- dsp\_\... leg_id text not null references
booking_leg(leg_id) on delete cascade, processor text not null, \--
\'stripe\' processor_dispute text, \-- dp\_\... reason text not null,
status text not null check (status in
(\'needs_response\',\'under_review\',\'won\',\'lost\',\'warning_closed\')),
evidence_due_at timestamptz, created_at timestamptz not null default
now());*

**Indices**

- *booking_leg (seller_user_id, start_at)* for seller calendars.
- *booking_leg (service_profile_id)* and *booking_leg (studio_id)* for
  lookups.
- *charge_split (leg_id)* for rollups.
- Partial indexes on *booking_leg(status in
  (\'confirmed\',\'in_progress\'))* for ops scans.

## **1.3.C State machines (per leg and for LBG)**

**Leg state:**\
*draft → awaiting_docs → awaiting_payment → confirmed → in_progress →
completed*\
Failures: *cancelled*, *failed*

**LBG state:**

- Derived from legs: *draft* if any leg *draft/awaiting\_\**;
  *confirmed* if **both** legs *confirmed*; *in_progress* if any leg
  *in_progress*; *completed* if **both** *completed*; *cancelled* if
  both cancelled (or group cancelled prior to start); *failed* on
  atomicity failure pre‑confirm.

**Transitions (high‑level)**

171. **startCheckout** → create LBG + one leg (Talent) in
     *awaiting_docs*.
172. **attachStudioInFlow** (optional) → add Studio leg; both legs now
     *awaiting_docs*.
173. **createDocPack & sign** → both legs *awaiting_payment*.
174. **authorize & capture LBG charge** (PaymentIntent) → *confirmed* if
     both legs funded; else rollback.
175. **before start_at**: allow **amendments** (extras), re‑quote tax,
     adjust charge (incremental capture or second charge).
176. **at start_at**: move legs to *in_progress*.
177. **completion**: buyer acceptance or window expiry → queue
     **payouts**; auto‑void unused deposit holds.
178. **dispute/refund**: flows do not alter leg status but affect
     payout/finance ledgers; receipts amended.

**Studio deposit** lives outside the main charge and is captured only on
approved claim within a policy window.

We implement these as an **AWS Step Functions** saga for LBG with
per‑leg substates, plus outbox events to keep UI in sync.

## **1.3.D Che