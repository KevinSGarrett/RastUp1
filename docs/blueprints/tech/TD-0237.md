<!-- id: TD-0237 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 853200-857200 -->


*processed boolean not null default false*\
*);*\
*create index on search.outbox (processed, created_at);*\
*commit;*\

**Flow**

3882. Application services write normalized docs into *payload* (already
      SFW‑filtered if public).
3883. **Indexer Lambda** (every 1--2 minutes, or triggered by DB notify)
      upserts/deletes in Typesense.
3884. On success, mark *processed=true*. Failures retry with back‑off;
      poison records alert.

**Normalization rules**

- People/studios include **availability_score** computed from §1.12
  feasible slots next 14 days (0--1).
- Ratings only included when *review_count ≥ 5* to avoid cold‑start
  bias.
- City + geo lat/lng always present for geosearch queries.

## **1.18.5 Query model & GraphQL**

**GraphQL (*****api/schema/search.graphql*****)**

*type SearchHit {*\
*id: ID!, kind: String!, score: Float!,*\
*title: String!, subtitle: String, city: String,*\
*image: AWSURL, verified: Boolean, rating: Float, reviewCount: Int,*\
*priceMin: Int, priceMax: Int, badges: \[String!\]*\
*}*\
*type SearchResults { hits: \[SearchHit!\]!, nextCursor: String }*\
\
*input PeopleFilter {*\
*city: String, roles: \[String!\], priceMin: Int, priceMax: Int,*\
*verified: Boolean, any: AWSJSON, all: AWSJSON*\
*}*\
*input StudiosFilter {*\
*city: String, amenities: \[String!\], hourlyMax: Int, verified:
Boolean*\
*}*\
*input WorkFilter { city: String, roles: \[String!\] }*\
\
*type Query {*\
*searchPeople(q: String, filter: PeopleFilter, sort: String, cursor:
String, limit: Int = 24): SearchResults!*\
*searchStudios(q: String, filter: StudiosFilter, sort: String, cursor:
String, limit: Int = 24): SearchResults!*\
*searchWork(q: String, filter: WorkFilter, sort: String, cursor: String,
limit: Int = 24): SearchResults!*\
*suggest(q: String!, scope: String!): \[String!\]! \# scope:
people\|studios\|work*\
*}*\

**Sorting options**

- *best* (default blended rank), *new*, *distance*, *price_low*,
  *price_high*, *rating*.
- Distance sorting requires an origin; otherwise fallback to *best*.

## **1.18.6 Ranking formula (blended relevance)**

**People/Studios rank score** (computed in search Lambda; weights
tunable via config):

*score = 0.45 \* text_match*\
* + 0.20 \* proximity_score \# inverse distance; city exact match gets
1.0*\
* + 0.12 \* verified_boost \# 1 if verified, else 0*\
* + 0.10 \* availability_score \# 0..1 next-14-days slots*\
* + 0.08 \* quality_score \# normalized rating \* log(review_count+1)*\
* + 0.05 \* freshness_score \# recency of update/publish*\

**Personalization boosts** (applied multiplicatively, capped):

- **Followed** author/studio: ×1.10
- **Recent engagement** (viewed profile or messaged in last 30 days):
  ×1.05
- **Blocked** author/studio: hard exclude
- **Same user**: hard exclude

**Anti‑gaming**:

- Clamp rating influence when *review_count \< 5*.
- Diminish freshness boost if an account edits too frequently
  (change‑rate limiter).

## **1.18.7 Facets & filters**

- **People**: *roles*, *city*, *price bands* (derived), *verified*,
  *tags*.
- **Studios**: *city*, *amenities*, *verified*, *hourly_max* band.
- **Work**: *roles*, *city*.
- **Safe‑Mode**: all public queries append filter *nsfw_band \<= 1*.
  Logged‑in 18+ areas use protected routes; never leak to public.

**ANY/ALL**: identical to the §1.16 contract; we normalize the filter
JSON and memoize a hash key for caching.

## **1.18.8 Spelling, synonyms & suggestions**

- **Synonyms**: role map ("photographer" ↔ "photo", "modeling" ↔
  "model").
- **Typos**: Typesense typo tolerance up to **2**; distance reduces
  *text_match*.
- **Suggestions**: prefix search over *handle*, *display_name*, *city*,
  and frequent tags with Safe‑Mode gate.

## **1.18.9 Availability & pricing integration**

- **availability_score** = sigmoid of available slot count in next 14
  days for the role; updated hourly during active hours.
- **price bands**: server computes band field (*\$*, *\$\$*, *\$\$\$*)
  from price_min/max; used for fa