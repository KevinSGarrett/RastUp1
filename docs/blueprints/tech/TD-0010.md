<!-- id: TD-0010 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 36000-40000 -->

; auto‑void unused deposit holds.
178. **dispute/refund**: flows do not alter leg status but affect
     payout/finance ledgers; receipts amended.

**Studio deposit** lives outside the main charge and is captured only on
approved claim within a policy window.

We implement these as an **AWS Step Functions** saga for LBG with
per‑leg substates, plus outbox events to keep UI in sync.

## **1.3.D Checkout & payment flows**

**Payment providers:** Stripe only at launch (cards + ACH via Financial
Connections). Adapter makes it swappable later.

**Strategy (escrow mimic):**

- **Capture the LBG charge at confirmation** (no long holds). Funds sit
  in platform/connected accounts.
- **Delay payouts** until completion/acceptance window.
- **Deposits** for Studio are handled via **SetupIntent** authorization
  (separate from GMV) and captured only if a valid claim is approved.

**Stripe objects**

- **PaymentIntent** (one per LBG) with **separate transfers** to legs on
  payout; metadata contains *lbg_id*, *leg_ids\[\]* and split details.
- **SetupIntent** for Studio deposit with
  *payment_method_options\[card\]\[capture_method\]=manual* semantics at
  claim time.
- **Transfers** at payout time per leg to the seller's Connect account.
- **Refunds** per leg (partial allowed).

**ACH specifics**

- ACH debit is **captured** when *succeeded*; we hold payouts until
  enough settlement confidence or policy window.

**3DS / SCA**

- Use Stripe's Payment Element; handle *requires_action* client‑side;
  webhook transitions keep our state machine consistent.

**Idempotency**

- All create/confirm/refund/payout calls carry an *Idempotency-Key*
  (persisted), and webhooks are verified (HMAC) + deduped.

## **1.3.E Tax & jurisdictions**

- Use **TaxJar/Avalara** (adapter) or **Stripe Tax** if we decide to
  keep vendors lean for MVP; either way, **quote is per leg** and stored
  in *tax_txn* with jurisdiction granularity.
- **Commit** tax on confirmation; **amend** on change orders; **refund**
  tax appropriately on cancellations/refunds per provider rules.

**Edge cases**

- Cross‑city bookings: compute tax based on **service location**
  (studio's city or talent's service location if no studio).
- Tax‑exempt flags (rare) require admin approval and audit.

## **1.3.F Amendments, extras & overtime**

- **Change Orders** produce *amendment* rows with deltas; tax re‑quoted;
  receipts updated.
- **Overtime**: triggered from thread/project during/after the session;
  priced per policy; may generate an extra **PaymentIntent** or
  **incremental capture** (cards) if allowed; for ACH, create a second
  charge.

## **1.3.G Refunds & cancellations**

**Policy engine**

- Encodes time‑banded refunds per leg (e.g., 72h+, 24--72h, \<24h).
- Computes buyer refund and seller forfeiture; **platform fees**
  refundability follows policy.
- **Group cancellation**: apply each leg's policy independently; the
  group summary is a sum (displayed on the group receipt).

**Technical flow**

- Create *refund* records per leg; call Stripe *refunds.create* with
  *amount*; reconcile via webhooks; update receipts and Gold facts.

## **1.3.H Disputes**

- Stripe disputes → *dispute* table per leg; evidence kit assembled from
  doc packs, chat transcripts, deliverable manifests, check‑in/out
  timestamps, and studio rules acknowledgments.
- Admin console tracks deadlines, statuses, and outcomes; *won/lost* are
  mirrored in finance facts.

## **1.3.I GraphQL API (checkout & lifecycle) --- key operations**

*type Mutation { startCheckout(leg: StartLegInput!, when:
DateTimeRange!, city: String!): CheckoutDraft!
attachStudioInFlow(draftId: ID!, studioId: ID!): CheckoutDraft! \#
validates time/conflicts createDocPack(draftId: ID!): DocPack! \#
returns envelope links markDocSigned(draftId: ID!, packId: ID!,
envelopeId: ID!): DocPack! \# Payment createPaymentIntent(draftId: ID!,
method: PaymentMethodInput!): PaymentIntentClientSecret!
confirmPayment(draftId: ID!): CheckoutConfirma