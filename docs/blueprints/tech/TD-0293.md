<!-- id: TD-0293 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1054800-1058800 -->

 --- n/a --- controls
  telemetry sampling.
- *GRAPHQL_URL* --- web --- dev/stage --- URL --- (env‑specific) ---
  must be HTTPS in prod --- plain --- Platform --- n/a.
- *JWT_AUDIENCE* --- api --- all --- string --- *rastup-app* --- fixed
  --- plain --- Security --- n/a.
- *KMS_KEY_APP* --- api --- prod --- ARN --- none --- required --- KMS
  --- Security --- yearly --- app‑level encryption.
- *DB_SECRET_ARN* --- api --- stage/prod --- ARN --- none --- required
  --- Secrets Manager --- Security --- 90d.
- *STRIPE_SECRET_KEY* --- api --- stage/prod --- secret --- none ---
  required --- Secrets Manager --- Finance --- rotate if compromised.
- *STRIPE_WEBHOOK_SECRET* --- api --- stage/prod --- secret --- none ---
  required --- Secrets Manager --- Finance --- rotate on leak.
- *TYPESENSE_API_KEY* --- api/indexer --- all --- secret --- none ---
  required --- Secrets Manager --- Search --- 180d.
- *EMAIL_FROM* --- notifications --- prod --- email ---
  [*noreply@rastup.com*](mailto:noreply@rastup.com) --- domain must pass
  DMARC --- plain --- Comms --- n/a.
- *PWA_WEBP_QUALITY* --- web --- all --- int --- *75* --- 50--90 ---
  plain --- Web --- n/a.
- *SAFE_MODE_DEFAULT* --- web/api --- all --- bool --- *true* ---
  true/false --- plain --- Safety --- n/a.
- *FEATURE_INSTANT_BOOK* --- web/api --- all --- flag --- *off* ---
  *{off,canary,100%}* --- Launch --- n/a.

**J.3 Secrets handling**

- All *\*\_SECRET\** keys live in **AWS Secrets Manager**; access via
  IAM least‑privilege roles; audited.
- **Rotation runbook:** *ops/runbooks/secret_rotation.md* (generate new,
  deploy, verify, decommission old).

**J.4 Feature flags**

- File: *ops/config/flags.yaml* (keys, owner, rollout guardrails, kill
  switch).
- Changes require PR + approver; no runtime "hot editing" outside Admin
  console with audit.

**J.5 Acceptance**

- Every service boots using only this registry; CI check refuses unknown
  env keys; secrets rotation rehearsed quarterly.

## **Appendix K --- API Error & Semantics Registry (paste‑ready)**

**Purpose.** Make errors predictable across REST, GraphQL, and webhooks.

**K.1 Error model**

- **HTTP**:

  - *400* validation, *401* auth, *403* authz, *404* not found, *409*
    conflict (idempotency/booking race), *422* domain rule violation,
    *429* rate limit, *5xx* server.

- **GraphQL**: *errors\[\].extensions* carries *code* (*BAD_USER_INPUT*,
  *UNAUTHENTICATED*, *FORBIDDEN*, *NOT_FOUND*, *CONFLICT*,
  *RATE_LIMITED*, *INTERNAL*).

- **Webhooks**: signed; *2xx* = success; any non‑2xx triggers retry with
  backoff; *410* unsubscribes endpoint.

**K.2 Error codes (canonical subset)**

- *AUTH.INVALID_CREDENTIALS* (401) --- message: "Email or password is
  incorrect."
- *AUTH.MFA_REQUIRED* (401) --- message: "Step‑up verification
  required."
- *BOOKING.SLOT_TAKEN* (409) --- message: "That time was just booked.
  Pick another slot."
- *PAYMENT.CARD_DECLINED* (402/GraphQL error) --- message: "Your bank
  declined the charge."
- *RATE.LIMITED* (429) --- headers include *X‑RateLimit‑Limit*,
  *X‑RateLimit‑Remaining*, *Retry‑After*.
- *WEBHOOK.SIGNATURE_INVALID* (400) --- message: "Signature invalid or
  timestamp skew too large."

**K.3 Idempotency**

- All *POST* endpoints accept *Idempotency‑Key*. On duplicate, return
  prior **status + body** with *Idempotent-Replay: true*.

**K.4 Pagination**

- Cursor‑based; response includes *next_cursor*; absence = end. Limit
  caps documented per resource.

**K.5 Deprecation**

- Header *Sunset* with RFC date; *Deprecation: true* on deprecated
  routes; docs banner; 90‑day notice.

**K.6 Acceptance**

- Contract tests pass across all surfaces; partner SDK examples
  round‑trip the codes above; idempotent replays proven in CI.

## **Appendix L --- CDN / Cache Key Matrix (paste‑ready)**

**Purpose.** Eliminate guesswork in caching; protect privacy while
hitting performance budgets.

**L.1 Behaviors (CloudFront)**

- **/ (Home)** --- TTL **600s**; Key: *Host, Path, Accept‑Lan