<!-- id: TD-0258 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 928800-932800 -->

   with runbooks.
4298. **Security & privacy first** (least‑privilege IAM, KMS encryption,
      secret hygiene, WAF).
4299. **Elastic & cost‑disciplined** (serverless everywhere practical;
      clear scale/cutover plan).
4300. **DR posture defined** (RPO/RTO targets, snapshot/restore,
      cross‑region backups).

## **1.23.2 Environments & accounts**

- **AWS accounts**: *dev*, *stage*, *prod* (separate billing &
  guardrails).

- **Environments**:

  - **Dev** --- feature branches deploy **Amplify Previews**
    (ephemeral), shared Aurora (small capacity), relaxed throttles.
  - **Stage** --- pre‑prod; mirrors prod topology; connected to
    **sandbox** Stripe/3P.
  - **Prod** --- customer traffic; tight WAF rules; read replica(s)
    enabled.

- **Regions**: primary *us-east-1*; **secondary DR** *us-west-2*
  (backups + cold‑standby plan).

**Naming & tags** (FinOps): every resource tagged *{env, service, owner,
cost_center, data_class}*; budgets & anomaly detection per tag.

## **1.23.3 Infrastructure‑as‑Code (IaC)**

- **Framework**: **AWS CDK (TypeScript)** in monorepo; stacks per
  domain:

  - *edge* (CloudFront, WAF, Lambda@Edge)
  - *web* (Amplify Hosting Gen‑2)
  - *auth* (Cognito + SAML/Google federation)
  - *api* (AppSync + Lambda resolvers)
  - *data* (Aurora Serverless v2, Secrets Manager, Parameter Store, KMS
    keys)
  - *queue* (EventBridge, SQS DLQs)
  - *search* (ECS Fargate + Typesense + EBS/Snapshot)
  - *observability* (CloudWatch, X‑Ray, alarms, dashboards)

- **Pipelines** (see §1.23.5) synth/deploy stacks with gated promotions
  Dev→Stage→Prod.

- **Policy packs**: CDK Aspects enforce encryption at rest, TLS 1.2+,
  access logs, and tagging.

## **1.23.4 Networking & security**

- **VPC** with private subnets for Aurora/ECS; NAT for outbound; **VPC
  endpoints** for S3/Secrets.

- **WAF** on CloudFront with: SQLi/XSS rules, bot control, rate limits,
  geo filters.

- **Shield Standard** enabled; **ALB** for Typesense behind private NLB;
  **Security Groups** locked to known CIDRs/Lambdas.

- **IAM**:

  - **Least‑privilege** policies per Lambda; no wildcards on *\**.
  - Scoped **KMS** keys: *kms/data*, *kms/logs*.

- **Secrets**: AWS **Secrets Manager** (Stripe, Plaid optional, Postgres
  creds) with 90‑day rotation; **no secrets in env vars** in code.

- **PII flow controls**: egress block lists; **VPC Traffic Mirroring**
  OFF by default; logs mask PII.

## **1.23.5 CI/CD pipelines & release strategy**

- **SCM**: GitHub (monorepo).

- **Branching**: trunk‑based; feature branches → PR → code review (2
  approvals for risk areas).

- **Actions**:

  - **Build**: type‑check, lint, unit tests; compile Next.js; package
    Lambdas.
  - **Security gates**: **Dependabot**, OSS vuln scan (e.g., *npm
    audit*/*osv-scanner*), **Trivy** for container images.
  - **Infra**: *cdk synth* + *cdk diff*; require approval on drift;
    **manual gate** for data migrations.
  - **Deploy**: Dev auto on merge; Stage manual promote with smoke
    tests; Prod **canary** (10%→50%→100%) with automatic rollback on
    alarms.

- **DB migrations**: **Sqitch** or **Flyway** with **idempotent,
  reversible** scripts; *predeploy* checks and **online schema change**
  pattern; migrations run before canary flip.

- **Feature flags**: config service (§1.22) for progressive delivery;
  flags used for risky features.

## **1.23.6 Observability (logs, metrics, traces)**

- **Logs**: CloudWatch structured JSON; 30--90 day retention (per env).
  PII masking on ingress.

- **Metrics**: service level + business KPIs (search latency, checkout
  success, outbox backlog, index staleness) push to CloudWatch.

- **Tracing**: AWS X‑Ray / OpenTelemetry SDK in Lambdas; trace IDs
  propagated via AppSync context.

- **Dashboards**:

  - **API** p50/p95 latency & errors; throttles; WAF blocks.
  - **Jobs**: indexer lag, DSAR queue, email send failures.
  - **Search**: hit ratio, Typesense CPU/heap, request rate.

- **Alerting**: SNS → PagerD