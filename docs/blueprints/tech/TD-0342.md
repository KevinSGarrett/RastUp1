<!-- id: TD-0342 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 1231200-1235200 -->

. Staff roles can bypass via a conditional.

## **R.5 Keying strategy (what we count)**

- **IP** for unauthenticated endpoints (and suggestions), aggregated to
  **/24** for residential NATs (compute key as *ip#A.B.C.0/24*).
- **userId** for most authenticated operations.
- **dyadId** (*min(userA,userB):max(userA,userB)*) for **messages** to
  limit harassment without blocking legitimate conversations elsewhere.
- **clientId** (API key or OAuth client) for partner REST; separate
  global **org quota** possible.
- **composite keys** (e.g., *userId+operation*) prevent one operation
  from starving others.

## **R.6 Exceptions & tiers**

- **Staff/service accounts**: allowlisted keys bypass app‑level limits
  (still subject to WAF hard floors to prevent accidental floods).
- **Partner tiers**: Bronze 600 rpm/50k day; Silver 1200 rpm/200k day;
  Gold custom. Tiers stored in *partners.clients* and used to compute
  *limit, refill*.
- **Backfilling/reindex jobs**: signed internal token to bypass WAF and
  app limits.

## **R.7 Observability, dashboards & alerts**

**Metrics to emit (per request):**

- *rate_guard.allowed{op,key_type}* (counter)
- *rate_guard.throttled{op,key_type}* (counter)
- *rate_bucket.remaining* (gauge) --- sampled
- *waf.blocked{rule}* (counter from WAF metrics)

**Dashboards** (*observability/dashboards/rate_limits.json*):

- Throttled % by operation, top throttled IPs/clients, suggest QPS vs
  throttle, messaging throttles vs abuse actions.

**Alerts**:

- **Search throttle spike**: *rate_guard.throttled{op=search\*} \> 2%
  for 5m* (SEV‑3).
- **Partner nearing quota**: remaining/day \< 10% (warn partner).
- **WAF surge**: *waf.blocked{rule=RateLimitSearch} \> threshold*.

## **R.8 Tests (CI + stage)**

- **Unit**: token bucket math (refill, burst, window).

- **Contract**: headers present on success and 429; *Retry-After* sane.

- **E2E**:

  - Push 65 search req/min (anon) → last 5 get 429.
  - Messaging 25/min in a dyad → last 5 429, but sending to a
    **different** peer still allowed.
  - Partner client hits 700 rpm → throttled to configured 600 rpm;
    headers reflect tier.

- **Load**: verify no hot partitions in Dynamo; conditional writes not
  exceeding throughput.

## **R.9 Repo artifacts & configs**

*api/functions/rateGuard.js \# AppSync pre-resolver*\
*infra/cdk/partner-api.ts \# API Gateway usage plans*\
*ops/waf/rate_rules.json \# WAF rate-based rules (edge)*\
*services/rate/README.md \# Key formats, tuning guide*\
*observability/dashboards/rate_limits.json \# Grafana/CloudWatch
dashboard*\
*tests/rate/rate_bucket.spec.ts \# Token bucket math tests*\
*tests/e2e/rate_limits.spec.ts \# Playwright/k6 checks*\

**Dynamo table (CDK)**

*const table = new dynamodb.Table(this, \'RateLimits\', {*\
*partitionKey: { name: \'key\', type: dynamodb.AttributeType.STRING },*\
*billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,*\
*timeToLiveAttribute: \'ttl\',*\
*removalPolicy: RemovalPolicy.RETAIN*\
*});*\

## **R.10 Governance & change process**

- All limit changes go via PR editing *services/rate/limits.yml* (source
  of truth).
- PR explains **customer impact** + **abuse signal** motivating change;
  link to dashboards.
- **Changelog** section *Rate & Quotas* updated (Appendix Q).
- Partners receive email notice for plan/tier changes.

## **R.11 Acceptance (Appendix R = FINAL)**

5793. WAF rate‑based rules deployed for search/suggest/auth.
5794. AppSync pre‑resolver **rateGuard** enabled on search, messaging
      send, checkout create/confirm, and other hot ops.
5795. Partner REST has **Usage Plans** (per client), tiered quotas, and
      returns **standard headers**.
5796. Rate‑limit headers & consistent **429** error shape implemented
      across REST and GraphQL.
5797. Dashboards + alerts live; CI has unit + E2E tests for throttling;
      load test shows stable Dynamo throughput.
5798. Exceptions (staff, webhooks) and tiering documented and honored

# **Appendix S --- Test Data (Seeders, Masking