<!-- id: TD-0073 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 262800-266800 -->

\
*column_list: \[dt, leg_id, latest_payload, last_event_at\]*\
* - expect_column_values_to_not_be_null:*\
*column: leg_id*\
* - expect_column_values_to_be_between:*\
*column: latest_payload.total_cents*\
*min_value: 0*\
* - expect_compound_columns_to_be_unique:*\
*column_list: \[dt, leg_id\]*\

*/data/quality/expectations/fact_promotions_events.yml*

*expectations:*\
* - expect_column_values_to_be_in_set:*\
*column: event*\
*value_set:
\[\"promo.impression\",\"promo.click\",\"promo.invalid_click\"\]*\
* - expect_column_values_to_match_regex:*\
*column: campaign_id*\
*regex: \"\^pcmp\_.\*\"*\

Run suites as part of the CTAS/dbt job tail step; failures → SNS alert +
Slack (Ops).

### **G.2 Lineage**

- Maintain a lightweight **schema registry** (static site)
  auto‑generated from JSON Schemas + dbt docs.
- For every Gold mart, include *meta* fields citing upstream Silver
  models. dbt renders lineage graph---check into */docs/*.

## **1.13.H (expanded) --- Privacy, Governance & Retention**

### **H.1 Lake Formation & permissions**

- **Data lake locations**:

  - *s3://data/bronze* (read: data‑eng only; analysts excluded).
  - *s3://data/silver* (read: data‑eng + analysts; **private PII**
    columns masked via LF tags).
  - *s3://data/gold* (read: broad analyst/viewers).

- **LF tags**: *pii:yes/no*, *env:dev\|stage\|prod*. Attach to columns
  (e.g., *email_sha256* is *pii:yes*). Grant principals row‑level +
  column‑level access via tags.

### **H.2 DSAR (Right to Erasure) workflow**

1378. **User request** creates *dsar.requested* admin ticket and writes
      a **tombstone event**:\
      *{ event: \"dsar.tombstone\", v:1, user_id:\"usr\_\...\",
      occurred_at:... }*.

1379. **Operational stores** (Aurora/Dynamo/S3 app buckets) execute
      deletion/redaction per policy (already covered in §§1.4--1.12).

1380. Analytics purge:

      j.  **Silver/Gold**: nightly job reads tombstones and
          deletes/overwrites partitions where *user_id=usr\_...* or
          *actor_key* links; regenerate affected aggregates.
      k.  **Bronze**: keep immutable; **exclude on read** by maintaining
          *dsar_exclusions* table joined in views (regulatory‑approved
          strategy).

1381. **Verification**: generate a DSAR purge report with table counts
      before/after; store PDF in legal hold S3.

**Legal hold**: blocked DSARs write *dsar.hold* and the purge job skips
those users until hold clears.

### **H.3 Retention**

- **Bronze**: 18 months rolling delete by *dt* partition (S3 lifecycle).
- **Silver**: 24--36 months depending on table; keep finance facts 7
  years if required (PII masked).
- **Gold**: 24 months rolling.

## **1.13.F (expanded) --- Experimentation Framework**

### **F.1 Assignment & exposure**

- **Assignment function** (deterministic):

*bucket = (fnv1a(hash_key = user_id \|\| anon_id \|\| \"EXP_KEY\") %
100)*\

- Store assignment in **AppConfig** or a small Dynamo table
  *exp_assignment* (for overrides).
- Log *exp.exposed* **once** per experiment per user at first exposure
  checkpoint.

***exp.exposed.v1*** **schema**

*{*\
*\"required\": \[\"exp_key\",\"variant\",\"checkpoint\"\],*\
*\"properties\": {*\
*\"exp_key\": {\"type\":\"string\"},*\
*\"variant\": {\"type\":\"string\"},*\
*\"checkpoint\":
{\"type\":\"string\",\"enum\":\[\"search\",\"profile\",\"checkout\",\"postbook\"\]}*\
*}*\
*}*\

### **F.2 Guardrails & metrics**

- Guardrails computed **daily**:

  - Refund rate Δ vs control ≤ 0.2 pp
  - Complaint rate ≤ 0.1%
  - API p95 latency ≤ 2 s

- Metrics prepared in **Gold** as per‑variant aggregates with CUPED
  pre‑period covariates (e.g., prior 28‑day spend or visits).

**Example (Gold) CUPED prep**

*CREATE TABLE gold.exp_metric_checkout_cuped AS*\
*SELECT*\
*e.exp_key, e.variant, e.user_id,*\
*count_if(m.event=\'checkout.start\') AS y_observed,*\
*\-- theta estimate computed offline or via regression; simplified
here*\
*avg(pre.y_baseline) as theta,*\
*(count_if(m.event=\'checkout.start\')