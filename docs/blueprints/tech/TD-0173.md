<!-- id: TD-0173 | source: ProjectPlans\TechnicalDevelopmentPlan.odt | range: 622800-626800 -->

card requests,
  gate accepts, RTB actions, booking confirmations, reschedules.
- **Digest**: daily/weekly depending on preference; sections (*New
  requests*, *Pending approvals*, *Upcoming bookings* with ICS links).
- **ICS attachments**: confirmed bookings include **.ics** to add to
  calendars. (Two‑way sync is covered in §1.24 Phase 2.)
- **Preference schema** (per user): channel toggles per event type;
  **Quiet Hours** window; override for "booking day" messages.

## **1.4.9 Moderation, Safety & Privacy**

- **Block/Report** UI on every thread; block prevents new gates; report
  opens a T&S case (Admin access is **case‑bound**).
- **Safe‑Mode images**: SFW previews only; NSFW/unsafe media blocked or
  blurred with label when policy demands.
- **PII**: exact addresses, phone, and studio door codes never appear in
  public; they appear in **booking detail** context only.

## **1.4.10 Observability, KPIs & Cost**

- **Events**: *msg.request.open\|accept\|decline\|block*, *msg.send*,
  *card.send\|accept\|decline*, *inbox.search*, *push.send\|open*,
  *digest.send\|open*.
- **KPIs**: request→accept rate, time‑to‑first‑response, card completion
  rate, reschedule success, extras attach rate, dispute rate,
  block/report rate.
- **Cost controls**: S3 lifecycle (attachments → IA in 90d), thumbnail
  transforms cached, push/email via pay‑as‑you‑go (Pinpoint/SES).

## **1.4.11 Work packages (Cursor 4‑agent lanes)**

- **Agent A --- Data/API**: DDL, GraphQL resolvers, gates, cards, audit
  writes, Actions→Order integration.
- **Agent B --- Web/RN UI**: Inbox lists, thread view, composer, card
  UIs, Message Request preview, search.
- **Agent C --- Notifications**: push/email, digest builder, ICS
  generator, preferences UI.
- **Agent D --- Safety/Moderation**: block/report flows,
  anti‑circumvention, Safe‑Mode preview logic, rate limits.

## **1.4.12 Test plan (Part 1)**

2829. **Message Request**: new contact gate; accept/decline/block;
      auto‑expire; folder moves.
2830. **Action Cards**: reschedule, extras, proofs/approvals, mark
      complete; order reflects accepted changes; audit written.
2831. **Studio deposit interaction**: overtime/violation card consumes
      deposit before new charge (from §1.24).
2832. **Notifications**: push + email for gates/cards; ICS included;
      Quiet Hours respected.
2833. **Search**: keyword + participant + "has:cardType" filters;
      performance under large inbox.
2834. **Safety**: NSFW preview blocked; block/report opens Admin case;
      anti‑circumvention nudge triggers.

## **1.4.13 Acceptance criteria (Part 1)**

- Message Requests fully gate new contacts with **Accept/Decline/Block**
  and rate limits.
- Core Action Cards function and update bookings; audit trails present.
- Inbox folders and search behave per spec; notifications and digests
  render correctly; ICS attaches to confirmations.
- Safety (block/report, Safe‑Mode previews, nudges) enforced; costs &
  lifecycles configured.

# **§1.4 --- Messaging, Inbox & Collaboration --- Full Technical Spec (Parts 2--Final)**

**Blueprint basis.** The non‑technical plan defines the role‑aware,
booking‑aware **Unified Inbox**, **Message Requests** gating, structured
**Action Cards** (reschedule, extras, proofs/approvals, expense,
mark‑complete, dispute, safety flag), folders/filters, search, credits,
contact filters, read/delivered receipts, typing indicators, and strong
anti‑circumvention + safety posture. The specs below translate that into
exact payloads, indexes, templates, thresholds, and testable rules.

NonTechBlueprint

## **1.4.A Action Card payload schemas (authoritative)**

Cards are first‑class messages (*message.kind=\'card\'*) with *cardType*
and validated *cardPayload* (server‑side). Cards mutate orders (see
§1.3) only on **accept**. Card audit entries are immutable.

**Common envelope (JSON):**

*{*\
*\"cardId\": \"crd_xxx\",*\
*\"threadId\": \"thr_xxx\",*\
*\"type\":
\"reschedule\|extras\|proofs\|expense\|complete